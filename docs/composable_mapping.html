<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.7.0"/>
    <title>composable_mapping API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>


            <h2>Submodules</h2>
            <ul>
                    <li><a href="composable_mapping/affine_transformation.html">affine_transformation</a></li>
                    <li><a href="composable_mapping/util.html">util</a></li>
            </ul>

            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Affine">Affine</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Affine.__init__">Affine</a>
                        </li>
                        <li>
                                <a class="variable" href="#Affine.transformation">transformation</a>
                        </li>
                        <li>
                                <a class="function" href="#Affine.from_matrix">from_matrix</a>
                        </li>
                        <li>
                                <a class="function" href="#Affine.from_diagonal_and_translation">from_diagonal_and_translation</a>
                        </li>
                        <li>
                                <a class="function" href="#Affine.identity">identity</a>
                        </li>
                        <li>
                                <a class="variable" href="#Affine.default_sampling_data_format">default_sampling_data_format</a>
                        </li>
                        <li>
                                <a class="function" href="#Affine.invert">invert</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#BaseSeparableSampler">BaseSeparableSampler</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#BaseSeparableSampler.derivative">derivative</a>
                        </li>
                        <li>
                                <a class="function" href="#BaseSeparableSampler.inverse">inverse</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#BicubicInterpolator">BicubicInterpolator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#BicubicInterpolator.__init__">BicubicInterpolator</a>
                        </li>
                        <li>
                                <a class="function" href="#BicubicInterpolator.sample_values">sample_values</a>
                        </li>
                        <li>
                                <a class="function" href="#BicubicInterpolator.sample_mask">sample_mask</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ClearMask">ClearMask</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ClearMask.invert">invert</a>
                        </li>
                        <li>
                                <a class="function" href="#ClearMask.detach">detach</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ComposableMapping">ComposableMapping</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ComposableMapping.__call__">__call__</a>
                        </li>
                        <li>
                                <a class="function" href="#ComposableMapping.invert">invert</a>
                        </li>
                        <li>
                                <a class="function" href="#ComposableMapping.sample_to">sample_to</a>
                        </li>
                        <li>
                                <a class="function" href="#ComposableMapping.resample_to">resample_to</a>
                        </li>
                        <li>
                                <a class="function" href="#ComposableMapping.assign_coordinates">assign_coordinates</a>
                        </li>
                        <li>
                                <a class="function" href="#ComposableMapping.as_affine_transformation">as_affine_transformation</a>
                        </li>
                        <li>
                                <a class="function" href="#ComposableMapping.as_affine_matrix">as_affine_matrix</a>
                        </li>
                        <li>
                                <a class="variable" href="#ComposableMapping.default_sampling_data_format">default_sampling_data_format</a>
                        </li>
                        <li>
                                <a class="function" href="#ComposableMapping.set_default_sampling_data_format">set_default_sampling_data_format</a>
                        </li>
                        <li>
                                <a class="function" href="#ComposableMapping.__matmul__">__matmul__</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CoordinateSystem">CoordinateSystem</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CoordinateSystem.__init__">CoordinateSystem</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.centered_normalized">centered_normalized</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.centered">centered</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.voxel">voxel</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.torch_grid_sample">torch_grid_sample</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.from_affine_matrix">from_affine_matrix</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.from_diagonal_affine_matrix">from_diagonal_affine_matrix</a>
                        </li>
                        <li>
                                <a class="variable" href="#CoordinateSystem.coordinate_system">coordinate_system</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.forward">forward</a>
                        </li>
                        <li>
                                <a class="variable" href="#CoordinateSystem.dtype">dtype</a>
                        </li>
                        <li>
                                <a class="variable" href="#CoordinateSystem.device">device</a>
                        </li>
                        <li>
                                <a class="variable" href="#CoordinateSystem.from_voxel_coordinates">from_voxel_coordinates</a>
                        </li>
                        <li>
                                <a class="variable" href="#CoordinateSystem.to_voxel_coordinates">to_voxel_coordinates</a>
                        </li>
                        <li>
                                <a class="variable" href="#CoordinateSystem.spatial_shape">spatial_shape</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.grid">grid</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.voxel_grid">voxel_grid</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.grid_spacing_cpu">grid_spacing_cpu</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.grid_spacing">grid_spacing</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.transform_voxel">transform_voxel</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.transform_voxel_with_diagonal_matrix">transform_voxel_with_diagonal_matrix</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.transform_world">transform_world</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.transform_world_with_diagonal_matrix">transform_world_with_diagonal_matrix</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.translate_voxel">translate_voxel</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.translate_world">translate_world</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.multiply_voxel">multiply_voxel</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.multiply_world">multiply_world</a>
                        </li>
                        <li>
                                <a class="function" href="#CoordinateSystem.reformat">reformat</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CubicSplineSampler">CubicSplineSampler</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CubicSplineSampler.__init__">CubicSplineSampler</a>
                        </li>
                        <li>
                                <a class="function" href="#CubicSplineSampler.sample_values">sample_values</a>
                        </li>
                        <li>
                                <a class="function" href="#CubicSplineSampler.sample_mask">sample_mask</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#DataFormat">DataFormat</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DataFormat.__init__">DataFormat</a>
                        </li>
                        <li>
                                <a class="variable" href="#DataFormat.representation">representation</a>
                        </li>
                        <li>
                                <a class="variable" href="#DataFormat.coordinate_type">coordinate_type</a>
                        </li>
                        <li>
                                <a class="function" href="#DataFormat.voxel_displacements">voxel_displacements</a>
                        </li>
                        <li>
                                <a class="function" href="#DataFormat.world_displacements">world_displacements</a>
                        </li>
                        <li>
                                <a class="function" href="#DataFormat.voxel_coordinates">voxel_coordinates</a>
                        </li>
                        <li>
                                <a class="function" href="#DataFormat.world_coordinates">world_coordinates</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#GenericSeparableDerivativeSampler">GenericSeparableDerivativeSampler</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GenericSeparableDerivativeSampler.__init__">GenericSeparableDerivativeSampler</a>
                        </li>
                        <li>
                                <a class="function" href="#GenericSeparableDerivativeSampler.derivative">derivative</a>
                        </li>
                        <li>
                                <a class="function" href="#GenericSeparableDerivativeSampler.sample_values">sample_values</a>
                        </li>
                        <li>
                                <a class="function" href="#GenericSeparableDerivativeSampler.sample_mask">sample_mask</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#GridComposableMapping">GridComposableMapping</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GridComposableMapping.invert">invert</a>
                        </li>
                        <li>
                                <a class="function" href="#GridComposableMapping.sample">sample</a>
                        </li>
                        <li>
                                <a class="function" href="#GridComposableMapping.resample">resample</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#GridVisualizationArguments">GridVisualizationArguments</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GridVisualizationArguments.__init__">GridVisualizationArguments</a>
                        </li>
                        <li>
                                <a class="variable" href="#GridVisualizationArguments.batch_index">batch_index</a>
                        </li>
                        <li>
                                <a class="variable" href="#GridVisualizationArguments.figure_height">figure_height</a>
                        </li>
                        <li>
                                <a class="variable" href="#GridVisualizationArguments.emphasize_every_nth_line">emphasize_every_nth_line</a>
                        </li>
                        <li>
                                <a class="variable" href="#GridVisualizationArguments.plot_kwargs">plot_kwargs</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Identity">Identity</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Identity.invert">invert</a>
                        </li>
                        <li>
                                <a class="function" href="#Identity.detach">detach</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ISampler">ISampler</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ISampler.derivative">derivative</a>
                        </li>
                        <li>
                                <a class="function" href="#ISampler.inverse">inverse</a>
                        </li>
                        <li>
                                <a class="function" href="#ISampler.sample_values">sample_values</a>
                        </li>
                        <li>
                                <a class="function" href="#ISampler.sample_mask">sample_mask</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ImageVisualizationArguments">ImageVisualizationArguments</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ImageVisualizationArguments.__init__">ImageVisualizationArguments</a>
                        </li>
                        <li>
                                <a class="variable" href="#ImageVisualizationArguments.batch_index">batch_index</a>
                        </li>
                        <li>
                                <a class="variable" href="#ImageVisualizationArguments.figure_height">figure_height</a>
                        </li>
                        <li>
                                <a class="variable" href="#ImageVisualizationArguments.mask_color">mask_color</a>
                        </li>
                        <li>
                                <a class="variable" href="#ImageVisualizationArguments.vmin">vmin</a>
                        </li>
                        <li>
                                <a class="variable" href="#ImageVisualizationArguments.vmax">vmax</a>
                        </li>
                        <li>
                                <a class="variable" href="#ImageVisualizationArguments.imshow_kwargs">imshow_kwargs</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ITensorLike">ITensorLike</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#ITensorLike.dtype">dtype</a>
                        </li>
                        <li>
                                <a class="variable" href="#ITensorLike.device">device</a>
                        </li>
                        <li>
                                <a class="function" href="#ITensorLike.cast">cast</a>
                        </li>
                        <li>
                                <a class="function" href="#ITensorLike.detach">detach</a>
                        </li>
                        <li>
                                <a class="function" href="#ITensorLike.pin_memory">pin_memory</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#LimitDirection">LimitDirection</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LimitDirection.__init__">LimitDirection</a>
                        </li>
                        <li>
                                <a class="variable" href="#LimitDirection.direction">direction</a>
                        </li>
                        <li>
                                <a class="function" href="#LimitDirection.left">left</a>
                        </li>
                        <li>
                                <a class="function" href="#LimitDirection.right">right</a>
                        </li>
                        <li>
                                <a class="function" href="#LimitDirection.average">average</a>
                        </li>
                        <li>
                                <a class="function" href="#LimitDirection.as_callable">as_callable</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#LinearInterpolator">LinearInterpolator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LinearInterpolator.__init__">LinearInterpolator</a>
                        </li>
                        <li>
                                <a class="function" href="#LinearInterpolator.sample_values">sample_values</a>
                        </li>
                        <li>
                                <a class="function" href="#LinearInterpolator.sample_mask">sample_mask</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#MappableTensor">MappableTensor</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MappableTensor.__init__">MappableTensor</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.from_tensor">from_tensor</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.voxel_grid">voxel_grid</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.shape">shape</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.spatial_shape">spatial_shape</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.channels_shape">channels_shape</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.batch_shape">batch_shape</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.mask_shape">mask_shape</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.n_channel_dims">n_channel_dims</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.generate">generate</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.generate_values">generate_values</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.generate_mask">generate_mask</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.displacements">displacements</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.affine_transformation">affine_transformation</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.grid">grid</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.transform">transform</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.has_mask">has_mask</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.clear_mask">clear_mask</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.reduce">reduce</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.modify_values">modify_values</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.mask_and">mask_and</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.modify_mask">modify_mask</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#NearestInterpolator">NearestInterpolator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#NearestInterpolator.__init__">NearestInterpolator</a>
                        </li>
                        <li>
                                <a class="function" href="#NearestInterpolator.sample_values">sample_values</a>
                        </li>
                        <li>
                                <a class="function" href="#NearestInterpolator.sample_mask">sample_mask</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="variable" href="#Number">Number</a>
            </li>
            <li>
                    <a class="class" href="#OriginalFOV">OriginalFOV</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#OriginalFOV.__init__">OriginalFOV</a>
                        </li>
                        <li>
                                <a class="variable" href="#OriginalFOV.DIVISION_FUNCTIONS">DIVISION_FUNCTIONS</a>
                        </li>
                        <li>
                                <a class="function" href="#OriginalFOV.target_size">target_size</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#OriginalShape">OriginalShape</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#OriginalShape.target_size">target_size</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ReformattingReference">ReformattingReference</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ReformattingReference.get_voxel_coordinate">get_voxel_coordinate</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ReformattingSpatialShape">ReformattingSpatialShape</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ReformattingSpatialShape.target_size">target_size</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#RectangleMask">RectangleMask</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#RectangleMask.__init__">RectangleMask</a>
                        </li>
                        <li>
                                <a class="function" href="#RectangleMask.invert">invert</a>
                        </li>
                        <li>
                                <a class="function" href="#RectangleMask.detach">detach</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SamplableVolume">SamplableVolume</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SamplableVolume.__init__">SamplableVolume</a>
                        </li>
                        <li>
                                <a class="function" href="#SamplableVolume.from_tensor">from_tensor</a>
                        </li>
                        <li>
                                <a class="function" href="#SamplableVolume.modify_sampler">modify_sampler</a>
                        </li>
                        <li>
                                <a class="variable" href="#SamplableVolume.coordinate_system">coordinate_system</a>
                        </li>
                        <li>
                                <a class="variable" href="#SamplableVolume.default_sampling_data_format">default_sampling_data_format</a>
                        </li>
                        <li>
                                <a class="function" href="#SamplableVolume.invert">invert</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ScalingAndSquaring">ScalingAndSquaring</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ScalingAndSquaring.__init__">ScalingAndSquaring</a>
                        </li>
                        <li>
                                <a class="function" href="#ScalingAndSquaring.derivative">derivative</a>
                        </li>
                        <li>
                                <a class="function" href="#ScalingAndSquaring.inverse">inverse</a>
                        </li>
                        <li>
                                <a class="function" href="#ScalingAndSquaring.sample_values">sample_values</a>
                        </li>
                        <li>
                                <a class="function" href="#ScalingAndSquaring.sample_mask">sample_mask</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Start">Start</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Start.__init__">Start</a>
                        </li>
                        <li>
                                <a class="function" href="#Start.get_voxel_coordinate">get_voxel_coordinate</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Center">Center</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Center.get_voxel_coordinate">get_voxel_coordinate</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#End">End</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#End.__init__">End</a>
                        </li>
                        <li>
                                <a class="function" href="#End.get_voxel_coordinate">get_voxel_coordinate</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#affine">affine</a>
            </li>
            <li>
                    <a class="function" href="#clear_default_sampler">clear_default_sampler</a>
            </li>
            <li>
                    <a class="function" href="#concatenate_mappings">concatenate_mappings</a>
            </li>
            <li>
                    <a class="function" href="#concatenate_mappable_tensors">concatenate_mappable_tensors</a>
            </li>
            <li>
                    <a class="class" href="#default_sampler">default_sampler</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#default_sampler.__init__">default_sampler</a>
                        </li>
                        <li>
                                <a class="variable" href="#default_sampler.sampler">sampler</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#diagonal_affine">diagonal_affine</a>
            </li>
            <li>
                    <a class="function" href="#estimate_spatial_jacobian_matrices">estimate_spatial_jacobian_matrices</a>
            </li>
            <li>
                    <a class="function" href="#get_default_sampler">get_default_sampler</a>
            </li>
            <li>
                    <a class="function" href="#get_sampler">get_sampler</a>
            </li>
            <li>
                    <a class="function" href="#mappable">mappable</a>
            </li>
            <li>
                    <a class="function" href="#samplable_volume">samplable_volume</a>
            </li>
            <li>
                    <a class="function" href="#set_default_sampler">set_default_sampler</a>
            </li>
            <li>
                    <a class="function" href="#stack_mappings">stack_mappings</a>
            </li>
            <li>
                    <a class="function" href="#stack_mappable_tensors">stack_mappable_tensors</a>
            </li>
            <li>
                    <a class="function" href="#voxel_grid">voxel_grid</a>
            </li>
            <li>
                    <a class="function" href="#visualize_as_deformed_grid">visualize_as_deformed_grid</a>
            </li>
            <li>
                    <a class="function" href="#visualize_as_image">visualize_as_image</a>
            </li>
            <li>
                    <a class="function" href="#visualize_grid">visualize_grid</a>
            </li>
            <li>
                    <a class="function" href="#visualize_image">visualize_image</a>
            </li>
            <li>
                    <a class="function" href="#visualize_to_as_deformed_grid">visualize_to_as_deformed_grid</a>
            </li>
            <li>
                    <a class="function" href="#visualize_to_as_image">visualize_to_as_image</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
composable_mapping    </h1>

                        <div class="docstring"><p>Library for handling spatial coordinate transformations in PyTorch.</p>

<p>Developed originally for medical imaging, this library provides a set of classes
and functions for handling spatial coordinate transformations.</p>

<p>The most powerful feature of this library is the ability to easily compose
transformations lazily and resample them to different coordinate systems as well
as sampler classes for sampling volumes defined on regular grids such that the
optimal method (either slicing operation, convolution, or torch.grid_sample) is
used based on the sampling locations.</p>

<p>The main idea was to develop a library that allows handling of the coordinate
mappings as if they were mathematical functions, without losing much performance
compared to more manual implementation.</p>

<p>In this codebase tensor shapes are seen as consisting of three parts (in the
following order): batch dimension, channel dimensions and spatial dimensions.
The split is defined by providing the number of channel dimensions with the
assumption that there is at most one batch dimension. If the number of
dimensions equals the number of channel dimensions, the batch dimension is
assumed to be empty. Codebase implements custom broadcasting operations which
apply normal broadcasting separately to each split. This makes many operations
easier as one does not have to worry about unsqueezing correct number of
dimensions to apply the same operation e.g. over all spatial and batch
dimensions.</p>
</div>

                        <input id="mod-composable_mapping-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-composable_mapping-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;Library for handling spatial coordinate transformations in PyTorch.</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">Developed originally for medical imaging, this library provides a set of classes</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="sd">and functions for handling spatial coordinate transformations.</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">The most powerful feature of this library is the ability to easily compose</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">transformations lazily and resample them to different coordinate systems as well</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">as sampler classes for sampling volumes defined on regular grids such that the</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">optimal method (either slicing operation, convolution, or torch.grid_sample) is</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">used based on the sampling locations.</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">The main idea was to develop a library that allows handling of the coordinate</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">mappings as if they were mathematical functions, without losing much performance</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">compared to more manual implementation.</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">In this codebase tensor shapes are seen as consisting of three parts (in the</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">following order): batch dimension, channel dimensions and spatial dimensions.</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">The split is defined by providing the number of channel dimensions with the</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">assumption that there is at most one batch dimension. If the number of</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">dimensions equals the number of channel dimensions, the batch dimension is</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">assumed to be empty. Codebase implements custom broadcasting operations which</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">apply normal broadcasting separately to each split. This makes many operations</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">easier as one does not have to worry about unsqueezing correct number of</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">dimensions to apply the same operation e.g. over all spatial and batch</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">dimensions.</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="kn">from</span> <span class="nn">.affine_mapping</span> <span class="kn">import</span> <span class="n">Affine</span><span class="p">,</span> <span class="n">affine</span><span class="p">,</span> <span class="n">diagonal_affine</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="kn">from</span> <span class="nn">.composable_mapping</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>    <span class="n">ComposableMapping</span><span class="p">,</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>    <span class="n">GridComposableMapping</span><span class="p">,</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>    <span class="n">Identity</span><span class="p">,</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>    <span class="n">SamplableVolume</span><span class="p">,</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>    <span class="n">concatenate_mappings</span><span class="p">,</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>    <span class="n">samplable_volume</span><span class="p">,</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>    <span class="n">stack_mappings</span><span class="p">,</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="p">)</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="kn">from</span> <span class="nn">.coordinate_system</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>    <span class="n">Center</span><span class="p">,</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>    <span class="n">CoordinateSystem</span><span class="p">,</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>    <span class="n">End</span><span class="p">,</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>    <span class="n">OriginalFOV</span><span class="p">,</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>    <span class="n">OriginalShape</span><span class="p">,</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>    <span class="n">ReformattingReference</span><span class="p">,</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>    <span class="n">ReformattingSpatialShape</span><span class="p">,</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>    <span class="n">Start</span><span class="p">,</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="p">)</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="kn">from</span> <span class="nn">.derivative</span> <span class="kn">import</span> <span class="n">estimate_spatial_jacobian_matrices</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="kn">from</span> <span class="nn">.interface</span> <span class="kn">import</span> <span class="n">Number</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="kn">from</span> <span class="nn">.mappable_tensor</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>    <span class="n">MappableTensor</span><span class="p">,</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>    <span class="n">concatenate_mappable_tensors</span><span class="p">,</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>    <span class="n">mappable</span><span class="p">,</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>    <span class="n">stack_mappable_tensors</span><span class="p">,</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>    <span class="n">voxel_grid</span><span class="p">,</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="p">)</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="kn">from</span> <span class="nn">.mask</span> <span class="kn">import</span> <span class="n">ClearMask</span><span class="p">,</span> <span class="n">RectangleMask</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="kn">from</span> <span class="nn">.sampler</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>    <span class="n">BaseSeparableSampler</span><span class="p">,</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>    <span class="n">BicubicInterpolator</span><span class="p">,</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>    <span class="n">CubicSplineSampler</span><span class="p">,</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>    <span class="n">DataFormat</span><span class="p">,</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>    <span class="n">GenericSeparableDerivativeSampler</span><span class="p">,</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>    <span class="n">ISampler</span><span class="p">,</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>    <span class="n">LimitDirection</span><span class="p">,</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>    <span class="n">LinearInterpolator</span><span class="p">,</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>    <span class="n">NearestInterpolator</span><span class="p">,</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>    <span class="n">ScalingAndSquaring</span><span class="p">,</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>    <span class="n">clear_default_sampler</span><span class="p">,</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>    <span class="n">default_sampler</span><span class="p">,</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>    <span class="n">get_default_sampler</span><span class="p">,</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>    <span class="n">get_sampler</span><span class="p">,</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>    <span class="n">set_default_sampler</span><span class="p">,</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="p">)</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="kn">from</span> <span class="nn">.tensor_like</span> <span class="kn">import</span> <span class="n">ITensorLike</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="kn">from</span> <span class="nn">.visualization</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>    <span class="n">GridVisualizationArguments</span><span class="p">,</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>    <span class="n">ImageVisualizationArguments</span><span class="p">,</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>    <span class="n">visualize_as_deformed_grid</span><span class="p">,</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>    <span class="n">visualize_as_image</span><span class="p">,</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>    <span class="n">visualize_grid</span><span class="p">,</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>    <span class="n">visualize_image</span><span class="p">,</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>    <span class="n">visualize_to_as_deformed_grid</span><span class="p">,</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>    <span class="n">visualize_to_as_image</span><span class="p">,</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="p">)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>    <span class="s2">&quot;Affine&quot;</span><span class="p">,</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>    <span class="s2">&quot;BaseSeparableSampler&quot;</span><span class="p">,</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>    <span class="s2">&quot;BicubicInterpolator&quot;</span><span class="p">,</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>    <span class="s2">&quot;ClearMask&quot;</span><span class="p">,</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>    <span class="s2">&quot;ComposableMapping&quot;</span><span class="p">,</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>    <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">,</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>    <span class="s2">&quot;CubicSplineSampler&quot;</span><span class="p">,</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>    <span class="s2">&quot;DataFormat&quot;</span><span class="p">,</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>    <span class="s2">&quot;GenericSeparableDerivativeSampler&quot;</span><span class="p">,</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>    <span class="s2">&quot;GridComposableMapping&quot;</span><span class="p">,</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>    <span class="s2">&quot;GridVisualizationArguments&quot;</span><span class="p">,</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>    <span class="s2">&quot;Identity&quot;</span><span class="p">,</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>    <span class="s2">&quot;ISampler&quot;</span><span class="p">,</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>    <span class="s2">&quot;ImageVisualizationArguments&quot;</span><span class="p">,</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>    <span class="s2">&quot;ITensorLike&quot;</span><span class="p">,</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>    <span class="s2">&quot;LimitDirection&quot;</span><span class="p">,</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>    <span class="s2">&quot;LinearInterpolator&quot;</span><span class="p">,</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>    <span class="s2">&quot;MappableTensor&quot;</span><span class="p">,</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>    <span class="s2">&quot;NearestInterpolator&quot;</span><span class="p">,</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>    <span class="s2">&quot;Number&quot;</span><span class="p">,</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>    <span class="s2">&quot;OriginalFOV&quot;</span><span class="p">,</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>    <span class="s2">&quot;OriginalShape&quot;</span><span class="p">,</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>    <span class="s2">&quot;ReformattingReference&quot;</span><span class="p">,</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>    <span class="s2">&quot;ReformattingSpatialShape&quot;</span><span class="p">,</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>    <span class="s2">&quot;RectangleMask&quot;</span><span class="p">,</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>    <span class="s2">&quot;SamplableVolume&quot;</span><span class="p">,</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>    <span class="s2">&quot;ScalingAndSquaring&quot;</span><span class="p">,</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>    <span class="s2">&quot;Start&quot;</span><span class="p">,</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>    <span class="s2">&quot;Center&quot;</span><span class="p">,</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>    <span class="s2">&quot;End&quot;</span><span class="p">,</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>    <span class="s2">&quot;affine&quot;</span><span class="p">,</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>    <span class="s2">&quot;affine_transformation&quot;</span><span class="p">,</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>    <span class="s2">&quot;clear_default_sampler&quot;</span><span class="p">,</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>    <span class="s2">&quot;concatenate_mappings&quot;</span><span class="p">,</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>    <span class="s2">&quot;concatenate_mappable_tensors&quot;</span><span class="p">,</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>    <span class="s2">&quot;default_sampler&quot;</span><span class="p">,</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>    <span class="s2">&quot;diagonal_affine&quot;</span><span class="p">,</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>    <span class="s2">&quot;estimate_spatial_jacobian_matrices&quot;</span><span class="p">,</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>    <span class="s2">&quot;get_default_sampler&quot;</span><span class="p">,</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>    <span class="s2">&quot;get_sampler&quot;</span><span class="p">,</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>    <span class="s2">&quot;mappable&quot;</span><span class="p">,</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>    <span class="s2">&quot;samplable_volume&quot;</span><span class="p">,</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>    <span class="s2">&quot;set_default_sampler&quot;</span><span class="p">,</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>    <span class="s2">&quot;stack_mappings&quot;</span><span class="p">,</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>    <span class="s2">&quot;stack_mappable_tensors&quot;</span><span class="p">,</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>    <span class="s2">&quot;util&quot;</span><span class="p">,</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>    <span class="s2">&quot;voxel_grid&quot;</span><span class="p">,</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>    <span class="s2">&quot;visualize_as_deformed_grid&quot;</span><span class="p">,</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>    <span class="s2">&quot;visualize_as_image&quot;</span><span class="p">,</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>    <span class="s2">&quot;visualize_grid&quot;</span><span class="p">,</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>    <span class="s2">&quot;visualize_image&quot;</span><span class="p">,</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>    <span class="s2">&quot;visualize_to_as_deformed_grid&quot;</span><span class="p">,</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>    <span class="s2">&quot;visualize_to_as_image&quot;</span><span class="p">,</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="Affine">
                            <input id="Affine-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Affine</span><wbr>(<span class="base">composable_mapping.tensor_like.BaseTensorLikeWrapper</span>, <span class="base"><a href="#ComposableMapping">composable_mapping.ComposableMapping</a></span>):

                <label class="view-source-button" for="Affine-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Affine"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Affine-22"><a href="#Affine-22"><span class="linenos"> 22</span></a><span class="k">class</span> <span class="nc">Affine</span><span class="p">(</span><span class="n">BaseTensorLikeWrapper</span><span class="p">,</span> <span class="n">ComposableMapping</span><span class="p">):</span>
</span><span id="Affine-23"><a href="#Affine-23"><span class="linenos"> 23</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Affine mapping.</span>
</span><span id="Affine-24"><a href="#Affine-24"><span class="linenos"> 24</span></a>
</span><span id="Affine-25"><a href="#Affine-25"><span class="linenos"> 25</span></a><span class="sd">    This class represents an affine transformation applicable to mappable</span>
</span><span id="Affine-26"><a href="#Affine-26"><span class="linenos"> 26</span></a><span class="sd">    tensors. In essence, it is a wrapper around an affine transformation object</span>
</span><span id="Affine-27"><a href="#Affine-27"><span class="linenos"> 27</span></a><span class="sd">    which acts on PyTorch tensors. Since it is a composable mapping, it can be</span>
</span><span id="Affine-28"><a href="#Affine-28"><span class="linenos"> 28</span></a><span class="sd">    composed with other mappings.</span>
</span><span id="Affine-29"><a href="#Affine-29"><span class="linenos"> 29</span></a>
</span><span id="Affine-30"><a href="#Affine-30"><span class="linenos"> 30</span></a><span class="sd">    Recommended way to create an affine transformation is to use the factory</span>
</span><span id="Affine-31"><a href="#Affine-31"><span class="linenos"> 31</span></a><span class="sd">    functions provided in this module or as class methods of this class:</span>
</span><span id="Affine-32"><a href="#Affine-32"><span class="linenos"> 32</span></a><span class="sd">    `affine`, `diagonal_affine`, `Affine.identity`,</span>
</span><span id="Affine-33"><a href="#Affine-33"><span class="linenos"> 33</span></a><span class="sd">    `Affine.from_matrix`, `Affine.from_diagonal_and_translation`.</span>
</span><span id="Affine-34"><a href="#Affine-34"><span class="linenos"> 34</span></a>
</span><span id="Affine-35"><a href="#Affine-35"><span class="linenos"> 35</span></a><span class="sd">    Args:</span>
</span><span id="Affine-36"><a href="#Affine-36"><span class="linenos"> 36</span></a><span class="sd">        transformation: The wrapped affine transformation acting on PyTorch tensors.</span>
</span><span id="Affine-37"><a href="#Affine-37"><span class="linenos"> 37</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Affine-38"><a href="#Affine-38"><span class="linenos"> 38</span></a>
</span><span id="Affine-39"><a href="#Affine-39"><span class="linenos"> 39</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transformation</span><span class="p">:</span> <span class="n">IAffineTransformation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Affine-40"><a href="#Affine-40"><span class="linenos"> 40</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="p">:</span> <span class="n">IAffineTransformation</span> <span class="o">=</span> <span class="n">transformation</span>
</span><span id="Affine-41"><a href="#Affine-41"><span class="linenos"> 41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The wrapped affine transformation action on PyTorch tensors.&quot;&quot;&quot;</span>
</span><span id="Affine-42"><a href="#Affine-42"><span class="linenos"> 42</span></a>
</span><span id="Affine-43"><a href="#Affine-43"><span class="linenos"> 43</span></a>    <span class="nd">@classmethod</span>
</span><span id="Affine-44"><a href="#Affine-44"><span class="linenos"> 44</span></a>    <span class="k">def</span> <span class="nf">from_matrix</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Affine&quot;</span><span class="p">:</span>
</span><span id="Affine-45"><a href="#Affine-45"><span class="linenos"> 45</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create affine mapping from an affine transformation matrix.</span>
</span><span id="Affine-46"><a href="#Affine-46"><span class="linenos"> 46</span></a>
</span><span id="Affine-47"><a href="#Affine-47"><span class="linenos"> 47</span></a><span class="sd">        Args:</span>
</span><span id="Affine-48"><a href="#Affine-48"><span class="linenos"> 48</span></a><span class="sd">            matrix: Affine transformation matrix with shape</span>
</span><span id="Affine-49"><a href="#Affine-49"><span class="linenos"> 49</span></a><span class="sd">                ([*batch_shape, ]n_output_dims + 1, n_input_dims + 1[, *spatial_shape]).</span>
</span><span id="Affine-50"><a href="#Affine-50"><span class="linenos"> 50</span></a>
</span><span id="Affine-51"><a href="#Affine-51"><span class="linenos"> 51</span></a><span class="sd">        Returns:</span>
</span><span id="Affine-52"><a href="#Affine-52"><span class="linenos"> 52</span></a><span class="sd">            Affine mapping.</span>
</span><span id="Affine-53"><a href="#Affine-53"><span class="linenos"> 53</span></a>
</span><span id="Affine-54"><a href="#Affine-54"><span class="linenos"> 54</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Affine-55"><a href="#Affine-55"><span class="linenos"> 55</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">AffineTransformation</span><span class="p">(</span><span class="n">matrix</span><span class="p">))</span>
</span><span id="Affine-56"><a href="#Affine-56"><span class="linenos"> 56</span></a>
</span><span id="Affine-57"><a href="#Affine-57"><span class="linenos"> 57</span></a>    <span class="nd">@classmethod</span>
</span><span id="Affine-58"><a href="#Affine-58"><span class="linenos"> 58</span></a>    <span class="k">def</span> <span class="nf">from_diagonal_and_translation</span><span class="p">(</span>
</span><span id="Affine-59"><a href="#Affine-59"><span class="linenos"> 59</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="Affine-60"><a href="#Affine-60"><span class="linenos"> 60</span></a>        <span class="n">diagonal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Affine-61"><a href="#Affine-61"><span class="linenos"> 61</span></a>        <span class="n">translation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Affine-62"><a href="#Affine-62"><span class="linenos"> 62</span></a>        <span class="n">matrix_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Affine-63"><a href="#Affine-63"><span class="linenos"> 63</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Affine-64"><a href="#Affine-64"><span class="linenos"> 64</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Affine-65"><a href="#Affine-65"><span class="linenos"> 65</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Affine&quot;</span><span class="p">:</span>
</span><span id="Affine-66"><a href="#Affine-66"><span class="linenos"> 66</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create affine mapping from diagonal and translation</span>
</span><span id="Affine-67"><a href="#Affine-67"><span class="linenos"> 67</span></a>
</span><span id="Affine-68"><a href="#Affine-68"><span class="linenos"> 68</span></a><span class="sd">        Args:</span>
</span><span id="Affine-69"><a href="#Affine-69"><span class="linenos"> 69</span></a><span class="sd">            diagonal: Diagonal of the affine transformation matrix with shape</span>
</span><span id="Affine-70"><a href="#Affine-70"><span class="linenos"> 70</span></a><span class="sd">                ([*batch_shape, ]diagonal_length[, *spatial_shape]).</span>
</span><span id="Affine-71"><a href="#Affine-71"><span class="linenos"> 71</span></a><span class="sd">            translation: Translation of the affine transformation matrix</span>
</span><span id="Affine-72"><a href="#Affine-72"><span class="linenos"> 72</span></a><span class="sd">                with shape ([*batch_shape, ]n_output_dims[, *spatial_shape]).</span>
</span><span id="Affine-73"><a href="#Affine-73"><span class="linenos"> 73</span></a><span class="sd">            matrix_shape: Shape of the affine transformation matrix in format</span>
</span><span id="Affine-74"><a href="#Affine-74"><span class="linenos"> 74</span></a><span class="sd">                ([*batch_shape, ]n_output_dims + 1, n_input_dims + 1[, *spatial_shape]).</span>
</span><span id="Affine-75"><a href="#Affine-75"><span class="linenos"> 75</span></a><span class="sd">            dtype: Data type of the affine transformation matrix, needed only if diagonal</span>
</span><span id="Affine-76"><a href="#Affine-76"><span class="linenos"> 76</span></a><span class="sd">                and translation are not provided.</span>
</span><span id="Affine-77"><a href="#Affine-77"><span class="linenos"> 77</span></a><span class="sd">            device: Device of the affine transformation matrix, needed only if diagonal</span>
</span><span id="Affine-78"><a href="#Affine-78"><span class="linenos"> 78</span></a><span class="sd">                and translation are not provided.</span>
</span><span id="Affine-79"><a href="#Affine-79"><span class="linenos"> 79</span></a>
</span><span id="Affine-80"><a href="#Affine-80"><span class="linenos"> 80</span></a><span class="sd">        Returns:</span>
</span><span id="Affine-81"><a href="#Affine-81"><span class="linenos"> 81</span></a><span class="sd">            Affine mapping.</span>
</span><span id="Affine-82"><a href="#Affine-82"><span class="linenos"> 82</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Affine-83"><a href="#Affine-83"><span class="linenos"> 83</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
</span><span id="Affine-84"><a href="#Affine-84"><span class="linenos"> 84</span></a>            <span class="n">DiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="Affine-85"><a href="#Affine-85"><span class="linenos"> 85</span></a>                <span class="n">diagonal</span><span class="o">=</span><span class="n">diagonal</span><span class="p">,</span>
</span><span id="Affine-86"><a href="#Affine-86"><span class="linenos"> 86</span></a>                <span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">,</span>
</span><span id="Affine-87"><a href="#Affine-87"><span class="linenos"> 87</span></a>                <span class="n">matrix_shape</span><span class="o">=</span><span class="n">matrix_shape</span><span class="p">,</span>
</span><span id="Affine-88"><a href="#Affine-88"><span class="linenos"> 88</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="Affine-89"><a href="#Affine-89"><span class="linenos"> 89</span></a>                <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="Affine-90"><a href="#Affine-90"><span class="linenos"> 90</span></a>            <span class="p">)</span>
</span><span id="Affine-91"><a href="#Affine-91"><span class="linenos"> 91</span></a>        <span class="p">)</span>
</span><span id="Affine-92"><a href="#Affine-92"><span class="linenos"> 92</span></a>
</span><span id="Affine-93"><a href="#Affine-93"><span class="linenos"> 93</span></a>    <span class="nd">@classmethod</span>
</span><span id="Affine-94"><a href="#Affine-94"><span class="linenos"> 94</span></a>    <span class="k">def</span> <span class="nf">identity</span><span class="p">(</span>
</span><span id="Affine-95"><a href="#Affine-95"><span class="linenos"> 95</span></a>        <span class="bp">cls</span><span class="p">,</span> <span class="n">n_dims</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Affine-96"><a href="#Affine-96"><span class="linenos"> 96</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Affine&quot;</span><span class="p">:</span>
</span><span id="Affine-97"><a href="#Affine-97"><span class="linenos"> 97</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create identity affine mapping.</span>
</span><span id="Affine-98"><a href="#Affine-98"><span class="linenos"> 98</span></a>
</span><span id="Affine-99"><a href="#Affine-99"><span class="linenos"> 99</span></a><span class="sd">        Args:</span>
</span><span id="Affine-100"><a href="#Affine-100"><span class="linenos">100</span></a><span class="sd">            n_dims: Number of input and output dimensions of the identity affine mapping.</span>
</span><span id="Affine-101"><a href="#Affine-101"><span class="linenos">101</span></a><span class="sd">            dtype: Data type of the identity affine mapping.</span>
</span><span id="Affine-102"><a href="#Affine-102"><span class="linenos">102</span></a><span class="sd">            device: Device of the identity affine mapping.</span>
</span><span id="Affine-103"><a href="#Affine-103"><span class="linenos">103</span></a>
</span><span id="Affine-104"><a href="#Affine-104"><span class="linenos">104</span></a><span class="sd">        Returns:</span>
</span><span id="Affine-105"><a href="#Affine-105"><span class="linenos">105</span></a><span class="sd">            Identity affine mapping.</span>
</span><span id="Affine-106"><a href="#Affine-106"><span class="linenos">106</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Affine-107"><a href="#Affine-107"><span class="linenos">107</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">IdentityAffineTransformation</span><span class="p">(</span><span class="n">n_dims</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
</span><span id="Affine-108"><a href="#Affine-108"><span class="linenos">108</span></a>
</span><span id="Affine-109"><a href="#Affine-109"><span class="linenos">109</span></a>    <span class="nd">@property</span>
</span><span id="Affine-110"><a href="#Affine-110"><span class="linenos">110</span></a>    <span class="k">def</span> <span class="nf">default_sampling_data_format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFormat</span><span class="p">:</span>
</span><span id="Affine-111"><a href="#Affine-111"><span class="linenos">111</span></a>        <span class="k">return</span> <span class="n">DataFormat</span><span class="o">.</span><span class="n">voxel_displacements</span><span class="p">()</span>
</span><span id="Affine-112"><a href="#Affine-112"><span class="linenos">112</span></a>
</span><span id="Affine-113"><a href="#Affine-113"><span class="linenos">113</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">masked_coordinates</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="Affine-114"><a href="#Affine-114"><span class="linenos">114</span></a>        <span class="k">return</span> <span class="n">masked_coordinates</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="p">)</span>
</span><span id="Affine-115"><a href="#Affine-115"><span class="linenos">115</span></a>
</span><span id="Affine-116"><a href="#Affine-116"><span class="linenos">116</span></a>    <span class="k">def</span> <span class="nf">_get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]:</span>
</span><span id="Affine-117"><a href="#Affine-117"><span class="linenos">117</span></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;transformation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="p">}</span>
</span><span id="Affine-118"><a href="#Affine-118"><span class="linenos">118</span></a>
</span><span id="Affine-119"><a href="#Affine-119"><span class="linenos">119</span></a>    <span class="k">def</span> <span class="nf">_get_tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="Affine-120"><a href="#Affine-120"><span class="linenos">120</span></a>        <span class="k">return</span> <span class="p">{}</span>
</span><span id="Affine-121"><a href="#Affine-121"><span class="linenos">121</span></a>
</span><span id="Affine-122"><a href="#Affine-122"><span class="linenos">122</span></a>    <span class="k">def</span> <span class="nf">_modified_copy</span><span class="p">(</span>
</span><span id="Affine-123"><a href="#Affine-123"><span class="linenos">123</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">tensors</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">children</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]</span>
</span><span id="Affine-124"><a href="#Affine-124"><span class="linenos">124</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Affine&quot;</span><span class="p">:</span>
</span><span id="Affine-125"><a href="#Affine-125"><span class="linenos">125</span></a>        <span class="k">return</span> <span class="n">Affine</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">IAffineTransformation</span><span class="p">,</span> <span class="n">children</span><span class="p">[</span><span class="s2">&quot;transformation&quot;</span><span class="p">]))</span>
</span><span id="Affine-126"><a href="#Affine-126"><span class="linenos">126</span></a>
</span><span id="Affine-127"><a href="#Affine-127"><span class="linenos">127</span></a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ComposableMapping</span><span class="p">:</span>
</span><span id="Affine-128"><a href="#Affine-128"><span class="linenos">128</span></a>        <span class="k">return</span> <span class="n">Affine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="o">.</span><span class="n">invert</span><span class="p">())</span>
</span><span id="Affine-129"><a href="#Affine-129"><span class="linenos">129</span></a>
</span><span id="Affine-130"><a href="#Affine-130"><span class="linenos">130</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Affine-131"><a href="#Affine-131"><span class="linenos">131</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Affine(transformation=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="si">}</span><span class="s2">)&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Affine mapping.</p>

<p>This class represents an affine transformation applicable to mappable
tensors. In essence, it is a wrapper around an affine transformation object
which acts on PyTorch tensors. Since it is a composable mapping, it can be
composed with other mappings.</p>

<p>Recommended way to create an affine transformation is to use the factory
functions provided in this module or as class methods of this class:
<code><a href="#affine">affine</a></code>, <code><a href="#diagonal_affine">diagonal_affine</a></code>, <code><a href="#Affine.identity">Affine.identity</a></code>,
<code><a href="#Affine.from_matrix">Affine.from_matrix</a></code>, <code><a href="#Affine.from_diagonal_and_translation">Affine.from_diagonal_and_translation</a></code>.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>transformation:</strong>  The wrapped affine transformation acting on PyTorch tensors.</li>
</ul>
</div>


                            <div id="Affine.__init__" class="classattr">
                                        <input id="Affine.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Affine</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">transformation</span><span class="p">:</span> <span class="n"><a href="composable_mapping/affine_transformation.html#IAffineTransformation">composable_mapping.affine_transformation.IAffineTransformation</a></span></span>)</span>

                <label class="view-source-button" for="Affine.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Affine.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Affine.__init__-39"><a href="#Affine.__init__-39"><span class="linenos">39</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transformation</span><span class="p">:</span> <span class="n">IAffineTransformation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Affine.__init__-40"><a href="#Affine.__init__-40"><span class="linenos">40</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="p">:</span> <span class="n">IAffineTransformation</span> <span class="o">=</span> <span class="n">transformation</span>
</span><span id="Affine.__init__-41"><a href="#Affine.__init__-41"><span class="linenos">41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The wrapped affine transformation action on PyTorch tensors.&quot;&quot;&quot;</span>
</span></pre></div>


    

                            </div>
                            <div id="Affine.transformation" class="classattr">
                                <div class="attr variable">
            <span class="name">transformation</span><span class="annotation">: <a href="composable_mapping/affine_transformation.html#IAffineTransformation">composable_mapping.affine_transformation.IAffineTransformation</a></span>

        
    </div>
    <a class="headerlink" href="#Affine.transformation"></a>
    
            <div class="docstring"><p>The wrapped affine transformation action on PyTorch tensors.</p>
</div>


                            </div>
                            <div id="Affine.from_matrix" class="classattr">
                                        <input id="Affine.from_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">matrix</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n"><a href="#Affine">Affine</a></span>:</span></span>

                <label class="view-source-button" for="Affine.from_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Affine.from_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Affine.from_matrix-43"><a href="#Affine.from_matrix-43"><span class="linenos">43</span></a>    <span class="nd">@classmethod</span>
</span><span id="Affine.from_matrix-44"><a href="#Affine.from_matrix-44"><span class="linenos">44</span></a>    <span class="k">def</span> <span class="nf">from_matrix</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Affine&quot;</span><span class="p">:</span>
</span><span id="Affine.from_matrix-45"><a href="#Affine.from_matrix-45"><span class="linenos">45</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create affine mapping from an affine transformation matrix.</span>
</span><span id="Affine.from_matrix-46"><a href="#Affine.from_matrix-46"><span class="linenos">46</span></a>
</span><span id="Affine.from_matrix-47"><a href="#Affine.from_matrix-47"><span class="linenos">47</span></a><span class="sd">        Args:</span>
</span><span id="Affine.from_matrix-48"><a href="#Affine.from_matrix-48"><span class="linenos">48</span></a><span class="sd">            matrix: Affine transformation matrix with shape</span>
</span><span id="Affine.from_matrix-49"><a href="#Affine.from_matrix-49"><span class="linenos">49</span></a><span class="sd">                ([*batch_shape, ]n_output_dims + 1, n_input_dims + 1[, *spatial_shape]).</span>
</span><span id="Affine.from_matrix-50"><a href="#Affine.from_matrix-50"><span class="linenos">50</span></a>
</span><span id="Affine.from_matrix-51"><a href="#Affine.from_matrix-51"><span class="linenos">51</span></a><span class="sd">        Returns:</span>
</span><span id="Affine.from_matrix-52"><a href="#Affine.from_matrix-52"><span class="linenos">52</span></a><span class="sd">            Affine mapping.</span>
</span><span id="Affine.from_matrix-53"><a href="#Affine.from_matrix-53"><span class="linenos">53</span></a>
</span><span id="Affine.from_matrix-54"><a href="#Affine.from_matrix-54"><span class="linenos">54</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Affine.from_matrix-55"><a href="#Affine.from_matrix-55"><span class="linenos">55</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">AffineTransformation</span><span class="p">(</span><span class="n">matrix</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Create affine mapping from an affine transformation matrix.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>matrix:</strong>  Affine transformation matrix with shape
([*batch_shape, ]n_output_dims + 1, n_input_dims + 1[, *spatial_shape]).</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Affine mapping.</p>
</blockquote>
</div>


                            </div>
                            <div id="Affine.from_diagonal_and_translation" class="classattr">
                                        <input id="Affine.from_diagonal_and_translation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_diagonal_and_translation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">diagonal</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">translation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">matrix_shape</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#Affine">Affine</a></span>:</span></span>

                <label class="view-source-button" for="Affine.from_diagonal_and_translation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Affine.from_diagonal_and_translation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Affine.from_diagonal_and_translation-57"><a href="#Affine.from_diagonal_and_translation-57"><span class="linenos">57</span></a>    <span class="nd">@classmethod</span>
</span><span id="Affine.from_diagonal_and_translation-58"><a href="#Affine.from_diagonal_and_translation-58"><span class="linenos">58</span></a>    <span class="k">def</span> <span class="nf">from_diagonal_and_translation</span><span class="p">(</span>
</span><span id="Affine.from_diagonal_and_translation-59"><a href="#Affine.from_diagonal_and_translation-59"><span class="linenos">59</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="Affine.from_diagonal_and_translation-60"><a href="#Affine.from_diagonal_and_translation-60"><span class="linenos">60</span></a>        <span class="n">diagonal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Affine.from_diagonal_and_translation-61"><a href="#Affine.from_diagonal_and_translation-61"><span class="linenos">61</span></a>        <span class="n">translation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Affine.from_diagonal_and_translation-62"><a href="#Affine.from_diagonal_and_translation-62"><span class="linenos">62</span></a>        <span class="n">matrix_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Affine.from_diagonal_and_translation-63"><a href="#Affine.from_diagonal_and_translation-63"><span class="linenos">63</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Affine.from_diagonal_and_translation-64"><a href="#Affine.from_diagonal_and_translation-64"><span class="linenos">64</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Affine.from_diagonal_and_translation-65"><a href="#Affine.from_diagonal_and_translation-65"><span class="linenos">65</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Affine&quot;</span><span class="p">:</span>
</span><span id="Affine.from_diagonal_and_translation-66"><a href="#Affine.from_diagonal_and_translation-66"><span class="linenos">66</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create affine mapping from diagonal and translation</span>
</span><span id="Affine.from_diagonal_and_translation-67"><a href="#Affine.from_diagonal_and_translation-67"><span class="linenos">67</span></a>
</span><span id="Affine.from_diagonal_and_translation-68"><a href="#Affine.from_diagonal_and_translation-68"><span class="linenos">68</span></a><span class="sd">        Args:</span>
</span><span id="Affine.from_diagonal_and_translation-69"><a href="#Affine.from_diagonal_and_translation-69"><span class="linenos">69</span></a><span class="sd">            diagonal: Diagonal of the affine transformation matrix with shape</span>
</span><span id="Affine.from_diagonal_and_translation-70"><a href="#Affine.from_diagonal_and_translation-70"><span class="linenos">70</span></a><span class="sd">                ([*batch_shape, ]diagonal_length[, *spatial_shape]).</span>
</span><span id="Affine.from_diagonal_and_translation-71"><a href="#Affine.from_diagonal_and_translation-71"><span class="linenos">71</span></a><span class="sd">            translation: Translation of the affine transformation matrix</span>
</span><span id="Affine.from_diagonal_and_translation-72"><a href="#Affine.from_diagonal_and_translation-72"><span class="linenos">72</span></a><span class="sd">                with shape ([*batch_shape, ]n_output_dims[, *spatial_shape]).</span>
</span><span id="Affine.from_diagonal_and_translation-73"><a href="#Affine.from_diagonal_and_translation-73"><span class="linenos">73</span></a><span class="sd">            matrix_shape: Shape of the affine transformation matrix in format</span>
</span><span id="Affine.from_diagonal_and_translation-74"><a href="#Affine.from_diagonal_and_translation-74"><span class="linenos">74</span></a><span class="sd">                ([*batch_shape, ]n_output_dims + 1, n_input_dims + 1[, *spatial_shape]).</span>
</span><span id="Affine.from_diagonal_and_translation-75"><a href="#Affine.from_diagonal_and_translation-75"><span class="linenos">75</span></a><span class="sd">            dtype: Data type of the affine transformation matrix, needed only if diagonal</span>
</span><span id="Affine.from_diagonal_and_translation-76"><a href="#Affine.from_diagonal_and_translation-76"><span class="linenos">76</span></a><span class="sd">                and translation are not provided.</span>
</span><span id="Affine.from_diagonal_and_translation-77"><a href="#Affine.from_diagonal_and_translation-77"><span class="linenos">77</span></a><span class="sd">            device: Device of the affine transformation matrix, needed only if diagonal</span>
</span><span id="Affine.from_diagonal_and_translation-78"><a href="#Affine.from_diagonal_and_translation-78"><span class="linenos">78</span></a><span class="sd">                and translation are not provided.</span>
</span><span id="Affine.from_diagonal_and_translation-79"><a href="#Affine.from_diagonal_and_translation-79"><span class="linenos">79</span></a>
</span><span id="Affine.from_diagonal_and_translation-80"><a href="#Affine.from_diagonal_and_translation-80"><span class="linenos">80</span></a><span class="sd">        Returns:</span>
</span><span id="Affine.from_diagonal_and_translation-81"><a href="#Affine.from_diagonal_and_translation-81"><span class="linenos">81</span></a><span class="sd">            Affine mapping.</span>
</span><span id="Affine.from_diagonal_and_translation-82"><a href="#Affine.from_diagonal_and_translation-82"><span class="linenos">82</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Affine.from_diagonal_and_translation-83"><a href="#Affine.from_diagonal_and_translation-83"><span class="linenos">83</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
</span><span id="Affine.from_diagonal_and_translation-84"><a href="#Affine.from_diagonal_and_translation-84"><span class="linenos">84</span></a>            <span class="n">DiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="Affine.from_diagonal_and_translation-85"><a href="#Affine.from_diagonal_and_translation-85"><span class="linenos">85</span></a>                <span class="n">diagonal</span><span class="o">=</span><span class="n">diagonal</span><span class="p">,</span>
</span><span id="Affine.from_diagonal_and_translation-86"><a href="#Affine.from_diagonal_and_translation-86"><span class="linenos">86</span></a>                <span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">,</span>
</span><span id="Affine.from_diagonal_and_translation-87"><a href="#Affine.from_diagonal_and_translation-87"><span class="linenos">87</span></a>                <span class="n">matrix_shape</span><span class="o">=</span><span class="n">matrix_shape</span><span class="p">,</span>
</span><span id="Affine.from_diagonal_and_translation-88"><a href="#Affine.from_diagonal_and_translation-88"><span class="linenos">88</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="Affine.from_diagonal_and_translation-89"><a href="#Affine.from_diagonal_and_translation-89"><span class="linenos">89</span></a>                <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="Affine.from_diagonal_and_translation-90"><a href="#Affine.from_diagonal_and_translation-90"><span class="linenos">90</span></a>            <span class="p">)</span>
</span><span id="Affine.from_diagonal_and_translation-91"><a href="#Affine.from_diagonal_and_translation-91"><span class="linenos">91</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create affine mapping from diagonal and translation</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>diagonal:</strong>  Diagonal of the affine transformation matrix with shape
([*batch_shape, ]diagonal_length[, *spatial_shape]).</li>
<li><strong>translation:</strong>  Translation of the affine transformation matrix
with shape ([*batch_shape, ]n_output_dims[, *spatial_shape]).</li>
<li><strong>matrix_shape:</strong>  Shape of the affine transformation matrix in format
([*batch_shape, ]n_output_dims + 1, n_input_dims + 1[, *spatial_shape]).</li>
<li><strong>dtype:</strong>  Data type of the affine transformation matrix, needed only if diagonal
and translation are not provided.</li>
<li><strong>device:</strong>  Device of the affine transformation matrix, needed only if diagonal
and translation are not provided.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Affine mapping.</p>
</blockquote>
</div>


                            </div>
                            <div id="Affine.identity" class="classattr">
                                        <input id="Affine.identity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">identity</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">n_dims</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#Affine">Affine</a></span>:</span></span>

                <label class="view-source-button" for="Affine.identity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Affine.identity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Affine.identity-93"><a href="#Affine.identity-93"><span class="linenos"> 93</span></a>    <span class="nd">@classmethod</span>
</span><span id="Affine.identity-94"><a href="#Affine.identity-94"><span class="linenos"> 94</span></a>    <span class="k">def</span> <span class="nf">identity</span><span class="p">(</span>
</span><span id="Affine.identity-95"><a href="#Affine.identity-95"><span class="linenos"> 95</span></a>        <span class="bp">cls</span><span class="p">,</span> <span class="n">n_dims</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Affine.identity-96"><a href="#Affine.identity-96"><span class="linenos"> 96</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Affine&quot;</span><span class="p">:</span>
</span><span id="Affine.identity-97"><a href="#Affine.identity-97"><span class="linenos"> 97</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create identity affine mapping.</span>
</span><span id="Affine.identity-98"><a href="#Affine.identity-98"><span class="linenos"> 98</span></a>
</span><span id="Affine.identity-99"><a href="#Affine.identity-99"><span class="linenos"> 99</span></a><span class="sd">        Args:</span>
</span><span id="Affine.identity-100"><a href="#Affine.identity-100"><span class="linenos">100</span></a><span class="sd">            n_dims: Number of input and output dimensions of the identity affine mapping.</span>
</span><span id="Affine.identity-101"><a href="#Affine.identity-101"><span class="linenos">101</span></a><span class="sd">            dtype: Data type of the identity affine mapping.</span>
</span><span id="Affine.identity-102"><a href="#Affine.identity-102"><span class="linenos">102</span></a><span class="sd">            device: Device of the identity affine mapping.</span>
</span><span id="Affine.identity-103"><a href="#Affine.identity-103"><span class="linenos">103</span></a>
</span><span id="Affine.identity-104"><a href="#Affine.identity-104"><span class="linenos">104</span></a><span class="sd">        Returns:</span>
</span><span id="Affine.identity-105"><a href="#Affine.identity-105"><span class="linenos">105</span></a><span class="sd">            Identity affine mapping.</span>
</span><span id="Affine.identity-106"><a href="#Affine.identity-106"><span class="linenos">106</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Affine.identity-107"><a href="#Affine.identity-107"><span class="linenos">107</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">IdentityAffineTransformation</span><span class="p">(</span><span class="n">n_dims</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Create identity affine mapping.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>n_dims:</strong>  Number of input and output dimensions of the identity affine mapping.</li>
<li><strong>dtype:</strong>  Data type of the identity affine mapping.</li>
<li><strong>device:</strong>  Device of the identity affine mapping.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Identity affine mapping.</p>
</blockquote>
</div>


                            </div>
                            <div id="Affine.default_sampling_data_format" class="classattr">
                                        <input id="Affine.default_sampling_data_format-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">default_sampling_data_format</span><span class="annotation">: <a href="#DataFormat">DataFormat</a></span>

                <label class="view-source-button" for="Affine.default_sampling_data_format-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Affine.default_sampling_data_format"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Affine.default_sampling_data_format-109"><a href="#Affine.default_sampling_data_format-109"><span class="linenos">109</span></a>    <span class="nd">@property</span>
</span><span id="Affine.default_sampling_data_format-110"><a href="#Affine.default_sampling_data_format-110"><span class="linenos">110</span></a>    <span class="k">def</span> <span class="nf">default_sampling_data_format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFormat</span><span class="p">:</span>
</span><span id="Affine.default_sampling_data_format-111"><a href="#Affine.default_sampling_data_format-111"><span class="linenos">111</span></a>        <span class="k">return</span> <span class="n">DataFormat</span><span class="o">.</span><span class="n">voxel_displacements</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Default data format to use in sampling and resampling operations for
the mapping.</p>

<p>If None, <a href="#DataFormat.world_coordinates">DataFormat.world_coordinates()</a> will be used but the behaviour
in operations with other mappings is different as the default data format
of the other mapping will be used.</p>
</div>


                            </div>
                            <div id="Affine.invert" class="classattr">
                                        <input id="Affine.invert-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">invert</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="o">**</span><span class="n">arguments</span></span><span class="return-annotation">) -> <span class="n"><a href="#ComposableMapping">ComposableMapping</a></span>:</span></span>

                <label class="view-source-button" for="Affine.invert-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Affine.invert"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Affine.invert-127"><a href="#Affine.invert-127"><span class="linenos">127</span></a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ComposableMapping</span><span class="p">:</span>
</span><span id="Affine.invert-128"><a href="#Affine.invert-128"><span class="linenos">128</span></a>        <span class="k">return</span> <span class="n">Affine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation</span><span class="o">.</span><span class="n">invert</span><span class="p">())</span>
</span></pre></div>


            <div class="docstring"><p>Invert the mapping.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>arguments:</strong>  Arguments for the inversion.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>The inverted mapping.</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>composable_mapping.tensor_like.BaseTensorLikeWrapper</dt>
                                <dd id="Affine.dtype" class="variable">dtype</dd>
                <dd id="Affine.device" class="variable">device</dd>
                <dd id="Affine.cast" class="function">cast</dd>
                <dd id="Affine.pin_memory" class="function">pin_memory</dd>
                <dd id="Affine.detach" class="function">detach</dd>

            </div>
            <div><dt><a href="#ComposableMapping">ComposableMapping</a></dt>
                                <dd id="Affine.sample_to" class="function"><a href="#ComposableMapping.sample_to">sample_to</a></dd>
                <dd id="Affine.resample_to" class="function"><a href="#ComposableMapping.resample_to">resample_to</a></dd>
                <dd id="Affine.assign_coordinates" class="function"><a href="#ComposableMapping.assign_coordinates">assign_coordinates</a></dd>
                <dd id="Affine.as_affine_transformation" class="function"><a href="#ComposableMapping.as_affine_transformation">as_affine_transformation</a></dd>
                <dd id="Affine.as_affine_matrix" class="function"><a href="#ComposableMapping.as_affine_matrix">as_affine_matrix</a></dd>
                <dd id="Affine.set_default_sampling_data_format" class="function"><a href="#ComposableMapping.set_default_sampling_data_format">set_default_sampling_data_format</a></dd>
                <dd id="Affine.__matmul__" class="function"><a href="#ComposableMapping.__matmul__">__matmul__</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="BaseSeparableSampler">
                            <input id="BaseSeparableSampler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">BaseSeparableSampler</span><wbr>(<span class="base"><a href="#ISampler">composable_mapping.ISampler</a></span>):

                <label class="view-source-button" for="BaseSeparableSampler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseSeparableSampler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseSeparableSampler-105"><a href="#BaseSeparableSampler-105"><span class="linenos">105</span></a><span class="k">class</span> <span class="nc">BaseSeparableSampler</span><span class="p">(</span><span class="n">ISampler</span><span class="p">):</span>
</span><span id="BaseSeparableSampler-106"><a href="#BaseSeparableSampler-106"><span class="linenos">106</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base sampler in voxel coordinates which can be implemented as a</span>
</span><span id="BaseSeparableSampler-107"><a href="#BaseSeparableSampler-107"><span class="linenos">107</span></a><span class="sd">    separable convolution</span>
</span><span id="BaseSeparableSampler-108"><a href="#BaseSeparableSampler-108"><span class="linenos">108</span></a>
</span><span id="BaseSeparableSampler-109"><a href="#BaseSeparableSampler-109"><span class="linenos">109</span></a><span class="sd">    Arguments:</span>
</span><span id="BaseSeparableSampler-110"><a href="#BaseSeparableSampler-110"><span class="linenos">110</span></a><span class="sd">        extrapolation_mode: Extrapolation mode for out-of-bound coordinates.</span>
</span><span id="BaseSeparableSampler-111"><a href="#BaseSeparableSampler-111"><span class="linenos">111</span></a><span class="sd">        mask_extrapolated_regions_for_empty_volume_mask: Whether to mask</span>
</span><span id="BaseSeparableSampler-112"><a href="#BaseSeparableSampler-112"><span class="linenos">112</span></a><span class="sd">            extrapolated regions when input volume mask is empty.</span>
</span><span id="BaseSeparableSampler-113"><a href="#BaseSeparableSampler-113"><span class="linenos">113</span></a><span class="sd">        convolution_threshold: Maximum allowed difference in coordinates</span>
</span><span id="BaseSeparableSampler-114"><a href="#BaseSeparableSampler-114"><span class="linenos">114</span></a><span class="sd">            for using convolution-based sampling (the difference might be upper</span>
</span><span id="BaseSeparableSampler-115"><a href="#BaseSeparableSampler-115"><span class="linenos">115</span></a><span class="sd">            bounded when doing the decision).</span>
</span><span id="BaseSeparableSampler-116"><a href="#BaseSeparableSampler-116"><span class="linenos">116</span></a><span class="sd">        mask_threshold: Maximum allowed weight for masked regions in a</span>
</span><span id="BaseSeparableSampler-117"><a href="#BaseSeparableSampler-117"><span class="linenos">117</span></a><span class="sd">            sampled location to still consider it valid (non-masked).</span>
</span><span id="BaseSeparableSampler-118"><a href="#BaseSeparableSampler-118"><span class="linenos">118</span></a><span class="sd">        limit_direction: Direction for evaluating the kernel at</span>
</span><span id="BaseSeparableSampler-119"><a href="#BaseSeparableSampler-119"><span class="linenos">119</span></a><span class="sd">            discontinuous points.</span>
</span><span id="BaseSeparableSampler-120"><a href="#BaseSeparableSampler-120"><span class="linenos">120</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="BaseSeparableSampler-121"><a href="#BaseSeparableSampler-121"><span class="linenos">121</span></a>
</span><span id="BaseSeparableSampler-122"><a href="#BaseSeparableSampler-122"><span class="linenos">122</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-123"><a href="#BaseSeparableSampler-123"><span class="linenos">123</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-124"><a href="#BaseSeparableSampler-124"><span class="linenos">124</span></a>        <span class="n">extrapolation_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-125"><a href="#BaseSeparableSampler-125"><span class="linenos">125</span></a>        <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-126"><a href="#BaseSeparableSampler-126"><span class="linenos">126</span></a>        <span class="n">convolution_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-127"><a href="#BaseSeparableSampler-127"><span class="linenos">127</span></a>        <span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-128"><a href="#BaseSeparableSampler-128"><span class="linenos">128</span></a>        <span class="n">limit_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">LimitDirection</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">LimitDirection</span><span class="p">]],</span>
</span><span id="BaseSeparableSampler-129"><a href="#BaseSeparableSampler-129"><span class="linenos">129</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-130"><a href="#BaseSeparableSampler-130"><span class="linenos">130</span></a>        <span class="k">if</span> <span class="n">extrapolation_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span> <span class="s2">&quot;border&quot;</span><span class="p">,</span> <span class="s2">&quot;reflection&quot;</span><span class="p">):</span>
</span><span id="BaseSeparableSampler-131"><a href="#BaseSeparableSampler-131"><span class="linenos">131</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown extrapolation mode&quot;</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-132"><a href="#BaseSeparableSampler-132"><span class="linenos">132</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_extrapolation_mode</span> <span class="o">=</span> <span class="n">extrapolation_mode</span>
</span><span id="BaseSeparableSampler-133"><a href="#BaseSeparableSampler-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_extrapolated_regions_for_empty_volume_mask</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BaseSeparableSampler-134"><a href="#BaseSeparableSampler-134"><span class="linenos">134</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="BaseSeparableSampler-135"><a href="#BaseSeparableSampler-135"><span class="linenos">135</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-136"><a href="#BaseSeparableSampler-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_convolution_threshold</span> <span class="o">=</span> <span class="n">convolution_threshold</span>
</span><span id="BaseSeparableSampler-137"><a href="#BaseSeparableSampler-137"><span class="linenos">137</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span> <span class="o">=</span> <span class="n">mask_threshold</span>
</span><span id="BaseSeparableSampler-138"><a href="#BaseSeparableSampler-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_limit_direction</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BaseSeparableSampler-139"><a href="#BaseSeparableSampler-139"><span class="linenos">139</span></a>            <span class="n">limit_direction</span><span class="o">.</span><span class="n">as_callable</span><span class="p">()</span>
</span><span id="BaseSeparableSampler-140"><a href="#BaseSeparableSampler-140"><span class="linenos">140</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">limit_direction</span><span class="p">,</span> <span class="n">LimitDirection</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-141"><a href="#BaseSeparableSampler-141"><span class="linenos">141</span></a>            <span class="k">else</span> <span class="n">limit_direction</span>
</span><span id="BaseSeparableSampler-142"><a href="#BaseSeparableSampler-142"><span class="linenos">142</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-143"><a href="#BaseSeparableSampler-143"><span class="linenos">143</span></a>
</span><span id="BaseSeparableSampler-144"><a href="#BaseSeparableSampler-144"><span class="linenos">144</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="BaseSeparableSampler-145"><a href="#BaseSeparableSampler-145"><span class="linenos">145</span></a>    <span class="k">def</span> <span class="nf">_kernel_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ISeparableKernelSupport</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-146"><a href="#BaseSeparableSampler-146"><span class="linenos">146</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Kernel support function for the interpolation kernel</span>
</span><span id="BaseSeparableSampler-147"><a href="#BaseSeparableSampler-147"><span class="linenos">147</span></a>
</span><span id="BaseSeparableSampler-148"><a href="#BaseSeparableSampler-148"><span class="linenos">148</span></a><span class="sd">        Args:</span>
</span><span id="BaseSeparableSampler-149"><a href="#BaseSeparableSampler-149"><span class="linenos">149</span></a><span class="sd">            spatial_dim: Spatial dimension for which to obtain the kernel support</span>
</span><span id="BaseSeparableSampler-150"><a href="#BaseSeparableSampler-150"><span class="linenos">150</span></a>
</span><span id="BaseSeparableSampler-151"><a href="#BaseSeparableSampler-151"><span class="linenos">151</span></a><span class="sd">        Returns:</span>
</span><span id="BaseSeparableSampler-152"><a href="#BaseSeparableSampler-152"><span class="linenos">152</span></a><span class="sd">            Kernel support function for the kernel.</span>
</span><span id="BaseSeparableSampler-153"><a href="#BaseSeparableSampler-153"><span class="linenos">153</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseSeparableSampler-154"><a href="#BaseSeparableSampler-154"><span class="linenos">154</span></a>
</span><span id="BaseSeparableSampler-155"><a href="#BaseSeparableSampler-155"><span class="linenos">155</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="BaseSeparableSampler-156"><a href="#BaseSeparableSampler-156"><span class="linenos">156</span></a>    <span class="k">def</span> <span class="nf">_is_interpolating_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-157"><a href="#BaseSeparableSampler-157"><span class="linenos">157</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Is the kernel is interpolating.</span>
</span><span id="BaseSeparableSampler-158"><a href="#BaseSeparableSampler-158"><span class="linenos">158</span></a>
</span><span id="BaseSeparableSampler-159"><a href="#BaseSeparableSampler-159"><span class="linenos">159</span></a><span class="sd">        Args:</span>
</span><span id="BaseSeparableSampler-160"><a href="#BaseSeparableSampler-160"><span class="linenos">160</span></a><span class="sd">            spatial_dim: Spatial dimension for which to obtain the information.</span>
</span><span id="BaseSeparableSampler-161"><a href="#BaseSeparableSampler-161"><span class="linenos">161</span></a>
</span><span id="BaseSeparableSampler-162"><a href="#BaseSeparableSampler-162"><span class="linenos">162</span></a><span class="sd">        Returns:</span>
</span><span id="BaseSeparableSampler-163"><a href="#BaseSeparableSampler-163"><span class="linenos">163</span></a><span class="sd">            Whether the kernel is interpolating over the specified spatial dimension.</span>
</span><span id="BaseSeparableSampler-164"><a href="#BaseSeparableSampler-164"><span class="linenos">164</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseSeparableSampler-165"><a href="#BaseSeparableSampler-165"><span class="linenos">165</span></a>
</span><span id="BaseSeparableSampler-166"><a href="#BaseSeparableSampler-166"><span class="linenos">166</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="BaseSeparableSampler-167"><a href="#BaseSeparableSampler-167"><span class="linenos">167</span></a>    <span class="k">def</span> <span class="nf">_left_limit_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-168"><a href="#BaseSeparableSampler-168"><span class="linenos">168</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate the interpolation kernel for the given 1d coordinates with the</span>
</span><span id="BaseSeparableSampler-169"><a href="#BaseSeparableSampler-169"><span class="linenos">169</span></a><span class="sd">        discontinuous points evaluated as left limit.</span>
</span><span id="BaseSeparableSampler-170"><a href="#BaseSeparableSampler-170"><span class="linenos">170</span></a>
</span><span id="BaseSeparableSampler-171"><a href="#BaseSeparableSampler-171"><span class="linenos">171</span></a><span class="sd">        Args:</span>
</span><span id="BaseSeparableSampler-172"><a href="#BaseSeparableSampler-172"><span class="linenos">172</span></a><span class="sd">            coordinates: 1d coordinates with shape (n_coordinates,)</span>
</span><span id="BaseSeparableSampler-173"><a href="#BaseSeparableSampler-173"><span class="linenos">173</span></a><span class="sd">            spatial_dim: Spatial dimension for which to evaluate the kernel</span>
</span><span id="BaseSeparableSampler-174"><a href="#BaseSeparableSampler-174"><span class="linenos">174</span></a>
</span><span id="BaseSeparableSampler-175"><a href="#BaseSeparableSampler-175"><span class="linenos">175</span></a><span class="sd">        Returns:</span>
</span><span id="BaseSeparableSampler-176"><a href="#BaseSeparableSampler-176"><span class="linenos">176</span></a><span class="sd">            Interpolation kernel evaluated at the given coordinates.</span>
</span><span id="BaseSeparableSampler-177"><a href="#BaseSeparableSampler-177"><span class="linenos">177</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseSeparableSampler-178"><a href="#BaseSeparableSampler-178"><span class="linenos">178</span></a>
</span><span id="BaseSeparableSampler-179"><a href="#BaseSeparableSampler-179"><span class="linenos">179</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="BaseSeparableSampler-180"><a href="#BaseSeparableSampler-180"><span class="linenos">180</span></a>    <span class="k">def</span> <span class="nf">_right_limit_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-181"><a href="#BaseSeparableSampler-181"><span class="linenos">181</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate the interpolation kernel for the given 1d coordinates with the</span>
</span><span id="BaseSeparableSampler-182"><a href="#BaseSeparableSampler-182"><span class="linenos">182</span></a><span class="sd">        discontinuous points evaluated as right limit.</span>
</span><span id="BaseSeparableSampler-183"><a href="#BaseSeparableSampler-183"><span class="linenos">183</span></a>
</span><span id="BaseSeparableSampler-184"><a href="#BaseSeparableSampler-184"><span class="linenos">184</span></a><span class="sd">        Args:</span>
</span><span id="BaseSeparableSampler-185"><a href="#BaseSeparableSampler-185"><span class="linenos">185</span></a><span class="sd">            coordinates: 1d coordinates with shape (n_coordinates,)</span>
</span><span id="BaseSeparableSampler-186"><a href="#BaseSeparableSampler-186"><span class="linenos">186</span></a><span class="sd">            spatial_dim: Spatial dimension for which to evaluate the kernel</span>
</span><span id="BaseSeparableSampler-187"><a href="#BaseSeparableSampler-187"><span class="linenos">187</span></a>
</span><span id="BaseSeparableSampler-188"><a href="#BaseSeparableSampler-188"><span class="linenos">188</span></a><span class="sd">        Returns:</span>
</span><span id="BaseSeparableSampler-189"><a href="#BaseSeparableSampler-189"><span class="linenos">189</span></a><span class="sd">            Interpolation kernel evaluated at the given coordinates.</span>
</span><span id="BaseSeparableSampler-190"><a href="#BaseSeparableSampler-190"><span class="linenos">190</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BaseSeparableSampler-191"><a href="#BaseSeparableSampler-191"><span class="linenos">191</span></a>
</span><span id="BaseSeparableSampler-192"><a href="#BaseSeparableSampler-192"><span class="linenos">192</span></a>    <span class="k">def</span> <span class="nf">_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-193"><a href="#BaseSeparableSampler-193"><span class="linenos">193</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_direction</span><span class="p">(</span><span class="n">spatial_dim</span><span class="p">)</span> <span class="o">==</span> <span class="n">LimitDirection</span><span class="o">.</span><span class="n">left</span><span class="p">():</span>
</span><span id="BaseSeparableSampler-194"><a href="#BaseSeparableSampler-194"><span class="linenos">194</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_left_limit_kernel</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-195"><a href="#BaseSeparableSampler-195"><span class="linenos">195</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_direction</span><span class="p">(</span><span class="n">spatial_dim</span><span class="p">)</span> <span class="o">==</span> <span class="n">LimitDirection</span><span class="o">.</span><span class="n">right</span><span class="p">():</span>
</span><span id="BaseSeparableSampler-196"><a href="#BaseSeparableSampler-196"><span class="linenos">196</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_right_limit_kernel</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-197"><a href="#BaseSeparableSampler-197"><span class="linenos">197</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit_direction</span><span class="p">(</span><span class="n">spatial_dim</span><span class="p">)</span> <span class="o">==</span> <span class="n">LimitDirection</span><span class="o">.</span><span class="n">average</span><span class="p">():</span>
</span><span id="BaseSeparableSampler-198"><a href="#BaseSeparableSampler-198"><span class="linenos">198</span></a>            <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span>
</span><span id="BaseSeparableSampler-199"><a href="#BaseSeparableSampler-199"><span class="linenos">199</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_left_limit_kernel</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-200"><a href="#BaseSeparableSampler-200"><span class="linenos">200</span></a>                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_right_limit_kernel</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-201"><a href="#BaseSeparableSampler-201"><span class="linenos">201</span></a>            <span class="p">)</span>
</span><span id="BaseSeparableSampler-202"><a href="#BaseSeparableSampler-202"><span class="linenos">202</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown limit direction&quot;</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-203"><a href="#BaseSeparableSampler-203"><span class="linenos">203</span></a>
</span><span id="BaseSeparableSampler-204"><a href="#BaseSeparableSampler-204"><span class="linenos">204</span></a>    <span class="k">def</span> <span class="nf">derivative</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-205"><a href="#BaseSeparableSampler-205"><span class="linenos">205</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-206"><a href="#BaseSeparableSampler-206"><span class="linenos">206</span></a>        <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-207"><a href="#BaseSeparableSampler-207"><span class="linenos">207</span></a>        <span class="n">limit_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="BaseSeparableSampler-208"><a href="#BaseSeparableSampler-208"><span class="linenos">208</span></a>            <span class="n">LimitDirection</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">LimitDirection</span><span class="p">]</span>
</span><span id="BaseSeparableSampler-209"><a href="#BaseSeparableSampler-209"><span class="linenos">209</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">LimitDirection</span><span class="o">.</span><span class="n">average</span><span class="p">(),</span>
</span><span id="BaseSeparableSampler-210"><a href="#BaseSeparableSampler-210"><span class="linenos">210</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GenericSeparableDerivativeSampler&quot;</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-211"><a href="#BaseSeparableSampler-211"><span class="linenos">211</span></a>        <span class="k">return</span> <span class="n">GenericSeparableDerivativeSampler</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-212"><a href="#BaseSeparableSampler-212"><span class="linenos">212</span></a>            <span class="n">spatial_dim</span><span class="o">=</span><span class="n">spatial_dim</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-213"><a href="#BaseSeparableSampler-213"><span class="linenos">213</span></a>            <span class="n">parent_left_limit_kernel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_left_limit_kernel</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-214"><a href="#BaseSeparableSampler-214"><span class="linenos">214</span></a>            <span class="n">parent_right_limit_kernel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_right_limit_kernel</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-215"><a href="#BaseSeparableSampler-215"><span class="linenos">215</span></a>            <span class="n">parent_kernel_support</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel_support</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-216"><a href="#BaseSeparableSampler-216"><span class="linenos">216</span></a>            <span class="n">parent_is_interpolating_kernel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_interpolating_kernel</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-217"><a href="#BaseSeparableSampler-217"><span class="linenos">217</span></a>            <span class="n">limit_direction</span><span class="o">=</span><span class="n">limit_direction</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-218"><a href="#BaseSeparableSampler-218"><span class="linenos">218</span></a>            <span class="n">extrapolation_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extrapolation_mode</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-219"><a href="#BaseSeparableSampler-219"><span class="linenos">219</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="o">=</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-220"><a href="#BaseSeparableSampler-220"><span class="linenos">220</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="BaseSeparableSampler-221"><a href="#BaseSeparableSampler-221"><span class="linenos">221</span></a>            <span class="p">),</span>
</span><span id="BaseSeparableSampler-222"><a href="#BaseSeparableSampler-222"><span class="linenos">222</span></a>            <span class="n">convolution_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_convolution_threshold</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-223"><a href="#BaseSeparableSampler-223"><span class="linenos">223</span></a>            <span class="n">mask_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-224"><a href="#BaseSeparableSampler-224"><span class="linenos">224</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-225"><a href="#BaseSeparableSampler-225"><span class="linenos">225</span></a>
</span><span id="BaseSeparableSampler-226"><a href="#BaseSeparableSampler-226"><span class="linenos">226</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-227"><a href="#BaseSeparableSampler-227"><span class="linenos">227</span></a>        <span class="k">if</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">n_channel_dims</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-228"><a href="#BaseSeparableSampler-228"><span class="linenos">228</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Interpolation assumes single channel coordinates&quot;</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-229"><a href="#BaseSeparableSampler-229"><span class="linenos">229</span></a>        <span class="k">if</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">):</span>
</span><span id="BaseSeparableSampler-230"><a href="#BaseSeparableSampler-230"><span class="linenos">230</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Interpolation assumes same number of channels as spatial dims&quot;</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-231"><a href="#BaseSeparableSampler-231"><span class="linenos">231</span></a>        <span class="n">interpolated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interpolate_conv</span><span class="p">(</span><span class="n">volume</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-232"><a href="#BaseSeparableSampler-232"><span class="linenos">232</span></a>        <span class="k">if</span> <span class="n">interpolated</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-233"><a href="#BaseSeparableSampler-233"><span class="linenos">233</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interpolate_general</span><span class="p">(</span><span class="n">volume</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-234"><a href="#BaseSeparableSampler-234"><span class="linenos">234</span></a>        <span class="k">return</span> <span class="n">interpolated</span>
</span><span id="BaseSeparableSampler-235"><a href="#BaseSeparableSampler-235"><span class="linenos">235</span></a>
</span><span id="BaseSeparableSampler-236"><a href="#BaseSeparableSampler-236"><span class="linenos">236</span></a>    <span class="nd">@property</span>
</span><span id="BaseSeparableSampler-237"><a href="#BaseSeparableSampler-237"><span class="linenos">237</span></a>    <span class="k">def</span> <span class="nf">_padding_mode_and_value</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
</span><span id="BaseSeparableSampler-238"><a href="#BaseSeparableSampler-238"><span class="linenos">238</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="BaseSeparableSampler-239"><a href="#BaseSeparableSampler-239"><span class="linenos">239</span></a>            <span class="s2">&quot;zeros&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="BaseSeparableSampler-240"><a href="#BaseSeparableSampler-240"><span class="linenos">240</span></a>            <span class="s2">&quot;border&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;replicate&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="BaseSeparableSampler-241"><a href="#BaseSeparableSampler-241"><span class="linenos">241</span></a>            <span class="s2">&quot;reflection&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;reflect&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="BaseSeparableSampler-242"><a href="#BaseSeparableSampler-242"><span class="linenos">242</span></a>        <span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">_extrapolation_mode</span><span class="p">]</span>
</span><span id="BaseSeparableSampler-243"><a href="#BaseSeparableSampler-243"><span class="linenos">243</span></a>
</span><span id="BaseSeparableSampler-244"><a href="#BaseSeparableSampler-244"><span class="linenos">244</span></a>    <span class="k">def</span> <span class="nf">_extract_conv_interpolatable_parameters</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-245"><a href="#BaseSeparableSampler-245"><span class="linenos">245</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-246"><a href="#BaseSeparableSampler-246"><span class="linenos">246</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-247"><a href="#BaseSeparableSampler-247"><span class="linenos">247</span></a>        <span class="n">voxel_coordinates</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-248"><a href="#BaseSeparableSampler-248"><span class="linenos">248</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;FlippingPermutation&quot;</span><span class="p">]]:</span>
</span><span id="BaseSeparableSampler-249"><a href="#BaseSeparableSampler-249"><span class="linenos">249</span></a>        <span class="k">if</span> <span class="n">voxel_coordinates</span><span class="o">.</span><span class="n">displacements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-250"><a href="#BaseSeparableSampler-250"><span class="linenos">250</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="BaseSeparableSampler-251"><a href="#BaseSeparableSampler-251"><span class="linenos">251</span></a>        <span class="n">grid</span> <span class="o">=</span> <span class="n">voxel_coordinates</span><span class="o">.</span><span class="n">grid</span>
</span><span id="BaseSeparableSampler-252"><a href="#BaseSeparableSampler-252"><span class="linenos">252</span></a>        <span class="k">assert</span> <span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="BaseSeparableSampler-253"><a href="#BaseSeparableSampler-253"><span class="linenos">253</span></a>        <span class="n">affine_transformation</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">affine_transformation</span>
</span><span id="BaseSeparableSampler-254"><a href="#BaseSeparableSampler-254"><span class="linenos">254</span></a>        <span class="n">channels_shape</span> <span class="o">=</span> <span class="n">affine_transformation</span><span class="o">.</span><span class="n">channels_shape</span>
</span><span id="BaseSeparableSampler-255"><a href="#BaseSeparableSampler-255"><span class="linenos">255</span></a>        <span class="k">if</span> <span class="n">channels_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">channels_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="BaseSeparableSampler-256"><a href="#BaseSeparableSampler-256"><span class="linenos">256</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="BaseSeparableSampler-257"><a href="#BaseSeparableSampler-257"><span class="linenos">257</span></a>        <span class="n">n_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-258"><a href="#BaseSeparableSampler-258"><span class="linenos">258</span></a>        <span class="n">host_matrix</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">affine_transformation</span><span class="o">.</span><span class="n">as_host_matrix</span><span class="p">()</span>
</span><span id="BaseSeparableSampler-259"><a href="#BaseSeparableSampler-259"><span class="linenos">259</span></a>        <span class="k">if</span> <span class="n">host_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-260"><a href="#BaseSeparableSampler-260"><span class="linenos">260</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="BaseSeparableSampler-261"><a href="#BaseSeparableSampler-261"><span class="linenos">261</span></a>        <span class="n">host_matrix</span> <span class="o">=</span> <span class="n">host_matrix</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-262"><a href="#BaseSeparableSampler-262"><span class="linenos">262</span></a>        <span class="n">flipping_permutation</span> <span class="o">=</span> <span class="n">FlippingPermutation</span><span class="o">.</span><span class="n">obtain_normalizing_flipping_permutation</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-263"><a href="#BaseSeparableSampler-263"><span class="linenos">263</span></a>            <span class="n">host_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BaseSeparableSampler-264"><a href="#BaseSeparableSampler-264"><span class="linenos">264</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-265"><a href="#BaseSeparableSampler-265"><span class="linenos">265</span></a>        <span class="k">if</span> <span class="n">flipping_permutation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-266"><a href="#BaseSeparableSampler-266"><span class="linenos">266</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="BaseSeparableSampler-267"><a href="#BaseSeparableSampler-267"><span class="linenos">267</span></a>        <span class="n">affine_transformation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BaseSeparableSampler-268"><a href="#BaseSeparableSampler-268"><span class="linenos">268</span></a>            <span class="n">flipping_permutation</span><span class="o">.</span><span class="n">as_transformation</span><span class="p">(</span><span class="n">spatial_shape</span><span class="o">=</span><span class="n">volume</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-269"><a href="#BaseSeparableSampler-269"><span class="linenos">269</span></a>            <span class="o">@</span> <span class="n">affine_transformation</span>
</span><span id="BaseSeparableSampler-270"><a href="#BaseSeparableSampler-270"><span class="linenos">270</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-271"><a href="#BaseSeparableSampler-271"><span class="linenos">271</span></a>        <span class="n">host_matrix</span> <span class="o">=</span> <span class="n">affine_transformation</span><span class="o">.</span><span class="n">as_host_matrix</span><span class="p">()</span>
</span><span id="BaseSeparableSampler-272"><a href="#BaseSeparableSampler-272"><span class="linenos">272</span></a>        <span class="k">assert</span> <span class="n">host_matrix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="BaseSeparableSampler-273"><a href="#BaseSeparableSampler-273"><span class="linenos">273</span></a>        <span class="n">host_matrix</span> <span class="o">=</span> <span class="n">host_matrix</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-274"><a href="#BaseSeparableSampler-274"><span class="linenos">274</span></a>        <span class="n">diagonal</span> <span class="o">=</span> <span class="n">host_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
</span><span id="BaseSeparableSampler-275"><a href="#BaseSeparableSampler-275"><span class="linenos">275</span></a>        <span class="k">if</span> <span class="n">diagonal</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-276"><a href="#BaseSeparableSampler-276"><span class="linenos">276</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="BaseSeparableSampler-277"><a href="#BaseSeparableSampler-277"><span class="linenos">277</span></a>        <span class="n">translation</span> <span class="o">=</span> <span class="n">host_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">memory_format</span><span class="o">=</span><span class="n">contiguous_format</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-278"><a href="#BaseSeparableSampler-278"><span class="linenos">278</span></a>
</span><span id="BaseSeparableSampler-279"><a href="#BaseSeparableSampler-279"><span class="linenos">279</span></a>        <span class="n">transposed_convolve</span> <span class="o">=</span> <span class="n">diagonal</span> <span class="o">&lt;</span> <span class="mf">0.75</span>
</span><span id="BaseSeparableSampler-280"><a href="#BaseSeparableSampler-280"><span class="linenos">280</span></a>        <span class="n">downsampling_factor</span> <span class="o">=</span> <span class="n">empty</span><span class="p">(</span><span class="n">diagonal</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">diagonal</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">diagonal</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-281"><a href="#BaseSeparableSampler-281"><span class="linenos">281</span></a>        <span class="n">downsampling_factor</span><span class="p">[</span><span class="o">~</span><span class="n">transposed_convolve</span><span class="p">]</span> <span class="o">=</span> <span class="n">diagonal</span><span class="p">[</span><span class="o">~</span><span class="n">transposed_convolve</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
</span><span id="BaseSeparableSampler-282"><a href="#BaseSeparableSampler-282"><span class="linenos">282</span></a>        <span class="n">downsampling_factor</span><span class="p">[</span><span class="n">transposed_convolve</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">diagonal</span><span class="p">[</span><span class="n">transposed_convolve</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
</span><span id="BaseSeparableSampler-283"><a href="#BaseSeparableSampler-283"><span class="linenos">283</span></a>        <span class="n">rounded_diagonal_matrix</span> <span class="o">=</span> <span class="n">DiagonalAffineMatrixDefinition</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-284"><a href="#BaseSeparableSampler-284"><span class="linenos">284</span></a>            <span class="n">diagonal</span><span class="o">=</span><span class="n">downsampling_factor</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="n">translation</span>
</span><span id="BaseSeparableSampler-285"><a href="#BaseSeparableSampler-285"><span class="linenos">285</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
</span><span id="BaseSeparableSampler-286"><a href="#BaseSeparableSampler-286"><span class="linenos">286</span></a>        <span class="n">difference_matrix</span> <span class="o">=</span> <span class="n">host_matrix</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rounded_diagonal_matrix</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BaseSeparableSampler-287"><a href="#BaseSeparableSampler-287"><span class="linenos">287</span></a>        <span class="n">shape_tensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch_device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-288"><a href="#BaseSeparableSampler-288"><span class="linenos">288</span></a>        <span class="n">max_conv_coordinate_difference_upper_bound</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BaseSeparableSampler-289"><a href="#BaseSeparableSampler-289"><span class="linenos">289</span></a>            <span class="p">(</span><span class="n">difference_matrix</span> <span class="o">*</span> <span class="n">shape_tensor</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="BaseSeparableSampler-290"><a href="#BaseSeparableSampler-290"><span class="linenos">290</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-291"><a href="#BaseSeparableSampler-291"><span class="linenos">291</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">max_conv_coordinate_difference_upper_bound</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convolution_threshold</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="BaseSeparableSampler-292"><a href="#BaseSeparableSampler-292"><span class="linenos">292</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="BaseSeparableSampler-293"><a href="#BaseSeparableSampler-293"><span class="linenos">293</span></a>        <span class="n">interpolating_kernel</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-294"><a href="#BaseSeparableSampler-294"><span class="linenos">294</span></a>            <span class="p">[</span>
</span><span id="BaseSeparableSampler-295"><a href="#BaseSeparableSampler-295"><span class="linenos">295</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_is_interpolating_kernel</span><span class="p">(</span><span class="n">flipping_permutation</span><span class="o">.</span><span class="n">spatial_permutation</span><span class="p">[</span><span class="n">spatial_dim</span><span class="p">])</span>
</span><span id="BaseSeparableSampler-296"><a href="#BaseSeparableSampler-296"><span class="linenos">296</span></a>                <span class="k">for</span> <span class="n">spatial_dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_dims</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-297"><a href="#BaseSeparableSampler-297"><span class="linenos">297</span></a>            <span class="p">],</span>
</span><span id="BaseSeparableSampler-298"><a href="#BaseSeparableSampler-298"><span class="linenos">298</span></a>            <span class="n">device</span><span class="o">=</span><span class="n">torch_device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">),</span>
</span><span id="BaseSeparableSampler-299"><a href="#BaseSeparableSampler-299"><span class="linenos">299</span></a>            <span class="n">dtype</span><span class="o">=</span><span class="n">torch_bool</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-300"><a href="#BaseSeparableSampler-300"><span class="linenos">300</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-301"><a href="#BaseSeparableSampler-301"><span class="linenos">301</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">interpolating_kernel</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">transposed_convolve</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
</span><span id="BaseSeparableSampler-302"><a href="#BaseSeparableSampler-302"><span class="linenos">302</span></a>            <span class="n">rounded_translation</span> <span class="o">=</span> <span class="n">translation</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
</span><span id="BaseSeparableSampler-303"><a href="#BaseSeparableSampler-303"><span class="linenos">303</span></a>            <span class="n">max_slicing_coordinate_difference_upper_bound</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BaseSeparableSampler-304"><a href="#BaseSeparableSampler-304"><span class="linenos">304</span></a>                <span class="p">(</span><span class="n">translation</span> <span class="o">-</span> <span class="n">rounded_translation</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
</span><span id="BaseSeparableSampler-305"><a href="#BaseSeparableSampler-305"><span class="linenos">305</span></a>                <span class="o">+</span> <span class="n">max_conv_coordinate_difference_upper_bound</span>
</span><span id="BaseSeparableSampler-306"><a href="#BaseSeparableSampler-306"><span class="linenos">306</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">amax</span><span class="p">()</span>
</span><span id="BaseSeparableSampler-307"><a href="#BaseSeparableSampler-307"><span class="linenos">307</span></a>            <span class="n">convolve</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BaseSeparableSampler-308"><a href="#BaseSeparableSampler-308"><span class="linenos">308</span></a>                <span class="p">(</span><span class="o">~</span><span class="n">interpolating_kernel</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-309"><a href="#BaseSeparableSampler-309"><span class="linenos">309</span></a>                <span class="o">|</span> <span class="p">(</span><span class="n">max_slicing_coordinate_difference_upper_bound</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convolution_threshold</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-310"><a href="#BaseSeparableSampler-310"><span class="linenos">310</span></a>            <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">transposed_convolve</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-311"><a href="#BaseSeparableSampler-311"><span class="linenos">311</span></a>            <span class="n">no_convolve_or_transposed_convolve</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">transposed_convolve</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">convolve</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-312"><a href="#BaseSeparableSampler-312"><span class="linenos">312</span></a>            <span class="n">translation</span><span class="p">[</span><span class="n">no_convolve_or_transposed_convolve</span><span class="p">]</span> <span class="o">=</span> <span class="n">translation</span><span class="p">[</span>
</span><span id="BaseSeparableSampler-313"><a href="#BaseSeparableSampler-313"><span class="linenos">313</span></a>                <span class="n">no_convolve_or_transposed_convolve</span>
</span><span id="BaseSeparableSampler-314"><a href="#BaseSeparableSampler-314"><span class="linenos">314</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
</span><span id="BaseSeparableSampler-315"><a href="#BaseSeparableSampler-315"><span class="linenos">315</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-316"><a href="#BaseSeparableSampler-316"><span class="linenos">316</span></a>            <span class="n">convolve</span> <span class="o">=</span> <span class="o">~</span><span class="n">transposed_convolve</span>
</span><span id="BaseSeparableSampler-317"><a href="#BaseSeparableSampler-317"><span class="linenos">317</span></a>        <span class="k">return</span> <span class="n">downsampling_factor</span><span class="p">,</span> <span class="n">translation</span><span class="p">,</span> <span class="n">convolve</span><span class="p">,</span> <span class="n">transposed_convolve</span><span class="p">,</span> <span class="n">flipping_permutation</span>
</span><span id="BaseSeparableSampler-318"><a href="#BaseSeparableSampler-318"><span class="linenos">318</span></a>
</span><span id="BaseSeparableSampler-319"><a href="#BaseSeparableSampler-319"><span class="linenos">319</span></a>    <span class="k">def</span> <span class="nf">_obtain_conv_parameters</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-320"><a href="#BaseSeparableSampler-320"><span class="linenos">320</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-321"><a href="#BaseSeparableSampler-321"><span class="linenos">321</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-322"><a href="#BaseSeparableSampler-322"><span class="linenos">322</span></a>        <span class="n">voxel_coordinates</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-323"><a href="#BaseSeparableSampler-323"><span class="linenos">323</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="BaseSeparableSampler-324"><a href="#BaseSeparableSampler-324"><span class="linenos">324</span></a>        <span class="n">Tuple</span><span class="p">[</span>
</span><span id="BaseSeparableSampler-325"><a href="#BaseSeparableSampler-325"><span class="linenos">325</span></a>            <span class="n">Sequence</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]],</span>
</span><span id="BaseSeparableSampler-326"><a href="#BaseSeparableSampler-326"><span class="linenos">326</span></a>            <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="BaseSeparableSampler-327"><a href="#BaseSeparableSampler-327"><span class="linenos">327</span></a>            <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="BaseSeparableSampler-328"><a href="#BaseSeparableSampler-328"><span class="linenos">328</span></a>            <span class="n">Sequence</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
</span><span id="BaseSeparableSampler-329"><a href="#BaseSeparableSampler-329"><span class="linenos">329</span></a>            <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
</span><span id="BaseSeparableSampler-330"><a href="#BaseSeparableSampler-330"><span class="linenos">330</span></a>            <span class="n">Sequence</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
</span><span id="BaseSeparableSampler-331"><a href="#BaseSeparableSampler-331"><span class="linenos">331</span></a>            <span class="s2">&quot;FlippingPermutation&quot;</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-332"><a href="#BaseSeparableSampler-332"><span class="linenos">332</span></a>        <span class="p">]</span>
</span><span id="BaseSeparableSampler-333"><a href="#BaseSeparableSampler-333"><span class="linenos">333</span></a>    <span class="p">]:</span>
</span><span id="BaseSeparableSampler-334"><a href="#BaseSeparableSampler-334"><span class="linenos">334</span></a>        <span class="n">conv_interpolation_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_conv_interpolatable_parameters</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-335"><a href="#BaseSeparableSampler-335"><span class="linenos">335</span></a>            <span class="n">volume</span><span class="p">,</span> <span class="n">voxel_coordinates</span>
</span><span id="BaseSeparableSampler-336"><a href="#BaseSeparableSampler-336"><span class="linenos">336</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-337"><a href="#BaseSeparableSampler-337"><span class="linenos">337</span></a>        <span class="k">if</span> <span class="n">conv_interpolation_parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-338"><a href="#BaseSeparableSampler-338"><span class="linenos">338</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="BaseSeparableSampler-339"><a href="#BaseSeparableSampler-339"><span class="linenos">339</span></a>        <span class="n">downsampling_factor</span><span class="p">,</span> <span class="n">translation</span><span class="p">,</span> <span class="n">convolve</span><span class="p">,</span> <span class="n">transposed_convolve</span><span class="p">,</span> <span class="n">flipping_permutation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BaseSeparableSampler-340"><a href="#BaseSeparableSampler-340"><span class="linenos">340</span></a>            <span class="n">conv_interpolation_parameters</span>
</span><span id="BaseSeparableSampler-341"><a href="#BaseSeparableSampler-341"><span class="linenos">341</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-342"><a href="#BaseSeparableSampler-342"><span class="linenos">342</span></a>        <span class="n">pre_pads_or_crops</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BaseSeparableSampler-343"><a href="#BaseSeparableSampler-343"><span class="linenos">343</span></a>        <span class="n">post_pads_or_crops</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BaseSeparableSampler-344"><a href="#BaseSeparableSampler-344"><span class="linenos">344</span></a>        <span class="n">conv_paddings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BaseSeparableSampler-345"><a href="#BaseSeparableSampler-345"><span class="linenos">345</span></a>        <span class="n">conv_kernels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BaseSeparableSampler-346"><a href="#BaseSeparableSampler-346"><span class="linenos">346</span></a>        <span class="k">for</span> <span class="n">spatial_dim</span><span class="p">,</span> <span class="p">(</span>
</span><span id="BaseSeparableSampler-347"><a href="#BaseSeparableSampler-347"><span class="linenos">347</span></a>            <span class="n">dim_size_volume</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-348"><a href="#BaseSeparableSampler-348"><span class="linenos">348</span></a>            <span class="n">dim_size_grid</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-349"><a href="#BaseSeparableSampler-349"><span class="linenos">349</span></a>            <span class="n">dim_convolve</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-350"><a href="#BaseSeparableSampler-350"><span class="linenos">350</span></a>            <span class="n">dim_transposed_convolve</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-351"><a href="#BaseSeparableSampler-351"><span class="linenos">351</span></a>            <span class="n">dim_translation</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-352"><a href="#BaseSeparableSampler-352"><span class="linenos">352</span></a>            <span class="n">dim_downsampling_factor</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-353"><a href="#BaseSeparableSampler-353"><span class="linenos">353</span></a>        <span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-354"><a href="#BaseSeparableSampler-354"><span class="linenos">354</span></a>            <span class="nb">zip</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-355"><a href="#BaseSeparableSampler-355"><span class="linenos">355</span></a>                <span class="n">flipping_permutation</span><span class="o">.</span><span class="n">permute_sequence</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">),</span>
</span><span id="BaseSeparableSampler-356"><a href="#BaseSeparableSampler-356"><span class="linenos">356</span></a>                <span class="n">voxel_coordinates</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-357"><a href="#BaseSeparableSampler-357"><span class="linenos">357</span></a>                <span class="n">convolve</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
</span><span id="BaseSeparableSampler-358"><a href="#BaseSeparableSampler-358"><span class="linenos">358</span></a>                <span class="n">transposed_convolve</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
</span><span id="BaseSeparableSampler-359"><a href="#BaseSeparableSampler-359"><span class="linenos">359</span></a>                <span class="n">translation</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
</span><span id="BaseSeparableSampler-360"><a href="#BaseSeparableSampler-360"><span class="linenos">360</span></a>                <span class="n">downsampling_factor</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
</span><span id="BaseSeparableSampler-361"><a href="#BaseSeparableSampler-361"><span class="linenos">361</span></a>            <span class="p">)</span>
</span><span id="BaseSeparableSampler-362"><a href="#BaseSeparableSampler-362"><span class="linenos">362</span></a>        <span class="p">):</span>
</span><span id="BaseSeparableSampler-363"><a href="#BaseSeparableSampler-363"><span class="linenos">363</span></a>            <span class="n">kernel_dim</span> <span class="o">=</span> <span class="n">flipping_permutation</span><span class="o">.</span><span class="n">spatial_permutation</span><span class="p">[</span><span class="n">spatial_dim</span><span class="p">]</span>
</span><span id="BaseSeparableSampler-364"><a href="#BaseSeparableSampler-364"><span class="linenos">364</span></a>            <span class="n">flip_kernel</span> <span class="o">=</span> <span class="n">kernel_dim</span> <span class="ow">in</span> <span class="n">flipping_permutation</span><span class="o">.</span><span class="n">flipped_spatial_dims</span>
</span><span id="BaseSeparableSampler-365"><a href="#BaseSeparableSampler-365"><span class="linenos">365</span></a>            <span class="p">(</span><span class="n">kernel_width</span><span class="p">,</span> <span class="n">inclusive_min</span><span class="p">,</span> <span class="n">inclusive_max</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_support</span><span class="p">(</span><span class="n">kernel_dim</span><span class="p">)(</span>
</span><span id="BaseSeparableSampler-366"><a href="#BaseSeparableSampler-366"><span class="linenos">366</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_limit_direction</span><span class="p">(</span><span class="n">kernel_dim</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-367"><a href="#BaseSeparableSampler-367"><span class="linenos">367</span></a>            <span class="p">)</span>
</span><span id="BaseSeparableSampler-368"><a href="#BaseSeparableSampler-368"><span class="linenos">368</span></a>            <span class="k">if</span> <span class="n">flip_kernel</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-369"><a href="#BaseSeparableSampler-369"><span class="linenos">369</span></a>                <span class="n">inclusive_min</span><span class="p">,</span> <span class="n">inclusive_max</span> <span class="o">=</span> <span class="n">inclusive_max</span><span class="p">,</span> <span class="n">inclusive_min</span>
</span><span id="BaseSeparableSampler-370"><a href="#BaseSeparableSampler-370"><span class="linenos">370</span></a>            <span class="n">lower_flooring_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_flooring_function</span><span class="p">(</span><span class="n">inclusive_min</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-371"><a href="#BaseSeparableSampler-371"><span class="linenos">371</span></a>            <span class="n">upper_flooring_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_flooring_function</span><span class="p">(</span><span class="n">inclusive_max</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-372"><a href="#BaseSeparableSampler-372"><span class="linenos">372</span></a>            <span class="n">min_coordinate</span> <span class="o">=</span> <span class="n">dim_translation</span>
</span><span id="BaseSeparableSampler-373"><a href="#BaseSeparableSampler-373"><span class="linenos">373</span></a>            <span class="n">max_coordinate</span> <span class="o">=</span> <span class="n">dim_translation</span> <span class="o">+</span> <span class="n">dim_downsampling_factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">dim_size_grid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-374"><a href="#BaseSeparableSampler-374"><span class="linenos">374</span></a>            <span class="k">if</span> <span class="n">dim_convolve</span> <span class="ow">or</span> <span class="n">dim_transposed_convolve</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-375"><a href="#BaseSeparableSampler-375"><span class="linenos">375</span></a>                <span class="n">pre_pad_or_crop_lower</span> <span class="o">=</span> <span class="n">lower_flooring_function</span><span class="p">(</span><span class="n">kernel_width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">dim_translation</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-376"><a href="#BaseSeparableSampler-376"><span class="linenos">376</span></a>                <span class="n">pre_pad_or_crop_upper</span> <span class="o">=</span> <span class="n">upper_flooring_function</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-377"><a href="#BaseSeparableSampler-377"><span class="linenos">377</span></a>                    <span class="n">kernel_width</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="BaseSeparableSampler-378"><a href="#BaseSeparableSampler-378"><span class="linenos">378</span></a>                    <span class="o">+</span> <span class="n">dim_translation</span>
</span><span id="BaseSeparableSampler-379"><a href="#BaseSeparableSampler-379"><span class="linenos">379</span></a>                    <span class="o">+</span> <span class="n">dim_downsampling_factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">dim_size_grid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-380"><a href="#BaseSeparableSampler-380"><span class="linenos">380</span></a>                    <span class="o">-</span> <span class="p">(</span><span class="n">dim_size_volume</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-381"><a href="#BaseSeparableSampler-381"><span class="linenos">381</span></a>                <span class="p">)</span>
</span><span id="BaseSeparableSampler-382"><a href="#BaseSeparableSampler-382"><span class="linenos">382</span></a>                <span class="k">if</span> <span class="n">dim_transposed_convolve</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-383"><a href="#BaseSeparableSampler-383"><span class="linenos">383</span></a>                    <span class="n">start_kernel_coordinate</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BaseSeparableSampler-384"><a href="#BaseSeparableSampler-384"><span class="linenos">384</span></a>                        <span class="mi">1</span>
</span><span id="BaseSeparableSampler-385"><a href="#BaseSeparableSampler-385"><span class="linenos">385</span></a>                        <span class="o">-</span> <span class="n">dim_translation</span>
</span><span id="BaseSeparableSampler-386"><a href="#BaseSeparableSampler-386"><span class="linenos">386</span></a>                        <span class="o">+</span> <span class="n">upper_flooring_function</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-387"><a href="#BaseSeparableSampler-387"><span class="linenos">387</span></a>                            <span class="p">(</span><span class="n">kernel_width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">dim_translation</span><span class="p">))</span> <span class="o">/</span> <span class="n">dim_downsampling_factor</span>
</span><span id="BaseSeparableSampler-388"><a href="#BaseSeparableSampler-388"><span class="linenos">388</span></a>                        <span class="p">)</span>
</span><span id="BaseSeparableSampler-389"><a href="#BaseSeparableSampler-389"><span class="linenos">389</span></a>                        <span class="o">*</span> <span class="n">dim_downsampling_factor</span>
</span><span id="BaseSeparableSampler-390"><a href="#BaseSeparableSampler-390"><span class="linenos">390</span></a>                    <span class="p">)</span>
</span><span id="BaseSeparableSampler-391"><a href="#BaseSeparableSampler-391"><span class="linenos">391</span></a>                    <span class="n">end_kernel_coordinate</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BaseSeparableSampler-392"><a href="#BaseSeparableSampler-392"><span class="linenos">392</span></a>                        <span class="o">-</span><span class="n">dim_translation</span>
</span><span id="BaseSeparableSampler-393"><a href="#BaseSeparableSampler-393"><span class="linenos">393</span></a>                        <span class="o">-</span> <span class="n">lower_flooring_function</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-394"><a href="#BaseSeparableSampler-394"><span class="linenos">394</span></a>                            <span class="p">(</span><span class="n">kernel_width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">dim_translation</span><span class="p">)</span> <span class="o">/</span> <span class="n">dim_downsampling_factor</span>
</span><span id="BaseSeparableSampler-395"><a href="#BaseSeparableSampler-395"><span class="linenos">395</span></a>                        <span class="p">)</span>
</span><span id="BaseSeparableSampler-396"><a href="#BaseSeparableSampler-396"><span class="linenos">396</span></a>                        <span class="o">*</span> <span class="n">dim_downsampling_factor</span>
</span><span id="BaseSeparableSampler-397"><a href="#BaseSeparableSampler-397"><span class="linenos">397</span></a>                    <span class="p">)</span>
</span><span id="BaseSeparableSampler-398"><a href="#BaseSeparableSampler-398"><span class="linenos">398</span></a>                    <span class="n">kernel_step_size</span> <span class="o">=</span> <span class="n">dim_downsampling_factor</span>
</span><span id="BaseSeparableSampler-399"><a href="#BaseSeparableSampler-399"><span class="linenos">399</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-400"><a href="#BaseSeparableSampler-400"><span class="linenos">400</span></a>                    <span class="n">relative_coordinate</span> <span class="o">=</span> <span class="n">dim_translation</span> <span class="o">-</span> <span class="n">floor</span><span class="p">(</span><span class="n">dim_translation</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-401"><a href="#BaseSeparableSampler-401"><span class="linenos">401</span></a>                    <span class="n">start_kernel_coordinate</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BaseSeparableSampler-402"><a href="#BaseSeparableSampler-402"><span class="linenos">402</span></a>                        <span class="o">-</span><span class="n">lower_flooring_function</span><span class="p">(</span><span class="n">kernel_width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">relative_coordinate</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-403"><a href="#BaseSeparableSampler-403"><span class="linenos">403</span></a>                        <span class="o">-</span> <span class="n">relative_coordinate</span>
</span><span id="BaseSeparableSampler-404"><a href="#BaseSeparableSampler-404"><span class="linenos">404</span></a>                    <span class="p">)</span>
</span><span id="BaseSeparableSampler-405"><a href="#BaseSeparableSampler-405"><span class="linenos">405</span></a>                    <span class="n">end_kernel_coordinate</span> <span class="o">=</span> <span class="n">upper_flooring_function</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-406"><a href="#BaseSeparableSampler-406"><span class="linenos">406</span></a>                        <span class="n">kernel_width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">relative_coordinate</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-407"><a href="#BaseSeparableSampler-407"><span class="linenos">407</span></a>                    <span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">relative_coordinate</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-408"><a href="#BaseSeparableSampler-408"><span class="linenos">408</span></a>                    <span class="n">kernel_step_size</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="BaseSeparableSampler-409"><a href="#BaseSeparableSampler-409"><span class="linenos">409</span></a>                <span class="n">kernel_coordinates</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-410"><a href="#BaseSeparableSampler-410"><span class="linenos">410</span></a>                    <span class="n">start_kernel_coordinate</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-411"><a href="#BaseSeparableSampler-411"><span class="linenos">411</span></a>                    <span class="n">end_kernel_coordinate</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-412"><a href="#BaseSeparableSampler-412"><span class="linenos">412</span></a>                    <span class="nb">int</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-413"><a href="#BaseSeparableSampler-413"><span class="linenos">413</span></a>                        <span class="nb">round</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-414"><a href="#BaseSeparableSampler-414"><span class="linenos">414</span></a>                            <span class="nb">abs</span><span class="p">(</span><span class="n">end_kernel_coordinate</span> <span class="o">-</span> <span class="n">start_kernel_coordinate</span><span class="p">)</span> <span class="o">/</span> <span class="n">kernel_step_size</span>
</span><span id="BaseSeparableSampler-415"><a href="#BaseSeparableSampler-415"><span class="linenos">415</span></a>                        <span class="p">)</span>
</span><span id="BaseSeparableSampler-416"><a href="#BaseSeparableSampler-416"><span class="linenos">416</span></a>                    <span class="p">)</span>
</span><span id="BaseSeparableSampler-417"><a href="#BaseSeparableSampler-417"><span class="linenos">417</span></a>                    <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-418"><a href="#BaseSeparableSampler-418"><span class="linenos">418</span></a>                    <span class="n">dtype</span><span class="o">=</span><span class="n">voxel_coordinates</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-419"><a href="#BaseSeparableSampler-419"><span class="linenos">419</span></a>                    <span class="n">device</span><span class="o">=</span><span class="n">voxel_coordinates</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-420"><a href="#BaseSeparableSampler-420"><span class="linenos">420</span></a>                <span class="p">)</span>
</span><span id="BaseSeparableSampler-421"><a href="#BaseSeparableSampler-421"><span class="linenos">421</span></a>                <span class="k">if</span> <span class="n">flip_kernel</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-422"><a href="#BaseSeparableSampler-422"><span class="linenos">422</span></a>                    <span class="n">kernel_coordinates</span> <span class="o">=</span> <span class="o">-</span><span class="n">kernel_coordinates</span>
</span><span id="BaseSeparableSampler-423"><a href="#BaseSeparableSampler-423"><span class="linenos">423</span></a>                <span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-424"><a href="#BaseSeparableSampler-424"><span class="linenos">424</span></a>                    <span class="n">kernel_coordinates</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-425"><a href="#BaseSeparableSampler-425"><span class="linenos">425</span></a>                    <span class="n">spatial_dim</span><span class="o">=</span><span class="n">kernel_dim</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-426"><a href="#BaseSeparableSampler-426"><span class="linenos">426</span></a>                <span class="p">)</span>
</span><span id="BaseSeparableSampler-427"><a href="#BaseSeparableSampler-427"><span class="linenos">427</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-428"><a href="#BaseSeparableSampler-428"><span class="linenos">428</span></a>                <span class="n">kernel</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BaseSeparableSampler-429"><a href="#BaseSeparableSampler-429"><span class="linenos">429</span></a>                <span class="n">pre_pad_or_crop_lower</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">min_coordinate</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-430"><a href="#BaseSeparableSampler-430"><span class="linenos">430</span></a>                <span class="n">pre_pad_or_crop_upper</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_coordinate</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">dim_size_volume</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-431"><a href="#BaseSeparableSampler-431"><span class="linenos">431</span></a>            <span class="k">if</span> <span class="n">dim_transposed_convolve</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-432"><a href="#BaseSeparableSampler-432"><span class="linenos">432</span></a>                <span class="n">post_pad_or_crop_lower</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-433"><a href="#BaseSeparableSampler-433"><span class="linenos">433</span></a>                    <span class="nb">round</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-434"><a href="#BaseSeparableSampler-434"><span class="linenos">434</span></a>                        <span class="p">(</span><span class="n">min_coordinate</span> <span class="o">+</span> <span class="n">pre_pad_or_crop_lower</span> <span class="o">+</span> <span class="n">start_kernel_coordinate</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-435"><a href="#BaseSeparableSampler-435"><span class="linenos">435</span></a>                        <span class="o">/</span> <span class="n">dim_downsampling_factor</span>
</span><span id="BaseSeparableSampler-436"><a href="#BaseSeparableSampler-436"><span class="linenos">436</span></a>                    <span class="p">)</span>
</span><span id="BaseSeparableSampler-437"><a href="#BaseSeparableSampler-437"><span class="linenos">437</span></a>                <span class="p">)</span>
</span><span id="BaseSeparableSampler-438"><a href="#BaseSeparableSampler-438"><span class="linenos">438</span></a>                <span class="n">post_pad_or_crop_upper</span> <span class="o">=</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-439"><a href="#BaseSeparableSampler-439"><span class="linenos">439</span></a>                    <span class="nb">round</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-440"><a href="#BaseSeparableSampler-440"><span class="linenos">440</span></a>                        <span class="p">(</span>
</span><span id="BaseSeparableSampler-441"><a href="#BaseSeparableSampler-441"><span class="linenos">441</span></a>                            <span class="p">(</span><span class="n">dim_size_volume</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-442"><a href="#BaseSeparableSampler-442"><span class="linenos">442</span></a>                            <span class="o">+</span> <span class="n">pre_pad_or_crop_upper</span>
</span><span id="BaseSeparableSampler-443"><a href="#BaseSeparableSampler-443"><span class="linenos">443</span></a>                            <span class="o">-</span> <span class="n">end_kernel_coordinate</span>
</span><span id="BaseSeparableSampler-444"><a href="#BaseSeparableSampler-444"><span class="linenos">444</span></a>                            <span class="o">-</span> <span class="n">max_coordinate</span>
</span><span id="BaseSeparableSampler-445"><a href="#BaseSeparableSampler-445"><span class="linenos">445</span></a>                        <span class="p">)</span>
</span><span id="BaseSeparableSampler-446"><a href="#BaseSeparableSampler-446"><span class="linenos">446</span></a>                        <span class="o">/</span> <span class="n">dim_downsampling_factor</span>
</span><span id="BaseSeparableSampler-447"><a href="#BaseSeparableSampler-447"><span class="linenos">447</span></a>                    <span class="p">)</span>
</span><span id="BaseSeparableSampler-448"><a href="#BaseSeparableSampler-448"><span class="linenos">448</span></a>                <span class="p">)</span>
</span><span id="BaseSeparableSampler-449"><a href="#BaseSeparableSampler-449"><span class="linenos">449</span></a>                <span class="k">assert</span> <span class="n">post_pad_or_crop_lower</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">post_pad_or_crop_upper</span> <span class="o">&lt;=</span> <span class="mi">0</span>
</span><span id="BaseSeparableSampler-450"><a href="#BaseSeparableSampler-450"><span class="linenos">450</span></a>                <span class="n">conv_padding</span> <span class="o">=</span> <span class="o">-</span><span class="nb">max</span><span class="p">(</span><span class="n">post_pad_or_crop_lower</span><span class="p">,</span> <span class="n">post_pad_or_crop_upper</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-451"><a href="#BaseSeparableSampler-451"><span class="linenos">451</span></a>                <span class="n">post_pad_or_crop_lower</span> <span class="o">+=</span> <span class="n">conv_padding</span>
</span><span id="BaseSeparableSampler-452"><a href="#BaseSeparableSampler-452"><span class="linenos">452</span></a>                <span class="n">post_pad_or_crop_upper</span> <span class="o">+=</span> <span class="n">conv_padding</span>
</span><span id="BaseSeparableSampler-453"><a href="#BaseSeparableSampler-453"><span class="linenos">453</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-454"><a href="#BaseSeparableSampler-454"><span class="linenos">454</span></a>                <span class="n">conv_padding</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BaseSeparableSampler-455"><a href="#BaseSeparableSampler-455"><span class="linenos">455</span></a>                <span class="n">post_pad_or_crop_lower</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BaseSeparableSampler-456"><a href="#BaseSeparableSampler-456"><span class="linenos">456</span></a>                <span class="n">post_pad_or_crop_upper</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BaseSeparableSampler-457"><a href="#BaseSeparableSampler-457"><span class="linenos">457</span></a>            <span class="n">conv_kernels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-458"><a href="#BaseSeparableSampler-458"><span class="linenos">458</span></a>            <span class="n">conv_paddings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conv_padding</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-459"><a href="#BaseSeparableSampler-459"><span class="linenos">459</span></a>            <span class="n">pre_pads_or_crops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pre_pad_or_crop_lower</span><span class="p">,</span> <span class="n">pre_pad_or_crop_upper</span><span class="p">))</span>
</span><span id="BaseSeparableSampler-460"><a href="#BaseSeparableSampler-460"><span class="linenos">460</span></a>            <span class="n">post_pads_or_crops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">post_pad_or_crop_lower</span><span class="p">,</span> <span class="n">post_pad_or_crop_upper</span><span class="p">))</span>
</span><span id="BaseSeparableSampler-461"><a href="#BaseSeparableSampler-461"><span class="linenos">461</span></a>        <span class="n">padding_mode</span><span class="p">,</span> <span class="n">_padding_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_padding_mode_and_value</span>
</span><span id="BaseSeparableSampler-462"><a href="#BaseSeparableSampler-462"><span class="linenos">462</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_croppable_first</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-463"><a href="#BaseSeparableSampler-463"><span class="linenos">463</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="n">volume</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">pads_or_crops</span><span class="o">=</span><span class="n">pre_pads_or_crops</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">padding_mode</span>
</span><span id="BaseSeparableSampler-464"><a href="#BaseSeparableSampler-464"><span class="linenos">464</span></a>        <span class="p">):</span>
</span><span id="BaseSeparableSampler-465"><a href="#BaseSeparableSampler-465"><span class="linenos">465</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="BaseSeparableSampler-466"><a href="#BaseSeparableSampler-466"><span class="linenos">466</span></a>        <span class="n">conv_strides</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BaseSeparableSampler-467"><a href="#BaseSeparableSampler-467"><span class="linenos">467</span></a>            <span class="p">(</span>
</span><span id="BaseSeparableSampler-468"><a href="#BaseSeparableSampler-468"><span class="linenos">468</span></a>                <span class="n">downsampling_factor</span> <span class="o">*</span> <span class="p">(</span><span class="o">~</span><span class="n">transposed_convolve</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-469"><a href="#BaseSeparableSampler-469"><span class="linenos">469</span></a>                <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">downsampling_factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">transposed_convolve</span>
</span><span id="BaseSeparableSampler-470"><a href="#BaseSeparableSampler-470"><span class="linenos">470</span></a>            <span class="p">)</span>
</span><span id="BaseSeparableSampler-471"><a href="#BaseSeparableSampler-471"><span class="linenos">471</span></a>            <span class="o">.</span><span class="n">round</span><span class="p">()</span>
</span><span id="BaseSeparableSampler-472"><a href="#BaseSeparableSampler-472"><span class="linenos">472</span></a>            <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">long</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-473"><a href="#BaseSeparableSampler-473"><span class="linenos">473</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-474"><a href="#BaseSeparableSampler-474"><span class="linenos">474</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="BaseSeparableSampler-475"><a href="#BaseSeparableSampler-475"><span class="linenos">475</span></a>            <span class="n">conv_kernels</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-476"><a href="#BaseSeparableSampler-476"><span class="linenos">476</span></a>            <span class="n">conv_strides</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
</span><span id="BaseSeparableSampler-477"><a href="#BaseSeparableSampler-477"><span class="linenos">477</span></a>            <span class="n">conv_paddings</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-478"><a href="#BaseSeparableSampler-478"><span class="linenos">478</span></a>            <span class="n">transposed_convolve</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
</span><span id="BaseSeparableSampler-479"><a href="#BaseSeparableSampler-479"><span class="linenos">479</span></a>            <span class="n">pre_pads_or_crops</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-480"><a href="#BaseSeparableSampler-480"><span class="linenos">480</span></a>            <span class="n">post_pads_or_crops</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-481"><a href="#BaseSeparableSampler-481"><span class="linenos">481</span></a>            <span class="n">flipping_permutation</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-482"><a href="#BaseSeparableSampler-482"><span class="linenos">482</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-483"><a href="#BaseSeparableSampler-483"><span class="linenos">483</span></a>
</span><span id="BaseSeparableSampler-484"><a href="#BaseSeparableSampler-484"><span class="linenos">484</span></a>    <span class="k">def</span> <span class="nf">_interpolate_conv</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-485"><a href="#BaseSeparableSampler-485"><span class="linenos">485</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-486"><a href="#BaseSeparableSampler-486"><span class="linenos">486</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-487"><a href="#BaseSeparableSampler-487"><span class="linenos">487</span></a>        <span class="n">voxel_coordinates</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-488"><a href="#BaseSeparableSampler-488"><span class="linenos">488</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MappableTensor</span><span class="p">]:</span>
</span><span id="BaseSeparableSampler-489"><a href="#BaseSeparableSampler-489"><span class="linenos">489</span></a>        <span class="n">conv_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obtain_conv_parameters</span><span class="p">(</span><span class="n">volume</span><span class="p">,</span> <span class="n">voxel_coordinates</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-490"><a href="#BaseSeparableSampler-490"><span class="linenos">490</span></a>        <span class="k">if</span> <span class="n">conv_parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-491"><a href="#BaseSeparableSampler-491"><span class="linenos">491</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="BaseSeparableSampler-492"><a href="#BaseSeparableSampler-492"><span class="linenos">492</span></a>        <span class="p">(</span>
</span><span id="BaseSeparableSampler-493"><a href="#BaseSeparableSampler-493"><span class="linenos">493</span></a>            <span class="n">conv_kernels</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-494"><a href="#BaseSeparableSampler-494"><span class="linenos">494</span></a>            <span class="n">conv_strides</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-495"><a href="#BaseSeparableSampler-495"><span class="linenos">495</span></a>            <span class="n">conv_paddings</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-496"><a href="#BaseSeparableSampler-496"><span class="linenos">496</span></a>            <span class="n">transposed_convolve</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-497"><a href="#BaseSeparableSampler-497"><span class="linenos">497</span></a>            <span class="n">pre_pads_or_crops</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-498"><a href="#BaseSeparableSampler-498"><span class="linenos">498</span></a>            <span class="n">post_pads_or_crops</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-499"><a href="#BaseSeparableSampler-499"><span class="linenos">499</span></a>            <span class="n">flipping_permutation</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-500"><a href="#BaseSeparableSampler-500"><span class="linenos">500</span></a>        <span class="p">)</span> <span class="o">=</span> <span class="n">conv_parameters</span>
</span><span id="BaseSeparableSampler-501"><a href="#BaseSeparableSampler-501"><span class="linenos">501</span></a>        <span class="n">padding_mode</span><span class="p">,</span> <span class="n">padding_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_padding_mode_and_value</span>
</span><span id="BaseSeparableSampler-502"><a href="#BaseSeparableSampler-502"><span class="linenos">502</span></a>
</span><span id="BaseSeparableSampler-503"><a href="#BaseSeparableSampler-503"><span class="linenos">503</span></a>        <span class="n">values</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-504"><a href="#BaseSeparableSampler-504"><span class="linenos">504</span></a>            <span class="n">generate_missing_mask</span><span class="o">=</span><span class="n">includes_padding</span><span class="p">(</span><span class="n">pre_pads_or_crops</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-505"><a href="#BaseSeparableSampler-505"><span class="linenos">505</span></a>            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-506"><a href="#BaseSeparableSampler-506"><span class="linenos">506</span></a>            <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-507"><a href="#BaseSeparableSampler-507"><span class="linenos">507</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-508"><a href="#BaseSeparableSampler-508"><span class="linenos">508</span></a>        <span class="n">interpolated_values</span> <span class="o">=</span> <span class="n">flipping_permutation</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">volume</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-509"><a href="#BaseSeparableSampler-509"><span class="linenos">509</span></a>        <span class="n">interpolated_values</span> <span class="o">=</span> <span class="n">crop_and_then_pad_spatial</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-510"><a href="#BaseSeparableSampler-510"><span class="linenos">510</span></a>            <span class="n">interpolated_values</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-511"><a href="#BaseSeparableSampler-511"><span class="linenos">511</span></a>            <span class="n">pads_or_crops</span><span class="o">=</span><span class="n">pre_pads_or_crops</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-512"><a href="#BaseSeparableSampler-512"><span class="linenos">512</span></a>            <span class="n">mode</span><span class="o">=</span><span class="n">padding_mode</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-513"><a href="#BaseSeparableSampler-513"><span class="linenos">513</span></a>            <span class="n">value</span><span class="o">=</span><span class="n">padding_value</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-514"><a href="#BaseSeparableSampler-514"><span class="linenos">514</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">volume</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-515"><a href="#BaseSeparableSampler-515"><span class="linenos">515</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-516"><a href="#BaseSeparableSampler-516"><span class="linenos">516</span></a>        <span class="n">interpolated_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_separable_conv</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-517"><a href="#BaseSeparableSampler-517"><span class="linenos">517</span></a>            <span class="n">interpolated_values</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-518"><a href="#BaseSeparableSampler-518"><span class="linenos">518</span></a>            <span class="n">kernels</span><span class="o">=</span><span class="n">conv_kernels</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-519"><a href="#BaseSeparableSampler-519"><span class="linenos">519</span></a>            <span class="n">strides</span><span class="o">=</span><span class="n">conv_strides</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-520"><a href="#BaseSeparableSampler-520"><span class="linenos">520</span></a>            <span class="n">paddings</span><span class="o">=</span><span class="n">conv_paddings</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-521"><a href="#BaseSeparableSampler-521"><span class="linenos">521</span></a>            <span class="n">transposed</span><span class="o">=</span><span class="n">transposed_convolve</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-522"><a href="#BaseSeparableSampler-522"><span class="linenos">522</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">volume</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-523"><a href="#BaseSeparableSampler-523"><span class="linenos">523</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-524"><a href="#BaseSeparableSampler-524"><span class="linenos">524</span></a>        <span class="n">interpolated_values</span> <span class="o">=</span> <span class="n">crop_and_then_pad_spatial</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-525"><a href="#BaseSeparableSampler-525"><span class="linenos">525</span></a>            <span class="n">interpolated_values</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-526"><a href="#BaseSeparableSampler-526"><span class="linenos">526</span></a>            <span class="n">pads_or_crops</span><span class="o">=</span><span class="n">post_pads_or_crops</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-527"><a href="#BaseSeparableSampler-527"><span class="linenos">527</span></a>            <span class="n">mode</span><span class="o">=</span><span class="n">padding_mode</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-528"><a href="#BaseSeparableSampler-528"><span class="linenos">528</span></a>            <span class="n">value</span><span class="o">=</span><span class="n">padding_value</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-529"><a href="#BaseSeparableSampler-529"><span class="linenos">529</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">volume</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-530"><a href="#BaseSeparableSampler-530"><span class="linenos">530</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-531"><a href="#BaseSeparableSampler-531"><span class="linenos">531</span></a>        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-532"><a href="#BaseSeparableSampler-532"><span class="linenos">532</span></a>            <span class="n">interpolated_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BaseSeparableSampler-533"><a href="#BaseSeparableSampler-533"><span class="linenos">533</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-534"><a href="#BaseSeparableSampler-534"><span class="linenos">534</span></a>            <span class="n">interpolated_mask</span> <span class="o">=</span> <span class="n">flipping_permutation</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">volume</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-535"><a href="#BaseSeparableSampler-535"><span class="linenos">535</span></a>            <span class="n">interpolated_mask</span> <span class="o">=</span> <span class="n">crop_and_then_pad_spatial</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-536"><a href="#BaseSeparableSampler-536"><span class="linenos">536</span></a>                <span class="n">interpolated_mask</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-537"><a href="#BaseSeparableSampler-537"><span class="linenos">537</span></a>                <span class="n">pads_or_crops</span><span class="o">=</span><span class="n">pre_pads_or_crops</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-538"><a href="#BaseSeparableSampler-538"><span class="linenos">538</span></a>                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-539"><a href="#BaseSeparableSampler-539"><span class="linenos">539</span></a>                <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-540"><a href="#BaseSeparableSampler-540"><span class="linenos">540</span></a>                <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">volume</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-541"><a href="#BaseSeparableSampler-541"><span class="linenos">541</span></a>            <span class="p">)</span>
</span><span id="BaseSeparableSampler-542"><a href="#BaseSeparableSampler-542"><span class="linenos">542</span></a>            <span class="n">interpolated_mask</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="BaseSeparableSampler-543"><a href="#BaseSeparableSampler-543"><span class="linenos">543</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_separable_conv</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-544"><a href="#BaseSeparableSampler-544"><span class="linenos">544</span></a>                    <span class="p">(</span><span class="o">~</span><span class="n">interpolated_mask</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">voxel_coordinates</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="BaseSeparableSampler-545"><a href="#BaseSeparableSampler-545"><span class="linenos">545</span></a>                    <span class="n">kernels</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span> <span class="k">if</span> <span class="n">kernel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kernel</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="k">for</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="n">conv_kernels</span><span class="p">],</span>
</span><span id="BaseSeparableSampler-546"><a href="#BaseSeparableSampler-546"><span class="linenos">546</span></a>                    <span class="n">strides</span><span class="o">=</span><span class="n">conv_strides</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-547"><a href="#BaseSeparableSampler-547"><span class="linenos">547</span></a>                    <span class="n">paddings</span><span class="o">=</span><span class="n">conv_paddings</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-548"><a href="#BaseSeparableSampler-548"><span class="linenos">548</span></a>                    <span class="n">transposed</span><span class="o">=</span><span class="n">transposed_convolve</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-549"><a href="#BaseSeparableSampler-549"><span class="linenos">549</span></a>                    <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">volume</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-550"><a href="#BaseSeparableSampler-550"><span class="linenos">550</span></a>                <span class="p">)</span>
</span><span id="BaseSeparableSampler-551"><a href="#BaseSeparableSampler-551"><span class="linenos">551</span></a>                <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span>
</span><span id="BaseSeparableSampler-552"><a href="#BaseSeparableSampler-552"><span class="linenos">552</span></a>            <span class="p">)</span>
</span><span id="BaseSeparableSampler-553"><a href="#BaseSeparableSampler-553"><span class="linenos">553</span></a>            <span class="n">interpolated_mask</span> <span class="o">=</span> <span class="n">crop_and_then_pad_spatial</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-554"><a href="#BaseSeparableSampler-554"><span class="linenos">554</span></a>                <span class="n">interpolated_mask</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-555"><a href="#BaseSeparableSampler-555"><span class="linenos">555</span></a>                <span class="n">pads_or_crops</span><span class="o">=</span><span class="n">post_pads_or_crops</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-556"><a href="#BaseSeparableSampler-556"><span class="linenos">556</span></a>                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-557"><a href="#BaseSeparableSampler-557"><span class="linenos">557</span></a>                <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-558"><a href="#BaseSeparableSampler-558"><span class="linenos">558</span></a>                <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">volume</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-559"><a href="#BaseSeparableSampler-559"><span class="linenos">559</span></a>            <span class="p">)</span>
</span><span id="BaseSeparableSampler-560"><a href="#BaseSeparableSampler-560"><span class="linenos">560</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-561"><a href="#BaseSeparableSampler-561"><span class="linenos">561</span></a>            <span class="n">interpolated_values</span><span class="p">,</span> <span class="n">interpolated_mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">volume</span><span class="o">.</span><span class="n">n_channel_dims</span>
</span><span id="BaseSeparableSampler-562"><a href="#BaseSeparableSampler-562"><span class="linenos">562</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-563"><a href="#BaseSeparableSampler-563"><span class="linenos">563</span></a>
</span><span id="BaseSeparableSampler-564"><a href="#BaseSeparableSampler-564"><span class="linenos">564</span></a>    <span class="k">def</span> <span class="nf">_separable_conv</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-565"><a href="#BaseSeparableSampler-565"><span class="linenos">565</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-566"><a href="#BaseSeparableSampler-566"><span class="linenos">566</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-567"><a href="#BaseSeparableSampler-567"><span class="linenos">567</span></a>        <span class="n">kernels</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]],</span>
</span><span id="BaseSeparableSampler-568"><a href="#BaseSeparableSampler-568"><span class="linenos">568</span></a>        <span class="n">strides</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="BaseSeparableSampler-569"><a href="#BaseSeparableSampler-569"><span class="linenos">569</span></a>        <span class="n">paddings</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="BaseSeparableSampler-570"><a href="#BaseSeparableSampler-570"><span class="linenos">570</span></a>        <span class="n">transposed</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
</span><span id="BaseSeparableSampler-571"><a href="#BaseSeparableSampler-571"><span class="linenos">571</span></a>        <span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-572"><a href="#BaseSeparableSampler-572"><span class="linenos">572</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-573"><a href="#BaseSeparableSampler-573"><span class="linenos">573</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="BaseSeparableSampler-574"><a href="#BaseSeparableSampler-574"><span class="linenos">574</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">kernels</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">get_spatial_dims</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">))</span>
</span><span id="BaseSeparableSampler-575"><a href="#BaseSeparableSampler-575"><span class="linenos">575</span></a>            <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">kernels</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">strides</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-576"><a href="#BaseSeparableSampler-576"><span class="linenos">576</span></a>            <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">kernels</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">transposed</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-577"><a href="#BaseSeparableSampler-577"><span class="linenos">577</span></a>            <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">kernels</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paddings</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-578"><a href="#BaseSeparableSampler-578"><span class="linenos">578</span></a>        <span class="p">):</span>
</span><span id="BaseSeparableSampler-579"><a href="#BaseSeparableSampler-579"><span class="linenos">579</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid number of kernels, strides, transposed, or paddings&quot;</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-580"><a href="#BaseSeparableSampler-580"><span class="linenos">580</span></a>        <span class="k">for</span> <span class="n">spatial_dim</span><span class="p">,</span> <span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">dim_transposed</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-581"><a href="#BaseSeparableSampler-581"><span class="linenos">581</span></a>            <span class="nb">zip</span><span class="p">(</span><span class="n">kernels</span><span class="p">,</span> <span class="n">strides</span><span class="p">,</span> <span class="n">transposed</span><span class="p">,</span> <span class="n">paddings</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-582"><a href="#BaseSeparableSampler-582"><span class="linenos">582</span></a>        <span class="p">):</span>
</span><span id="BaseSeparableSampler-583"><a href="#BaseSeparableSampler-583"><span class="linenos">583</span></a>            <span class="k">if</span> <span class="n">kernel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">kernel</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-584"><a href="#BaseSeparableSampler-584"><span class="linenos">584</span></a>                <span class="k">assert</span> <span class="n">dim_transposed</span> <span class="ow">is</span> <span class="kc">False</span>
</span><span id="BaseSeparableSampler-585"><a href="#BaseSeparableSampler-585"><span class="linenos">585</span></a>                <span class="n">dim</span> <span class="o">=</span> <span class="n">get_spatial_dims</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">)[</span><span class="n">spatial_dim</span><span class="p">]</span>
</span><span id="BaseSeparableSampler-586"><a href="#BaseSeparableSampler-586"><span class="linenos">586</span></a>                <span class="n">volume</span> <span class="o">=</span> <span class="n">volume</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">+</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stride</span><span class="p">),)]</span>
</span><span id="BaseSeparableSampler-587"><a href="#BaseSeparableSampler-587"><span class="linenos">587</span></a>                <span class="k">if</span> <span class="n">kernel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-588"><a href="#BaseSeparableSampler-588"><span class="linenos">588</span></a>                    <span class="n">volume</span> <span class="o">=</span> <span class="n">kernel</span> <span class="o">*</span> <span class="n">volume</span>
</span><span id="BaseSeparableSampler-589"><a href="#BaseSeparableSampler-589"><span class="linenos">589</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-590"><a href="#BaseSeparableSampler-590"><span class="linenos">590</span></a>                <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conv1d</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-591"><a href="#BaseSeparableSampler-591"><span class="linenos">591</span></a>                    <span class="n">volume</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-592"><a href="#BaseSeparableSampler-592"><span class="linenos">592</span></a>                    <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-593"><a href="#BaseSeparableSampler-593"><span class="linenos">593</span></a>                    <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-594"><a href="#BaseSeparableSampler-594"><span class="linenos">594</span></a>                    <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-595"><a href="#BaseSeparableSampler-595"><span class="linenos">595</span></a>                    <span class="n">transposed</span><span class="o">=</span><span class="n">dim_transposed</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-596"><a href="#BaseSeparableSampler-596"><span class="linenos">596</span></a>                    <span class="n">spatial_dim</span><span class="o">=</span><span class="n">spatial_dim</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-597"><a href="#BaseSeparableSampler-597"><span class="linenos">597</span></a>                    <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-598"><a href="#BaseSeparableSampler-598"><span class="linenos">598</span></a>                <span class="p">)</span>
</span><span id="BaseSeparableSampler-599"><a href="#BaseSeparableSampler-599"><span class="linenos">599</span></a>        <span class="k">return</span> <span class="n">volume</span>
</span><span id="BaseSeparableSampler-600"><a href="#BaseSeparableSampler-600"><span class="linenos">600</span></a>
</span><span id="BaseSeparableSampler-601"><a href="#BaseSeparableSampler-601"><span class="linenos">601</span></a>    <span class="nd">@staticmethod</span>
</span><span id="BaseSeparableSampler-602"><a href="#BaseSeparableSampler-602"><span class="linenos">602</span></a>    <span class="k">def</span> <span class="nf">_conv1d</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-603"><a href="#BaseSeparableSampler-603"><span class="linenos">603</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-604"><a href="#BaseSeparableSampler-604"><span class="linenos">604</span></a>        <span class="n">kernel</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-605"><a href="#BaseSeparableSampler-605"><span class="linenos">605</span></a>        <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-606"><a href="#BaseSeparableSampler-606"><span class="linenos">606</span></a>        <span class="n">padding</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-607"><a href="#BaseSeparableSampler-607"><span class="linenos">607</span></a>        <span class="n">transposed</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-608"><a href="#BaseSeparableSampler-608"><span class="linenos">608</span></a>        <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-609"><a href="#BaseSeparableSampler-609"><span class="linenos">609</span></a>        <span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-610"><a href="#BaseSeparableSampler-610"><span class="linenos">610</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-611"><a href="#BaseSeparableSampler-611"><span class="linenos">611</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="n">get_spatial_dims</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">)[</span><span class="n">spatial_dim</span><span class="p">]</span>
</span><span id="BaseSeparableSampler-612"><a href="#BaseSeparableSampler-612"><span class="linenos">612</span></a>        <span class="n">volume</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-613"><a href="#BaseSeparableSampler-613"><span class="linenos">613</span></a>        <span class="n">dim_excluded_shape</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="BaseSeparableSampler-614"><a href="#BaseSeparableSampler-614"><span class="linenos">614</span></a>        <span class="n">volume</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">volume</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="BaseSeparableSampler-615"><a href="#BaseSeparableSampler-615"><span class="linenos">615</span></a>        <span class="n">conv_function</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">conv1d</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">transposed</span> <span class="k">else</span> <span class="n">conv_transpose1d</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-616"><a href="#BaseSeparableSampler-616"><span class="linenos">616</span></a>        <span class="n">convolved</span> <span class="o">=</span> <span class="n">conv_function</span><span class="p">(</span>  <span class="c1"># pylint: disable=not-callable</span>
</span><span id="BaseSeparableSampler-617"><a href="#BaseSeparableSampler-617"><span class="linenos">617</span></a>            <span class="n">volume</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-618"><a href="#BaseSeparableSampler-618"><span class="linenos">618</span></a>            <span class="n">kernel</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
</span><span id="BaseSeparableSampler-619"><a href="#BaseSeparableSampler-619"><span class="linenos">619</span></a>            <span class="n">bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-620"><a href="#BaseSeparableSampler-620"><span class="linenos">620</span></a>            <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="n">stride</span><span class="p">,),</span>
</span><span id="BaseSeparableSampler-621"><a href="#BaseSeparableSampler-621"><span class="linenos">621</span></a>            <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-622"><a href="#BaseSeparableSampler-622"><span class="linenos">622</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dim_excluded_shape</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,))</span>
</span><span id="BaseSeparableSampler-623"><a href="#BaseSeparableSampler-623"><span class="linenos">623</span></a>        <span class="k">return</span> <span class="n">convolved</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-624"><a href="#BaseSeparableSampler-624"><span class="linenos">624</span></a>
</span><span id="BaseSeparableSampler-625"><a href="#BaseSeparableSampler-625"><span class="linenos">625</span></a>    <span class="nd">@staticmethod</span>
</span><span id="BaseSeparableSampler-626"><a href="#BaseSeparableSampler-626"><span class="linenos">626</span></a>    <span class="k">def</span> <span class="nf">_get_flooring_function</span><span class="p">(</span><span class="n">inclusive</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="nb">int</span><span class="p">]:</span>
</span><span id="BaseSeparableSampler-627"><a href="#BaseSeparableSampler-627"><span class="linenos">627</span></a>        <span class="k">if</span> <span class="n">inclusive</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-628"><a href="#BaseSeparableSampler-628"><span class="linenos">628</span></a>            <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span><span id="BaseSeparableSampler-629"><a href="#BaseSeparableSampler-629"><span class="linenos">629</span></a>        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="BaseSeparableSampler-630"><a href="#BaseSeparableSampler-630"><span class="linenos">630</span></a>
</span><span id="BaseSeparableSampler-631"><a href="#BaseSeparableSampler-631"><span class="linenos">631</span></a>    <span class="k">def</span> <span class="nf">_interpolate_general</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-632"><a href="#BaseSeparableSampler-632"><span class="linenos">632</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span> <span class="n">voxel_coordinates</span><span class="p">:</span> <span class="n">MappableTensor</span>
</span><span id="BaseSeparableSampler-633"><a href="#BaseSeparableSampler-633"><span class="linenos">633</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-634"><a href="#BaseSeparableSampler-634"><span class="linenos">634</span></a>        <span class="n">volume_values</span><span class="p">,</span> <span class="n">volume_mask</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-635"><a href="#BaseSeparableSampler-635"><span class="linenos">635</span></a>            <span class="n">generate_missing_mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-636"><a href="#BaseSeparableSampler-636"><span class="linenos">636</span></a>            <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-637"><a href="#BaseSeparableSampler-637"><span class="linenos">637</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-638"><a href="#BaseSeparableSampler-638"><span class="linenos">638</span></a>        <span class="n">coordinate_values</span> <span class="o">=</span> <span class="n">voxel_coordinates</span><span class="o">.</span><span class="n">generate_values</span><span class="p">()</span>
</span><span id="BaseSeparableSampler-639"><a href="#BaseSeparableSampler-639"><span class="linenos">639</span></a>        <span class="n">interpolated_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_values</span><span class="p">(</span><span class="n">volume_values</span><span class="p">,</span> <span class="n">coordinate_values</span><span class="p">)</span>
</span><span id="BaseSeparableSampler-640"><a href="#BaseSeparableSampler-640"><span class="linenos">640</span></a>        <span class="k">if</span> <span class="n">volume_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-641"><a href="#BaseSeparableSampler-641"><span class="linenos">641</span></a>            <span class="n">interpolated_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_mask</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-642"><a href="#BaseSeparableSampler-642"><span class="linenos">642</span></a>                <span class="n">volume_mask</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-643"><a href="#BaseSeparableSampler-643"><span class="linenos">643</span></a>                <span class="n">coordinate_values</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-644"><a href="#BaseSeparableSampler-644"><span class="linenos">644</span></a>            <span class="p">)</span>
</span><span id="BaseSeparableSampler-645"><a href="#BaseSeparableSampler-645"><span class="linenos">645</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-646"><a href="#BaseSeparableSampler-646"><span class="linenos">646</span></a>            <span class="n">interpolated_mask</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BaseSeparableSampler-647"><a href="#BaseSeparableSampler-647"><span class="linenos">647</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-648"><a href="#BaseSeparableSampler-648"><span class="linenos">648</span></a>            <span class="n">interpolated_values</span><span class="p">,</span> <span class="n">interpolated_mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">volume</span><span class="o">.</span><span class="n">n_channel_dims</span>
</span><span id="BaseSeparableSampler-649"><a href="#BaseSeparableSampler-649"><span class="linenos">649</span></a>        <span class="p">)</span>
</span><span id="BaseSeparableSampler-650"><a href="#BaseSeparableSampler-650"><span class="linenos">650</span></a>
</span><span id="BaseSeparableSampler-651"><a href="#BaseSeparableSampler-651"><span class="linenos">651</span></a>    <span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-652"><a href="#BaseSeparableSampler-652"><span class="linenos">652</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-653"><a href="#BaseSeparableSampler-653"><span class="linenos">653</span></a>        <span class="n">coordinate_system</span><span class="p">:</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-654"><a href="#BaseSeparableSampler-654"><span class="linenos">654</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">DataFormat</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-655"><a href="#BaseSeparableSampler-655"><span class="linenos">655</span></a>        <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-656"><a href="#BaseSeparableSampler-656"><span class="linenos">656</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ISampler</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-657"><a href="#BaseSeparableSampler-657"><span class="linenos">657</span></a>        <span class="k">if</span> <span class="n">data_format</span><span class="o">.</span><span class="n">coordinate_type</span> <span class="o">==</span> <span class="s2">&quot;voxel&quot;</span> <span class="ow">and</span> <span class="n">data_format</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;displacements&quot;</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-658"><a href="#BaseSeparableSampler-658"><span class="linenos">658</span></a>            <span class="k">if</span> <span class="n">arguments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseSeparableSampler-659"><a href="#BaseSeparableSampler-659"><span class="linenos">659</span></a>                <span class="n">arguments</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="BaseSeparableSampler-660"><a href="#BaseSeparableSampler-660"><span class="linenos">660</span></a>            <span class="n">fixed_point_inversion_arguments</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fixed_point_inversion_arguments&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="BaseSeparableSampler-661"><a href="#BaseSeparableSampler-661"><span class="linenos">661</span></a>            <span class="k">return</span> <span class="n">FixedPointInverseSampler</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-662"><a href="#BaseSeparableSampler-662"><span class="linenos">662</span></a>                <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseSeparableSampler-663"><a href="#BaseSeparableSampler-663"><span class="linenos">663</span></a>                <span class="n">forward_solver</span><span class="o">=</span><span class="n">fixed_point_inversion_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forward_solver&quot;</span><span class="p">),</span>
</span><span id="BaseSeparableSampler-664"><a href="#BaseSeparableSampler-664"><span class="linenos">664</span></a>                <span class="n">backward_solver</span><span class="o">=</span><span class="n">fixed_point_inversion_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backward_solver&quot;</span><span class="p">),</span>
</span><span id="BaseSeparableSampler-665"><a href="#BaseSeparableSampler-665"><span class="linenos">665</span></a>                <span class="n">forward_dtype</span><span class="o">=</span><span class="n">fixed_point_inversion_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forward_dtype&quot;</span><span class="p">),</span>
</span><span id="BaseSeparableSampler-666"><a href="#BaseSeparableSampler-666"><span class="linenos">666</span></a>                <span class="n">backward_dtype</span><span class="o">=</span><span class="n">fixed_point_inversion_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backward_dtype&quot;</span><span class="p">),</span>
</span><span id="BaseSeparableSampler-667"><a href="#BaseSeparableSampler-667"><span class="linenos">667</span></a>                <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="o">=</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-668"><a href="#BaseSeparableSampler-668"><span class="linenos">668</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="BaseSeparableSampler-669"><a href="#BaseSeparableSampler-669"><span class="linenos">669</span></a>                <span class="p">),</span>
</span><span id="BaseSeparableSampler-670"><a href="#BaseSeparableSampler-670"><span class="linenos">670</span></a>            <span class="p">)</span>
</span><span id="BaseSeparableSampler-671"><a href="#BaseSeparableSampler-671"><span class="linenos">671</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="BaseSeparableSampler-672"><a href="#BaseSeparableSampler-672"><span class="linenos">672</span></a>            <span class="s2">&quot;Inverse sampler has been currently implemented only for voxel &quot;</span>
</span><span id="BaseSeparableSampler-673"><a href="#BaseSeparableSampler-673"><span class="linenos">673</span></a>            <span class="s2">&quot;displacements data format.&quot;</span>
</span><span id="BaseSeparableSampler-674"><a href="#BaseSeparableSampler-674"><span class="linenos">674</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Base sampler in voxel coordinates which can be implemented as a
separable convolution</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>extrapolation_mode:</strong>  Extrapolation mode for out-of-bound coordinates.</li>
<li><strong>mask_extrapolated_regions_for_empty_volume_mask:</strong>  Whether to mask
extrapolated regions when input volume mask is empty.</li>
<li><strong>convolution_threshold:</strong>  Maximum allowed difference in coordinates
for using convolution-based sampling (the difference might be upper
bounded when doing the decision).</li>
<li><strong>mask_threshold:</strong>  Maximum allowed weight for masked regions in a
sampled location to still consider it valid (non-masked).</li>
<li><strong>limit_direction:</strong>  Direction for evaluating the kernel at
discontinuous points.</li>
</ul>
</div>


                            <div id="BaseSeparableSampler.derivative" class="classattr">
                                        <input id="BaseSeparableSampler.derivative-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">derivative</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">limit_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#LimitDirection">LimitDirection</a></span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n"><a href="#LimitDirection">LimitDirection</a></span><span class="p">]]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n"><a href="#LimitDirection">LimitDirection</a></span> <span class="nb">object</span><span class="o">&gt;</span></span><span class="return-annotation">) -> <span class="n"><a href="#GenericSeparableDerivativeSampler">GenericSeparableDerivativeSampler</a></span>:</span></span>

                <label class="view-source-button" for="BaseSeparableSampler.derivative-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseSeparableSampler.derivative"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseSeparableSampler.derivative-204"><a href="#BaseSeparableSampler.derivative-204"><span class="linenos">204</span></a>    <span class="k">def</span> <span class="nf">derivative</span><span class="p">(</span>
</span><span id="BaseSeparableSampler.derivative-205"><a href="#BaseSeparableSampler.derivative-205"><span class="linenos">205</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseSeparableSampler.derivative-206"><a href="#BaseSeparableSampler.derivative-206"><span class="linenos">206</span></a>        <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="BaseSeparableSampler.derivative-207"><a href="#BaseSeparableSampler.derivative-207"><span class="linenos">207</span></a>        <span class="n">limit_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="BaseSeparableSampler.derivative-208"><a href="#BaseSeparableSampler.derivative-208"><span class="linenos">208</span></a>            <span class="n">LimitDirection</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">LimitDirection</span><span class="p">]</span>
</span><span id="BaseSeparableSampler.derivative-209"><a href="#BaseSeparableSampler.derivative-209"><span class="linenos">209</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">LimitDirection</span><span class="o">.</span><span class="n">average</span><span class="p">(),</span>
</span><span id="BaseSeparableSampler.derivative-210"><a href="#BaseSeparableSampler.derivative-210"><span class="linenos">210</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GenericSeparableDerivativeSampler&quot;</span><span class="p">:</span>
</span><span id="BaseSeparableSampler.derivative-211"><a href="#BaseSeparableSampler.derivative-211"><span class="linenos">211</span></a>        <span class="k">return</span> <span class="n">GenericSeparableDerivativeSampler</span><span class="p">(</span>
</span><span id="BaseSeparableSampler.derivative-212"><a href="#BaseSeparableSampler.derivative-212"><span class="linenos">212</span></a>            <span class="n">spatial_dim</span><span class="o">=</span><span class="n">spatial_dim</span><span class="p">,</span>
</span><span id="BaseSeparableSampler.derivative-213"><a href="#BaseSeparableSampler.derivative-213"><span class="linenos">213</span></a>            <span class="n">parent_left_limit_kernel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_left_limit_kernel</span><span class="p">,</span>
</span><span id="BaseSeparableSampler.derivative-214"><a href="#BaseSeparableSampler.derivative-214"><span class="linenos">214</span></a>            <span class="n">parent_right_limit_kernel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_right_limit_kernel</span><span class="p">,</span>
</span><span id="BaseSeparableSampler.derivative-215"><a href="#BaseSeparableSampler.derivative-215"><span class="linenos">215</span></a>            <span class="n">parent_kernel_support</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel_support</span><span class="p">,</span>
</span><span id="BaseSeparableSampler.derivative-216"><a href="#BaseSeparableSampler.derivative-216"><span class="linenos">216</span></a>            <span class="n">parent_is_interpolating_kernel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_interpolating_kernel</span><span class="p">,</span>
</span><span id="BaseSeparableSampler.derivative-217"><a href="#BaseSeparableSampler.derivative-217"><span class="linenos">217</span></a>            <span class="n">limit_direction</span><span class="o">=</span><span class="n">limit_direction</span><span class="p">,</span>
</span><span id="BaseSeparableSampler.derivative-218"><a href="#BaseSeparableSampler.derivative-218"><span class="linenos">218</span></a>            <span class="n">extrapolation_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extrapolation_mode</span><span class="p">,</span>
</span><span id="BaseSeparableSampler.derivative-219"><a href="#BaseSeparableSampler.derivative-219"><span class="linenos">219</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="o">=</span><span class="p">(</span>
</span><span id="BaseSeparableSampler.derivative-220"><a href="#BaseSeparableSampler.derivative-220"><span class="linenos">220</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="BaseSeparableSampler.derivative-221"><a href="#BaseSeparableSampler.derivative-221"><span class="linenos">221</span></a>            <span class="p">),</span>
</span><span id="BaseSeparableSampler.derivative-222"><a href="#BaseSeparableSampler.derivative-222"><span class="linenos">222</span></a>            <span class="n">convolution_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_convolution_threshold</span><span class="p">,</span>
</span><span id="BaseSeparableSampler.derivative-223"><a href="#BaseSeparableSampler.derivative-223"><span class="linenos">223</span></a>            <span class="n">mask_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span><span class="p">,</span>
</span><span id="BaseSeparableSampler.derivative-224"><a href="#BaseSeparableSampler.derivative-224"><span class="linenos">224</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Obtain sampler for sampling derivatives corresponding to the current sampler.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>spatial_dim:</strong>  Spatial dimension along which to compute the derivative.</li>
<li><strong>limit_direction:</strong>  Direction in which to compute the derivative.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Sampler for sampling derivatives.</p>
</blockquote>
</div>


                            </div>
                            <div id="BaseSeparableSampler.inverse" class="classattr">
                                        <input id="BaseSeparableSampler.inverse-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">inverse</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">coordinate_system</span><span class="p">:</span> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>,</span><span class="param">	<span class="n">data_format</span><span class="p">:</span> <span class="n"><a href="#DataFormat">DataFormat</a></span>,</span><span class="param">	<span class="n">arguments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#ISampler">ISampler</a></span>:</span></span>

                <label class="view-source-button" for="BaseSeparableSampler.inverse-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BaseSeparableSampler.inverse"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BaseSeparableSampler.inverse-651"><a href="#BaseSeparableSampler.inverse-651"><span class="linenos">651</span></a>    <span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span>
</span><span id="BaseSeparableSampler.inverse-652"><a href="#BaseSeparableSampler.inverse-652"><span class="linenos">652</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseSeparableSampler.inverse-653"><a href="#BaseSeparableSampler.inverse-653"><span class="linenos">653</span></a>        <span class="n">coordinate_system</span><span class="p">:</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">,</span>
</span><span id="BaseSeparableSampler.inverse-654"><a href="#BaseSeparableSampler.inverse-654"><span class="linenos">654</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">DataFormat</span><span class="p">,</span>
</span><span id="BaseSeparableSampler.inverse-655"><a href="#BaseSeparableSampler.inverse-655"><span class="linenos">655</span></a>        <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BaseSeparableSampler.inverse-656"><a href="#BaseSeparableSampler.inverse-656"><span class="linenos">656</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ISampler</span><span class="p">:</span>
</span><span id="BaseSeparableSampler.inverse-657"><a href="#BaseSeparableSampler.inverse-657"><span class="linenos">657</span></a>        <span class="k">if</span> <span class="n">data_format</span><span class="o">.</span><span class="n">coordinate_type</span> <span class="o">==</span> <span class="s2">&quot;voxel&quot;</span> <span class="ow">and</span> <span class="n">data_format</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;displacements&quot;</span><span class="p">:</span>
</span><span id="BaseSeparableSampler.inverse-658"><a href="#BaseSeparableSampler.inverse-658"><span class="linenos">658</span></a>            <span class="k">if</span> <span class="n">arguments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BaseSeparableSampler.inverse-659"><a href="#BaseSeparableSampler.inverse-659"><span class="linenos">659</span></a>                <span class="n">arguments</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="BaseSeparableSampler.inverse-660"><a href="#BaseSeparableSampler.inverse-660"><span class="linenos">660</span></a>            <span class="n">fixed_point_inversion_arguments</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fixed_point_inversion_arguments&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="BaseSeparableSampler.inverse-661"><a href="#BaseSeparableSampler.inverse-661"><span class="linenos">661</span></a>            <span class="k">return</span> <span class="n">FixedPointInverseSampler</span><span class="p">(</span>
</span><span id="BaseSeparableSampler.inverse-662"><a href="#BaseSeparableSampler.inverse-662"><span class="linenos">662</span></a>                <span class="bp">self</span><span class="p">,</span>
</span><span id="BaseSeparableSampler.inverse-663"><a href="#BaseSeparableSampler.inverse-663"><span class="linenos">663</span></a>                <span class="n">forward_solver</span><span class="o">=</span><span class="n">fixed_point_inversion_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forward_solver&quot;</span><span class="p">),</span>
</span><span id="BaseSeparableSampler.inverse-664"><a href="#BaseSeparableSampler.inverse-664"><span class="linenos">664</span></a>                <span class="n">backward_solver</span><span class="o">=</span><span class="n">fixed_point_inversion_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backward_solver&quot;</span><span class="p">),</span>
</span><span id="BaseSeparableSampler.inverse-665"><a href="#BaseSeparableSampler.inverse-665"><span class="linenos">665</span></a>                <span class="n">forward_dtype</span><span class="o">=</span><span class="n">fixed_point_inversion_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forward_dtype&quot;</span><span class="p">),</span>
</span><span id="BaseSeparableSampler.inverse-666"><a href="#BaseSeparableSampler.inverse-666"><span class="linenos">666</span></a>                <span class="n">backward_dtype</span><span class="o">=</span><span class="n">fixed_point_inversion_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;backward_dtype&quot;</span><span class="p">),</span>
</span><span id="BaseSeparableSampler.inverse-667"><a href="#BaseSeparableSampler.inverse-667"><span class="linenos">667</span></a>                <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="o">=</span><span class="p">(</span>
</span><span id="BaseSeparableSampler.inverse-668"><a href="#BaseSeparableSampler.inverse-668"><span class="linenos">668</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="BaseSeparableSampler.inverse-669"><a href="#BaseSeparableSampler.inverse-669"><span class="linenos">669</span></a>                <span class="p">),</span>
</span><span id="BaseSeparableSampler.inverse-670"><a href="#BaseSeparableSampler.inverse-670"><span class="linenos">670</span></a>            <span class="p">)</span>
</span><span id="BaseSeparableSampler.inverse-671"><a href="#BaseSeparableSampler.inverse-671"><span class="linenos">671</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="BaseSeparableSampler.inverse-672"><a href="#BaseSeparableSampler.inverse-672"><span class="linenos">672</span></a>            <span class="s2">&quot;Inverse sampler has been currently implemented only for voxel &quot;</span>
</span><span id="BaseSeparableSampler.inverse-673"><a href="#BaseSeparableSampler.inverse-673"><span class="linenos">673</span></a>            <span class="s2">&quot;displacements data format.&quot;</span>
</span><span id="BaseSeparableSampler.inverse-674"><a href="#BaseSeparableSampler.inverse-674"><span class="linenos">674</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Obtain sampler for sampling inverse values corresponding to the
current sampler, if available.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>coordinate_system:</strong>  Coordinate system of the mapping.</li>
<li><strong>data_format:</strong>  Data format of the sampled volume.</li>
<li><strong>arguments:</strong>  Additional arguments for the inverse.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Sampler for sampling inverse values.</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#ISampler">ISampler</a></dt>
                                <dd id="BaseSeparableSampler.sample_values" class="function"><a href="#ISampler.sample_values">sample_values</a></dd>
                <dd id="BaseSeparableSampler.sample_mask" class="function"><a href="#ISampler.sample_mask">sample_mask</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="BicubicInterpolator">
                            <input id="BicubicInterpolator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">BicubicInterpolator</span><wbr>(<span class="base"><a href="#BaseSeparableSampler">composable_mapping.BaseSeparableSampler</a></span>):

                <label class="view-source-button" for="BicubicInterpolator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BicubicInterpolator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BicubicInterpolator-167"><a href="#BicubicInterpolator-167"><span class="linenos">167</span></a><span class="k">class</span> <span class="nc">BicubicInterpolator</span><span class="p">(</span><span class="n">BaseSeparableSampler</span><span class="p">):</span>
</span><span id="BicubicInterpolator-168"><a href="#BicubicInterpolator-168"><span class="linenos">168</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Bicubic interpolation in voxel coordinates.</span>
</span><span id="BicubicInterpolator-169"><a href="#BicubicInterpolator-169"><span class="linenos">169</span></a>
</span><span id="BicubicInterpolator-170"><a href="#BicubicInterpolator-170"><span class="linenos">170</span></a><span class="sd">    Arguments:</span>
</span><span id="BicubicInterpolator-171"><a href="#BicubicInterpolator-171"><span class="linenos">171</span></a><span class="sd">        extrapolation_mode: Extrapolation mode for out-of-bound coordinates.</span>
</span><span id="BicubicInterpolator-172"><a href="#BicubicInterpolator-172"><span class="linenos">172</span></a><span class="sd">        mask_extrapolated_regions_for_empty_volume_mask: Whether to mask</span>
</span><span id="BicubicInterpolator-173"><a href="#BicubicInterpolator-173"><span class="linenos">173</span></a><span class="sd">            extrapolated regions when input volume mask is empty.</span>
</span><span id="BicubicInterpolator-174"><a href="#BicubicInterpolator-174"><span class="linenos">174</span></a><span class="sd">        convolution_threshold: Maximum allowed difference in coordinates</span>
</span><span id="BicubicInterpolator-175"><a href="#BicubicInterpolator-175"><span class="linenos">175</span></a><span class="sd">            for using convolution-based sampling (the difference might be upper</span>
</span><span id="BicubicInterpolator-176"><a href="#BicubicInterpolator-176"><span class="linenos">176</span></a><span class="sd">            bounded when doing the decision).</span>
</span><span id="BicubicInterpolator-177"><a href="#BicubicInterpolator-177"><span class="linenos">177</span></a><span class="sd">        mask_threshold: Maximum allowed weight for masked regions in a</span>
</span><span id="BicubicInterpolator-178"><a href="#BicubicInterpolator-178"><span class="linenos">178</span></a><span class="sd">            sampled location to still consider it valid (non-masked).</span>
</span><span id="BicubicInterpolator-179"><a href="#BicubicInterpolator-179"><span class="linenos">179</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="BicubicInterpolator-180"><a href="#BicubicInterpolator-180"><span class="linenos">180</span></a>
</span><span id="BicubicInterpolator-181"><a href="#BicubicInterpolator-181"><span class="linenos">181</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="BicubicInterpolator-182"><a href="#BicubicInterpolator-182"><span class="linenos">182</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BicubicInterpolator-183"><a href="#BicubicInterpolator-183"><span class="linenos">183</span></a>        <span class="n">extrapolation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;border&quot;</span><span class="p">,</span>
</span><span id="BicubicInterpolator-184"><a href="#BicubicInterpolator-184"><span class="linenos">184</span></a>        <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="BicubicInterpolator-185"><a href="#BicubicInterpolator-185"><span class="linenos">185</span></a>        <span class="n">convolution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
</span><span id="BicubicInterpolator-186"><a href="#BicubicInterpolator-186"><span class="linenos">186</span></a>        <span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span>
</span><span id="BicubicInterpolator-187"><a href="#BicubicInterpolator-187"><span class="linenos">187</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BicubicInterpolator-188"><a href="#BicubicInterpolator-188"><span class="linenos">188</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="BicubicInterpolator-189"><a href="#BicubicInterpolator-189"><span class="linenos">189</span></a>            <span class="n">extrapolation_mode</span><span class="o">=</span><span class="n">extrapolation_mode</span><span class="p">,</span>
</span><span id="BicubicInterpolator-190"><a href="#BicubicInterpolator-190"><span class="linenos">190</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="o">=</span><span class="p">(</span>
</span><span id="BicubicInterpolator-191"><a href="#BicubicInterpolator-191"><span class="linenos">191</span></a>                <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="BicubicInterpolator-192"><a href="#BicubicInterpolator-192"><span class="linenos">192</span></a>            <span class="p">),</span>
</span><span id="BicubicInterpolator-193"><a href="#BicubicInterpolator-193"><span class="linenos">193</span></a>            <span class="n">convolution_threshold</span><span class="o">=</span><span class="n">convolution_threshold</span><span class="p">,</span>
</span><span id="BicubicInterpolator-194"><a href="#BicubicInterpolator-194"><span class="linenos">194</span></a>            <span class="n">mask_threshold</span><span class="o">=</span><span class="n">mask_threshold</span><span class="p">,</span>
</span><span id="BicubicInterpolator-195"><a href="#BicubicInterpolator-195"><span class="linenos">195</span></a>            <span class="n">limit_direction</span><span class="o">=</span><span class="n">LimitDirection</span><span class="o">.</span><span class="n">right</span><span class="p">(),</span>
</span><span id="BicubicInterpolator-196"><a href="#BicubicInterpolator-196"><span class="linenos">196</span></a>        <span class="p">)</span>
</span><span id="BicubicInterpolator-197"><a href="#BicubicInterpolator-197"><span class="linenos">197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span> <span class="o">=</span> <span class="n">mask_threshold</span>
</span><span id="BicubicInterpolator-198"><a href="#BicubicInterpolator-198"><span class="linenos">198</span></a>
</span><span id="BicubicInterpolator-199"><a href="#BicubicInterpolator-199"><span class="linenos">199</span></a>    <span class="k">def</span> <span class="nf">_kernel_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ISeparableKernelSupport</span><span class="p">:</span>
</span><span id="BicubicInterpolator-200"><a href="#BicubicInterpolator-200"><span class="linenos">200</span></a>        <span class="k">return</span> <span class="n">SymmetricPolynomialKernelSupport</span><span class="p">(</span><span class="n">kernel_width</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">polynomial_degree</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="BicubicInterpolator-201"><a href="#BicubicInterpolator-201"><span class="linenos">201</span></a>
</span><span id="BicubicInterpolator-202"><a href="#BicubicInterpolator-202"><span class="linenos">202</span></a>    <span class="k">def</span> <span class="nf">_is_interpolating_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="BicubicInterpolator-203"><a href="#BicubicInterpolator-203"><span class="linenos">203</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="BicubicInterpolator-204"><a href="#BicubicInterpolator-204"><span class="linenos">204</span></a>
</span><span id="BicubicInterpolator-205"><a href="#BicubicInterpolator-205"><span class="linenos">205</span></a>    <span class="k">def</span> <span class="nf">_kernel_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="BicubicInterpolator-206"><a href="#BicubicInterpolator-206"><span class="linenos">206</span></a>        <span class="n">abs_coordinates</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
</span><span id="BicubicInterpolator-207"><a href="#BicubicInterpolator-207"><span class="linenos">207</span></a>        <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.75</span>
</span><span id="BicubicInterpolator-208"><a href="#BicubicInterpolator-208"><span class="linenos">208</span></a>        <span class="n">center_part</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">abs_coordinates</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">abs_coordinates</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="BicubicInterpolator-209"><a href="#BicubicInterpolator-209"><span class="linenos">209</span></a>        <span class="n">surrounding_part</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span>
</span><span id="BicubicInterpolator-210"><a href="#BicubicInterpolator-210"><span class="linenos">210</span></a>            <span class="n">abs_coordinates</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">abs_coordinates</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">abs_coordinates</span> <span class="o">-</span> <span class="mi">4</span>
</span><span id="BicubicInterpolator-211"><a href="#BicubicInterpolator-211"><span class="linenos">211</span></a>        <span class="p">)</span>
</span><span id="BicubicInterpolator-212"><a href="#BicubicInterpolator-212"><span class="linenos">212</span></a>        <span class="k">return</span> <span class="n">center_part</span><span class="p">,</span> <span class="n">surrounding_part</span>
</span><span id="BicubicInterpolator-213"><a href="#BicubicInterpolator-213"><span class="linenos">213</span></a>
</span><span id="BicubicInterpolator-214"><a href="#BicubicInterpolator-214"><span class="linenos">214</span></a>    <span class="k">def</span> <span class="nf">_left_limit_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="BicubicInterpolator-215"><a href="#BicubicInterpolator-215"><span class="linenos">215</span></a>        <span class="n">center_part</span><span class="p">,</span> <span class="n">surrounding_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_parts</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
</span><span id="BicubicInterpolator-216"><a href="#BicubicInterpolator-216"><span class="linenos">216</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="BicubicInterpolator-217"><a href="#BicubicInterpolator-217"><span class="linenos">217</span></a>            <span class="n">surrounding_part</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="BicubicInterpolator-218"><a href="#BicubicInterpolator-218"><span class="linenos">218</span></a>            <span class="o">+</span> <span class="n">center_part</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="BicubicInterpolator-219"><a href="#BicubicInterpolator-219"><span class="linenos">219</span></a>            <span class="o">+</span> <span class="n">center_part</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="BicubicInterpolator-220"><a href="#BicubicInterpolator-220"><span class="linenos">220</span></a>            <span class="o">+</span> <span class="n">surrounding_part</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="BicubicInterpolator-221"><a href="#BicubicInterpolator-221"><span class="linenos">221</span></a>        <span class="p">)</span>
</span><span id="BicubicInterpolator-222"><a href="#BicubicInterpolator-222"><span class="linenos">222</span></a>
</span><span id="BicubicInterpolator-223"><a href="#BicubicInterpolator-223"><span class="linenos">223</span></a>    <span class="k">def</span> <span class="nf">_right_limit_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="BicubicInterpolator-224"><a href="#BicubicInterpolator-224"><span class="linenos">224</span></a>        <span class="n">center_part</span><span class="p">,</span> <span class="n">surrounding_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_parts</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
</span><span id="BicubicInterpolator-225"><a href="#BicubicInterpolator-225"><span class="linenos">225</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="BicubicInterpolator-226"><a href="#BicubicInterpolator-226"><span class="linenos">226</span></a>            <span class="n">surrounding_part</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="BicubicInterpolator-227"><a href="#BicubicInterpolator-227"><span class="linenos">227</span></a>            <span class="o">+</span> <span class="n">center_part</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="BicubicInterpolator-228"><a href="#BicubicInterpolator-228"><span class="linenos">228</span></a>            <span class="o">+</span> <span class="n">center_part</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="BicubicInterpolator-229"><a href="#BicubicInterpolator-229"><span class="linenos">229</span></a>            <span class="o">+</span> <span class="n">surrounding_part</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="BicubicInterpolator-230"><a href="#BicubicInterpolator-230"><span class="linenos">230</span></a>        <span class="p">)</span>
</span><span id="BicubicInterpolator-231"><a href="#BicubicInterpolator-231"><span class="linenos">231</span></a>
</span><span id="BicubicInterpolator-232"><a href="#BicubicInterpolator-232"><span class="linenos">232</span></a>    <span class="k">def</span> <span class="nf">sample_values</span><span class="p">(</span>
</span><span id="BicubicInterpolator-233"><a href="#BicubicInterpolator-233"><span class="linenos">233</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BicubicInterpolator-234"><a href="#BicubicInterpolator-234"><span class="linenos">234</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="BicubicInterpolator-235"><a href="#BicubicInterpolator-235"><span class="linenos">235</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="BicubicInterpolator-236"><a href="#BicubicInterpolator-236"><span class="linenos">236</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="BicubicInterpolator-237"><a href="#BicubicInterpolator-237"><span class="linenos">237</span></a>        <span class="k">return</span> <span class="n">interpolate</span><span class="p">(</span>
</span><span id="BicubicInterpolator-238"><a href="#BicubicInterpolator-238"><span class="linenos">238</span></a>            <span class="n">volume</span><span class="p">,</span>
</span><span id="BicubicInterpolator-239"><a href="#BicubicInterpolator-239"><span class="linenos">239</span></a>            <span class="n">coordinates</span><span class="p">,</span>
</span><span id="BicubicInterpolator-240"><a href="#BicubicInterpolator-240"><span class="linenos">240</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;bicubic&quot;</span><span class="p">,</span>
</span><span id="BicubicInterpolator-241"><a href="#BicubicInterpolator-241"><span class="linenos">241</span></a>            <span class="n">padding_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extrapolation_mode</span><span class="p">,</span>
</span><span id="BicubicInterpolator-242"><a href="#BicubicInterpolator-242"><span class="linenos">242</span></a>        <span class="p">)</span>
</span><span id="BicubicInterpolator-243"><a href="#BicubicInterpolator-243"><span class="linenos">243</span></a>
</span><span id="BicubicInterpolator-244"><a href="#BicubicInterpolator-244"><span class="linenos">244</span></a>    <span class="k">def</span> <span class="nf">sample_mask</span><span class="p">(</span>
</span><span id="BicubicInterpolator-245"><a href="#BicubicInterpolator-245"><span class="linenos">245</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BicubicInterpolator-246"><a href="#BicubicInterpolator-246"><span class="linenos">246</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="BicubicInterpolator-247"><a href="#BicubicInterpolator-247"><span class="linenos">247</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="BicubicInterpolator-248"><a href="#BicubicInterpolator-248"><span class="linenos">248</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="BicubicInterpolator-249"><a href="#BicubicInterpolator-249"><span class="linenos">249</span></a>        <span class="n">n_spatial_dims</span> <span class="o">=</span> <span class="n">get_channels_shape</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BicubicInterpolator-250"><a href="#BicubicInterpolator-250"><span class="linenos">250</span></a>        <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="n">get_n_channel_dims</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">n_spatial_dims</span><span class="p">)</span>
</span><span id="BicubicInterpolator-251"><a href="#BicubicInterpolator-251"><span class="linenos">251</span></a>        <span class="n">batch_shape</span><span class="p">,</span> <span class="n">channels_shape</span><span class="p">,</span> <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">split_shape</span><span class="p">(</span>
</span><span id="BicubicInterpolator-252"><a href="#BicubicInterpolator-252"><span class="linenos">252</span></a>            <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span>
</span><span id="BicubicInterpolator-253"><a href="#BicubicInterpolator-253"><span class="linenos">253</span></a>        <span class="p">)</span>
</span><span id="BicubicInterpolator-254"><a href="#BicubicInterpolator-254"><span class="linenos">254</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">spatial_shape</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="BicubicInterpolator-255"><a href="#BicubicInterpolator-255"><span class="linenos">255</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">_avg_pool_nd_function</span><span class="p">(</span><span class="n">n_spatial_dims</span><span class="p">)(</span><span class="n">mask</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
</span><span id="BicubicInterpolator-256"><a href="#BicubicInterpolator-256"><span class="linenos">256</span></a>        <span class="n">interpolated_mask</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span>
</span><span id="BicubicInterpolator-257"><a href="#BicubicInterpolator-257"><span class="linenos">257</span></a>            <span class="n">volume</span><span class="o">=</span><span class="n">mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="BicubicInterpolator-258"><a href="#BicubicInterpolator-258"><span class="linenos">258</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
</span><span id="BicubicInterpolator-259"><a href="#BicubicInterpolator-259"><span class="linenos">259</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
</span><span id="BicubicInterpolator-260"><a href="#BicubicInterpolator-260"><span class="linenos">260</span></a>            <span class="n">padding_mode</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span>
</span><span id="BicubicInterpolator-261"><a href="#BicubicInterpolator-261"><span class="linenos">261</span></a>        <span class="p">)</span>
</span><span id="BicubicInterpolator-262"><a href="#BicubicInterpolator-262"><span class="linenos">262</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="BicubicInterpolator-263"><a href="#BicubicInterpolator-263"><span class="linenos">263</span></a>            <span class="n">interpolated_mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
</span><span id="BicubicInterpolator-264"><a href="#BicubicInterpolator-264"><span class="linenos">264</span></a>                <span class="n">get_batch_shape</span><span class="p">(</span><span class="n">interpolated_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="BicubicInterpolator-265"><a href="#BicubicInterpolator-265"><span class="linenos">265</span></a>                <span class="o">+</span> <span class="n">channels_shape</span>
</span><span id="BicubicInterpolator-266"><a href="#BicubicInterpolator-266"><span class="linenos">266</span></a>                <span class="o">+</span> <span class="n">get_spatial_shape</span><span class="p">(</span><span class="n">interpolated_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="BicubicInterpolator-267"><a href="#BicubicInterpolator-267"><span class="linenos">267</span></a>            <span class="p">)</span>
</span><span id="BicubicInterpolator-268"><a href="#BicubicInterpolator-268"><span class="linenos">268</span></a>            <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span>
</span><span id="BicubicInterpolator-269"><a href="#BicubicInterpolator-269"><span class="linenos">269</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Bicubic interpolation in voxel coordinates.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>extrapolation_mode:</strong>  Extrapolation mode for out-of-bound coordinates.</li>
<li><strong>mask_extrapolated_regions_for_empty_volume_mask:</strong>  Whether to mask
extrapolated regions when input volume mask is empty.</li>
<li><strong>convolution_threshold:</strong>  Maximum allowed difference in coordinates
for using convolution-based sampling (the difference might be upper
bounded when doing the decision).</li>
<li><strong>mask_threshold:</strong>  Maximum allowed weight for masked regions in a
sampled location to still consider it valid (non-masked).</li>
</ul>
</div>


                            <div id="BicubicInterpolator.__init__" class="classattr">
                                        <input id="BicubicInterpolator.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">BicubicInterpolator</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">extrapolation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;border&#39;</span>,</span><span class="param">	<span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">convolution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0001</span>,</span><span class="param">	<span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-05</span></span>)</span>

                <label class="view-source-button" for="BicubicInterpolator.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BicubicInterpolator.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BicubicInterpolator.__init__-181"><a href="#BicubicInterpolator.__init__-181"><span class="linenos">181</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="BicubicInterpolator.__init__-182"><a href="#BicubicInterpolator.__init__-182"><span class="linenos">182</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BicubicInterpolator.__init__-183"><a href="#BicubicInterpolator.__init__-183"><span class="linenos">183</span></a>        <span class="n">extrapolation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;border&quot;</span><span class="p">,</span>
</span><span id="BicubicInterpolator.__init__-184"><a href="#BicubicInterpolator.__init__-184"><span class="linenos">184</span></a>        <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="BicubicInterpolator.__init__-185"><a href="#BicubicInterpolator.__init__-185"><span class="linenos">185</span></a>        <span class="n">convolution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
</span><span id="BicubicInterpolator.__init__-186"><a href="#BicubicInterpolator.__init__-186"><span class="linenos">186</span></a>        <span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span>
</span><span id="BicubicInterpolator.__init__-187"><a href="#BicubicInterpolator.__init__-187"><span class="linenos">187</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BicubicInterpolator.__init__-188"><a href="#BicubicInterpolator.__init__-188"><span class="linenos">188</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="BicubicInterpolator.__init__-189"><a href="#BicubicInterpolator.__init__-189"><span class="linenos">189</span></a>            <span class="n">extrapolation_mode</span><span class="o">=</span><span class="n">extrapolation_mode</span><span class="p">,</span>
</span><span id="BicubicInterpolator.__init__-190"><a href="#BicubicInterpolator.__init__-190"><span class="linenos">190</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="o">=</span><span class="p">(</span>
</span><span id="BicubicInterpolator.__init__-191"><a href="#BicubicInterpolator.__init__-191"><span class="linenos">191</span></a>                <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="BicubicInterpolator.__init__-192"><a href="#BicubicInterpolator.__init__-192"><span class="linenos">192</span></a>            <span class="p">),</span>
</span><span id="BicubicInterpolator.__init__-193"><a href="#BicubicInterpolator.__init__-193"><span class="linenos">193</span></a>            <span class="n">convolution_threshold</span><span class="o">=</span><span class="n">convolution_threshold</span><span class="p">,</span>
</span><span id="BicubicInterpolator.__init__-194"><a href="#BicubicInterpolator.__init__-194"><span class="linenos">194</span></a>            <span class="n">mask_threshold</span><span class="o">=</span><span class="n">mask_threshold</span><span class="p">,</span>
</span><span id="BicubicInterpolator.__init__-195"><a href="#BicubicInterpolator.__init__-195"><span class="linenos">195</span></a>            <span class="n">limit_direction</span><span class="o">=</span><span class="n">LimitDirection</span><span class="o">.</span><span class="n">right</span><span class="p">(),</span>
</span><span id="BicubicInterpolator.__init__-196"><a href="#BicubicInterpolator.__init__-196"><span class="linenos">196</span></a>        <span class="p">)</span>
</span><span id="BicubicInterpolator.__init__-197"><a href="#BicubicInterpolator.__init__-197"><span class="linenos">197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span> <span class="o">=</span> <span class="n">mask_threshold</span>
</span></pre></div>


    

                            </div>
                            <div id="BicubicInterpolator.sample_values" class="classattr">
                                        <input id="BicubicInterpolator.sample_values-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_values</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">volume</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>, </span><span class="param"><span class="n">coordinates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="BicubicInterpolator.sample_values-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BicubicInterpolator.sample_values"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BicubicInterpolator.sample_values-232"><a href="#BicubicInterpolator.sample_values-232"><span class="linenos">232</span></a>    <span class="k">def</span> <span class="nf">sample_values</span><span class="p">(</span>
</span><span id="BicubicInterpolator.sample_values-233"><a href="#BicubicInterpolator.sample_values-233"><span class="linenos">233</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BicubicInterpolator.sample_values-234"><a href="#BicubicInterpolator.sample_values-234"><span class="linenos">234</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="BicubicInterpolator.sample_values-235"><a href="#BicubicInterpolator.sample_values-235"><span class="linenos">235</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="BicubicInterpolator.sample_values-236"><a href="#BicubicInterpolator.sample_values-236"><span class="linenos">236</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="BicubicInterpolator.sample_values-237"><a href="#BicubicInterpolator.sample_values-237"><span class="linenos">237</span></a>        <span class="k">return</span> <span class="n">interpolate</span><span class="p">(</span>
</span><span id="BicubicInterpolator.sample_values-238"><a href="#BicubicInterpolator.sample_values-238"><span class="linenos">238</span></a>            <span class="n">volume</span><span class="p">,</span>
</span><span id="BicubicInterpolator.sample_values-239"><a href="#BicubicInterpolator.sample_values-239"><span class="linenos">239</span></a>            <span class="n">coordinates</span><span class="p">,</span>
</span><span id="BicubicInterpolator.sample_values-240"><a href="#BicubicInterpolator.sample_values-240"><span class="linenos">240</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;bicubic&quot;</span><span class="p">,</span>
</span><span id="BicubicInterpolator.sample_values-241"><a href="#BicubicInterpolator.sample_values-241"><span class="linenos">241</span></a>            <span class="n">padding_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extrapolation_mode</span><span class="p">,</span>
</span><span id="BicubicInterpolator.sample_values-242"><a href="#BicubicInterpolator.sample_values-242"><span class="linenos">242</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sample values at spatial locations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>volume:</strong>  Volume to sample over spatial dimensions
with shape (*batch_shape, *channels_shape, *spatial_shape)</li>
<li><strong>coordinates:</strong>  Coordinates in voxel coordinates with shape
(*batch_shape, n_spatial_dims, *target_shape).</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Sampled values with shape (*batch_shape, *channels_shape, *target_shape).</p>
</blockquote>
</div>


                            </div>
                            <div id="BicubicInterpolator.sample_mask" class="classattr">
                                        <input id="BicubicInterpolator.sample_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_mask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>, </span><span class="param"><span class="n">coordinates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="BicubicInterpolator.sample_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BicubicInterpolator.sample_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BicubicInterpolator.sample_mask-244"><a href="#BicubicInterpolator.sample_mask-244"><span class="linenos">244</span></a>    <span class="k">def</span> <span class="nf">sample_mask</span><span class="p">(</span>
</span><span id="BicubicInterpolator.sample_mask-245"><a href="#BicubicInterpolator.sample_mask-245"><span class="linenos">245</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="BicubicInterpolator.sample_mask-246"><a href="#BicubicInterpolator.sample_mask-246"><span class="linenos">246</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="BicubicInterpolator.sample_mask-247"><a href="#BicubicInterpolator.sample_mask-247"><span class="linenos">247</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="BicubicInterpolator.sample_mask-248"><a href="#BicubicInterpolator.sample_mask-248"><span class="linenos">248</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="BicubicInterpolator.sample_mask-249"><a href="#BicubicInterpolator.sample_mask-249"><span class="linenos">249</span></a>        <span class="n">n_spatial_dims</span> <span class="o">=</span> <span class="n">get_channels_shape</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="BicubicInterpolator.sample_mask-250"><a href="#BicubicInterpolator.sample_mask-250"><span class="linenos">250</span></a>        <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="n">get_n_channel_dims</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">n_spatial_dims</span><span class="p">)</span>
</span><span id="BicubicInterpolator.sample_mask-251"><a href="#BicubicInterpolator.sample_mask-251"><span class="linenos">251</span></a>        <span class="n">batch_shape</span><span class="p">,</span> <span class="n">channels_shape</span><span class="p">,</span> <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">split_shape</span><span class="p">(</span>
</span><span id="BicubicInterpolator.sample_mask-252"><a href="#BicubicInterpolator.sample_mask-252"><span class="linenos">252</span></a>            <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span>
</span><span id="BicubicInterpolator.sample_mask-253"><a href="#BicubicInterpolator.sample_mask-253"><span class="linenos">253</span></a>        <span class="p">)</span>
</span><span id="BicubicInterpolator.sample_mask-254"><a href="#BicubicInterpolator.sample_mask-254"><span class="linenos">254</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">+</span> <span class="n">spatial_shape</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="BicubicInterpolator.sample_mask-255"><a href="#BicubicInterpolator.sample_mask-255"><span class="linenos">255</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">_avg_pool_nd_function</span><span class="p">(</span><span class="n">n_spatial_dims</span><span class="p">)(</span><span class="n">mask</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
</span><span id="BicubicInterpolator.sample_mask-256"><a href="#BicubicInterpolator.sample_mask-256"><span class="linenos">256</span></a>        <span class="n">interpolated_mask</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span>
</span><span id="BicubicInterpolator.sample_mask-257"><a href="#BicubicInterpolator.sample_mask-257"><span class="linenos">257</span></a>            <span class="n">volume</span><span class="o">=</span><span class="n">mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="BicubicInterpolator.sample_mask-258"><a href="#BicubicInterpolator.sample_mask-258"><span class="linenos">258</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
</span><span id="BicubicInterpolator.sample_mask-259"><a href="#BicubicInterpolator.sample_mask-259"><span class="linenos">259</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
</span><span id="BicubicInterpolator.sample_mask-260"><a href="#BicubicInterpolator.sample_mask-260"><span class="linenos">260</span></a>            <span class="n">padding_mode</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span>
</span><span id="BicubicInterpolator.sample_mask-261"><a href="#BicubicInterpolator.sample_mask-261"><span class="linenos">261</span></a>        <span class="p">)</span>
</span><span id="BicubicInterpolator.sample_mask-262"><a href="#BicubicInterpolator.sample_mask-262"><span class="linenos">262</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="BicubicInterpolator.sample_mask-263"><a href="#BicubicInterpolator.sample_mask-263"><span class="linenos">263</span></a>            <span class="n">interpolated_mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
</span><span id="BicubicInterpolator.sample_mask-264"><a href="#BicubicInterpolator.sample_mask-264"><span class="linenos">264</span></a>                <span class="n">get_batch_shape</span><span class="p">(</span><span class="n">interpolated_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="BicubicInterpolator.sample_mask-265"><a href="#BicubicInterpolator.sample_mask-265"><span class="linenos">265</span></a>                <span class="o">+</span> <span class="n">channels_shape</span>
</span><span id="BicubicInterpolator.sample_mask-266"><a href="#BicubicInterpolator.sample_mask-266"><span class="linenos">266</span></a>                <span class="o">+</span> <span class="n">get_spatial_shape</span><span class="p">(</span><span class="n">interpolated_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="BicubicInterpolator.sample_mask-267"><a href="#BicubicInterpolator.sample_mask-267"><span class="linenos">267</span></a>            <span class="p">)</span>
</span><span id="BicubicInterpolator.sample_mask-268"><a href="#BicubicInterpolator.sample_mask-268"><span class="linenos">268</span></a>            <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span>
</span><span id="BicubicInterpolator.sample_mask-269"><a href="#BicubicInterpolator.sample_mask-269"><span class="linenos">269</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sample mask at spatial locations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mask:</strong>  Mask to sample over spatial dimensions
with shape (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</li>
<li><strong>coordinates:</strong>  Coordinates in voxel coordinates with shape
(*batch_shape, n_spatial_dims, *target_shape).</li>
</ul>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#BaseSeparableSampler">BaseSeparableSampler</a></dt>
                                <dd id="BicubicInterpolator.derivative" class="function"><a href="#BaseSeparableSampler.derivative">derivative</a></dd>
                <dd id="BicubicInterpolator.inverse" class="function"><a href="#BaseSeparableSampler.inverse">inverse</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ClearMask">
                            <input id="ClearMask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ClearMask</span><wbr>(<span class="base">composable_mapping.tensor_like.BaseTensorLikeWrapper</span>, <span class="base"><a href="#ComposableMapping">composable_mapping.ComposableMapping</a></span>):

                <label class="view-source-button" for="ClearMask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClearMask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClearMask-100"><a href="#ClearMask-100"><span class="linenos">100</span></a><span class="k">class</span> <span class="nc">ClearMask</span><span class="p">(</span><span class="n">BaseTensorLikeWrapper</span><span class="p">,</span> <span class="n">ComposableMapping</span><span class="p">):</span>
</span><span id="ClearMask-101"><a href="#ClearMask-101"><span class="linenos">101</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear mask of the input&quot;&quot;&quot;</span>
</span><span id="ClearMask-102"><a href="#ClearMask-102"><span class="linenos">102</span></a>
</span><span id="ClearMask-103"><a href="#ClearMask-103"><span class="linenos">103</span></a>    <span class="k">def</span> <span class="nf">_get_tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="ClearMask-104"><a href="#ClearMask-104"><span class="linenos">104</span></a>        <span class="k">return</span> <span class="p">{}</span>
</span><span id="ClearMask-105"><a href="#ClearMask-105"><span class="linenos">105</span></a>
</span><span id="ClearMask-106"><a href="#ClearMask-106"><span class="linenos">106</span></a>    <span class="k">def</span> <span class="nf">_get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]:</span>
</span><span id="ClearMask-107"><a href="#ClearMask-107"><span class="linenos">107</span></a>        <span class="k">return</span> <span class="p">{}</span>
</span><span id="ClearMask-108"><a href="#ClearMask-108"><span class="linenos">108</span></a>
</span><span id="ClearMask-109"><a href="#ClearMask-109"><span class="linenos">109</span></a>    <span class="k">def</span> <span class="nf">_modified_copy</span><span class="p">(</span>
</span><span id="ClearMask-110"><a href="#ClearMask-110"><span class="linenos">110</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">tensors</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">children</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]</span>
</span><span id="ClearMask-111"><a href="#ClearMask-111"><span class="linenos">111</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ClearMask&quot;</span><span class="p">:</span>
</span><span id="ClearMask-112"><a href="#ClearMask-112"><span class="linenos">112</span></a>        <span class="k">return</span> <span class="n">ClearMask</span><span class="p">()</span>
</span><span id="ClearMask-113"><a href="#ClearMask-113"><span class="linenos">113</span></a>
</span><span id="ClearMask-114"><a href="#ClearMask-114"><span class="linenos">114</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">masked_coordinates</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="ClearMask-115"><a href="#ClearMask-115"><span class="linenos">115</span></a>        <span class="k">return</span> <span class="n">masked_coordinates</span><span class="o">.</span><span class="n">clear_mask</span><span class="p">()</span>
</span><span id="ClearMask-116"><a href="#ClearMask-116"><span class="linenos">116</span></a>
</span><span id="ClearMask-117"><a href="#ClearMask-117"><span class="linenos">117</span></a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">):</span>
</span><span id="ClearMask-118"><a href="#ClearMask-118"><span class="linenos">118</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Mask clearing is not invertible&quot;</span><span class="p">)</span>
</span><span id="ClearMask-119"><a href="#ClearMask-119"><span class="linenos">119</span></a>
</span><span id="ClearMask-120"><a href="#ClearMask-120"><span class="linenos">120</span></a>    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ClearMask&quot;</span><span class="p">:</span>
</span><span id="ClearMask-121"><a href="#ClearMask-121"><span class="linenos">121</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="ClearMask-122"><a href="#ClearMask-122"><span class="linenos">122</span></a>
</span><span id="ClearMask-123"><a href="#ClearMask-123"><span class="linenos">123</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="ClearMask-124"><a href="#ClearMask-124"><span class="linenos">124</span></a>        <span class="k">return</span> <span class="s2">&quot;ClearMask()&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Clear mask of the input</p>
</div>


                            <div id="ClearMask.invert" class="classattr">
                                        <input id="ClearMask.invert-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">invert</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">**</span><span class="n">arguments</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClearMask.invert-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClearMask.invert"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClearMask.invert-117"><a href="#ClearMask.invert-117"><span class="linenos">117</span></a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">):</span>
</span><span id="ClearMask.invert-118"><a href="#ClearMask.invert-118"><span class="linenos">118</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Mask clearing is not invertible&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Invert the mapping.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>arguments:</strong>  Arguments for the inversion.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>The inverted mapping.</p>
</blockquote>
</div>


                            </div>
                            <div id="ClearMask.detach" class="classattr">
                                        <input id="ClearMask.detach-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">detach</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n"><a href="#ClearMask">ClearMask</a></span>:</span></span>

                <label class="view-source-button" for="ClearMask.detach-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClearMask.detach"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClearMask.detach-120"><a href="#ClearMask.detach-120"><span class="linenos">120</span></a>    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ClearMask&quot;</span><span class="p">:</span>
</span><span id="ClearMask.detach-121"><a href="#ClearMask.detach-121"><span class="linenos">121</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Detach the wrapped tensors from computational graph</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>composable_mapping.tensor_like.BaseTensorLikeWrapper</dt>
                                <dd id="ClearMask.dtype" class="variable">dtype</dd>
                <dd id="ClearMask.device" class="variable">device</dd>
                <dd id="ClearMask.cast" class="function">cast</dd>
                <dd id="ClearMask.pin_memory" class="function">pin_memory</dd>

            </div>
            <div><dt><a href="#ComposableMapping">ComposableMapping</a></dt>
                                <dd id="ClearMask.sample_to" class="function"><a href="#ComposableMapping.sample_to">sample_to</a></dd>
                <dd id="ClearMask.resample_to" class="function"><a href="#ComposableMapping.resample_to">resample_to</a></dd>
                <dd id="ClearMask.assign_coordinates" class="function"><a href="#ComposableMapping.assign_coordinates">assign_coordinates</a></dd>
                <dd id="ClearMask.as_affine_transformation" class="function"><a href="#ComposableMapping.as_affine_transformation">as_affine_transformation</a></dd>
                <dd id="ClearMask.as_affine_matrix" class="function"><a href="#ComposableMapping.as_affine_matrix">as_affine_matrix</a></dd>
                <dd id="ClearMask.default_sampling_data_format" class="variable"><a href="#ComposableMapping.default_sampling_data_format">default_sampling_data_format</a></dd>
                <dd id="ClearMask.set_default_sampling_data_format" class="function"><a href="#ComposableMapping.set_default_sampling_data_format">set_default_sampling_data_format</a></dd>
                <dd id="ClearMask.__matmul__" class="function"><a href="#ComposableMapping.__matmul__">__matmul__</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ComposableMapping">
                            <input id="ComposableMapping-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ComposableMapping</span><wbr>(<span class="base"><a href="#ITensorLike">composable_mapping.ITensorLike</a></span>, <span class="base">abc.ABC</span>):

                <label class="view-source-button" for="ComposableMapping-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ComposableMapping"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ComposableMapping-149"><a href="#ComposableMapping-149"><span class="linenos">149</span></a><span class="k">class</span> <span class="nc">ComposableMapping</span><span class="p">(</span><span class="n">ITensorLike</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
</span><span id="ComposableMapping-150"><a href="#ComposableMapping-150"><span class="linenos">150</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for mappings composable with each other, and acting on mappable</span>
</span><span id="ComposableMapping-151"><a href="#ComposableMapping-151"><span class="linenos">151</span></a><span class="sd">    tensors.</span>
</span><span id="ComposableMapping-152"><a href="#ComposableMapping-152"><span class="linenos">152</span></a>
</span><span id="ComposableMapping-153"><a href="#ComposableMapping-153"><span class="linenos">153</span></a><span class="sd">    In general a composable mapping is a callable object that takes coordinates</span>
</span><span id="ComposableMapping-154"><a href="#ComposableMapping-154"><span class="linenos">154</span></a><span class="sd">    as input and returns the mapping evaluated at these coordinates. Composable</span>
</span><span id="ComposableMapping-155"><a href="#ComposableMapping-155"><span class="linenos">155</span></a><span class="sd">    mappings are generally assumed to be independent over the batch and spatial</span>
</span><span id="ComposableMapping-156"><a href="#ComposableMapping-156"><span class="linenos">156</span></a><span class="sd">    dimensions of an input.</span>
</span><span id="ComposableMapping-157"><a href="#ComposableMapping-157"><span class="linenos">157</span></a>
</span><span id="ComposableMapping-158"><a href="#ComposableMapping-158"><span class="linenos">158</span></a><span class="sd">    As the name suggests, a composable mapping can be additionally composed with</span>
</span><span id="ComposableMapping-159"><a href="#ComposableMapping-159"><span class="linenos">159</span></a><span class="sd">    other composable mappings with the `__matmul__` operator (@). Composing does</span>
</span><span id="ComposableMapping-160"><a href="#ComposableMapping-160"><span class="linenos">160</span></a><span class="sd">    not apply resampling, an operation which can be executed separately using</span>
</span><span id="ComposableMapping-161"><a href="#ComposableMapping-161"><span class="linenos">161</span></a><span class="sd">    `resample_to` method (or `GridComposableMapping.resample` method for</span>
</span><span id="ComposableMapping-162"><a href="#ComposableMapping-162"><span class="linenos">162</span></a><span class="sd">    composable mappings with an assigned coordinate system).</span>
</span><span id="ComposableMapping-163"><a href="#ComposableMapping-163"><span class="linenos">163</span></a>
</span><span id="ComposableMapping-164"><a href="#ComposableMapping-164"><span class="linenos">164</span></a><span class="sd">    Basic arithmetic operations are also supported between two composable</span>
</span><span id="ComposableMapping-165"><a href="#ComposableMapping-165"><span class="linenos">165</span></a><span class="sd">    mappings or between a composable mapping and a number or a tensor, both of</span>
</span><span id="ComposableMapping-166"><a href="#ComposableMapping-166"><span class="linenos">166</span></a><span class="sd">    which return a new composable mapping.</span>
</span><span id="ComposableMapping-167"><a href="#ComposableMapping-167"><span class="linenos">167</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ComposableMapping-168"><a href="#ComposableMapping-168"><span class="linenos">168</span></a>
</span><span id="ComposableMapping-169"><a href="#ComposableMapping-169"><span class="linenos">169</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ComposableMapping-170"><a href="#ComposableMapping-170"><span class="linenos">170</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="ComposableMapping-171"><a href="#ComposableMapping-171"><span class="linenos">171</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate the mapping at coordinates.</span>
</span><span id="ComposableMapping-172"><a href="#ComposableMapping-172"><span class="linenos">172</span></a>
</span><span id="ComposableMapping-173"><a href="#ComposableMapping-173"><span class="linenos">173</span></a><span class="sd">        Args:</span>
</span><span id="ComposableMapping-174"><a href="#ComposableMapping-174"><span class="linenos">174</span></a><span class="sd">            coordinates: Coordinates to evaluate the mapping at with shape</span>
</span><span id="ComposableMapping-175"><a href="#ComposableMapping-175"><span class="linenos">175</span></a><span class="sd">                ([*batch_shape ,]n_dims[, *spatial_shape]).</span>
</span><span id="ComposableMapping-176"><a href="#ComposableMapping-176"><span class="linenos">176</span></a>
</span><span id="ComposableMapping-177"><a href="#ComposableMapping-177"><span class="linenos">177</span></a><span class="sd">        Returns:</span>
</span><span id="ComposableMapping-178"><a href="#ComposableMapping-178"><span class="linenos">178</span></a><span class="sd">            Mapping evaluated at the coordinates.</span>
</span><span id="ComposableMapping-179"><a href="#ComposableMapping-179"><span class="linenos">179</span></a>
</span><span id="ComposableMapping-180"><a href="#ComposableMapping-180"><span class="linenos">180</span></a><span class="sd">        @public</span>
</span><span id="ComposableMapping-181"><a href="#ComposableMapping-181"><span class="linenos">181</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ComposableMapping-182"><a href="#ComposableMapping-182"><span class="linenos">182</span></a>
</span><span id="ComposableMapping-183"><a href="#ComposableMapping-183"><span class="linenos">183</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ComposableMapping-184"><a href="#ComposableMapping-184"><span class="linenos">184</span></a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ComposableMapping&quot;</span><span class="p">:</span>
</span><span id="ComposableMapping-185"><a href="#ComposableMapping-185"><span class="linenos">185</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Invert the mapping.</span>
</span><span id="ComposableMapping-186"><a href="#ComposableMapping-186"><span class="linenos">186</span></a>
</span><span id="ComposableMapping-187"><a href="#ComposableMapping-187"><span class="linenos">187</span></a><span class="sd">        Args:</span>
</span><span id="ComposableMapping-188"><a href="#ComposableMapping-188"><span class="linenos">188</span></a><span class="sd">            arguments: Arguments for the inversion.</span>
</span><span id="ComposableMapping-189"><a href="#ComposableMapping-189"><span class="linenos">189</span></a>
</span><span id="ComposableMapping-190"><a href="#ComposableMapping-190"><span class="linenos">190</span></a><span class="sd">        Returns:</span>
</span><span id="ComposableMapping-191"><a href="#ComposableMapping-191"><span class="linenos">191</span></a><span class="sd">            The inverted mapping.</span>
</span><span id="ComposableMapping-192"><a href="#ComposableMapping-192"><span class="linenos">192</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ComposableMapping-193"><a href="#ComposableMapping-193"><span class="linenos">193</span></a>
</span><span id="ComposableMapping-194"><a href="#ComposableMapping-194"><span class="linenos">194</span></a>    <span class="k">def</span> <span class="nf">sample_to</span><span class="p">(</span>
</span><span id="ComposableMapping-195"><a href="#ComposableMapping-195"><span class="linenos">195</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ComposableMapping-196"><a href="#ComposableMapping-196"><span class="linenos">196</span></a>        <span class="n">target</span><span class="p">:</span> <span class="n">ICoordinateSystemContainer</span><span class="p">,</span>
</span><span id="ComposableMapping-197"><a href="#ComposableMapping-197"><span class="linenos">197</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFormat</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ComposableMapping-198"><a href="#ComposableMapping-198"><span class="linenos">198</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="ComposableMapping-199"><a href="#ComposableMapping-199"><span class="linenos">199</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate the mapping at the coordinates defined by the target.</span>
</span><span id="ComposableMapping-200"><a href="#ComposableMapping-200"><span class="linenos">200</span></a>
</span><span id="ComposableMapping-201"><a href="#ComposableMapping-201"><span class="linenos">201</span></a><span class="sd">        Args:</span>
</span><span id="ComposableMapping-202"><a href="#ComposableMapping-202"><span class="linenos">202</span></a><span class="sd">            target: Target coordinate system (or a container with a coordinate system)</span>
</span><span id="ComposableMapping-203"><a href="#ComposableMapping-203"><span class="linenos">203</span></a><span class="sd">                defining a grid to evaluate the mapping at.</span>
</span><span id="ComposableMapping-204"><a href="#ComposableMapping-204"><span class="linenos">204</span></a><span class="sd">            data_format: Data format of the output. Default data format depends</span>
</span><span id="ComposableMapping-205"><a href="#ComposableMapping-205"><span class="linenos">205</span></a><span class="sd">                on the mapping, but as a general rule is the same as the data</span>
</span><span id="ComposableMapping-206"><a href="#ComposableMapping-206"><span class="linenos">206</span></a><span class="sd">                format of the mapping being sampled, or the default data format</span>
</span><span id="ComposableMapping-207"><a href="#ComposableMapping-207"><span class="linenos">207</span></a><span class="sd">                of the left mapping in a composition or other operation. When no</span>
</span><span id="ComposableMapping-208"><a href="#ComposableMapping-208"><span class="linenos">208</span></a><span class="sd">                clear default data format is available,</span>
</span><span id="ComposableMapping-209"><a href="#ComposableMapping-209"><span class="linenos">209</span></a><span class="sd">                DataFormat.world_coordinates() is used. Default data format can</span>
</span><span id="ComposableMapping-210"><a href="#ComposableMapping-210"><span class="linenos">210</span></a><span class="sd">                be set for a mapping using `set_default_sampling_data_format`.</span>
</span><span id="ComposableMapping-211"><a href="#ComposableMapping-211"><span class="linenos">211</span></a>
</span><span id="ComposableMapping-212"><a href="#ComposableMapping-212"><span class="linenos">212</span></a><span class="sd">        Returns:</span>
</span><span id="ComposableMapping-213"><a href="#ComposableMapping-213"><span class="linenos">213</span></a><span class="sd">            Mappable tensor containing the values obtained by evaluating the</span>
</span><span id="ComposableMapping-214"><a href="#ComposableMapping-214"><span class="linenos">214</span></a><span class="sd">            mapping at the coordinates defined by the target.</span>
</span><span id="ComposableMapping-215"><a href="#ComposableMapping-215"><span class="linenos">215</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ComposableMapping-216"><a href="#ComposableMapping-216"><span class="linenos">216</span></a>        <span class="n">data_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sampling_data_format</span><span class="p">(</span><span class="n">data_format</span><span class="p">)</span>
</span><span id="ComposableMapping-217"><a href="#ComposableMapping-217"><span class="linenos">217</span></a>        <span class="n">sampled</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">grid</span><span class="p">())</span>
</span><span id="ComposableMapping-218"><a href="#ComposableMapping-218"><span class="linenos">218</span></a>        <span class="k">if</span> <span class="n">data_format</span><span class="o">.</span><span class="n">coordinate_type</span> <span class="o">==</span> <span class="s2">&quot;voxel&quot;</span><span class="p">:</span>
</span><span id="ComposableMapping-219"><a href="#ComposableMapping-219"><span class="linenos">219</span></a>            <span class="n">sampled</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">to_voxel_coordinates</span><span class="p">(</span><span class="n">sampled</span><span class="p">)</span>
</span><span id="ComposableMapping-220"><a href="#ComposableMapping-220"><span class="linenos">220</span></a>        <span class="k">if</span> <span class="n">data_format</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;displacements&quot;</span><span class="p">:</span>
</span><span id="ComposableMapping-221"><a href="#ComposableMapping-221"><span class="linenos">221</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ComposableMapping-222"><a href="#ComposableMapping-222"><span class="linenos">222</span></a>                <span class="n">target</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">voxel_grid</span><span class="p">()</span>
</span><span id="ComposableMapping-223"><a href="#ComposableMapping-223"><span class="linenos">223</span></a>                <span class="k">if</span> <span class="n">data_format</span><span class="o">.</span><span class="n">coordinate_type</span> <span class="o">==</span> <span class="s2">&quot;voxel&quot;</span>
</span><span id="ComposableMapping-224"><a href="#ComposableMapping-224"><span class="linenos">224</span></a>                <span class="k">else</span> <span class="n">target</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</span><span id="ComposableMapping-225"><a href="#ComposableMapping-225"><span class="linenos">225</span></a>            <span class="p">)</span>
</span><span id="ComposableMapping-226"><a href="#ComposableMapping-226"><span class="linenos">226</span></a>            <span class="n">sampled</span> <span class="o">=</span> <span class="n">sampled</span> <span class="o">-</span> <span class="n">grid</span>
</span><span id="ComposableMapping-227"><a href="#ComposableMapping-227"><span class="linenos">227</span></a>        <span class="k">return</span> <span class="n">sampled</span>
</span><span id="ComposableMapping-228"><a href="#ComposableMapping-228"><span class="linenos">228</span></a>
</span><span id="ComposableMapping-229"><a href="#ComposableMapping-229"><span class="linenos">229</span></a>    <span class="k">def</span> <span class="nf">resample_to</span><span class="p">(</span>
</span><span id="ComposableMapping-230"><a href="#ComposableMapping-230"><span class="linenos">230</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ComposableMapping-231"><a href="#ComposableMapping-231"><span class="linenos">231</span></a>        <span class="n">target</span><span class="p">:</span> <span class="n">ICoordinateSystemContainer</span><span class="p">,</span>
</span><span id="ComposableMapping-232"><a href="#ComposableMapping-232"><span class="linenos">232</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFormat</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ComposableMapping-233"><a href="#ComposableMapping-233"><span class="linenos">233</span></a>        <span class="n">sampler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ISampler&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ComposableMapping-234"><a href="#ComposableMapping-234"><span class="linenos">234</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SamplableVolume&quot;</span><span class="p">:</span>
</span><span id="ComposableMapping-235"><a href="#ComposableMapping-235"><span class="linenos">235</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Resample the mapping at the coordinates defined by the target.</span>
</span><span id="ComposableMapping-236"><a href="#ComposableMapping-236"><span class="linenos">236</span></a>
</span><span id="ComposableMapping-237"><a href="#ComposableMapping-237"><span class="linenos">237</span></a><span class="sd">        Args:</span>
</span><span id="ComposableMapping-238"><a href="#ComposableMapping-238"><span class="linenos">238</span></a><span class="sd">            target: Target coordinate system (or a container with a coordinate system)</span>
</span><span id="ComposableMapping-239"><a href="#ComposableMapping-239"><span class="linenos">239</span></a><span class="sd">                defining a grid to resample the mapping at.</span>
</span><span id="ComposableMapping-240"><a href="#ComposableMapping-240"><span class="linenos">240</span></a><span class="sd">            data_format: Data format used as an internal representation of the</span>
</span><span id="ComposableMapping-241"><a href="#ComposableMapping-241"><span class="linenos">241</span></a><span class="sd">                generated resampled mapping. Default data format depends on the</span>
</span><span id="ComposableMapping-242"><a href="#ComposableMapping-242"><span class="linenos">242</span></a><span class="sd">                mapping, but as a general rule is the same as the data format of</span>
</span><span id="ComposableMapping-243"><a href="#ComposableMapping-243"><span class="linenos">243</span></a><span class="sd">                the mapping being sampled, or the default data format of the</span>
</span><span id="ComposableMapping-244"><a href="#ComposableMapping-244"><span class="linenos">244</span></a><span class="sd">                left mapping in a composition or other operation. When no clear</span>
</span><span id="ComposableMapping-245"><a href="#ComposableMapping-245"><span class="linenos">245</span></a><span class="sd">                default data format is available, DataFormat.world_coordinates()</span>
</span><span id="ComposableMapping-246"><a href="#ComposableMapping-246"><span class="linenos">246</span></a><span class="sd">                is used. Default data format can be set for a mapping using</span>
</span><span id="ComposableMapping-247"><a href="#ComposableMapping-247"><span class="linenos">247</span></a><span class="sd">                `set_default_sampling_data_format`.</span>
</span><span id="ComposableMapping-248"><a href="#ComposableMapping-248"><span class="linenos">248</span></a><span class="sd">            sampler: Sampler used by the generated resampled mapping. Note that</span>
</span><span id="ComposableMapping-249"><a href="#ComposableMapping-249"><span class="linenos">249</span></a><span class="sd">                this sampler is not used to resample the mapping, but to sample</span>
</span><span id="ComposableMapping-250"><a href="#ComposableMapping-250"><span class="linenos">250</span></a><span class="sd">                the generated resampled mapping. If None, the default sampler</span>
</span><span id="ComposableMapping-251"><a href="#ComposableMapping-251"><span class="linenos">251</span></a><span class="sd">                is used (see `default_sampler`).</span>
</span><span id="ComposableMapping-252"><a href="#ComposableMapping-252"><span class="linenos">252</span></a>
</span><span id="ComposableMapping-253"><a href="#ComposableMapping-253"><span class="linenos">253</span></a><span class="sd">        Returns:</span>
</span><span id="ComposableMapping-254"><a href="#ComposableMapping-254"><span class="linenos">254</span></a><span class="sd">            Resampled mapping.</span>
</span><span id="ComposableMapping-255"><a href="#ComposableMapping-255"><span class="linenos">255</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ComposableMapping-256"><a href="#ComposableMapping-256"><span class="linenos">256</span></a>        <span class="n">data_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sampling_data_format</span><span class="p">(</span><span class="n">data_format</span><span class="p">)</span>
</span><span id="ComposableMapping-257"><a href="#ComposableMapping-257"><span class="linenos">257</span></a>        <span class="k">return</span> <span class="n">SamplableVolume</span><span class="p">(</span>
</span><span id="ComposableMapping-258"><a href="#ComposableMapping-258"><span class="linenos">258</span></a>            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_to</span><span class="p">(</span>
</span><span id="ComposableMapping-259"><a href="#ComposableMapping-259"><span class="linenos">259</span></a>                <span class="n">target</span><span class="p">,</span>
</span><span id="ComposableMapping-260"><a href="#ComposableMapping-260"><span class="linenos">260</span></a>                <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">,</span>
</span><span id="ComposableMapping-261"><a href="#ComposableMapping-261"><span class="linenos">261</span></a>            <span class="p">),</span>
</span><span id="ComposableMapping-262"><a href="#ComposableMapping-262"><span class="linenos">262</span></a>            <span class="n">coordinate_system</span><span class="o">=</span><span class="n">target</span><span class="o">.</span><span class="n">coordinate_system</span><span class="p">,</span>
</span><span id="ComposableMapping-263"><a href="#ComposableMapping-263"><span class="linenos">263</span></a>            <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">,</span>
</span><span id="ComposableMapping-264"><a href="#ComposableMapping-264"><span class="linenos">264</span></a>            <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span>
</span><span id="ComposableMapping-265"><a href="#ComposableMapping-265"><span class="linenos">265</span></a>        <span class="p">)</span>
</span><span id="ComposableMapping-266"><a href="#ComposableMapping-266"><span class="linenos">266</span></a>
</span><span id="ComposableMapping-267"><a href="#ComposableMapping-267"><span class="linenos">267</span></a>    <span class="k">def</span> <span class="nf">assign_coordinates</span><span class="p">(</span>
</span><span id="ComposableMapping-268"><a href="#ComposableMapping-268"><span class="linenos">268</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="s2">&quot;ICoordinateSystemContainer&quot;</span>
</span><span id="ComposableMapping-269"><a href="#ComposableMapping-269"><span class="linenos">269</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GridComposableMapping&quot;</span><span class="p">:</span>
</span><span id="ComposableMapping-270"><a href="#ComposableMapping-270"><span class="linenos">270</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign a coordinate system for the mapping.</span>
</span><span id="ComposableMapping-271"><a href="#ComposableMapping-271"><span class="linenos">271</span></a>
</span><span id="ComposableMapping-272"><a href="#ComposableMapping-272"><span class="linenos">272</span></a><span class="sd">        This only changes the coordinate system of the mapping, the mapping itself</span>
</span><span id="ComposableMapping-273"><a href="#ComposableMapping-273"><span class="linenos">273</span></a><span class="sd">        is not changed. The coordinate system contained by the mapping affects</span>
</span><span id="ComposableMapping-274"><a href="#ComposableMapping-274"><span class="linenos">274</span></a><span class="sd">        behaviour of some methods such as `GridComposableMapping.sample` and</span>
</span><span id="ComposableMapping-275"><a href="#ComposableMapping-275"><span class="linenos">275</span></a><span class="sd">        `GridComposableMapping.resample`.</span>
</span><span id="ComposableMapping-276"><a href="#ComposableMapping-276"><span class="linenos">276</span></a>
</span><span id="ComposableMapping-277"><a href="#ComposableMapping-277"><span class="linenos">277</span></a><span class="sd">        Args:</span>
</span><span id="ComposableMapping-278"><a href="#ComposableMapping-278"><span class="linenos">278</span></a><span class="sd">            coordinates: Coordinate system (or a container with a coordinate system)</span>
</span><span id="ComposableMapping-279"><a href="#ComposableMapping-279"><span class="linenos">279</span></a><span class="sd">                to assign for the mapping.</span>
</span><span id="ComposableMapping-280"><a href="#ComposableMapping-280"><span class="linenos">280</span></a>
</span><span id="ComposableMapping-281"><a href="#ComposableMapping-281"><span class="linenos">281</span></a><span class="sd">        Returns:</span>
</span><span id="ComposableMapping-282"><a href="#ComposableMapping-282"><span class="linenos">282</span></a><span class="sd">            Mapping with the given target coordinate system.</span>
</span><span id="ComposableMapping-283"><a href="#ComposableMapping-283"><span class="linenos">283</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ComposableMapping-284"><a href="#ComposableMapping-284"><span class="linenos">284</span></a>        <span class="k">return</span> <span class="n">_AssignCoordinatesDecorator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">coordinate_system</span><span class="p">)</span>
</span><span id="ComposableMapping-285"><a href="#ComposableMapping-285"><span class="linenos">285</span></a>
</span><span id="ComposableMapping-286"><a href="#ComposableMapping-286"><span class="linenos">286</span></a>    <span class="k">def</span> <span class="nf">as_affine_transformation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IAffineTransformation</span><span class="p">:</span>
</span><span id="ComposableMapping-287"><a href="#ComposableMapping-287"><span class="linenos">287</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain the mapping as an affine transformation on PyTorch tensors, if possible.</span>
</span><span id="ComposableMapping-288"><a href="#ComposableMapping-288"><span class="linenos">288</span></a>
</span><span id="ComposableMapping-289"><a href="#ComposableMapping-289"><span class="linenos">289</span></a><span class="sd">        Returns:</span>
</span><span id="ComposableMapping-290"><a href="#ComposableMapping-290"><span class="linenos">290</span></a><span class="sd">            Affine transformation on PyTorch tensors.</span>
</span><span id="ComposableMapping-291"><a href="#ComposableMapping-291"><span class="linenos">291</span></a>
</span><span id="ComposableMapping-292"><a href="#ComposableMapping-292"><span class="linenos">292</span></a><span class="sd">        Raises:</span>
</span><span id="ComposableMapping-293"><a href="#ComposableMapping-293"><span class="linenos">293</span></a><span class="sd">            NotAffineTransformationError: If the mapping is not an affine transformation on</span>
</span><span id="ComposableMapping-294"><a href="#ComposableMapping-294"><span class="linenos">294</span></a><span class="sd">                PyTorch tensors.</span>
</span><span id="ComposableMapping-295"><a href="#ComposableMapping-295"><span class="linenos">295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ComposableMapping-296"><a href="#ComposableMapping-296"><span class="linenos">296</span></a>        <span class="n">tracer</span> <span class="o">=</span> <span class="n">_AffineTracer</span><span class="p">()</span>
</span><span id="ComposableMapping-297"><a href="#ComposableMapping-297"><span class="linenos">297</span></a>        <span class="n">traced</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">tracer</span><span class="p">)</span>
</span><span id="ComposableMapping-298"><a href="#ComposableMapping-298"><span class="linenos">298</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">traced</span><span class="p">,</span> <span class="n">_AffineTracer</span><span class="p">):</span>
</span><span id="ComposableMapping-299"><a href="#ComposableMapping-299"><span class="linenos">299</span></a>            <span class="k">if</span> <span class="n">traced</span><span class="o">.</span><span class="n">traced_affine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ComposableMapping-300"><a href="#ComposableMapping-300"><span class="linenos">300</span></a>                <span class="k">raise</span> <span class="n">NotAffineTransformationError</span><span class="p">(</span><span class="s2">&quot;Could not infer affine transformation&quot;</span><span class="p">)</span>
</span><span id="ComposableMapping-301"><a href="#ComposableMapping-301"><span class="linenos">301</span></a>            <span class="k">return</span> <span class="n">traced</span><span class="o">.</span><span class="n">traced_affine</span>
</span><span id="ComposableMapping-302"><a href="#ComposableMapping-302"><span class="linenos">302</span></a>        <span class="k">raise</span> <span class="n">NotAffineTransformationError</span><span class="p">(</span><span class="s2">&quot;Could not infer affine transformation&quot;</span><span class="p">)</span>
</span><span id="ComposableMapping-303"><a href="#ComposableMapping-303"><span class="linenos">303</span></a>
</span><span id="ComposableMapping-304"><a href="#ComposableMapping-304"><span class="linenos">304</span></a>    <span class="k">def</span> <span class="nf">as_affine_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="ComposableMapping-305"><a href="#ComposableMapping-305"><span class="linenos">305</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain the mapping as an affine matrix, if possible.</span>
</span><span id="ComposableMapping-306"><a href="#ComposableMapping-306"><span class="linenos">306</span></a>
</span><span id="ComposableMapping-307"><a href="#ComposableMapping-307"><span class="linenos">307</span></a><span class="sd">        Returns:</span>
</span><span id="ComposableMapping-308"><a href="#ComposableMapping-308"><span class="linenos">308</span></a><span class="sd">            Affine matrix with</span>
</span><span id="ComposableMapping-309"><a href="#ComposableMapping-309"><span class="linenos">309</span></a><span class="sd">            shape ([*batch_shape, ]n_output_dims + 1, n_input_dims + 1[, *spatial_shape]).</span>
</span><span id="ComposableMapping-310"><a href="#ComposableMapping-310"><span class="linenos">310</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ComposableMapping-311"><a href="#ComposableMapping-311"><span class="linenos">311</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_affine_transformation</span><span class="p">()</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
</span><span id="ComposableMapping-312"><a href="#ComposableMapping-312"><span class="linenos">312</span></a>
</span><span id="ComposableMapping-313"><a href="#ComposableMapping-313"><span class="linenos">313</span></a>    <span class="nd">@property</span>
</span><span id="ComposableMapping-314"><a href="#ComposableMapping-314"><span class="linenos">314</span></a>    <span class="k">def</span> <span class="nf">default_sampling_data_format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFormat</span><span class="p">]:</span>
</span><span id="ComposableMapping-315"><a href="#ComposableMapping-315"><span class="linenos">315</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Default data format to use in sampling and resampling operations for</span>
</span><span id="ComposableMapping-316"><a href="#ComposableMapping-316"><span class="linenos">316</span></a><span class="sd">        the mapping.</span>
</span><span id="ComposableMapping-317"><a href="#ComposableMapping-317"><span class="linenos">317</span></a>
</span><span id="ComposableMapping-318"><a href="#ComposableMapping-318"><span class="linenos">318</span></a><span class="sd">        If None, DataFormat.world_coordinates() will be used but the behaviour</span>
</span><span id="ComposableMapping-319"><a href="#ComposableMapping-319"><span class="linenos">319</span></a><span class="sd">        in operations with other mappings is different as the default data format</span>
</span><span id="ComposableMapping-320"><a href="#ComposableMapping-320"><span class="linenos">320</span></a><span class="sd">        of the other mapping will be used.</span>
</span><span id="ComposableMapping-321"><a href="#ComposableMapping-321"><span class="linenos">321</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ComposableMapping-322"><a href="#ComposableMapping-322"><span class="linenos">322</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="ComposableMapping-323"><a href="#ComposableMapping-323"><span class="linenos">323</span></a>
</span><span id="ComposableMapping-324"><a href="#ComposableMapping-324"><span class="linenos">324</span></a>    <span class="n">set_default_sampling_data_format</span> <span class="o">=</span> <span class="n">_set_default_sampling_data_format</span>
</span><span id="ComposableMapping-325"><a href="#ComposableMapping-325"><span class="linenos">325</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the default data format to use in sampling and resampling operations for</span>
</span><span id="ComposableMapping-326"><a href="#ComposableMapping-326"><span class="linenos">326</span></a><span class="sd">    the mapping.</span>
</span><span id="ComposableMapping-327"><a href="#ComposableMapping-327"><span class="linenos">327</span></a><span class="sd">    </span>
</span><span id="ComposableMapping-328"><a href="#ComposableMapping-328"><span class="linenos">328</span></a><span class="sd">    Args:</span>
</span><span id="ComposableMapping-329"><a href="#ComposableMapping-329"><span class="linenos">329</span></a><span class="sd">        data_format: Default data format to use in sampling and resampling operations.</span>
</span><span id="ComposableMapping-330"><a href="#ComposableMapping-330"><span class="linenos">330</span></a><span class="sd">    </span>
</span><span id="ComposableMapping-331"><a href="#ComposableMapping-331"><span class="linenos">331</span></a><span class="sd">    Returns:</span>
</span><span id="ComposableMapping-332"><a href="#ComposableMapping-332"><span class="linenos">332</span></a><span class="sd">        Mapping with the default data format set.</span>
</span><span id="ComposableMapping-333"><a href="#ComposableMapping-333"><span class="linenos">333</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ComposableMapping-334"><a href="#ComposableMapping-334"><span class="linenos">334</span></a>
</span><span id="ComposableMapping-335"><a href="#ComposableMapping-335"><span class="linenos">335</span></a>    <span class="k">def</span> <span class="nf">_get_sampling_data_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFormat</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">DataFormat</span><span class="p">:</span>
</span><span id="ComposableMapping-336"><a href="#ComposableMapping-336"><span class="linenos">336</span></a>        <span class="k">if</span> <span class="n">data_format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ComposableMapping-337"><a href="#ComposableMapping-337"><span class="linenos">337</span></a>            <span class="k">return</span> <span class="n">data_format</span>
</span><span id="ComposableMapping-338"><a href="#ComposableMapping-338"><span class="linenos">338</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_sampling_data_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ComposableMapping-339"><a href="#ComposableMapping-339"><span class="linenos">339</span></a>            <span class="k">return</span> <span class="n">DataFormat</span><span class="o">.</span><span class="n">world_coordinates</span><span class="p">()</span>
</span><span id="ComposableMapping-340"><a href="#ComposableMapping-340"><span class="linenos">340</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_sampling_data_format</span>
</span><span id="ComposableMapping-341"><a href="#ComposableMapping-341"><span class="linenos">341</span></a>
</span><span id="ComposableMapping-342"><a href="#ComposableMapping-342"><span class="linenos">342</span></a>    <span class="fm">__matmul__</span> <span class="o">=</span> <span class="n">_composition</span>
</span><span id="ComposableMapping-343"><a href="#ComposableMapping-343"><span class="linenos">343</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Compose with another mapping.</span>
</span><span id="ComposableMapping-344"><a href="#ComposableMapping-344"><span class="linenos">344</span></a><span class="sd">    </span>
</span><span id="ComposableMapping-345"><a href="#ComposableMapping-345"><span class="linenos">345</span></a><span class="sd">    Args:</span>
</span><span id="ComposableMapping-346"><a href="#ComposableMapping-346"><span class="linenos">346</span></a><span class="sd">        right_mapping: Mapping to compose with.</span>
</span><span id="ComposableMapping-347"><a href="#ComposableMapping-347"><span class="linenos">347</span></a><span class="sd">    </span>
</span><span id="ComposableMapping-348"><a href="#ComposableMapping-348"><span class="linenos">348</span></a><span class="sd">    Returns:</span>
</span><span id="ComposableMapping-349"><a href="#ComposableMapping-349"><span class="linenos">349</span></a><span class="sd">        Composed mapping.</span>
</span><span id="ComposableMapping-350"><a href="#ComposableMapping-350"><span class="linenos">350</span></a><span class="sd">    @public</span>
</span><span id="ComposableMapping-351"><a href="#ComposableMapping-351"><span class="linenos">351</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ComposableMapping-352"><a href="#ComposableMapping-352"><span class="linenos">352</span></a>    <span class="fm">__add__</span> <span class="o">=</span> <span class="n">_generate_bivariate_arithmetic_operator</span><span class="p">(</span>
</span><span id="ComposableMapping-353"><a href="#ComposableMapping-353"><span class="linenos">353</span></a>        <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="n">_bivariate_arithmetic_operator_template</span>
</span><span id="ComposableMapping-354"><a href="#ComposableMapping-354"><span class="linenos">354</span></a>    <span class="p">)</span>
</span><span id="ComposableMapping-355"><a href="#ComposableMapping-355"><span class="linenos">355</span></a>    <span class="fm">__radd__</span> <span class="o">=</span> <span class="fm">__add__</span>
</span><span id="ComposableMapping-356"><a href="#ComposableMapping-356"><span class="linenos">356</span></a>    <span class="fm">__sub__</span> <span class="o">=</span> <span class="n">_generate_bivariate_arithmetic_operator</span><span class="p">(</span>
</span><span id="ComposableMapping-357"><a href="#ComposableMapping-357"><span class="linenos">357</span></a>        <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="n">_bivariate_arithmetic_operator_template</span>
</span><span id="ComposableMapping-358"><a href="#ComposableMapping-358"><span class="linenos">358</span></a>    <span class="p">)</span>
</span><span id="ComposableMapping-359"><a href="#ComposableMapping-359"><span class="linenos">359</span></a>    <span class="fm">__rsub__</span> <span class="o">=</span> <span class="n">_generate_bivariate_arithmetic_operator</span><span class="p">(</span>
</span><span id="ComposableMapping-360"><a href="#ComposableMapping-360"><span class="linenos">360</span></a>        <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">_bivariate_arithmetic_operator_template</span>
</span><span id="ComposableMapping-361"><a href="#ComposableMapping-361"><span class="linenos">361</span></a>    <span class="p">)</span>
</span><span id="ComposableMapping-362"><a href="#ComposableMapping-362"><span class="linenos">362</span></a>    <span class="fm">__mul__</span> <span class="o">=</span> <span class="n">_generate_bivariate_arithmetic_operator</span><span class="p">(</span>
</span><span id="ComposableMapping-363"><a href="#ComposableMapping-363"><span class="linenos">363</span></a>        <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="p">,</span> <span class="n">_bivariate_arithmetic_operator_template</span>
</span><span id="ComposableMapping-364"><a href="#ComposableMapping-364"><span class="linenos">364</span></a>    <span class="p">)</span>
</span><span id="ComposableMapping-365"><a href="#ComposableMapping-365"><span class="linenos">365</span></a>    <span class="fm">__rmul__</span> <span class="o">=</span> <span class="fm">__mul__</span>
</span><span id="ComposableMapping-366"><a href="#ComposableMapping-366"><span class="linenos">366</span></a>    <span class="fm">__truediv__</span> <span class="o">=</span> <span class="n">_generate_bivariate_arithmetic_operator</span><span class="p">(</span>
</span><span id="ComposableMapping-367"><a href="#ComposableMapping-367"><span class="linenos">367</span></a>        <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">_bivariate_arithmetic_operator_template</span>
</span><span id="ComposableMapping-368"><a href="#ComposableMapping-368"><span class="linenos">368</span></a>    <span class="p">)</span>
</span><span id="ComposableMapping-369"><a href="#ComposableMapping-369"><span class="linenos">369</span></a>    <span class="fm">__rtruediv__</span> <span class="o">=</span> <span class="n">_generate_bivariate_arithmetic_operator</span><span class="p">(</span>
</span><span id="ComposableMapping-370"><a href="#ComposableMapping-370"><span class="linenos">370</span></a>        <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span> <span class="o">/</span> <span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span> <span class="o">/</span> <span class="n">x</span><span class="p">,</span> <span class="n">_bivariate_arithmetic_operator_template</span>
</span><span id="ComposableMapping-371"><a href="#ComposableMapping-371"><span class="linenos">371</span></a>    <span class="p">)</span>
</span><span id="ComposableMapping-372"><a href="#ComposableMapping-372"><span class="linenos">372</span></a>    <span class="fm">__pow__</span> <span class="o">=</span> <span class="n">_generate_bivariate_arithmetic_operator</span><span class="p">(</span>
</span><span id="ComposableMapping-373"><a href="#ComposableMapping-373"><span class="linenos">373</span></a>        <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">**</span><span class="n">y</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">y</span><span class="p">),</span> <span class="n">_bivariate_arithmetic_operator_template</span>
</span><span id="ComposableMapping-374"><a href="#ComposableMapping-374"><span class="linenos">374</span></a>    <span class="p">)</span>
</span><span id="ComposableMapping-375"><a href="#ComposableMapping-375"><span class="linenos">375</span></a>    <span class="fm">__neg__</span> <span class="o">=</span> <span class="n">_generate_univariate_arithmetic_operator</span><span class="p">(</span>
</span><span id="ComposableMapping-376"><a href="#ComposableMapping-376"><span class="linenos">376</span></a>        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="n">_univariate_arithmetic_operator_template</span>
</span><span id="ComposableMapping-377"><a href="#ComposableMapping-377"><span class="linenos">377</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Base class for mappings composable with each other, and acting on mappable
tensors.</p>

<p>In general a composable mapping is a callable object that takes coordinates
as input and returns the mapping evaluated at these coordinates. Composable
mappings are generally assumed to be independent over the batch and spatial
dimensions of an input.</p>

<p>As the name suggests, a composable mapping can be additionally composed with
other composable mappings with the <code><a href="#ComposableMapping.__matmul__">__matmul__</a></code> operator (@). Composing does
not apply resampling, an operation which can be executed separately using
<code><a href="#ComposableMapping.resample_to">resample_to</a></code> method (or <code><a href="#GridComposableMapping.resample">GridComposableMapping.resample</a></code> method for
composable mappings with an assigned coordinate system).</p>

<p>Basic arithmetic operations are also supported between two composable
mappings or between a composable mapping and a number or a tensor, both of
which return a new composable mapping.</p>
</div>


                            <div id="ComposableMapping.__call__" class="classattr">
                                        <input id="ComposableMapping.__call__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">__call__</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">coordinates</span><span class="p">:</span> <span class="n"><a href="#MappableTensor">MappableTensor</a></span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="ComposableMapping.__call__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ComposableMapping.__call__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ComposableMapping.__call__-169"><a href="#ComposableMapping.__call__-169"><span class="linenos">169</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ComposableMapping.__call__-170"><a href="#ComposableMapping.__call__-170"><span class="linenos">170</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="ComposableMapping.__call__-171"><a href="#ComposableMapping.__call__-171"><span class="linenos">171</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate the mapping at coordinates.</span>
</span><span id="ComposableMapping.__call__-172"><a href="#ComposableMapping.__call__-172"><span class="linenos">172</span></a>
</span><span id="ComposableMapping.__call__-173"><a href="#ComposableMapping.__call__-173"><span class="linenos">173</span></a><span class="sd">        Args:</span>
</span><span id="ComposableMapping.__call__-174"><a href="#ComposableMapping.__call__-174"><span class="linenos">174</span></a><span class="sd">            coordinates: Coordinates to evaluate the mapping at with shape</span>
</span><span id="ComposableMapping.__call__-175"><a href="#ComposableMapping.__call__-175"><span class="linenos">175</span></a><span class="sd">                ([*batch_shape ,]n_dims[, *spatial_shape]).</span>
</span><span id="ComposableMapping.__call__-176"><a href="#ComposableMapping.__call__-176"><span class="linenos">176</span></a>
</span><span id="ComposableMapping.__call__-177"><a href="#ComposableMapping.__call__-177"><span class="linenos">177</span></a><span class="sd">        Returns:</span>
</span><span id="ComposableMapping.__call__-178"><a href="#ComposableMapping.__call__-178"><span class="linenos">178</span></a><span class="sd">            Mapping evaluated at the coordinates.</span>
</span><span id="ComposableMapping.__call__-179"><a href="#ComposableMapping.__call__-179"><span class="linenos">179</span></a>
</span><span id="ComposableMapping.__call__-180"><a href="#ComposableMapping.__call__-180"><span class="linenos">180</span></a><span class="sd">        @public</span>
</span><span id="ComposableMapping.__call__-181"><a href="#ComposableMapping.__call__-181"><span class="linenos">181</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Evaluate the mapping at coordinates.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>coordinates:</strong>  Coordinates to evaluate the mapping at with shape
([*batch_shape ,]n_dims[, *spatial_shape]).</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Mapping evaluated at the coordinates.</p>
</blockquote>
</div>


                            </div>
                            <div id="ComposableMapping.invert" class="classattr">
                                        <input id="ComposableMapping.invert-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">invert</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="o">**</span><span class="n">arguments</span></span><span class="return-annotation">) -> <span class="n"><a href="#ComposableMapping">ComposableMapping</a></span>:</span></span>

                <label class="view-source-button" for="ComposableMapping.invert-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ComposableMapping.invert"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ComposableMapping.invert-183"><a href="#ComposableMapping.invert-183"><span class="linenos">183</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ComposableMapping.invert-184"><a href="#ComposableMapping.invert-184"><span class="linenos">184</span></a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ComposableMapping&quot;</span><span class="p">:</span>
</span><span id="ComposableMapping.invert-185"><a href="#ComposableMapping.invert-185"><span class="linenos">185</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Invert the mapping.</span>
</span><span id="ComposableMapping.invert-186"><a href="#ComposableMapping.invert-186"><span class="linenos">186</span></a>
</span><span id="ComposableMapping.invert-187"><a href="#ComposableMapping.invert-187"><span class="linenos">187</span></a><span class="sd">        Args:</span>
</span><span id="ComposableMapping.invert-188"><a href="#ComposableMapping.invert-188"><span class="linenos">188</span></a><span class="sd">            arguments: Arguments for the inversion.</span>
</span><span id="ComposableMapping.invert-189"><a href="#ComposableMapping.invert-189"><span class="linenos">189</span></a>
</span><span id="ComposableMapping.invert-190"><a href="#ComposableMapping.invert-190"><span class="linenos">190</span></a><span class="sd">        Returns:</span>
</span><span id="ComposableMapping.invert-191"><a href="#ComposableMapping.invert-191"><span class="linenos">191</span></a><span class="sd">            The inverted mapping.</span>
</span><span id="ComposableMapping.invert-192"><a href="#ComposableMapping.invert-192"><span class="linenos">192</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Invert the mapping.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>arguments:</strong>  Arguments for the inversion.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>The inverted mapping.</p>
</blockquote>
</div>


                            </div>
                            <div id="ComposableMapping.sample_to" class="classattr">
                                        <input id="ComposableMapping.sample_to-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_to</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">target</span><span class="p">:</span> <span class="n">composable_mapping</span><span class="o">.</span><span class="n">composable_mapping</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">ICoordinateSystemContainer</span>,</span><span class="param">	<span class="n">data_format</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#DataFormat">DataFormat</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="ComposableMapping.sample_to-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ComposableMapping.sample_to"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ComposableMapping.sample_to-194"><a href="#ComposableMapping.sample_to-194"><span class="linenos">194</span></a>    <span class="k">def</span> <span class="nf">sample_to</span><span class="p">(</span>
</span><span id="ComposableMapping.sample_to-195"><a href="#ComposableMapping.sample_to-195"><span class="linenos">195</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ComposableMapping.sample_to-196"><a href="#ComposableMapping.sample_to-196"><span class="linenos">196</span></a>        <span class="n">target</span><span class="p">:</span> <span class="n">ICoordinateSystemContainer</span><span class="p">,</span>
</span><span id="ComposableMapping.sample_to-197"><a href="#ComposableMapping.sample_to-197"><span class="linenos">197</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFormat</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ComposableMapping.sample_to-198"><a href="#ComposableMapping.sample_to-198"><span class="linenos">198</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="ComposableMapping.sample_to-199"><a href="#ComposableMapping.sample_to-199"><span class="linenos">199</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate the mapping at the coordinates defined by the target.</span>
</span><span id="ComposableMapping.sample_to-200"><a href="#ComposableMapping.sample_to-200"><span class="linenos">200</span></a>
</span><span id="ComposableMapping.sample_to-201"><a href="#ComposableMapping.sample_to-201"><span class="linenos">201</span></a><span class="sd">        Args:</span>
</span><span id="ComposableMapping.sample_to-202"><a href="#ComposableMapping.sample_to-202"><span class="linenos">202</span></a><span class="sd">            target: Target coordinate system (or a container with a coordinate system)</span>
</span><span id="ComposableMapping.sample_to-203"><a href="#ComposableMapping.sample_to-203"><span class="linenos">203</span></a><span class="sd">                defining a grid to evaluate the mapping at.</span>
</span><span id="ComposableMapping.sample_to-204"><a href="#ComposableMapping.sample_to-204"><span class="linenos">204</span></a><span class="sd">            data_format: Data format of the output. Default data format depends</span>
</span><span id="ComposableMapping.sample_to-205"><a href="#ComposableMapping.sample_to-205"><span class="linenos">205</span></a><span class="sd">                on the mapping, but as a general rule is the same as the data</span>
</span><span id="ComposableMapping.sample_to-206"><a href="#ComposableMapping.sample_to-206"><span class="linenos">206</span></a><span class="sd">                format of the mapping being sampled, or the default data format</span>
</span><span id="ComposableMapping.sample_to-207"><a href="#ComposableMapping.sample_to-207"><span class="linenos">207</span></a><span class="sd">                of the left mapping in a composition or other operation. When no</span>
</span><span id="ComposableMapping.sample_to-208"><a href="#ComposableMapping.sample_to-208"><span class="linenos">208</span></a><span class="sd">                clear default data format is available,</span>
</span><span id="ComposableMapping.sample_to-209"><a href="#ComposableMapping.sample_to-209"><span class="linenos">209</span></a><span class="sd">                DataFormat.world_coordinates() is used. Default data format can</span>
</span><span id="ComposableMapping.sample_to-210"><a href="#ComposableMapping.sample_to-210"><span class="linenos">210</span></a><span class="sd">                be set for a mapping using `set_default_sampling_data_format`.</span>
</span><span id="ComposableMapping.sample_to-211"><a href="#ComposableMapping.sample_to-211"><span class="linenos">211</span></a>
</span><span id="ComposableMapping.sample_to-212"><a href="#ComposableMapping.sample_to-212"><span class="linenos">212</span></a><span class="sd">        Returns:</span>
</span><span id="ComposableMapping.sample_to-213"><a href="#ComposableMapping.sample_to-213"><span class="linenos">213</span></a><span class="sd">            Mappable tensor containing the values obtained by evaluating the</span>
</span><span id="ComposableMapping.sample_to-214"><a href="#ComposableMapping.sample_to-214"><span class="linenos">214</span></a><span class="sd">            mapping at the coordinates defined by the target.</span>
</span><span id="ComposableMapping.sample_to-215"><a href="#ComposableMapping.sample_to-215"><span class="linenos">215</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ComposableMapping.sample_to-216"><a href="#ComposableMapping.sample_to-216"><span class="linenos">216</span></a>        <span class="n">data_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sampling_data_format</span><span class="p">(</span><span class="n">data_format</span><span class="p">)</span>
</span><span id="ComposableMapping.sample_to-217"><a href="#ComposableMapping.sample_to-217"><span class="linenos">217</span></a>        <span class="n">sampled</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">grid</span><span class="p">())</span>
</span><span id="ComposableMapping.sample_to-218"><a href="#ComposableMapping.sample_to-218"><span class="linenos">218</span></a>        <span class="k">if</span> <span class="n">data_format</span><span class="o">.</span><span class="n">coordinate_type</span> <span class="o">==</span> <span class="s2">&quot;voxel&quot;</span><span class="p">:</span>
</span><span id="ComposableMapping.sample_to-219"><a href="#ComposableMapping.sample_to-219"><span class="linenos">219</span></a>            <span class="n">sampled</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">to_voxel_coordinates</span><span class="p">(</span><span class="n">sampled</span><span class="p">)</span>
</span><span id="ComposableMapping.sample_to-220"><a href="#ComposableMapping.sample_to-220"><span class="linenos">220</span></a>        <span class="k">if</span> <span class="n">data_format</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;displacements&quot;</span><span class="p">:</span>
</span><span id="ComposableMapping.sample_to-221"><a href="#ComposableMapping.sample_to-221"><span class="linenos">221</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ComposableMapping.sample_to-222"><a href="#ComposableMapping.sample_to-222"><span class="linenos">222</span></a>                <span class="n">target</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">voxel_grid</span><span class="p">()</span>
</span><span id="ComposableMapping.sample_to-223"><a href="#ComposableMapping.sample_to-223"><span class="linenos">223</span></a>                <span class="k">if</span> <span class="n">data_format</span><span class="o">.</span><span class="n">coordinate_type</span> <span class="o">==</span> <span class="s2">&quot;voxel&quot;</span>
</span><span id="ComposableMapping.sample_to-224"><a href="#ComposableMapping.sample_to-224"><span class="linenos">224</span></a>                <span class="k">else</span> <span class="n">target</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</span><span id="ComposableMapping.sample_to-225"><a href="#ComposableMapping.sample_to-225"><span class="linenos">225</span></a>            <span class="p">)</span>
</span><span id="ComposableMapping.sample_to-226"><a href="#ComposableMapping.sample_to-226"><span class="linenos">226</span></a>            <span class="n">sampled</span> <span class="o">=</span> <span class="n">sampled</span> <span class="o">-</span> <span class="n">grid</span>
</span><span id="ComposableMapping.sample_to-227"><a href="#ComposableMapping.sample_to-227"><span class="linenos">227</span></a>        <span class="k">return</span> <span class="n">sampled</span>
</span></pre></div>


            <div class="docstring"><p>Evaluate the mapping at the coordinates defined by the target.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>target:</strong>  Target coordinate system (or a container with a coordinate system)
defining a grid to evaluate the mapping at.</li>
<li><strong>data_format:</strong>  Data format of the output. Default data format depends
on the mapping, but as a general rule is the same as the data
format of the mapping being sampled, or the default data format
of the left mapping in a composition or other operation. When no
clear default data format is available,
<a href="#DataFormat.world_coordinates">DataFormat.world_coordinates()</a> is used. Default data format can
be set for a mapping using <code><a href="#ComposableMapping.set_default_sampling_data_format">set_default_sampling_data_format</a></code>.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Mappable tensor containing the values obtained by evaluating the
  mapping at the coordinates defined by the target.</p>
</blockquote>
</div>


                            </div>
                            <div id="ComposableMapping.resample_to" class="classattr">
                                        <input id="ComposableMapping.resample_to-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">resample_to</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">target</span><span class="p">:</span> <span class="n">composable_mapping</span><span class="o">.</span><span class="n">composable_mapping</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">ICoordinateSystemContainer</span>,</span><span class="param">	<span class="n">data_format</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#DataFormat">DataFormat</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">sampler</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#ISampler">ISampler</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#SamplableVolume">SamplableVolume</a></span>:</span></span>

                <label class="view-source-button" for="ComposableMapping.resample_to-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ComposableMapping.resample_to"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ComposableMapping.resample_to-229"><a href="#ComposableMapping.resample_to-229"><span class="linenos">229</span></a>    <span class="k">def</span> <span class="nf">resample_to</span><span class="p">(</span>
</span><span id="ComposableMapping.resample_to-230"><a href="#ComposableMapping.resample_to-230"><span class="linenos">230</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ComposableMapping.resample_to-231"><a href="#ComposableMapping.resample_to-231"><span class="linenos">231</span></a>        <span class="n">target</span><span class="p">:</span> <span class="n">ICoordinateSystemContainer</span><span class="p">,</span>
</span><span id="ComposableMapping.resample_to-232"><a href="#ComposableMapping.resample_to-232"><span class="linenos">232</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFormat</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ComposableMapping.resample_to-233"><a href="#ComposableMapping.resample_to-233"><span class="linenos">233</span></a>        <span class="n">sampler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;ISampler&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ComposableMapping.resample_to-234"><a href="#ComposableMapping.resample_to-234"><span class="linenos">234</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SamplableVolume&quot;</span><span class="p">:</span>
</span><span id="ComposableMapping.resample_to-235"><a href="#ComposableMapping.resample_to-235"><span class="linenos">235</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Resample the mapping at the coordinates defined by the target.</span>
</span><span id="ComposableMapping.resample_to-236"><a href="#ComposableMapping.resample_to-236"><span class="linenos">236</span></a>
</span><span id="ComposableMapping.resample_to-237"><a href="#ComposableMapping.resample_to-237"><span class="linenos">237</span></a><span class="sd">        Args:</span>
</span><span id="ComposableMapping.resample_to-238"><a href="#ComposableMapping.resample_to-238"><span class="linenos">238</span></a><span class="sd">            target: Target coordinate system (or a container with a coordinate system)</span>
</span><span id="ComposableMapping.resample_to-239"><a href="#ComposableMapping.resample_to-239"><span class="linenos">239</span></a><span class="sd">                defining a grid to resample the mapping at.</span>
</span><span id="ComposableMapping.resample_to-240"><a href="#ComposableMapping.resample_to-240"><span class="linenos">240</span></a><span class="sd">            data_format: Data format used as an internal representation of the</span>
</span><span id="ComposableMapping.resample_to-241"><a href="#ComposableMapping.resample_to-241"><span class="linenos">241</span></a><span class="sd">                generated resampled mapping. Default data format depends on the</span>
</span><span id="ComposableMapping.resample_to-242"><a href="#ComposableMapping.resample_to-242"><span class="linenos">242</span></a><span class="sd">                mapping, but as a general rule is the same as the data format of</span>
</span><span id="ComposableMapping.resample_to-243"><a href="#ComposableMapping.resample_to-243"><span class="linenos">243</span></a><span class="sd">                the mapping being sampled, or the default data format of the</span>
</span><span id="ComposableMapping.resample_to-244"><a href="#ComposableMapping.resample_to-244"><span class="linenos">244</span></a><span class="sd">                left mapping in a composition or other operation. When no clear</span>
</span><span id="ComposableMapping.resample_to-245"><a href="#ComposableMapping.resample_to-245"><span class="linenos">245</span></a><span class="sd">                default data format is available, DataFormat.world_coordinates()</span>
</span><span id="ComposableMapping.resample_to-246"><a href="#ComposableMapping.resample_to-246"><span class="linenos">246</span></a><span class="sd">                is used. Default data format can be set for a mapping using</span>
</span><span id="ComposableMapping.resample_to-247"><a href="#ComposableMapping.resample_to-247"><span class="linenos">247</span></a><span class="sd">                `set_default_sampling_data_format`.</span>
</span><span id="ComposableMapping.resample_to-248"><a href="#ComposableMapping.resample_to-248"><span class="linenos">248</span></a><span class="sd">            sampler: Sampler used by the generated resampled mapping. Note that</span>
</span><span id="ComposableMapping.resample_to-249"><a href="#ComposableMapping.resample_to-249"><span class="linenos">249</span></a><span class="sd">                this sampler is not used to resample the mapping, but to sample</span>
</span><span id="ComposableMapping.resample_to-250"><a href="#ComposableMapping.resample_to-250"><span class="linenos">250</span></a><span class="sd">                the generated resampled mapping. If None, the default sampler</span>
</span><span id="ComposableMapping.resample_to-251"><a href="#ComposableMapping.resample_to-251"><span class="linenos">251</span></a><span class="sd">                is used (see `default_sampler`).</span>
</span><span id="ComposableMapping.resample_to-252"><a href="#ComposableMapping.resample_to-252"><span class="linenos">252</span></a>
</span><span id="ComposableMapping.resample_to-253"><a href="#ComposableMapping.resample_to-253"><span class="linenos">253</span></a><span class="sd">        Returns:</span>
</span><span id="ComposableMapping.resample_to-254"><a href="#ComposableMapping.resample_to-254"><span class="linenos">254</span></a><span class="sd">            Resampled mapping.</span>
</span><span id="ComposableMapping.resample_to-255"><a href="#ComposableMapping.resample_to-255"><span class="linenos">255</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ComposableMapping.resample_to-256"><a href="#ComposableMapping.resample_to-256"><span class="linenos">256</span></a>        <span class="n">data_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sampling_data_format</span><span class="p">(</span><span class="n">data_format</span><span class="p">)</span>
</span><span id="ComposableMapping.resample_to-257"><a href="#ComposableMapping.resample_to-257"><span class="linenos">257</span></a>        <span class="k">return</span> <span class="n">SamplableVolume</span><span class="p">(</span>
</span><span id="ComposableMapping.resample_to-258"><a href="#ComposableMapping.resample_to-258"><span class="linenos">258</span></a>            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_to</span><span class="p">(</span>
</span><span id="ComposableMapping.resample_to-259"><a href="#ComposableMapping.resample_to-259"><span class="linenos">259</span></a>                <span class="n">target</span><span class="p">,</span>
</span><span id="ComposableMapping.resample_to-260"><a href="#ComposableMapping.resample_to-260"><span class="linenos">260</span></a>                <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">,</span>
</span><span id="ComposableMapping.resample_to-261"><a href="#ComposableMapping.resample_to-261"><span class="linenos">261</span></a>            <span class="p">),</span>
</span><span id="ComposableMapping.resample_to-262"><a href="#ComposableMapping.resample_to-262"><span class="linenos">262</span></a>            <span class="n">coordinate_system</span><span class="o">=</span><span class="n">target</span><span class="o">.</span><span class="n">coordinate_system</span><span class="p">,</span>
</span><span id="ComposableMapping.resample_to-263"><a href="#ComposableMapping.resample_to-263"><span class="linenos">263</span></a>            <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">,</span>
</span><span id="ComposableMapping.resample_to-264"><a href="#ComposableMapping.resample_to-264"><span class="linenos">264</span></a>            <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span>
</span><span id="ComposableMapping.resample_to-265"><a href="#ComposableMapping.resample_to-265"><span class="linenos">265</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Resample the mapping at the coordinates defined by the target.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>target:</strong>  Target coordinate system (or a container with a coordinate system)
defining a grid to resample the mapping at.</li>
<li><strong>data_format:</strong>  Data format used as an internal representation of the
generated resampled mapping. Default data format depends on the
mapping, but as a general rule is the same as the data format of
the mapping being sampled, or the default data format of the
left mapping in a composition or other operation. When no clear
default data format is available, <a href="#DataFormat.world_coordinates">DataFormat.world_coordinates()</a>
is used. Default data format can be set for a mapping using
<code><a href="#ComposableMapping.set_default_sampling_data_format">set_default_sampling_data_format</a></code>.</li>
<li><strong>sampler:</strong>  Sampler used by the generated resampled mapping. Note that
this sampler is not used to resample the mapping, but to sample
the generated resampled mapping. If None, the default sampler
is used (see <code><a href="#default_sampler">default_sampler</a></code>).</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Resampled mapping.</p>
</blockquote>
</div>


                            </div>
                            <div id="ComposableMapping.assign_coordinates" class="classattr">
                                        <input id="ComposableMapping.assign_coordinates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">assign_coordinates</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">coordinates</span><span class="p">:</span> <span class="n">composable_mapping</span><span class="o">.</span><span class="n">composable_mapping</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">ICoordinateSystemContainer</span></span><span class="return-annotation">) -> <span class="n"><a href="#GridComposableMapping">GridComposableMapping</a></span>:</span></span>

                <label class="view-source-button" for="ComposableMapping.assign_coordinates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ComposableMapping.assign_coordinates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ComposableMapping.assign_coordinates-267"><a href="#ComposableMapping.assign_coordinates-267"><span class="linenos">267</span></a>    <span class="k">def</span> <span class="nf">assign_coordinates</span><span class="p">(</span>
</span><span id="ComposableMapping.assign_coordinates-268"><a href="#ComposableMapping.assign_coordinates-268"><span class="linenos">268</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="s2">&quot;ICoordinateSystemContainer&quot;</span>
</span><span id="ComposableMapping.assign_coordinates-269"><a href="#ComposableMapping.assign_coordinates-269"><span class="linenos">269</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GridComposableMapping&quot;</span><span class="p">:</span>
</span><span id="ComposableMapping.assign_coordinates-270"><a href="#ComposableMapping.assign_coordinates-270"><span class="linenos">270</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign a coordinate system for the mapping.</span>
</span><span id="ComposableMapping.assign_coordinates-271"><a href="#ComposableMapping.assign_coordinates-271"><span class="linenos">271</span></a>
</span><span id="ComposableMapping.assign_coordinates-272"><a href="#ComposableMapping.assign_coordinates-272"><span class="linenos">272</span></a><span class="sd">        This only changes the coordinate system of the mapping, the mapping itself</span>
</span><span id="ComposableMapping.assign_coordinates-273"><a href="#ComposableMapping.assign_coordinates-273"><span class="linenos">273</span></a><span class="sd">        is not changed. The coordinate system contained by the mapping affects</span>
</span><span id="ComposableMapping.assign_coordinates-274"><a href="#ComposableMapping.assign_coordinates-274"><span class="linenos">274</span></a><span class="sd">        behaviour of some methods such as `GridComposableMapping.sample` and</span>
</span><span id="ComposableMapping.assign_coordinates-275"><a href="#ComposableMapping.assign_coordinates-275"><span class="linenos">275</span></a><span class="sd">        `GridComposableMapping.resample`.</span>
</span><span id="ComposableMapping.assign_coordinates-276"><a href="#ComposableMapping.assign_coordinates-276"><span class="linenos">276</span></a>
</span><span id="ComposableMapping.assign_coordinates-277"><a href="#ComposableMapping.assign_coordinates-277"><span class="linenos">277</span></a><span class="sd">        Args:</span>
</span><span id="ComposableMapping.assign_coordinates-278"><a href="#ComposableMapping.assign_coordinates-278"><span class="linenos">278</span></a><span class="sd">            coordinates: Coordinate system (or a container with a coordinate system)</span>
</span><span id="ComposableMapping.assign_coordinates-279"><a href="#ComposableMapping.assign_coordinates-279"><span class="linenos">279</span></a><span class="sd">                to assign for the mapping.</span>
</span><span id="ComposableMapping.assign_coordinates-280"><a href="#ComposableMapping.assign_coordinates-280"><span class="linenos">280</span></a>
</span><span id="ComposableMapping.assign_coordinates-281"><a href="#ComposableMapping.assign_coordinates-281"><span class="linenos">281</span></a><span class="sd">        Returns:</span>
</span><span id="ComposableMapping.assign_coordinates-282"><a href="#ComposableMapping.assign_coordinates-282"><span class="linenos">282</span></a><span class="sd">            Mapping with the given target coordinate system.</span>
</span><span id="ComposableMapping.assign_coordinates-283"><a href="#ComposableMapping.assign_coordinates-283"><span class="linenos">283</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ComposableMapping.assign_coordinates-284"><a href="#ComposableMapping.assign_coordinates-284"><span class="linenos">284</span></a>        <span class="k">return</span> <span class="n">_AssignCoordinatesDecorator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">coordinate_system</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Assign a coordinate system for the mapping.</p>

<p>This only changes the coordinate system of the mapping, the mapping itself
is not changed. The coordinate system contained by the mapping affects
behaviour of some methods such as <code><a href="#GridComposableMapping.sample">GridComposableMapping.sample</a></code> and
<code><a href="#GridComposableMapping.resample">GridComposableMapping.resample</a></code>.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>coordinates:</strong>  Coordinate system (or a container with a coordinate system)
to assign for the mapping.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Mapping with the given target coordinate system.</p>
</blockquote>
</div>


                            </div>
                            <div id="ComposableMapping.as_affine_transformation" class="classattr">
                                        <input id="ComposableMapping.as_affine_transformation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">as_affine_transformation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="n"><a href="composable_mapping/affine_transformation.html#IAffineTransformation">composable_mapping.affine_transformation.IAffineTransformation</a></span>:</span></span>

                <label class="view-source-button" for="ComposableMapping.as_affine_transformation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ComposableMapping.as_affine_transformation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ComposableMapping.as_affine_transformation-286"><a href="#ComposableMapping.as_affine_transformation-286"><span class="linenos">286</span></a>    <span class="k">def</span> <span class="nf">as_affine_transformation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IAffineTransformation</span><span class="p">:</span>
</span><span id="ComposableMapping.as_affine_transformation-287"><a href="#ComposableMapping.as_affine_transformation-287"><span class="linenos">287</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain the mapping as an affine transformation on PyTorch tensors, if possible.</span>
</span><span id="ComposableMapping.as_affine_transformation-288"><a href="#ComposableMapping.as_affine_transformation-288"><span class="linenos">288</span></a>
</span><span id="ComposableMapping.as_affine_transformation-289"><a href="#ComposableMapping.as_affine_transformation-289"><span class="linenos">289</span></a><span class="sd">        Returns:</span>
</span><span id="ComposableMapping.as_affine_transformation-290"><a href="#ComposableMapping.as_affine_transformation-290"><span class="linenos">290</span></a><span class="sd">            Affine transformation on PyTorch tensors.</span>
</span><span id="ComposableMapping.as_affine_transformation-291"><a href="#ComposableMapping.as_affine_transformation-291"><span class="linenos">291</span></a>
</span><span id="ComposableMapping.as_affine_transformation-292"><a href="#ComposableMapping.as_affine_transformation-292"><span class="linenos">292</span></a><span class="sd">        Raises:</span>
</span><span id="ComposableMapping.as_affine_transformation-293"><a href="#ComposableMapping.as_affine_transformation-293"><span class="linenos">293</span></a><span class="sd">            NotAffineTransformationError: If the mapping is not an affine transformation on</span>
</span><span id="ComposableMapping.as_affine_transformation-294"><a href="#ComposableMapping.as_affine_transformation-294"><span class="linenos">294</span></a><span class="sd">                PyTorch tensors.</span>
</span><span id="ComposableMapping.as_affine_transformation-295"><a href="#ComposableMapping.as_affine_transformation-295"><span class="linenos">295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ComposableMapping.as_affine_transformation-296"><a href="#ComposableMapping.as_affine_transformation-296"><span class="linenos">296</span></a>        <span class="n">tracer</span> <span class="o">=</span> <span class="n">_AffineTracer</span><span class="p">()</span>
</span><span id="ComposableMapping.as_affine_transformation-297"><a href="#ComposableMapping.as_affine_transformation-297"><span class="linenos">297</span></a>        <span class="n">traced</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">tracer</span><span class="p">)</span>
</span><span id="ComposableMapping.as_affine_transformation-298"><a href="#ComposableMapping.as_affine_transformation-298"><span class="linenos">298</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">traced</span><span class="p">,</span> <span class="n">_AffineTracer</span><span class="p">):</span>
</span><span id="ComposableMapping.as_affine_transformation-299"><a href="#ComposableMapping.as_affine_transformation-299"><span class="linenos">299</span></a>            <span class="k">if</span> <span class="n">traced</span><span class="o">.</span><span class="n">traced_affine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ComposableMapping.as_affine_transformation-300"><a href="#ComposableMapping.as_affine_transformation-300"><span class="linenos">300</span></a>                <span class="k">raise</span> <span class="n">NotAffineTransformationError</span><span class="p">(</span><span class="s2">&quot;Could not infer affine transformation&quot;</span><span class="p">)</span>
</span><span id="ComposableMapping.as_affine_transformation-301"><a href="#ComposableMapping.as_affine_transformation-301"><span class="linenos">301</span></a>            <span class="k">return</span> <span class="n">traced</span><span class="o">.</span><span class="n">traced_affine</span>
</span><span id="ComposableMapping.as_affine_transformation-302"><a href="#ComposableMapping.as_affine_transformation-302"><span class="linenos">302</span></a>        <span class="k">raise</span> <span class="n">NotAffineTransformationError</span><span class="p">(</span><span class="s2">&quot;Could not infer affine transformation&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Obtain the mapping as an affine transformation on PyTorch tensors, if possible.</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Affine transformation on PyTorch tensors.</p>
</blockquote>

<h6 id="raises">Raises:</h6>

<ul>
<li><strong>NotAffineTransformationError:</strong>  If the mapping is not an affine transformation on
PyTorch tensors.</li>
</ul>
</div>


                            </div>
                            <div id="ComposableMapping.as_affine_matrix" class="classattr">
                                        <input id="ComposableMapping.as_affine_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">as_affine_matrix</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="ComposableMapping.as_affine_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ComposableMapping.as_affine_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ComposableMapping.as_affine_matrix-304"><a href="#ComposableMapping.as_affine_matrix-304"><span class="linenos">304</span></a>    <span class="k">def</span> <span class="nf">as_affine_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="ComposableMapping.as_affine_matrix-305"><a href="#ComposableMapping.as_affine_matrix-305"><span class="linenos">305</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain the mapping as an affine matrix, if possible.</span>
</span><span id="ComposableMapping.as_affine_matrix-306"><a href="#ComposableMapping.as_affine_matrix-306"><span class="linenos">306</span></a>
</span><span id="ComposableMapping.as_affine_matrix-307"><a href="#ComposableMapping.as_affine_matrix-307"><span class="linenos">307</span></a><span class="sd">        Returns:</span>
</span><span id="ComposableMapping.as_affine_matrix-308"><a href="#ComposableMapping.as_affine_matrix-308"><span class="linenos">308</span></a><span class="sd">            Affine matrix with</span>
</span><span id="ComposableMapping.as_affine_matrix-309"><a href="#ComposableMapping.as_affine_matrix-309"><span class="linenos">309</span></a><span class="sd">            shape ([*batch_shape, ]n_output_dims + 1, n_input_dims + 1[, *spatial_shape]).</span>
</span><span id="ComposableMapping.as_affine_matrix-310"><a href="#ComposableMapping.as_affine_matrix-310"><span class="linenos">310</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ComposableMapping.as_affine_matrix-311"><a href="#ComposableMapping.as_affine_matrix-311"><span class="linenos">311</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_affine_transformation</span><span class="p">()</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Obtain the mapping as an affine matrix, if possible.</p>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Affine matrix with
  shape ([*batch_shape, ]n_output_dims + 1, n_input_dims + 1[, *spatial_shape]).</p>
</blockquote>
</div>


                            </div>
                            <div id="ComposableMapping.default_sampling_data_format" class="classattr">
                                        <input id="ComposableMapping.default_sampling_data_format-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">default_sampling_data_format</span><span class="annotation">: Union[<a href="#DataFormat">DataFormat</a>, NoneType]</span>

                <label class="view-source-button" for="ComposableMapping.default_sampling_data_format-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ComposableMapping.default_sampling_data_format"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ComposableMapping.default_sampling_data_format-313"><a href="#ComposableMapping.default_sampling_data_format-313"><span class="linenos">313</span></a>    <span class="nd">@property</span>
</span><span id="ComposableMapping.default_sampling_data_format-314"><a href="#ComposableMapping.default_sampling_data_format-314"><span class="linenos">314</span></a>    <span class="k">def</span> <span class="nf">default_sampling_data_format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFormat</span><span class="p">]:</span>
</span><span id="ComposableMapping.default_sampling_data_format-315"><a href="#ComposableMapping.default_sampling_data_format-315"><span class="linenos">315</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Default data format to use in sampling and resampling operations for</span>
</span><span id="ComposableMapping.default_sampling_data_format-316"><a href="#ComposableMapping.default_sampling_data_format-316"><span class="linenos">316</span></a><span class="sd">        the mapping.</span>
</span><span id="ComposableMapping.default_sampling_data_format-317"><a href="#ComposableMapping.default_sampling_data_format-317"><span class="linenos">317</span></a>
</span><span id="ComposableMapping.default_sampling_data_format-318"><a href="#ComposableMapping.default_sampling_data_format-318"><span class="linenos">318</span></a><span class="sd">        If None, DataFormat.world_coordinates() will be used but the behaviour</span>
</span><span id="ComposableMapping.default_sampling_data_format-319"><a href="#ComposableMapping.default_sampling_data_format-319"><span class="linenos">319</span></a><span class="sd">        in operations with other mappings is different as the default data format</span>
</span><span id="ComposableMapping.default_sampling_data_format-320"><a href="#ComposableMapping.default_sampling_data_format-320"><span class="linenos">320</span></a><span class="sd">        of the other mapping will be used.</span>
</span><span id="ComposableMapping.default_sampling_data_format-321"><a href="#ComposableMapping.default_sampling_data_format-321"><span class="linenos">321</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ComposableMapping.default_sampling_data_format-322"><a href="#ComposableMapping.default_sampling_data_format-322"><span class="linenos">322</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Default data format to use in sampling and resampling operations for
the mapping.</p>

<p>If None, <a href="#DataFormat.world_coordinates">DataFormat.world_coordinates()</a> will be used but the behaviour
in operations with other mappings is different as the default data format
of the other mapping will be used.</p>
</div>


                            </div>
                            <div id="ComposableMapping.set_default_sampling_data_format" class="classattr">
                                        <input id="ComposableMapping.set_default_sampling_data_format-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_default_sampling_data_format</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span><span class="p">:</span> <span class="n"><a href="#ComposableMapping">ComposableMapping</a></span>,</span><span class="param">	<span class="n">data_format</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#DataFormat">DataFormat</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="#ComposableMapping">ComposableMapping</a></span>:</span></span>

                <label class="view-source-button" for="ComposableMapping.set_default_sampling_data_format-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ComposableMapping.set_default_sampling_data_format"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ComposableMapping.set_default_sampling_data_format-141"><a href="#ComposableMapping.set_default_sampling_data_format-141"><span class="linenos">141</span></a><span class="k">def</span> <span class="nf">_set_default_sampling_data_format</span><span class="p">(</span>
</span><span id="ComposableMapping.set_default_sampling_data_format-142"><a href="#ComposableMapping.set_default_sampling_data_format-142"><span class="linenos">142</span></a>    <span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;ComposableMapping&quot;</span><span class="p">,</span> <span class="n">data_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFormat</span><span class="p">]</span>
</span><span id="ComposableMapping.set_default_sampling_data_format-143"><a href="#ComposableMapping.set_default_sampling_data_format-143"><span class="linenos">143</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ComposableMapping&quot;</span><span class="p">:</span>
</span><span id="ComposableMapping.set_default_sampling_data_format-144"><a href="#ComposableMapping.set_default_sampling_data_format-144"><span class="linenos">144</span></a>    <span class="k">return</span> <span class="n">_assign_coordinates_if_available</span><span class="p">(</span>
</span><span id="ComposableMapping.set_default_sampling_data_format-145"><a href="#ComposableMapping.set_default_sampling_data_format-145"><span class="linenos">145</span></a>        <span class="n">_SetDefaultSamplingDataFormatDecorator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_format</span><span class="p">),</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span>
</span><span id="ComposableMapping.set_default_sampling_data_format-146"><a href="#ComposableMapping.set_default_sampling_data_format-146"><span class="linenos">146</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Set the default data format to use in sampling and resampling operations for
the mapping.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>data_format:</strong>  Default data format to use in sampling and resampling operations.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Mapping with the default data format set.</p>
</blockquote>
</div>


                            </div>
                            <div id="ComposableMapping.__matmul__" class="classattr">
                                        <input id="ComposableMapping.__matmul__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">__matmul__</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span><span class="p">:</span> <span class="n"><a href="#ComposableMapping">ComposableMapping</a></span>,</span><span class="param">	<span class="n">right_mapping</span><span class="p">:</span> <span class="n"><a href="#ComposableMapping">ComposableMapping</a></span></span><span class="return-annotation">) -> <span class="n"><a href="#ComposableMapping">ComposableMapping</a></span>:</span></span>

                <label class="view-source-button" for="ComposableMapping.__matmul__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ComposableMapping.__matmul__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ComposableMapping.__matmul__-125"><a href="#ComposableMapping.__matmul__-125"><span class="linenos">125</span></a><span class="k">def</span> <span class="nf">_composition</span><span class="p">(</span>
</span><span id="ComposableMapping.__matmul__-126"><a href="#ComposableMapping.__matmul__-126"><span class="linenos">126</span></a>    <span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;ComposableMapping&quot;</span><span class="p">,</span> <span class="n">right_mapping</span><span class="p">:</span> <span class="s2">&quot;ComposableMapping&quot;</span>
</span><span id="ComposableMapping.__matmul__-127"><a href="#ComposableMapping.__matmul__-127"><span class="linenos">127</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ComposableMapping&quot;</span><span class="p">:</span>
</span><span id="ComposableMapping.__matmul__-128"><a href="#ComposableMapping.__matmul__-128"><span class="linenos">128</span></a>    <span class="k">return</span> <span class="n">_assign_coordinates_if_available</span><span class="p">(</span>
</span><span id="ComposableMapping.__matmul__-129"><a href="#ComposableMapping.__matmul__-129"><span class="linenos">129</span></a>        <span class="n">_Composition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">right_mapping</span><span class="p">),</span> <span class="p">[</span><span class="bp">self</span><span class="p">,</span> <span class="n">right_mapping</span><span class="p">]</span>
</span><span id="ComposableMapping.__matmul__-130"><a href="#ComposableMapping.__matmul__-130"><span class="linenos">130</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compose with another mapping.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>right_mapping:</strong>  Mapping to compose with.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Composed mapping.</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#ITensorLike">ITensorLike</a></dt>
                                <dd id="ComposableMapping.dtype" class="variable"><a href="#ITensorLike.dtype">dtype</a></dd>
                <dd id="ComposableMapping.device" class="variable"><a href="#ITensorLike.device">device</a></dd>
                <dd id="ComposableMapping.cast" class="function"><a href="#ITensorLike.cast">cast</a></dd>
                <dd id="ComposableMapping.detach" class="function"><a href="#ITensorLike.detach">detach</a></dd>
                <dd id="ComposableMapping.pin_memory" class="function"><a href="#ITensorLike.pin_memory">pin_memory</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="CoordinateSystem">
                            <input id="CoordinateSystem-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CoordinateSystem</span><wbr>(<span class="base">torch.nn.modules.module.Module</span>, <span class="base">composable_mapping.composable_mapping.interface.ICoordinateSystemContainer</span>, <span class="base">composable_mapping.tensor_like.BaseTensorLikeWrapper</span>):

                <label class="view-source-button" for="CoordinateSystem-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem-40"><a href="#CoordinateSystem-40"><span class="linenos"> 40</span></a><span class="k">class</span> <span class="nc">CoordinateSystem</span><span class="p">(</span><span class="n">Module</span><span class="p">,</span> <span class="n">ICoordinateSystemContainer</span><span class="p">,</span> <span class="n">BaseTensorLikeWrapper</span><span class="p">):</span>
</span><span id="CoordinateSystem-41"><a href="#CoordinateSystem-41"><span class="linenos"> 41</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents coordinate system between voxel and world coordinates on a regular grid</span>
</span><span id="CoordinateSystem-42"><a href="#CoordinateSystem-42"><span class="linenos"> 42</span></a>
</span><span id="CoordinateSystem-43"><a href="#CoordinateSystem-43"><span class="linenos"> 43</span></a><span class="sd">    Recommended way to create a coordinate system is to use the factory</span>
</span><span id="CoordinateSystem-44"><a href="#CoordinateSystem-44"><span class="linenos"> 44</span></a><span class="sd">    methods provided as class method of this class:</span>
</span><span id="CoordinateSystem-45"><a href="#CoordinateSystem-45"><span class="linenos"> 45</span></a><span class="sd">    `CoordinateSystem.centered_normalized`,</span>
</span><span id="CoordinateSystem-46"><a href="#CoordinateSystem-46"><span class="linenos"> 46</span></a><span class="sd">    `CoordinateSystem.centered`, `CoordinateSystem.voxel`,</span>
</span><span id="CoordinateSystem-47"><a href="#CoordinateSystem-47"><span class="linenos"> 47</span></a><span class="sd">    `CoordinateSystem.torch_grid_sample`,</span>
</span><span id="CoordinateSystem-48"><a href="#CoordinateSystem-48"><span class="linenos"> 48</span></a><span class="sd">    `CoordinateSystem.from_affine_matrix`,</span>
</span><span id="CoordinateSystem-49"><a href="#CoordinateSystem-49"><span class="linenos"> 49</span></a><span class="sd">    `CoordinateSystem.from_diagonal_affine_matrix`.</span>
</span><span id="CoordinateSystem-50"><a href="#CoordinateSystem-50"><span class="linenos"> 50</span></a>
</span><span id="CoordinateSystem-51"><a href="#CoordinateSystem-51"><span class="linenos"> 51</span></a><span class="sd">    Arguments:</span>
</span><span id="CoordinateSystem-52"><a href="#CoordinateSystem-52"><span class="linenos"> 52</span></a><span class="sd">        spatial_shape: Spatial shape of the grid</span>
</span><span id="CoordinateSystem-53"><a href="#CoordinateSystem-53"><span class="linenos"> 53</span></a><span class="sd">        to_voxel_coordinates: Affine transformation from world to voxel</span>
</span><span id="CoordinateSystem-54"><a href="#CoordinateSystem-54"><span class="linenos"> 54</span></a><span class="sd">            coordinates. This should be the inverse of from_voxel_coordinates</span>
</span><span id="CoordinateSystem-55"><a href="#CoordinateSystem-55"><span class="linenos"> 55</span></a><span class="sd">            and can be omitted if from_voxel_coordinates is given. This should</span>
</span><span id="CoordinateSystem-56"><a href="#CoordinateSystem-56"><span class="linenos"> 56</span></a><span class="sd">            be a IHostAffineTransformation meaning that the transformation is</span>
</span><span id="CoordinateSystem-57"><a href="#CoordinateSystem-57"><span class="linenos"> 57</span></a><span class="sd">            stored on the host (cpu) until needed on a target device. That is,</span>
</span><span id="CoordinateSystem-58"><a href="#CoordinateSystem-58"><span class="linenos"> 58</span></a><span class="sd">            since the transformation may be used in control flow decisions, and</span>
</span><span id="CoordinateSystem-59"><a href="#CoordinateSystem-59"><span class="linenos"> 59</span></a><span class="sd">            we want to avoid synchronizing the target device with the host.</span>
</span><span id="CoordinateSystem-60"><a href="#CoordinateSystem-60"><span class="linenos"> 60</span></a><span class="sd">        from_voxel_coordinates: Affine transformation from voxel to world</span>
</span><span id="CoordinateSystem-61"><a href="#CoordinateSystem-61"><span class="linenos"> 61</span></a><span class="sd">            coordinates. This should be the inverse of to_voxel_coordinates</span>
</span><span id="CoordinateSystem-62"><a href="#CoordinateSystem-62"><span class="linenos"> 62</span></a><span class="sd">            and can be omitted if to_voxel_coordinates is given. This should</span>
</span><span id="CoordinateSystem-63"><a href="#CoordinateSystem-63"><span class="linenos"> 63</span></a><span class="sd">            be a IHostAffineTransformation meaning that the transformation is</span>
</span><span id="CoordinateSystem-64"><a href="#CoordinateSystem-64"><span class="linenos"> 64</span></a><span class="sd">            stored on the host (cpu) until needed on a target device. That is,</span>
</span><span id="CoordinateSystem-65"><a href="#CoordinateSystem-65"><span class="linenos"> 65</span></a><span class="sd">            since the transformation may be used in control flow decisions, and</span>
</span><span id="CoordinateSystem-66"><a href="#CoordinateSystem-66"><span class="linenos"> 66</span></a><span class="sd">            we want to avoid synchronizing the target device with the host.</span>
</span><span id="CoordinateSystem-67"><a href="#CoordinateSystem-67"><span class="linenos"> 67</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-68"><a href="#CoordinateSystem-68"><span class="linenos"> 68</span></a>
</span><span id="CoordinateSystem-69"><a href="#CoordinateSystem-69"><span class="linenos"> 69</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="CoordinateSystem-70"><a href="#CoordinateSystem-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CoordinateSystem-71"><a href="#CoordinateSystem-71"><span class="linenos"> 71</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="CoordinateSystem-72"><a href="#CoordinateSystem-72"><span class="linenos"> 72</span></a>        <span class="n">to_voxel_coordinates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IHostAffineTransformation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-73"><a href="#CoordinateSystem-73"><span class="linenos"> 73</span></a>        <span class="n">from_voxel_coordinates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IHostAffineTransformation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-74"><a href="#CoordinateSystem-74"><span class="linenos"> 74</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem-75"><a href="#CoordinateSystem-75"><span class="linenos"> 75</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="CoordinateSystem-76"><a href="#CoordinateSystem-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem-77"><a href="#CoordinateSystem-77"><span class="linenos"> 77</span></a>        <span class="k">if</span> <span class="n">from_voxel_coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem-78"><a href="#CoordinateSystem-78"><span class="linenos"> 78</span></a>            <span class="k">if</span> <span class="n">to_voxel_coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem-79"><a href="#CoordinateSystem-79"><span class="linenos"> 79</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="CoordinateSystem-80"><a href="#CoordinateSystem-80"><span class="linenos"> 80</span></a>                    <span class="s2">&quot;Either from_voxel_coordinates or to_voxel_coordinates should be given&quot;</span>
</span><span id="CoordinateSystem-81"><a href="#CoordinateSystem-81"><span class="linenos"> 81</span></a>                <span class="p">)</span>
</span><span id="CoordinateSystem-82"><a href="#CoordinateSystem-82"><span class="linenos"> 82</span></a>            <span class="n">from_voxel_coordinates</span> <span class="o">=</span> <span class="n">to_voxel_coordinates</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
</span><span id="CoordinateSystem-83"><a href="#CoordinateSystem-83"><span class="linenos"> 83</span></a>        <span class="k">elif</span> <span class="n">to_voxel_coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem-84"><a href="#CoordinateSystem-84"><span class="linenos"> 84</span></a>            <span class="n">to_voxel_coordinates</span> <span class="o">=</span> <span class="n">from_voxel_coordinates</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
</span><span id="CoordinateSystem-85"><a href="#CoordinateSystem-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_transformations_which_should_not_be_accessed_directly</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="CoordinateSystem-86"><a href="#CoordinateSystem-86"><span class="linenos"> 86</span></a>            <span class="s2">&quot;from_voxel_coordinates&quot;</span><span class="p">:</span> <span class="n">from_voxel_coordinates</span><span class="p">,</span>
</span><span id="CoordinateSystem-87"><a href="#CoordinateSystem-87"><span class="linenos"> 87</span></a>            <span class="s2">&quot;to_voxel_coordinates&quot;</span><span class="p">:</span> <span class="n">to_voxel_coordinates</span><span class="p">,</span>
</span><span id="CoordinateSystem-88"><a href="#CoordinateSystem-88"><span class="linenos"> 88</span></a>        <span class="p">}</span>
</span><span id="CoordinateSystem-89"><a href="#CoordinateSystem-89"><span class="linenos"> 89</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="CoordinateSystem-90"><a href="#CoordinateSystem-90"><span class="linenos"> 90</span></a>            <span class="n">get_channels_shape</span><span class="p">(</span><span class="n">from_voxel_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CoordinateSystem-91"><a href="#CoordinateSystem-91"><span class="linenos"> 91</span></a>            <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="CoordinateSystem-92"><a href="#CoordinateSystem-92"><span class="linenos"> 92</span></a>            <span class="ow">or</span> <span class="n">get_spatial_shape</span><span class="p">(</span><span class="n">from_voxel_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">tuple</span><span class="p">()</span>
</span><span id="CoordinateSystem-93"><a href="#CoordinateSystem-93"><span class="linenos"> 93</span></a>        <span class="p">):</span>
</span><span id="CoordinateSystem-94"><a href="#CoordinateSystem-94"><span class="linenos"> 94</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid affine transformation for a coordinate system&quot;</span><span class="p">)</span>
</span><span id="CoordinateSystem-95"><a href="#CoordinateSystem-95"><span class="linenos"> 95</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="CoordinateSystem-96"><a href="#CoordinateSystem-96"><span class="linenos"> 96</span></a>            <span class="n">get_channels_shape</span><span class="p">(</span><span class="n">to_voxel_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CoordinateSystem-97"><a href="#CoordinateSystem-97"><span class="linenos"> 97</span></a>            <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="CoordinateSystem-98"><a href="#CoordinateSystem-98"><span class="linenos"> 98</span></a>            <span class="ow">or</span> <span class="n">get_spatial_shape</span><span class="p">(</span><span class="n">to_voxel_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">tuple</span><span class="p">()</span>
</span><span id="CoordinateSystem-99"><a href="#CoordinateSystem-99"><span class="linenos"> 99</span></a>        <span class="p">):</span>
</span><span id="CoordinateSystem-100"><a href="#CoordinateSystem-100"><span class="linenos">100</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid affine transformation for a coordinate system&quot;</span><span class="p">)</span>
</span><span id="CoordinateSystem-101"><a href="#CoordinateSystem-101"><span class="linenos">101</span></a>        <span class="c1"># Trick to make torch.nn.Module type conversion work automatically, we</span>
</span><span id="CoordinateSystem-102"><a href="#CoordinateSystem-102"><span class="linenos">102</span></a>        <span class="c1"># use the empty indicator tensor to infer the device and dtype of the</span>
</span><span id="CoordinateSystem-103"><a href="#CoordinateSystem-103"><span class="linenos">103</span></a>        <span class="c1"># coordinate system.</span>
</span><span id="CoordinateSystem-104"><a href="#CoordinateSystem-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span>
</span><span id="CoordinateSystem-105"><a href="#CoordinateSystem-105"><span class="linenos">105</span></a>            <span class="s2">&quot;_indicator&quot;</span><span class="p">,</span>
</span><span id="CoordinateSystem-106"><a href="#CoordinateSystem-106"><span class="linenos">106</span></a>            <span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">to_voxel_coordinates</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">to_voxel_coordinates</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="CoordinateSystem-107"><a href="#CoordinateSystem-107"><span class="linenos">107</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-108"><a href="#CoordinateSystem-108"><span class="linenos">108</span></a>
</span><span id="CoordinateSystem-109"><a href="#CoordinateSystem-109"><span class="linenos">109</span></a>    <span class="nd">@classmethod</span>
</span><span id="CoordinateSystem-110"><a href="#CoordinateSystem-110"><span class="linenos">110</span></a>    <span class="k">def</span> <span class="nf">centered_normalized</span><span class="p">(</span>
</span><span id="CoordinateSystem-111"><a href="#CoordinateSystem-111"><span class="linenos">111</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="CoordinateSystem-112"><a href="#CoordinateSystem-112"><span class="linenos">112</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="CoordinateSystem-113"><a href="#CoordinateSystem-113"><span class="linenos">113</span></a>        <span class="n">voxel_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="CoordinateSystem-114"><a href="#CoordinateSystem-114"><span class="linenos">114</span></a>        <span class="n">fov_convention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">,</span>
</span><span id="CoordinateSystem-115"><a href="#CoordinateSystem-115"><span class="linenos">115</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-116"><a href="#CoordinateSystem-116"><span class="linenos">116</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-117"><a href="#CoordinateSystem-117"><span class="linenos">117</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-118"><a href="#CoordinateSystem-118"><span class="linenos">118</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a centered normalized coordinate system.</span>
</span><span id="CoordinateSystem-119"><a href="#CoordinateSystem-119"><span class="linenos">119</span></a>
</span><span id="CoordinateSystem-120"><a href="#CoordinateSystem-120"><span class="linenos">120</span></a><span class="sd">        The coordinate system is normalized such that the grid just fits into the</span>
</span><span id="CoordinateSystem-121"><a href="#CoordinateSystem-121"><span class="linenos">121</span></a><span class="sd">        cube from -1 to 1 in each dimension. The grid is centered in the cube.</span>
</span><span id="CoordinateSystem-122"><a href="#CoordinateSystem-122"><span class="linenos">122</span></a>
</span><span id="CoordinateSystem-123"><a href="#CoordinateSystem-123"><span class="linenos">123</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem-124"><a href="#CoordinateSystem-124"><span class="linenos">124</span></a><span class="sd">            spatial_shape: Spatial shape of the grid.</span>
</span><span id="CoordinateSystem-125"><a href="#CoordinateSystem-125"><span class="linenos">125</span></a><span class="sd">            voxel_size: Relative voxel size of the grid.</span>
</span><span id="CoordinateSystem-126"><a href="#CoordinateSystem-126"><span class="linenos">126</span></a><span class="sd">            fov_convention: Convention for defining the field of view, either &quot;full_voxels&quot;</span>
</span><span id="CoordinateSystem-127"><a href="#CoordinateSystem-127"><span class="linenos">127</span></a><span class="sd">                or &quot;voxel_centers&quot;. If voxels are seens as cubes with the value at the</span>
</span><span id="CoordinateSystem-128"><a href="#CoordinateSystem-128"><span class="linenos">128</span></a><span class="sd">                center, the convention &quot;full voxels&quot; includes the full cubes in the field</span>
</span><span id="CoordinateSystem-129"><a href="#CoordinateSystem-129"><span class="linenos">129</span></a><span class="sd">                of view, while the convention &quot;voxel_centers&quot; includes only the centers.</span>
</span><span id="CoordinateSystem-130"><a href="#CoordinateSystem-130"><span class="linenos">130</span></a><span class="sd">                The latter results in a field of view that is one voxel smaller in each</span>
</span><span id="CoordinateSystem-131"><a href="#CoordinateSystem-131"><span class="linenos">131</span></a><span class="sd">                dimension. Similar to the align_corners option in</span>
</span><span id="CoordinateSystem-132"><a href="#CoordinateSystem-132"><span class="linenos">132</span></a><span class="sd">                torch.nn.functional.grid_sample.</span>
</span><span id="CoordinateSystem-133"><a href="#CoordinateSystem-133"><span class="linenos">133</span></a><span class="sd">            dtype: Data type of the created coordinate system.</span>
</span><span id="CoordinateSystem-134"><a href="#CoordinateSystem-134"><span class="linenos">134</span></a><span class="sd">            device: Device of the created coordinate system.</span>
</span><span id="CoordinateSystem-135"><a href="#CoordinateSystem-135"><span class="linenos">135</span></a>
</span><span id="CoordinateSystem-136"><a href="#CoordinateSystem-136"><span class="linenos">136</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem-137"><a href="#CoordinateSystem-137"><span class="linenos">137</span></a><span class="sd">            Centered normalized coordinate system.</span>
</span><span id="CoordinateSystem-138"><a href="#CoordinateSystem-138"><span class="linenos">138</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-139"><a href="#CoordinateSystem-139"><span class="linenos">139</span></a>        <span class="n">centered</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">centered</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">voxel_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="CoordinateSystem-140"><a href="#CoordinateSystem-140"><span class="linenos">140</span></a>        <span class="n">voxel_size</span> <span class="o">=</span> <span class="n">centered</span><span class="o">.</span><span class="n">grid_spacing_cpu</span><span class="p">()</span>
</span><span id="CoordinateSystem-141"><a href="#CoordinateSystem-141"><span class="linenos">141</span></a>        <span class="n">shape_tensor</span> <span class="o">=</span> <span class="n">voxel_size</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem-142"><a href="#CoordinateSystem-142"><span class="linenos">142</span></a>        <span class="k">if</span> <span class="n">fov_convention</span> <span class="o">==</span> <span class="s2">&quot;voxel_centers&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-143"><a href="#CoordinateSystem-143"><span class="linenos">143</span></a>            <span class="n">shape_tensor</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="CoordinateSystem-144"><a href="#CoordinateSystem-144"><span class="linenos">144</span></a>        <span class="k">elif</span> <span class="n">fov_convention</span> <span class="o">!=</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-145"><a href="#CoordinateSystem-145"><span class="linenos">145</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown fov convention </span><span class="si">{</span><span class="n">fov_convention</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CoordinateSystem-146"><a href="#CoordinateSystem-146"><span class="linenos">146</span></a>        <span class="n">fov_sizes</span> <span class="o">=</span> <span class="n">shape_tensor</span> <span class="o">*</span> <span class="n">voxel_size</span>
</span><span id="CoordinateSystem-147"><a href="#CoordinateSystem-147"><span class="linenos">147</span></a>        <span class="n">max_fov_size_index</span> <span class="o">=</span> <span class="n">fov_sizes</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
</span><span id="CoordinateSystem-148"><a href="#CoordinateSystem-148"><span class="linenos">148</span></a>        <span class="n">relative_voxel_sizes</span> <span class="o">=</span> <span class="n">voxel_size</span> <span class="o">/</span> <span class="n">voxel_size</span><span class="p">[</span><span class="n">max_fov_size_index</span><span class="p">]</span>
</span><span id="CoordinateSystem-149"><a href="#CoordinateSystem-149"><span class="linenos">149</span></a>        <span class="n">target_voxel_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">fov_sizes</span><span class="p">[</span><span class="n">max_fov_size_index</span><span class="p">]</span> <span class="o">*</span> <span class="n">relative_voxel_sizes</span>
</span><span id="CoordinateSystem-150"><a href="#CoordinateSystem-150"><span class="linenos">150</span></a>        <span class="k">return</span> <span class="n">centered</span><span class="o">.</span><span class="n">reformat</span><span class="p">(</span>
</span><span id="CoordinateSystem-151"><a href="#CoordinateSystem-151"><span class="linenos">151</span></a>            <span class="n">voxel_size</span><span class="o">=</span><span class="n">target_voxel_size</span><span class="p">,</span>
</span><span id="CoordinateSystem-152"><a href="#CoordinateSystem-152"><span class="linenos">152</span></a>            <span class="n">reference</span><span class="o">=</span><span class="n">Center</span><span class="p">(),</span>
</span><span id="CoordinateSystem-153"><a href="#CoordinateSystem-153"><span class="linenos">153</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="n">OriginalShape</span><span class="p">(),</span>
</span><span id="CoordinateSystem-154"><a href="#CoordinateSystem-154"><span class="linenos">154</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-155"><a href="#CoordinateSystem-155"><span class="linenos">155</span></a>
</span><span id="CoordinateSystem-156"><a href="#CoordinateSystem-156"><span class="linenos">156</span></a>    <span class="nd">@classmethod</span>
</span><span id="CoordinateSystem-157"><a href="#CoordinateSystem-157"><span class="linenos">157</span></a>    <span class="k">def</span> <span class="nf">centered</span><span class="p">(</span>
</span><span id="CoordinateSystem-158"><a href="#CoordinateSystem-158"><span class="linenos">158</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="CoordinateSystem-159"><a href="#CoordinateSystem-159"><span class="linenos">159</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="CoordinateSystem-160"><a href="#CoordinateSystem-160"><span class="linenos">160</span></a>        <span class="n">voxel_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="CoordinateSystem-161"><a href="#CoordinateSystem-161"><span class="linenos">161</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-162"><a href="#CoordinateSystem-162"><span class="linenos">162</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-163"><a href="#CoordinateSystem-163"><span class="linenos">163</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-164"><a href="#CoordinateSystem-164"><span class="linenos">164</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create centered coordinate system with a given voxel size.</span>
</span><span id="CoordinateSystem-165"><a href="#CoordinateSystem-165"><span class="linenos">165</span></a>
</span><span id="CoordinateSystem-166"><a href="#CoordinateSystem-166"><span class="linenos">166</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem-167"><a href="#CoordinateSystem-167"><span class="linenos">167</span></a><span class="sd">            spatial_shape: Spatial shape of the grid.</span>
</span><span id="CoordinateSystem-168"><a href="#CoordinateSystem-168"><span class="linenos">168</span></a><span class="sd">            voxel_size: Voxel size of the grid.</span>
</span><span id="CoordinateSystem-169"><a href="#CoordinateSystem-169"><span class="linenos">169</span></a><span class="sd">            dtype: Data type of the created coordinate system.</span>
</span><span id="CoordinateSystem-170"><a href="#CoordinateSystem-170"><span class="linenos">170</span></a><span class="sd">            device: Device of the created coordinate system.</span>
</span><span id="CoordinateSystem-171"><a href="#CoordinateSystem-171"><span class="linenos">171</span></a>
</span><span id="CoordinateSystem-172"><a href="#CoordinateSystem-172"><span class="linenos">172</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem-173"><a href="#CoordinateSystem-173"><span class="linenos">173</span></a><span class="sd">            Centered coordinate system.</span>
</span><span id="CoordinateSystem-174"><a href="#CoordinateSystem-174"><span class="linenos">174</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-175"><a href="#CoordinateSystem-175"><span class="linenos">175</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">voxel</span><span class="p">(</span>
</span><span id="CoordinateSystem-176"><a href="#CoordinateSystem-176"><span class="linenos">176</span></a>            <span class="n">spatial_shape</span><span class="p">,</span> <span class="n">voxel_size</span><span class="o">=</span><span class="n">voxel_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
</span><span id="CoordinateSystem-177"><a href="#CoordinateSystem-177"><span class="linenos">177</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">translate_voxel</span><span class="p">([</span><span class="o">-</span><span class="p">(</span><span class="n">dim_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">dim_size</span> <span class="ow">in</span> <span class="n">spatial_shape</span><span class="p">])</span>
</span><span id="CoordinateSystem-178"><a href="#CoordinateSystem-178"><span class="linenos">178</span></a>
</span><span id="CoordinateSystem-179"><a href="#CoordinateSystem-179"><span class="linenos">179</span></a>    <span class="nd">@classmethod</span>
</span><span id="CoordinateSystem-180"><a href="#CoordinateSystem-180"><span class="linenos">180</span></a>    <span class="k">def</span> <span class="nf">voxel</span><span class="p">(</span>
</span><span id="CoordinateSystem-181"><a href="#CoordinateSystem-181"><span class="linenos">181</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="CoordinateSystem-182"><a href="#CoordinateSystem-182"><span class="linenos">182</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="CoordinateSystem-183"><a href="#CoordinateSystem-183"><span class="linenos">183</span></a>        <span class="n">voxel_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-184"><a href="#CoordinateSystem-184"><span class="linenos">184</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-185"><a href="#CoordinateSystem-185"><span class="linenos">185</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-186"><a href="#CoordinateSystem-186"><span class="linenos">186</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-187"><a href="#CoordinateSystem-187"><span class="linenos">187</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create coordinate system corresponding to the voxel coordinate</span>
</span><span id="CoordinateSystem-188"><a href="#CoordinateSystem-188"><span class="linenos">188</span></a><span class="sd">        potentially scaled by the voxel size.</span>
</span><span id="CoordinateSystem-189"><a href="#CoordinateSystem-189"><span class="linenos">189</span></a>
</span><span id="CoordinateSystem-190"><a href="#CoordinateSystem-190"><span class="linenos">190</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem-191"><a href="#CoordinateSystem-191"><span class="linenos">191</span></a><span class="sd">            spatial_shape: Spatial shape of the grid.</span>
</span><span id="CoordinateSystem-192"><a href="#CoordinateSystem-192"><span class="linenos">192</span></a><span class="sd">            voxel_size: Voxel size of the grid.</span>
</span><span id="CoordinateSystem-193"><a href="#CoordinateSystem-193"><span class="linenos">193</span></a><span class="sd">            dtype: Data type of the created coordinate system.</span>
</span><span id="CoordinateSystem-194"><a href="#CoordinateSystem-194"><span class="linenos">194</span></a><span class="sd">            device: Device of the created coordinate system.</span>
</span><span id="CoordinateSystem-195"><a href="#CoordinateSystem-195"><span class="linenos">195</span></a>
</span><span id="CoordinateSystem-196"><a href="#CoordinateSystem-196"><span class="linenos">196</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem-197"><a href="#CoordinateSystem-197"><span class="linenos">197</span></a><span class="sd">            Voxel coordinate system.</span>
</span><span id="CoordinateSystem-198"><a href="#CoordinateSystem-198"><span class="linenos">198</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-199"><a href="#CoordinateSystem-199"><span class="linenos">199</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_diagonal_affine_matrix</span><span class="p">(</span>
</span><span id="CoordinateSystem-200"><a href="#CoordinateSystem-200"><span class="linenos">200</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem-201"><a href="#CoordinateSystem-201"><span class="linenos">201</span></a>            <span class="n">diagonal</span><span class="o">=</span><span class="n">voxel_size</span><span class="p">,</span>
</span><span id="CoordinateSystem-202"><a href="#CoordinateSystem-202"><span class="linenos">202</span></a>            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="CoordinateSystem-203"><a href="#CoordinateSystem-203"><span class="linenos">203</span></a>            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="CoordinateSystem-204"><a href="#CoordinateSystem-204"><span class="linenos">204</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-205"><a href="#CoordinateSystem-205"><span class="linenos">205</span></a>
</span><span id="CoordinateSystem-206"><a href="#CoordinateSystem-206"><span class="linenos">206</span></a>    <span class="nd">@classmethod</span>
</span><span id="CoordinateSystem-207"><a href="#CoordinateSystem-207"><span class="linenos">207</span></a>    <span class="k">def</span> <span class="nf">torch_grid_sample</span><span class="p">(</span>
</span><span id="CoordinateSystem-208"><a href="#CoordinateSystem-208"><span class="linenos">208</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="CoordinateSystem-209"><a href="#CoordinateSystem-209"><span class="linenos">209</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="CoordinateSystem-210"><a href="#CoordinateSystem-210"><span class="linenos">210</span></a>        <span class="n">fov_convention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">,</span>
</span><span id="CoordinateSystem-211"><a href="#CoordinateSystem-211"><span class="linenos">211</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-212"><a href="#CoordinateSystem-212"><span class="linenos">212</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-213"><a href="#CoordinateSystem-213"><span class="linenos">213</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-214"><a href="#CoordinateSystem-214"><span class="linenos">214</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create coordinate system corresponding to the one used by the</span>
</span><span id="CoordinateSystem-215"><a href="#CoordinateSystem-215"><span class="linenos">215</span></a><span class="sd">        torch.nn.functional.grid_sample.</span>
</span><span id="CoordinateSystem-216"><a href="#CoordinateSystem-216"><span class="linenos">216</span></a>
</span><span id="CoordinateSystem-217"><a href="#CoordinateSystem-217"><span class="linenos">217</span></a><span class="sd">        The coordinate system is normalized along each dimensions to the range</span>
</span><span id="CoordinateSystem-218"><a href="#CoordinateSystem-218"><span class="linenos">218</span></a><span class="sd">        from -1 to 1.</span>
</span><span id="CoordinateSystem-219"><a href="#CoordinateSystem-219"><span class="linenos">219</span></a>
</span><span id="CoordinateSystem-220"><a href="#CoordinateSystem-220"><span class="linenos">220</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem-221"><a href="#CoordinateSystem-221"><span class="linenos">221</span></a><span class="sd">            spatial_shape: Spatial shape of the grid.</span>
</span><span id="CoordinateSystem-222"><a href="#CoordinateSystem-222"><span class="linenos">222</span></a><span class="sd">            fov_convention: Convention for defining the field of view, either &quot;full_voxels&quot;</span>
</span><span id="CoordinateSystem-223"><a href="#CoordinateSystem-223"><span class="linenos">223</span></a><span class="sd">                or &quot;voxel_centers&quot;. If voxels are seens as cubes with the value at the</span>
</span><span id="CoordinateSystem-224"><a href="#CoordinateSystem-224"><span class="linenos">224</span></a><span class="sd">                center, the convention &quot;full voxels&quot; includes the full cubes in the field</span>
</span><span id="CoordinateSystem-225"><a href="#CoordinateSystem-225"><span class="linenos">225</span></a><span class="sd">                of view, while the convention &quot;voxel_centers&quot; includes only the centers.</span>
</span><span id="CoordinateSystem-226"><a href="#CoordinateSystem-226"><span class="linenos">226</span></a><span class="sd">                The latter results in a field of view that is one voxel smaller in each</span>
</span><span id="CoordinateSystem-227"><a href="#CoordinateSystem-227"><span class="linenos">227</span></a><span class="sd">                dimension. Similar to the align_corners option in</span>
</span><span id="CoordinateSystem-228"><a href="#CoordinateSystem-228"><span class="linenos">228</span></a><span class="sd">                torch.nn.functional.grid_sample.</span>
</span><span id="CoordinateSystem-229"><a href="#CoordinateSystem-229"><span class="linenos">229</span></a><span class="sd">            dtype: Data type of the created coordinate system.</span>
</span><span id="CoordinateSystem-230"><a href="#CoordinateSystem-230"><span class="linenos">230</span></a><span class="sd">            device: Device of the created coordinate system.</span>
</span><span id="CoordinateSystem-231"><a href="#CoordinateSystem-231"><span class="linenos">231</span></a>
</span><span id="CoordinateSystem-232"><a href="#CoordinateSystem-232"><span class="linenos">232</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem-233"><a href="#CoordinateSystem-233"><span class="linenos">233</span></a><span class="sd">            Coordinate system corresponding to the one used by the</span>
</span><span id="CoordinateSystem-234"><a href="#CoordinateSystem-234"><span class="linenos">234</span></a><span class="sd">            torch.nn.functional.grid_sample.</span>
</span><span id="CoordinateSystem-235"><a href="#CoordinateSystem-235"><span class="linenos">235</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-236"><a href="#CoordinateSystem-236"><span class="linenos">236</span></a>        <span class="n">centered</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">centered</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="CoordinateSystem-237"><a href="#CoordinateSystem-237"><span class="linenos">237</span></a>        <span class="n">shape_tensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">centered</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch_device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">))</span>
</span><span id="CoordinateSystem-238"><a href="#CoordinateSystem-238"><span class="linenos">238</span></a>        <span class="k">if</span> <span class="n">fov_convention</span> <span class="o">==</span> <span class="s2">&quot;voxel_centers&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-239"><a href="#CoordinateSystem-239"><span class="linenos">239</span></a>            <span class="n">shape_tensor</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="CoordinateSystem-240"><a href="#CoordinateSystem-240"><span class="linenos">240</span></a>        <span class="k">elif</span> <span class="n">fov_convention</span> <span class="o">!=</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-241"><a href="#CoordinateSystem-241"><span class="linenos">241</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown fov convention </span><span class="si">{</span><span class="n">fov_convention</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="CoordinateSystem-242"><a href="#CoordinateSystem-242"><span class="linenos">242</span></a>        <span class="n">fov_sizes</span> <span class="o">=</span> <span class="n">shape_tensor</span>
</span><span id="CoordinateSystem-243"><a href="#CoordinateSystem-243"><span class="linenos">243</span></a>        <span class="n">target_voxel_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">fov_sizes</span>
</span><span id="CoordinateSystem-244"><a href="#CoordinateSystem-244"><span class="linenos">244</span></a>        <span class="k">return</span> <span class="n">centered</span><span class="o">.</span><span class="n">reformat</span><span class="p">(</span>
</span><span id="CoordinateSystem-245"><a href="#CoordinateSystem-245"><span class="linenos">245</span></a>            <span class="n">voxel_size</span><span class="o">=</span><span class="n">target_voxel_size</span><span class="p">,</span>
</span><span id="CoordinateSystem-246"><a href="#CoordinateSystem-246"><span class="linenos">246</span></a>            <span class="n">reference</span><span class="o">=</span><span class="n">Center</span><span class="p">(),</span>
</span><span id="CoordinateSystem-247"><a href="#CoordinateSystem-247"><span class="linenos">247</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="n">OriginalShape</span><span class="p">(),</span>
</span><span id="CoordinateSystem-248"><a href="#CoordinateSystem-248"><span class="linenos">248</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-249"><a href="#CoordinateSystem-249"><span class="linenos">249</span></a>
</span><span id="CoordinateSystem-250"><a href="#CoordinateSystem-250"><span class="linenos">250</span></a>    <span class="nd">@classmethod</span>
</span><span id="CoordinateSystem-251"><a href="#CoordinateSystem-251"><span class="linenos">251</span></a>    <span class="k">def</span> <span class="nf">from_affine_matrix</span><span class="p">(</span>
</span><span id="CoordinateSystem-252"><a href="#CoordinateSystem-252"><span class="linenos">252</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="CoordinateSystem-253"><a href="#CoordinateSystem-253"><span class="linenos">253</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="CoordinateSystem-254"><a href="#CoordinateSystem-254"><span class="linenos">254</span></a>        <span class="n">affine_matrix</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CoordinateSystem-255"><a href="#CoordinateSystem-255"><span class="linenos">255</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-256"><a href="#CoordinateSystem-256"><span class="linenos">256</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-257"><a href="#CoordinateSystem-257"><span class="linenos">257</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create coordinate system from an affine matrix</span>
</span><span id="CoordinateSystem-258"><a href="#CoordinateSystem-258"><span class="linenos">258</span></a>
</span><span id="CoordinateSystem-259"><a href="#CoordinateSystem-259"><span class="linenos">259</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem-260"><a href="#CoordinateSystem-260"><span class="linenos">260</span></a><span class="sd">            spatial_shape: Spatial shape of the grid</span>
</span><span id="CoordinateSystem-261"><a href="#CoordinateSystem-261"><span class="linenos">261</span></a><span class="sd">            affine_matrix: Affine matrix describing the transformation</span>
</span><span id="CoordinateSystem-262"><a href="#CoordinateSystem-262"><span class="linenos">262</span></a><span class="sd">                from voxel to world coordinates. Tensor with shape</span>
</span><span id="CoordinateSystem-263"><a href="#CoordinateSystem-263"><span class="linenos">263</span></a><span class="sd">                ([*batch_shape, ]n_output_dims + 1, n_input_dims + 1).</span>
</span><span id="CoordinateSystem-264"><a href="#CoordinateSystem-264"><span class="linenos">264</span></a><span class="sd">                The affine matrix tensor should be provided on the host (cpu).</span>
</span><span id="CoordinateSystem-265"><a href="#CoordinateSystem-265"><span class="linenos">265</span></a><span class="sd">                That is, since the transformation may be used in control flow</span>
</span><span id="CoordinateSystem-266"><a href="#CoordinateSystem-266"><span class="linenos">266</span></a><span class="sd">                decisions, and we want to avoid synchronizing the target device</span>
</span><span id="CoordinateSystem-267"><a href="#CoordinateSystem-267"><span class="linenos">267</span></a><span class="sd">                with the host. The matrix is moved to the target device</span>
</span><span id="CoordinateSystem-268"><a href="#CoordinateSystem-268"><span class="linenos">268</span></a><span class="sd">                asynchronously, if needed.</span>
</span><span id="CoordinateSystem-269"><a href="#CoordinateSystem-269"><span class="linenos">269</span></a><span class="sd">            device: Device of the created coordinate system.</span>
</span><span id="CoordinateSystem-270"><a href="#CoordinateSystem-270"><span class="linenos">270</span></a>
</span><span id="CoordinateSystem-271"><a href="#CoordinateSystem-271"><span class="linenos">271</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem-272"><a href="#CoordinateSystem-272"><span class="linenos">272</span></a><span class="sd">            Coordinate system with the given affine matrix.</span>
</span><span id="CoordinateSystem-273"><a href="#CoordinateSystem-273"><span class="linenos">273</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-274"><a href="#CoordinateSystem-274"><span class="linenos">274</span></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">_ensure_tensor_on_host</span><span class="p">(</span><span class="n">affine_matrix</span><span class="p">)</span>
</span><span id="CoordinateSystem-275"><a href="#CoordinateSystem-275"><span class="linenos">275</span></a>        <span class="k">return</span> <span class="n">CoordinateSystem</span><span class="p">(</span>
</span><span id="CoordinateSystem-276"><a href="#CoordinateSystem-276"><span class="linenos">276</span></a>            <span class="n">from_voxel_coordinates</span><span class="o">=</span><span class="n">HostAffineTransformation</span><span class="p">(</span>
</span><span id="CoordinateSystem-277"><a href="#CoordinateSystem-277"><span class="linenos">277</span></a>                <span class="n">affine_matrix</span><span class="p">,</span>
</span><span id="CoordinateSystem-278"><a href="#CoordinateSystem-278"><span class="linenos">278</span></a>                <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="CoordinateSystem-279"><a href="#CoordinateSystem-279"><span class="linenos">279</span></a>            <span class="p">),</span>
</span><span id="CoordinateSystem-280"><a href="#CoordinateSystem-280"><span class="linenos">280</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem-281"><a href="#CoordinateSystem-281"><span class="linenos">281</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-282"><a href="#CoordinateSystem-282"><span class="linenos">282</span></a>
</span><span id="CoordinateSystem-283"><a href="#CoordinateSystem-283"><span class="linenos">283</span></a>    <span class="nd">@classmethod</span>
</span><span id="CoordinateSystem-284"><a href="#CoordinateSystem-284"><span class="linenos">284</span></a>    <span class="k">def</span> <span class="nf">from_diagonal_affine_matrix</span><span class="p">(</span>
</span><span id="CoordinateSystem-285"><a href="#CoordinateSystem-285"><span class="linenos">285</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="CoordinateSystem-286"><a href="#CoordinateSystem-286"><span class="linenos">286</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="CoordinateSystem-287"><a href="#CoordinateSystem-287"><span class="linenos">287</span></a>        <span class="n">diagonal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-288"><a href="#CoordinateSystem-288"><span class="linenos">288</span></a>        <span class="n">translation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-289"><a href="#CoordinateSystem-289"><span class="linenos">289</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-290"><a href="#CoordinateSystem-290"><span class="linenos">290</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-291"><a href="#CoordinateSystem-291"><span class="linenos">291</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-292"><a href="#CoordinateSystem-292"><span class="linenos">292</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create coordinate system from diagonal affine matrix</span>
</span><span id="CoordinateSystem-293"><a href="#CoordinateSystem-293"><span class="linenos">293</span></a>
</span><span id="CoordinateSystem-294"><a href="#CoordinateSystem-294"><span class="linenos">294</span></a><span class="sd">        The diagonal and the translation should be provided on the host (cpu).</span>
</span><span id="CoordinateSystem-295"><a href="#CoordinateSystem-295"><span class="linenos">295</span></a><span class="sd">        That is, since the transformation may be used in control flow decisions,</span>
</span><span id="CoordinateSystem-296"><a href="#CoordinateSystem-296"><span class="linenos">296</span></a><span class="sd">        and we want to avoid synchronizing the target device with the host. The</span>
</span><span id="CoordinateSystem-297"><a href="#CoordinateSystem-297"><span class="linenos">297</span></a><span class="sd">        matrix is moved to the target device asynchronously, if needed.</span>
</span><span id="CoordinateSystem-298"><a href="#CoordinateSystem-298"><span class="linenos">298</span></a>
</span><span id="CoordinateSystem-299"><a href="#CoordinateSystem-299"><span class="linenos">299</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem-300"><a href="#CoordinateSystem-300"><span class="linenos">300</span></a><span class="sd">            spatial_shape: Spatial shape of the created grid</span>
</span><span id="CoordinateSystem-301"><a href="#CoordinateSystem-301"><span class="linenos">301</span></a><span class="sd">            diagonal: Diagonal of the affine transformation matrix describing</span>
</span><span id="CoordinateSystem-302"><a href="#CoordinateSystem-302"><span class="linenos">302</span></a><span class="sd">                the transformation from voxel to world coordinates. Tensor</span>
</span><span id="CoordinateSystem-303"><a href="#CoordinateSystem-303"><span class="linenos">303</span></a><span class="sd">                with shape ([*batch_shape, ]diagonal_length[, *spatial_shape]).</span>
</span><span id="CoordinateSystem-304"><a href="#CoordinateSystem-304"><span class="linenos">304</span></a><span class="sd">            translation: Translation of the affine transformation describing</span>
</span><span id="CoordinateSystem-305"><a href="#CoordinateSystem-305"><span class="linenos">305</span></a><span class="sd">                the transformation from voxel to world coordinates. Tensor with</span>
</span><span id="CoordinateSystem-306"><a href="#CoordinateSystem-306"><span class="linenos">306</span></a><span class="sd">                shape ([*batch_shape, ]n_output_dims[, *spatial_shape]).</span>
</span><span id="CoordinateSystem-307"><a href="#CoordinateSystem-307"><span class="linenos">307</span></a><span class="sd">            dtype: Data type of the created coordinate system.</span>
</span><span id="CoordinateSystem-308"><a href="#CoordinateSystem-308"><span class="linenos">308</span></a><span class="sd">            device: Device of the created coordinate system.</span>
</span><span id="CoordinateSystem-309"><a href="#CoordinateSystem-309"><span class="linenos">309</span></a>
</span><span id="CoordinateSystem-310"><a href="#CoordinateSystem-310"><span class="linenos">310</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem-311"><a href="#CoordinateSystem-311"><span class="linenos">311</span></a><span class="sd">            Coordinate system with the given diagonal affine matrix.</span>
</span><span id="CoordinateSystem-312"><a href="#CoordinateSystem-312"><span class="linenos">312</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-313"><a href="#CoordinateSystem-313"><span class="linenos">313</span></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">_ensure_tensor_on_host</span><span class="p">(</span><span class="n">diagonal</span><span class="p">)</span>
</span><span id="CoordinateSystem-314"><a href="#CoordinateSystem-314"><span class="linenos">314</span></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">_ensure_tensor_on_host</span><span class="p">(</span><span class="n">translation</span><span class="p">)</span>
</span><span id="CoordinateSystem-315"><a href="#CoordinateSystem-315"><span class="linenos">315</span></a>        <span class="n">n_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem-316"><a href="#CoordinateSystem-316"><span class="linenos">316</span></a>        <span class="k">return</span> <span class="n">CoordinateSystem</span><span class="p">(</span>
</span><span id="CoordinateSystem-317"><a href="#CoordinateSystem-317"><span class="linenos">317</span></a>            <span class="n">from_voxel_coordinates</span><span class="o">=</span><span class="n">HostDiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="CoordinateSystem-318"><a href="#CoordinateSystem-318"><span class="linenos">318</span></a>                <span class="n">diagonal</span><span class="o">=</span><span class="n">diagonal</span><span class="p">,</span>
</span><span id="CoordinateSystem-319"><a href="#CoordinateSystem-319"><span class="linenos">319</span></a>                <span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">,</span>
</span><span id="CoordinateSystem-320"><a href="#CoordinateSystem-320"><span class="linenos">320</span></a>                <span class="n">matrix_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="CoordinateSystem-321"><a href="#CoordinateSystem-321"><span class="linenos">321</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="CoordinateSystem-322"><a href="#CoordinateSystem-322"><span class="linenos">322</span></a>                <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="CoordinateSystem-323"><a href="#CoordinateSystem-323"><span class="linenos">323</span></a>            <span class="p">),</span>
</span><span id="CoordinateSystem-324"><a href="#CoordinateSystem-324"><span class="linenos">324</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem-325"><a href="#CoordinateSystem-325"><span class="linenos">325</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-326"><a href="#CoordinateSystem-326"><span class="linenos">326</span></a>
</span><span id="CoordinateSystem-327"><a href="#CoordinateSystem-327"><span class="linenos">327</span></a>    <span class="nd">@property</span>
</span><span id="CoordinateSystem-328"><a href="#CoordinateSystem-328"><span class="linenos">328</span></a>    <span class="k">def</span> <span class="nf">coordinate_system</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-329"><a href="#CoordinateSystem-329"><span class="linenos">329</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="CoordinateSystem-330"><a href="#CoordinateSystem-330"><span class="linenos">330</span></a>
</span><span id="CoordinateSystem-331"><a href="#CoordinateSystem-331"><span class="linenos">331</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem-332"><a href="#CoordinateSystem-332"><span class="linenos">332</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Dummy forward pass to make the coordinate system a torch.nn.Module&quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-333"><a href="#CoordinateSystem-333"><span class="linenos">333</span></a>
</span><span id="CoordinateSystem-334"><a href="#CoordinateSystem-334"><span class="linenos">334</span></a>    <span class="nd">@property</span>
</span><span id="CoordinateSystem-335"><a href="#CoordinateSystem-335"><span class="linenos">335</span></a>    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch_dtype</span><span class="p">:</span>
</span><span id="CoordinateSystem-336"><a href="#CoordinateSystem-336"><span class="linenos">336</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">(</span><span class="s2">&quot;_indicator&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="CoordinateSystem-337"><a href="#CoordinateSystem-337"><span class="linenos">337</span></a>
</span><span id="CoordinateSystem-338"><a href="#CoordinateSystem-338"><span class="linenos">338</span></a>    <span class="nd">@property</span>
</span><span id="CoordinateSystem-339"><a href="#CoordinateSystem-339"><span class="linenos">339</span></a>    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch_device</span><span class="p">:</span>
</span><span id="CoordinateSystem-340"><a href="#CoordinateSystem-340"><span class="linenos">340</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">(</span><span class="s2">&quot;_indicator&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">device</span>
</span><span id="CoordinateSystem-341"><a href="#CoordinateSystem-341"><span class="linenos">341</span></a>
</span><span id="CoordinateSystem-342"><a href="#CoordinateSystem-342"><span class="linenos">342</span></a>    <span class="nd">@property</span>
</span><span id="CoordinateSystem-343"><a href="#CoordinateSystem-343"><span class="linenos">343</span></a>    <span class="k">def</span> <span class="nf">from_voxel_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Affine</span><span class="p">:</span>
</span><span id="CoordinateSystem-344"><a href="#CoordinateSystem-344"><span class="linenos">344</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Affine mapping from voxel to world coordinates&quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-345"><a href="#CoordinateSystem-345"><span class="linenos">345</span></a>        <span class="k">return</span> <span class="n">Affine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="p">)</span>
</span><span id="CoordinateSystem-346"><a href="#CoordinateSystem-346"><span class="linenos">346</span></a>
</span><span id="CoordinateSystem-347"><a href="#CoordinateSystem-347"><span class="linenos">347</span></a>    <span class="nd">@property</span>
</span><span id="CoordinateSystem-348"><a href="#CoordinateSystem-348"><span class="linenos">348</span></a>    <span class="k">def</span> <span class="nf">to_voxel_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Affine</span><span class="p">:</span>
</span><span id="CoordinateSystem-349"><a href="#CoordinateSystem-349"><span class="linenos">349</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Affine mapping from world to voxel coordinates&quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-350"><a href="#CoordinateSystem-350"><span class="linenos">350</span></a>        <span class="k">return</span> <span class="n">Affine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_voxel_coordinates</span><span class="p">)</span>
</span><span id="CoordinateSystem-351"><a href="#CoordinateSystem-351"><span class="linenos">351</span></a>
</span><span id="CoordinateSystem-352"><a href="#CoordinateSystem-352"><span class="linenos">352</span></a>    <span class="nd">@property</span>
</span><span id="CoordinateSystem-353"><a href="#CoordinateSystem-353"><span class="linenos">353</span></a>    <span class="k">def</span> <span class="nf">spatial_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="CoordinateSystem-354"><a href="#CoordinateSystem-354"><span class="linenos">354</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Spatial shape of the coordinate system grid&quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-355"><a href="#CoordinateSystem-355"><span class="linenos">355</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span>
</span><span id="CoordinateSystem-356"><a href="#CoordinateSystem-356"><span class="linenos">356</span></a>
</span><span id="CoordinateSystem-357"><a href="#CoordinateSystem-357"><span class="linenos">357</span></a>    <span class="k">def</span> <span class="nf">grid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="CoordinateSystem-358"><a href="#CoordinateSystem-358"><span class="linenos">358</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Grid in the world coordinates&quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-359"><a href="#CoordinateSystem-359"><span class="linenos">359</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_voxel_coordinates</span><span class="p">(</span>
</span><span id="CoordinateSystem-360"><a href="#CoordinateSystem-360"><span class="linenos">360</span></a>            <span class="n">voxel_grid</span><span class="p">(</span>
</span><span id="CoordinateSystem-361"><a href="#CoordinateSystem-361"><span class="linenos">361</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem-362"><a href="#CoordinateSystem-362"><span class="linenos">362</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="CoordinateSystem-363"><a href="#CoordinateSystem-363"><span class="linenos">363</span></a>                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="CoordinateSystem-364"><a href="#CoordinateSystem-364"><span class="linenos">364</span></a>            <span class="p">)</span>
</span><span id="CoordinateSystem-365"><a href="#CoordinateSystem-365"><span class="linenos">365</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-366"><a href="#CoordinateSystem-366"><span class="linenos">366</span></a>
</span><span id="CoordinateSystem-367"><a href="#CoordinateSystem-367"><span class="linenos">367</span></a>    <span class="k">def</span> <span class="nf">voxel_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="CoordinateSystem-368"><a href="#CoordinateSystem-368"><span class="linenos">368</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Grid in the voxel coordinates&quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-369"><a href="#CoordinateSystem-369"><span class="linenos">369</span></a>        <span class="k">return</span> <span class="n">voxel_grid</span><span class="p">(</span><span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="CoordinateSystem-370"><a href="#CoordinateSystem-370"><span class="linenos">370</span></a>
</span><span id="CoordinateSystem-371"><a href="#CoordinateSystem-371"><span class="linenos">371</span></a>    <span class="nd">@staticmethod</span>
</span><span id="CoordinateSystem-372"><a href="#CoordinateSystem-372"><span class="linenos">372</span></a>    <span class="k">def</span> <span class="nf">_calculate_voxel_size</span><span class="p">(</span><span class="n">affine_matrix</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="CoordinateSystem-373"><a href="#CoordinateSystem-373"><span class="linenos">373</span></a>        <span class="n">channel_dims</span> <span class="o">=</span> <span class="n">get_channel_dims</span><span class="p">(</span><span class="n">affine_matrix</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="CoordinateSystem-374"><a href="#CoordinateSystem-374"><span class="linenos">374</span></a>        <span class="n">row_dim</span> <span class="o">=</span> <span class="n">channel_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CoordinateSystem-375"><a href="#CoordinateSystem-375"><span class="linenos">375</span></a>        <span class="n">col_dim</span> <span class="o">=</span> <span class="n">channel_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CoordinateSystem-376"><a href="#CoordinateSystem-376"><span class="linenos">376</span></a>        <span class="n">matrix</span> <span class="o">=</span> <span class="n">affine_matrix</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="n">row_dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">affine_matrix</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">row_dim</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="CoordinateSystem-377"><a href="#CoordinateSystem-377"><span class="linenos">377</span></a>        <span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="n">col_dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">affine_matrix</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">col_dim</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="CoordinateSystem-378"><a href="#CoordinateSystem-378"><span class="linenos">378</span></a>        <span class="k">return</span> <span class="n">matrix</span><span class="o">.</span><span class="n">square</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">row_dim</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
</span><span id="CoordinateSystem-379"><a href="#CoordinateSystem-379"><span class="linenos">379</span></a>
</span><span id="CoordinateSystem-380"><a href="#CoordinateSystem-380"><span class="linenos">380</span></a>    <span class="k">def</span> <span class="nf">grid_spacing_cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="CoordinateSystem-381"><a href="#CoordinateSystem-381"><span class="linenos">381</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain grid spacing as a CPU tensor&quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-382"><a href="#CoordinateSystem-382"><span class="linenos">382</span></a>        <span class="n">diagonal_on_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="o">.</span><span class="n">as_host_diagonal</span><span class="p">()</span>
</span><span id="CoordinateSystem-383"><a href="#CoordinateSystem-383"><span class="linenos">383</span></a>        <span class="k">if</span> <span class="n">diagonal_on_host</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem-384"><a href="#CoordinateSystem-384"><span class="linenos">384</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_voxel_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="o">.</span><span class="n">as_host_matrix</span><span class="p">())</span>
</span><span id="CoordinateSystem-385"><a href="#CoordinateSystem-385"><span class="linenos">385</span></a>        <span class="k">return</span> <span class="n">diagonal_on_host</span><span class="o">.</span><span class="n">generate_diagonal</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
</span><span id="CoordinateSystem-386"><a href="#CoordinateSystem-386"><span class="linenos">386</span></a>
</span><span id="CoordinateSystem-387"><a href="#CoordinateSystem-387"><span class="linenos">387</span></a>    <span class="k">def</span> <span class="nf">grid_spacing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="CoordinateSystem-388"><a href="#CoordinateSystem-388"><span class="linenos">388</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain grid spacing on the target device&quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-389"><a href="#CoordinateSystem-389"><span class="linenos">389</span></a>        <span class="n">diagonal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="o">.</span><span class="n">as_diagonal</span><span class="p">()</span>
</span><span id="CoordinateSystem-390"><a href="#CoordinateSystem-390"><span class="linenos">390</span></a>        <span class="k">if</span> <span class="n">diagonal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem-391"><a href="#CoordinateSystem-391"><span class="linenos">391</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_voxel_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">())</span>
</span><span id="CoordinateSystem-392"><a href="#CoordinateSystem-392"><span class="linenos">392</span></a>        <span class="k">return</span> <span class="n">diagonal</span><span class="o">.</span><span class="n">generate_diagonal</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
</span><span id="CoordinateSystem-393"><a href="#CoordinateSystem-393"><span class="linenos">393</span></a>
</span><span id="CoordinateSystem-394"><a href="#CoordinateSystem-394"><span class="linenos">394</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="CoordinateSystem-395"><a href="#CoordinateSystem-395"><span class="linenos">395</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="CoordinateSystem-396"><a href="#CoordinateSystem-396"><span class="linenos">396</span></a>            <span class="s2">&quot;CoordinateSystem(&quot;</span>
</span><span id="CoordinateSystem-397"><a href="#CoordinateSystem-397"><span class="linenos">397</span></a>            <span class="sa">f</span><span class="s2">&quot;spatial_shape=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="CoordinateSystem-398"><a href="#CoordinateSystem-398"><span class="linenos">398</span></a>            <span class="sa">f</span><span class="s2">&quot;to_voxel_coordinates=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_voxel_coordinates</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="CoordinateSystem-399"><a href="#CoordinateSystem-399"><span class="linenos">399</span></a>            <span class="sa">f</span><span class="s2">&quot;from_voxel_coordinates=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">from_voxel_coordinates</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="CoordinateSystem-400"><a href="#CoordinateSystem-400"><span class="linenos">400</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-401"><a href="#CoordinateSystem-401"><span class="linenos">401</span></a>
</span><span id="CoordinateSystem-402"><a href="#CoordinateSystem-402"><span class="linenos">402</span></a>    <span class="k">def</span> <span class="nf">transform_voxel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">affine_matrix</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-403"><a href="#CoordinateSystem-403"><span class="linenos">403</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform the coordinates with an affine matrix in the</span>
</span><span id="CoordinateSystem-404"><a href="#CoordinateSystem-404"><span class="linenos">404</span></a><span class="sd">        voxel coordinates before applying the current affine transformation</span>
</span><span id="CoordinateSystem-405"><a href="#CoordinateSystem-405"><span class="linenos">405</span></a>
</span><span id="CoordinateSystem-406"><a href="#CoordinateSystem-406"><span class="linenos">406</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem-407"><a href="#CoordinateSystem-407"><span class="linenos">407</span></a><span class="sd">            affine_matrix: Affine matrix describing the transformation</span>
</span><span id="CoordinateSystem-408"><a href="#CoordinateSystem-408"><span class="linenos">408</span></a><span class="sd">                in the voxel coordinates. Tensor with shape</span>
</span><span id="CoordinateSystem-409"><a href="#CoordinateSystem-409"><span class="linenos">409</span></a><span class="sd">                ([*batch_shape, ]n_output_dims + 1, n_spatial_dims + 1).</span>
</span><span id="CoordinateSystem-410"><a href="#CoordinateSystem-410"><span class="linenos">410</span></a><span class="sd">                The affine matrix tensor should be provided on the host (cpu).</span>
</span><span id="CoordinateSystem-411"><a href="#CoordinateSystem-411"><span class="linenos">411</span></a><span class="sd">                That is, since the transformation may be used in control flow</span>
</span><span id="CoordinateSystem-412"><a href="#CoordinateSystem-412"><span class="linenos">412</span></a><span class="sd">                decisions, and we want to avoid synchronizing the target device</span>
</span><span id="CoordinateSystem-413"><a href="#CoordinateSystem-413"><span class="linenos">413</span></a><span class="sd">                with the host. The matrix is moved to the target device</span>
</span><span id="CoordinateSystem-414"><a href="#CoordinateSystem-414"><span class="linenos">414</span></a><span class="sd">                asynchronously, if needed.</span>
</span><span id="CoordinateSystem-415"><a href="#CoordinateSystem-415"><span class="linenos">415</span></a>
</span><span id="CoordinateSystem-416"><a href="#CoordinateSystem-416"><span class="linenos">416</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem-417"><a href="#CoordinateSystem-417"><span class="linenos">417</span></a><span class="sd">            Coordinate system with a modified affine transformation from voxel</span>
</span><span id="CoordinateSystem-418"><a href="#CoordinateSystem-418"><span class="linenos">418</span></a><span class="sd">            to world coordinates.</span>
</span><span id="CoordinateSystem-419"><a href="#CoordinateSystem-419"><span class="linenos">419</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-420"><a href="#CoordinateSystem-420"><span class="linenos">420</span></a>        <span class="k">return</span> <span class="n">CoordinateSystem</span><span class="p">(</span>
</span><span id="CoordinateSystem-421"><a href="#CoordinateSystem-421"><span class="linenos">421</span></a>            <span class="n">from_voxel_coordinates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span>
</span><span id="CoordinateSystem-422"><a href="#CoordinateSystem-422"><span class="linenos">422</span></a>            <span class="o">@</span> <span class="n">HostAffineTransformation</span><span class="p">(</span><span class="n">affine_matrix</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
</span><span id="CoordinateSystem-423"><a href="#CoordinateSystem-423"><span class="linenos">423</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem-424"><a href="#CoordinateSystem-424"><span class="linenos">424</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-425"><a href="#CoordinateSystem-425"><span class="linenos">425</span></a>
</span><span id="CoordinateSystem-426"><a href="#CoordinateSystem-426"><span class="linenos">426</span></a>    <span class="k">def</span> <span class="nf">transform_voxel_with_diagonal_matrix</span><span class="p">(</span>
</span><span id="CoordinateSystem-427"><a href="#CoordinateSystem-427"><span class="linenos">427</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CoordinateSystem-428"><a href="#CoordinateSystem-428"><span class="linenos">428</span></a>        <span class="n">diagonal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-429"><a href="#CoordinateSystem-429"><span class="linenos">429</span></a>        <span class="n">translation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-430"><a href="#CoordinateSystem-430"><span class="linenos">430</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-431"><a href="#CoordinateSystem-431"><span class="linenos">431</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform the coordinates with a diagonal affine matrix in the</span>
</span><span id="CoordinateSystem-432"><a href="#CoordinateSystem-432"><span class="linenos">432</span></a><span class="sd">        voxel coordinates before applying the current affine transformation.</span>
</span><span id="CoordinateSystem-433"><a href="#CoordinateSystem-433"><span class="linenos">433</span></a>
</span><span id="CoordinateSystem-434"><a href="#CoordinateSystem-434"><span class="linenos">434</span></a><span class="sd">        The diagonal and the translation should be provided on the host (cpu).</span>
</span><span id="CoordinateSystem-435"><a href="#CoordinateSystem-435"><span class="linenos">435</span></a><span class="sd">        That is, since the transformation may be used in control flow decisions,</span>
</span><span id="CoordinateSystem-436"><a href="#CoordinateSystem-436"><span class="linenos">436</span></a><span class="sd">        and we want to avoid synchronizing the target device with the host. The</span>
</span><span id="CoordinateSystem-437"><a href="#CoordinateSystem-437"><span class="linenos">437</span></a><span class="sd">        matrix is moved to the target device asynchronously, if needed.</span>
</span><span id="CoordinateSystem-438"><a href="#CoordinateSystem-438"><span class="linenos">438</span></a>
</span><span id="CoordinateSystem-439"><a href="#CoordinateSystem-439"><span class="linenos">439</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem-440"><a href="#CoordinateSystem-440"><span class="linenos">440</span></a><span class="sd">            diagonal: Diagonal of the affine transformation matrix with shape</span>
</span><span id="CoordinateSystem-441"><a href="#CoordinateSystem-441"><span class="linenos">441</span></a><span class="sd">                ([*batch_shape, ]n_spatial_dims). Can be also</span>
</span><span id="CoordinateSystem-442"><a href="#CoordinateSystem-442"><span class="linenos">442</span></a><span class="sd">                given as a number or sequence of numbers. If None, corresponds</span>
</span><span id="CoordinateSystem-443"><a href="#CoordinateSystem-443"><span class="linenos">443</span></a><span class="sd">                to the diagonal of ones.</span>
</span><span id="CoordinateSystem-444"><a href="#CoordinateSystem-444"><span class="linenos">444</span></a><span class="sd">            translation: Translation of the affine transformation matrix</span>
</span><span id="CoordinateSystem-445"><a href="#CoordinateSystem-445"><span class="linenos">445</span></a><span class="sd">                with shape ([*batch_shape, ]n_spatial_dims).</span>
</span><span id="CoordinateSystem-446"><a href="#CoordinateSystem-446"><span class="linenos">446</span></a><span class="sd">                Can be also given as a number or sequence of numbers. If None,</span>
</span><span id="CoordinateSystem-447"><a href="#CoordinateSystem-447"><span class="linenos">447</span></a><span class="sd">                corresponds to the zero translation.</span>
</span><span id="CoordinateSystem-448"><a href="#CoordinateSystem-448"><span class="linenos">448</span></a>
</span><span id="CoordinateSystem-449"><a href="#CoordinateSystem-449"><span class="linenos">449</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem-450"><a href="#CoordinateSystem-450"><span class="linenos">450</span></a><span class="sd">            Coordinate system with a modified affine transformation from voxel</span>
</span><span id="CoordinateSystem-451"><a href="#CoordinateSystem-451"><span class="linenos">451</span></a><span class="sd">            to world coordinates.</span>
</span><span id="CoordinateSystem-452"><a href="#CoordinateSystem-452"><span class="linenos">452</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-453"><a href="#CoordinateSystem-453"><span class="linenos">453</span></a>        <span class="n">n_spatial_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem-454"><a href="#CoordinateSystem-454"><span class="linenos">454</span></a>        <span class="k">return</span> <span class="n">CoordinateSystem</span><span class="p">(</span>
</span><span id="CoordinateSystem-455"><a href="#CoordinateSystem-455"><span class="linenos">455</span></a>            <span class="n">from_voxel_coordinates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span>
</span><span id="CoordinateSystem-456"><a href="#CoordinateSystem-456"><span class="linenos">456</span></a>            <span class="o">@</span> <span class="n">HostDiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="CoordinateSystem-457"><a href="#CoordinateSystem-457"><span class="linenos">457</span></a>                <span class="n">diagonal</span><span class="o">=</span><span class="n">diagonal</span><span class="p">,</span>
</span><span id="CoordinateSystem-458"><a href="#CoordinateSystem-458"><span class="linenos">458</span></a>                <span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">,</span>
</span><span id="CoordinateSystem-459"><a href="#CoordinateSystem-459"><span class="linenos">459</span></a>                <span class="n">matrix_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_spatial_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_spatial_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="CoordinateSystem-460"><a href="#CoordinateSystem-460"><span class="linenos">460</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="CoordinateSystem-461"><a href="#CoordinateSystem-461"><span class="linenos">461</span></a>                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="CoordinateSystem-462"><a href="#CoordinateSystem-462"><span class="linenos">462</span></a>            <span class="p">),</span>
</span><span id="CoordinateSystem-463"><a href="#CoordinateSystem-463"><span class="linenos">463</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem-464"><a href="#CoordinateSystem-464"><span class="linenos">464</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-465"><a href="#CoordinateSystem-465"><span class="linenos">465</span></a>
</span><span id="CoordinateSystem-466"><a href="#CoordinateSystem-466"><span class="linenos">466</span></a>    <span class="k">def</span> <span class="nf">transform_world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">affine_matrix</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-467"><a href="#CoordinateSystem-467"><span class="linenos">467</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform the coordinates with an affine matrix in the</span>
</span><span id="CoordinateSystem-468"><a href="#CoordinateSystem-468"><span class="linenos">468</span></a><span class="sd">        world coordinates after applying the current affine transformation</span>
</span><span id="CoordinateSystem-469"><a href="#CoordinateSystem-469"><span class="linenos">469</span></a>
</span><span id="CoordinateSystem-470"><a href="#CoordinateSystem-470"><span class="linenos">470</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem-471"><a href="#CoordinateSystem-471"><span class="linenos">471</span></a><span class="sd">            affine_matrix: Affine matrix describing the transformation</span>
</span><span id="CoordinateSystem-472"><a href="#CoordinateSystem-472"><span class="linenos">472</span></a><span class="sd">                in the world coordinates. Tensor with shape</span>
</span><span id="CoordinateSystem-473"><a href="#CoordinateSystem-473"><span class="linenos">473</span></a><span class="sd">                ([*batch_shape, ]n_output_dims + 1, n_input_dims + 1).</span>
</span><span id="CoordinateSystem-474"><a href="#CoordinateSystem-474"><span class="linenos">474</span></a><span class="sd">                The affine matrix tensor should be provided on the host (cpu).</span>
</span><span id="CoordinateSystem-475"><a href="#CoordinateSystem-475"><span class="linenos">475</span></a><span class="sd">                That is, since the transformation may be used in control flow</span>
</span><span id="CoordinateSystem-476"><a href="#CoordinateSystem-476"><span class="linenos">476</span></a><span class="sd">                decisions, and we want to avoid synchronizing the target device</span>
</span><span id="CoordinateSystem-477"><a href="#CoordinateSystem-477"><span class="linenos">477</span></a><span class="sd">                with the host. The matrix is moved to the target device</span>
</span><span id="CoordinateSystem-478"><a href="#CoordinateSystem-478"><span class="linenos">478</span></a><span class="sd">                asynchronously, if needed.</span>
</span><span id="CoordinateSystem-479"><a href="#CoordinateSystem-479"><span class="linenos">479</span></a>
</span><span id="CoordinateSystem-480"><a href="#CoordinateSystem-480"><span class="linenos">480</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem-481"><a href="#CoordinateSystem-481"><span class="linenos">481</span></a><span class="sd">            Coordinate system with a modified affine transformation from voxel</span>
</span><span id="CoordinateSystem-482"><a href="#CoordinateSystem-482"><span class="linenos">482</span></a><span class="sd">            to world coordinates.</span>
</span><span id="CoordinateSystem-483"><a href="#CoordinateSystem-483"><span class="linenos">483</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-484"><a href="#CoordinateSystem-484"><span class="linenos">484</span></a>        <span class="k">return</span> <span class="n">CoordinateSystem</span><span class="p">(</span>
</span><span id="CoordinateSystem-485"><a href="#CoordinateSystem-485"><span class="linenos">485</span></a>            <span class="n">from_voxel_coordinates</span><span class="o">=</span><span class="n">HostAffineTransformation</span><span class="p">(</span><span class="n">affine_matrix</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="CoordinateSystem-486"><a href="#CoordinateSystem-486"><span class="linenos">486</span></a>            <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="p">,</span>
</span><span id="CoordinateSystem-487"><a href="#CoordinateSystem-487"><span class="linenos">487</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem-488"><a href="#CoordinateSystem-488"><span class="linenos">488</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-489"><a href="#CoordinateSystem-489"><span class="linenos">489</span></a>
</span><span id="CoordinateSystem-490"><a href="#CoordinateSystem-490"><span class="linenos">490</span></a>    <span class="k">def</span> <span class="fm">__rmatmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">affine_matrix</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-491"><a href="#CoordinateSystem-491"><span class="linenos">491</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_world</span><span class="p">(</span><span class="n">affine_matrix</span><span class="p">)</span>
</span><span id="CoordinateSystem-492"><a href="#CoordinateSystem-492"><span class="linenos">492</span></a>
</span><span id="CoordinateSystem-493"><a href="#CoordinateSystem-493"><span class="linenos">493</span></a>    <span class="k">def</span> <span class="nf">transform_world_with_diagonal_matrix</span><span class="p">(</span>
</span><span id="CoordinateSystem-494"><a href="#CoordinateSystem-494"><span class="linenos">494</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CoordinateSystem-495"><a href="#CoordinateSystem-495"><span class="linenos">495</span></a>        <span class="n">diagonal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-496"><a href="#CoordinateSystem-496"><span class="linenos">496</span></a>        <span class="n">translation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-497"><a href="#CoordinateSystem-497"><span class="linenos">497</span></a>        <span class="n">n_output_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-498"><a href="#CoordinateSystem-498"><span class="linenos">498</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-499"><a href="#CoordinateSystem-499"><span class="linenos">499</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform the coordinates with a diagonal affine matrix in the</span>
</span><span id="CoordinateSystem-500"><a href="#CoordinateSystem-500"><span class="linenos">500</span></a><span class="sd">        world coordinates after applying the current affine transformation</span>
</span><span id="CoordinateSystem-501"><a href="#CoordinateSystem-501"><span class="linenos">501</span></a>
</span><span id="CoordinateSystem-502"><a href="#CoordinateSystem-502"><span class="linenos">502</span></a><span class="sd">        The diagonal and the translation should be provided on the host (cpu).</span>
</span><span id="CoordinateSystem-503"><a href="#CoordinateSystem-503"><span class="linenos">503</span></a><span class="sd">        That is, since the transformation may be used in control flow decisions,</span>
</span><span id="CoordinateSystem-504"><a href="#CoordinateSystem-504"><span class="linenos">504</span></a><span class="sd">        and we want to avoid synchronizing the target device with the host. The</span>
</span><span id="CoordinateSystem-505"><a href="#CoordinateSystem-505"><span class="linenos">505</span></a><span class="sd">        matrix is moved to the target device asynchronously, if needed.</span>
</span><span id="CoordinateSystem-506"><a href="#CoordinateSystem-506"><span class="linenos">506</span></a>
</span><span id="CoordinateSystem-507"><a href="#CoordinateSystem-507"><span class="linenos">507</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem-508"><a href="#CoordinateSystem-508"><span class="linenos">508</span></a><span class="sd">            diagonal: Diagonal of the affine transformation matrix with shape</span>
</span><span id="CoordinateSystem-509"><a href="#CoordinateSystem-509"><span class="linenos">509</span></a><span class="sd">                ([*batch_shape, ]diagonal_length). Can be also</span>
</span><span id="CoordinateSystem-510"><a href="#CoordinateSystem-510"><span class="linenos">510</span></a><span class="sd">                given as a number or sequence of numbers. If None, corresponds</span>
</span><span id="CoordinateSystem-511"><a href="#CoordinateSystem-511"><span class="linenos">511</span></a><span class="sd">                to the diagonal of ones.</span>
</span><span id="CoordinateSystem-512"><a href="#CoordinateSystem-512"><span class="linenos">512</span></a><span class="sd">            translation: Translation of the affine transformation matrix</span>
</span><span id="CoordinateSystem-513"><a href="#CoordinateSystem-513"><span class="linenos">513</span></a><span class="sd">                with shape ([*batch_shape, ]n_output_dims).</span>
</span><span id="CoordinateSystem-514"><a href="#CoordinateSystem-514"><span class="linenos">514</span></a><span class="sd">                Can be also given as a number or sequence of numbers. If None,</span>
</span><span id="CoordinateSystem-515"><a href="#CoordinateSystem-515"><span class="linenos">515</span></a><span class="sd">                corresponds to the zero translation.</span>
</span><span id="CoordinateSystem-516"><a href="#CoordinateSystem-516"><span class="linenos">516</span></a><span class="sd">            n_output_dims: Number of output dimensions of the transformation.</span>
</span><span id="CoordinateSystem-517"><a href="#CoordinateSystem-517"><span class="linenos">517</span></a>
</span><span id="CoordinateSystem-518"><a href="#CoordinateSystem-518"><span class="linenos">518</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem-519"><a href="#CoordinateSystem-519"><span class="linenos">519</span></a><span class="sd">            Coordinate system with a modified affine transformation from voxel</span>
</span><span id="CoordinateSystem-520"><a href="#CoordinateSystem-520"><span class="linenos">520</span></a><span class="sd">            to world coordinates.</span>
</span><span id="CoordinateSystem-521"><a href="#CoordinateSystem-521"><span class="linenos">521</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-522"><a href="#CoordinateSystem-522"><span class="linenos">522</span></a>        <span class="n">n_input_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="CoordinateSystem-523"><a href="#CoordinateSystem-523"><span class="linenos">523</span></a>        <span class="k">if</span> <span class="n">n_output_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem-524"><a href="#CoordinateSystem-524"><span class="linenos">524</span></a>            <span class="n">n_output_dims</span> <span class="o">=</span> <span class="n">n_input_dims</span>
</span><span id="CoordinateSystem-525"><a href="#CoordinateSystem-525"><span class="linenos">525</span></a>        <span class="k">return</span> <span class="n">CoordinateSystem</span><span class="p">(</span>
</span><span id="CoordinateSystem-526"><a href="#CoordinateSystem-526"><span class="linenos">526</span></a>            <span class="n">from_voxel_coordinates</span><span class="o">=</span><span class="n">HostDiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="CoordinateSystem-527"><a href="#CoordinateSystem-527"><span class="linenos">527</span></a>                <span class="n">diagonal</span><span class="o">=</span><span class="n">diagonal</span><span class="p">,</span>
</span><span id="CoordinateSystem-528"><a href="#CoordinateSystem-528"><span class="linenos">528</span></a>                <span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">,</span>
</span><span id="CoordinateSystem-529"><a href="#CoordinateSystem-529"><span class="linenos">529</span></a>                <span class="n">matrix_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_output_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_input_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="CoordinateSystem-530"><a href="#CoordinateSystem-530"><span class="linenos">530</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="CoordinateSystem-531"><a href="#CoordinateSystem-531"><span class="linenos">531</span></a>                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="CoordinateSystem-532"><a href="#CoordinateSystem-532"><span class="linenos">532</span></a>            <span class="p">)</span>
</span><span id="CoordinateSystem-533"><a href="#CoordinateSystem-533"><span class="linenos">533</span></a>            <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="p">,</span>
</span><span id="CoordinateSystem-534"><a href="#CoordinateSystem-534"><span class="linenos">534</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem-535"><a href="#CoordinateSystem-535"><span class="linenos">535</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-536"><a href="#CoordinateSystem-536"><span class="linenos">536</span></a>
</span><span id="CoordinateSystem-537"><a href="#CoordinateSystem-537"><span class="linenos">537</span></a>    <span class="k">def</span> <span class="nf">translate_voxel</span><span class="p">(</span>
</span><span id="CoordinateSystem-538"><a href="#CoordinateSystem-538"><span class="linenos">538</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">translation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span>
</span><span id="CoordinateSystem-539"><a href="#CoordinateSystem-539"><span class="linenos">539</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-540"><a href="#CoordinateSystem-540"><span class="linenos">540</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Translate the coordinates in the voxel coordinates before applying</span>
</span><span id="CoordinateSystem-541"><a href="#CoordinateSystem-541"><span class="linenos">541</span></a><span class="sd">        the current affine transformation</span>
</span><span id="CoordinateSystem-542"><a href="#CoordinateSystem-542"><span class="linenos">542</span></a>
</span><span id="CoordinateSystem-543"><a href="#CoordinateSystem-543"><span class="linenos">543</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem-544"><a href="#CoordinateSystem-544"><span class="linenos">544</span></a><span class="sd">            translation: Translation with shape ([*batch_shape, ]n_spatial_dims).</span>
</span><span id="CoordinateSystem-545"><a href="#CoordinateSystem-545"><span class="linenos">545</span></a><span class="sd">                Can be also given as a number or sequence of numbers.</span>
</span><span id="CoordinateSystem-546"><a href="#CoordinateSystem-546"><span class="linenos">546</span></a>
</span><span id="CoordinateSystem-547"><a href="#CoordinateSystem-547"><span class="linenos">547</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem-548"><a href="#CoordinateSystem-548"><span class="linenos">548</span></a><span class="sd">            Coordinate system with translated coordinates.</span>
</span><span id="CoordinateSystem-549"><a href="#CoordinateSystem-549"><span class="linenos">549</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-550"><a href="#CoordinateSystem-550"><span class="linenos">550</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_voxel_with_diagonal_matrix</span><span class="p">(</span><span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">)</span>
</span><span id="CoordinateSystem-551"><a href="#CoordinateSystem-551"><span class="linenos">551</span></a>
</span><span id="CoordinateSystem-552"><a href="#CoordinateSystem-552"><span class="linenos">552</span></a>    <span class="k">def</span> <span class="nf">translate_world</span><span class="p">(</span>
</span><span id="CoordinateSystem-553"><a href="#CoordinateSystem-553"><span class="linenos">553</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">translation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span>
</span><span id="CoordinateSystem-554"><a href="#CoordinateSystem-554"><span class="linenos">554</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-555"><a href="#CoordinateSystem-555"><span class="linenos">555</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Translate the coordinates in the world coordinates after applying</span>
</span><span id="CoordinateSystem-556"><a href="#CoordinateSystem-556"><span class="linenos">556</span></a><span class="sd">        the current affine transformation</span>
</span><span id="CoordinateSystem-557"><a href="#CoordinateSystem-557"><span class="linenos">557</span></a>
</span><span id="CoordinateSystem-558"><a href="#CoordinateSystem-558"><span class="linenos">558</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem-559"><a href="#CoordinateSystem-559"><span class="linenos">559</span></a><span class="sd">            translation: Translation with shape ([*batch_shape, ]n_output_dims).</span>
</span><span id="CoordinateSystem-560"><a href="#CoordinateSystem-560"><span class="linenos">560</span></a><span class="sd">                Can be also given as a number or sequence of numbers.</span>
</span><span id="CoordinateSystem-561"><a href="#CoordinateSystem-561"><span class="linenos">561</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-562"><a href="#CoordinateSystem-562"><span class="linenos">562</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_world_with_diagonal_matrix</span><span class="p">(</span><span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">)</span>
</span><span id="CoordinateSystem-563"><a href="#CoordinateSystem-563"><span class="linenos">563</span></a>
</span><span id="CoordinateSystem-564"><a href="#CoordinateSystem-564"><span class="linenos">564</span></a>    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-565"><a href="#CoordinateSystem-565"><span class="linenos">565</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate_world</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="CoordinateSystem-566"><a href="#CoordinateSystem-566"><span class="linenos">566</span></a>
</span><span id="CoordinateSystem-567"><a href="#CoordinateSystem-567"><span class="linenos">567</span></a>    <span class="k">def</span> <span class="nf">multiply_voxel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-568"><a href="#CoordinateSystem-568"><span class="linenos">568</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Multiply the coordinates in the voxel coordinates (before applying</span>
</span><span id="CoordinateSystem-569"><a href="#CoordinateSystem-569"><span class="linenos">569</span></a><span class="sd">        the current affine transformation)</span>
</span><span id="CoordinateSystem-570"><a href="#CoordinateSystem-570"><span class="linenos">570</span></a>
</span><span id="CoordinateSystem-571"><a href="#CoordinateSystem-571"><span class="linenos">571</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem-572"><a href="#CoordinateSystem-572"><span class="linenos">572</span></a><span class="sd">            factor: Factor to multiply the grid spacing. A tensor with shape</span>
</span><span id="CoordinateSystem-573"><a href="#CoordinateSystem-573"><span class="linenos">573</span></a><span class="sd">                ([*batch_shape, ]n_spatial_dims). Can be also given as a number</span>
</span><span id="CoordinateSystem-574"><a href="#CoordinateSystem-574"><span class="linenos">574</span></a><span class="sd">                or sequence of numbers.</span>
</span><span id="CoordinateSystem-575"><a href="#CoordinateSystem-575"><span class="linenos">575</span></a>
</span><span id="CoordinateSystem-576"><a href="#CoordinateSystem-576"><span class="linenos">576</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem-577"><a href="#CoordinateSystem-577"><span class="linenos">577</span></a><span class="sd">            Coordinate system with a modified affine transformation from voxel</span>
</span><span id="CoordinateSystem-578"><a href="#CoordinateSystem-578"><span class="linenos">578</span></a><span class="sd">            to world coordinates.</span>
</span><span id="CoordinateSystem-579"><a href="#CoordinateSystem-579"><span class="linenos">579</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-580"><a href="#CoordinateSystem-580"><span class="linenos">580</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_voxel_with_diagonal_matrix</span><span class="p">(</span><span class="n">diagonal</span><span class="o">=</span><span class="n">factor</span><span class="p">)</span>
</span><span id="CoordinateSystem-581"><a href="#CoordinateSystem-581"><span class="linenos">581</span></a>
</span><span id="CoordinateSystem-582"><a href="#CoordinateSystem-582"><span class="linenos">582</span></a>    <span class="k">def</span> <span class="nf">multiply_world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-583"><a href="#CoordinateSystem-583"><span class="linenos">583</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Multiply the coordinates in the world coordinates after applying</span>
</span><span id="CoordinateSystem-584"><a href="#CoordinateSystem-584"><span class="linenos">584</span></a><span class="sd">        the current affine transformation.</span>
</span><span id="CoordinateSystem-585"><a href="#CoordinateSystem-585"><span class="linenos">585</span></a>
</span><span id="CoordinateSystem-586"><a href="#CoordinateSystem-586"><span class="linenos">586</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem-587"><a href="#CoordinateSystem-587"><span class="linenos">587</span></a><span class="sd">            factor: Factor to multiply each dimension of the grid. A tensor with</span>
</span><span id="CoordinateSystem-588"><a href="#CoordinateSystem-588"><span class="linenos">588</span></a><span class="sd">                shape ([*batch_shape, ]n_output_dims). Can be also given as a number</span>
</span><span id="CoordinateSystem-589"><a href="#CoordinateSystem-589"><span class="linenos">589</span></a><span class="sd">                or sequence of numbers.</span>
</span><span id="CoordinateSystem-590"><a href="#CoordinateSystem-590"><span class="linenos">590</span></a>
</span><span id="CoordinateSystem-591"><a href="#CoordinateSystem-591"><span class="linenos">591</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem-592"><a href="#CoordinateSystem-592"><span class="linenos">592</span></a><span class="sd">            Coordinate system with a modified affine transformation from voxel</span>
</span><span id="CoordinateSystem-593"><a href="#CoordinateSystem-593"><span class="linenos">593</span></a><span class="sd">            to world coordinates.</span>
</span><span id="CoordinateSystem-594"><a href="#CoordinateSystem-594"><span class="linenos">594</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-595"><a href="#CoordinateSystem-595"><span class="linenos">595</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_world_with_diagonal_matrix</span><span class="p">(</span><span class="n">diagonal</span><span class="o">=</span><span class="n">factor</span><span class="p">)</span>
</span><span id="CoordinateSystem-596"><a href="#CoordinateSystem-596"><span class="linenos">596</span></a>
</span><span id="CoordinateSystem-597"><a href="#CoordinateSystem-597"><span class="linenos">597</span></a>    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-598"><a href="#CoordinateSystem-598"><span class="linenos">598</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiply_world</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="CoordinateSystem-599"><a href="#CoordinateSystem-599"><span class="linenos">599</span></a>
</span><span id="CoordinateSystem-600"><a href="#CoordinateSystem-600"><span class="linenos">600</span></a>    <span class="nd">@overload</span>
</span><span id="CoordinateSystem-601"><a href="#CoordinateSystem-601"><span class="linenos">601</span></a>    <span class="k">def</span> <span class="nf">reformat</span><span class="p">(</span>
</span><span id="CoordinateSystem-602"><a href="#CoordinateSystem-602"><span class="linenos">602</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CoordinateSystem-603"><a href="#CoordinateSystem-603"><span class="linenos">603</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="CoordinateSystem-604"><a href="#CoordinateSystem-604"><span class="linenos">604</span></a>        <span class="n">downsampling_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-605"><a href="#CoordinateSystem-605"><span class="linenos">605</span></a>        <span class="n">upsampling_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-606"><a href="#CoordinateSystem-606"><span class="linenos">606</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="CoordinateSystem-607"><a href="#CoordinateSystem-607"><span class="linenos">607</span></a>            <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ReformattingSpatialShape</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
</span><span id="CoordinateSystem-608"><a href="#CoordinateSystem-608"><span class="linenos">608</span></a>            <span class="n">ReformattingSpatialShape</span><span class="p">,</span>
</span><span id="CoordinateSystem-609"><a href="#CoordinateSystem-609"><span class="linenos">609</span></a>            <span class="nb">int</span><span class="p">,</span>
</span><span id="CoordinateSystem-610"><a href="#CoordinateSystem-610"><span class="linenos">610</span></a>            <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CoordinateSystem-611"><a href="#CoordinateSystem-611"><span class="linenos">611</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">OriginalFOV</span><span class="p">(</span><span class="n">fitting_method</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">fov_convention</span><span class="o">=</span><span class="s2">&quot;full_voxels&quot;</span><span class="p">),</span>
</span><span id="CoordinateSystem-612"><a href="#CoordinateSystem-612"><span class="linenos">612</span></a>        <span class="n">reference</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="CoordinateSystem-613"><a href="#CoordinateSystem-613"><span class="linenos">613</span></a>            <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ReformattingReference</span><span class="p">,</span> <span class="n">Number</span><span class="p">]],</span>
</span><span id="CoordinateSystem-614"><a href="#CoordinateSystem-614"><span class="linenos">614</span></a>            <span class="n">ReformattingReference</span><span class="p">,</span>
</span><span id="CoordinateSystem-615"><a href="#CoordinateSystem-615"><span class="linenos">615</span></a>            <span class="n">Number</span><span class="p">,</span>
</span><span id="CoordinateSystem-616"><a href="#CoordinateSystem-616"><span class="linenos">616</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">Center</span><span class="p">(),</span>
</span><span id="CoordinateSystem-617"><a href="#CoordinateSystem-617"><span class="linenos">617</span></a>        <span class="n">target_reference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="CoordinateSystem-618"><a href="#CoordinateSystem-618"><span class="linenos">618</span></a>            <span class="n">Union</span><span class="p">[</span>
</span><span id="CoordinateSystem-619"><a href="#CoordinateSystem-619"><span class="linenos">619</span></a>                <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ReformattingReference</span><span class="p">,</span> <span class="n">Number</span><span class="p">]],</span>
</span><span id="CoordinateSystem-620"><a href="#CoordinateSystem-620"><span class="linenos">620</span></a>                <span class="n">ReformattingReference</span><span class="p">,</span>
</span><span id="CoordinateSystem-621"><a href="#CoordinateSystem-621"><span class="linenos">621</span></a>                <span class="n">Number</span><span class="p">,</span>
</span><span id="CoordinateSystem-622"><a href="#CoordinateSystem-622"><span class="linenos">622</span></a>            <span class="p">]</span>
</span><span id="CoordinateSystem-623"><a href="#CoordinateSystem-623"><span class="linenos">623</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-624"><a href="#CoordinateSystem-624"><span class="linenos">624</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span> <span class="o">...</span>
</span><span id="CoordinateSystem-625"><a href="#CoordinateSystem-625"><span class="linenos">625</span></a>
</span><span id="CoordinateSystem-626"><a href="#CoordinateSystem-626"><span class="linenos">626</span></a>    <span class="nd">@overload</span>
</span><span id="CoordinateSystem-627"><a href="#CoordinateSystem-627"><span class="linenos">627</span></a>    <span class="k">def</span> <span class="nf">reformat</span><span class="p">(</span>
</span><span id="CoordinateSystem-628"><a href="#CoordinateSystem-628"><span class="linenos">628</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CoordinateSystem-629"><a href="#CoordinateSystem-629"><span class="linenos">629</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="CoordinateSystem-630"><a href="#CoordinateSystem-630"><span class="linenos">630</span></a>        <span class="n">voxel_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-631"><a href="#CoordinateSystem-631"><span class="linenos">631</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="CoordinateSystem-632"><a href="#CoordinateSystem-632"><span class="linenos">632</span></a>            <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ReformattingSpatialShape</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
</span><span id="CoordinateSystem-633"><a href="#CoordinateSystem-633"><span class="linenos">633</span></a>            <span class="n">ReformattingSpatialShape</span><span class="p">,</span>
</span><span id="CoordinateSystem-634"><a href="#CoordinateSystem-634"><span class="linenos">634</span></a>            <span class="nb">int</span><span class="p">,</span>
</span><span id="CoordinateSystem-635"><a href="#CoordinateSystem-635"><span class="linenos">635</span></a>            <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CoordinateSystem-636"><a href="#CoordinateSystem-636"><span class="linenos">636</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">OriginalFOV</span><span class="p">(</span><span class="n">fitting_method</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">fov_convention</span><span class="o">=</span><span class="s2">&quot;full_voxels&quot;</span><span class="p">),</span>
</span><span id="CoordinateSystem-637"><a href="#CoordinateSystem-637"><span class="linenos">637</span></a>        <span class="n">reference</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="CoordinateSystem-638"><a href="#CoordinateSystem-638"><span class="linenos">638</span></a>            <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ReformattingReference</span><span class="p">,</span> <span class="n">Number</span><span class="p">]],</span>
</span><span id="CoordinateSystem-639"><a href="#CoordinateSystem-639"><span class="linenos">639</span></a>            <span class="n">ReformattingReference</span><span class="p">,</span>
</span><span id="CoordinateSystem-640"><a href="#CoordinateSystem-640"><span class="linenos">640</span></a>            <span class="n">Number</span><span class="p">,</span>
</span><span id="CoordinateSystem-641"><a href="#CoordinateSystem-641"><span class="linenos">641</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">Center</span><span class="p">(),</span>
</span><span id="CoordinateSystem-642"><a href="#CoordinateSystem-642"><span class="linenos">642</span></a>        <span class="n">target_reference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="CoordinateSystem-643"><a href="#CoordinateSystem-643"><span class="linenos">643</span></a>            <span class="n">Union</span><span class="p">[</span>
</span><span id="CoordinateSystem-644"><a href="#CoordinateSystem-644"><span class="linenos">644</span></a>                <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ReformattingReference</span><span class="p">,</span> <span class="n">Number</span><span class="p">]],</span>
</span><span id="CoordinateSystem-645"><a href="#CoordinateSystem-645"><span class="linenos">645</span></a>                <span class="n">ReformattingReference</span><span class="p">,</span>
</span><span id="CoordinateSystem-646"><a href="#CoordinateSystem-646"><span class="linenos">646</span></a>                <span class="n">Number</span><span class="p">,</span>
</span><span id="CoordinateSystem-647"><a href="#CoordinateSystem-647"><span class="linenos">647</span></a>            <span class="p">]</span>
</span><span id="CoordinateSystem-648"><a href="#CoordinateSystem-648"><span class="linenos">648</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-649"><a href="#CoordinateSystem-649"><span class="linenos">649</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span> <span class="o">...</span>
</span><span id="CoordinateSystem-650"><a href="#CoordinateSystem-650"><span class="linenos">650</span></a>
</span><span id="CoordinateSystem-651"><a href="#CoordinateSystem-651"><span class="linenos">651</span></a>    <span class="k">def</span> <span class="nf">reformat</span><span class="p">(</span>
</span><span id="CoordinateSystem-652"><a href="#CoordinateSystem-652"><span class="linenos">652</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CoordinateSystem-653"><a href="#CoordinateSystem-653"><span class="linenos">653</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="CoordinateSystem-654"><a href="#CoordinateSystem-654"><span class="linenos">654</span></a>        <span class="n">downsampling_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-655"><a href="#CoordinateSystem-655"><span class="linenos">655</span></a>        <span class="n">upsampling_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-656"><a href="#CoordinateSystem-656"><span class="linenos">656</span></a>        <span class="n">voxel_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-657"><a href="#CoordinateSystem-657"><span class="linenos">657</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="CoordinateSystem-658"><a href="#CoordinateSystem-658"><span class="linenos">658</span></a>            <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ReformattingSpatialShape</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
</span><span id="CoordinateSystem-659"><a href="#CoordinateSystem-659"><span class="linenos">659</span></a>            <span class="n">ReformattingSpatialShape</span><span class="p">,</span>
</span><span id="CoordinateSystem-660"><a href="#CoordinateSystem-660"><span class="linenos">660</span></a>            <span class="nb">int</span><span class="p">,</span>
</span><span id="CoordinateSystem-661"><a href="#CoordinateSystem-661"><span class="linenos">661</span></a>            <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CoordinateSystem-662"><a href="#CoordinateSystem-662"><span class="linenos">662</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">OriginalFOV</span><span class="p">(</span><span class="n">fitting_method</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">fov_convention</span><span class="o">=</span><span class="s2">&quot;full_voxels&quot;</span><span class="p">),</span>
</span><span id="CoordinateSystem-663"><a href="#CoordinateSystem-663"><span class="linenos">663</span></a>        <span class="n">reference</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="CoordinateSystem-664"><a href="#CoordinateSystem-664"><span class="linenos">664</span></a>            <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ReformattingReference</span><span class="p">,</span> <span class="n">Number</span><span class="p">]],</span>
</span><span id="CoordinateSystem-665"><a href="#CoordinateSystem-665"><span class="linenos">665</span></a>            <span class="n">ReformattingReference</span><span class="p">,</span>
</span><span id="CoordinateSystem-666"><a href="#CoordinateSystem-666"><span class="linenos">666</span></a>            <span class="n">Number</span><span class="p">,</span>
</span><span id="CoordinateSystem-667"><a href="#CoordinateSystem-667"><span class="linenos">667</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">Center</span><span class="p">(),</span>
</span><span id="CoordinateSystem-668"><a href="#CoordinateSystem-668"><span class="linenos">668</span></a>        <span class="n">target_reference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="CoordinateSystem-669"><a href="#CoordinateSystem-669"><span class="linenos">669</span></a>            <span class="n">Union</span><span class="p">[</span>
</span><span id="CoordinateSystem-670"><a href="#CoordinateSystem-670"><span class="linenos">670</span></a>                <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ReformattingReference</span><span class="p">,</span> <span class="n">Number</span><span class="p">]],</span>
</span><span id="CoordinateSystem-671"><a href="#CoordinateSystem-671"><span class="linenos">671</span></a>                <span class="n">ReformattingReference</span><span class="p">,</span>
</span><span id="CoordinateSystem-672"><a href="#CoordinateSystem-672"><span class="linenos">672</span></a>                <span class="n">Number</span><span class="p">,</span>
</span><span id="CoordinateSystem-673"><a href="#CoordinateSystem-673"><span class="linenos">673</span></a>            <span class="p">]</span>
</span><span id="CoordinateSystem-674"><a href="#CoordinateSystem-674"><span class="linenos">674</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-675"><a href="#CoordinateSystem-675"><span class="linenos">675</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-676"><a href="#CoordinateSystem-676"><span class="linenos">676</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reformat the coordinate system.</span>
</span><span id="CoordinateSystem-677"><a href="#CoordinateSystem-677"><span class="linenos">677</span></a>
</span><span id="CoordinateSystem-678"><a href="#CoordinateSystem-678"><span class="linenos">678</span></a><span class="sd">        All tensors should be provided on the host (cpu). That is, since the</span>
</span><span id="CoordinateSystem-679"><a href="#CoordinateSystem-679"><span class="linenos">679</span></a><span class="sd">        transformation may be used in control flow decisions, and we want to</span>
</span><span id="CoordinateSystem-680"><a href="#CoordinateSystem-680"><span class="linenos">680</span></a><span class="sd">        avoid synchronizing the target device with the host. The matrix is moved</span>
</span><span id="CoordinateSystem-681"><a href="#CoordinateSystem-681"><span class="linenos">681</span></a><span class="sd">        to the target device asynchronously, if needed.</span>
</span><span id="CoordinateSystem-682"><a href="#CoordinateSystem-682"><span class="linenos">682</span></a>
</span><span id="CoordinateSystem-683"><a href="#CoordinateSystem-683"><span class="linenos">683</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem-684"><a href="#CoordinateSystem-684"><span class="linenos">684</span></a><span class="sd">            downsampling_factor: Factor to downsample the grid voxel size. A tensor</span>
</span><span id="CoordinateSystem-685"><a href="#CoordinateSystem-685"><span class="linenos">685</span></a><span class="sd">                with shape ([*batch_shape, ]n_spatial_dims). Can be also given as a</span>
</span><span id="CoordinateSystem-686"><a href="#CoordinateSystem-686"><span class="linenos">686</span></a><span class="sd">                number or sequence of numbers.</span>
</span><span id="CoordinateSystem-687"><a href="#CoordinateSystem-687"><span class="linenos">687</span></a><span class="sd">            upsampling_factor: Factor to upsample the grid voxel size. A tensor with</span>
</span><span id="CoordinateSystem-688"><a href="#CoordinateSystem-688"><span class="linenos">688</span></a><span class="sd">                shape ([*batch_shape, ]n_spatial_dims). Can be also given as a number</span>
</span><span id="CoordinateSystem-689"><a href="#CoordinateSystem-689"><span class="linenos">689</span></a><span class="sd">                or sequence of numbers.</span>
</span><span id="CoordinateSystem-690"><a href="#CoordinateSystem-690"><span class="linenos">690</span></a><span class="sd">            voxel_size: Voxel size of the reformatted grid. A tensor with shape</span>
</span><span id="CoordinateSystem-691"><a href="#CoordinateSystem-691"><span class="linenos">691</span></a><span class="sd">                ([*batch_shape, ]n_spatial_dims). Can be also given as a number or</span>
</span><span id="CoordinateSystem-692"><a href="#CoordinateSystem-692"><span class="linenos">692</span></a><span class="sd">                sequence of numbers.</span>
</span><span id="CoordinateSystem-693"><a href="#CoordinateSystem-693"><span class="linenos">693</span></a><span class="sd">            spatial_shape: Defines spatial_shape of the target grid, either</span>
</span><span id="CoordinateSystem-694"><a href="#CoordinateSystem-694"><span class="linenos">694</span></a><span class="sd">                given separately for each dimension or as a single value in</span>
</span><span id="CoordinateSystem-695"><a href="#CoordinateSystem-695"><span class="linenos">695</span></a><span class="sd">                which case the same value is used for all the dimensions.</span>
</span><span id="CoordinateSystem-696"><a href="#CoordinateSystem-696"><span class="linenos">696</span></a><span class="sd">                Defaults to OriginalFOV(&quot;round&quot;, &quot;full_voxels&quot;).</span>
</span><span id="CoordinateSystem-697"><a href="#CoordinateSystem-697"><span class="linenos">697</span></a><span class="sd">            reference: Defines the point in the original voxel</span>
</span><span id="CoordinateSystem-698"><a href="#CoordinateSystem-698"><span class="linenos">698</span></a><span class="sd">                coordinates which will be aligned with the target reference in</span>
</span><span id="CoordinateSystem-699"><a href="#CoordinateSystem-699"><span class="linenos">699</span></a><span class="sd">                the reformatted coordinates. Either given separately for each</span>
</span><span id="CoordinateSystem-700"><a href="#CoordinateSystem-700"><span class="linenos">700</span></a><span class="sd">                dimension or as a single value in which case the same value is</span>
</span><span id="CoordinateSystem-701"><a href="#CoordinateSystem-701"><span class="linenos">701</span></a><span class="sd">                used for all the dimensions. Defaults to Center().</span>
</span><span id="CoordinateSystem-702"><a href="#CoordinateSystem-702"><span class="linenos">702</span></a><span class="sd">            target_reference: Defaults to reference. Defines the point in the</span>
</span><span id="CoordinateSystem-703"><a href="#CoordinateSystem-703"><span class="linenos">703</span></a><span class="sd">                reformatted voxel coordinates which will be aligned with the</span>
</span><span id="CoordinateSystem-704"><a href="#CoordinateSystem-704"><span class="linenos">704</span></a><span class="sd">                source reference in the original coordinates. Either given</span>
</span><span id="CoordinateSystem-705"><a href="#CoordinateSystem-705"><span class="linenos">705</span></a><span class="sd">                separately for each dimension or as a single value in which case</span>
</span><span id="CoordinateSystem-706"><a href="#CoordinateSystem-706"><span class="linenos">706</span></a><span class="sd">                the same value is used for all the dimensions.</span>
</span><span id="CoordinateSystem-707"><a href="#CoordinateSystem-707"><span class="linenos">707</span></a>
</span><span id="CoordinateSystem-708"><a href="#CoordinateSystem-708"><span class="linenos">708</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem-709"><a href="#CoordinateSystem-709"><span class="linenos">709</span></a><span class="sd">            Reformatted coordinate system.</span>
</span><span id="CoordinateSystem-710"><a href="#CoordinateSystem-710"><span class="linenos">710</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem-711"><a href="#CoordinateSystem-711"><span class="linenos">711</span></a>        <span class="n">original_voxel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_spacing_cpu</span><span class="p">()</span>
</span><span id="CoordinateSystem-712"><a href="#CoordinateSystem-712"><span class="linenos">712</span></a>        <span class="n">downsampling_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_downsampling_factor</span><span class="p">(</span>
</span><span id="CoordinateSystem-713"><a href="#CoordinateSystem-713"><span class="linenos">713</span></a>            <span class="n">original_voxel_size</span><span class="p">,</span> <span class="n">downsampling_factor</span><span class="p">,</span> <span class="n">upsampling_factor</span><span class="p">,</span> <span class="n">voxel_size</span>
</span><span id="CoordinateSystem-714"><a href="#CoordinateSystem-714"><span class="linenos">714</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-715"><a href="#CoordinateSystem-715"><span class="linenos">715</span></a>        <span class="n">target_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_target_shape</span><span class="p">(</span><span class="n">downsampling_factor</span><span class="p">,</span> <span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem-716"><a href="#CoordinateSystem-716"><span class="linenos">716</span></a>        <span class="n">source_reference_in_voxel_coordinates</span> <span class="o">=</span> <span class="n">original_voxel_size</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span>
</span><span id="CoordinateSystem-717"><a href="#CoordinateSystem-717"><span class="linenos">717</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_reference_in_voxel_coordinates</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem-718"><a href="#CoordinateSystem-718"><span class="linenos">718</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-719"><a href="#CoordinateSystem-719"><span class="linenos">719</span></a>        <span class="k">if</span> <span class="n">target_reference</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem-720"><a href="#CoordinateSystem-720"><span class="linenos">720</span></a>            <span class="n">target_reference</span> <span class="o">=</span> <span class="n">reference</span>
</span><span id="CoordinateSystem-721"><a href="#CoordinateSystem-721"><span class="linenos">721</span></a>        <span class="n">target_reference_in_voxel_coordinates</span> <span class="o">=</span> <span class="n">original_voxel_size</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span>
</span><span id="CoordinateSystem-722"><a href="#CoordinateSystem-722"><span class="linenos">722</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_reference_in_voxel_coordinates</span><span class="p">(</span><span class="n">target_reference</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem-723"><a href="#CoordinateSystem-723"><span class="linenos">723</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-724"><a href="#CoordinateSystem-724"><span class="linenos">724</span></a>        <span class="n">source_translation</span> <span class="o">=</span> <span class="n">HostDiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="CoordinateSystem-725"><a href="#CoordinateSystem-725"><span class="linenos">725</span></a>            <span class="n">translation</span><span class="o">=</span><span class="n">source_reference_in_voxel_coordinates</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span>
</span><span id="CoordinateSystem-726"><a href="#CoordinateSystem-726"><span class="linenos">726</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-727"><a href="#CoordinateSystem-727"><span class="linenos">727</span></a>        <span class="n">target_translation</span> <span class="o">=</span> <span class="n">HostDiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="CoordinateSystem-728"><a href="#CoordinateSystem-728"><span class="linenos">728</span></a>            <span class="n">translation</span><span class="o">=-</span><span class="n">target_reference_in_voxel_coordinates</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span>
</span><span id="CoordinateSystem-729"><a href="#CoordinateSystem-729"><span class="linenos">729</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-730"><a href="#CoordinateSystem-730"><span class="linenos">730</span></a>        <span class="n">downsampling_translation</span> <span class="o">=</span> <span class="n">HostDiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="CoordinateSystem-731"><a href="#CoordinateSystem-731"><span class="linenos">731</span></a>            <span class="n">downsampling_factor</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span>
</span><span id="CoordinateSystem-732"><a href="#CoordinateSystem-732"><span class="linenos">732</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-733"><a href="#CoordinateSystem-733"><span class="linenos">733</span></a>        <span class="n">reformatted_transformation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CoordinateSystem-734"><a href="#CoordinateSystem-734"><span class="linenos">734</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span>
</span><span id="CoordinateSystem-735"><a href="#CoordinateSystem-735"><span class="linenos">735</span></a>            <span class="o">@</span> <span class="n">source_translation</span>
</span><span id="CoordinateSystem-736"><a href="#CoordinateSystem-736"><span class="linenos">736</span></a>            <span class="o">@</span> <span class="n">downsampling_translation</span>
</span><span id="CoordinateSystem-737"><a href="#CoordinateSystem-737"><span class="linenos">737</span></a>            <span class="o">@</span> <span class="n">target_translation</span>
</span><span id="CoordinateSystem-738"><a href="#CoordinateSystem-738"><span class="linenos">738</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-739"><a href="#CoordinateSystem-739"><span class="linenos">739</span></a>
</span><span id="CoordinateSystem-740"><a href="#CoordinateSystem-740"><span class="linenos">740</span></a>        <span class="k">return</span> <span class="n">CoordinateSystem</span><span class="p">(</span>
</span><span id="CoordinateSystem-741"><a href="#CoordinateSystem-741"><span class="linenos">741</span></a>            <span class="n">from_voxel_coordinates</span><span class="o">=</span><span class="n">reformatted_transformation</span><span class="p">,</span>
</span><span id="CoordinateSystem-742"><a href="#CoordinateSystem-742"><span class="linenos">742</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="n">target_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem-743"><a href="#CoordinateSystem-743"><span class="linenos">743</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-744"><a href="#CoordinateSystem-744"><span class="linenos">744</span></a>
</span><span id="CoordinateSystem-745"><a href="#CoordinateSystem-745"><span class="linenos">745</span></a>    <span class="k">def</span> <span class="nf">_as_downsampling_factor</span><span class="p">(</span>
</span><span id="CoordinateSystem-746"><a href="#CoordinateSystem-746"><span class="linenos">746</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CoordinateSystem-747"><a href="#CoordinateSystem-747"><span class="linenos">747</span></a>        <span class="n">original_voxel_size</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CoordinateSystem-748"><a href="#CoordinateSystem-748"><span class="linenos">748</span></a>        <span class="n">downsampling_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-749"><a href="#CoordinateSystem-749"><span class="linenos">749</span></a>        <span class="n">upsampling_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-750"><a href="#CoordinateSystem-750"><span class="linenos">750</span></a>        <span class="n">voxel_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem-751"><a href="#CoordinateSystem-751"><span class="linenos">751</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="CoordinateSystem-752"><a href="#CoordinateSystem-752"><span class="linenos">752</span></a>        <span class="k">if</span> <span class="n">voxel_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem-753"><a href="#CoordinateSystem-753"><span class="linenos">753</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">voxel_size</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="CoordinateSystem-754"><a href="#CoordinateSystem-754"><span class="linenos">754</span></a>                <span class="n">voxel_size</span> <span class="o">=</span> <span class="n">original_voxel_size</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="n">voxel_size</span><span class="p">)</span>
</span><span id="CoordinateSystem-755"><a href="#CoordinateSystem-755"><span class="linenos">755</span></a>            <span class="k">if</span> <span class="n">voxel_size</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CoordinateSystem-756"><a href="#CoordinateSystem-756"><span class="linenos">756</span></a>                <span class="n">voxel_size</span> <span class="o">=</span> <span class="n">voxel_size</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="CoordinateSystem-757"><a href="#CoordinateSystem-757"><span class="linenos">757</span></a>            <span class="n">voxel_size</span><span class="p">,</span> <span class="n">original_voxel_size</span> <span class="o">=</span> <span class="n">broadcast_tensors_in_parts</span><span class="p">(</span>
</span><span id="CoordinateSystem-758"><a href="#CoordinateSystem-758"><span class="linenos">758</span></a>                <span class="n">voxel_size</span><span class="p">,</span> <span class="n">original_voxel_size</span>
</span><span id="CoordinateSystem-759"><a href="#CoordinateSystem-759"><span class="linenos">759</span></a>            <span class="p">)</span>
</span><span id="CoordinateSystem-760"><a href="#CoordinateSystem-760"><span class="linenos">760</span></a>            <span class="k">if</span> <span class="n">get_spatial_shape</span><span class="p">(</span><span class="n">voxel_size</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">tuple</span><span class="p">():</span>
</span><span id="CoordinateSystem-761"><a href="#CoordinateSystem-761"><span class="linenos">761</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="CoordinateSystem-762"><a href="#CoordinateSystem-762"><span class="linenos">762</span></a>                    <span class="s2">&quot;Downsampling factors or upsampling factors should not have spatial dimensions&quot;</span>
</span><span id="CoordinateSystem-763"><a href="#CoordinateSystem-763"><span class="linenos">763</span></a>                <span class="p">)</span>
</span><span id="CoordinateSystem-764"><a href="#CoordinateSystem-764"><span class="linenos">764</span></a>            <span class="k">return</span> <span class="n">voxel_size</span> <span class="o">/</span> <span class="n">original_voxel_size</span>
</span><span id="CoordinateSystem-765"><a href="#CoordinateSystem-765"><span class="linenos">765</span></a>        <span class="k">if</span> <span class="n">downsampling_factor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem-766"><a href="#CoordinateSystem-766"><span class="linenos">766</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">downsampling_factor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="CoordinateSystem-767"><a href="#CoordinateSystem-767"><span class="linenos">767</span></a>                <span class="n">downsampling_factor</span> <span class="o">=</span> <span class="n">original_voxel_size</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="n">downsampling_factor</span><span class="p">)</span>
</span><span id="CoordinateSystem-768"><a href="#CoordinateSystem-768"><span class="linenos">768</span></a>            <span class="k">if</span> <span class="n">downsampling_factor</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CoordinateSystem-769"><a href="#CoordinateSystem-769"><span class="linenos">769</span></a>                <span class="n">downsampling_factor</span> <span class="o">=</span> <span class="n">downsampling_factor</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="CoordinateSystem-770"><a href="#CoordinateSystem-770"><span class="linenos">770</span></a>            <span class="n">processed_downsampling_factor</span> <span class="o">=</span> <span class="n">downsampling_factor</span>
</span><span id="CoordinateSystem-771"><a href="#CoordinateSystem-771"><span class="linenos">771</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CoordinateSystem-772"><a href="#CoordinateSystem-772"><span class="linenos">772</span></a>            <span class="n">processed_downsampling_factor</span> <span class="o">=</span> <span class="n">original_voxel_size</span><span class="o">.</span><span class="n">new_ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CoordinateSystem-773"><a href="#CoordinateSystem-773"><span class="linenos">773</span></a>        <span class="k">if</span> <span class="n">upsampling_factor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem-774"><a href="#CoordinateSystem-774"><span class="linenos">774</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">upsampling_factor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="CoordinateSystem-775"><a href="#CoordinateSystem-775"><span class="linenos">775</span></a>                <span class="n">upsampling_factor</span> <span class="o">=</span> <span class="n">original_voxel_size</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="n">upsampling_factor</span><span class="p">)</span>
</span><span id="CoordinateSystem-776"><a href="#CoordinateSystem-776"><span class="linenos">776</span></a>            <span class="k">if</span> <span class="n">upsampling_factor</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="CoordinateSystem-777"><a href="#CoordinateSystem-777"><span class="linenos">777</span></a>                <span class="n">upsampling_factor</span> <span class="o">=</span> <span class="n">upsampling_factor</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="CoordinateSystem-778"><a href="#CoordinateSystem-778"><span class="linenos">778</span></a>            <span class="n">processed_upsampling_factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">upsampling_factor</span>
</span><span id="CoordinateSystem-779"><a href="#CoordinateSystem-779"><span class="linenos">779</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CoordinateSystem-780"><a href="#CoordinateSystem-780"><span class="linenos">780</span></a>            <span class="n">processed_upsampling_factor</span> <span class="o">=</span> <span class="n">original_voxel_size</span><span class="o">.</span><span class="n">new_ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CoordinateSystem-781"><a href="#CoordinateSystem-781"><span class="linenos">781</span></a>        <span class="n">_batch_shape</span><span class="p">,</span> <span class="n">channels_shape</span><span class="p">,</span> <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">broadcast_shapes_in_parts_splitted</span><span class="p">(</span>
</span><span id="CoordinateSystem-782"><a href="#CoordinateSystem-782"><span class="linenos">782</span></a>            <span class="n">processed_downsampling_factor</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="CoordinateSystem-783"><a href="#CoordinateSystem-783"><span class="linenos">783</span></a>            <span class="n">processed_upsampling_factor</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="CoordinateSystem-784"><a href="#CoordinateSystem-784"><span class="linenos">784</span></a>            <span class="n">original_voxel_size</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="CoordinateSystem-785"><a href="#CoordinateSystem-785"><span class="linenos">785</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-786"><a href="#CoordinateSystem-786"><span class="linenos">786</span></a>        <span class="k">if</span> <span class="n">spatial_shape</span> <span class="o">!=</span> <span class="nb">tuple</span><span class="p">():</span>
</span><span id="CoordinateSystem-787"><a href="#CoordinateSystem-787"><span class="linenos">787</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="CoordinateSystem-788"><a href="#CoordinateSystem-788"><span class="linenos">788</span></a>                <span class="s2">&quot;Downsampling factors or upsampling factors should not have spatial dimensions&quot;</span>
</span><span id="CoordinateSystem-789"><a href="#CoordinateSystem-789"><span class="linenos">789</span></a>            <span class="p">)</span>
</span><span id="CoordinateSystem-790"><a href="#CoordinateSystem-790"><span class="linenos">790</span></a>        <span class="n">processed_downsampling_factor</span> <span class="o">=</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="CoordinateSystem-791"><a href="#CoordinateSystem-791"><span class="linenos">791</span></a>            <span class="n">processed_downsampling_factor</span><span class="p">,</span>
</span><span id="CoordinateSystem-792"><a href="#CoordinateSystem-792"><span class="linenos">792</span></a>            <span class="n">channels_shape</span><span class="o">=</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem-793"><a href="#CoordinateSystem-793"><span class="linenos">793</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-794"><a href="#CoordinateSystem-794"><span class="linenos">794</span></a>        <span class="n">processed_upsampling_factor</span> <span class="o">=</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="CoordinateSystem-795"><a href="#CoordinateSystem-795"><span class="linenos">795</span></a>            <span class="n">processed_upsampling_factor</span><span class="p">,</span>
</span><span id="CoordinateSystem-796"><a href="#CoordinateSystem-796"><span class="linenos">796</span></a>            <span class="n">channels_shape</span><span class="o">=</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem-797"><a href="#CoordinateSystem-797"><span class="linenos">797</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-798"><a href="#CoordinateSystem-798"><span class="linenos">798</span></a>        <span class="k">return</span> <span class="n">processed_downsampling_factor</span> <span class="o">*</span> <span class="n">processed_upsampling_factor</span>
</span><span id="CoordinateSystem-799"><a href="#CoordinateSystem-799"><span class="linenos">799</span></a>
</span><span id="CoordinateSystem-800"><a href="#CoordinateSystem-800"><span class="linenos">800</span></a>    <span class="k">def</span> <span class="nf">_get_reference_in_voxel_coordinates</span><span class="p">(</span>
</span><span id="CoordinateSystem-801"><a href="#CoordinateSystem-801"><span class="linenos">801</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CoordinateSystem-802"><a href="#CoordinateSystem-802"><span class="linenos">802</span></a>        <span class="n">reference</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="CoordinateSystem-803"><a href="#CoordinateSystem-803"><span class="linenos">803</span></a>            <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ReformattingReference</span><span class="p">,</span> <span class="n">Number</span><span class="p">]],</span>
</span><span id="CoordinateSystem-804"><a href="#CoordinateSystem-804"><span class="linenos">804</span></a>            <span class="n">ReformattingReference</span><span class="p">,</span>
</span><span id="CoordinateSystem-805"><a href="#CoordinateSystem-805"><span class="linenos">805</span></a>            <span class="n">Number</span><span class="p">,</span>
</span><span id="CoordinateSystem-806"><a href="#CoordinateSystem-806"><span class="linenos">806</span></a>        <span class="p">],</span>
</span><span id="CoordinateSystem-807"><a href="#CoordinateSystem-807"><span class="linenos">807</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="CoordinateSystem-808"><a href="#CoordinateSystem-808"><span class="linenos">808</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
</span><span id="CoordinateSystem-809"><a href="#CoordinateSystem-809"><span class="linenos">809</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="p">(</span><span class="n">ReformattingReference</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
</span><span id="CoordinateSystem-810"><a href="#CoordinateSystem-810"><span class="linenos">810</span></a>            <span class="n">reference</span> <span class="o">=</span> <span class="p">[</span><span class="n">reference</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem-811"><a href="#CoordinateSystem-811"><span class="linenos">811</span></a>        <span class="n">voxel_coordinate_reference</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CoordinateSystem-812"><a href="#CoordinateSystem-812"><span class="linenos">812</span></a>        <span class="k">for</span> <span class="n">dim_reference</span><span class="p">,</span> <span class="n">dim_size</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">spatial_shape</span><span class="p">):</span>
</span><span id="CoordinateSystem-813"><a href="#CoordinateSystem-813"><span class="linenos">813</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dim_reference</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
</span><span id="CoordinateSystem-814"><a href="#CoordinateSystem-814"><span class="linenos">814</span></a>                <span class="n">voxel_coordinate_reference</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim_reference</span><span class="p">)</span>
</span><span id="CoordinateSystem-815"><a href="#CoordinateSystem-815"><span class="linenos">815</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CoordinateSystem-816"><a href="#CoordinateSystem-816"><span class="linenos">816</span></a>                <span class="n">voxel_coordinate_reference</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="CoordinateSystem-817"><a href="#CoordinateSystem-817"><span class="linenos">817</span></a>                    <span class="nb">float</span><span class="p">(</span><span class="n">dim_reference</span><span class="o">.</span><span class="n">get_voxel_coordinate</span><span class="p">(</span><span class="n">dim_size</span><span class="p">))</span>
</span><span id="CoordinateSystem-818"><a href="#CoordinateSystem-818"><span class="linenos">818</span></a>                <span class="p">)</span>
</span><span id="CoordinateSystem-819"><a href="#CoordinateSystem-819"><span class="linenos">819</span></a>        <span class="k">return</span> <span class="n">voxel_coordinate_reference</span>
</span><span id="CoordinateSystem-820"><a href="#CoordinateSystem-820"><span class="linenos">820</span></a>
</span><span id="CoordinateSystem-821"><a href="#CoordinateSystem-821"><span class="linenos">821</span></a>    <span class="k">def</span> <span class="nf">_get_target_shape</span><span class="p">(</span>
</span><span id="CoordinateSystem-822"><a href="#CoordinateSystem-822"><span class="linenos">822</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CoordinateSystem-823"><a href="#CoordinateSystem-823"><span class="linenos">823</span></a>        <span class="n">downsampling_factor</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CoordinateSystem-824"><a href="#CoordinateSystem-824"><span class="linenos">824</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="CoordinateSystem-825"><a href="#CoordinateSystem-825"><span class="linenos">825</span></a>            <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ReformattingSpatialShape</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">ReformattingSpatialShape</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Tensor</span>
</span><span id="CoordinateSystem-826"><a href="#CoordinateSystem-826"><span class="linenos">826</span></a>        <span class="p">],</span>
</span><span id="CoordinateSystem-827"><a href="#CoordinateSystem-827"><span class="linenos">827</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="CoordinateSystem-828"><a href="#CoordinateSystem-828"><span class="linenos">828</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="CoordinateSystem-829"><a href="#CoordinateSystem-829"><span class="linenos">829</span></a>            <span class="k">if</span> <span class="n">spatial_shape</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="CoordinateSystem-830"><a href="#CoordinateSystem-830"><span class="linenos">830</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid spatial_shape tensor for reformatting&quot;</span><span class="p">)</span>
</span><span id="CoordinateSystem-831"><a href="#CoordinateSystem-831"><span class="linenos">831</span></a>            <span class="k">if</span> <span class="n">spatial_shape</span><span class="o">.</span><span class="n">is_floating_point</span><span class="p">()</span> <span class="ow">or</span> <span class="n">spatial_shape</span><span class="o">.</span><span class="n">is_complex</span><span class="p">():</span>
</span><span id="CoordinateSystem-832"><a href="#CoordinateSystem-832"><span class="linenos">832</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shape tensor should be an integer tensor&quot;</span><span class="p">)</span>
</span><span id="CoordinateSystem-833"><a href="#CoordinateSystem-833"><span class="linenos">833</span></a>            <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">spatial_shape</span><span class="o">.</span><span class="n">expand</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">),))</span>
</span><span id="CoordinateSystem-834"><a href="#CoordinateSystem-834"><span class="linenos">834</span></a>            <span class="k">return</span> <span class="n">spatial_shape</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="CoordinateSystem-835"><a href="#CoordinateSystem-835"><span class="linenos">835</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="CoordinateSystem-836"><a href="#CoordinateSystem-836"><span class="linenos">836</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">spatial_shape</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem-837"><a href="#CoordinateSystem-837"><span class="linenos">837</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">ReformattingSpatialShape</span><span class="p">):</span>
</span><span id="CoordinateSystem-838"><a href="#CoordinateSystem-838"><span class="linenos">838</span></a>            <span class="n">spatial_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">spatial_shape</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem-839"><a href="#CoordinateSystem-839"><span class="linenos">839</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CoordinateSystem-840"><a href="#CoordinateSystem-840"><span class="linenos">840</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">):</span>
</span><span id="CoordinateSystem-841"><a href="#CoordinateSystem-841"><span class="linenos">841</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid spatial_shape for reformatting&quot;</span><span class="p">)</span>
</span><span id="CoordinateSystem-842"><a href="#CoordinateSystem-842"><span class="linenos">842</span></a>            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dim_shape</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">dim_shape</span> <span class="ow">in</span> <span class="n">spatial_shape</span><span class="p">):</span>
</span><span id="CoordinateSystem-843"><a href="#CoordinateSystem-843"><span class="linenos">843</span></a>                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem-844"><a href="#CoordinateSystem-844"><span class="linenos">844</span></a>        <span class="n">downsampling_factor</span> <span class="o">=</span> <span class="n">move_channels_last</span><span class="p">(</span><span class="n">downsampling_factor</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
</span><span id="CoordinateSystem-845"><a href="#CoordinateSystem-845"><span class="linenos">845</span></a>            <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">get_channels_shape</span><span class="p">(</span><span class="n">downsampling_factor</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CoordinateSystem-846"><a href="#CoordinateSystem-846"><span class="linenos">846</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-847"><a href="#CoordinateSystem-847"><span class="linenos">847</span></a>        <span class="k">if</span> <span class="n">downsampling_factor</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="CoordinateSystem-848"><a href="#CoordinateSystem-848"><span class="linenos">848</span></a>            <span class="n">downsampling_factor</span> <span class="o">=</span> <span class="n">downsampling_factor</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="CoordinateSystem-849"><a href="#CoordinateSystem-849"><span class="linenos">849</span></a>        <span class="n">output_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CoordinateSystem-850"><a href="#CoordinateSystem-850"><span class="linenos">850</span></a>        <span class="k">for</span> <span class="n">batch_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">downsampling_factor</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
</span><span id="CoordinateSystem-851"><a href="#CoordinateSystem-851"><span class="linenos">851</span></a>            <span class="n">target_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_target_shape_for_batch</span><span class="p">(</span>
</span><span id="CoordinateSystem-852"><a href="#CoordinateSystem-852"><span class="linenos">852</span></a>                <span class="n">downsampling_factor</span><span class="p">[</span><span class="n">batch_index</span><span class="p">],</span> <span class="n">spatial_shape</span>
</span><span id="CoordinateSystem-853"><a href="#CoordinateSystem-853"><span class="linenos">853</span></a>            <span class="p">)</span>
</span><span id="CoordinateSystem-854"><a href="#CoordinateSystem-854"><span class="linenos">854</span></a>            <span class="k">if</span> <span class="n">output_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem-855"><a href="#CoordinateSystem-855"><span class="linenos">855</span></a>                <span class="n">output_shape</span> <span class="o">=</span> <span class="n">target_shape</span>
</span><span id="CoordinateSystem-856"><a href="#CoordinateSystem-856"><span class="linenos">856</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CoordinateSystem-857"><a href="#CoordinateSystem-857"><span class="linenos">857</span></a>                <span class="k">if</span> <span class="n">output_shape</span> <span class="o">!=</span> <span class="n">target_shape</span><span class="p">:</span>
</span><span id="CoordinateSystem-858"><a href="#CoordinateSystem-858"><span class="linenos">858</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="CoordinateSystem-859"><a href="#CoordinateSystem-859"><span class="linenos">859</span></a>                        <span class="s2">&quot;Inconsistent target shapes obtained with given spatial shape options, &quot;</span>
</span><span id="CoordinateSystem-860"><a href="#CoordinateSystem-860"><span class="linenos">860</span></a>                        <span class="s2">&quot;consider defining an explicit target shape for reformatting.&quot;</span>
</span><span id="CoordinateSystem-861"><a href="#CoordinateSystem-861"><span class="linenos">861</span></a>                    <span class="p">)</span>
</span><span id="CoordinateSystem-862"><a href="#CoordinateSystem-862"><span class="linenos">862</span></a>        <span class="k">assert</span> <span class="n">output_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="CoordinateSystem-863"><a href="#CoordinateSystem-863"><span class="linenos">863</span></a>        <span class="k">return</span> <span class="n">output_shape</span>
</span><span id="CoordinateSystem-864"><a href="#CoordinateSystem-864"><span class="linenos">864</span></a>
</span><span id="CoordinateSystem-865"><a href="#CoordinateSystem-865"><span class="linenos">865</span></a>    <span class="k">def</span> <span class="nf">_get_target_shape_for_batch</span><span class="p">(</span>
</span><span id="CoordinateSystem-866"><a href="#CoordinateSystem-866"><span class="linenos">866</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CoordinateSystem-867"><a href="#CoordinateSystem-867"><span class="linenos">867</span></a>        <span class="n">single_downsampling_factor</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CoordinateSystem-868"><a href="#CoordinateSystem-868"><span class="linenos">868</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ReformattingSpatialShape</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
</span><span id="CoordinateSystem-869"><a href="#CoordinateSystem-869"><span class="linenos">869</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span><span id="CoordinateSystem-870"><a href="#CoordinateSystem-870"><span class="linenos">870</span></a>        <span class="n">target_shape</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CoordinateSystem-871"><a href="#CoordinateSystem-871"><span class="linenos">871</span></a>        <span class="k">for</span> <span class="n">dim_original_shape</span><span class="p">,</span> <span class="n">dim_shape</span><span class="p">,</span> <span class="n">dim_downsampling_factor</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
</span><span id="CoordinateSystem-872"><a href="#CoordinateSystem-872"><span class="linenos">872</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">,</span> <span class="n">spatial_shape</span><span class="p">,</span> <span class="n">single_downsampling_factor</span>
</span><span id="CoordinateSystem-873"><a href="#CoordinateSystem-873"><span class="linenos">873</span></a>        <span class="p">):</span>
</span><span id="CoordinateSystem-874"><a href="#CoordinateSystem-874"><span class="linenos">874</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dim_shape</span><span class="p">,</span> <span class="n">ReformattingSpatialShape</span><span class="p">):</span>
</span><span id="CoordinateSystem-875"><a href="#CoordinateSystem-875"><span class="linenos">875</span></a>                <span class="n">target_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="CoordinateSystem-876"><a href="#CoordinateSystem-876"><span class="linenos">876</span></a>                    <span class="n">dim_shape</span><span class="o">.</span><span class="n">target_size</span><span class="p">(</span><span class="n">dim_original_shape</span><span class="p">,</span> <span class="n">dim_downsampling_factor</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</span><span id="CoordinateSystem-877"><a href="#CoordinateSystem-877"><span class="linenos">877</span></a>                <span class="p">)</span>
</span><span id="CoordinateSystem-878"><a href="#CoordinateSystem-878"><span class="linenos">878</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dim_shape</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="CoordinateSystem-879"><a href="#CoordinateSystem-879"><span class="linenos">879</span></a>                <span class="n">target_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dim_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem-880"><a href="#CoordinateSystem-880"><span class="linenos">880</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CoordinateSystem-881"><a href="#CoordinateSystem-881"><span class="linenos">881</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid spatial shape for reformatting: </span><span class="si">{</span><span class="n">spatial_shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CoordinateSystem-882"><a href="#CoordinateSystem-882"><span class="linenos">882</span></a>        <span class="k">return</span> <span class="n">target_shape</span>
</span><span id="CoordinateSystem-883"><a href="#CoordinateSystem-883"><span class="linenos">883</span></a>
</span><span id="CoordinateSystem-884"><a href="#CoordinateSystem-884"><span class="linenos">884</span></a>    <span class="nd">@staticmethod</span>
</span><span id="CoordinateSystem-885"><a href="#CoordinateSystem-885"><span class="linenos">885</span></a>    <span class="k">def</span> <span class="nf">_ensure_tensor_on_host</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem-886"><a href="#CoordinateSystem-886"><span class="linenos">886</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-887"><a href="#CoordinateSystem-887"><span class="linenos">887</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="CoordinateSystem-888"><a href="#CoordinateSystem-888"><span class="linenos">888</span></a>                <span class="s2">&quot;Tensors contained by the coordinate system should be located on CPU. &quot;</span>
</span><span id="CoordinateSystem-889"><a href="#CoordinateSystem-889"><span class="linenos">889</span></a>                <span class="s2">&quot;That is since the coordinate system can affect the control flow &quot;</span>
</span><span id="CoordinateSystem-890"><a href="#CoordinateSystem-890"><span class="linenos">890</span></a>                <span class="s2">&quot;and we want to avoid CPU-GPU synchronizations. Tensors contained &quot;</span>
</span><span id="CoordinateSystem-891"><a href="#CoordinateSystem-891"><span class="linenos">891</span></a>                <span class="s2">&quot;by the coordinate system are moved to the target device of the &quot;</span>
</span><span id="CoordinateSystem-892"><a href="#CoordinateSystem-892"><span class="linenos">892</span></a>                <span class="s2">&quot;coordinate system when needed (which can be done asynchonously).&quot;</span>
</span><span id="CoordinateSystem-893"><a href="#CoordinateSystem-893"><span class="linenos">893</span></a>            <span class="p">)</span>
</span><span id="CoordinateSystem-894"><a href="#CoordinateSystem-894"><span class="linenos">894</span></a>
</span><span id="CoordinateSystem-895"><a href="#CoordinateSystem-895"><span class="linenos">895</span></a>    <span class="nd">@property</span>
</span><span id="CoordinateSystem-896"><a href="#CoordinateSystem-896"><span class="linenos">896</span></a>    <span class="k">def</span> <span class="nf">_from_voxel_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IHostAffineTransformation</span><span class="p">:</span>
</span><span id="CoordinateSystem-897"><a href="#CoordinateSystem-897"><span class="linenos">897</span></a>        <span class="n">from_voxel_coordinates</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CoordinateSystem-898"><a href="#CoordinateSystem-898"><span class="linenos">898</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_transformations_which_should_not_be_accessed_directly</span><span class="p">[</span>
</span><span id="CoordinateSystem-899"><a href="#CoordinateSystem-899"><span class="linenos">899</span></a>                <span class="s2">&quot;from_voxel_coordinates&quot;</span>
</span><span id="CoordinateSystem-900"><a href="#CoordinateSystem-900"><span class="linenos">900</span></a>            <span class="p">]</span>
</span><span id="CoordinateSystem-901"><a href="#CoordinateSystem-901"><span class="linenos">901</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-902"><a href="#CoordinateSystem-902"><span class="linenos">902</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="CoordinateSystem-903"><a href="#CoordinateSystem-903"><span class="linenos">903</span></a>            <span class="n">from_voxel_coordinates</span><span class="o">.</span><span class="n">device</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span>
</span><span id="CoordinateSystem-904"><a href="#CoordinateSystem-904"><span class="linenos">904</span></a>            <span class="ow">or</span> <span class="n">from_voxel_coordinates</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="CoordinateSystem-905"><a href="#CoordinateSystem-905"><span class="linenos">905</span></a>        <span class="p">):</span>
</span><span id="CoordinateSystem-906"><a href="#CoordinateSystem-906"><span class="linenos">906</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_transformations_which_should_not_be_accessed_directly</span><span class="p">[</span>
</span><span id="CoordinateSystem-907"><a href="#CoordinateSystem-907"><span class="linenos">907</span></a>                <span class="s2">&quot;from_voxel_coordinates&quot;</span>
</span><span id="CoordinateSystem-908"><a href="#CoordinateSystem-908"><span class="linenos">908</span></a>            <span class="p">]</span> <span class="o">=</span> <span class="n">from_voxel_coordinates</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="CoordinateSystem-909"><a href="#CoordinateSystem-909"><span class="linenos">909</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_transformations_which_should_not_be_accessed_directly</span><span class="p">[</span>
</span><span id="CoordinateSystem-910"><a href="#CoordinateSystem-910"><span class="linenos">910</span></a>            <span class="s2">&quot;from_voxel_coordinates&quot;</span>
</span><span id="CoordinateSystem-911"><a href="#CoordinateSystem-911"><span class="linenos">911</span></a>        <span class="p">]</span>
</span><span id="CoordinateSystem-912"><a href="#CoordinateSystem-912"><span class="linenos">912</span></a>
</span><span id="CoordinateSystem-913"><a href="#CoordinateSystem-913"><span class="linenos">913</span></a>    <span class="nd">@property</span>
</span><span id="CoordinateSystem-914"><a href="#CoordinateSystem-914"><span class="linenos">914</span></a>    <span class="k">def</span> <span class="nf">_to_voxel_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IHostAffineTransformation</span><span class="p">:</span>
</span><span id="CoordinateSystem-915"><a href="#CoordinateSystem-915"><span class="linenos">915</span></a>        <span class="n">to_voxel_coordinates</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CoordinateSystem-916"><a href="#CoordinateSystem-916"><span class="linenos">916</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_transformations_which_should_not_be_accessed_directly</span><span class="p">[</span>
</span><span id="CoordinateSystem-917"><a href="#CoordinateSystem-917"><span class="linenos">917</span></a>                <span class="s2">&quot;to_voxel_coordinates&quot;</span>
</span><span id="CoordinateSystem-918"><a href="#CoordinateSystem-918"><span class="linenos">918</span></a>            <span class="p">]</span>
</span><span id="CoordinateSystem-919"><a href="#CoordinateSystem-919"><span class="linenos">919</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem-920"><a href="#CoordinateSystem-920"><span class="linenos">920</span></a>        <span class="k">if</span> <span class="n">to_voxel_coordinates</span><span class="o">.</span><span class="n">device</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="ow">or</span> <span class="n">to_voxel_coordinates</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
</span><span id="CoordinateSystem-921"><a href="#CoordinateSystem-921"><span class="linenos">921</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_transformations_which_should_not_be_accessed_directly</span><span class="p">[</span>
</span><span id="CoordinateSystem-922"><a href="#CoordinateSystem-922"><span class="linenos">922</span></a>                <span class="s2">&quot;to_voxel_coordinates&quot;</span>
</span><span id="CoordinateSystem-923"><a href="#CoordinateSystem-923"><span class="linenos">923</span></a>            <span class="p">]</span> <span class="o">=</span> <span class="n">to_voxel_coordinates</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="CoordinateSystem-924"><a href="#CoordinateSystem-924"><span class="linenos">924</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_transformations_which_should_not_be_accessed_directly</span><span class="p">[</span>
</span><span id="CoordinateSystem-925"><a href="#CoordinateSystem-925"><span class="linenos">925</span></a>            <span class="s2">&quot;to_voxel_coordinates&quot;</span>
</span><span id="CoordinateSystem-926"><a href="#CoordinateSystem-926"><span class="linenos">926</span></a>        <span class="p">]</span>
</span><span id="CoordinateSystem-927"><a href="#CoordinateSystem-927"><span class="linenos">927</span></a>
</span><span id="CoordinateSystem-928"><a href="#CoordinateSystem-928"><span class="linenos">928</span></a>    <span class="k">def</span> <span class="nf">_get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]:</span>
</span><span id="CoordinateSystem-929"><a href="#CoordinateSystem-929"><span class="linenos">929</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="CoordinateSystem-930"><a href="#CoordinateSystem-930"><span class="linenos">930</span></a>            <span class="s2">&quot;from_voxel_coordinates&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="p">,</span>
</span><span id="CoordinateSystem-931"><a href="#CoordinateSystem-931"><span class="linenos">931</span></a>            <span class="s2">&quot;to_voxel_coordinates&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_voxel_coordinates</span><span class="p">,</span>
</span><span id="CoordinateSystem-932"><a href="#CoordinateSystem-932"><span class="linenos">932</span></a>        <span class="p">}</span>
</span><span id="CoordinateSystem-933"><a href="#CoordinateSystem-933"><span class="linenos">933</span></a>
</span><span id="CoordinateSystem-934"><a href="#CoordinateSystem-934"><span class="linenos">934</span></a>    <span class="k">def</span> <span class="nf">_modified_copy</span><span class="p">(</span>
</span><span id="CoordinateSystem-935"><a href="#CoordinateSystem-935"><span class="linenos">935</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">tensors</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">children</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]</span>
</span><span id="CoordinateSystem-936"><a href="#CoordinateSystem-936"><span class="linenos">936</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem-937"><a href="#CoordinateSystem-937"><span class="linenos">937</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;from_voxel_coordinates&quot;</span><span class="p">],</span> <span class="n">IHostAffineTransformation</span><span class="p">):</span>
</span><span id="CoordinateSystem-938"><a href="#CoordinateSystem-938"><span class="linenos">938</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;from_voxel_coordinates should be an affine transformation&quot;</span><span class="p">)</span>
</span><span id="CoordinateSystem-939"><a href="#CoordinateSystem-939"><span class="linenos">939</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;to_voxel_coordinates&quot;</span><span class="p">],</span> <span class="n">IHostAffineTransformation</span><span class="p">):</span>
</span><span id="CoordinateSystem-940"><a href="#CoordinateSystem-940"><span class="linenos">940</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;to_voxel_coordinates should be an affine transformation&quot;</span><span class="p">)</span>
</span><span id="CoordinateSystem-941"><a href="#CoordinateSystem-941"><span class="linenos">941</span></a>        <span class="k">return</span> <span class="n">CoordinateSystem</span><span class="p">(</span>
</span><span id="CoordinateSystem-942"><a href="#CoordinateSystem-942"><span class="linenos">942</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem-943"><a href="#CoordinateSystem-943"><span class="linenos">943</span></a>            <span class="n">from_voxel_coordinates</span><span class="o">=</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;from_voxel_coordinates&quot;</span><span class="p">],</span>
</span><span id="CoordinateSystem-944"><a href="#CoordinateSystem-944"><span class="linenos">944</span></a>            <span class="n">to_voxel_coordinates</span><span class="o">=</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;to_voxel_coordinates&quot;</span><span class="p">],</span>
</span><span id="CoordinateSystem-945"><a href="#CoordinateSystem-945"><span class="linenos">945</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Represents coordinate system between voxel and world coordinates on a regular grid</p>

<p>Recommended way to create a coordinate system is to use the factory
methods provided as class method of this class:
<code><a href="#CoordinateSystem.centered_normalized">CoordinateSystem.centered_normalized</a></code>,
<code><a href="#CoordinateSystem.centered">CoordinateSystem.centered</a></code>, <code><a href="#CoordinateSystem.voxel">CoordinateSystem.voxel</a></code>,
<code><a href="#CoordinateSystem.torch_grid_sample">CoordinateSystem.torch_grid_sample</a></code>,
<code><a href="#CoordinateSystem.from_affine_matrix">CoordinateSystem.from_affine_matrix</a></code>,
<code><a href="#CoordinateSystem.from_diagonal_affine_matrix">CoordinateSystem.from_diagonal_affine_matrix</a></code>.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>spatial_shape:</strong>  Spatial shape of the grid</li>
<li><strong>to_voxel_coordinates:</strong>  Affine transformation from world to voxel
coordinates. This should be the inverse of from_voxel_coordinates
and can be omitted if from_voxel_coordinates is given. This should
be a IHostAffineTransformation meaning that the transformation is
stored on the host (cpu) until needed on a target device. That is,
since the transformation may be used in control flow decisions, and
we want to avoid synchronizing the target device with the host.</li>
<li><strong>from_voxel_coordinates:</strong>  Affine transformation from voxel to world
coordinates. This should be the inverse of to_voxel_coordinates
and can be omitted if to_voxel_coordinates is given. This should
be a IHostAffineTransformation meaning that the transformation is
stored on the host (cpu) until needed on a target device. That is,
since the transformation may be used in control flow decisions, and
we want to avoid synchronizing the target device with the host.</li>
</ul>
</div>


                            <div id="CoordinateSystem.__init__" class="classattr">
                                        <input id="CoordinateSystem.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CoordinateSystem</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">to_voxel_coordinates</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="composable_mapping/affine_transformation.html#IHostAffineTransformation">composable_mapping.affine_transformation.IHostAffineTransformation</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">from_voxel_coordinates</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="composable_mapping/affine_transformation.html#IHostAffineTransformation">composable_mapping.affine_transformation.IHostAffineTransformation</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="CoordinateSystem.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.__init__-69"><a href="#CoordinateSystem.__init__-69"><span class="linenos"> 69</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="CoordinateSystem.__init__-70"><a href="#CoordinateSystem.__init__-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CoordinateSystem.__init__-71"><a href="#CoordinateSystem.__init__-71"><span class="linenos"> 71</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="CoordinateSystem.__init__-72"><a href="#CoordinateSystem.__init__-72"><span class="linenos"> 72</span></a>        <span class="n">to_voxel_coordinates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IHostAffineTransformation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.__init__-73"><a href="#CoordinateSystem.__init__-73"><span class="linenos"> 73</span></a>        <span class="n">from_voxel_coordinates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IHostAffineTransformation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.__init__-74"><a href="#CoordinateSystem.__init__-74"><span class="linenos"> 74</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem.__init__-75"><a href="#CoordinateSystem.__init__-75"><span class="linenos"> 75</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="CoordinateSystem.__init__-76"><a href="#CoordinateSystem.__init__-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem.__init__-77"><a href="#CoordinateSystem.__init__-77"><span class="linenos"> 77</span></a>        <span class="k">if</span> <span class="n">from_voxel_coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem.__init__-78"><a href="#CoordinateSystem.__init__-78"><span class="linenos"> 78</span></a>            <span class="k">if</span> <span class="n">to_voxel_coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem.__init__-79"><a href="#CoordinateSystem.__init__-79"><span class="linenos"> 79</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="CoordinateSystem.__init__-80"><a href="#CoordinateSystem.__init__-80"><span class="linenos"> 80</span></a>                    <span class="s2">&quot;Either from_voxel_coordinates or to_voxel_coordinates should be given&quot;</span>
</span><span id="CoordinateSystem.__init__-81"><a href="#CoordinateSystem.__init__-81"><span class="linenos"> 81</span></a>                <span class="p">)</span>
</span><span id="CoordinateSystem.__init__-82"><a href="#CoordinateSystem.__init__-82"><span class="linenos"> 82</span></a>            <span class="n">from_voxel_coordinates</span> <span class="o">=</span> <span class="n">to_voxel_coordinates</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
</span><span id="CoordinateSystem.__init__-83"><a href="#CoordinateSystem.__init__-83"><span class="linenos"> 83</span></a>        <span class="k">elif</span> <span class="n">to_voxel_coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem.__init__-84"><a href="#CoordinateSystem.__init__-84"><span class="linenos"> 84</span></a>            <span class="n">to_voxel_coordinates</span> <span class="o">=</span> <span class="n">from_voxel_coordinates</span><span class="o">.</span><span class="n">invert</span><span class="p">()</span>
</span><span id="CoordinateSystem.__init__-85"><a href="#CoordinateSystem.__init__-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_transformations_which_should_not_be_accessed_directly</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="CoordinateSystem.__init__-86"><a href="#CoordinateSystem.__init__-86"><span class="linenos"> 86</span></a>            <span class="s2">&quot;from_voxel_coordinates&quot;</span><span class="p">:</span> <span class="n">from_voxel_coordinates</span><span class="p">,</span>
</span><span id="CoordinateSystem.__init__-87"><a href="#CoordinateSystem.__init__-87"><span class="linenos"> 87</span></a>            <span class="s2">&quot;to_voxel_coordinates&quot;</span><span class="p">:</span> <span class="n">to_voxel_coordinates</span><span class="p">,</span>
</span><span id="CoordinateSystem.__init__-88"><a href="#CoordinateSystem.__init__-88"><span class="linenos"> 88</span></a>        <span class="p">}</span>
</span><span id="CoordinateSystem.__init__-89"><a href="#CoordinateSystem.__init__-89"><span class="linenos"> 89</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="CoordinateSystem.__init__-90"><a href="#CoordinateSystem.__init__-90"><span class="linenos"> 90</span></a>            <span class="n">get_channels_shape</span><span class="p">(</span><span class="n">from_voxel_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CoordinateSystem.__init__-91"><a href="#CoordinateSystem.__init__-91"><span class="linenos"> 91</span></a>            <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="CoordinateSystem.__init__-92"><a href="#CoordinateSystem.__init__-92"><span class="linenos"> 92</span></a>            <span class="ow">or</span> <span class="n">get_spatial_shape</span><span class="p">(</span><span class="n">from_voxel_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">tuple</span><span class="p">()</span>
</span><span id="CoordinateSystem.__init__-93"><a href="#CoordinateSystem.__init__-93"><span class="linenos"> 93</span></a>        <span class="p">):</span>
</span><span id="CoordinateSystem.__init__-94"><a href="#CoordinateSystem.__init__-94"><span class="linenos"> 94</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid affine transformation for a coordinate system&quot;</span><span class="p">)</span>
</span><span id="CoordinateSystem.__init__-95"><a href="#CoordinateSystem.__init__-95"><span class="linenos"> 95</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="CoordinateSystem.__init__-96"><a href="#CoordinateSystem.__init__-96"><span class="linenos"> 96</span></a>            <span class="n">get_channels_shape</span><span class="p">(</span><span class="n">to_voxel_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CoordinateSystem.__init__-97"><a href="#CoordinateSystem.__init__-97"><span class="linenos"> 97</span></a>            <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="CoordinateSystem.__init__-98"><a href="#CoordinateSystem.__init__-98"><span class="linenos"> 98</span></a>            <span class="ow">or</span> <span class="n">get_spatial_shape</span><span class="p">(</span><span class="n">to_voxel_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">tuple</span><span class="p">()</span>
</span><span id="CoordinateSystem.__init__-99"><a href="#CoordinateSystem.__init__-99"><span class="linenos"> 99</span></a>        <span class="p">):</span>
</span><span id="CoordinateSystem.__init__-100"><a href="#CoordinateSystem.__init__-100"><span class="linenos">100</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid affine transformation for a coordinate system&quot;</span><span class="p">)</span>
</span><span id="CoordinateSystem.__init__-101"><a href="#CoordinateSystem.__init__-101"><span class="linenos">101</span></a>        <span class="c1"># Trick to make torch.nn.Module type conversion work automatically, we</span>
</span><span id="CoordinateSystem.__init__-102"><a href="#CoordinateSystem.__init__-102"><span class="linenos">102</span></a>        <span class="c1"># use the empty indicator tensor to infer the device and dtype of the</span>
</span><span id="CoordinateSystem.__init__-103"><a href="#CoordinateSystem.__init__-103"><span class="linenos">103</span></a>        <span class="c1"># coordinate system.</span>
</span><span id="CoordinateSystem.__init__-104"><a href="#CoordinateSystem.__init__-104"><span class="linenos">104</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span>
</span><span id="CoordinateSystem.__init__-105"><a href="#CoordinateSystem.__init__-105"><span class="linenos">105</span></a>            <span class="s2">&quot;_indicator&quot;</span><span class="p">,</span>
</span><span id="CoordinateSystem.__init__-106"><a href="#CoordinateSystem.__init__-106"><span class="linenos">106</span></a>            <span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">to_voxel_coordinates</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">to_voxel_coordinates</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="CoordinateSystem.__init__-107"><a href="#CoordinateSystem.__init__-107"><span class="linenos">107</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
</div>


                            </div>
                            <div id="CoordinateSystem.centered_normalized" class="classattr">
                                        <input id="CoordinateSystem.centered_normalized-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">centered_normalized</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">voxel_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">fov_convention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;full_voxels&#39;</span>,</span><span class="param">	<span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.centered_normalized-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.centered_normalized"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.centered_normalized-109"><a href="#CoordinateSystem.centered_normalized-109"><span class="linenos">109</span></a>    <span class="nd">@classmethod</span>
</span><span id="CoordinateSystem.centered_normalized-110"><a href="#CoordinateSystem.centered_normalized-110"><span class="linenos">110</span></a>    <span class="k">def</span> <span class="nf">centered_normalized</span><span class="p">(</span>
</span><span id="CoordinateSystem.centered_normalized-111"><a href="#CoordinateSystem.centered_normalized-111"><span class="linenos">111</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="CoordinateSystem.centered_normalized-112"><a href="#CoordinateSystem.centered_normalized-112"><span class="linenos">112</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="CoordinateSystem.centered_normalized-113"><a href="#CoordinateSystem.centered_normalized-113"><span class="linenos">113</span></a>        <span class="n">voxel_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="CoordinateSystem.centered_normalized-114"><a href="#CoordinateSystem.centered_normalized-114"><span class="linenos">114</span></a>        <span class="n">fov_convention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">,</span>
</span><span id="CoordinateSystem.centered_normalized-115"><a href="#CoordinateSystem.centered_normalized-115"><span class="linenos">115</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.centered_normalized-116"><a href="#CoordinateSystem.centered_normalized-116"><span class="linenos">116</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.centered_normalized-117"><a href="#CoordinateSystem.centered_normalized-117"><span class="linenos">117</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.centered_normalized-118"><a href="#CoordinateSystem.centered_normalized-118"><span class="linenos">118</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a centered normalized coordinate system.</span>
</span><span id="CoordinateSystem.centered_normalized-119"><a href="#CoordinateSystem.centered_normalized-119"><span class="linenos">119</span></a>
</span><span id="CoordinateSystem.centered_normalized-120"><a href="#CoordinateSystem.centered_normalized-120"><span class="linenos">120</span></a><span class="sd">        The coordinate system is normalized such that the grid just fits into the</span>
</span><span id="CoordinateSystem.centered_normalized-121"><a href="#CoordinateSystem.centered_normalized-121"><span class="linenos">121</span></a><span class="sd">        cube from -1 to 1 in each dimension. The grid is centered in the cube.</span>
</span><span id="CoordinateSystem.centered_normalized-122"><a href="#CoordinateSystem.centered_normalized-122"><span class="linenos">122</span></a>
</span><span id="CoordinateSystem.centered_normalized-123"><a href="#CoordinateSystem.centered_normalized-123"><span class="linenos">123</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem.centered_normalized-124"><a href="#CoordinateSystem.centered_normalized-124"><span class="linenos">124</span></a><span class="sd">            spatial_shape: Spatial shape of the grid.</span>
</span><span id="CoordinateSystem.centered_normalized-125"><a href="#CoordinateSystem.centered_normalized-125"><span class="linenos">125</span></a><span class="sd">            voxel_size: Relative voxel size of the grid.</span>
</span><span id="CoordinateSystem.centered_normalized-126"><a href="#CoordinateSystem.centered_normalized-126"><span class="linenos">126</span></a><span class="sd">            fov_convention: Convention for defining the field of view, either &quot;full_voxels&quot;</span>
</span><span id="CoordinateSystem.centered_normalized-127"><a href="#CoordinateSystem.centered_normalized-127"><span class="linenos">127</span></a><span class="sd">                or &quot;voxel_centers&quot;. If voxels are seens as cubes with the value at the</span>
</span><span id="CoordinateSystem.centered_normalized-128"><a href="#CoordinateSystem.centered_normalized-128"><span class="linenos">128</span></a><span class="sd">                center, the convention &quot;full voxels&quot; includes the full cubes in the field</span>
</span><span id="CoordinateSystem.centered_normalized-129"><a href="#CoordinateSystem.centered_normalized-129"><span class="linenos">129</span></a><span class="sd">                of view, while the convention &quot;voxel_centers&quot; includes only the centers.</span>
</span><span id="CoordinateSystem.centered_normalized-130"><a href="#CoordinateSystem.centered_normalized-130"><span class="linenos">130</span></a><span class="sd">                The latter results in a field of view that is one voxel smaller in each</span>
</span><span id="CoordinateSystem.centered_normalized-131"><a href="#CoordinateSystem.centered_normalized-131"><span class="linenos">131</span></a><span class="sd">                dimension. Similar to the align_corners option in</span>
</span><span id="CoordinateSystem.centered_normalized-132"><a href="#CoordinateSystem.centered_normalized-132"><span class="linenos">132</span></a><span class="sd">                torch.nn.functional.grid_sample.</span>
</span><span id="CoordinateSystem.centered_normalized-133"><a href="#CoordinateSystem.centered_normalized-133"><span class="linenos">133</span></a><span class="sd">            dtype: Data type of the created coordinate system.</span>
</span><span id="CoordinateSystem.centered_normalized-134"><a href="#CoordinateSystem.centered_normalized-134"><span class="linenos">134</span></a><span class="sd">            device: Device of the created coordinate system.</span>
</span><span id="CoordinateSystem.centered_normalized-135"><a href="#CoordinateSystem.centered_normalized-135"><span class="linenos">135</span></a>
</span><span id="CoordinateSystem.centered_normalized-136"><a href="#CoordinateSystem.centered_normalized-136"><span class="linenos">136</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem.centered_normalized-137"><a href="#CoordinateSystem.centered_normalized-137"><span class="linenos">137</span></a><span class="sd">            Centered normalized coordinate system.</span>
</span><span id="CoordinateSystem.centered_normalized-138"><a href="#CoordinateSystem.centered_normalized-138"><span class="linenos">138</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.centered_normalized-139"><a href="#CoordinateSystem.centered_normalized-139"><span class="linenos">139</span></a>        <span class="n">centered</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">centered</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">voxel_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="CoordinateSystem.centered_normalized-140"><a href="#CoordinateSystem.centered_normalized-140"><span class="linenos">140</span></a>        <span class="n">voxel_size</span> <span class="o">=</span> <span class="n">centered</span><span class="o">.</span><span class="n">grid_spacing_cpu</span><span class="p">()</span>
</span><span id="CoordinateSystem.centered_normalized-141"><a href="#CoordinateSystem.centered_normalized-141"><span class="linenos">141</span></a>        <span class="n">shape_tensor</span> <span class="o">=</span> <span class="n">voxel_size</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem.centered_normalized-142"><a href="#CoordinateSystem.centered_normalized-142"><span class="linenos">142</span></a>        <span class="k">if</span> <span class="n">fov_convention</span> <span class="o">==</span> <span class="s2">&quot;voxel_centers&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.centered_normalized-143"><a href="#CoordinateSystem.centered_normalized-143"><span class="linenos">143</span></a>            <span class="n">shape_tensor</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="CoordinateSystem.centered_normalized-144"><a href="#CoordinateSystem.centered_normalized-144"><span class="linenos">144</span></a>        <span class="k">elif</span> <span class="n">fov_convention</span> <span class="o">!=</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.centered_normalized-145"><a href="#CoordinateSystem.centered_normalized-145"><span class="linenos">145</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown fov convention </span><span class="si">{</span><span class="n">fov_convention</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CoordinateSystem.centered_normalized-146"><a href="#CoordinateSystem.centered_normalized-146"><span class="linenos">146</span></a>        <span class="n">fov_sizes</span> <span class="o">=</span> <span class="n">shape_tensor</span> <span class="o">*</span> <span class="n">voxel_size</span>
</span><span id="CoordinateSystem.centered_normalized-147"><a href="#CoordinateSystem.centered_normalized-147"><span class="linenos">147</span></a>        <span class="n">max_fov_size_index</span> <span class="o">=</span> <span class="n">fov_sizes</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
</span><span id="CoordinateSystem.centered_normalized-148"><a href="#CoordinateSystem.centered_normalized-148"><span class="linenos">148</span></a>        <span class="n">relative_voxel_sizes</span> <span class="o">=</span> <span class="n">voxel_size</span> <span class="o">/</span> <span class="n">voxel_size</span><span class="p">[</span><span class="n">max_fov_size_index</span><span class="p">]</span>
</span><span id="CoordinateSystem.centered_normalized-149"><a href="#CoordinateSystem.centered_normalized-149"><span class="linenos">149</span></a>        <span class="n">target_voxel_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">fov_sizes</span><span class="p">[</span><span class="n">max_fov_size_index</span><span class="p">]</span> <span class="o">*</span> <span class="n">relative_voxel_sizes</span>
</span><span id="CoordinateSystem.centered_normalized-150"><a href="#CoordinateSystem.centered_normalized-150"><span class="linenos">150</span></a>        <span class="k">return</span> <span class="n">centered</span><span class="o">.</span><span class="n">reformat</span><span class="p">(</span>
</span><span id="CoordinateSystem.centered_normalized-151"><a href="#CoordinateSystem.centered_normalized-151"><span class="linenos">151</span></a>            <span class="n">voxel_size</span><span class="o">=</span><span class="n">target_voxel_size</span><span class="p">,</span>
</span><span id="CoordinateSystem.centered_normalized-152"><a href="#CoordinateSystem.centered_normalized-152"><span class="linenos">152</span></a>            <span class="n">reference</span><span class="o">=</span><span class="n">Center</span><span class="p">(),</span>
</span><span id="CoordinateSystem.centered_normalized-153"><a href="#CoordinateSystem.centered_normalized-153"><span class="linenos">153</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="n">OriginalShape</span><span class="p">(),</span>
</span><span id="CoordinateSystem.centered_normalized-154"><a href="#CoordinateSystem.centered_normalized-154"><span class="linenos">154</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a centered normalized coordinate system.</p>

<p>The coordinate system is normalized such that the grid just fits into the
cube from -1 to 1 in each dimension. The grid is centered in the cube.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>spatial_shape:</strong>  Spatial shape of the grid.</li>
<li><strong>voxel_size:</strong>  Relative voxel size of the grid.</li>
<li><strong>fov_convention:</strong>  Convention for defining the field of view, either "full_voxels"
or "voxel_centers". If voxels are seens as cubes with the value at the
center, the convention "full voxels" includes the full cubes in the field
of view, while the convention "voxel_centers" includes only the centers.
The latter results in a field of view that is one voxel smaller in each
dimension. Similar to the align_corners option in
torch.nn.functional.grid_sample.</li>
<li><strong>dtype:</strong>  Data type of the created coordinate system.</li>
<li><strong>device:</strong>  Device of the created coordinate system.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Centered normalized coordinate system.</p>
</blockquote>
</div>


                            </div>
                            <div id="CoordinateSystem.centered" class="classattr">
                                        <input id="CoordinateSystem.centered-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">centered</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">voxel_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.centered-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.centered"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.centered-156"><a href="#CoordinateSystem.centered-156"><span class="linenos">156</span></a>    <span class="nd">@classmethod</span>
</span><span id="CoordinateSystem.centered-157"><a href="#CoordinateSystem.centered-157"><span class="linenos">157</span></a>    <span class="k">def</span> <span class="nf">centered</span><span class="p">(</span>
</span><span id="CoordinateSystem.centered-158"><a href="#CoordinateSystem.centered-158"><span class="linenos">158</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="CoordinateSystem.centered-159"><a href="#CoordinateSystem.centered-159"><span class="linenos">159</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="CoordinateSystem.centered-160"><a href="#CoordinateSystem.centered-160"><span class="linenos">160</span></a>        <span class="n">voxel_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="CoordinateSystem.centered-161"><a href="#CoordinateSystem.centered-161"><span class="linenos">161</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.centered-162"><a href="#CoordinateSystem.centered-162"><span class="linenos">162</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.centered-163"><a href="#CoordinateSystem.centered-163"><span class="linenos">163</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.centered-164"><a href="#CoordinateSystem.centered-164"><span class="linenos">164</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create centered coordinate system with a given voxel size.</span>
</span><span id="CoordinateSystem.centered-165"><a href="#CoordinateSystem.centered-165"><span class="linenos">165</span></a>
</span><span id="CoordinateSystem.centered-166"><a href="#CoordinateSystem.centered-166"><span class="linenos">166</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem.centered-167"><a href="#CoordinateSystem.centered-167"><span class="linenos">167</span></a><span class="sd">            spatial_shape: Spatial shape of the grid.</span>
</span><span id="CoordinateSystem.centered-168"><a href="#CoordinateSystem.centered-168"><span class="linenos">168</span></a><span class="sd">            voxel_size: Voxel size of the grid.</span>
</span><span id="CoordinateSystem.centered-169"><a href="#CoordinateSystem.centered-169"><span class="linenos">169</span></a><span class="sd">            dtype: Data type of the created coordinate system.</span>
</span><span id="CoordinateSystem.centered-170"><a href="#CoordinateSystem.centered-170"><span class="linenos">170</span></a><span class="sd">            device: Device of the created coordinate system.</span>
</span><span id="CoordinateSystem.centered-171"><a href="#CoordinateSystem.centered-171"><span class="linenos">171</span></a>
</span><span id="CoordinateSystem.centered-172"><a href="#CoordinateSystem.centered-172"><span class="linenos">172</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem.centered-173"><a href="#CoordinateSystem.centered-173"><span class="linenos">173</span></a><span class="sd">            Centered coordinate system.</span>
</span><span id="CoordinateSystem.centered-174"><a href="#CoordinateSystem.centered-174"><span class="linenos">174</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.centered-175"><a href="#CoordinateSystem.centered-175"><span class="linenos">175</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">voxel</span><span class="p">(</span>
</span><span id="CoordinateSystem.centered-176"><a href="#CoordinateSystem.centered-176"><span class="linenos">176</span></a>            <span class="n">spatial_shape</span><span class="p">,</span> <span class="n">voxel_size</span><span class="o">=</span><span class="n">voxel_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
</span><span id="CoordinateSystem.centered-177"><a href="#CoordinateSystem.centered-177"><span class="linenos">177</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">translate_voxel</span><span class="p">([</span><span class="o">-</span><span class="p">(</span><span class="n">dim_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">dim_size</span> <span class="ow">in</span> <span class="n">spatial_shape</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Create centered coordinate system with a given voxel size.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>spatial_shape:</strong>  Spatial shape of the grid.</li>
<li><strong>voxel_size:</strong>  Voxel size of the grid.</li>
<li><strong>dtype:</strong>  Data type of the created coordinate system.</li>
<li><strong>device:</strong>  Device of the created coordinate system.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Centered coordinate system.</p>
</blockquote>
</div>


                            </div>
                            <div id="CoordinateSystem.voxel" class="classattr">
                                        <input id="CoordinateSystem.voxel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">voxel</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">voxel_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.voxel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.voxel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.voxel-179"><a href="#CoordinateSystem.voxel-179"><span class="linenos">179</span></a>    <span class="nd">@classmethod</span>
</span><span id="CoordinateSystem.voxel-180"><a href="#CoordinateSystem.voxel-180"><span class="linenos">180</span></a>    <span class="k">def</span> <span class="nf">voxel</span><span class="p">(</span>
</span><span id="CoordinateSystem.voxel-181"><a href="#CoordinateSystem.voxel-181"><span class="linenos">181</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="CoordinateSystem.voxel-182"><a href="#CoordinateSystem.voxel-182"><span class="linenos">182</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="CoordinateSystem.voxel-183"><a href="#CoordinateSystem.voxel-183"><span class="linenos">183</span></a>        <span class="n">voxel_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.voxel-184"><a href="#CoordinateSystem.voxel-184"><span class="linenos">184</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.voxel-185"><a href="#CoordinateSystem.voxel-185"><span class="linenos">185</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.voxel-186"><a href="#CoordinateSystem.voxel-186"><span class="linenos">186</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.voxel-187"><a href="#CoordinateSystem.voxel-187"><span class="linenos">187</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create coordinate system corresponding to the voxel coordinate</span>
</span><span id="CoordinateSystem.voxel-188"><a href="#CoordinateSystem.voxel-188"><span class="linenos">188</span></a><span class="sd">        potentially scaled by the voxel size.</span>
</span><span id="CoordinateSystem.voxel-189"><a href="#CoordinateSystem.voxel-189"><span class="linenos">189</span></a>
</span><span id="CoordinateSystem.voxel-190"><a href="#CoordinateSystem.voxel-190"><span class="linenos">190</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem.voxel-191"><a href="#CoordinateSystem.voxel-191"><span class="linenos">191</span></a><span class="sd">            spatial_shape: Spatial shape of the grid.</span>
</span><span id="CoordinateSystem.voxel-192"><a href="#CoordinateSystem.voxel-192"><span class="linenos">192</span></a><span class="sd">            voxel_size: Voxel size of the grid.</span>
</span><span id="CoordinateSystem.voxel-193"><a href="#CoordinateSystem.voxel-193"><span class="linenos">193</span></a><span class="sd">            dtype: Data type of the created coordinate system.</span>
</span><span id="CoordinateSystem.voxel-194"><a href="#CoordinateSystem.voxel-194"><span class="linenos">194</span></a><span class="sd">            device: Device of the created coordinate system.</span>
</span><span id="CoordinateSystem.voxel-195"><a href="#CoordinateSystem.voxel-195"><span class="linenos">195</span></a>
</span><span id="CoordinateSystem.voxel-196"><a href="#CoordinateSystem.voxel-196"><span class="linenos">196</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem.voxel-197"><a href="#CoordinateSystem.voxel-197"><span class="linenos">197</span></a><span class="sd">            Voxel coordinate system.</span>
</span><span id="CoordinateSystem.voxel-198"><a href="#CoordinateSystem.voxel-198"><span class="linenos">198</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.voxel-199"><a href="#CoordinateSystem.voxel-199"><span class="linenos">199</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_diagonal_affine_matrix</span><span class="p">(</span>
</span><span id="CoordinateSystem.voxel-200"><a href="#CoordinateSystem.voxel-200"><span class="linenos">200</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem.voxel-201"><a href="#CoordinateSystem.voxel-201"><span class="linenos">201</span></a>            <span class="n">diagonal</span><span class="o">=</span><span class="n">voxel_size</span><span class="p">,</span>
</span><span id="CoordinateSystem.voxel-202"><a href="#CoordinateSystem.voxel-202"><span class="linenos">202</span></a>            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="CoordinateSystem.voxel-203"><a href="#CoordinateSystem.voxel-203"><span class="linenos">203</span></a>            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="CoordinateSystem.voxel-204"><a href="#CoordinateSystem.voxel-204"><span class="linenos">204</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create coordinate system corresponding to the voxel coordinate
potentially scaled by the voxel size.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>spatial_shape:</strong>  Spatial shape of the grid.</li>
<li><strong>voxel_size:</strong>  Voxel size of the grid.</li>
<li><strong>dtype:</strong>  Data type of the created coordinate system.</li>
<li><strong>device:</strong>  Device of the created coordinate system.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Voxel coordinate system.</p>
</blockquote>
</div>


                            </div>
                            <div id="CoordinateSystem.torch_grid_sample" class="classattr">
                                        <input id="CoordinateSystem.torch_grid_sample-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">torch_grid_sample</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">fov_convention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;full_voxels&#39;</span>,</span><span class="param">	<span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.torch_grid_sample-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.torch_grid_sample"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.torch_grid_sample-206"><a href="#CoordinateSystem.torch_grid_sample-206"><span class="linenos">206</span></a>    <span class="nd">@classmethod</span>
</span><span id="CoordinateSystem.torch_grid_sample-207"><a href="#CoordinateSystem.torch_grid_sample-207"><span class="linenos">207</span></a>    <span class="k">def</span> <span class="nf">torch_grid_sample</span><span class="p">(</span>
</span><span id="CoordinateSystem.torch_grid_sample-208"><a href="#CoordinateSystem.torch_grid_sample-208"><span class="linenos">208</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="CoordinateSystem.torch_grid_sample-209"><a href="#CoordinateSystem.torch_grid_sample-209"><span class="linenos">209</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="CoordinateSystem.torch_grid_sample-210"><a href="#CoordinateSystem.torch_grid_sample-210"><span class="linenos">210</span></a>        <span class="n">fov_convention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">,</span>
</span><span id="CoordinateSystem.torch_grid_sample-211"><a href="#CoordinateSystem.torch_grid_sample-211"><span class="linenos">211</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.torch_grid_sample-212"><a href="#CoordinateSystem.torch_grid_sample-212"><span class="linenos">212</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.torch_grid_sample-213"><a href="#CoordinateSystem.torch_grid_sample-213"><span class="linenos">213</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.torch_grid_sample-214"><a href="#CoordinateSystem.torch_grid_sample-214"><span class="linenos">214</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create coordinate system corresponding to the one used by the</span>
</span><span id="CoordinateSystem.torch_grid_sample-215"><a href="#CoordinateSystem.torch_grid_sample-215"><span class="linenos">215</span></a><span class="sd">        torch.nn.functional.grid_sample.</span>
</span><span id="CoordinateSystem.torch_grid_sample-216"><a href="#CoordinateSystem.torch_grid_sample-216"><span class="linenos">216</span></a>
</span><span id="CoordinateSystem.torch_grid_sample-217"><a href="#CoordinateSystem.torch_grid_sample-217"><span class="linenos">217</span></a><span class="sd">        The coordinate system is normalized along each dimensions to the range</span>
</span><span id="CoordinateSystem.torch_grid_sample-218"><a href="#CoordinateSystem.torch_grid_sample-218"><span class="linenos">218</span></a><span class="sd">        from -1 to 1.</span>
</span><span id="CoordinateSystem.torch_grid_sample-219"><a href="#CoordinateSystem.torch_grid_sample-219"><span class="linenos">219</span></a>
</span><span id="CoordinateSystem.torch_grid_sample-220"><a href="#CoordinateSystem.torch_grid_sample-220"><span class="linenos">220</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem.torch_grid_sample-221"><a href="#CoordinateSystem.torch_grid_sample-221"><span class="linenos">221</span></a><span class="sd">            spatial_shape: Spatial shape of the grid.</span>
</span><span id="CoordinateSystem.torch_grid_sample-222"><a href="#CoordinateSystem.torch_grid_sample-222"><span class="linenos">222</span></a><span class="sd">            fov_convention: Convention for defining the field of view, either &quot;full_voxels&quot;</span>
</span><span id="CoordinateSystem.torch_grid_sample-223"><a href="#CoordinateSystem.torch_grid_sample-223"><span class="linenos">223</span></a><span class="sd">                or &quot;voxel_centers&quot;. If voxels are seens as cubes with the value at the</span>
</span><span id="CoordinateSystem.torch_grid_sample-224"><a href="#CoordinateSystem.torch_grid_sample-224"><span class="linenos">224</span></a><span class="sd">                center, the convention &quot;full voxels&quot; includes the full cubes in the field</span>
</span><span id="CoordinateSystem.torch_grid_sample-225"><a href="#CoordinateSystem.torch_grid_sample-225"><span class="linenos">225</span></a><span class="sd">                of view, while the convention &quot;voxel_centers&quot; includes only the centers.</span>
</span><span id="CoordinateSystem.torch_grid_sample-226"><a href="#CoordinateSystem.torch_grid_sample-226"><span class="linenos">226</span></a><span class="sd">                The latter results in a field of view that is one voxel smaller in each</span>
</span><span id="CoordinateSystem.torch_grid_sample-227"><a href="#CoordinateSystem.torch_grid_sample-227"><span class="linenos">227</span></a><span class="sd">                dimension. Similar to the align_corners option in</span>
</span><span id="CoordinateSystem.torch_grid_sample-228"><a href="#CoordinateSystem.torch_grid_sample-228"><span class="linenos">228</span></a><span class="sd">                torch.nn.functional.grid_sample.</span>
</span><span id="CoordinateSystem.torch_grid_sample-229"><a href="#CoordinateSystem.torch_grid_sample-229"><span class="linenos">229</span></a><span class="sd">            dtype: Data type of the created coordinate system.</span>
</span><span id="CoordinateSystem.torch_grid_sample-230"><a href="#CoordinateSystem.torch_grid_sample-230"><span class="linenos">230</span></a><span class="sd">            device: Device of the created coordinate system.</span>
</span><span id="CoordinateSystem.torch_grid_sample-231"><a href="#CoordinateSystem.torch_grid_sample-231"><span class="linenos">231</span></a>
</span><span id="CoordinateSystem.torch_grid_sample-232"><a href="#CoordinateSystem.torch_grid_sample-232"><span class="linenos">232</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem.torch_grid_sample-233"><a href="#CoordinateSystem.torch_grid_sample-233"><span class="linenos">233</span></a><span class="sd">            Coordinate system corresponding to the one used by the</span>
</span><span id="CoordinateSystem.torch_grid_sample-234"><a href="#CoordinateSystem.torch_grid_sample-234"><span class="linenos">234</span></a><span class="sd">            torch.nn.functional.grid_sample.</span>
</span><span id="CoordinateSystem.torch_grid_sample-235"><a href="#CoordinateSystem.torch_grid_sample-235"><span class="linenos">235</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.torch_grid_sample-236"><a href="#CoordinateSystem.torch_grid_sample-236"><span class="linenos">236</span></a>        <span class="n">centered</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">centered</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
</span><span id="CoordinateSystem.torch_grid_sample-237"><a href="#CoordinateSystem.torch_grid_sample-237"><span class="linenos">237</span></a>        <span class="n">shape_tensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">centered</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch_device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">))</span>
</span><span id="CoordinateSystem.torch_grid_sample-238"><a href="#CoordinateSystem.torch_grid_sample-238"><span class="linenos">238</span></a>        <span class="k">if</span> <span class="n">fov_convention</span> <span class="o">==</span> <span class="s2">&quot;voxel_centers&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.torch_grid_sample-239"><a href="#CoordinateSystem.torch_grid_sample-239"><span class="linenos">239</span></a>            <span class="n">shape_tensor</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="CoordinateSystem.torch_grid_sample-240"><a href="#CoordinateSystem.torch_grid_sample-240"><span class="linenos">240</span></a>        <span class="k">elif</span> <span class="n">fov_convention</span> <span class="o">!=</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.torch_grid_sample-241"><a href="#CoordinateSystem.torch_grid_sample-241"><span class="linenos">241</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown fov convention </span><span class="si">{</span><span class="n">fov_convention</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="CoordinateSystem.torch_grid_sample-242"><a href="#CoordinateSystem.torch_grid_sample-242"><span class="linenos">242</span></a>        <span class="n">fov_sizes</span> <span class="o">=</span> <span class="n">shape_tensor</span>
</span><span id="CoordinateSystem.torch_grid_sample-243"><a href="#CoordinateSystem.torch_grid_sample-243"><span class="linenos">243</span></a>        <span class="n">target_voxel_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">fov_sizes</span>
</span><span id="CoordinateSystem.torch_grid_sample-244"><a href="#CoordinateSystem.torch_grid_sample-244"><span class="linenos">244</span></a>        <span class="k">return</span> <span class="n">centered</span><span class="o">.</span><span class="n">reformat</span><span class="p">(</span>
</span><span id="CoordinateSystem.torch_grid_sample-245"><a href="#CoordinateSystem.torch_grid_sample-245"><span class="linenos">245</span></a>            <span class="n">voxel_size</span><span class="o">=</span><span class="n">target_voxel_size</span><span class="p">,</span>
</span><span id="CoordinateSystem.torch_grid_sample-246"><a href="#CoordinateSystem.torch_grid_sample-246"><span class="linenos">246</span></a>            <span class="n">reference</span><span class="o">=</span><span class="n">Center</span><span class="p">(),</span>
</span><span id="CoordinateSystem.torch_grid_sample-247"><a href="#CoordinateSystem.torch_grid_sample-247"><span class="linenos">247</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="n">OriginalShape</span><span class="p">(),</span>
</span><span id="CoordinateSystem.torch_grid_sample-248"><a href="#CoordinateSystem.torch_grid_sample-248"><span class="linenos">248</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create coordinate system corresponding to the one used by the
torch.nn.functional.grid_sample.</p>

<p>The coordinate system is normalized along each dimensions to the range
from -1 to 1.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>spatial_shape:</strong>  Spatial shape of the grid.</li>
<li><strong>fov_convention:</strong>  Convention for defining the field of view, either "full_voxels"
or "voxel_centers". If voxels are seens as cubes with the value at the
center, the convention "full voxels" includes the full cubes in the field
of view, while the convention "voxel_centers" includes only the centers.
The latter results in a field of view that is one voxel smaller in each
dimension. Similar to the align_corners option in
torch.nn.functional.grid_sample.</li>
<li><strong>dtype:</strong>  Data type of the created coordinate system.</li>
<li><strong>device:</strong>  Device of the created coordinate system.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Coordinate system corresponding to the one used by the
  torch.nn.functional.grid_sample.</p>
</blockquote>
</div>


                            </div>
                            <div id="CoordinateSystem.from_affine_matrix" class="classattr">
                                        <input id="CoordinateSystem.from_affine_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_affine_matrix</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">affine_matrix</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>,</span><span class="param">	<span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.from_affine_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.from_affine_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.from_affine_matrix-250"><a href="#CoordinateSystem.from_affine_matrix-250"><span class="linenos">250</span></a>    <span class="nd">@classmethod</span>
</span><span id="CoordinateSystem.from_affine_matrix-251"><a href="#CoordinateSystem.from_affine_matrix-251"><span class="linenos">251</span></a>    <span class="k">def</span> <span class="nf">from_affine_matrix</span><span class="p">(</span>
</span><span id="CoordinateSystem.from_affine_matrix-252"><a href="#CoordinateSystem.from_affine_matrix-252"><span class="linenos">252</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="CoordinateSystem.from_affine_matrix-253"><a href="#CoordinateSystem.from_affine_matrix-253"><span class="linenos">253</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="CoordinateSystem.from_affine_matrix-254"><a href="#CoordinateSystem.from_affine_matrix-254"><span class="linenos">254</span></a>        <span class="n">affine_matrix</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CoordinateSystem.from_affine_matrix-255"><a href="#CoordinateSystem.from_affine_matrix-255"><span class="linenos">255</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.from_affine_matrix-256"><a href="#CoordinateSystem.from_affine_matrix-256"><span class="linenos">256</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.from_affine_matrix-257"><a href="#CoordinateSystem.from_affine_matrix-257"><span class="linenos">257</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create coordinate system from an affine matrix</span>
</span><span id="CoordinateSystem.from_affine_matrix-258"><a href="#CoordinateSystem.from_affine_matrix-258"><span class="linenos">258</span></a>
</span><span id="CoordinateSystem.from_affine_matrix-259"><a href="#CoordinateSystem.from_affine_matrix-259"><span class="linenos">259</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem.from_affine_matrix-260"><a href="#CoordinateSystem.from_affine_matrix-260"><span class="linenos">260</span></a><span class="sd">            spatial_shape: Spatial shape of the grid</span>
</span><span id="CoordinateSystem.from_affine_matrix-261"><a href="#CoordinateSystem.from_affine_matrix-261"><span class="linenos">261</span></a><span class="sd">            affine_matrix: Affine matrix describing the transformation</span>
</span><span id="CoordinateSystem.from_affine_matrix-262"><a href="#CoordinateSystem.from_affine_matrix-262"><span class="linenos">262</span></a><span class="sd">                from voxel to world coordinates. Tensor with shape</span>
</span><span id="CoordinateSystem.from_affine_matrix-263"><a href="#CoordinateSystem.from_affine_matrix-263"><span class="linenos">263</span></a><span class="sd">                ([*batch_shape, ]n_output_dims + 1, n_input_dims + 1).</span>
</span><span id="CoordinateSystem.from_affine_matrix-264"><a href="#CoordinateSystem.from_affine_matrix-264"><span class="linenos">264</span></a><span class="sd">                The affine matrix tensor should be provided on the host (cpu).</span>
</span><span id="CoordinateSystem.from_affine_matrix-265"><a href="#CoordinateSystem.from_affine_matrix-265"><span class="linenos">265</span></a><span class="sd">                That is, since the transformation may be used in control flow</span>
</span><span id="CoordinateSystem.from_affine_matrix-266"><a href="#CoordinateSystem.from_affine_matrix-266"><span class="linenos">266</span></a><span class="sd">                decisions, and we want to avoid synchronizing the target device</span>
</span><span id="CoordinateSystem.from_affine_matrix-267"><a href="#CoordinateSystem.from_affine_matrix-267"><span class="linenos">267</span></a><span class="sd">                with the host. The matrix is moved to the target device</span>
</span><span id="CoordinateSystem.from_affine_matrix-268"><a href="#CoordinateSystem.from_affine_matrix-268"><span class="linenos">268</span></a><span class="sd">                asynchronously, if needed.</span>
</span><span id="CoordinateSystem.from_affine_matrix-269"><a href="#CoordinateSystem.from_affine_matrix-269"><span class="linenos">269</span></a><span class="sd">            device: Device of the created coordinate system.</span>
</span><span id="CoordinateSystem.from_affine_matrix-270"><a href="#CoordinateSystem.from_affine_matrix-270"><span class="linenos">270</span></a>
</span><span id="CoordinateSystem.from_affine_matrix-271"><a href="#CoordinateSystem.from_affine_matrix-271"><span class="linenos">271</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem.from_affine_matrix-272"><a href="#CoordinateSystem.from_affine_matrix-272"><span class="linenos">272</span></a><span class="sd">            Coordinate system with the given affine matrix.</span>
</span><span id="CoordinateSystem.from_affine_matrix-273"><a href="#CoordinateSystem.from_affine_matrix-273"><span class="linenos">273</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.from_affine_matrix-274"><a href="#CoordinateSystem.from_affine_matrix-274"><span class="linenos">274</span></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">_ensure_tensor_on_host</span><span class="p">(</span><span class="n">affine_matrix</span><span class="p">)</span>
</span><span id="CoordinateSystem.from_affine_matrix-275"><a href="#CoordinateSystem.from_affine_matrix-275"><span class="linenos">275</span></a>        <span class="k">return</span> <span class="n">CoordinateSystem</span><span class="p">(</span>
</span><span id="CoordinateSystem.from_affine_matrix-276"><a href="#CoordinateSystem.from_affine_matrix-276"><span class="linenos">276</span></a>            <span class="n">from_voxel_coordinates</span><span class="o">=</span><span class="n">HostAffineTransformation</span><span class="p">(</span>
</span><span id="CoordinateSystem.from_affine_matrix-277"><a href="#CoordinateSystem.from_affine_matrix-277"><span class="linenos">277</span></a>                <span class="n">affine_matrix</span><span class="p">,</span>
</span><span id="CoordinateSystem.from_affine_matrix-278"><a href="#CoordinateSystem.from_affine_matrix-278"><span class="linenos">278</span></a>                <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="CoordinateSystem.from_affine_matrix-279"><a href="#CoordinateSystem.from_affine_matrix-279"><span class="linenos">279</span></a>            <span class="p">),</span>
</span><span id="CoordinateSystem.from_affine_matrix-280"><a href="#CoordinateSystem.from_affine_matrix-280"><span class="linenos">280</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem.from_affine_matrix-281"><a href="#CoordinateSystem.from_affine_matrix-281"><span class="linenos">281</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create coordinate system from an affine matrix</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>spatial_shape:</strong>  Spatial shape of the grid</li>
<li><strong>affine_matrix:</strong>  Affine matrix describing the transformation
from voxel to world coordinates. Tensor with shape
([*batch_shape, ]n_output_dims + 1, n_input_dims + 1).
The affine matrix tensor should be provided on the host (cpu).
That is, since the transformation may be used in control flow
decisions, and we want to avoid synchronizing the target device
with the host. The matrix is moved to the target device
asynchronously, if needed.</li>
<li><strong>device:</strong>  Device of the created coordinate system.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Coordinate system with the given affine matrix.</p>
</blockquote>
</div>


                            </div>
                            <div id="CoordinateSystem.from_diagonal_affine_matrix" class="classattr">
                                        <input id="CoordinateSystem.from_diagonal_affine_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_diagonal_affine_matrix</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">diagonal</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">translation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.from_diagonal_affine_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.from_diagonal_affine_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.from_diagonal_affine_matrix-283"><a href="#CoordinateSystem.from_diagonal_affine_matrix-283"><span class="linenos">283</span></a>    <span class="nd">@classmethod</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-284"><a href="#CoordinateSystem.from_diagonal_affine_matrix-284"><span class="linenos">284</span></a>    <span class="k">def</span> <span class="nf">from_diagonal_affine_matrix</span><span class="p">(</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-285"><a href="#CoordinateSystem.from_diagonal_affine_matrix-285"><span class="linenos">285</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-286"><a href="#CoordinateSystem.from_diagonal_affine_matrix-286"><span class="linenos">286</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-287"><a href="#CoordinateSystem.from_diagonal_affine_matrix-287"><span class="linenos">287</span></a>        <span class="n">diagonal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-288"><a href="#CoordinateSystem.from_diagonal_affine_matrix-288"><span class="linenos">288</span></a>        <span class="n">translation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-289"><a href="#CoordinateSystem.from_diagonal_affine_matrix-289"><span class="linenos">289</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-290"><a href="#CoordinateSystem.from_diagonal_affine_matrix-290"><span class="linenos">290</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-291"><a href="#CoordinateSystem.from_diagonal_affine_matrix-291"><span class="linenos">291</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-292"><a href="#CoordinateSystem.from_diagonal_affine_matrix-292"><span class="linenos">292</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create coordinate system from diagonal affine matrix</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-293"><a href="#CoordinateSystem.from_diagonal_affine_matrix-293"><span class="linenos">293</span></a>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-294"><a href="#CoordinateSystem.from_diagonal_affine_matrix-294"><span class="linenos">294</span></a><span class="sd">        The diagonal and the translation should be provided on the host (cpu).</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-295"><a href="#CoordinateSystem.from_diagonal_affine_matrix-295"><span class="linenos">295</span></a><span class="sd">        That is, since the transformation may be used in control flow decisions,</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-296"><a href="#CoordinateSystem.from_diagonal_affine_matrix-296"><span class="linenos">296</span></a><span class="sd">        and we want to avoid synchronizing the target device with the host. The</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-297"><a href="#CoordinateSystem.from_diagonal_affine_matrix-297"><span class="linenos">297</span></a><span class="sd">        matrix is moved to the target device asynchronously, if needed.</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-298"><a href="#CoordinateSystem.from_diagonal_affine_matrix-298"><span class="linenos">298</span></a>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-299"><a href="#CoordinateSystem.from_diagonal_affine_matrix-299"><span class="linenos">299</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-300"><a href="#CoordinateSystem.from_diagonal_affine_matrix-300"><span class="linenos">300</span></a><span class="sd">            spatial_shape: Spatial shape of the created grid</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-301"><a href="#CoordinateSystem.from_diagonal_affine_matrix-301"><span class="linenos">301</span></a><span class="sd">            diagonal: Diagonal of the affine transformation matrix describing</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-302"><a href="#CoordinateSystem.from_diagonal_affine_matrix-302"><span class="linenos">302</span></a><span class="sd">                the transformation from voxel to world coordinates. Tensor</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-303"><a href="#CoordinateSystem.from_diagonal_affine_matrix-303"><span class="linenos">303</span></a><span class="sd">                with shape ([*batch_shape, ]diagonal_length[, *spatial_shape]).</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-304"><a href="#CoordinateSystem.from_diagonal_affine_matrix-304"><span class="linenos">304</span></a><span class="sd">            translation: Translation of the affine transformation describing</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-305"><a href="#CoordinateSystem.from_diagonal_affine_matrix-305"><span class="linenos">305</span></a><span class="sd">                the transformation from voxel to world coordinates. Tensor with</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-306"><a href="#CoordinateSystem.from_diagonal_affine_matrix-306"><span class="linenos">306</span></a><span class="sd">                shape ([*batch_shape, ]n_output_dims[, *spatial_shape]).</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-307"><a href="#CoordinateSystem.from_diagonal_affine_matrix-307"><span class="linenos">307</span></a><span class="sd">            dtype: Data type of the created coordinate system.</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-308"><a href="#CoordinateSystem.from_diagonal_affine_matrix-308"><span class="linenos">308</span></a><span class="sd">            device: Device of the created coordinate system.</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-309"><a href="#CoordinateSystem.from_diagonal_affine_matrix-309"><span class="linenos">309</span></a>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-310"><a href="#CoordinateSystem.from_diagonal_affine_matrix-310"><span class="linenos">310</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-311"><a href="#CoordinateSystem.from_diagonal_affine_matrix-311"><span class="linenos">311</span></a><span class="sd">            Coordinate system with the given diagonal affine matrix.</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-312"><a href="#CoordinateSystem.from_diagonal_affine_matrix-312"><span class="linenos">312</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-313"><a href="#CoordinateSystem.from_diagonal_affine_matrix-313"><span class="linenos">313</span></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">_ensure_tensor_on_host</span><span class="p">(</span><span class="n">diagonal</span><span class="p">)</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-314"><a href="#CoordinateSystem.from_diagonal_affine_matrix-314"><span class="linenos">314</span></a>        <span class="bp">cls</span><span class="o">.</span><span class="n">_ensure_tensor_on_host</span><span class="p">(</span><span class="n">translation</span><span class="p">)</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-315"><a href="#CoordinateSystem.from_diagonal_affine_matrix-315"><span class="linenos">315</span></a>        <span class="n">n_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-316"><a href="#CoordinateSystem.from_diagonal_affine_matrix-316"><span class="linenos">316</span></a>        <span class="k">return</span> <span class="n">CoordinateSystem</span><span class="p">(</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-317"><a href="#CoordinateSystem.from_diagonal_affine_matrix-317"><span class="linenos">317</span></a>            <span class="n">from_voxel_coordinates</span><span class="o">=</span><span class="n">HostDiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-318"><a href="#CoordinateSystem.from_diagonal_affine_matrix-318"><span class="linenos">318</span></a>                <span class="n">diagonal</span><span class="o">=</span><span class="n">diagonal</span><span class="p">,</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-319"><a href="#CoordinateSystem.from_diagonal_affine_matrix-319"><span class="linenos">319</span></a>                <span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">,</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-320"><a href="#CoordinateSystem.from_diagonal_affine_matrix-320"><span class="linenos">320</span></a>                <span class="n">matrix_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-321"><a href="#CoordinateSystem.from_diagonal_affine_matrix-321"><span class="linenos">321</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-322"><a href="#CoordinateSystem.from_diagonal_affine_matrix-322"><span class="linenos">322</span></a>                <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-323"><a href="#CoordinateSystem.from_diagonal_affine_matrix-323"><span class="linenos">323</span></a>            <span class="p">),</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-324"><a href="#CoordinateSystem.from_diagonal_affine_matrix-324"><span class="linenos">324</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem.from_diagonal_affine_matrix-325"><a href="#CoordinateSystem.from_diagonal_affine_matrix-325"><span class="linenos">325</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create coordinate system from diagonal affine matrix</p>

<p>The diagonal and the translation should be provided on the host (cpu).
That is, since the transformation may be used in control flow decisions,
and we want to avoid synchronizing the target device with the host. The
matrix is moved to the target device asynchronously, if needed.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>spatial_shape:</strong>  Spatial shape of the created grid</li>
<li><strong>diagonal:</strong>  Diagonal of the affine transformation matrix describing
the transformation from voxel to world coordinates. Tensor
with shape ([*batch_shape, ]diagonal_length[, *spatial_shape]).</li>
<li><strong>translation:</strong>  Translation of the affine transformation describing
the transformation from voxel to world coordinates. Tensor with
shape ([*batch_shape, ]n_output_dims[, *spatial_shape]).</li>
<li><strong>dtype:</strong>  Data type of the created coordinate system.</li>
<li><strong>device:</strong>  Device of the created coordinate system.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Coordinate system with the given diagonal affine matrix.</p>
</blockquote>
</div>


                            </div>
                            <div id="CoordinateSystem.coordinate_system" class="classattr">
                                        <input id="CoordinateSystem.coordinate_system-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">coordinate_system</span><span class="annotation">: <a href="#CoordinateSystem">CoordinateSystem</a></span>

                <label class="view-source-button" for="CoordinateSystem.coordinate_system-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.coordinate_system"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.coordinate_system-327"><a href="#CoordinateSystem.coordinate_system-327"><span class="linenos">327</span></a>    <span class="nd">@property</span>
</span><span id="CoordinateSystem.coordinate_system-328"><a href="#CoordinateSystem.coordinate_system-328"><span class="linenos">328</span></a>    <span class="k">def</span> <span class="nf">coordinate_system</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.coordinate_system-329"><a href="#CoordinateSystem.coordinate_system-329"><span class="linenos">329</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Coordinate system of the container.</p>
</div>


                            </div>
                            <div id="CoordinateSystem.forward" class="classattr">
                                        <input id="CoordinateSystem.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.forward-331"><a href="#CoordinateSystem.forward-331"><span class="linenos">331</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem.forward-332"><a href="#CoordinateSystem.forward-332"><span class="linenos">332</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Dummy forward pass to make the coordinate system a torch.nn.Module&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Dummy forward pass to make the coordinate system a torch.nn.Module</p>
</div>


                            </div>
                            <div id="CoordinateSystem.dtype" class="classattr">
                                        <input id="CoordinateSystem.dtype-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">dtype</span><span class="annotation">: torch.dtype</span>

                <label class="view-source-button" for="CoordinateSystem.dtype-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.dtype"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.dtype-334"><a href="#CoordinateSystem.dtype-334"><span class="linenos">334</span></a>    <span class="nd">@property</span>
</span><span id="CoordinateSystem.dtype-335"><a href="#CoordinateSystem.dtype-335"><span class="linenos">335</span></a>    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch_dtype</span><span class="p">:</span>
</span><span id="CoordinateSystem.dtype-336"><a href="#CoordinateSystem.dtype-336"><span class="linenos">336</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">(</span><span class="s2">&quot;_indicator&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span>
</span></pre></div>


            <div class="docstring"><p>Return the dtype of the underlying tensor(s)</p>

<p>Does not check that all the wrapped tensors have the same dtype.</p>
</div>


                            </div>
                            <div id="CoordinateSystem.device" class="classattr">
                                        <input id="CoordinateSystem.device-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">device</span><span class="annotation">: torch.device</span>

                <label class="view-source-button" for="CoordinateSystem.device-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.device"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.device-338"><a href="#CoordinateSystem.device-338"><span class="linenos">338</span></a>    <span class="nd">@property</span>
</span><span id="CoordinateSystem.device-339"><a href="#CoordinateSystem.device-339"><span class="linenos">339</span></a>    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch_device</span><span class="p">:</span>
</span><span id="CoordinateSystem.device-340"><a href="#CoordinateSystem.device-340"><span class="linenos">340</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_buffer</span><span class="p">(</span><span class="s2">&quot;_indicator&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">device</span>
</span></pre></div>


            <div class="docstring"><p>Return the device of the underlying tensor(s)</p>

<p>Does not check that all the wrapped tensors are on the same device.</p>
</div>


                            </div>
                            <div id="CoordinateSystem.from_voxel_coordinates" class="classattr">
                                        <input id="CoordinateSystem.from_voxel_coordinates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">from_voxel_coordinates</span><span class="annotation">: <a href="#Affine">Affine</a></span>

                <label class="view-source-button" for="CoordinateSystem.from_voxel_coordinates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.from_voxel_coordinates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.from_voxel_coordinates-342"><a href="#CoordinateSystem.from_voxel_coordinates-342"><span class="linenos">342</span></a>    <span class="nd">@property</span>
</span><span id="CoordinateSystem.from_voxel_coordinates-343"><a href="#CoordinateSystem.from_voxel_coordinates-343"><span class="linenos">343</span></a>    <span class="k">def</span> <span class="nf">from_voxel_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Affine</span><span class="p">:</span>
</span><span id="CoordinateSystem.from_voxel_coordinates-344"><a href="#CoordinateSystem.from_voxel_coordinates-344"><span class="linenos">344</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Affine mapping from voxel to world coordinates&quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.from_voxel_coordinates-345"><a href="#CoordinateSystem.from_voxel_coordinates-345"><span class="linenos">345</span></a>        <span class="k">return</span> <span class="n">Affine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Affine mapping from voxel to world coordinates</p>
</div>


                            </div>
                            <div id="CoordinateSystem.to_voxel_coordinates" class="classattr">
                                        <input id="CoordinateSystem.to_voxel_coordinates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">to_voxel_coordinates</span><span class="annotation">: <a href="#Affine">Affine</a></span>

                <label class="view-source-button" for="CoordinateSystem.to_voxel_coordinates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.to_voxel_coordinates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.to_voxel_coordinates-347"><a href="#CoordinateSystem.to_voxel_coordinates-347"><span class="linenos">347</span></a>    <span class="nd">@property</span>
</span><span id="CoordinateSystem.to_voxel_coordinates-348"><a href="#CoordinateSystem.to_voxel_coordinates-348"><span class="linenos">348</span></a>    <span class="k">def</span> <span class="nf">to_voxel_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Affine</span><span class="p">:</span>
</span><span id="CoordinateSystem.to_voxel_coordinates-349"><a href="#CoordinateSystem.to_voxel_coordinates-349"><span class="linenos">349</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Affine mapping from world to voxel coordinates&quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.to_voxel_coordinates-350"><a href="#CoordinateSystem.to_voxel_coordinates-350"><span class="linenos">350</span></a>        <span class="k">return</span> <span class="n">Affine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_voxel_coordinates</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Affine mapping from world to voxel coordinates</p>
</div>


                            </div>
                            <div id="CoordinateSystem.spatial_shape" class="classattr">
                                        <input id="CoordinateSystem.spatial_shape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">spatial_shape</span><span class="annotation">: Tuple[int, ...]</span>

                <label class="view-source-button" for="CoordinateSystem.spatial_shape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.spatial_shape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.spatial_shape-352"><a href="#CoordinateSystem.spatial_shape-352"><span class="linenos">352</span></a>    <span class="nd">@property</span>
</span><span id="CoordinateSystem.spatial_shape-353"><a href="#CoordinateSystem.spatial_shape-353"><span class="linenos">353</span></a>    <span class="k">def</span> <span class="nf">spatial_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="CoordinateSystem.spatial_shape-354"><a href="#CoordinateSystem.spatial_shape-354"><span class="linenos">354</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Spatial shape of the coordinate system grid&quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.spatial_shape-355"><a href="#CoordinateSystem.spatial_shape-355"><span class="linenos">355</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span>
</span></pre></div>


            <div class="docstring"><p>Spatial shape of the coordinate system grid</p>
</div>


                            </div>
                            <div id="CoordinateSystem.grid" class="classattr">
                                        <input id="CoordinateSystem.grid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">grid</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.grid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.grid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.grid-357"><a href="#CoordinateSystem.grid-357"><span class="linenos">357</span></a>    <span class="k">def</span> <span class="nf">grid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="CoordinateSystem.grid-358"><a href="#CoordinateSystem.grid-358"><span class="linenos">358</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Grid in the world coordinates&quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.grid-359"><a href="#CoordinateSystem.grid-359"><span class="linenos">359</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_voxel_coordinates</span><span class="p">(</span>
</span><span id="CoordinateSystem.grid-360"><a href="#CoordinateSystem.grid-360"><span class="linenos">360</span></a>            <span class="n">voxel_grid</span><span class="p">(</span>
</span><span id="CoordinateSystem.grid-361"><a href="#CoordinateSystem.grid-361"><span class="linenos">361</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem.grid-362"><a href="#CoordinateSystem.grid-362"><span class="linenos">362</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="CoordinateSystem.grid-363"><a href="#CoordinateSystem.grid-363"><span class="linenos">363</span></a>                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="CoordinateSystem.grid-364"><a href="#CoordinateSystem.grid-364"><span class="linenos">364</span></a>            <span class="p">)</span>
</span><span id="CoordinateSystem.grid-365"><a href="#CoordinateSystem.grid-365"><span class="linenos">365</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Grid in the world coordinates</p>
</div>


                            </div>
                            <div id="CoordinateSystem.voxel_grid" class="classattr">
                                        <input id="CoordinateSystem.voxel_grid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">voxel_grid</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.voxel_grid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.voxel_grid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.voxel_grid-367"><a href="#CoordinateSystem.voxel_grid-367"><span class="linenos">367</span></a>    <span class="k">def</span> <span class="nf">voxel_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="CoordinateSystem.voxel_grid-368"><a href="#CoordinateSystem.voxel_grid-368"><span class="linenos">368</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Grid in the voxel coordinates&quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.voxel_grid-369"><a href="#CoordinateSystem.voxel_grid-369"><span class="linenos">369</span></a>        <span class="k">return</span> <span class="n">voxel_grid</span><span class="p">(</span><span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Grid in the voxel coordinates</p>
</div>


                            </div>
                            <div id="CoordinateSystem.grid_spacing_cpu" class="classattr">
                                        <input id="CoordinateSystem.grid_spacing_cpu-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">grid_spacing_cpu</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.grid_spacing_cpu-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.grid_spacing_cpu"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.grid_spacing_cpu-380"><a href="#CoordinateSystem.grid_spacing_cpu-380"><span class="linenos">380</span></a>    <span class="k">def</span> <span class="nf">grid_spacing_cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="CoordinateSystem.grid_spacing_cpu-381"><a href="#CoordinateSystem.grid_spacing_cpu-381"><span class="linenos">381</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain grid spacing as a CPU tensor&quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.grid_spacing_cpu-382"><a href="#CoordinateSystem.grid_spacing_cpu-382"><span class="linenos">382</span></a>        <span class="n">diagonal_on_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="o">.</span><span class="n">as_host_diagonal</span><span class="p">()</span>
</span><span id="CoordinateSystem.grid_spacing_cpu-383"><a href="#CoordinateSystem.grid_spacing_cpu-383"><span class="linenos">383</span></a>        <span class="k">if</span> <span class="n">diagonal_on_host</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem.grid_spacing_cpu-384"><a href="#CoordinateSystem.grid_spacing_cpu-384"><span class="linenos">384</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_voxel_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="o">.</span><span class="n">as_host_matrix</span><span class="p">())</span>
</span><span id="CoordinateSystem.grid_spacing_cpu-385"><a href="#CoordinateSystem.grid_spacing_cpu-385"><span class="linenos">385</span></a>        <span class="k">return</span> <span class="n">diagonal_on_host</span><span class="o">.</span><span class="n">generate_diagonal</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Obtain grid spacing as a CPU tensor</p>
</div>


                            </div>
                            <div id="CoordinateSystem.grid_spacing" class="classattr">
                                        <input id="CoordinateSystem.grid_spacing-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">grid_spacing</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.grid_spacing-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.grid_spacing"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.grid_spacing-387"><a href="#CoordinateSystem.grid_spacing-387"><span class="linenos">387</span></a>    <span class="k">def</span> <span class="nf">grid_spacing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="CoordinateSystem.grid_spacing-388"><a href="#CoordinateSystem.grid_spacing-388"><span class="linenos">388</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain grid spacing on the target device&quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.grid_spacing-389"><a href="#CoordinateSystem.grid_spacing-389"><span class="linenos">389</span></a>        <span class="n">diagonal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="o">.</span><span class="n">as_diagonal</span><span class="p">()</span>
</span><span id="CoordinateSystem.grid_spacing-390"><a href="#CoordinateSystem.grid_spacing-390"><span class="linenos">390</span></a>        <span class="k">if</span> <span class="n">diagonal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem.grid_spacing-391"><a href="#CoordinateSystem.grid_spacing-391"><span class="linenos">391</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_voxel_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">())</span>
</span><span id="CoordinateSystem.grid_spacing-392"><a href="#CoordinateSystem.grid_spacing-392"><span class="linenos">392</span></a>        <span class="k">return</span> <span class="n">diagonal</span><span class="o">.</span><span class="n">generate_diagonal</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Obtain grid spacing on the target device</p>
</div>


                            </div>
                            <div id="CoordinateSystem.transform_voxel" class="classattr">
                                        <input id="CoordinateSystem.transform_voxel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">transform_voxel</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">affine_matrix</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.transform_voxel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.transform_voxel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.transform_voxel-402"><a href="#CoordinateSystem.transform_voxel-402"><span class="linenos">402</span></a>    <span class="k">def</span> <span class="nf">transform_voxel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">affine_matrix</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.transform_voxel-403"><a href="#CoordinateSystem.transform_voxel-403"><span class="linenos">403</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform the coordinates with an affine matrix in the</span>
</span><span id="CoordinateSystem.transform_voxel-404"><a href="#CoordinateSystem.transform_voxel-404"><span class="linenos">404</span></a><span class="sd">        voxel coordinates before applying the current affine transformation</span>
</span><span id="CoordinateSystem.transform_voxel-405"><a href="#CoordinateSystem.transform_voxel-405"><span class="linenos">405</span></a>
</span><span id="CoordinateSystem.transform_voxel-406"><a href="#CoordinateSystem.transform_voxel-406"><span class="linenos">406</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem.transform_voxel-407"><a href="#CoordinateSystem.transform_voxel-407"><span class="linenos">407</span></a><span class="sd">            affine_matrix: Affine matrix describing the transformation</span>
</span><span id="CoordinateSystem.transform_voxel-408"><a href="#CoordinateSystem.transform_voxel-408"><span class="linenos">408</span></a><span class="sd">                in the voxel coordinates. Tensor with shape</span>
</span><span id="CoordinateSystem.transform_voxel-409"><a href="#CoordinateSystem.transform_voxel-409"><span class="linenos">409</span></a><span class="sd">                ([*batch_shape, ]n_output_dims + 1, n_spatial_dims + 1).</span>
</span><span id="CoordinateSystem.transform_voxel-410"><a href="#CoordinateSystem.transform_voxel-410"><span class="linenos">410</span></a><span class="sd">                The affine matrix tensor should be provided on the host (cpu).</span>
</span><span id="CoordinateSystem.transform_voxel-411"><a href="#CoordinateSystem.transform_voxel-411"><span class="linenos">411</span></a><span class="sd">                That is, since the transformation may be used in control flow</span>
</span><span id="CoordinateSystem.transform_voxel-412"><a href="#CoordinateSystem.transform_voxel-412"><span class="linenos">412</span></a><span class="sd">                decisions, and we want to avoid synchronizing the target device</span>
</span><span id="CoordinateSystem.transform_voxel-413"><a href="#CoordinateSystem.transform_voxel-413"><span class="linenos">413</span></a><span class="sd">                with the host. The matrix is moved to the target device</span>
</span><span id="CoordinateSystem.transform_voxel-414"><a href="#CoordinateSystem.transform_voxel-414"><span class="linenos">414</span></a><span class="sd">                asynchronously, if needed.</span>
</span><span id="CoordinateSystem.transform_voxel-415"><a href="#CoordinateSystem.transform_voxel-415"><span class="linenos">415</span></a>
</span><span id="CoordinateSystem.transform_voxel-416"><a href="#CoordinateSystem.transform_voxel-416"><span class="linenos">416</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem.transform_voxel-417"><a href="#CoordinateSystem.transform_voxel-417"><span class="linenos">417</span></a><span class="sd">            Coordinate system with a modified affine transformation from voxel</span>
</span><span id="CoordinateSystem.transform_voxel-418"><a href="#CoordinateSystem.transform_voxel-418"><span class="linenos">418</span></a><span class="sd">            to world coordinates.</span>
</span><span id="CoordinateSystem.transform_voxel-419"><a href="#CoordinateSystem.transform_voxel-419"><span class="linenos">419</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.transform_voxel-420"><a href="#CoordinateSystem.transform_voxel-420"><span class="linenos">420</span></a>        <span class="k">return</span> <span class="n">CoordinateSystem</span><span class="p">(</span>
</span><span id="CoordinateSystem.transform_voxel-421"><a href="#CoordinateSystem.transform_voxel-421"><span class="linenos">421</span></a>            <span class="n">from_voxel_coordinates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span>
</span><span id="CoordinateSystem.transform_voxel-422"><a href="#CoordinateSystem.transform_voxel-422"><span class="linenos">422</span></a>            <span class="o">@</span> <span class="n">HostAffineTransformation</span><span class="p">(</span><span class="n">affine_matrix</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span>
</span><span id="CoordinateSystem.transform_voxel-423"><a href="#CoordinateSystem.transform_voxel-423"><span class="linenos">423</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_voxel-424"><a href="#CoordinateSystem.transform_voxel-424"><span class="linenos">424</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Transform the coordinates with an affine matrix in the
voxel coordinates before applying the current affine transformation</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>affine_matrix:</strong>  Affine matrix describing the transformation
in the voxel coordinates. Tensor with shape
([*batch_shape, ]n_output_dims + 1, n_spatial_dims + 1).
The affine matrix tensor should be provided on the host (cpu).
That is, since the transformation may be used in control flow
decisions, and we want to avoid synchronizing the target device
with the host. The matrix is moved to the target device
asynchronously, if needed.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Coordinate system with a modified affine transformation from voxel
  to world coordinates.</p>
</blockquote>
</div>


                            </div>
                            <div id="CoordinateSystem.transform_voxel_with_diagonal_matrix" class="classattr">
                                        <input id="CoordinateSystem.transform_voxel_with_diagonal_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">transform_voxel_with_diagonal_matrix</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">diagonal</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">translation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.transform_voxel_with_diagonal_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.transform_voxel_with_diagonal_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-426"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-426"><span class="linenos">426</span></a>    <span class="k">def</span> <span class="nf">transform_voxel_with_diagonal_matrix</span><span class="p">(</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-427"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-427"><span class="linenos">427</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-428"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-428"><span class="linenos">428</span></a>        <span class="n">diagonal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-429"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-429"><span class="linenos">429</span></a>        <span class="n">translation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-430"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-430"><span class="linenos">430</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-431"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-431"><span class="linenos">431</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform the coordinates with a diagonal affine matrix in the</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-432"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-432"><span class="linenos">432</span></a><span class="sd">        voxel coordinates before applying the current affine transformation.</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-433"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-433"><span class="linenos">433</span></a>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-434"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-434"><span class="linenos">434</span></a><span class="sd">        The diagonal and the translation should be provided on the host (cpu).</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-435"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-435"><span class="linenos">435</span></a><span class="sd">        That is, since the transformation may be used in control flow decisions,</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-436"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-436"><span class="linenos">436</span></a><span class="sd">        and we want to avoid synchronizing the target device with the host. The</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-437"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-437"><span class="linenos">437</span></a><span class="sd">        matrix is moved to the target device asynchronously, if needed.</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-438"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-438"><span class="linenos">438</span></a>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-439"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-439"><span class="linenos">439</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-440"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-440"><span class="linenos">440</span></a><span class="sd">            diagonal: Diagonal of the affine transformation matrix with shape</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-441"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-441"><span class="linenos">441</span></a><span class="sd">                ([*batch_shape, ]n_spatial_dims). Can be also</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-442"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-442"><span class="linenos">442</span></a><span class="sd">                given as a number or sequence of numbers. If None, corresponds</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-443"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-443"><span class="linenos">443</span></a><span class="sd">                to the diagonal of ones.</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-444"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-444"><span class="linenos">444</span></a><span class="sd">            translation: Translation of the affine transformation matrix</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-445"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-445"><span class="linenos">445</span></a><span class="sd">                with shape ([*batch_shape, ]n_spatial_dims).</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-446"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-446"><span class="linenos">446</span></a><span class="sd">                Can be also given as a number or sequence of numbers. If None,</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-447"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-447"><span class="linenos">447</span></a><span class="sd">                corresponds to the zero translation.</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-448"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-448"><span class="linenos">448</span></a>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-449"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-449"><span class="linenos">449</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-450"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-450"><span class="linenos">450</span></a><span class="sd">            Coordinate system with a modified affine transformation from voxel</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-451"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-451"><span class="linenos">451</span></a><span class="sd">            to world coordinates.</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-452"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-452"><span class="linenos">452</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-453"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-453"><span class="linenos">453</span></a>        <span class="n">n_spatial_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-454"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-454"><span class="linenos">454</span></a>        <span class="k">return</span> <span class="n">CoordinateSystem</span><span class="p">(</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-455"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-455"><span class="linenos">455</span></a>            <span class="n">from_voxel_coordinates</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-456"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-456"><span class="linenos">456</span></a>            <span class="o">@</span> <span class="n">HostDiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-457"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-457"><span class="linenos">457</span></a>                <span class="n">diagonal</span><span class="o">=</span><span class="n">diagonal</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-458"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-458"><span class="linenos">458</span></a>                <span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-459"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-459"><span class="linenos">459</span></a>                <span class="n">matrix_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_spatial_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_spatial_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-460"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-460"><span class="linenos">460</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-461"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-461"><span class="linenos">461</span></a>                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-462"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-462"><span class="linenos">462</span></a>            <span class="p">),</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-463"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-463"><span class="linenos">463</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_voxel_with_diagonal_matrix-464"><a href="#CoordinateSystem.transform_voxel_with_diagonal_matrix-464"><span class="linenos">464</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Transform the coordinates with a diagonal affine matrix in the
voxel coordinates before applying the current affine transformation.</p>

<p>The diagonal and the translation should be provided on the host (cpu).
That is, since the transformation may be used in control flow decisions,
and we want to avoid synchronizing the target device with the host. The
matrix is moved to the target device asynchronously, if needed.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>diagonal:</strong>  Diagonal of the affine transformation matrix with shape
([*batch_shape, ]n_spatial_dims). Can be also
given as a number or sequence of numbers. If None, corresponds
to the diagonal of ones.</li>
<li><strong>translation:</strong>  Translation of the affine transformation matrix
with shape ([*batch_shape, ]n_spatial_dims).
Can be also given as a number or sequence of numbers. If None,
corresponds to the zero translation.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Coordinate system with a modified affine transformation from voxel
  to world coordinates.</p>
</blockquote>
</div>


                            </div>
                            <div id="CoordinateSystem.transform_world" class="classattr">
                                        <input id="CoordinateSystem.transform_world-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">transform_world</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">affine_matrix</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.transform_world-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.transform_world"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.transform_world-466"><a href="#CoordinateSystem.transform_world-466"><span class="linenos">466</span></a>    <span class="k">def</span> <span class="nf">transform_world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">affine_matrix</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.transform_world-467"><a href="#CoordinateSystem.transform_world-467"><span class="linenos">467</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform the coordinates with an affine matrix in the</span>
</span><span id="CoordinateSystem.transform_world-468"><a href="#CoordinateSystem.transform_world-468"><span class="linenos">468</span></a><span class="sd">        world coordinates after applying the current affine transformation</span>
</span><span id="CoordinateSystem.transform_world-469"><a href="#CoordinateSystem.transform_world-469"><span class="linenos">469</span></a>
</span><span id="CoordinateSystem.transform_world-470"><a href="#CoordinateSystem.transform_world-470"><span class="linenos">470</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem.transform_world-471"><a href="#CoordinateSystem.transform_world-471"><span class="linenos">471</span></a><span class="sd">            affine_matrix: Affine matrix describing the transformation</span>
</span><span id="CoordinateSystem.transform_world-472"><a href="#CoordinateSystem.transform_world-472"><span class="linenos">472</span></a><span class="sd">                in the world coordinates. Tensor with shape</span>
</span><span id="CoordinateSystem.transform_world-473"><a href="#CoordinateSystem.transform_world-473"><span class="linenos">473</span></a><span class="sd">                ([*batch_shape, ]n_output_dims + 1, n_input_dims + 1).</span>
</span><span id="CoordinateSystem.transform_world-474"><a href="#CoordinateSystem.transform_world-474"><span class="linenos">474</span></a><span class="sd">                The affine matrix tensor should be provided on the host (cpu).</span>
</span><span id="CoordinateSystem.transform_world-475"><a href="#CoordinateSystem.transform_world-475"><span class="linenos">475</span></a><span class="sd">                That is, since the transformation may be used in control flow</span>
</span><span id="CoordinateSystem.transform_world-476"><a href="#CoordinateSystem.transform_world-476"><span class="linenos">476</span></a><span class="sd">                decisions, and we want to avoid synchronizing the target device</span>
</span><span id="CoordinateSystem.transform_world-477"><a href="#CoordinateSystem.transform_world-477"><span class="linenos">477</span></a><span class="sd">                with the host. The matrix is moved to the target device</span>
</span><span id="CoordinateSystem.transform_world-478"><a href="#CoordinateSystem.transform_world-478"><span class="linenos">478</span></a><span class="sd">                asynchronously, if needed.</span>
</span><span id="CoordinateSystem.transform_world-479"><a href="#CoordinateSystem.transform_world-479"><span class="linenos">479</span></a>
</span><span id="CoordinateSystem.transform_world-480"><a href="#CoordinateSystem.transform_world-480"><span class="linenos">480</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem.transform_world-481"><a href="#CoordinateSystem.transform_world-481"><span class="linenos">481</span></a><span class="sd">            Coordinate system with a modified affine transformation from voxel</span>
</span><span id="CoordinateSystem.transform_world-482"><a href="#CoordinateSystem.transform_world-482"><span class="linenos">482</span></a><span class="sd">            to world coordinates.</span>
</span><span id="CoordinateSystem.transform_world-483"><a href="#CoordinateSystem.transform_world-483"><span class="linenos">483</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.transform_world-484"><a href="#CoordinateSystem.transform_world-484"><span class="linenos">484</span></a>        <span class="k">return</span> <span class="n">CoordinateSystem</span><span class="p">(</span>
</span><span id="CoordinateSystem.transform_world-485"><a href="#CoordinateSystem.transform_world-485"><span class="linenos">485</span></a>            <span class="n">from_voxel_coordinates</span><span class="o">=</span><span class="n">HostAffineTransformation</span><span class="p">(</span><span class="n">affine_matrix</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
</span><span id="CoordinateSystem.transform_world-486"><a href="#CoordinateSystem.transform_world-486"><span class="linenos">486</span></a>            <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_world-487"><a href="#CoordinateSystem.transform_world-487"><span class="linenos">487</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_world-488"><a href="#CoordinateSystem.transform_world-488"><span class="linenos">488</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Transform the coordinates with an affine matrix in the
world coordinates after applying the current affine transformation</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>affine_matrix:</strong>  Affine matrix describing the transformation
in the world coordinates. Tensor with shape
([*batch_shape, ]n_output_dims + 1, n_input_dims + 1).
The affine matrix tensor should be provided on the host (cpu).
That is, since the transformation may be used in control flow
decisions, and we want to avoid synchronizing the target device
with the host. The matrix is moved to the target device
asynchronously, if needed.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Coordinate system with a modified affine transformation from voxel
  to world coordinates.</p>
</blockquote>
</div>


                            </div>
                            <div id="CoordinateSystem.transform_world_with_diagonal_matrix" class="classattr">
                                        <input id="CoordinateSystem.transform_world_with_diagonal_matrix-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">transform_world_with_diagonal_matrix</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">diagonal</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">translation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">n_output_dims</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.transform_world_with_diagonal_matrix-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.transform_world_with_diagonal_matrix"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-493"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-493"><span class="linenos">493</span></a>    <span class="k">def</span> <span class="nf">transform_world_with_diagonal_matrix</span><span class="p">(</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-494"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-494"><span class="linenos">494</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-495"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-495"><span class="linenos">495</span></a>        <span class="n">diagonal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-496"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-496"><span class="linenos">496</span></a>        <span class="n">translation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-497"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-497"><span class="linenos">497</span></a>        <span class="n">n_output_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-498"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-498"><span class="linenos">498</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-499"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-499"><span class="linenos">499</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform the coordinates with a diagonal affine matrix in the</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-500"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-500"><span class="linenos">500</span></a><span class="sd">        world coordinates after applying the current affine transformation</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-501"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-501"><span class="linenos">501</span></a>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-502"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-502"><span class="linenos">502</span></a><span class="sd">        The diagonal and the translation should be provided on the host (cpu).</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-503"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-503"><span class="linenos">503</span></a><span class="sd">        That is, since the transformation may be used in control flow decisions,</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-504"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-504"><span class="linenos">504</span></a><span class="sd">        and we want to avoid synchronizing the target device with the host. The</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-505"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-505"><span class="linenos">505</span></a><span class="sd">        matrix is moved to the target device asynchronously, if needed.</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-506"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-506"><span class="linenos">506</span></a>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-507"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-507"><span class="linenos">507</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-508"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-508"><span class="linenos">508</span></a><span class="sd">            diagonal: Diagonal of the affine transformation matrix with shape</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-509"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-509"><span class="linenos">509</span></a><span class="sd">                ([*batch_shape, ]diagonal_length). Can be also</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-510"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-510"><span class="linenos">510</span></a><span class="sd">                given as a number or sequence of numbers. If None, corresponds</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-511"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-511"><span class="linenos">511</span></a><span class="sd">                to the diagonal of ones.</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-512"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-512"><span class="linenos">512</span></a><span class="sd">            translation: Translation of the affine transformation matrix</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-513"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-513"><span class="linenos">513</span></a><span class="sd">                with shape ([*batch_shape, ]n_output_dims).</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-514"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-514"><span class="linenos">514</span></a><span class="sd">                Can be also given as a number or sequence of numbers. If None,</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-515"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-515"><span class="linenos">515</span></a><span class="sd">                corresponds to the zero translation.</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-516"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-516"><span class="linenos">516</span></a><span class="sd">            n_output_dims: Number of output dimensions of the transformation.</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-517"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-517"><span class="linenos">517</span></a>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-518"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-518"><span class="linenos">518</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-519"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-519"><span class="linenos">519</span></a><span class="sd">            Coordinate system with a modified affine transformation from voxel</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-520"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-520"><span class="linenos">520</span></a><span class="sd">            to world coordinates.</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-521"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-521"><span class="linenos">521</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-522"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-522"><span class="linenos">522</span></a>        <span class="n">n_input_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-523"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-523"><span class="linenos">523</span></a>        <span class="k">if</span> <span class="n">n_output_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-524"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-524"><span class="linenos">524</span></a>            <span class="n">n_output_dims</span> <span class="o">=</span> <span class="n">n_input_dims</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-525"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-525"><span class="linenos">525</span></a>        <span class="k">return</span> <span class="n">CoordinateSystem</span><span class="p">(</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-526"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-526"><span class="linenos">526</span></a>            <span class="n">from_voxel_coordinates</span><span class="o">=</span><span class="n">HostDiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-527"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-527"><span class="linenos">527</span></a>                <span class="n">diagonal</span><span class="o">=</span><span class="n">diagonal</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-528"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-528"><span class="linenos">528</span></a>                <span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-529"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-529"><span class="linenos">529</span></a>                <span class="n">matrix_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_output_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_input_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-530"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-530"><span class="linenos">530</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-531"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-531"><span class="linenos">531</span></a>                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-532"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-532"><span class="linenos">532</span></a>            <span class="p">)</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-533"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-533"><span class="linenos">533</span></a>            <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-534"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-534"><span class="linenos">534</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem.transform_world_with_diagonal_matrix-535"><a href="#CoordinateSystem.transform_world_with_diagonal_matrix-535"><span class="linenos">535</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Transform the coordinates with a diagonal affine matrix in the
world coordinates after applying the current affine transformation</p>

<p>The diagonal and the translation should be provided on the host (cpu).
That is, since the transformation may be used in control flow decisions,
and we want to avoid synchronizing the target device with the host. The
matrix is moved to the target device asynchronously, if needed.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>diagonal:</strong>  Diagonal of the affine transformation matrix with shape
([*batch_shape, ]diagonal_length). Can be also
given as a number or sequence of numbers. If None, corresponds
to the diagonal of ones.</li>
<li><strong>translation:</strong>  Translation of the affine transformation matrix
with shape ([*batch_shape, ]n_output_dims).
Can be also given as a number or sequence of numbers. If None,
corresponds to the zero translation.</li>
<li><strong>n_output_dims:</strong>  Number of output dimensions of the transformation.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Coordinate system with a modified affine transformation from voxel
  to world coordinates.</p>
</blockquote>
</div>


                            </div>
                            <div id="CoordinateSystem.translate_voxel" class="classattr">
                                        <input id="CoordinateSystem.translate_voxel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">translate_voxel</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">translation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.translate_voxel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.translate_voxel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.translate_voxel-537"><a href="#CoordinateSystem.translate_voxel-537"><span class="linenos">537</span></a>    <span class="k">def</span> <span class="nf">translate_voxel</span><span class="p">(</span>
</span><span id="CoordinateSystem.translate_voxel-538"><a href="#CoordinateSystem.translate_voxel-538"><span class="linenos">538</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">translation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span>
</span><span id="CoordinateSystem.translate_voxel-539"><a href="#CoordinateSystem.translate_voxel-539"><span class="linenos">539</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.translate_voxel-540"><a href="#CoordinateSystem.translate_voxel-540"><span class="linenos">540</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Translate the coordinates in the voxel coordinates before applying</span>
</span><span id="CoordinateSystem.translate_voxel-541"><a href="#CoordinateSystem.translate_voxel-541"><span class="linenos">541</span></a><span class="sd">        the current affine transformation</span>
</span><span id="CoordinateSystem.translate_voxel-542"><a href="#CoordinateSystem.translate_voxel-542"><span class="linenos">542</span></a>
</span><span id="CoordinateSystem.translate_voxel-543"><a href="#CoordinateSystem.translate_voxel-543"><span class="linenos">543</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem.translate_voxel-544"><a href="#CoordinateSystem.translate_voxel-544"><span class="linenos">544</span></a><span class="sd">            translation: Translation with shape ([*batch_shape, ]n_spatial_dims).</span>
</span><span id="CoordinateSystem.translate_voxel-545"><a href="#CoordinateSystem.translate_voxel-545"><span class="linenos">545</span></a><span class="sd">                Can be also given as a number or sequence of numbers.</span>
</span><span id="CoordinateSystem.translate_voxel-546"><a href="#CoordinateSystem.translate_voxel-546"><span class="linenos">546</span></a>
</span><span id="CoordinateSystem.translate_voxel-547"><a href="#CoordinateSystem.translate_voxel-547"><span class="linenos">547</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem.translate_voxel-548"><a href="#CoordinateSystem.translate_voxel-548"><span class="linenos">548</span></a><span class="sd">            Coordinate system with translated coordinates.</span>
</span><span id="CoordinateSystem.translate_voxel-549"><a href="#CoordinateSystem.translate_voxel-549"><span class="linenos">549</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.translate_voxel-550"><a href="#CoordinateSystem.translate_voxel-550"><span class="linenos">550</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_voxel_with_diagonal_matrix</span><span class="p">(</span><span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Translate the coordinates in the voxel coordinates before applying
the current affine transformation</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>translation:</strong>  Translation with shape ([*batch_shape, ]n_spatial_dims).
Can be also given as a number or sequence of numbers.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Coordinate system with translated coordinates.</p>
</blockquote>
</div>


                            </div>
                            <div id="CoordinateSystem.translate_world" class="classattr">
                                        <input id="CoordinateSystem.translate_world-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">translate_world</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">translation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.translate_world-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.translate_world"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.translate_world-552"><a href="#CoordinateSystem.translate_world-552"><span class="linenos">552</span></a>    <span class="k">def</span> <span class="nf">translate_world</span><span class="p">(</span>
</span><span id="CoordinateSystem.translate_world-553"><a href="#CoordinateSystem.translate_world-553"><span class="linenos">553</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">translation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span>
</span><span id="CoordinateSystem.translate_world-554"><a href="#CoordinateSystem.translate_world-554"><span class="linenos">554</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.translate_world-555"><a href="#CoordinateSystem.translate_world-555"><span class="linenos">555</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Translate the coordinates in the world coordinates after applying</span>
</span><span id="CoordinateSystem.translate_world-556"><a href="#CoordinateSystem.translate_world-556"><span class="linenos">556</span></a><span class="sd">        the current affine transformation</span>
</span><span id="CoordinateSystem.translate_world-557"><a href="#CoordinateSystem.translate_world-557"><span class="linenos">557</span></a>
</span><span id="CoordinateSystem.translate_world-558"><a href="#CoordinateSystem.translate_world-558"><span class="linenos">558</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem.translate_world-559"><a href="#CoordinateSystem.translate_world-559"><span class="linenos">559</span></a><span class="sd">            translation: Translation with shape ([*batch_shape, ]n_output_dims).</span>
</span><span id="CoordinateSystem.translate_world-560"><a href="#CoordinateSystem.translate_world-560"><span class="linenos">560</span></a><span class="sd">                Can be also given as a number or sequence of numbers.</span>
</span><span id="CoordinateSystem.translate_world-561"><a href="#CoordinateSystem.translate_world-561"><span class="linenos">561</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.translate_world-562"><a href="#CoordinateSystem.translate_world-562"><span class="linenos">562</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_world_with_diagonal_matrix</span><span class="p">(</span><span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Translate the coordinates in the world coordinates after applying
the current affine transformation</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>translation:</strong>  Translation with shape ([*batch_shape, ]n_output_dims).
Can be also given as a number or sequence of numbers.</li>
</ul>
</div>


                            </div>
                            <div id="CoordinateSystem.multiply_voxel" class="classattr">
                                        <input id="CoordinateSystem.multiply_voxel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">multiply_voxel</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">factor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.multiply_voxel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.multiply_voxel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.multiply_voxel-567"><a href="#CoordinateSystem.multiply_voxel-567"><span class="linenos">567</span></a>    <span class="k">def</span> <span class="nf">multiply_voxel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.multiply_voxel-568"><a href="#CoordinateSystem.multiply_voxel-568"><span class="linenos">568</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Multiply the coordinates in the voxel coordinates (before applying</span>
</span><span id="CoordinateSystem.multiply_voxel-569"><a href="#CoordinateSystem.multiply_voxel-569"><span class="linenos">569</span></a><span class="sd">        the current affine transformation)</span>
</span><span id="CoordinateSystem.multiply_voxel-570"><a href="#CoordinateSystem.multiply_voxel-570"><span class="linenos">570</span></a>
</span><span id="CoordinateSystem.multiply_voxel-571"><a href="#CoordinateSystem.multiply_voxel-571"><span class="linenos">571</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem.multiply_voxel-572"><a href="#CoordinateSystem.multiply_voxel-572"><span class="linenos">572</span></a><span class="sd">            factor: Factor to multiply the grid spacing. A tensor with shape</span>
</span><span id="CoordinateSystem.multiply_voxel-573"><a href="#CoordinateSystem.multiply_voxel-573"><span class="linenos">573</span></a><span class="sd">                ([*batch_shape, ]n_spatial_dims). Can be also given as a number</span>
</span><span id="CoordinateSystem.multiply_voxel-574"><a href="#CoordinateSystem.multiply_voxel-574"><span class="linenos">574</span></a><span class="sd">                or sequence of numbers.</span>
</span><span id="CoordinateSystem.multiply_voxel-575"><a href="#CoordinateSystem.multiply_voxel-575"><span class="linenos">575</span></a>
</span><span id="CoordinateSystem.multiply_voxel-576"><a href="#CoordinateSystem.multiply_voxel-576"><span class="linenos">576</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem.multiply_voxel-577"><a href="#CoordinateSystem.multiply_voxel-577"><span class="linenos">577</span></a><span class="sd">            Coordinate system with a modified affine transformation from voxel</span>
</span><span id="CoordinateSystem.multiply_voxel-578"><a href="#CoordinateSystem.multiply_voxel-578"><span class="linenos">578</span></a><span class="sd">            to world coordinates.</span>
</span><span id="CoordinateSystem.multiply_voxel-579"><a href="#CoordinateSystem.multiply_voxel-579"><span class="linenos">579</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.multiply_voxel-580"><a href="#CoordinateSystem.multiply_voxel-580"><span class="linenos">580</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_voxel_with_diagonal_matrix</span><span class="p">(</span><span class="n">diagonal</span><span class="o">=</span><span class="n">factor</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Multiply the coordinates in the voxel coordinates (before applying
the current affine transformation)</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>factor:</strong>  Factor to multiply the grid spacing. A tensor with shape
([*batch_shape, ]n_spatial_dims). Can be also given as a number
or sequence of numbers.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Coordinate system with a modified affine transformation from voxel
  to world coordinates.</p>
</blockquote>
</div>


                            </div>
                            <div id="CoordinateSystem.multiply_world" class="classattr">
                                        <input id="CoordinateSystem.multiply_world-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">multiply_world</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">factor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.multiply_world-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.multiply_world"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.multiply_world-582"><a href="#CoordinateSystem.multiply_world-582"><span class="linenos">582</span></a>    <span class="k">def</span> <span class="nf">multiply_world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.multiply_world-583"><a href="#CoordinateSystem.multiply_world-583"><span class="linenos">583</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Multiply the coordinates in the world coordinates after applying</span>
</span><span id="CoordinateSystem.multiply_world-584"><a href="#CoordinateSystem.multiply_world-584"><span class="linenos">584</span></a><span class="sd">        the current affine transformation.</span>
</span><span id="CoordinateSystem.multiply_world-585"><a href="#CoordinateSystem.multiply_world-585"><span class="linenos">585</span></a>
</span><span id="CoordinateSystem.multiply_world-586"><a href="#CoordinateSystem.multiply_world-586"><span class="linenos">586</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem.multiply_world-587"><a href="#CoordinateSystem.multiply_world-587"><span class="linenos">587</span></a><span class="sd">            factor: Factor to multiply each dimension of the grid. A tensor with</span>
</span><span id="CoordinateSystem.multiply_world-588"><a href="#CoordinateSystem.multiply_world-588"><span class="linenos">588</span></a><span class="sd">                shape ([*batch_shape, ]n_output_dims). Can be also given as a number</span>
</span><span id="CoordinateSystem.multiply_world-589"><a href="#CoordinateSystem.multiply_world-589"><span class="linenos">589</span></a><span class="sd">                or sequence of numbers.</span>
</span><span id="CoordinateSystem.multiply_world-590"><a href="#CoordinateSystem.multiply_world-590"><span class="linenos">590</span></a>
</span><span id="CoordinateSystem.multiply_world-591"><a href="#CoordinateSystem.multiply_world-591"><span class="linenos">591</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem.multiply_world-592"><a href="#CoordinateSystem.multiply_world-592"><span class="linenos">592</span></a><span class="sd">            Coordinate system with a modified affine transformation from voxel</span>
</span><span id="CoordinateSystem.multiply_world-593"><a href="#CoordinateSystem.multiply_world-593"><span class="linenos">593</span></a><span class="sd">            to world coordinates.</span>
</span><span id="CoordinateSystem.multiply_world-594"><a href="#CoordinateSystem.multiply_world-594"><span class="linenos">594</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.multiply_world-595"><a href="#CoordinateSystem.multiply_world-595"><span class="linenos">595</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_world_with_diagonal_matrix</span><span class="p">(</span><span class="n">diagonal</span><span class="o">=</span><span class="n">factor</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Multiply the coordinates in the world coordinates after applying
the current affine transformation.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>factor:</strong>  Factor to multiply each dimension of the grid. A tensor with
shape ([*batch_shape, ]n_output_dims). Can be also given as a number
or sequence of numbers.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Coordinate system with a modified affine transformation from voxel
  to world coordinates.</p>
</blockquote>
</div>


                            </div>
                            <div id="CoordinateSystem.reformat" class="classattr">
                                        <input id="CoordinateSystem.reformat-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reformat</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="o">*</span>,</span><span class="param">	<span class="n">downsampling_factor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">upsampling_factor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">voxel_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n"><a href="#ReformattingSpatialShape">ReformattingSpatialShape</a></span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n"><a href="#ReformattingSpatialShape">ReformattingSpatialShape</a></span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n"><a href="#OriginalFOV">OriginalFOV</a></span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">reference</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n"><a href="#ReformattingReference">ReformattingReference</a></span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n"><a href="#ReformattingReference">ReformattingReference</a></span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n"><a href="#Center">Center</a></span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">target_reference</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n"><a href="#ReformattingReference">ReformattingReference</a></span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n"><a href="#ReformattingReference">ReformattingReference</a></span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>:</span></span>

                <label class="view-source-button" for="CoordinateSystem.reformat-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CoordinateSystem.reformat"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CoordinateSystem.reformat-651"><a href="#CoordinateSystem.reformat-651"><span class="linenos">651</span></a>    <span class="k">def</span> <span class="nf">reformat</span><span class="p">(</span>
</span><span id="CoordinateSystem.reformat-652"><a href="#CoordinateSystem.reformat-652"><span class="linenos">652</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CoordinateSystem.reformat-653"><a href="#CoordinateSystem.reformat-653"><span class="linenos">653</span></a>        <span class="o">*</span><span class="p">,</span>
</span><span id="CoordinateSystem.reformat-654"><a href="#CoordinateSystem.reformat-654"><span class="linenos">654</span></a>        <span class="n">downsampling_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.reformat-655"><a href="#CoordinateSystem.reformat-655"><span class="linenos">655</span></a>        <span class="n">upsampling_factor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.reformat-656"><a href="#CoordinateSystem.reformat-656"><span class="linenos">656</span></a>        <span class="n">voxel_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">],</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.reformat-657"><a href="#CoordinateSystem.reformat-657"><span class="linenos">657</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="CoordinateSystem.reformat-658"><a href="#CoordinateSystem.reformat-658"><span class="linenos">658</span></a>            <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ReformattingSpatialShape</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
</span><span id="CoordinateSystem.reformat-659"><a href="#CoordinateSystem.reformat-659"><span class="linenos">659</span></a>            <span class="n">ReformattingSpatialShape</span><span class="p">,</span>
</span><span id="CoordinateSystem.reformat-660"><a href="#CoordinateSystem.reformat-660"><span class="linenos">660</span></a>            <span class="nb">int</span><span class="p">,</span>
</span><span id="CoordinateSystem.reformat-661"><a href="#CoordinateSystem.reformat-661"><span class="linenos">661</span></a>            <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CoordinateSystem.reformat-662"><a href="#CoordinateSystem.reformat-662"><span class="linenos">662</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">OriginalFOV</span><span class="p">(</span><span class="n">fitting_method</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">fov_convention</span><span class="o">=</span><span class="s2">&quot;full_voxels&quot;</span><span class="p">),</span>
</span><span id="CoordinateSystem.reformat-663"><a href="#CoordinateSystem.reformat-663"><span class="linenos">663</span></a>        <span class="n">reference</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="CoordinateSystem.reformat-664"><a href="#CoordinateSystem.reformat-664"><span class="linenos">664</span></a>            <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ReformattingReference</span><span class="p">,</span> <span class="n">Number</span><span class="p">]],</span>
</span><span id="CoordinateSystem.reformat-665"><a href="#CoordinateSystem.reformat-665"><span class="linenos">665</span></a>            <span class="n">ReformattingReference</span><span class="p">,</span>
</span><span id="CoordinateSystem.reformat-666"><a href="#CoordinateSystem.reformat-666"><span class="linenos">666</span></a>            <span class="n">Number</span><span class="p">,</span>
</span><span id="CoordinateSystem.reformat-667"><a href="#CoordinateSystem.reformat-667"><span class="linenos">667</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">Center</span><span class="p">(),</span>
</span><span id="CoordinateSystem.reformat-668"><a href="#CoordinateSystem.reformat-668"><span class="linenos">668</span></a>        <span class="n">target_reference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
</span><span id="CoordinateSystem.reformat-669"><a href="#CoordinateSystem.reformat-669"><span class="linenos">669</span></a>            <span class="n">Union</span><span class="p">[</span>
</span><span id="CoordinateSystem.reformat-670"><a href="#CoordinateSystem.reformat-670"><span class="linenos">670</span></a>                <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ReformattingReference</span><span class="p">,</span> <span class="n">Number</span><span class="p">]],</span>
</span><span id="CoordinateSystem.reformat-671"><a href="#CoordinateSystem.reformat-671"><span class="linenos">671</span></a>                <span class="n">ReformattingReference</span><span class="p">,</span>
</span><span id="CoordinateSystem.reformat-672"><a href="#CoordinateSystem.reformat-672"><span class="linenos">672</span></a>                <span class="n">Number</span><span class="p">,</span>
</span><span id="CoordinateSystem.reformat-673"><a href="#CoordinateSystem.reformat-673"><span class="linenos">673</span></a>            <span class="p">]</span>
</span><span id="CoordinateSystem.reformat-674"><a href="#CoordinateSystem.reformat-674"><span class="linenos">674</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CoordinateSystem.reformat-675"><a href="#CoordinateSystem.reformat-675"><span class="linenos">675</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="CoordinateSystem.reformat-676"><a href="#CoordinateSystem.reformat-676"><span class="linenos">676</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reformat the coordinate system.</span>
</span><span id="CoordinateSystem.reformat-677"><a href="#CoordinateSystem.reformat-677"><span class="linenos">677</span></a>
</span><span id="CoordinateSystem.reformat-678"><a href="#CoordinateSystem.reformat-678"><span class="linenos">678</span></a><span class="sd">        All tensors should be provided on the host (cpu). That is, since the</span>
</span><span id="CoordinateSystem.reformat-679"><a href="#CoordinateSystem.reformat-679"><span class="linenos">679</span></a><span class="sd">        transformation may be used in control flow decisions, and we want to</span>
</span><span id="CoordinateSystem.reformat-680"><a href="#CoordinateSystem.reformat-680"><span class="linenos">680</span></a><span class="sd">        avoid synchronizing the target device with the host. The matrix is moved</span>
</span><span id="CoordinateSystem.reformat-681"><a href="#CoordinateSystem.reformat-681"><span class="linenos">681</span></a><span class="sd">        to the target device asynchronously, if needed.</span>
</span><span id="CoordinateSystem.reformat-682"><a href="#CoordinateSystem.reformat-682"><span class="linenos">682</span></a>
</span><span id="CoordinateSystem.reformat-683"><a href="#CoordinateSystem.reformat-683"><span class="linenos">683</span></a><span class="sd">        Args:</span>
</span><span id="CoordinateSystem.reformat-684"><a href="#CoordinateSystem.reformat-684"><span class="linenos">684</span></a><span class="sd">            downsampling_factor: Factor to downsample the grid voxel size. A tensor</span>
</span><span id="CoordinateSystem.reformat-685"><a href="#CoordinateSystem.reformat-685"><span class="linenos">685</span></a><span class="sd">                with shape ([*batch_shape, ]n_spatial_dims). Can be also given as a</span>
</span><span id="CoordinateSystem.reformat-686"><a href="#CoordinateSystem.reformat-686"><span class="linenos">686</span></a><span class="sd">                number or sequence of numbers.</span>
</span><span id="CoordinateSystem.reformat-687"><a href="#CoordinateSystem.reformat-687"><span class="linenos">687</span></a><span class="sd">            upsampling_factor: Factor to upsample the grid voxel size. A tensor with</span>
</span><span id="CoordinateSystem.reformat-688"><a href="#CoordinateSystem.reformat-688"><span class="linenos">688</span></a><span class="sd">                shape ([*batch_shape, ]n_spatial_dims). Can be also given as a number</span>
</span><span id="CoordinateSystem.reformat-689"><a href="#CoordinateSystem.reformat-689"><span class="linenos">689</span></a><span class="sd">                or sequence of numbers.</span>
</span><span id="CoordinateSystem.reformat-690"><a href="#CoordinateSystem.reformat-690"><span class="linenos">690</span></a><span class="sd">            voxel_size: Voxel size of the reformatted grid. A tensor with shape</span>
</span><span id="CoordinateSystem.reformat-691"><a href="#CoordinateSystem.reformat-691"><span class="linenos">691</span></a><span class="sd">                ([*batch_shape, ]n_spatial_dims). Can be also given as a number or</span>
</span><span id="CoordinateSystem.reformat-692"><a href="#CoordinateSystem.reformat-692"><span class="linenos">692</span></a><span class="sd">                sequence of numbers.</span>
</span><span id="CoordinateSystem.reformat-693"><a href="#CoordinateSystem.reformat-693"><span class="linenos">693</span></a><span class="sd">            spatial_shape: Defines spatial_shape of the target grid, either</span>
</span><span id="CoordinateSystem.reformat-694"><a href="#CoordinateSystem.reformat-694"><span class="linenos">694</span></a><span class="sd">                given separately for each dimension or as a single value in</span>
</span><span id="CoordinateSystem.reformat-695"><a href="#CoordinateSystem.reformat-695"><span class="linenos">695</span></a><span class="sd">                which case the same value is used for all the dimensions.</span>
</span><span id="CoordinateSystem.reformat-696"><a href="#CoordinateSystem.reformat-696"><span class="linenos">696</span></a><span class="sd">                Defaults to OriginalFOV(&quot;round&quot;, &quot;full_voxels&quot;).</span>
</span><span id="CoordinateSystem.reformat-697"><a href="#CoordinateSystem.reformat-697"><span class="linenos">697</span></a><span class="sd">            reference: Defines the point in the original voxel</span>
</span><span id="CoordinateSystem.reformat-698"><a href="#CoordinateSystem.reformat-698"><span class="linenos">698</span></a><span class="sd">                coordinates which will be aligned with the target reference in</span>
</span><span id="CoordinateSystem.reformat-699"><a href="#CoordinateSystem.reformat-699"><span class="linenos">699</span></a><span class="sd">                the reformatted coordinates. Either given separately for each</span>
</span><span id="CoordinateSystem.reformat-700"><a href="#CoordinateSystem.reformat-700"><span class="linenos">700</span></a><span class="sd">                dimension or as a single value in which case the same value is</span>
</span><span id="CoordinateSystem.reformat-701"><a href="#CoordinateSystem.reformat-701"><span class="linenos">701</span></a><span class="sd">                used for all the dimensions. Defaults to Center().</span>
</span><span id="CoordinateSystem.reformat-702"><a href="#CoordinateSystem.reformat-702"><span class="linenos">702</span></a><span class="sd">            target_reference: Defaults to reference. Defines the point in the</span>
</span><span id="CoordinateSystem.reformat-703"><a href="#CoordinateSystem.reformat-703"><span class="linenos">703</span></a><span class="sd">                reformatted voxel coordinates which will be aligned with the</span>
</span><span id="CoordinateSystem.reformat-704"><a href="#CoordinateSystem.reformat-704"><span class="linenos">704</span></a><span class="sd">                source reference in the original coordinates. Either given</span>
</span><span id="CoordinateSystem.reformat-705"><a href="#CoordinateSystem.reformat-705"><span class="linenos">705</span></a><span class="sd">                separately for each dimension or as a single value in which case</span>
</span><span id="CoordinateSystem.reformat-706"><a href="#CoordinateSystem.reformat-706"><span class="linenos">706</span></a><span class="sd">                the same value is used for all the dimensions.</span>
</span><span id="CoordinateSystem.reformat-707"><a href="#CoordinateSystem.reformat-707"><span class="linenos">707</span></a>
</span><span id="CoordinateSystem.reformat-708"><a href="#CoordinateSystem.reformat-708"><span class="linenos">708</span></a><span class="sd">        Returns:</span>
</span><span id="CoordinateSystem.reformat-709"><a href="#CoordinateSystem.reformat-709"><span class="linenos">709</span></a><span class="sd">            Reformatted coordinate system.</span>
</span><span id="CoordinateSystem.reformat-710"><a href="#CoordinateSystem.reformat-710"><span class="linenos">710</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CoordinateSystem.reformat-711"><a href="#CoordinateSystem.reformat-711"><span class="linenos">711</span></a>        <span class="n">original_voxel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_spacing_cpu</span><span class="p">()</span>
</span><span id="CoordinateSystem.reformat-712"><a href="#CoordinateSystem.reformat-712"><span class="linenos">712</span></a>        <span class="n">downsampling_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_as_downsampling_factor</span><span class="p">(</span>
</span><span id="CoordinateSystem.reformat-713"><a href="#CoordinateSystem.reformat-713"><span class="linenos">713</span></a>            <span class="n">original_voxel_size</span><span class="p">,</span> <span class="n">downsampling_factor</span><span class="p">,</span> <span class="n">upsampling_factor</span><span class="p">,</span> <span class="n">voxel_size</span>
</span><span id="CoordinateSystem.reformat-714"><a href="#CoordinateSystem.reformat-714"><span class="linenos">714</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem.reformat-715"><a href="#CoordinateSystem.reformat-715"><span class="linenos">715</span></a>        <span class="n">target_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_target_shape</span><span class="p">(</span><span class="n">downsampling_factor</span><span class="p">,</span> <span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem.reformat-716"><a href="#CoordinateSystem.reformat-716"><span class="linenos">716</span></a>        <span class="n">source_reference_in_voxel_coordinates</span> <span class="o">=</span> <span class="n">original_voxel_size</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span>
</span><span id="CoordinateSystem.reformat-717"><a href="#CoordinateSystem.reformat-717"><span class="linenos">717</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_reference_in_voxel_coordinates</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem.reformat-718"><a href="#CoordinateSystem.reformat-718"><span class="linenos">718</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem.reformat-719"><a href="#CoordinateSystem.reformat-719"><span class="linenos">719</span></a>        <span class="k">if</span> <span class="n">target_reference</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CoordinateSystem.reformat-720"><a href="#CoordinateSystem.reformat-720"><span class="linenos">720</span></a>            <span class="n">target_reference</span> <span class="o">=</span> <span class="n">reference</span>
</span><span id="CoordinateSystem.reformat-721"><a href="#CoordinateSystem.reformat-721"><span class="linenos">721</span></a>        <span class="n">target_reference_in_voxel_coordinates</span> <span class="o">=</span> <span class="n">original_voxel_size</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span>
</span><span id="CoordinateSystem.reformat-722"><a href="#CoordinateSystem.reformat-722"><span class="linenos">722</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_get_reference_in_voxel_coordinates</span><span class="p">(</span><span class="n">target_reference</span><span class="p">,</span> <span class="n">target_shape</span><span class="p">)</span>
</span><span id="CoordinateSystem.reformat-723"><a href="#CoordinateSystem.reformat-723"><span class="linenos">723</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem.reformat-724"><a href="#CoordinateSystem.reformat-724"><span class="linenos">724</span></a>        <span class="n">source_translation</span> <span class="o">=</span> <span class="n">HostDiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="CoordinateSystem.reformat-725"><a href="#CoordinateSystem.reformat-725"><span class="linenos">725</span></a>            <span class="n">translation</span><span class="o">=</span><span class="n">source_reference_in_voxel_coordinates</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span>
</span><span id="CoordinateSystem.reformat-726"><a href="#CoordinateSystem.reformat-726"><span class="linenos">726</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem.reformat-727"><a href="#CoordinateSystem.reformat-727"><span class="linenos">727</span></a>        <span class="n">target_translation</span> <span class="o">=</span> <span class="n">HostDiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="CoordinateSystem.reformat-728"><a href="#CoordinateSystem.reformat-728"><span class="linenos">728</span></a>            <span class="n">translation</span><span class="o">=-</span><span class="n">target_reference_in_voxel_coordinates</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span>
</span><span id="CoordinateSystem.reformat-729"><a href="#CoordinateSystem.reformat-729"><span class="linenos">729</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem.reformat-730"><a href="#CoordinateSystem.reformat-730"><span class="linenos">730</span></a>        <span class="n">downsampling_translation</span> <span class="o">=</span> <span class="n">HostDiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="CoordinateSystem.reformat-731"><a href="#CoordinateSystem.reformat-731"><span class="linenos">731</span></a>            <span class="n">downsampling_factor</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span>
</span><span id="CoordinateSystem.reformat-732"><a href="#CoordinateSystem.reformat-732"><span class="linenos">732</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem.reformat-733"><a href="#CoordinateSystem.reformat-733"><span class="linenos">733</span></a>        <span class="n">reformatted_transformation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="CoordinateSystem.reformat-734"><a href="#CoordinateSystem.reformat-734"><span class="linenos">734</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_from_voxel_coordinates</span>
</span><span id="CoordinateSystem.reformat-735"><a href="#CoordinateSystem.reformat-735"><span class="linenos">735</span></a>            <span class="o">@</span> <span class="n">source_translation</span>
</span><span id="CoordinateSystem.reformat-736"><a href="#CoordinateSystem.reformat-736"><span class="linenos">736</span></a>            <span class="o">@</span> <span class="n">downsampling_translation</span>
</span><span id="CoordinateSystem.reformat-737"><a href="#CoordinateSystem.reformat-737"><span class="linenos">737</span></a>            <span class="o">@</span> <span class="n">target_translation</span>
</span><span id="CoordinateSystem.reformat-738"><a href="#CoordinateSystem.reformat-738"><span class="linenos">738</span></a>        <span class="p">)</span>
</span><span id="CoordinateSystem.reformat-739"><a href="#CoordinateSystem.reformat-739"><span class="linenos">739</span></a>
</span><span id="CoordinateSystem.reformat-740"><a href="#CoordinateSystem.reformat-740"><span class="linenos">740</span></a>        <span class="k">return</span> <span class="n">CoordinateSystem</span><span class="p">(</span>
</span><span id="CoordinateSystem.reformat-741"><a href="#CoordinateSystem.reformat-741"><span class="linenos">741</span></a>            <span class="n">from_voxel_coordinates</span><span class="o">=</span><span class="n">reformatted_transformation</span><span class="p">,</span>
</span><span id="CoordinateSystem.reformat-742"><a href="#CoordinateSystem.reformat-742"><span class="linenos">742</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="n">target_shape</span><span class="p">,</span>
</span><span id="CoordinateSystem.reformat-743"><a href="#CoordinateSystem.reformat-743"><span class="linenos">743</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Reformat the coordinate system.</p>

<p>All tensors should be provided on the host (cpu). That is, since the
transformation may be used in control flow decisions, and we want to
avoid synchronizing the target device with the host. The matrix is moved
to the target device asynchronously, if needed.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>downsampling_factor:</strong>  Factor to downsample the grid voxel size. A tensor
with shape ([*batch_shape, ]n_spatial_dims). Can be also given as a
number or sequence of numbers.</li>
<li><strong>upsampling_factor:</strong>  Factor to upsample the grid voxel size. A tensor with
shape ([*batch_shape, ]n_spatial_dims). Can be also given as a number
or sequence of numbers.</li>
<li><strong>voxel_size:</strong>  Voxel size of the reformatted grid. A tensor with shape
([*batch_shape, ]n_spatial_dims). Can be also given as a number or
sequence of numbers.</li>
<li><strong>spatial_shape:</strong>  Defines spatial_shape of the target grid, either
given separately for each dimension or as a single value in
which case the same value is used for all the dimensions.
Defaults to OriginalFOV("round", "full_voxels").</li>
<li><strong>reference:</strong>  Defines the point in the original voxel
coordinates which will be aligned with the target reference in
the reformatted coordinates. Either given separately for each
dimension or as a single value in which case the same value is
used for all the dimensions. Defaults to Center().</li>
<li><strong>target_reference:</strong>  Defaults to reference. Defines the point in the
reformatted voxel coordinates which will be aligned with the
source reference in the original coordinates. Either given
separately for each dimension or as a single value in which case
the same value is used for all the dimensions.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Reformatted coordinate system.</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="CoordinateSystem.dump_patches" class="variable">dump_patches</dd>
                <dd id="CoordinateSystem.training" class="variable">training</dd>
                <dd id="CoordinateSystem.call_super_init" class="variable">call_super_init</dd>
                <dd id="CoordinateSystem.register_buffer" class="function">register_buffer</dd>
                <dd id="CoordinateSystem.register_parameter" class="function">register_parameter</dd>
                <dd id="CoordinateSystem.add_module" class="function">add_module</dd>
                <dd id="CoordinateSystem.register_module" class="function">register_module</dd>
                <dd id="CoordinateSystem.get_submodule" class="function">get_submodule</dd>
                <dd id="CoordinateSystem.get_parameter" class="function">get_parameter</dd>
                <dd id="CoordinateSystem.get_buffer" class="function">get_buffer</dd>
                <dd id="CoordinateSystem.get_extra_state" class="function">get_extra_state</dd>
                <dd id="CoordinateSystem.set_extra_state" class="function">set_extra_state</dd>
                <dd id="CoordinateSystem.apply" class="function">apply</dd>
                <dd id="CoordinateSystem.cuda" class="function">cuda</dd>
                <dd id="CoordinateSystem.ipu" class="function">ipu</dd>
                <dd id="CoordinateSystem.xpu" class="function">xpu</dd>
                <dd id="CoordinateSystem.cpu" class="function">cpu</dd>
                <dd id="CoordinateSystem.type" class="function">type</dd>
                <dd id="CoordinateSystem.float" class="function">float</dd>
                <dd id="CoordinateSystem.double" class="function">double</dd>
                <dd id="CoordinateSystem.half" class="function">half</dd>
                <dd id="CoordinateSystem.bfloat16" class="function">bfloat16</dd>
                <dd id="CoordinateSystem.to_empty" class="function">to_empty</dd>
                <dd id="CoordinateSystem.to" class="function">to</dd>
                <dd id="CoordinateSystem.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="CoordinateSystem.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="CoordinateSystem.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="CoordinateSystem.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="CoordinateSystem.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="CoordinateSystem.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="CoordinateSystem.state_dict" class="function">state_dict</dd>
                <dd id="CoordinateSystem.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="CoordinateSystem.load_state_dict" class="function">load_state_dict</dd>
                <dd id="CoordinateSystem.parameters" class="function">parameters</dd>
                <dd id="CoordinateSystem.named_parameters" class="function">named_parameters</dd>
                <dd id="CoordinateSystem.buffers" class="function">buffers</dd>
                <dd id="CoordinateSystem.named_buffers" class="function">named_buffers</dd>
                <dd id="CoordinateSystem.children" class="function">children</dd>
                <dd id="CoordinateSystem.named_children" class="function">named_children</dd>
                <dd id="CoordinateSystem.modules" class="function">modules</dd>
                <dd id="CoordinateSystem.named_modules" class="function">named_modules</dd>
                <dd id="CoordinateSystem.train" class="function">train</dd>
                <dd id="CoordinateSystem.eval" class="function">eval</dd>
                <dd id="CoordinateSystem.requires_grad_" class="function">requires_grad_</dd>
                <dd id="CoordinateSystem.zero_grad" class="function">zero_grad</dd>
                <dd id="CoordinateSystem.share_memory" class="function">share_memory</dd>
                <dd id="CoordinateSystem.extra_repr" class="function">extra_repr</dd>
                <dd id="CoordinateSystem.compile" class="function">compile</dd>

            </div>
            <div><dt>composable_mapping.tensor_like.BaseTensorLikeWrapper</dt>
                                <dd id="CoordinateSystem.cast" class="function">cast</dd>
                <dd id="CoordinateSystem.pin_memory" class="function">pin_memory</dd>
                <dd id="CoordinateSystem.detach" class="function">detach</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="CubicSplineSampler">
                            <input id="CubicSplineSampler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CubicSplineSampler</span><wbr>(<span class="base"><a href="#BaseSeparableSampler">composable_mapping.BaseSeparableSampler</a></span>):

                <label class="view-source-button" for="CubicSplineSampler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CubicSplineSampler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CubicSplineSampler-14"><a href="#CubicSplineSampler-14"><span class="linenos"> 14</span></a><span class="k">class</span> <span class="nc">CubicSplineSampler</span><span class="p">(</span><span class="n">BaseSeparableSampler</span><span class="p">):</span>
</span><span id="CubicSplineSampler-15"><a href="#CubicSplineSampler-15"><span class="linenos"> 15</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Sampling based on regularly spaced cubic spline control points in voxel</span>
</span><span id="CubicSplineSampler-16"><a href="#CubicSplineSampler-16"><span class="linenos"> 16</span></a><span class="sd">    coordinates</span>
</span><span id="CubicSplineSampler-17"><a href="#CubicSplineSampler-17"><span class="linenos"> 17</span></a>
</span><span id="CubicSplineSampler-18"><a href="#CubicSplineSampler-18"><span class="linenos"> 18</span></a><span class="sd">    Arguments:</span>
</span><span id="CubicSplineSampler-19"><a href="#CubicSplineSampler-19"><span class="linenos"> 19</span></a><span class="sd">        prefilter: Whether to prefilter the volume before sampling making</span>
</span><span id="CubicSplineSampler-20"><a href="#CubicSplineSampler-20"><span class="linenos"> 20</span></a><span class="sd">            the sampler an interpolator. Currently not implemented.</span>
</span><span id="CubicSplineSampler-21"><a href="#CubicSplineSampler-21"><span class="linenos"> 21</span></a><span class="sd">        extrapolation_mode: Extrapolation mode for out-of-bound coordinates.</span>
</span><span id="CubicSplineSampler-22"><a href="#CubicSplineSampler-22"><span class="linenos"> 22</span></a><span class="sd">        mask_extrapolated_regions_for_empty_volume_mask: Whether to mask</span>
</span><span id="CubicSplineSampler-23"><a href="#CubicSplineSampler-23"><span class="linenos"> 23</span></a><span class="sd">            extrapolated regions when input volume mask is empty.</span>
</span><span id="CubicSplineSampler-24"><a href="#CubicSplineSampler-24"><span class="linenos"> 24</span></a><span class="sd">        convolution_threshold: Maximum allowed difference in coordinates</span>
</span><span id="CubicSplineSampler-25"><a href="#CubicSplineSampler-25"><span class="linenos"> 25</span></a><span class="sd">            for using convolution-based sampling (the difference might be upper</span>
</span><span id="CubicSplineSampler-26"><a href="#CubicSplineSampler-26"><span class="linenos"> 26</span></a><span class="sd">            bounded when doing the decision).</span>
</span><span id="CubicSplineSampler-27"><a href="#CubicSplineSampler-27"><span class="linenos"> 27</span></a><span class="sd">        mask_threshold: Maximum allowed weight for masked regions in a</span>
</span><span id="CubicSplineSampler-28"><a href="#CubicSplineSampler-28"><span class="linenos"> 28</span></a><span class="sd">            sampled location to still consider it valid (non-masked).</span>
</span><span id="CubicSplineSampler-29"><a href="#CubicSplineSampler-29"><span class="linenos"> 29</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="CubicSplineSampler-30"><a href="#CubicSplineSampler-30"><span class="linenos"> 30</span></a>
</span><span id="CubicSplineSampler-31"><a href="#CubicSplineSampler-31"><span class="linenos"> 31</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="CubicSplineSampler-32"><a href="#CubicSplineSampler-32"><span class="linenos"> 32</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CubicSplineSampler-33"><a href="#CubicSplineSampler-33"><span class="linenos"> 33</span></a>        <span class="n">prefilter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="CubicSplineSampler-34"><a href="#CubicSplineSampler-34"><span class="linenos"> 34</span></a>        <span class="n">extrapolation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;border&quot;</span><span class="p">,</span>
</span><span id="CubicSplineSampler-35"><a href="#CubicSplineSampler-35"><span class="linenos"> 35</span></a>        <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="CubicSplineSampler-36"><a href="#CubicSplineSampler-36"><span class="linenos"> 36</span></a>        <span class="n">convolution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
</span><span id="CubicSplineSampler-37"><a href="#CubicSplineSampler-37"><span class="linenos"> 37</span></a>        <span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span>
</span><span id="CubicSplineSampler-38"><a href="#CubicSplineSampler-38"><span class="linenos"> 38</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CubicSplineSampler-39"><a href="#CubicSplineSampler-39"><span class="linenos"> 39</span></a>        <span class="k">if</span> <span class="n">prefilter</span><span class="p">:</span>
</span><span id="CubicSplineSampler-40"><a href="#CubicSplineSampler-40"><span class="linenos"> 40</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="CubicSplineSampler-41"><a href="#CubicSplineSampler-41"><span class="linenos"> 41</span></a>                <span class="s2">&quot;Prefiltering is currently not implemented. &quot;</span>
</span><span id="CubicSplineSampler-42"><a href="#CubicSplineSampler-42"><span class="linenos"> 42</span></a>                <span class="s2">&quot;Contact the developers if you would want it included.&quot;</span>
</span><span id="CubicSplineSampler-43"><a href="#CubicSplineSampler-43"><span class="linenos"> 43</span></a>            <span class="p">)</span>
</span><span id="CubicSplineSampler-44"><a href="#CubicSplineSampler-44"><span class="linenos"> 44</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="CubicSplineSampler-45"><a href="#CubicSplineSampler-45"><span class="linenos"> 45</span></a>            <span class="n">extrapolation_mode</span><span class="o">=</span><span class="n">extrapolation_mode</span><span class="p">,</span>
</span><span id="CubicSplineSampler-46"><a href="#CubicSplineSampler-46"><span class="linenos"> 46</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="o">=</span><span class="p">(</span>
</span><span id="CubicSplineSampler-47"><a href="#CubicSplineSampler-47"><span class="linenos"> 47</span></a>                <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="CubicSplineSampler-48"><a href="#CubicSplineSampler-48"><span class="linenos"> 48</span></a>            <span class="p">),</span>
</span><span id="CubicSplineSampler-49"><a href="#CubicSplineSampler-49"><span class="linenos"> 49</span></a>            <span class="n">convolution_threshold</span><span class="o">=</span><span class="n">convolution_threshold</span><span class="p">,</span>
</span><span id="CubicSplineSampler-50"><a href="#CubicSplineSampler-50"><span class="linenos"> 50</span></a>            <span class="n">mask_threshold</span><span class="o">=</span><span class="n">mask_threshold</span><span class="p">,</span>
</span><span id="CubicSplineSampler-51"><a href="#CubicSplineSampler-51"><span class="linenos"> 51</span></a>            <span class="n">limit_direction</span><span class="o">=</span><span class="n">LimitDirection</span><span class="o">.</span><span class="n">right</span><span class="p">(),</span>
</span><span id="CubicSplineSampler-52"><a href="#CubicSplineSampler-52"><span class="linenos"> 52</span></a>        <span class="p">)</span>
</span><span id="CubicSplineSampler-53"><a href="#CubicSplineSampler-53"><span class="linenos"> 53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span> <span class="o">=</span> <span class="n">mask_threshold</span>
</span><span id="CubicSplineSampler-54"><a href="#CubicSplineSampler-54"><span class="linenos"> 54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_prefilter</span> <span class="o">=</span> <span class="n">prefilter</span>
</span><span id="CubicSplineSampler-55"><a href="#CubicSplineSampler-55"><span class="linenos"> 55</span></a>
</span><span id="CubicSplineSampler-56"><a href="#CubicSplineSampler-56"><span class="linenos"> 56</span></a>    <span class="k">def</span> <span class="nf">_kernel_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ISeparableKernelSupport</span><span class="p">:</span>
</span><span id="CubicSplineSampler-57"><a href="#CubicSplineSampler-57"><span class="linenos"> 57</span></a>        <span class="k">return</span> <span class="n">SymmetricPolynomialKernelSupport</span><span class="p">(</span><span class="n">kernel_width</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">polynomial_degree</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="CubicSplineSampler-58"><a href="#CubicSplineSampler-58"><span class="linenos"> 58</span></a>
</span><span id="CubicSplineSampler-59"><a href="#CubicSplineSampler-59"><span class="linenos"> 59</span></a>    <span class="k">def</span> <span class="nf">_is_interpolating_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="CubicSplineSampler-60"><a href="#CubicSplineSampler-60"><span class="linenos"> 60</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefilter</span>
</span><span id="CubicSplineSampler-61"><a href="#CubicSplineSampler-61"><span class="linenos"> 61</span></a>
</span><span id="CubicSplineSampler-62"><a href="#CubicSplineSampler-62"><span class="linenos"> 62</span></a>    <span class="k">def</span> <span class="nf">_kernel_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="CubicSplineSampler-63"><a href="#CubicSplineSampler-63"><span class="linenos"> 63</span></a>        <span class="n">abs_coordinates</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
</span><span id="CubicSplineSampler-64"><a href="#CubicSplineSampler-64"><span class="linenos"> 64</span></a>        <span class="n">center_part</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">abs_coordinates</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">abs_coordinates</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CubicSplineSampler-65"><a href="#CubicSplineSampler-65"><span class="linenos"> 65</span></a>        <span class="n">surrounding_part</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">abs_coordinates</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span>
</span><span id="CubicSplineSampler-66"><a href="#CubicSplineSampler-66"><span class="linenos"> 66</span></a>        <span class="k">return</span> <span class="n">center_part</span><span class="p">,</span> <span class="n">surrounding_part</span>
</span><span id="CubicSplineSampler-67"><a href="#CubicSplineSampler-67"><span class="linenos"> 67</span></a>
</span><span id="CubicSplineSampler-68"><a href="#CubicSplineSampler-68"><span class="linenos"> 68</span></a>    <span class="k">def</span> <span class="nf">_left_limit_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="CubicSplineSampler-69"><a href="#CubicSplineSampler-69"><span class="linenos"> 69</span></a>        <span class="n">center_part</span><span class="p">,</span> <span class="n">surrounding_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_parts</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
</span><span id="CubicSplineSampler-70"><a href="#CubicSplineSampler-70"><span class="linenos"> 70</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="CubicSplineSampler-71"><a href="#CubicSplineSampler-71"><span class="linenos"> 71</span></a>            <span class="n">surrounding_part</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="CubicSplineSampler-72"><a href="#CubicSplineSampler-72"><span class="linenos"> 72</span></a>            <span class="o">+</span> <span class="n">center_part</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="CubicSplineSampler-73"><a href="#CubicSplineSampler-73"><span class="linenos"> 73</span></a>            <span class="o">+</span> <span class="n">center_part</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="CubicSplineSampler-74"><a href="#CubicSplineSampler-74"><span class="linenos"> 74</span></a>            <span class="o">+</span> <span class="n">surrounding_part</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="CubicSplineSampler-75"><a href="#CubicSplineSampler-75"><span class="linenos"> 75</span></a>        <span class="p">)</span>
</span><span id="CubicSplineSampler-76"><a href="#CubicSplineSampler-76"><span class="linenos"> 76</span></a>
</span><span id="CubicSplineSampler-77"><a href="#CubicSplineSampler-77"><span class="linenos"> 77</span></a>    <span class="k">def</span> <span class="nf">_right_limit_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="CubicSplineSampler-78"><a href="#CubicSplineSampler-78"><span class="linenos"> 78</span></a>        <span class="n">center_part</span><span class="p">,</span> <span class="n">surrounding_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_parts</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
</span><span id="CubicSplineSampler-79"><a href="#CubicSplineSampler-79"><span class="linenos"> 79</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="CubicSplineSampler-80"><a href="#CubicSplineSampler-80"><span class="linenos"> 80</span></a>            <span class="n">surrounding_part</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="CubicSplineSampler-81"><a href="#CubicSplineSampler-81"><span class="linenos"> 81</span></a>            <span class="o">+</span> <span class="n">center_part</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="CubicSplineSampler-82"><a href="#CubicSplineSampler-82"><span class="linenos"> 82</span></a>            <span class="o">+</span> <span class="n">center_part</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="CubicSplineSampler-83"><a href="#CubicSplineSampler-83"><span class="linenos"> 83</span></a>            <span class="o">+</span> <span class="n">surrounding_part</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="CubicSplineSampler-84"><a href="#CubicSplineSampler-84"><span class="linenos"> 84</span></a>        <span class="p">)</span>
</span><span id="CubicSplineSampler-85"><a href="#CubicSplineSampler-85"><span class="linenos"> 85</span></a>
</span><span id="CubicSplineSampler-86"><a href="#CubicSplineSampler-86"><span class="linenos"> 86</span></a>    <span class="k">def</span> <span class="nf">sample_values</span><span class="p">(</span>
</span><span id="CubicSplineSampler-87"><a href="#CubicSplineSampler-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CubicSplineSampler-88"><a href="#CubicSplineSampler-88"><span class="linenos"> 88</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CubicSplineSampler-89"><a href="#CubicSplineSampler-89"><span class="linenos"> 89</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CubicSplineSampler-90"><a href="#CubicSplineSampler-90"><span class="linenos"> 90</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="CubicSplineSampler-91"><a href="#CubicSplineSampler-91"><span class="linenos"> 91</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="CubicSplineSampler-92"><a href="#CubicSplineSampler-92"><span class="linenos"> 92</span></a>            <span class="s2">&quot;Sampling volume at arbitrary coordinates is not currently implemented. &quot;</span>
</span><span id="CubicSplineSampler-93"><a href="#CubicSplineSampler-93"><span class="linenos"> 93</span></a>            <span class="s2">&quot;Contact the developers if you would want it included.&quot;</span>
</span><span id="CubicSplineSampler-94"><a href="#CubicSplineSampler-94"><span class="linenos"> 94</span></a>        <span class="p">)</span>
</span><span id="CubicSplineSampler-95"><a href="#CubicSplineSampler-95"><span class="linenos"> 95</span></a>
</span><span id="CubicSplineSampler-96"><a href="#CubicSplineSampler-96"><span class="linenos"> 96</span></a>    <span class="k">def</span> <span class="nf">sample_mask</span><span class="p">(</span>
</span><span id="CubicSplineSampler-97"><a href="#CubicSplineSampler-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CubicSplineSampler-98"><a href="#CubicSplineSampler-98"><span class="linenos"> 98</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CubicSplineSampler-99"><a href="#CubicSplineSampler-99"><span class="linenos"> 99</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CubicSplineSampler-100"><a href="#CubicSplineSampler-100"><span class="linenos">100</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="CubicSplineSampler-101"><a href="#CubicSplineSampler-101"><span class="linenos">101</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="CubicSplineSampler-102"><a href="#CubicSplineSampler-102"><span class="linenos">102</span></a>            <span class="s2">&quot;Sampling mask at arbitrary coordinates is not currently implemented. &quot;</span>
</span><span id="CubicSplineSampler-103"><a href="#CubicSplineSampler-103"><span class="linenos">103</span></a>            <span class="s2">&quot;Contact the developers if you would want it included.&quot;</span>
</span><span id="CubicSplineSampler-104"><a href="#CubicSplineSampler-104"><span class="linenos">104</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sampling based on regularly spaced cubic spline control points in voxel
coordinates</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>prefilter:</strong>  Whether to prefilter the volume before sampling making
the sampler an interpolator. Currently not implemented.</li>
<li><strong>extrapolation_mode:</strong>  Extrapolation mode for out-of-bound coordinates.</li>
<li><strong>mask_extrapolated_regions_for_empty_volume_mask:</strong>  Whether to mask
extrapolated regions when input volume mask is empty.</li>
<li><strong>convolution_threshold:</strong>  Maximum allowed difference in coordinates
for using convolution-based sampling (the difference might be upper
bounded when doing the decision).</li>
<li><strong>mask_threshold:</strong>  Maximum allowed weight for masked regions in a
sampled location to still consider it valid (non-masked).</li>
</ul>
</div>


                            <div id="CubicSplineSampler.__init__" class="classattr">
                                        <input id="CubicSplineSampler.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CubicSplineSampler</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">prefilter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">extrapolation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;border&#39;</span>,</span><span class="param">	<span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">convolution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0001</span>,</span><span class="param">	<span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-05</span></span>)</span>

                <label class="view-source-button" for="CubicSplineSampler.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CubicSplineSampler.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CubicSplineSampler.__init__-31"><a href="#CubicSplineSampler.__init__-31"><span class="linenos">31</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="CubicSplineSampler.__init__-32"><a href="#CubicSplineSampler.__init__-32"><span class="linenos">32</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CubicSplineSampler.__init__-33"><a href="#CubicSplineSampler.__init__-33"><span class="linenos">33</span></a>        <span class="n">prefilter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="CubicSplineSampler.__init__-34"><a href="#CubicSplineSampler.__init__-34"><span class="linenos">34</span></a>        <span class="n">extrapolation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;border&quot;</span><span class="p">,</span>
</span><span id="CubicSplineSampler.__init__-35"><a href="#CubicSplineSampler.__init__-35"><span class="linenos">35</span></a>        <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="CubicSplineSampler.__init__-36"><a href="#CubicSplineSampler.__init__-36"><span class="linenos">36</span></a>        <span class="n">convolution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
</span><span id="CubicSplineSampler.__init__-37"><a href="#CubicSplineSampler.__init__-37"><span class="linenos">37</span></a>        <span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span>
</span><span id="CubicSplineSampler.__init__-38"><a href="#CubicSplineSampler.__init__-38"><span class="linenos">38</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CubicSplineSampler.__init__-39"><a href="#CubicSplineSampler.__init__-39"><span class="linenos">39</span></a>        <span class="k">if</span> <span class="n">prefilter</span><span class="p">:</span>
</span><span id="CubicSplineSampler.__init__-40"><a href="#CubicSplineSampler.__init__-40"><span class="linenos">40</span></a>            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="CubicSplineSampler.__init__-41"><a href="#CubicSplineSampler.__init__-41"><span class="linenos">41</span></a>                <span class="s2">&quot;Prefiltering is currently not implemented. &quot;</span>
</span><span id="CubicSplineSampler.__init__-42"><a href="#CubicSplineSampler.__init__-42"><span class="linenos">42</span></a>                <span class="s2">&quot;Contact the developers if you would want it included.&quot;</span>
</span><span id="CubicSplineSampler.__init__-43"><a href="#CubicSplineSampler.__init__-43"><span class="linenos">43</span></a>            <span class="p">)</span>
</span><span id="CubicSplineSampler.__init__-44"><a href="#CubicSplineSampler.__init__-44"><span class="linenos">44</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="CubicSplineSampler.__init__-45"><a href="#CubicSplineSampler.__init__-45"><span class="linenos">45</span></a>            <span class="n">extrapolation_mode</span><span class="o">=</span><span class="n">extrapolation_mode</span><span class="p">,</span>
</span><span id="CubicSplineSampler.__init__-46"><a href="#CubicSplineSampler.__init__-46"><span class="linenos">46</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="o">=</span><span class="p">(</span>
</span><span id="CubicSplineSampler.__init__-47"><a href="#CubicSplineSampler.__init__-47"><span class="linenos">47</span></a>                <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="CubicSplineSampler.__init__-48"><a href="#CubicSplineSampler.__init__-48"><span class="linenos">48</span></a>            <span class="p">),</span>
</span><span id="CubicSplineSampler.__init__-49"><a href="#CubicSplineSampler.__init__-49"><span class="linenos">49</span></a>            <span class="n">convolution_threshold</span><span class="o">=</span><span class="n">convolution_threshold</span><span class="p">,</span>
</span><span id="CubicSplineSampler.__init__-50"><a href="#CubicSplineSampler.__init__-50"><span class="linenos">50</span></a>            <span class="n">mask_threshold</span><span class="o">=</span><span class="n">mask_threshold</span><span class="p">,</span>
</span><span id="CubicSplineSampler.__init__-51"><a href="#CubicSplineSampler.__init__-51"><span class="linenos">51</span></a>            <span class="n">limit_direction</span><span class="o">=</span><span class="n">LimitDirection</span><span class="o">.</span><span class="n">right</span><span class="p">(),</span>
</span><span id="CubicSplineSampler.__init__-52"><a href="#CubicSplineSampler.__init__-52"><span class="linenos">52</span></a>        <span class="p">)</span>
</span><span id="CubicSplineSampler.__init__-53"><a href="#CubicSplineSampler.__init__-53"><span class="linenos">53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span> <span class="o">=</span> <span class="n">mask_threshold</span>
</span><span id="CubicSplineSampler.__init__-54"><a href="#CubicSplineSampler.__init__-54"><span class="linenos">54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_prefilter</span> <span class="o">=</span> <span class="n">prefilter</span>
</span></pre></div>


    

                            </div>
                            <div id="CubicSplineSampler.sample_values" class="classattr">
                                        <input id="CubicSplineSampler.sample_values-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_values</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">volume</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>, </span><span class="param"><span class="n">coordinates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="CubicSplineSampler.sample_values-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CubicSplineSampler.sample_values"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CubicSplineSampler.sample_values-86"><a href="#CubicSplineSampler.sample_values-86"><span class="linenos">86</span></a>    <span class="k">def</span> <span class="nf">sample_values</span><span class="p">(</span>
</span><span id="CubicSplineSampler.sample_values-87"><a href="#CubicSplineSampler.sample_values-87"><span class="linenos">87</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CubicSplineSampler.sample_values-88"><a href="#CubicSplineSampler.sample_values-88"><span class="linenos">88</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CubicSplineSampler.sample_values-89"><a href="#CubicSplineSampler.sample_values-89"><span class="linenos">89</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CubicSplineSampler.sample_values-90"><a href="#CubicSplineSampler.sample_values-90"><span class="linenos">90</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="CubicSplineSampler.sample_values-91"><a href="#CubicSplineSampler.sample_values-91"><span class="linenos">91</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="CubicSplineSampler.sample_values-92"><a href="#CubicSplineSampler.sample_values-92"><span class="linenos">92</span></a>            <span class="s2">&quot;Sampling volume at arbitrary coordinates is not currently implemented. &quot;</span>
</span><span id="CubicSplineSampler.sample_values-93"><a href="#CubicSplineSampler.sample_values-93"><span class="linenos">93</span></a>            <span class="s2">&quot;Contact the developers if you would want it included.&quot;</span>
</span><span id="CubicSplineSampler.sample_values-94"><a href="#CubicSplineSampler.sample_values-94"><span class="linenos">94</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sample values at spatial locations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>volume:</strong>  Volume to sample over spatial dimensions
with shape (*batch_shape, *channels_shape, *spatial_shape)</li>
<li><strong>coordinates:</strong>  Coordinates in voxel coordinates with shape
(*batch_shape, n_spatial_dims, *target_shape).</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Sampled values with shape (*batch_shape, *channels_shape, *target_shape).</p>
</blockquote>
</div>


                            </div>
                            <div id="CubicSplineSampler.sample_mask" class="classattr">
                                        <input id="CubicSplineSampler.sample_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_mask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>, </span><span class="param"><span class="n">coordinates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="CubicSplineSampler.sample_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CubicSplineSampler.sample_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CubicSplineSampler.sample_mask-96"><a href="#CubicSplineSampler.sample_mask-96"><span class="linenos"> 96</span></a>    <span class="k">def</span> <span class="nf">sample_mask</span><span class="p">(</span>
</span><span id="CubicSplineSampler.sample_mask-97"><a href="#CubicSplineSampler.sample_mask-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="CubicSplineSampler.sample_mask-98"><a href="#CubicSplineSampler.sample_mask-98"><span class="linenos"> 98</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CubicSplineSampler.sample_mask-99"><a href="#CubicSplineSampler.sample_mask-99"><span class="linenos"> 99</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="CubicSplineSampler.sample_mask-100"><a href="#CubicSplineSampler.sample_mask-100"><span class="linenos">100</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="CubicSplineSampler.sample_mask-101"><a href="#CubicSplineSampler.sample_mask-101"><span class="linenos">101</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="CubicSplineSampler.sample_mask-102"><a href="#CubicSplineSampler.sample_mask-102"><span class="linenos">102</span></a>            <span class="s2">&quot;Sampling mask at arbitrary coordinates is not currently implemented. &quot;</span>
</span><span id="CubicSplineSampler.sample_mask-103"><a href="#CubicSplineSampler.sample_mask-103"><span class="linenos">103</span></a>            <span class="s2">&quot;Contact the developers if you would want it included.&quot;</span>
</span><span id="CubicSplineSampler.sample_mask-104"><a href="#CubicSplineSampler.sample_mask-104"><span class="linenos">104</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sample mask at spatial locations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mask:</strong>  Mask to sample over spatial dimensions
with shape (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</li>
<li><strong>coordinates:</strong>  Coordinates in voxel coordinates with shape
(*batch_shape, n_spatial_dims, *target_shape).</li>
</ul>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#BaseSeparableSampler">BaseSeparableSampler</a></dt>
                                <dd id="CubicSplineSampler.derivative" class="function"><a href="#BaseSeparableSampler.derivative">derivative</a></dd>
                <dd id="CubicSplineSampler.inverse" class="function"><a href="#BaseSeparableSampler.inverse">inverse</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="DataFormat">
                            <input id="DataFormat-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">DataFormat</span>:

                <label class="view-source-button" for="DataFormat-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DataFormat"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DataFormat-57"><a href="#DataFormat-57"><span class="linenos">57</span></a><span class="k">class</span> <span class="nc">DataFormat</span><span class="p">:</span>
</span><span id="DataFormat-58"><a href="#DataFormat-58"><span class="linenos">58</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Defines data format for sampled volumes.</span>
</span><span id="DataFormat-59"><a href="#DataFormat-59"><span class="linenos">59</span></a>
</span><span id="DataFormat-60"><a href="#DataFormat-60"><span class="linenos">60</span></a><span class="sd">    Arguments:</span>
</span><span id="DataFormat-61"><a href="#DataFormat-61"><span class="linenos">61</span></a><span class="sd">        representation: Representation of the data. Can be one of &quot;coordinates&quot;</span>
</span><span id="DataFormat-62"><a href="#DataFormat-62"><span class="linenos">62</span></a><span class="sd">            or &quot;displacements&quot;.</span>
</span><span id="DataFormat-63"><a href="#DataFormat-63"><span class="linenos">63</span></a><span class="sd">        coordinate_type: Type of the coordinates. Can be one of &quot;world&quot; or</span>
</span><span id="DataFormat-64"><a href="#DataFormat-64"><span class="linenos">64</span></a><span class="sd">            &quot;voxel&quot;.</span>
</span><span id="DataFormat-65"><a href="#DataFormat-65"><span class="linenos">65</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="DataFormat-66"><a href="#DataFormat-66"><span class="linenos">66</span></a>
</span><span id="DataFormat-67"><a href="#DataFormat-67"><span class="linenos">67</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">representation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">coordinate_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DataFormat-68"><a href="#DataFormat-68"><span class="linenos">68</span></a>        <span class="k">if</span> <span class="n">representation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">,</span> <span class="s2">&quot;displacements&quot;</span><span class="p">]:</span>
</span><span id="DataFormat-69"><a href="#DataFormat-69"><span class="linenos">69</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid format&quot;</span><span class="p">)</span>
</span><span id="DataFormat-70"><a href="#DataFormat-70"><span class="linenos">70</span></a>        <span class="k">if</span> <span class="n">coordinate_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;world&quot;</span><span class="p">,</span> <span class="s2">&quot;voxel&quot;</span><span class="p">]:</span>
</span><span id="DataFormat-71"><a href="#DataFormat-71"><span class="linenos">71</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid coordinate type&quot;</span><span class="p">)</span>
</span><span id="DataFormat-72"><a href="#DataFormat-72"><span class="linenos">72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">representation</span> <span class="o">=</span> <span class="n">representation</span>
</span><span id="DataFormat-73"><a href="#DataFormat-73"><span class="linenos">73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_type</span> <span class="o">=</span> <span class="n">coordinate_type</span>
</span><span id="DataFormat-74"><a href="#DataFormat-74"><span class="linenos">74</span></a>
</span><span id="DataFormat-75"><a href="#DataFormat-75"><span class="linenos">75</span></a>    <span class="nd">@classmethod</span>
</span><span id="DataFormat-76"><a href="#DataFormat-76"><span class="linenos">76</span></a>    <span class="k">def</span> <span class="nf">voxel_displacements</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DataFormat&quot;</span><span class="p">:</span>
</span><span id="DataFormat-77"><a href="#DataFormat-77"><span class="linenos">77</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Voxel displacements data format.&quot;&quot;&quot;</span>
</span><span id="DataFormat-78"><a href="#DataFormat-78"><span class="linenos">78</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">representation</span><span class="o">=</span><span class="s2">&quot;displacements&quot;</span><span class="p">,</span> <span class="n">coordinate_type</span><span class="o">=</span><span class="s2">&quot;voxel&quot;</span><span class="p">)</span>
</span><span id="DataFormat-79"><a href="#DataFormat-79"><span class="linenos">79</span></a>
</span><span id="DataFormat-80"><a href="#DataFormat-80"><span class="linenos">80</span></a>    <span class="nd">@classmethod</span>
</span><span id="DataFormat-81"><a href="#DataFormat-81"><span class="linenos">81</span></a>    <span class="k">def</span> <span class="nf">world_displacements</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DataFormat&quot;</span><span class="p">:</span>
</span><span id="DataFormat-82"><a href="#DataFormat-82"><span class="linenos">82</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;World displacements data format.&quot;&quot;&quot;</span>
</span><span id="DataFormat-83"><a href="#DataFormat-83"><span class="linenos">83</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">representation</span><span class="o">=</span><span class="s2">&quot;displacements&quot;</span><span class="p">,</span> <span class="n">coordinate_type</span><span class="o">=</span><span class="s2">&quot;world&quot;</span><span class="p">)</span>
</span><span id="DataFormat-84"><a href="#DataFormat-84"><span class="linenos">84</span></a>
</span><span id="DataFormat-85"><a href="#DataFormat-85"><span class="linenos">85</span></a>    <span class="nd">@classmethod</span>
</span><span id="DataFormat-86"><a href="#DataFormat-86"><span class="linenos">86</span></a>    <span class="k">def</span> <span class="nf">voxel_coordinates</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DataFormat&quot;</span><span class="p">:</span>
</span><span id="DataFormat-87"><a href="#DataFormat-87"><span class="linenos">87</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Voxel coordinates data format.&quot;&quot;&quot;</span>
</span><span id="DataFormat-88"><a href="#DataFormat-88"><span class="linenos">88</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">representation</span><span class="o">=</span><span class="s2">&quot;coordinates&quot;</span><span class="p">,</span> <span class="n">coordinate_type</span><span class="o">=</span><span class="s2">&quot;voxel&quot;</span><span class="p">)</span>
</span><span id="DataFormat-89"><a href="#DataFormat-89"><span class="linenos">89</span></a>
</span><span id="DataFormat-90"><a href="#DataFormat-90"><span class="linenos">90</span></a>    <span class="nd">@classmethod</span>
</span><span id="DataFormat-91"><a href="#DataFormat-91"><span class="linenos">91</span></a>    <span class="k">def</span> <span class="nf">world_coordinates</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DataFormat&quot;</span><span class="p">:</span>
</span><span id="DataFormat-92"><a href="#DataFormat-92"><span class="linenos">92</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;World coordinates data format.&quot;&quot;&quot;</span>
</span><span id="DataFormat-93"><a href="#DataFormat-93"><span class="linenos">93</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">representation</span><span class="o">=</span><span class="s2">&quot;coordinates&quot;</span><span class="p">,</span> <span class="n">coordinate_type</span><span class="o">=</span><span class="s2">&quot;world&quot;</span><span class="p">)</span>
</span><span id="DataFormat-94"><a href="#DataFormat-94"><span class="linenos">94</span></a>
</span><span id="DataFormat-95"><a href="#DataFormat-95"><span class="linenos">95</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="DataFormat-96"><a href="#DataFormat-96"><span class="linenos">96</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="DataFormat-97"><a href="#DataFormat-97"><span class="linenos">97</span></a>            <span class="sa">f</span><span class="s2">&quot;DataFormat(representation=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">representation</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="DataFormat-98"><a href="#DataFormat-98"><span class="linenos">98</span></a>            <span class="sa">f</span><span class="s2">&quot;coordinate_type=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_type</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="DataFormat-99"><a href="#DataFormat-99"><span class="linenos">99</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Defines data format for sampled volumes.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>representation:</strong>  Representation of the data. Can be one of "coordinates"
or "displacements".</li>
<li><strong>coordinate_type:</strong>  Type of the coordinates. Can be one of "world" or
"voxel".</li>
</ul>
</div>


                            <div id="DataFormat.__init__" class="classattr">
                                        <input id="DataFormat.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">DataFormat</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">representation</span><span class="p">:</span> <span class="nb">str</span>, </span><span class="param"><span class="n">coordinate_type</span><span class="p">:</span> <span class="nb">str</span></span>)</span>

                <label class="view-source-button" for="DataFormat.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DataFormat.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DataFormat.__init__-67"><a href="#DataFormat.__init__-67"><span class="linenos">67</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">representation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">coordinate_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DataFormat.__init__-68"><a href="#DataFormat.__init__-68"><span class="linenos">68</span></a>        <span class="k">if</span> <span class="n">representation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">,</span> <span class="s2">&quot;displacements&quot;</span><span class="p">]:</span>
</span><span id="DataFormat.__init__-69"><a href="#DataFormat.__init__-69"><span class="linenos">69</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid format&quot;</span><span class="p">)</span>
</span><span id="DataFormat.__init__-70"><a href="#DataFormat.__init__-70"><span class="linenos">70</span></a>        <span class="k">if</span> <span class="n">coordinate_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;world&quot;</span><span class="p">,</span> <span class="s2">&quot;voxel&quot;</span><span class="p">]:</span>
</span><span id="DataFormat.__init__-71"><a href="#DataFormat.__init__-71"><span class="linenos">71</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid coordinate type&quot;</span><span class="p">)</span>
</span><span id="DataFormat.__init__-72"><a href="#DataFormat.__init__-72"><span class="linenos">72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">representation</span> <span class="o">=</span> <span class="n">representation</span>
</span><span id="DataFormat.__init__-73"><a href="#DataFormat.__init__-73"><span class="linenos">73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_type</span> <span class="o">=</span> <span class="n">coordinate_type</span>
</span></pre></div>


    

                            </div>
                            <div id="DataFormat.representation" class="classattr">
                                <div class="attr variable">
            <span class="name">representation</span>

        
    </div>
    <a class="headerlink" href="#DataFormat.representation"></a>
    
    

                            </div>
                            <div id="DataFormat.coordinate_type" class="classattr">
                                <div class="attr variable">
            <span class="name">coordinate_type</span>

        
    </div>
    <a class="headerlink" href="#DataFormat.coordinate_type"></a>
    
    

                            </div>
                            <div id="DataFormat.voxel_displacements" class="classattr">
                                        <input id="DataFormat.voxel_displacements-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">voxel_displacements</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span></span><span class="return-annotation">) -> <span class="n"><a href="#DataFormat">DataFormat</a></span>:</span></span>

                <label class="view-source-button" for="DataFormat.voxel_displacements-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DataFormat.voxel_displacements"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DataFormat.voxel_displacements-75"><a href="#DataFormat.voxel_displacements-75"><span class="linenos">75</span></a>    <span class="nd">@classmethod</span>
</span><span id="DataFormat.voxel_displacements-76"><a href="#DataFormat.voxel_displacements-76"><span class="linenos">76</span></a>    <span class="k">def</span> <span class="nf">voxel_displacements</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DataFormat&quot;</span><span class="p">:</span>
</span><span id="DataFormat.voxel_displacements-77"><a href="#DataFormat.voxel_displacements-77"><span class="linenos">77</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Voxel displacements data format.&quot;&quot;&quot;</span>
</span><span id="DataFormat.voxel_displacements-78"><a href="#DataFormat.voxel_displacements-78"><span class="linenos">78</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">representation</span><span class="o">=</span><span class="s2">&quot;displacements&quot;</span><span class="p">,</span> <span class="n">coordinate_type</span><span class="o">=</span><span class="s2">&quot;voxel&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Voxel displacements data format.</p>
</div>


                            </div>
                            <div id="DataFormat.world_displacements" class="classattr">
                                        <input id="DataFormat.world_displacements-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">world_displacements</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span></span><span class="return-annotation">) -> <span class="n"><a href="#DataFormat">DataFormat</a></span>:</span></span>

                <label class="view-source-button" for="DataFormat.world_displacements-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DataFormat.world_displacements"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DataFormat.world_displacements-80"><a href="#DataFormat.world_displacements-80"><span class="linenos">80</span></a>    <span class="nd">@classmethod</span>
</span><span id="DataFormat.world_displacements-81"><a href="#DataFormat.world_displacements-81"><span class="linenos">81</span></a>    <span class="k">def</span> <span class="nf">world_displacements</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DataFormat&quot;</span><span class="p">:</span>
</span><span id="DataFormat.world_displacements-82"><a href="#DataFormat.world_displacements-82"><span class="linenos">82</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;World displacements data format.&quot;&quot;&quot;</span>
</span><span id="DataFormat.world_displacements-83"><a href="#DataFormat.world_displacements-83"><span class="linenos">83</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">representation</span><span class="o">=</span><span class="s2">&quot;displacements&quot;</span><span class="p">,</span> <span class="n">coordinate_type</span><span class="o">=</span><span class="s2">&quot;world&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>World displacements data format.</p>
</div>


                            </div>
                            <div id="DataFormat.voxel_coordinates" class="classattr">
                                        <input id="DataFormat.voxel_coordinates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">voxel_coordinates</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span></span><span class="return-annotation">) -> <span class="n"><a href="#DataFormat">DataFormat</a></span>:</span></span>

                <label class="view-source-button" for="DataFormat.voxel_coordinates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DataFormat.voxel_coordinates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DataFormat.voxel_coordinates-85"><a href="#DataFormat.voxel_coordinates-85"><span class="linenos">85</span></a>    <span class="nd">@classmethod</span>
</span><span id="DataFormat.voxel_coordinates-86"><a href="#DataFormat.voxel_coordinates-86"><span class="linenos">86</span></a>    <span class="k">def</span> <span class="nf">voxel_coordinates</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DataFormat&quot;</span><span class="p">:</span>
</span><span id="DataFormat.voxel_coordinates-87"><a href="#DataFormat.voxel_coordinates-87"><span class="linenos">87</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Voxel coordinates data format.&quot;&quot;&quot;</span>
</span><span id="DataFormat.voxel_coordinates-88"><a href="#DataFormat.voxel_coordinates-88"><span class="linenos">88</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">representation</span><span class="o">=</span><span class="s2">&quot;coordinates&quot;</span><span class="p">,</span> <span class="n">coordinate_type</span><span class="o">=</span><span class="s2">&quot;voxel&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Voxel coordinates data format.</p>
</div>


                            </div>
                            <div id="DataFormat.world_coordinates" class="classattr">
                                        <input id="DataFormat.world_coordinates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">world_coordinates</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span></span><span class="return-annotation">) -> <span class="n"><a href="#DataFormat">DataFormat</a></span>:</span></span>

                <label class="view-source-button" for="DataFormat.world_coordinates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DataFormat.world_coordinates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DataFormat.world_coordinates-90"><a href="#DataFormat.world_coordinates-90"><span class="linenos">90</span></a>    <span class="nd">@classmethod</span>
</span><span id="DataFormat.world_coordinates-91"><a href="#DataFormat.world_coordinates-91"><span class="linenos">91</span></a>    <span class="k">def</span> <span class="nf">world_coordinates</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DataFormat&quot;</span><span class="p">:</span>
</span><span id="DataFormat.world_coordinates-92"><a href="#DataFormat.world_coordinates-92"><span class="linenos">92</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;World coordinates data format.&quot;&quot;&quot;</span>
</span><span id="DataFormat.world_coordinates-93"><a href="#DataFormat.world_coordinates-93"><span class="linenos">93</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">representation</span><span class="o">=</span><span class="s2">&quot;coordinates&quot;</span><span class="p">,</span> <span class="n">coordinate_type</span><span class="o">=</span><span class="s2">&quot;world&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>World coordinates data format.</p>
</div>


                            </div>
                </section>
                <section id="GenericSeparableDerivativeSampler">
                            <input id="GenericSeparableDerivativeSampler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">GenericSeparableDerivativeSampler</span><wbr>(<span class="base"><a href="#BaseSeparableSampler">composable_mapping.BaseSeparableSampler</a></span>):

                <label class="view-source-button" for="GenericSeparableDerivativeSampler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GenericSeparableDerivativeSampler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GenericSeparableDerivativeSampler-677"><a href="#GenericSeparableDerivativeSampler-677"><span class="linenos">677</span></a><span class="k">class</span> <span class="nc">GenericSeparableDerivativeSampler</span><span class="p">(</span><span class="n">BaseSeparableSampler</span><span class="p">):</span>
</span><span id="GenericSeparableDerivativeSampler-678"><a href="#GenericSeparableDerivativeSampler-678"><span class="linenos">678</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Sampler for sampling spatial derivatives of a separable kernel</span>
</span><span id="GenericSeparableDerivativeSampler-679"><a href="#GenericSeparableDerivativeSampler-679"><span class="linenos">679</span></a><span class="sd">    sampler.</span>
</span><span id="GenericSeparableDerivativeSampler-680"><a href="#GenericSeparableDerivativeSampler-680"><span class="linenos">680</span></a>
</span><span id="GenericSeparableDerivativeSampler-681"><a href="#GenericSeparableDerivativeSampler-681"><span class="linenos">681</span></a><span class="sd">    Args:</span>
</span><span id="GenericSeparableDerivativeSampler-682"><a href="#GenericSeparableDerivativeSampler-682"><span class="linenos">682</span></a><span class="sd">        spatial_dim: Spatial dimension over which the derivative is taken.</span>
</span><span id="GenericSeparableDerivativeSampler-683"><a href="#GenericSeparableDerivativeSampler-683"><span class="linenos">683</span></a><span class="sd">        parent_left_limit_kernel: Parent sampler&#39;s left limit kernel function.</span>
</span><span id="GenericSeparableDerivativeSampler-684"><a href="#GenericSeparableDerivativeSampler-684"><span class="linenos">684</span></a><span class="sd">        parent_right_limit_kernel: Parent sampler&#39;s right limit kernel function.</span>
</span><span id="GenericSeparableDerivativeSampler-685"><a href="#GenericSeparableDerivativeSampler-685"><span class="linenos">685</span></a><span class="sd">        parent_kernel_support: Parent sampler&#39;s kernel support function.</span>
</span><span id="GenericSeparableDerivativeSampler-686"><a href="#GenericSeparableDerivativeSampler-686"><span class="linenos">686</span></a><span class="sd">        parent_is_interpolating_kernel: Parent sampler&#39;s information on whether the kernel</span>
</span><span id="GenericSeparableDerivativeSampler-687"><a href="#GenericSeparableDerivativeSampler-687"><span class="linenos">687</span></a><span class="sd">            is interpolating.</span>
</span><span id="GenericSeparableDerivativeSampler-688"><a href="#GenericSeparableDerivativeSampler-688"><span class="linenos">688</span></a><span class="sd">        limit_direction: Direction for evaluating the kernel at discontinuous points.</span>
</span><span id="GenericSeparableDerivativeSampler-689"><a href="#GenericSeparableDerivativeSampler-689"><span class="linenos">689</span></a><span class="sd">        extrapolation_mode: Extrapolation mode for out-of-bound coordinates.</span>
</span><span id="GenericSeparableDerivativeSampler-690"><a href="#GenericSeparableDerivativeSampler-690"><span class="linenos">690</span></a><span class="sd">        mask_extrapolated_regions_for_empty_volume_mask: Whether to mask</span>
</span><span id="GenericSeparableDerivativeSampler-691"><a href="#GenericSeparableDerivativeSampler-691"><span class="linenos">691</span></a><span class="sd">            extrapolated regions when input volume mask is empty.</span>
</span><span id="GenericSeparableDerivativeSampler-692"><a href="#GenericSeparableDerivativeSampler-692"><span class="linenos">692</span></a><span class="sd">        convolution_threshold: Maximum allowed difference in coordinates</span>
</span><span id="GenericSeparableDerivativeSampler-693"><a href="#GenericSeparableDerivativeSampler-693"><span class="linenos">693</span></a><span class="sd">            for using convolution-based sampling.</span>
</span><span id="GenericSeparableDerivativeSampler-694"><a href="#GenericSeparableDerivativeSampler-694"><span class="linenos">694</span></a><span class="sd">        mask_threshold: Maximum allowed weight for masked regions in a</span>
</span><span id="GenericSeparableDerivativeSampler-695"><a href="#GenericSeparableDerivativeSampler-695"><span class="linenos">695</span></a><span class="sd">            sampled location to still consider it valid (non-masked).</span>
</span><span id="GenericSeparableDerivativeSampler-696"><a href="#GenericSeparableDerivativeSampler-696"><span class="linenos">696</span></a>
</span><span id="GenericSeparableDerivativeSampler-697"><a href="#GenericSeparableDerivativeSampler-697"><span class="linenos">697</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="GenericSeparableDerivativeSampler-698"><a href="#GenericSeparableDerivativeSampler-698"><span class="linenos">698</span></a>
</span><span id="GenericSeparableDerivativeSampler-699"><a href="#GenericSeparableDerivativeSampler-699"><span class="linenos">699</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler-700"><a href="#GenericSeparableDerivativeSampler-700"><span class="linenos">700</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-701"><a href="#GenericSeparableDerivativeSampler-701"><span class="linenos">701</span></a>        <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-702"><a href="#GenericSeparableDerivativeSampler-702"><span class="linenos">702</span></a>        <span class="n">parent_left_limit_kernel</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="GenericSeparableDerivativeSampler-703"><a href="#GenericSeparableDerivativeSampler-703"><span class="linenos">703</span></a>        <span class="n">parent_right_limit_kernel</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="GenericSeparableDerivativeSampler-704"><a href="#GenericSeparableDerivativeSampler-704"><span class="linenos">704</span></a>        <span class="n">parent_kernel_support</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">ISeparableKernelSupport</span><span class="p">],</span>
</span><span id="GenericSeparableDerivativeSampler-705"><a href="#GenericSeparableDerivativeSampler-705"><span class="linenos">705</span></a>        <span class="n">parent_is_interpolating_kernel</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span>
</span><span id="GenericSeparableDerivativeSampler-706"><a href="#GenericSeparableDerivativeSampler-706"><span class="linenos">706</span></a>        <span class="n">limit_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">LimitDirection</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">LimitDirection</span><span class="p">]],</span>
</span><span id="GenericSeparableDerivativeSampler-707"><a href="#GenericSeparableDerivativeSampler-707"><span class="linenos">707</span></a>        <span class="n">extrapolation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;border&quot;</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-708"><a href="#GenericSeparableDerivativeSampler-708"><span class="linenos">708</span></a>        <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-709"><a href="#GenericSeparableDerivativeSampler-709"><span class="linenos">709</span></a>        <span class="n">convolution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-710"><a href="#GenericSeparableDerivativeSampler-710"><span class="linenos">710</span></a>        <span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-711"><a href="#GenericSeparableDerivativeSampler-711"><span class="linenos">711</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler-712"><a href="#GenericSeparableDerivativeSampler-712"><span class="linenos">712</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler-713"><a href="#GenericSeparableDerivativeSampler-713"><span class="linenos">713</span></a>            <span class="n">extrapolation_mode</span><span class="o">=</span><span class="n">extrapolation_mode</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-714"><a href="#GenericSeparableDerivativeSampler-714"><span class="linenos">714</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="o">=</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler-715"><a href="#GenericSeparableDerivativeSampler-715"><span class="linenos">715</span></a>                <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="GenericSeparableDerivativeSampler-716"><a href="#GenericSeparableDerivativeSampler-716"><span class="linenos">716</span></a>            <span class="p">),</span>
</span><span id="GenericSeparableDerivativeSampler-717"><a href="#GenericSeparableDerivativeSampler-717"><span class="linenos">717</span></a>            <span class="n">convolution_threshold</span><span class="o">=</span><span class="n">convolution_threshold</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-718"><a href="#GenericSeparableDerivativeSampler-718"><span class="linenos">718</span></a>            <span class="n">mask_threshold</span><span class="o">=</span><span class="n">mask_threshold</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-719"><a href="#GenericSeparableDerivativeSampler-719"><span class="linenos">719</span></a>            <span class="n">limit_direction</span><span class="o">=</span><span class="n">limit_direction</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-720"><a href="#GenericSeparableDerivativeSampler-720"><span class="linenos">720</span></a>        <span class="p">)</span>
</span><span id="GenericSeparableDerivativeSampler-721"><a href="#GenericSeparableDerivativeSampler-721"><span class="linenos">721</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_dim</span> <span class="o">=</span> <span class="n">spatial_dim</span>
</span><span id="GenericSeparableDerivativeSampler-722"><a href="#GenericSeparableDerivativeSampler-722"><span class="linenos">722</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_left_limit_kernel</span> <span class="o">=</span> <span class="n">parent_left_limit_kernel</span>
</span><span id="GenericSeparableDerivativeSampler-723"><a href="#GenericSeparableDerivativeSampler-723"><span class="linenos">723</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_right_limit_kernel</span> <span class="o">=</span> <span class="n">parent_right_limit_kernel</span>
</span><span id="GenericSeparableDerivativeSampler-724"><a href="#GenericSeparableDerivativeSampler-724"><span class="linenos">724</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_is_interpolating_kernel</span> <span class="o">=</span> <span class="n">parent_is_interpolating_kernel</span>
</span><span id="GenericSeparableDerivativeSampler-725"><a href="#GenericSeparableDerivativeSampler-725"><span class="linenos">725</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_kernel_support</span> <span class="o">=</span> <span class="n">parent_kernel_support</span>
</span><span id="GenericSeparableDerivativeSampler-726"><a href="#GenericSeparableDerivativeSampler-726"><span class="linenos">726</span></a>
</span><span id="GenericSeparableDerivativeSampler-727"><a href="#GenericSeparableDerivativeSampler-727"><span class="linenos">727</span></a>    <span class="k">def</span> <span class="nf">_kernel_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ISeparableKernelSupport</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler-728"><a href="#GenericSeparableDerivativeSampler-728"><span class="linenos">728</span></a>        <span class="k">if</span> <span class="n">spatial_dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_dim</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler-729"><a href="#GenericSeparableDerivativeSampler-729"><span class="linenos">729</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_kernel_support</span><span class="p">(</span><span class="n">spatial_dim</span><span class="p">)</span><span class="o">.</span><span class="n">derivative</span><span class="p">()</span>
</span><span id="GenericSeparableDerivativeSampler-730"><a href="#GenericSeparableDerivativeSampler-730"><span class="linenos">730</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_kernel_support</span><span class="p">(</span><span class="n">spatial_dim</span><span class="p">)</span>
</span><span id="GenericSeparableDerivativeSampler-731"><a href="#GenericSeparableDerivativeSampler-731"><span class="linenos">731</span></a>
</span><span id="GenericSeparableDerivativeSampler-732"><a href="#GenericSeparableDerivativeSampler-732"><span class="linenos">732</span></a>    <span class="k">def</span> <span class="nf">derivative</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler-733"><a href="#GenericSeparableDerivativeSampler-733"><span class="linenos">733</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-734"><a href="#GenericSeparableDerivativeSampler-734"><span class="linenos">734</span></a>        <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-735"><a href="#GenericSeparableDerivativeSampler-735"><span class="linenos">735</span></a>        <span class="n">limit_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="GenericSeparableDerivativeSampler-736"><a href="#GenericSeparableDerivativeSampler-736"><span class="linenos">736</span></a>            <span class="n">LimitDirection</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">LimitDirection</span><span class="p">]</span>
</span><span id="GenericSeparableDerivativeSampler-737"><a href="#GenericSeparableDerivativeSampler-737"><span class="linenos">737</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">LimitDirection</span><span class="o">.</span><span class="n">average</span><span class="p">(),</span>
</span><span id="GenericSeparableDerivativeSampler-738"><a href="#GenericSeparableDerivativeSampler-738"><span class="linenos">738</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GenericSeparableDerivativeSampler&quot;</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler-739"><a href="#GenericSeparableDerivativeSampler-739"><span class="linenos">739</span></a>        <span class="k">return</span> <span class="n">GenericSeparableDerivativeSampler</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler-740"><a href="#GenericSeparableDerivativeSampler-740"><span class="linenos">740</span></a>            <span class="n">spatial_dim</span><span class="o">=</span><span class="n">spatial_dim</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-741"><a href="#GenericSeparableDerivativeSampler-741"><span class="linenos">741</span></a>            <span class="n">parent_left_limit_kernel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_left_limit_kernel</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-742"><a href="#GenericSeparableDerivativeSampler-742"><span class="linenos">742</span></a>            <span class="n">parent_right_limit_kernel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_right_limit_kernel</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-743"><a href="#GenericSeparableDerivativeSampler-743"><span class="linenos">743</span></a>            <span class="n">parent_kernel_support</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel_support</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-744"><a href="#GenericSeparableDerivativeSampler-744"><span class="linenos">744</span></a>            <span class="n">parent_is_interpolating_kernel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_interpolating_kernel</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-745"><a href="#GenericSeparableDerivativeSampler-745"><span class="linenos">745</span></a>            <span class="n">limit_direction</span><span class="o">=</span><span class="n">limit_direction</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-746"><a href="#GenericSeparableDerivativeSampler-746"><span class="linenos">746</span></a>            <span class="n">extrapolation_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extrapolation_mode</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-747"><a href="#GenericSeparableDerivativeSampler-747"><span class="linenos">747</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="o">=</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler-748"><a href="#GenericSeparableDerivativeSampler-748"><span class="linenos">748</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="GenericSeparableDerivativeSampler-749"><a href="#GenericSeparableDerivativeSampler-749"><span class="linenos">749</span></a>            <span class="p">),</span>
</span><span id="GenericSeparableDerivativeSampler-750"><a href="#GenericSeparableDerivativeSampler-750"><span class="linenos">750</span></a>            <span class="n">convolution_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_convolution_threshold</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-751"><a href="#GenericSeparableDerivativeSampler-751"><span class="linenos">751</span></a>            <span class="n">mask_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-752"><a href="#GenericSeparableDerivativeSampler-752"><span class="linenos">752</span></a>        <span class="p">)</span>
</span><span id="GenericSeparableDerivativeSampler-753"><a href="#GenericSeparableDerivativeSampler-753"><span class="linenos">753</span></a>
</span><span id="GenericSeparableDerivativeSampler-754"><a href="#GenericSeparableDerivativeSampler-754"><span class="linenos">754</span></a>    <span class="k">def</span> <span class="nf">_is_interpolating_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler-755"><a href="#GenericSeparableDerivativeSampler-755"><span class="linenos">755</span></a>        <span class="k">if</span> <span class="n">spatial_dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_dim</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler-756"><a href="#GenericSeparableDerivativeSampler-756"><span class="linenos">756</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="GenericSeparableDerivativeSampler-757"><a href="#GenericSeparableDerivativeSampler-757"><span class="linenos">757</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_is_interpolating_kernel</span><span class="p">(</span><span class="n">spatial_dim</span><span class="p">)</span>
</span><span id="GenericSeparableDerivativeSampler-758"><a href="#GenericSeparableDerivativeSampler-758"><span class="linenos">758</span></a>
</span><span id="GenericSeparableDerivativeSampler-759"><a href="#GenericSeparableDerivativeSampler-759"><span class="linenos">759</span></a>    <span class="k">def</span> <span class="nf">_derive_function</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler-760"><a href="#GenericSeparableDerivativeSampler-760"><span class="linenos">760</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-761"><a href="#GenericSeparableDerivativeSampler-761"><span class="linenos">761</span></a>        <span class="n">kernel_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="GenericSeparableDerivativeSampler-762"><a href="#GenericSeparableDerivativeSampler-762"><span class="linenos">762</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-763"><a href="#GenericSeparableDerivativeSampler-763"><span class="linenos">763</span></a>        <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-764"><a href="#GenericSeparableDerivativeSampler-764"><span class="linenos">764</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler-765"><a href="#GenericSeparableDerivativeSampler-765"><span class="linenos">765</span></a>        <span class="k">def</span> <span class="nf">partial_kernel_function</span><span class="p">(</span><span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler-766"><a href="#GenericSeparableDerivativeSampler-766"><span class="linenos">766</span></a>            <span class="k">return</span> <span class="o">-</span><span class="n">kernel_function</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">)</span>
</span><span id="GenericSeparableDerivativeSampler-767"><a href="#GenericSeparableDerivativeSampler-767"><span class="linenos">767</span></a>
</span><span id="GenericSeparableDerivativeSampler-768"><a href="#GenericSeparableDerivativeSampler-768"><span class="linenos">768</span></a>        <span class="n">_output</span><span class="p">,</span> <span class="n">derivatives</span> <span class="o">=</span> <span class="n">vjp</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler-769"><a href="#GenericSeparableDerivativeSampler-769"><span class="linenos">769</span></a>            <span class="n">partial_kernel_function</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-770"><a href="#GenericSeparableDerivativeSampler-770"><span class="linenos">770</span></a>            <span class="n">inputs</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-771"><a href="#GenericSeparableDerivativeSampler-771"><span class="linenos">771</span></a>            <span class="n">v</span><span class="o">=</span><span class="n">ones</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">coordinates</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">coordinates</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="GenericSeparableDerivativeSampler-772"><a href="#GenericSeparableDerivativeSampler-772"><span class="linenos">772</span></a>            <span class="n">create_graph</span><span class="o">=</span><span class="n">coordinates</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-773"><a href="#GenericSeparableDerivativeSampler-773"><span class="linenos">773</span></a>        <span class="p">)</span>
</span><span id="GenericSeparableDerivativeSampler-774"><a href="#GenericSeparableDerivativeSampler-774"><span class="linenos">774</span></a>        <span class="k">return</span> <span class="n">derivatives</span>
</span><span id="GenericSeparableDerivativeSampler-775"><a href="#GenericSeparableDerivativeSampler-775"><span class="linenos">775</span></a>
</span><span id="GenericSeparableDerivativeSampler-776"><a href="#GenericSeparableDerivativeSampler-776"><span class="linenos">776</span></a>    <span class="k">def</span> <span class="nf">_kernel_derivative</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler-777"><a href="#GenericSeparableDerivativeSampler-777"><span class="linenos">777</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-778"><a href="#GenericSeparableDerivativeSampler-778"><span class="linenos">778</span></a>        <span class="n">kernel_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="GenericSeparableDerivativeSampler-779"><a href="#GenericSeparableDerivativeSampler-779"><span class="linenos">779</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-780"><a href="#GenericSeparableDerivativeSampler-780"><span class="linenos">780</span></a>        <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-781"><a href="#GenericSeparableDerivativeSampler-781"><span class="linenos">781</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler-782"><a href="#GenericSeparableDerivativeSampler-782"><span class="linenos">782</span></a>        <span class="k">if</span> <span class="n">spatial_dim</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_dim</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler-783"><a href="#GenericSeparableDerivativeSampler-783"><span class="linenos">783</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derive_function</span><span class="p">(</span><span class="n">kernel_function</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">)</span>
</span><span id="GenericSeparableDerivativeSampler-784"><a href="#GenericSeparableDerivativeSampler-784"><span class="linenos">784</span></a>        <span class="k">return</span> <span class="n">kernel_function</span><span class="p">(</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">)</span>
</span><span id="GenericSeparableDerivativeSampler-785"><a href="#GenericSeparableDerivativeSampler-785"><span class="linenos">785</span></a>
</span><span id="GenericSeparableDerivativeSampler-786"><a href="#GenericSeparableDerivativeSampler-786"><span class="linenos">786</span></a>    <span class="k">def</span> <span class="nf">_left_limit_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler-787"><a href="#GenericSeparableDerivativeSampler-787"><span class="linenos">787</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_derivative</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler-788"><a href="#GenericSeparableDerivativeSampler-788"><span class="linenos">788</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_left_limit_kernel</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="o">=</span><span class="n">spatial_dim</span>
</span><span id="GenericSeparableDerivativeSampler-789"><a href="#GenericSeparableDerivativeSampler-789"><span class="linenos">789</span></a>        <span class="p">)</span>
</span><span id="GenericSeparableDerivativeSampler-790"><a href="#GenericSeparableDerivativeSampler-790"><span class="linenos">790</span></a>
</span><span id="GenericSeparableDerivativeSampler-791"><a href="#GenericSeparableDerivativeSampler-791"><span class="linenos">791</span></a>    <span class="k">def</span> <span class="nf">_right_limit_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler-792"><a href="#GenericSeparableDerivativeSampler-792"><span class="linenos">792</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kernel_derivative</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler-793"><a href="#GenericSeparableDerivativeSampler-793"><span class="linenos">793</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_right_limit_kernel</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="o">=</span><span class="n">spatial_dim</span>
</span><span id="GenericSeparableDerivativeSampler-794"><a href="#GenericSeparableDerivativeSampler-794"><span class="linenos">794</span></a>        <span class="p">)</span>
</span><span id="GenericSeparableDerivativeSampler-795"><a href="#GenericSeparableDerivativeSampler-795"><span class="linenos">795</span></a>
</span><span id="GenericSeparableDerivativeSampler-796"><a href="#GenericSeparableDerivativeSampler-796"><span class="linenos">796</span></a>    <span class="k">def</span> <span class="nf">sample_values</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler-797"><a href="#GenericSeparableDerivativeSampler-797"><span class="linenos">797</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-798"><a href="#GenericSeparableDerivativeSampler-798"><span class="linenos">798</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-799"><a href="#GenericSeparableDerivativeSampler-799"><span class="linenos">799</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-800"><a href="#GenericSeparableDerivativeSampler-800"><span class="linenos">800</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler-801"><a href="#GenericSeparableDerivativeSampler-801"><span class="linenos">801</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler-802"><a href="#GenericSeparableDerivativeSampler-802"><span class="linenos">802</span></a>            <span class="s2">&quot;Sampling derivatives at arbitrary coordinates is not currently implemented. &quot;</span>
</span><span id="GenericSeparableDerivativeSampler-803"><a href="#GenericSeparableDerivativeSampler-803"><span class="linenos">803</span></a>            <span class="s2">&quot;Contact the developers if you would like this to be included. Currently only &quot;</span>
</span><span id="GenericSeparableDerivativeSampler-804"><a href="#GenericSeparableDerivativeSampler-804"><span class="linenos">804</span></a>            <span class="s2">&quot;cases where the coordinates are on a regular grid with the axes &quot;</span>
</span><span id="GenericSeparableDerivativeSampler-805"><a href="#GenericSeparableDerivativeSampler-805"><span class="linenos">805</span></a>            <span class="s2">&quot;aligned with the spatial dimensions are supported (implementable with convolution).&quot;</span>
</span><span id="GenericSeparableDerivativeSampler-806"><a href="#GenericSeparableDerivativeSampler-806"><span class="linenos">806</span></a>        <span class="p">)</span>
</span><span id="GenericSeparableDerivativeSampler-807"><a href="#GenericSeparableDerivativeSampler-807"><span class="linenos">807</span></a>
</span><span id="GenericSeparableDerivativeSampler-808"><a href="#GenericSeparableDerivativeSampler-808"><span class="linenos">808</span></a>    <span class="k">def</span> <span class="nf">sample_mask</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler-809"><a href="#GenericSeparableDerivativeSampler-809"><span class="linenos">809</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-810"><a href="#GenericSeparableDerivativeSampler-810"><span class="linenos">810</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-811"><a href="#GenericSeparableDerivativeSampler-811"><span class="linenos">811</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler-812"><a href="#GenericSeparableDerivativeSampler-812"><span class="linenos">812</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler-813"><a href="#GenericSeparableDerivativeSampler-813"><span class="linenos">813</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler-814"><a href="#GenericSeparableDerivativeSampler-814"><span class="linenos">814</span></a>            <span class="s2">&quot;Sampling derivatives at arbitrary coordinates is not currently implemented. &quot;</span>
</span><span id="GenericSeparableDerivativeSampler-815"><a href="#GenericSeparableDerivativeSampler-815"><span class="linenos">815</span></a>            <span class="s2">&quot;Contact the developers if you would like this to be included. Currently only &quot;</span>
</span><span id="GenericSeparableDerivativeSampler-816"><a href="#GenericSeparableDerivativeSampler-816"><span class="linenos">816</span></a>            <span class="s2">&quot;cases where the coordinates are on a regular grid with the axes &quot;</span>
</span><span id="GenericSeparableDerivativeSampler-817"><a href="#GenericSeparableDerivativeSampler-817"><span class="linenos">817</span></a>            <span class="s2">&quot;aligned with the spatial dimensions are supported (implementable with convolution).&quot;</span>
</span><span id="GenericSeparableDerivativeSampler-818"><a href="#GenericSeparableDerivativeSampler-818"><span class="linenos">818</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sampler for sampling spatial derivatives of a separable kernel
sampler.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>spatial_dim:</strong>  Spatial dimension over which the derivative is taken.</li>
<li><strong>parent_left_limit_kernel:</strong>  Parent sampler's left limit kernel function.</li>
<li><strong>parent_right_limit_kernel:</strong>  Parent sampler's right limit kernel function.</li>
<li><strong>parent_kernel_support:</strong>  Parent sampler's kernel support function.</li>
<li><strong>parent_is_interpolating_kernel:</strong>  Parent sampler's information on whether the kernel
is interpolating.</li>
<li><strong>limit_direction:</strong>  Direction for evaluating the kernel at discontinuous points.</li>
<li><strong>extrapolation_mode:</strong>  Extrapolation mode for out-of-bound coordinates.</li>
<li><strong>mask_extrapolated_regions_for_empty_volume_mask:</strong>  Whether to mask
extrapolated regions when input volume mask is empty.</li>
<li><strong>convolution_threshold:</strong>  Maximum allowed difference in coordinates
for using convolution-based sampling.</li>
<li><strong>mask_threshold:</strong>  Maximum allowed weight for masked regions in a
sampled location to still consider it valid (non-masked).</li>
</ul>
</div>


                            <div id="GenericSeparableDerivativeSampler.__init__" class="classattr">
                                        <input id="GenericSeparableDerivativeSampler.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">GenericSeparableDerivativeSampler</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">parent_left_limit_kernel</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">parent_right_limit_kernel</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>,</span><span class="param">	<span class="n">parent_kernel_support</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">composable_mapping</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">ISeparableKernelSupport</span><span class="p">]</span>,</span><span class="param">	<span class="n">parent_is_interpolating_kernel</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span>,</span><span class="param">	<span class="n">limit_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#LimitDirection">LimitDirection</a></span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n"><a href="#LimitDirection">LimitDirection</a></span><span class="p">]]</span>,</span><span class="param">	<span class="n">extrapolation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;border&#39;</span>,</span><span class="param">	<span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">convolution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0001</span>,</span><span class="param">	<span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-05</span></span>)</span>

                <label class="view-source-button" for="GenericSeparableDerivativeSampler.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GenericSeparableDerivativeSampler.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GenericSeparableDerivativeSampler.__init__-699"><a href="#GenericSeparableDerivativeSampler.__init__-699"><span class="linenos">699</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-700"><a href="#GenericSeparableDerivativeSampler.__init__-700"><span class="linenos">700</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-701"><a href="#GenericSeparableDerivativeSampler.__init__-701"><span class="linenos">701</span></a>        <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-702"><a href="#GenericSeparableDerivativeSampler.__init__-702"><span class="linenos">702</span></a>        <span class="n">parent_left_limit_kernel</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-703"><a href="#GenericSeparableDerivativeSampler.__init__-703"><span class="linenos">703</span></a>        <span class="n">parent_right_limit_kernel</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Tensor</span><span class="p">],</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-704"><a href="#GenericSeparableDerivativeSampler.__init__-704"><span class="linenos">704</span></a>        <span class="n">parent_kernel_support</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">ISeparableKernelSupport</span><span class="p">],</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-705"><a href="#GenericSeparableDerivativeSampler.__init__-705"><span class="linenos">705</span></a>        <span class="n">parent_is_interpolating_kernel</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-706"><a href="#GenericSeparableDerivativeSampler.__init__-706"><span class="linenos">706</span></a>        <span class="n">limit_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">LimitDirection</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">LimitDirection</span><span class="p">]],</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-707"><a href="#GenericSeparableDerivativeSampler.__init__-707"><span class="linenos">707</span></a>        <span class="n">extrapolation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;border&quot;</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-708"><a href="#GenericSeparableDerivativeSampler.__init__-708"><span class="linenos">708</span></a>        <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-709"><a href="#GenericSeparableDerivativeSampler.__init__-709"><span class="linenos">709</span></a>        <span class="n">convolution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-710"><a href="#GenericSeparableDerivativeSampler.__init__-710"><span class="linenos">710</span></a>        <span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-711"><a href="#GenericSeparableDerivativeSampler.__init__-711"><span class="linenos">711</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-712"><a href="#GenericSeparableDerivativeSampler.__init__-712"><span class="linenos">712</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-713"><a href="#GenericSeparableDerivativeSampler.__init__-713"><span class="linenos">713</span></a>            <span class="n">extrapolation_mode</span><span class="o">=</span><span class="n">extrapolation_mode</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-714"><a href="#GenericSeparableDerivativeSampler.__init__-714"><span class="linenos">714</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="o">=</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-715"><a href="#GenericSeparableDerivativeSampler.__init__-715"><span class="linenos">715</span></a>                <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-716"><a href="#GenericSeparableDerivativeSampler.__init__-716"><span class="linenos">716</span></a>            <span class="p">),</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-717"><a href="#GenericSeparableDerivativeSampler.__init__-717"><span class="linenos">717</span></a>            <span class="n">convolution_threshold</span><span class="o">=</span><span class="n">convolution_threshold</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-718"><a href="#GenericSeparableDerivativeSampler.__init__-718"><span class="linenos">718</span></a>            <span class="n">mask_threshold</span><span class="o">=</span><span class="n">mask_threshold</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-719"><a href="#GenericSeparableDerivativeSampler.__init__-719"><span class="linenos">719</span></a>            <span class="n">limit_direction</span><span class="o">=</span><span class="n">limit_direction</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-720"><a href="#GenericSeparableDerivativeSampler.__init__-720"><span class="linenos">720</span></a>        <span class="p">)</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-721"><a href="#GenericSeparableDerivativeSampler.__init__-721"><span class="linenos">721</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_dim</span> <span class="o">=</span> <span class="n">spatial_dim</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-722"><a href="#GenericSeparableDerivativeSampler.__init__-722"><span class="linenos">722</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_left_limit_kernel</span> <span class="o">=</span> <span class="n">parent_left_limit_kernel</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-723"><a href="#GenericSeparableDerivativeSampler.__init__-723"><span class="linenos">723</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_right_limit_kernel</span> <span class="o">=</span> <span class="n">parent_right_limit_kernel</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-724"><a href="#GenericSeparableDerivativeSampler.__init__-724"><span class="linenos">724</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_is_interpolating_kernel</span> <span class="o">=</span> <span class="n">parent_is_interpolating_kernel</span>
</span><span id="GenericSeparableDerivativeSampler.__init__-725"><a href="#GenericSeparableDerivativeSampler.__init__-725"><span class="linenos">725</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_kernel_support</span> <span class="o">=</span> <span class="n">parent_kernel_support</span>
</span></pre></div>


    

                            </div>
                            <div id="GenericSeparableDerivativeSampler.derivative" class="classattr">
                                        <input id="GenericSeparableDerivativeSampler.derivative-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">derivative</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">limit_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#LimitDirection">LimitDirection</a></span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n"><a href="#LimitDirection">LimitDirection</a></span><span class="p">]]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n"><a href="#LimitDirection">LimitDirection</a></span> <span class="nb">object</span><span class="o">&gt;</span></span><span class="return-annotation">) -> <span class="n"><a href="#GenericSeparableDerivativeSampler">GenericSeparableDerivativeSampler</a></span>:</span></span>

                <label class="view-source-button" for="GenericSeparableDerivativeSampler.derivative-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GenericSeparableDerivativeSampler.derivative"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GenericSeparableDerivativeSampler.derivative-732"><a href="#GenericSeparableDerivativeSampler.derivative-732"><span class="linenos">732</span></a>    <span class="k">def</span> <span class="nf">derivative</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-733"><a href="#GenericSeparableDerivativeSampler.derivative-733"><span class="linenos">733</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-734"><a href="#GenericSeparableDerivativeSampler.derivative-734"><span class="linenos">734</span></a>        <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-735"><a href="#GenericSeparableDerivativeSampler.derivative-735"><span class="linenos">735</span></a>        <span class="n">limit_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-736"><a href="#GenericSeparableDerivativeSampler.derivative-736"><span class="linenos">736</span></a>            <span class="n">LimitDirection</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">LimitDirection</span><span class="p">]</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-737"><a href="#GenericSeparableDerivativeSampler.derivative-737"><span class="linenos">737</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">LimitDirection</span><span class="o">.</span><span class="n">average</span><span class="p">(),</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-738"><a href="#GenericSeparableDerivativeSampler.derivative-738"><span class="linenos">738</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GenericSeparableDerivativeSampler&quot;</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-739"><a href="#GenericSeparableDerivativeSampler.derivative-739"><span class="linenos">739</span></a>        <span class="k">return</span> <span class="n">GenericSeparableDerivativeSampler</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-740"><a href="#GenericSeparableDerivativeSampler.derivative-740"><span class="linenos">740</span></a>            <span class="n">spatial_dim</span><span class="o">=</span><span class="n">spatial_dim</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-741"><a href="#GenericSeparableDerivativeSampler.derivative-741"><span class="linenos">741</span></a>            <span class="n">parent_left_limit_kernel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_left_limit_kernel</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-742"><a href="#GenericSeparableDerivativeSampler.derivative-742"><span class="linenos">742</span></a>            <span class="n">parent_right_limit_kernel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_right_limit_kernel</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-743"><a href="#GenericSeparableDerivativeSampler.derivative-743"><span class="linenos">743</span></a>            <span class="n">parent_kernel_support</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_kernel_support</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-744"><a href="#GenericSeparableDerivativeSampler.derivative-744"><span class="linenos">744</span></a>            <span class="n">parent_is_interpolating_kernel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_interpolating_kernel</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-745"><a href="#GenericSeparableDerivativeSampler.derivative-745"><span class="linenos">745</span></a>            <span class="n">limit_direction</span><span class="o">=</span><span class="n">limit_direction</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-746"><a href="#GenericSeparableDerivativeSampler.derivative-746"><span class="linenos">746</span></a>            <span class="n">extrapolation_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extrapolation_mode</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-747"><a href="#GenericSeparableDerivativeSampler.derivative-747"><span class="linenos">747</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="o">=</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-748"><a href="#GenericSeparableDerivativeSampler.derivative-748"><span class="linenos">748</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-749"><a href="#GenericSeparableDerivativeSampler.derivative-749"><span class="linenos">749</span></a>            <span class="p">),</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-750"><a href="#GenericSeparableDerivativeSampler.derivative-750"><span class="linenos">750</span></a>            <span class="n">convolution_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_convolution_threshold</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-751"><a href="#GenericSeparableDerivativeSampler.derivative-751"><span class="linenos">751</span></a>            <span class="n">mask_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.derivative-752"><a href="#GenericSeparableDerivativeSampler.derivative-752"><span class="linenos">752</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Obtain sampler for sampling derivatives corresponding to the current sampler.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>spatial_dim:</strong>  Spatial dimension along which to compute the derivative.</li>
<li><strong>limit_direction:</strong>  Direction in which to compute the derivative.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Sampler for sampling derivatives.</p>
</blockquote>
</div>


                            </div>
                            <div id="GenericSeparableDerivativeSampler.sample_values" class="classattr">
                                        <input id="GenericSeparableDerivativeSampler.sample_values-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_values</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">volume</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>, </span><span class="param"><span class="n">coordinates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="GenericSeparableDerivativeSampler.sample_values-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GenericSeparableDerivativeSampler.sample_values"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GenericSeparableDerivativeSampler.sample_values-796"><a href="#GenericSeparableDerivativeSampler.sample_values-796"><span class="linenos">796</span></a>    <span class="k">def</span> <span class="nf">sample_values</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler.sample_values-797"><a href="#GenericSeparableDerivativeSampler.sample_values-797"><span class="linenos">797</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.sample_values-798"><a href="#GenericSeparableDerivativeSampler.sample_values-798"><span class="linenos">798</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.sample_values-799"><a href="#GenericSeparableDerivativeSampler.sample_values-799"><span class="linenos">799</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.sample_values-800"><a href="#GenericSeparableDerivativeSampler.sample_values-800"><span class="linenos">800</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler.sample_values-801"><a href="#GenericSeparableDerivativeSampler.sample_values-801"><span class="linenos">801</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler.sample_values-802"><a href="#GenericSeparableDerivativeSampler.sample_values-802"><span class="linenos">802</span></a>            <span class="s2">&quot;Sampling derivatives at arbitrary coordinates is not currently implemented. &quot;</span>
</span><span id="GenericSeparableDerivativeSampler.sample_values-803"><a href="#GenericSeparableDerivativeSampler.sample_values-803"><span class="linenos">803</span></a>            <span class="s2">&quot;Contact the developers if you would like this to be included. Currently only &quot;</span>
</span><span id="GenericSeparableDerivativeSampler.sample_values-804"><a href="#GenericSeparableDerivativeSampler.sample_values-804"><span class="linenos">804</span></a>            <span class="s2">&quot;cases where the coordinates are on a regular grid with the axes &quot;</span>
</span><span id="GenericSeparableDerivativeSampler.sample_values-805"><a href="#GenericSeparableDerivativeSampler.sample_values-805"><span class="linenos">805</span></a>            <span class="s2">&quot;aligned with the spatial dimensions are supported (implementable with convolution).&quot;</span>
</span><span id="GenericSeparableDerivativeSampler.sample_values-806"><a href="#GenericSeparableDerivativeSampler.sample_values-806"><span class="linenos">806</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sample values at spatial locations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>volume:</strong>  Volume to sample over spatial dimensions
with shape (*batch_shape, *channels_shape, *spatial_shape)</li>
<li><strong>coordinates:</strong>  Coordinates in voxel coordinates with shape
(*batch_shape, n_spatial_dims, *target_shape).</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Sampled values with shape (*batch_shape, *channels_shape, *target_shape).</p>
</blockquote>
</div>


                            </div>
                            <div id="GenericSeparableDerivativeSampler.sample_mask" class="classattr">
                                        <input id="GenericSeparableDerivativeSampler.sample_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_mask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>, </span><span class="param"><span class="n">coordinates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="GenericSeparableDerivativeSampler.sample_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GenericSeparableDerivativeSampler.sample_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GenericSeparableDerivativeSampler.sample_mask-808"><a href="#GenericSeparableDerivativeSampler.sample_mask-808"><span class="linenos">808</span></a>    <span class="k">def</span> <span class="nf">sample_mask</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler.sample_mask-809"><a href="#GenericSeparableDerivativeSampler.sample_mask-809"><span class="linenos">809</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.sample_mask-810"><a href="#GenericSeparableDerivativeSampler.sample_mask-810"><span class="linenos">810</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.sample_mask-811"><a href="#GenericSeparableDerivativeSampler.sample_mask-811"><span class="linenos">811</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="GenericSeparableDerivativeSampler.sample_mask-812"><a href="#GenericSeparableDerivativeSampler.sample_mask-812"><span class="linenos">812</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="GenericSeparableDerivativeSampler.sample_mask-813"><a href="#GenericSeparableDerivativeSampler.sample_mask-813"><span class="linenos">813</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="GenericSeparableDerivativeSampler.sample_mask-814"><a href="#GenericSeparableDerivativeSampler.sample_mask-814"><span class="linenos">814</span></a>            <span class="s2">&quot;Sampling derivatives at arbitrary coordinates is not currently implemented. &quot;</span>
</span><span id="GenericSeparableDerivativeSampler.sample_mask-815"><a href="#GenericSeparableDerivativeSampler.sample_mask-815"><span class="linenos">815</span></a>            <span class="s2">&quot;Contact the developers if you would like this to be included. Currently only &quot;</span>
</span><span id="GenericSeparableDerivativeSampler.sample_mask-816"><a href="#GenericSeparableDerivativeSampler.sample_mask-816"><span class="linenos">816</span></a>            <span class="s2">&quot;cases where the coordinates are on a regular grid with the axes &quot;</span>
</span><span id="GenericSeparableDerivativeSampler.sample_mask-817"><a href="#GenericSeparableDerivativeSampler.sample_mask-817"><span class="linenos">817</span></a>            <span class="s2">&quot;aligned with the spatial dimensions are supported (implementable with convolution).&quot;</span>
</span><span id="GenericSeparableDerivativeSampler.sample_mask-818"><a href="#GenericSeparableDerivativeSampler.sample_mask-818"><span class="linenos">818</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sample mask at spatial locations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mask:</strong>  Mask to sample over spatial dimensions
with shape (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</li>
<li><strong>coordinates:</strong>  Coordinates in voxel coordinates with shape
(*batch_shape, n_spatial_dims, *target_shape).</li>
</ul>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#BaseSeparableSampler">BaseSeparableSampler</a></dt>
                                <dd id="GenericSeparableDerivativeSampler.inverse" class="function"><a href="#BaseSeparableSampler.inverse">inverse</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="GridComposableMapping">
                            <input id="GridComposableMapping-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">GridComposableMapping</span><wbr>(<span class="base"><a href="#ComposableMapping">composable_mapping.ComposableMapping</a></span>, <span class="base">composable_mapping.composable_mapping.interface.ICoordinateSystemContainer</span>, <span class="base">abc.ABC</span>):

                <label class="view-source-button" for="GridComposableMapping-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GridComposableMapping"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GridComposableMapping-380"><a href="#GridComposableMapping-380"><span class="linenos">380</span></a><span class="k">class</span> <span class="nc">GridComposableMapping</span><span class="p">(</span><span class="n">ComposableMapping</span><span class="p">,</span> <span class="n">ICoordinateSystemContainer</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
</span><span id="GridComposableMapping-381"><a href="#GridComposableMapping-381"><span class="linenos">381</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for composable mappings with an assigned coordinate system.&quot;&quot;&quot;</span>
</span><span id="GridComposableMapping-382"><a href="#GridComposableMapping-382"><span class="linenos">382</span></a>
</span><span id="GridComposableMapping-383"><a href="#GridComposableMapping-383"><span class="linenos">383</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="GridComposableMapping-384"><a href="#GridComposableMapping-384"><span class="linenos">384</span></a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GridComposableMapping&quot;</span><span class="p">:</span>
</span><span id="GridComposableMapping-385"><a href="#GridComposableMapping-385"><span class="linenos">385</span></a>        <span class="k">pass</span>
</span><span id="GridComposableMapping-386"><a href="#GridComposableMapping-386"><span class="linenos">386</span></a>
</span><span id="GridComposableMapping-387"><a href="#GridComposableMapping-387"><span class="linenos">387</span></a>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span>
</span><span id="GridComposableMapping-388"><a href="#GridComposableMapping-388"><span class="linenos">388</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GridComposableMapping-389"><a href="#GridComposableMapping-389"><span class="linenos">389</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFormat</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GridComposableMapping-390"><a href="#GridComposableMapping-390"><span class="linenos">390</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="GridComposableMapping-391"><a href="#GridComposableMapping-391"><span class="linenos">391</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate the mapping at the coordinates contained by the mapping.</span>
</span><span id="GridComposableMapping-392"><a href="#GridComposableMapping-392"><span class="linenos">392</span></a>
</span><span id="GridComposableMapping-393"><a href="#GridComposableMapping-393"><span class="linenos">393</span></a><span class="sd">        Args:</span>
</span><span id="GridComposableMapping-394"><a href="#GridComposableMapping-394"><span class="linenos">394</span></a><span class="sd">            data_format: Data format of the output. Default data format depends</span>
</span><span id="GridComposableMapping-395"><a href="#GridComposableMapping-395"><span class="linenos">395</span></a><span class="sd">                on the mapping, but as a general rule is the same as the data</span>
</span><span id="GridComposableMapping-396"><a href="#GridComposableMapping-396"><span class="linenos">396</span></a><span class="sd">                format of the mapping being sampled, or the default data format</span>
</span><span id="GridComposableMapping-397"><a href="#GridComposableMapping-397"><span class="linenos">397</span></a><span class="sd">                of the left mapping in a composition or other operation. When no</span>
</span><span id="GridComposableMapping-398"><a href="#GridComposableMapping-398"><span class="linenos">398</span></a><span class="sd">                clear default data format is available,</span>
</span><span id="GridComposableMapping-399"><a href="#GridComposableMapping-399"><span class="linenos">399</span></a><span class="sd">                DataFormat.world_coordinates() is used. Default data format can</span>
</span><span id="GridComposableMapping-400"><a href="#GridComposableMapping-400"><span class="linenos">400</span></a><span class="sd">                be set for a mapping using `set_default_sampling_data_format`.</span>
</span><span id="GridComposableMapping-401"><a href="#GridComposableMapping-401"><span class="linenos">401</span></a>
</span><span id="GridComposableMapping-402"><a href="#GridComposableMapping-402"><span class="linenos">402</span></a><span class="sd">        Returns:</span>
</span><span id="GridComposableMapping-403"><a href="#GridComposableMapping-403"><span class="linenos">403</span></a><span class="sd">            Mappable tensor containing the values obtained by evaluating the</span>
</span><span id="GridComposableMapping-404"><a href="#GridComposableMapping-404"><span class="linenos">404</span></a><span class="sd">            mapping at the coordinates contained by the mapping.</span>
</span><span id="GridComposableMapping-405"><a href="#GridComposableMapping-405"><span class="linenos">405</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridComposableMapping-406"><a href="#GridComposableMapping-406"><span class="linenos">406</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">)</span>
</span><span id="GridComposableMapping-407"><a href="#GridComposableMapping-407"><span class="linenos">407</span></a>
</span><span id="GridComposableMapping-408"><a href="#GridComposableMapping-408"><span class="linenos">408</span></a>    <span class="k">def</span> <span class="nf">resample</span><span class="p">(</span>
</span><span id="GridComposableMapping-409"><a href="#GridComposableMapping-409"><span class="linenos">409</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GridComposableMapping-410"><a href="#GridComposableMapping-410"><span class="linenos">410</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFormat</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GridComposableMapping-411"><a href="#GridComposableMapping-411"><span class="linenos">411</span></a>        <span class="n">sampler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ISampler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GridComposableMapping-412"><a href="#GridComposableMapping-412"><span class="linenos">412</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SamplableVolume&quot;</span><span class="p">:</span>
</span><span id="GridComposableMapping-413"><a href="#GridComposableMapping-413"><span class="linenos">413</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Resample the mapping at the coordinates contained by the mapping.</span>
</span><span id="GridComposableMapping-414"><a href="#GridComposableMapping-414"><span class="linenos">414</span></a>
</span><span id="GridComposableMapping-415"><a href="#GridComposableMapping-415"><span class="linenos">415</span></a><span class="sd">        Args:</span>
</span><span id="GridComposableMapping-416"><a href="#GridComposableMapping-416"><span class="linenos">416</span></a><span class="sd">            data_format: Data format used as an internal representation of the</span>
</span><span id="GridComposableMapping-417"><a href="#GridComposableMapping-417"><span class="linenos">417</span></a><span class="sd">                generated resampled mapping. Default data format depends on the</span>
</span><span id="GridComposableMapping-418"><a href="#GridComposableMapping-418"><span class="linenos">418</span></a><span class="sd">                mapping, but as a general rule is the same as the data format of</span>
</span><span id="GridComposableMapping-419"><a href="#GridComposableMapping-419"><span class="linenos">419</span></a><span class="sd">                the mapping being sampled, or the default data format of the</span>
</span><span id="GridComposableMapping-420"><a href="#GridComposableMapping-420"><span class="linenos">420</span></a><span class="sd">                left mapping in a composition or other operation. When no clear</span>
</span><span id="GridComposableMapping-421"><a href="#GridComposableMapping-421"><span class="linenos">421</span></a><span class="sd">                default data format is available, DataFormat.world_coordinates()</span>
</span><span id="GridComposableMapping-422"><a href="#GridComposableMapping-422"><span class="linenos">422</span></a><span class="sd">                is used. Default data format can be set for a mapping using</span>
</span><span id="GridComposableMapping-423"><a href="#GridComposableMapping-423"><span class="linenos">423</span></a><span class="sd">                `set_default_sampling_data_format`.</span>
</span><span id="GridComposableMapping-424"><a href="#GridComposableMapping-424"><span class="linenos">424</span></a><span class="sd">            sampler: Sampler used by the generated resampled mapping. Note that</span>
</span><span id="GridComposableMapping-425"><a href="#GridComposableMapping-425"><span class="linenos">425</span></a><span class="sd">                this sampler is not used to resample the mapping, but to sample</span>
</span><span id="GridComposableMapping-426"><a href="#GridComposableMapping-426"><span class="linenos">426</span></a><span class="sd">                the generated resampled mapping. If None, the default sampler</span>
</span><span id="GridComposableMapping-427"><a href="#GridComposableMapping-427"><span class="linenos">427</span></a><span class="sd">                is used (see `default_sampler`).</span>
</span><span id="GridComposableMapping-428"><a href="#GridComposableMapping-428"><span class="linenos">428</span></a>
</span><span id="GridComposableMapping-429"><a href="#GridComposableMapping-429"><span class="linenos">429</span></a><span class="sd">        Returns:</span>
</span><span id="GridComposableMapping-430"><a href="#GridComposableMapping-430"><span class="linenos">430</span></a><span class="sd">            Resampled mapping.</span>
</span><span id="GridComposableMapping-431"><a href="#GridComposableMapping-431"><span class="linenos">431</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridComposableMapping-432"><a href="#GridComposableMapping-432"><span class="linenos">432</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resample_to</span><span class="p">(</span>
</span><span id="GridComposableMapping-433"><a href="#GridComposableMapping-433"><span class="linenos">433</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="GridComposableMapping-434"><a href="#GridComposableMapping-434"><span class="linenos">434</span></a>            <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">,</span>
</span><span id="GridComposableMapping-435"><a href="#GridComposableMapping-435"><span class="linenos">435</span></a>            <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span>
</span><span id="GridComposableMapping-436"><a href="#GridComposableMapping-436"><span class="linenos">436</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Base class for composable mappings with an assigned coordinate system.</p>
</div>


                            <div id="GridComposableMapping.invert" class="classattr">
                                        <input id="GridComposableMapping.invert-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">invert</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="o">**</span><span class="n">arguments</span></span><span class="return-annotation">) -> <span class="n"><a href="#GridComposableMapping">GridComposableMapping</a></span>:</span></span>

                <label class="view-source-button" for="GridComposableMapping.invert-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GridComposableMapping.invert"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GridComposableMapping.invert-383"><a href="#GridComposableMapping.invert-383"><span class="linenos">383</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="GridComposableMapping.invert-384"><a href="#GridComposableMapping.invert-384"><span class="linenos">384</span></a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;GridComposableMapping&quot;</span><span class="p">:</span>
</span><span id="GridComposableMapping.invert-385"><a href="#GridComposableMapping.invert-385"><span class="linenos">385</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Invert the mapping.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>arguments:</strong>  Arguments for the inversion.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>The inverted mapping.</p>
</blockquote>
</div>


                            </div>
                            <div id="GridComposableMapping.sample" class="classattr">
                                        <input id="GridComposableMapping.sample-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">data_format</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#DataFormat">DataFormat</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="GridComposableMapping.sample-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GridComposableMapping.sample"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GridComposableMapping.sample-387"><a href="#GridComposableMapping.sample-387"><span class="linenos">387</span></a>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span>
</span><span id="GridComposableMapping.sample-388"><a href="#GridComposableMapping.sample-388"><span class="linenos">388</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GridComposableMapping.sample-389"><a href="#GridComposableMapping.sample-389"><span class="linenos">389</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFormat</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GridComposableMapping.sample-390"><a href="#GridComposableMapping.sample-390"><span class="linenos">390</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="GridComposableMapping.sample-391"><a href="#GridComposableMapping.sample-391"><span class="linenos">391</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate the mapping at the coordinates contained by the mapping.</span>
</span><span id="GridComposableMapping.sample-392"><a href="#GridComposableMapping.sample-392"><span class="linenos">392</span></a>
</span><span id="GridComposableMapping.sample-393"><a href="#GridComposableMapping.sample-393"><span class="linenos">393</span></a><span class="sd">        Args:</span>
</span><span id="GridComposableMapping.sample-394"><a href="#GridComposableMapping.sample-394"><span class="linenos">394</span></a><span class="sd">            data_format: Data format of the output. Default data format depends</span>
</span><span id="GridComposableMapping.sample-395"><a href="#GridComposableMapping.sample-395"><span class="linenos">395</span></a><span class="sd">                on the mapping, but as a general rule is the same as the data</span>
</span><span id="GridComposableMapping.sample-396"><a href="#GridComposableMapping.sample-396"><span class="linenos">396</span></a><span class="sd">                format of the mapping being sampled, or the default data format</span>
</span><span id="GridComposableMapping.sample-397"><a href="#GridComposableMapping.sample-397"><span class="linenos">397</span></a><span class="sd">                of the left mapping in a composition or other operation. When no</span>
</span><span id="GridComposableMapping.sample-398"><a href="#GridComposableMapping.sample-398"><span class="linenos">398</span></a><span class="sd">                clear default data format is available,</span>
</span><span id="GridComposableMapping.sample-399"><a href="#GridComposableMapping.sample-399"><span class="linenos">399</span></a><span class="sd">                DataFormat.world_coordinates() is used. Default data format can</span>
</span><span id="GridComposableMapping.sample-400"><a href="#GridComposableMapping.sample-400"><span class="linenos">400</span></a><span class="sd">                be set for a mapping using `set_default_sampling_data_format`.</span>
</span><span id="GridComposableMapping.sample-401"><a href="#GridComposableMapping.sample-401"><span class="linenos">401</span></a>
</span><span id="GridComposableMapping.sample-402"><a href="#GridComposableMapping.sample-402"><span class="linenos">402</span></a><span class="sd">        Returns:</span>
</span><span id="GridComposableMapping.sample-403"><a href="#GridComposableMapping.sample-403"><span class="linenos">403</span></a><span class="sd">            Mappable tensor containing the values obtained by evaluating the</span>
</span><span id="GridComposableMapping.sample-404"><a href="#GridComposableMapping.sample-404"><span class="linenos">404</span></a><span class="sd">            mapping at the coordinates contained by the mapping.</span>
</span><span id="GridComposableMapping.sample-405"><a href="#GridComposableMapping.sample-405"><span class="linenos">405</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridComposableMapping.sample-406"><a href="#GridComposableMapping.sample-406"><span class="linenos">406</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Evaluate the mapping at the coordinates contained by the mapping.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>data_format:</strong>  Data format of the output. Default data format depends
on the mapping, but as a general rule is the same as the data
format of the mapping being sampled, or the default data format
of the left mapping in a composition or other operation. When no
clear default data format is available,
<a href="#DataFormat.world_coordinates">DataFormat.world_coordinates()</a> is used. Default data format can
be set for a mapping using <code><a href="#GridComposableMapping.set_default_sampling_data_format">set_default_sampling_data_format</a></code>.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Mappable tensor containing the values obtained by evaluating the
  mapping at the coordinates contained by the mapping.</p>
</blockquote>
</div>


                            </div>
                            <div id="GridComposableMapping.resample" class="classattr">
                                        <input id="GridComposableMapping.resample-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">resample</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">data_format</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#DataFormat">DataFormat</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">sampler</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#ISampler">ISampler</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#SamplableVolume">SamplableVolume</a></span>:</span></span>

                <label class="view-source-button" for="GridComposableMapping.resample-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GridComposableMapping.resample"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GridComposableMapping.resample-408"><a href="#GridComposableMapping.resample-408"><span class="linenos">408</span></a>    <span class="k">def</span> <span class="nf">resample</span><span class="p">(</span>
</span><span id="GridComposableMapping.resample-409"><a href="#GridComposableMapping.resample-409"><span class="linenos">409</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GridComposableMapping.resample-410"><a href="#GridComposableMapping.resample-410"><span class="linenos">410</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DataFormat</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GridComposableMapping.resample-411"><a href="#GridComposableMapping.resample-411"><span class="linenos">411</span></a>        <span class="n">sampler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ISampler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GridComposableMapping.resample-412"><a href="#GridComposableMapping.resample-412"><span class="linenos">412</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SamplableVolume&quot;</span><span class="p">:</span>
</span><span id="GridComposableMapping.resample-413"><a href="#GridComposableMapping.resample-413"><span class="linenos">413</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Resample the mapping at the coordinates contained by the mapping.</span>
</span><span id="GridComposableMapping.resample-414"><a href="#GridComposableMapping.resample-414"><span class="linenos">414</span></a>
</span><span id="GridComposableMapping.resample-415"><a href="#GridComposableMapping.resample-415"><span class="linenos">415</span></a><span class="sd">        Args:</span>
</span><span id="GridComposableMapping.resample-416"><a href="#GridComposableMapping.resample-416"><span class="linenos">416</span></a><span class="sd">            data_format: Data format used as an internal representation of the</span>
</span><span id="GridComposableMapping.resample-417"><a href="#GridComposableMapping.resample-417"><span class="linenos">417</span></a><span class="sd">                generated resampled mapping. Default data format depends on the</span>
</span><span id="GridComposableMapping.resample-418"><a href="#GridComposableMapping.resample-418"><span class="linenos">418</span></a><span class="sd">                mapping, but as a general rule is the same as the data format of</span>
</span><span id="GridComposableMapping.resample-419"><a href="#GridComposableMapping.resample-419"><span class="linenos">419</span></a><span class="sd">                the mapping being sampled, or the default data format of the</span>
</span><span id="GridComposableMapping.resample-420"><a href="#GridComposableMapping.resample-420"><span class="linenos">420</span></a><span class="sd">                left mapping in a composition or other operation. When no clear</span>
</span><span id="GridComposableMapping.resample-421"><a href="#GridComposableMapping.resample-421"><span class="linenos">421</span></a><span class="sd">                default data format is available, DataFormat.world_coordinates()</span>
</span><span id="GridComposableMapping.resample-422"><a href="#GridComposableMapping.resample-422"><span class="linenos">422</span></a><span class="sd">                is used. Default data format can be set for a mapping using</span>
</span><span id="GridComposableMapping.resample-423"><a href="#GridComposableMapping.resample-423"><span class="linenos">423</span></a><span class="sd">                `set_default_sampling_data_format`.</span>
</span><span id="GridComposableMapping.resample-424"><a href="#GridComposableMapping.resample-424"><span class="linenos">424</span></a><span class="sd">            sampler: Sampler used by the generated resampled mapping. Note that</span>
</span><span id="GridComposableMapping.resample-425"><a href="#GridComposableMapping.resample-425"><span class="linenos">425</span></a><span class="sd">                this sampler is not used to resample the mapping, but to sample</span>
</span><span id="GridComposableMapping.resample-426"><a href="#GridComposableMapping.resample-426"><span class="linenos">426</span></a><span class="sd">                the generated resampled mapping. If None, the default sampler</span>
</span><span id="GridComposableMapping.resample-427"><a href="#GridComposableMapping.resample-427"><span class="linenos">427</span></a><span class="sd">                is used (see `default_sampler`).</span>
</span><span id="GridComposableMapping.resample-428"><a href="#GridComposableMapping.resample-428"><span class="linenos">428</span></a>
</span><span id="GridComposableMapping.resample-429"><a href="#GridComposableMapping.resample-429"><span class="linenos">429</span></a><span class="sd">        Returns:</span>
</span><span id="GridComposableMapping.resample-430"><a href="#GridComposableMapping.resample-430"><span class="linenos">430</span></a><span class="sd">            Resampled mapping.</span>
</span><span id="GridComposableMapping.resample-431"><a href="#GridComposableMapping.resample-431"><span class="linenos">431</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridComposableMapping.resample-432"><a href="#GridComposableMapping.resample-432"><span class="linenos">432</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resample_to</span><span class="p">(</span>
</span><span id="GridComposableMapping.resample-433"><a href="#GridComposableMapping.resample-433"><span class="linenos">433</span></a>            <span class="bp">self</span><span class="p">,</span>
</span><span id="GridComposableMapping.resample-434"><a href="#GridComposableMapping.resample-434"><span class="linenos">434</span></a>            <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">,</span>
</span><span id="GridComposableMapping.resample-435"><a href="#GridComposableMapping.resample-435"><span class="linenos">435</span></a>            <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span>
</span><span id="GridComposableMapping.resample-436"><a href="#GridComposableMapping.resample-436"><span class="linenos">436</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Resample the mapping at the coordinates contained by the mapping.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>data_format:</strong>  Data format used as an internal representation of the
generated resampled mapping. Default data format depends on the
mapping, but as a general rule is the same as the data format of
the mapping being sampled, or the default data format of the
left mapping in a composition or other operation. When no clear
default data format is available, <a href="#DataFormat.world_coordinates">DataFormat.world_coordinates()</a>
is used. Default data format can be set for a mapping using
<code><a href="#GridComposableMapping.set_default_sampling_data_format">set_default_sampling_data_format</a></code>.</li>
<li><strong>sampler:</strong>  Sampler used by the generated resampled mapping. Note that
this sampler is not used to resample the mapping, but to sample
the generated resampled mapping. If None, the default sampler
is used (see <code><a href="#default_sampler">default_sampler</a></code>).</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Resampled mapping.</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#ComposableMapping">ComposableMapping</a></dt>
                                <dd id="GridComposableMapping.__call__" class="function"><a href="#ComposableMapping.__call__">__call__</a></dd>
                <dd id="GridComposableMapping.sample_to" class="function"><a href="#ComposableMapping.sample_to">sample_to</a></dd>
                <dd id="GridComposableMapping.resample_to" class="function"><a href="#ComposableMapping.resample_to">resample_to</a></dd>
                <dd id="GridComposableMapping.assign_coordinates" class="function"><a href="#ComposableMapping.assign_coordinates">assign_coordinates</a></dd>
                <dd id="GridComposableMapping.as_affine_transformation" class="function"><a href="#ComposableMapping.as_affine_transformation">as_affine_transformation</a></dd>
                <dd id="GridComposableMapping.as_affine_matrix" class="function"><a href="#ComposableMapping.as_affine_matrix">as_affine_matrix</a></dd>
                <dd id="GridComposableMapping.default_sampling_data_format" class="variable"><a href="#ComposableMapping.default_sampling_data_format">default_sampling_data_format</a></dd>
                <dd id="GridComposableMapping.set_default_sampling_data_format" class="function"><a href="#ComposableMapping.set_default_sampling_data_format">set_default_sampling_data_format</a></dd>
                <dd id="GridComposableMapping.__matmul__" class="function"><a href="#ComposableMapping.__matmul__">__matmul__</a></dd>

            </div>
            <div><dt><a href="#ITensorLike">ITensorLike</a></dt>
                                <dd id="GridComposableMapping.dtype" class="variable"><a href="#ITensorLike.dtype">dtype</a></dd>
                <dd id="GridComposableMapping.device" class="variable"><a href="#ITensorLike.device">device</a></dd>
                <dd id="GridComposableMapping.cast" class="function"><a href="#ITensorLike.cast">cast</a></dd>
                <dd id="GridComposableMapping.detach" class="function"><a href="#ITensorLike.detach">detach</a></dd>
                <dd id="GridComposableMapping.pin_memory" class="function"><a href="#ITensorLike.pin_memory">pin_memory</a></dd>

            </div>
            <div><dt>composable_mapping.composable_mapping.interface.ICoordinateSystemContainer</dt>
                                <dd id="GridComposableMapping.coordinate_system" class="variable">coordinate_system</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="GridVisualizationArguments">
                            <input id="GridVisualizationArguments-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">GridVisualizationArguments</span>:

                <label class="view-source-button" for="GridVisualizationArguments-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GridVisualizationArguments"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GridVisualizationArguments-85"><a href="#GridVisualizationArguments-85"><span class="linenos">85</span></a><span class="k">class</span> <span class="nc">GridVisualizationArguments</span><span class="p">:</span>
</span><span id="GridVisualizationArguments-86"><a href="#GridVisualizationArguments-86"><span class="linenos">86</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Arguments for grid visualization&quot;&quot;&quot;</span>
</span><span id="GridVisualizationArguments-87"><a href="#GridVisualizationArguments-87"><span class="linenos">87</span></a>
</span><span id="GridVisualizationArguments-88"><a href="#GridVisualizationArguments-88"><span class="linenos">88</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="GridVisualizationArguments-89"><a href="#GridVisualizationArguments-89"><span class="linenos">89</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GridVisualizationArguments-90"><a href="#GridVisualizationArguments-90"><span class="linenos">90</span></a>        <span class="n">batch_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="GridVisualizationArguments-91"><a href="#GridVisualizationArguments-91"><span class="linenos">91</span></a>        <span class="n">figure_height</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="GridVisualizationArguments-92"><a href="#GridVisualizationArguments-92"><span class="linenos">92</span></a>        <span class="n">emphasize_every_nth_line</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="GridVisualizationArguments-93"><a href="#GridVisualizationArguments-93"><span class="linenos">93</span></a>        <span class="n">plot_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GridVisualizationArguments-94"><a href="#GridVisualizationArguments-94"><span class="linenos">94</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GridVisualizationArguments-95"><a href="#GridVisualizationArguments-95"><span class="linenos">95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_index</span> <span class="o">=</span> <span class="n">batch_index</span>
</span><span id="GridVisualizationArguments-96"><a href="#GridVisualizationArguments-96"><span class="linenos">96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">figure_height</span> <span class="o">=</span> <span class="n">figure_height</span>
</span><span id="GridVisualizationArguments-97"><a href="#GridVisualizationArguments-97"><span class="linenos">97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">emphasize_every_nth_line</span> <span class="o">=</span> <span class="n">emphasize_every_nth_line</span>
</span><span id="GridVisualizationArguments-98"><a href="#GridVisualizationArguments-98"><span class="linenos">98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">plot_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">plot_kwargs</span>
</span></pre></div>


            <div class="docstring"><p>Arguments for grid visualization</p>
</div>


                            <div id="GridVisualizationArguments.__init__" class="classattr">
                                        <input id="GridVisualizationArguments.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">GridVisualizationArguments</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">batch_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">figure_height</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>,</span><span class="param">	<span class="n">emphasize_every_nth_line</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>,</span><span class="param">	<span class="n">plot_kwargs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="GridVisualizationArguments.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GridVisualizationArguments.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GridVisualizationArguments.__init__-88"><a href="#GridVisualizationArguments.__init__-88"><span class="linenos">88</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="GridVisualizationArguments.__init__-89"><a href="#GridVisualizationArguments.__init__-89"><span class="linenos">89</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GridVisualizationArguments.__init__-90"><a href="#GridVisualizationArguments.__init__-90"><span class="linenos">90</span></a>        <span class="n">batch_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="GridVisualizationArguments.__init__-91"><a href="#GridVisualizationArguments.__init__-91"><span class="linenos">91</span></a>        <span class="n">figure_height</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="GridVisualizationArguments.__init__-92"><a href="#GridVisualizationArguments.__init__-92"><span class="linenos">92</span></a>        <span class="n">emphasize_every_nth_line</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="GridVisualizationArguments.__init__-93"><a href="#GridVisualizationArguments.__init__-93"><span class="linenos">93</span></a>        <span class="n">plot_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GridVisualizationArguments.__init__-94"><a href="#GridVisualizationArguments.__init__-94"><span class="linenos">94</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GridVisualizationArguments.__init__-95"><a href="#GridVisualizationArguments.__init__-95"><span class="linenos">95</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_index</span> <span class="o">=</span> <span class="n">batch_index</span>
</span><span id="GridVisualizationArguments.__init__-96"><a href="#GridVisualizationArguments.__init__-96"><span class="linenos">96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">figure_height</span> <span class="o">=</span> <span class="n">figure_height</span>
</span><span id="GridVisualizationArguments.__init__-97"><a href="#GridVisualizationArguments.__init__-97"><span class="linenos">97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">emphasize_every_nth_line</span> <span class="o">=</span> <span class="n">emphasize_every_nth_line</span>
</span><span id="GridVisualizationArguments.__init__-98"><a href="#GridVisualizationArguments.__init__-98"><span class="linenos">98</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">plot_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">plot_kwargs</span>
</span></pre></div>


    

                            </div>
                            <div id="GridVisualizationArguments.batch_index" class="classattr">
                                <div class="attr variable">
            <span class="name">batch_index</span>

        
    </div>
    <a class="headerlink" href="#GridVisualizationArguments.batch_index"></a>
    
    

                            </div>
                            <div id="GridVisualizationArguments.figure_height" class="classattr">
                                <div class="attr variable">
            <span class="name">figure_height</span>

        
    </div>
    <a class="headerlink" href="#GridVisualizationArguments.figure_height"></a>
    
    

                            </div>
                            <div id="GridVisualizationArguments.emphasize_every_nth_line" class="classattr">
                                <div class="attr variable">
            <span class="name">emphasize_every_nth_line</span>

        
    </div>
    <a class="headerlink" href="#GridVisualizationArguments.emphasize_every_nth_line"></a>
    
    

                            </div>
                            <div id="GridVisualizationArguments.plot_kwargs" class="classattr">
                                <div class="attr variable">
            <span class="name">plot_kwargs</span>

        
    </div>
    <a class="headerlink" href="#GridVisualizationArguments.plot_kwargs"></a>
    
    

                            </div>
                </section>
                <section id="Identity">
                            <input id="Identity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Identity</span><wbr>(<span class="base">composable_mapping.tensor_like.BaseTensorLikeWrapper</span>, <span class="base"><a href="#ComposableMapping">composable_mapping.ComposableMapping</a></span>):

                <label class="view-source-button" for="Identity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Identity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Identity-526"><a href="#Identity-526"><span class="linenos">526</span></a><span class="k">class</span> <span class="nc">Identity</span><span class="p">(</span><span class="n">BaseTensorLikeWrapper</span><span class="p">,</span> <span class="n">ComposableMapping</span><span class="p">):</span>
</span><span id="Identity-527"><a href="#Identity-527"><span class="linenos">527</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Identity mapping.&quot;&quot;&quot;</span>
</span><span id="Identity-528"><a href="#Identity-528"><span class="linenos">528</span></a>
</span><span id="Identity-529"><a href="#Identity-529"><span class="linenos">529</span></a>    <span class="k">def</span> <span class="nf">_get_tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="Identity-530"><a href="#Identity-530"><span class="linenos">530</span></a>        <span class="k">return</span> <span class="p">{}</span>
</span><span id="Identity-531"><a href="#Identity-531"><span class="linenos">531</span></a>
</span><span id="Identity-532"><a href="#Identity-532"><span class="linenos">532</span></a>    <span class="k">def</span> <span class="nf">_get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]:</span>
</span><span id="Identity-533"><a href="#Identity-533"><span class="linenos">533</span></a>        <span class="k">return</span> <span class="p">{}</span>
</span><span id="Identity-534"><a href="#Identity-534"><span class="linenos">534</span></a>
</span><span id="Identity-535"><a href="#Identity-535"><span class="linenos">535</span></a>    <span class="k">def</span> <span class="nf">_modified_copy</span><span class="p">(</span>
</span><span id="Identity-536"><a href="#Identity-536"><span class="linenos">536</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">tensors</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">children</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]</span>
</span><span id="Identity-537"><a href="#Identity-537"><span class="linenos">537</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Identity&quot;</span><span class="p">:</span>
</span><span id="Identity-538"><a href="#Identity-538"><span class="linenos">538</span></a>        <span class="k">return</span> <span class="n">Identity</span><span class="p">()</span>
</span><span id="Identity-539"><a href="#Identity-539"><span class="linenos">539</span></a>
</span><span id="Identity-540"><a href="#Identity-540"><span class="linenos">540</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="Identity-541"><a href="#Identity-541"><span class="linenos">541</span></a>        <span class="k">return</span> <span class="n">coordinates</span>
</span><span id="Identity-542"><a href="#Identity-542"><span class="linenos">542</span></a>
</span><span id="Identity-543"><a href="#Identity-543"><span class="linenos">543</span></a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">_inversion_parameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Identity&quot;</span><span class="p">:</span>
</span><span id="Identity-544"><a href="#Identity-544"><span class="linenos">544</span></a>        <span class="k">return</span> <span class="n">Identity</span><span class="p">()</span>
</span><span id="Identity-545"><a href="#Identity-545"><span class="linenos">545</span></a>
</span><span id="Identity-546"><a href="#Identity-546"><span class="linenos">546</span></a>    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Identity&quot;</span><span class="p">:</span>
</span><span id="Identity-547"><a href="#Identity-547"><span class="linenos">547</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Identity-548"><a href="#Identity-548"><span class="linenos">548</span></a>
</span><span id="Identity-549"><a href="#Identity-549"><span class="linenos">549</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Identity-550"><a href="#Identity-550"><span class="linenos">550</span></a>        <span class="k">return</span> <span class="s2">&quot;Identity()&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Identity mapping.</p>
</div>


                            <div id="Identity.invert" class="classattr">
                                        <input id="Identity.invert-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">invert</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="o">**</span><span class="n">_inversion_parameters</span></span><span class="return-annotation">) -> <span class="n"><a href="#Identity">Identity</a></span>:</span></span>

                <label class="view-source-button" for="Identity.invert-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Identity.invert"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Identity.invert-543"><a href="#Identity.invert-543"><span class="linenos">543</span></a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">_inversion_parameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Identity&quot;</span><span class="p">:</span>
</span><span id="Identity.invert-544"><a href="#Identity.invert-544"><span class="linenos">544</span></a>        <span class="k">return</span> <span class="n">Identity</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Invert the mapping.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>arguments:</strong>  Arguments for the inversion.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>The inverted mapping.</p>
</blockquote>
</div>


                            </div>
                            <div id="Identity.detach" class="classattr">
                                        <input id="Identity.detach-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">detach</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="n"><a href="#Identity">Identity</a></span>:</span></span>

                <label class="view-source-button" for="Identity.detach-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Identity.detach"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Identity.detach-546"><a href="#Identity.detach-546"><span class="linenos">546</span></a>    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Identity&quot;</span><span class="p">:</span>
</span><span id="Identity.detach-547"><a href="#Identity.detach-547"><span class="linenos">547</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Detach the wrapped tensors from computational graph</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>composable_mapping.tensor_like.BaseTensorLikeWrapper</dt>
                                <dd id="Identity.dtype" class="variable">dtype</dd>
                <dd id="Identity.device" class="variable">device</dd>
                <dd id="Identity.cast" class="function">cast</dd>
                <dd id="Identity.pin_memory" class="function">pin_memory</dd>

            </div>
            <div><dt><a href="#ComposableMapping">ComposableMapping</a></dt>
                                <dd id="Identity.sample_to" class="function"><a href="#ComposableMapping.sample_to">sample_to</a></dd>
                <dd id="Identity.resample_to" class="function"><a href="#ComposableMapping.resample_to">resample_to</a></dd>
                <dd id="Identity.assign_coordinates" class="function"><a href="#ComposableMapping.assign_coordinates">assign_coordinates</a></dd>
                <dd id="Identity.as_affine_transformation" class="function"><a href="#ComposableMapping.as_affine_transformation">as_affine_transformation</a></dd>
                <dd id="Identity.as_affine_matrix" class="function"><a href="#ComposableMapping.as_affine_matrix">as_affine_matrix</a></dd>
                <dd id="Identity.default_sampling_data_format" class="variable"><a href="#ComposableMapping.default_sampling_data_format">default_sampling_data_format</a></dd>
                <dd id="Identity.set_default_sampling_data_format" class="function"><a href="#ComposableMapping.set_default_sampling_data_format">set_default_sampling_data_format</a></dd>
                <dd id="Identity.__matmul__" class="function"><a href="#ComposableMapping.__matmul__">__matmul__</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ISampler">
                            <input id="ISampler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ISampler</span><wbr>(<span class="base">abc.ABC</span>):

                <label class="view-source-button" for="ISampler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ISampler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ISampler-102"><a href="#ISampler-102"><span class="linenos">102</span></a><span class="k">class</span> <span class="nc">ISampler</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="ISampler-103"><a href="#ISampler-103"><span class="linenos">103</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Samples values on regular grid in voxel coordinates.&quot;&quot;&quot;</span>
</span><span id="ISampler-104"><a href="#ISampler-104"><span class="linenos">104</span></a>
</span><span id="ISampler-105"><a href="#ISampler-105"><span class="linenos">105</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ISampler-106"><a href="#ISampler-106"><span class="linenos">106</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="ISampler-107"><a href="#ISampler-107"><span class="linenos">107</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample the volume at coordinates.</span>
</span><span id="ISampler-108"><a href="#ISampler-108"><span class="linenos">108</span></a>
</span><span id="ISampler-109"><a href="#ISampler-109"><span class="linenos">109</span></a><span class="sd">        Args:</span>
</span><span id="ISampler-110"><a href="#ISampler-110"><span class="linenos">110</span></a><span class="sd">            volume: Volume to be sampled over spatial dimensions.</span>
</span><span id="ISampler-111"><a href="#ISampler-111"><span class="linenos">111</span></a><span class="sd">            coordinates: Coordinates in voxel coordinates.</span>
</span><span id="ISampler-112"><a href="#ISampler-112"><span class="linenos">112</span></a>
</span><span id="ISampler-113"><a href="#ISampler-113"><span class="linenos">113</span></a><span class="sd">        Returns:</span>
</span><span id="ISampler-114"><a href="#ISampler-114"><span class="linenos">114</span></a><span class="sd">            Sampled volume.</span>
</span><span id="ISampler-115"><a href="#ISampler-115"><span class="linenos">115</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ISampler-116"><a href="#ISampler-116"><span class="linenos">116</span></a>
</span><span id="ISampler-117"><a href="#ISampler-117"><span class="linenos">117</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ISampler-118"><a href="#ISampler-118"><span class="linenos">118</span></a>    <span class="k">def</span> <span class="nf">derivative</span><span class="p">(</span>
</span><span id="ISampler-119"><a href="#ISampler-119"><span class="linenos">119</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ISampler-120"><a href="#ISampler-120"><span class="linenos">120</span></a>        <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="ISampler-121"><a href="#ISampler-121"><span class="linenos">121</span></a>        <span class="n">limit_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="ISampler-122"><a href="#ISampler-122"><span class="linenos">122</span></a>            <span class="n">LimitDirection</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">LimitDirection</span><span class="p">]</span>
</span><span id="ISampler-123"><a href="#ISampler-123"><span class="linenos">123</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">LimitDirection</span><span class="o">.</span><span class="n">average</span><span class="p">(),</span>
</span><span id="ISampler-124"><a href="#ISampler-124"><span class="linenos">124</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ISampler&quot;</span><span class="p">:</span>
</span><span id="ISampler-125"><a href="#ISampler-125"><span class="linenos">125</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain sampler for sampling derivatives corresponding to the current sampler.</span>
</span><span id="ISampler-126"><a href="#ISampler-126"><span class="linenos">126</span></a>
</span><span id="ISampler-127"><a href="#ISampler-127"><span class="linenos">127</span></a><span class="sd">        Args:</span>
</span><span id="ISampler-128"><a href="#ISampler-128"><span class="linenos">128</span></a><span class="sd">            spatial_dim: Spatial dimension along which to compute the derivative.</span>
</span><span id="ISampler-129"><a href="#ISampler-129"><span class="linenos">129</span></a><span class="sd">            limit_direction: Direction in which to compute the derivative.</span>
</span><span id="ISampler-130"><a href="#ISampler-130"><span class="linenos">130</span></a>
</span><span id="ISampler-131"><a href="#ISampler-131"><span class="linenos">131</span></a><span class="sd">        Returns:</span>
</span><span id="ISampler-132"><a href="#ISampler-132"><span class="linenos">132</span></a><span class="sd">            Sampler for sampling derivatives.</span>
</span><span id="ISampler-133"><a href="#ISampler-133"><span class="linenos">133</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ISampler-134"><a href="#ISampler-134"><span class="linenos">134</span></a>
</span><span id="ISampler-135"><a href="#ISampler-135"><span class="linenos">135</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ISampler-136"><a href="#ISampler-136"><span class="linenos">136</span></a>    <span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span>
</span><span id="ISampler-137"><a href="#ISampler-137"><span class="linenos">137</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ISampler-138"><a href="#ISampler-138"><span class="linenos">138</span></a>        <span class="n">coordinate_system</span><span class="p">:</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">,</span>
</span><span id="ISampler-139"><a href="#ISampler-139"><span class="linenos">139</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">DataFormat</span><span class="p">,</span>
</span><span id="ISampler-140"><a href="#ISampler-140"><span class="linenos">140</span></a>        <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ISampler-141"><a href="#ISampler-141"><span class="linenos">141</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ISampler&quot;</span><span class="p">:</span>
</span><span id="ISampler-142"><a href="#ISampler-142"><span class="linenos">142</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain sampler for sampling inverse values corresponding to the</span>
</span><span id="ISampler-143"><a href="#ISampler-143"><span class="linenos">143</span></a><span class="sd">        current sampler, if available.</span>
</span><span id="ISampler-144"><a href="#ISampler-144"><span class="linenos">144</span></a>
</span><span id="ISampler-145"><a href="#ISampler-145"><span class="linenos">145</span></a><span class="sd">        Args:</span>
</span><span id="ISampler-146"><a href="#ISampler-146"><span class="linenos">146</span></a><span class="sd">            coordinate_system: Coordinate system of the mapping.</span>
</span><span id="ISampler-147"><a href="#ISampler-147"><span class="linenos">147</span></a><span class="sd">            data_format: Data format of the sampled volume.</span>
</span><span id="ISampler-148"><a href="#ISampler-148"><span class="linenos">148</span></a><span class="sd">            arguments: Additional arguments for the inverse.</span>
</span><span id="ISampler-149"><a href="#ISampler-149"><span class="linenos">149</span></a>
</span><span id="ISampler-150"><a href="#ISampler-150"><span class="linenos">150</span></a><span class="sd">        Returns:</span>
</span><span id="ISampler-151"><a href="#ISampler-151"><span class="linenos">151</span></a><span class="sd">            Sampler for sampling inverse values.</span>
</span><span id="ISampler-152"><a href="#ISampler-152"><span class="linenos">152</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ISampler-153"><a href="#ISampler-153"><span class="linenos">153</span></a>
</span><span id="ISampler-154"><a href="#ISampler-154"><span class="linenos">154</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ISampler-155"><a href="#ISampler-155"><span class="linenos">155</span></a>    <span class="k">def</span> <span class="nf">sample_values</span><span class="p">(</span>
</span><span id="ISampler-156"><a href="#ISampler-156"><span class="linenos">156</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ISampler-157"><a href="#ISampler-157"><span class="linenos">157</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="ISampler-158"><a href="#ISampler-158"><span class="linenos">158</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="ISampler-159"><a href="#ISampler-159"><span class="linenos">159</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="ISampler-160"><a href="#ISampler-160"><span class="linenos">160</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample values at spatial locations.</span>
</span><span id="ISampler-161"><a href="#ISampler-161"><span class="linenos">161</span></a>
</span><span id="ISampler-162"><a href="#ISampler-162"><span class="linenos">162</span></a><span class="sd">        Args:</span>
</span><span id="ISampler-163"><a href="#ISampler-163"><span class="linenos">163</span></a><span class="sd">            volume: Volume to sample over spatial dimensions</span>
</span><span id="ISampler-164"><a href="#ISampler-164"><span class="linenos">164</span></a><span class="sd">                with shape (*batch_shape, *channels_shape, *spatial_shape)</span>
</span><span id="ISampler-165"><a href="#ISampler-165"><span class="linenos">165</span></a><span class="sd">            coordinates: Coordinates in voxel coordinates with shape</span>
</span><span id="ISampler-166"><a href="#ISampler-166"><span class="linenos">166</span></a><span class="sd">                (*batch_shape, n_spatial_dims, *target_shape).</span>
</span><span id="ISampler-167"><a href="#ISampler-167"><span class="linenos">167</span></a>
</span><span id="ISampler-168"><a href="#ISampler-168"><span class="linenos">168</span></a><span class="sd">        Returns:</span>
</span><span id="ISampler-169"><a href="#ISampler-169"><span class="linenos">169</span></a><span class="sd">            Sampled values with shape (*batch_shape, *channels_shape, *target_shape).</span>
</span><span id="ISampler-170"><a href="#ISampler-170"><span class="linenos">170</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ISampler-171"><a href="#ISampler-171"><span class="linenos">171</span></a>
</span><span id="ISampler-172"><a href="#ISampler-172"><span class="linenos">172</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ISampler-173"><a href="#ISampler-173"><span class="linenos">173</span></a>    <span class="k">def</span> <span class="nf">sample_mask</span><span class="p">(</span>
</span><span id="ISampler-174"><a href="#ISampler-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ISampler-175"><a href="#ISampler-175"><span class="linenos">175</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="ISampler-176"><a href="#ISampler-176"><span class="linenos">176</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="ISampler-177"><a href="#ISampler-177"><span class="linenos">177</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="ISampler-178"><a href="#ISampler-178"><span class="linenos">178</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample mask at spatial locations.</span>
</span><span id="ISampler-179"><a href="#ISampler-179"><span class="linenos">179</span></a>
</span><span id="ISampler-180"><a href="#ISampler-180"><span class="linenos">180</span></a><span class="sd">        Args:</span>
</span><span id="ISampler-181"><a href="#ISampler-181"><span class="linenos">181</span></a><span class="sd">            mask: Mask to sample over spatial dimensions</span>
</span><span id="ISampler-182"><a href="#ISampler-182"><span class="linenos">182</span></a><span class="sd">                with shape (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</span>
</span><span id="ISampler-183"><a href="#ISampler-183"><span class="linenos">183</span></a><span class="sd">            coordinates: Coordinates in voxel coordinates with shape</span>
</span><span id="ISampler-184"><a href="#ISampler-184"><span class="linenos">184</span></a><span class="sd">                (*batch_shape, n_spatial_dims, *target_shape).</span>
</span><span id="ISampler-185"><a href="#ISampler-185"><span class="linenos">185</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Samples values on regular grid in voxel coordinates.</p>
</div>


                            <div id="ISampler.derivative" class="classattr">
                                        <input id="ISampler.derivative-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">derivative</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">limit_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#LimitDirection">LimitDirection</a></span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n"><a href="#LimitDirection">LimitDirection</a></span><span class="p">]]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n"><a href="#LimitDirection">LimitDirection</a></span> <span class="nb">object</span><span class="o">&gt;</span></span><span class="return-annotation">) -> <span class="n"><a href="#ISampler">ISampler</a></span>:</span></span>

                <label class="view-source-button" for="ISampler.derivative-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ISampler.derivative"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ISampler.derivative-117"><a href="#ISampler.derivative-117"><span class="linenos">117</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ISampler.derivative-118"><a href="#ISampler.derivative-118"><span class="linenos">118</span></a>    <span class="k">def</span> <span class="nf">derivative</span><span class="p">(</span>
</span><span id="ISampler.derivative-119"><a href="#ISampler.derivative-119"><span class="linenos">119</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ISampler.derivative-120"><a href="#ISampler.derivative-120"><span class="linenos">120</span></a>        <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="ISampler.derivative-121"><a href="#ISampler.derivative-121"><span class="linenos">121</span></a>        <span class="n">limit_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="ISampler.derivative-122"><a href="#ISampler.derivative-122"><span class="linenos">122</span></a>            <span class="n">LimitDirection</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">LimitDirection</span><span class="p">]</span>
</span><span id="ISampler.derivative-123"><a href="#ISampler.derivative-123"><span class="linenos">123</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">LimitDirection</span><span class="o">.</span><span class="n">average</span><span class="p">(),</span>
</span><span id="ISampler.derivative-124"><a href="#ISampler.derivative-124"><span class="linenos">124</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ISampler&quot;</span><span class="p">:</span>
</span><span id="ISampler.derivative-125"><a href="#ISampler.derivative-125"><span class="linenos">125</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain sampler for sampling derivatives corresponding to the current sampler.</span>
</span><span id="ISampler.derivative-126"><a href="#ISampler.derivative-126"><span class="linenos">126</span></a>
</span><span id="ISampler.derivative-127"><a href="#ISampler.derivative-127"><span class="linenos">127</span></a><span class="sd">        Args:</span>
</span><span id="ISampler.derivative-128"><a href="#ISampler.derivative-128"><span class="linenos">128</span></a><span class="sd">            spatial_dim: Spatial dimension along which to compute the derivative.</span>
</span><span id="ISampler.derivative-129"><a href="#ISampler.derivative-129"><span class="linenos">129</span></a><span class="sd">            limit_direction: Direction in which to compute the derivative.</span>
</span><span id="ISampler.derivative-130"><a href="#ISampler.derivative-130"><span class="linenos">130</span></a>
</span><span id="ISampler.derivative-131"><a href="#ISampler.derivative-131"><span class="linenos">131</span></a><span class="sd">        Returns:</span>
</span><span id="ISampler.derivative-132"><a href="#ISampler.derivative-132"><span class="linenos">132</span></a><span class="sd">            Sampler for sampling derivatives.</span>
</span><span id="ISampler.derivative-133"><a href="#ISampler.derivative-133"><span class="linenos">133</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Obtain sampler for sampling derivatives corresponding to the current sampler.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>spatial_dim:</strong>  Spatial dimension along which to compute the derivative.</li>
<li><strong>limit_direction:</strong>  Direction in which to compute the derivative.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Sampler for sampling derivatives.</p>
</blockquote>
</div>


                            </div>
                            <div id="ISampler.inverse" class="classattr">
                                        <input id="ISampler.inverse-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">inverse</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">coordinate_system</span><span class="p">:</span> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>,</span><span class="param">	<span class="n">data_format</span><span class="p">:</span> <span class="n"><a href="#DataFormat">DataFormat</a></span>,</span><span class="param">	<span class="n">arguments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#ISampler">ISampler</a></span>:</span></span>

                <label class="view-source-button" for="ISampler.inverse-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ISampler.inverse"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ISampler.inverse-135"><a href="#ISampler.inverse-135"><span class="linenos">135</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ISampler.inverse-136"><a href="#ISampler.inverse-136"><span class="linenos">136</span></a>    <span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span>
</span><span id="ISampler.inverse-137"><a href="#ISampler.inverse-137"><span class="linenos">137</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ISampler.inverse-138"><a href="#ISampler.inverse-138"><span class="linenos">138</span></a>        <span class="n">coordinate_system</span><span class="p">:</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">,</span>
</span><span id="ISampler.inverse-139"><a href="#ISampler.inverse-139"><span class="linenos">139</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">DataFormat</span><span class="p">,</span>
</span><span id="ISampler.inverse-140"><a href="#ISampler.inverse-140"><span class="linenos">140</span></a>        <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ISampler.inverse-141"><a href="#ISampler.inverse-141"><span class="linenos">141</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ISampler&quot;</span><span class="p">:</span>
</span><span id="ISampler.inverse-142"><a href="#ISampler.inverse-142"><span class="linenos">142</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain sampler for sampling inverse values corresponding to the</span>
</span><span id="ISampler.inverse-143"><a href="#ISampler.inverse-143"><span class="linenos">143</span></a><span class="sd">        current sampler, if available.</span>
</span><span id="ISampler.inverse-144"><a href="#ISampler.inverse-144"><span class="linenos">144</span></a>
</span><span id="ISampler.inverse-145"><a href="#ISampler.inverse-145"><span class="linenos">145</span></a><span class="sd">        Args:</span>
</span><span id="ISampler.inverse-146"><a href="#ISampler.inverse-146"><span class="linenos">146</span></a><span class="sd">            coordinate_system: Coordinate system of the mapping.</span>
</span><span id="ISampler.inverse-147"><a href="#ISampler.inverse-147"><span class="linenos">147</span></a><span class="sd">            data_format: Data format of the sampled volume.</span>
</span><span id="ISampler.inverse-148"><a href="#ISampler.inverse-148"><span class="linenos">148</span></a><span class="sd">            arguments: Additional arguments for the inverse.</span>
</span><span id="ISampler.inverse-149"><a href="#ISampler.inverse-149"><span class="linenos">149</span></a>
</span><span id="ISampler.inverse-150"><a href="#ISampler.inverse-150"><span class="linenos">150</span></a><span class="sd">        Returns:</span>
</span><span id="ISampler.inverse-151"><a href="#ISampler.inverse-151"><span class="linenos">151</span></a><span class="sd">            Sampler for sampling inverse values.</span>
</span><span id="ISampler.inverse-152"><a href="#ISampler.inverse-152"><span class="linenos">152</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Obtain sampler for sampling inverse values corresponding to the
current sampler, if available.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>coordinate_system:</strong>  Coordinate system of the mapping.</li>
<li><strong>data_format:</strong>  Data format of the sampled volume.</li>
<li><strong>arguments:</strong>  Additional arguments for the inverse.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Sampler for sampling inverse values.</p>
</blockquote>
</div>


                            </div>
                            <div id="ISampler.sample_values" class="classattr">
                                        <input id="ISampler.sample_values-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">sample_values</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">volume</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>, </span><span class="param"><span class="n">coordinates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="ISampler.sample_values-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ISampler.sample_values"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ISampler.sample_values-154"><a href="#ISampler.sample_values-154"><span class="linenos">154</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ISampler.sample_values-155"><a href="#ISampler.sample_values-155"><span class="linenos">155</span></a>    <span class="k">def</span> <span class="nf">sample_values</span><span class="p">(</span>
</span><span id="ISampler.sample_values-156"><a href="#ISampler.sample_values-156"><span class="linenos">156</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ISampler.sample_values-157"><a href="#ISampler.sample_values-157"><span class="linenos">157</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="ISampler.sample_values-158"><a href="#ISampler.sample_values-158"><span class="linenos">158</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="ISampler.sample_values-159"><a href="#ISampler.sample_values-159"><span class="linenos">159</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="ISampler.sample_values-160"><a href="#ISampler.sample_values-160"><span class="linenos">160</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample values at spatial locations.</span>
</span><span id="ISampler.sample_values-161"><a href="#ISampler.sample_values-161"><span class="linenos">161</span></a>
</span><span id="ISampler.sample_values-162"><a href="#ISampler.sample_values-162"><span class="linenos">162</span></a><span class="sd">        Args:</span>
</span><span id="ISampler.sample_values-163"><a href="#ISampler.sample_values-163"><span class="linenos">163</span></a><span class="sd">            volume: Volume to sample over spatial dimensions</span>
</span><span id="ISampler.sample_values-164"><a href="#ISampler.sample_values-164"><span class="linenos">164</span></a><span class="sd">                with shape (*batch_shape, *channels_shape, *spatial_shape)</span>
</span><span id="ISampler.sample_values-165"><a href="#ISampler.sample_values-165"><span class="linenos">165</span></a><span class="sd">            coordinates: Coordinates in voxel coordinates with shape</span>
</span><span id="ISampler.sample_values-166"><a href="#ISampler.sample_values-166"><span class="linenos">166</span></a><span class="sd">                (*batch_shape, n_spatial_dims, *target_shape).</span>
</span><span id="ISampler.sample_values-167"><a href="#ISampler.sample_values-167"><span class="linenos">167</span></a>
</span><span id="ISampler.sample_values-168"><a href="#ISampler.sample_values-168"><span class="linenos">168</span></a><span class="sd">        Returns:</span>
</span><span id="ISampler.sample_values-169"><a href="#ISampler.sample_values-169"><span class="linenos">169</span></a><span class="sd">            Sampled values with shape (*batch_shape, *channels_shape, *target_shape).</span>
</span><span id="ISampler.sample_values-170"><a href="#ISampler.sample_values-170"><span class="linenos">170</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Sample values at spatial locations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>volume:</strong>  Volume to sample over spatial dimensions
with shape (*batch_shape, *channels_shape, *spatial_shape)</li>
<li><strong>coordinates:</strong>  Coordinates in voxel coordinates with shape
(*batch_shape, n_spatial_dims, *target_shape).</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Sampled values with shape (*batch_shape, *channels_shape, *target_shape).</p>
</blockquote>
</div>


                            </div>
                            <div id="ISampler.sample_mask" class="classattr">
                                        <input id="ISampler.sample_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">sample_mask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>, </span><span class="param"><span class="n">coordinates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="ISampler.sample_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ISampler.sample_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ISampler.sample_mask-172"><a href="#ISampler.sample_mask-172"><span class="linenos">172</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ISampler.sample_mask-173"><a href="#ISampler.sample_mask-173"><span class="linenos">173</span></a>    <span class="k">def</span> <span class="nf">sample_mask</span><span class="p">(</span>
</span><span id="ISampler.sample_mask-174"><a href="#ISampler.sample_mask-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ISampler.sample_mask-175"><a href="#ISampler.sample_mask-175"><span class="linenos">175</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="ISampler.sample_mask-176"><a href="#ISampler.sample_mask-176"><span class="linenos">176</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="ISampler.sample_mask-177"><a href="#ISampler.sample_mask-177"><span class="linenos">177</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="ISampler.sample_mask-178"><a href="#ISampler.sample_mask-178"><span class="linenos">178</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample mask at spatial locations.</span>
</span><span id="ISampler.sample_mask-179"><a href="#ISampler.sample_mask-179"><span class="linenos">179</span></a>
</span><span id="ISampler.sample_mask-180"><a href="#ISampler.sample_mask-180"><span class="linenos">180</span></a><span class="sd">        Args:</span>
</span><span id="ISampler.sample_mask-181"><a href="#ISampler.sample_mask-181"><span class="linenos">181</span></a><span class="sd">            mask: Mask to sample over spatial dimensions</span>
</span><span id="ISampler.sample_mask-182"><a href="#ISampler.sample_mask-182"><span class="linenos">182</span></a><span class="sd">                with shape (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</span>
</span><span id="ISampler.sample_mask-183"><a href="#ISampler.sample_mask-183"><span class="linenos">183</span></a><span class="sd">            coordinates: Coordinates in voxel coordinates with shape</span>
</span><span id="ISampler.sample_mask-184"><a href="#ISampler.sample_mask-184"><span class="linenos">184</span></a><span class="sd">                (*batch_shape, n_spatial_dims, *target_shape).</span>
</span><span id="ISampler.sample_mask-185"><a href="#ISampler.sample_mask-185"><span class="linenos">185</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Sample mask at spatial locations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mask:</strong>  Mask to sample over spatial dimensions
with shape (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</li>
<li><strong>coordinates:</strong>  Coordinates in voxel coordinates with shape
(*batch_shape, n_spatial_dims, *target_shape).</li>
</ul>
</div>


                            </div>
                </section>
                <section id="ImageVisualizationArguments">
                            <input id="ImageVisualizationArguments-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ImageVisualizationArguments</span>:

                <label class="view-source-button" for="ImageVisualizationArguments-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImageVisualizationArguments"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImageVisualizationArguments-159"><a href="#ImageVisualizationArguments-159"><span class="linenos">159</span></a><span class="k">class</span> <span class="nc">ImageVisualizationArguments</span><span class="p">:</span>
</span><span id="ImageVisualizationArguments-160"><a href="#ImageVisualizationArguments-160"><span class="linenos">160</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Arguments for image visualization&quot;&quot;&quot;</span>
</span><span id="ImageVisualizationArguments-161"><a href="#ImageVisualizationArguments-161"><span class="linenos">161</span></a>
</span><span id="ImageVisualizationArguments-162"><a href="#ImageVisualizationArguments-162"><span class="linenos">162</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="ImageVisualizationArguments-163"><a href="#ImageVisualizationArguments-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ImageVisualizationArguments-164"><a href="#ImageVisualizationArguments-164"><span class="linenos">164</span></a>        <span class="n">batch_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="ImageVisualizationArguments-165"><a href="#ImageVisualizationArguments-165"><span class="linenos">165</span></a>        <span class="n">figure_height</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="ImageVisualizationArguments-166"><a href="#ImageVisualizationArguments-166"><span class="linenos">166</span></a>        <span class="n">mask_color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#591500&quot;</span><span class="p">,</span>
</span><span id="ImageVisualizationArguments-167"><a href="#ImageVisualizationArguments-167"><span class="linenos">167</span></a>        <span class="n">vmin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ImageVisualizationArguments-168"><a href="#ImageVisualizationArguments-168"><span class="linenos">168</span></a>        <span class="n">vmax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ImageVisualizationArguments-169"><a href="#ImageVisualizationArguments-169"><span class="linenos">169</span></a>        <span class="n">imshow_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ImageVisualizationArguments-170"><a href="#ImageVisualizationArguments-170"><span class="linenos">170</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ImageVisualizationArguments-171"><a href="#ImageVisualizationArguments-171"><span class="linenos">171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_index</span> <span class="o">=</span> <span class="n">batch_index</span>
</span><span id="ImageVisualizationArguments-172"><a href="#ImageVisualizationArguments-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">figure_height</span> <span class="o">=</span> <span class="n">figure_height</span>
</span><span id="ImageVisualizationArguments-173"><a href="#ImageVisualizationArguments-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mask_color</span> <span class="o">=</span> <span class="n">mask_color</span>
</span><span id="ImageVisualizationArguments-174"><a href="#ImageVisualizationArguments-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span>
</span><span id="ImageVisualizationArguments-175"><a href="#ImageVisualizationArguments-175"><span class="linenos">175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vmax</span> <span class="o">=</span> <span class="n">vmax</span>
</span><span id="ImageVisualizationArguments-176"><a href="#ImageVisualizationArguments-176"><span class="linenos">176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">imshow_kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">imshow_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">imshow_kwargs</span>
</span></pre></div>


            <div class="docstring"><p>Arguments for image visualization</p>
</div>


                            <div id="ImageVisualizationArguments.__init__" class="classattr">
                                        <input id="ImageVisualizationArguments.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ImageVisualizationArguments</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">batch_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">figure_height</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>,</span><span class="param">	<span class="n">mask_color</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;#591500&#39;</span>,</span><span class="param">	<span class="n">vmin</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">vmax</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">imshow_kwargs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="ImageVisualizationArguments.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImageVisualizationArguments.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImageVisualizationArguments.__init__-162"><a href="#ImageVisualizationArguments.__init__-162"><span class="linenos">162</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="ImageVisualizationArguments.__init__-163"><a href="#ImageVisualizationArguments.__init__-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ImageVisualizationArguments.__init__-164"><a href="#ImageVisualizationArguments.__init__-164"><span class="linenos">164</span></a>        <span class="n">batch_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="ImageVisualizationArguments.__init__-165"><a href="#ImageVisualizationArguments.__init__-165"><span class="linenos">165</span></a>        <span class="n">figure_height</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="ImageVisualizationArguments.__init__-166"><a href="#ImageVisualizationArguments.__init__-166"><span class="linenos">166</span></a>        <span class="n">mask_color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#591500&quot;</span><span class="p">,</span>
</span><span id="ImageVisualizationArguments.__init__-167"><a href="#ImageVisualizationArguments.__init__-167"><span class="linenos">167</span></a>        <span class="n">vmin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ImageVisualizationArguments.__init__-168"><a href="#ImageVisualizationArguments.__init__-168"><span class="linenos">168</span></a>        <span class="n">vmax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Number</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ImageVisualizationArguments.__init__-169"><a href="#ImageVisualizationArguments.__init__-169"><span class="linenos">169</span></a>        <span class="n">imshow_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ImageVisualizationArguments.__init__-170"><a href="#ImageVisualizationArguments.__init__-170"><span class="linenos">170</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ImageVisualizationArguments.__init__-171"><a href="#ImageVisualizationArguments.__init__-171"><span class="linenos">171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_index</span> <span class="o">=</span> <span class="n">batch_index</span>
</span><span id="ImageVisualizationArguments.__init__-172"><a href="#ImageVisualizationArguments.__init__-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">figure_height</span> <span class="o">=</span> <span class="n">figure_height</span>
</span><span id="ImageVisualizationArguments.__init__-173"><a href="#ImageVisualizationArguments.__init__-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mask_color</span> <span class="o">=</span> <span class="n">mask_color</span>
</span><span id="ImageVisualizationArguments.__init__-174"><a href="#ImageVisualizationArguments.__init__-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span>
</span><span id="ImageVisualizationArguments.__init__-175"><a href="#ImageVisualizationArguments.__init__-175"><span class="linenos">175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vmax</span> <span class="o">=</span> <span class="n">vmax</span>
</span><span id="ImageVisualizationArguments.__init__-176"><a href="#ImageVisualizationArguments.__init__-176"><span class="linenos">176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">imshow_kwargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">imshow_kwargs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">imshow_kwargs</span>
</span></pre></div>


    

                            </div>
                            <div id="ImageVisualizationArguments.batch_index" class="classattr">
                                <div class="attr variable">
            <span class="name">batch_index</span>

        
    </div>
    <a class="headerlink" href="#ImageVisualizationArguments.batch_index"></a>
    
    

                            </div>
                            <div id="ImageVisualizationArguments.figure_height" class="classattr">
                                <div class="attr variable">
            <span class="name">figure_height</span>

        
    </div>
    <a class="headerlink" href="#ImageVisualizationArguments.figure_height"></a>
    
    

                            </div>
                            <div id="ImageVisualizationArguments.mask_color" class="classattr">
                                <div class="attr variable">
            <span class="name">mask_color</span>

        
    </div>
    <a class="headerlink" href="#ImageVisualizationArguments.mask_color"></a>
    
    

                            </div>
                            <div id="ImageVisualizationArguments.vmin" class="classattr">
                                <div class="attr variable">
            <span class="name">vmin</span>

        
    </div>
    <a class="headerlink" href="#ImageVisualizationArguments.vmin"></a>
    
    

                            </div>
                            <div id="ImageVisualizationArguments.vmax" class="classattr">
                                <div class="attr variable">
            <span class="name">vmax</span>

        
    </div>
    <a class="headerlink" href="#ImageVisualizationArguments.vmax"></a>
    
    

                            </div>
                            <div id="ImageVisualizationArguments.imshow_kwargs" class="classattr">
                                <div class="attr variable">
            <span class="name">imshow_kwargs</span>

        
    </div>
    <a class="headerlink" href="#ImageVisualizationArguments.imshow_kwargs"></a>
    
    

                            </div>
                </section>
                <section id="ITensorLike">
                            <input id="ITensorLike-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ITensorLike</span><wbr>(<span class="base">abc.ABC</span>):

                <label class="view-source-button" for="ITensorLike-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ITensorLike"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ITensorLike-14"><a href="#ITensorLike-14"><span class="linenos">14</span></a><span class="k">class</span> <span class="nc">ITensorLike</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="ITensorLike-15"><a href="#ITensorLike-15"><span class="linenos">15</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Interface for classes having tensor like properties</span>
</span><span id="ITensorLike-16"><a href="#ITensorLike-16"><span class="linenos">16</span></a>
</span><span id="ITensorLike-17"><a href="#ITensorLike-17"><span class="linenos">17</span></a><span class="sd">    Usually contains wrapped tensors with device, dtype, and detachment</span>
</span><span id="ITensorLike-18"><a href="#ITensorLike-18"><span class="linenos">18</span></a><span class="sd">    related functionalities corresponding directly to the wrapped tensors.</span>
</span><span id="ITensorLike-19"><a href="#ITensorLike-19"><span class="linenos">19</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ITensorLike-20"><a href="#ITensorLike-20"><span class="linenos">20</span></a>
</span><span id="ITensorLike-21"><a href="#ITensorLike-21"><span class="linenos">21</span></a>    <span class="nd">@property</span>
</span><span id="ITensorLike-22"><a href="#ITensorLike-22"><span class="linenos">22</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ITensorLike-23"><a href="#ITensorLike-23"><span class="linenos">23</span></a>    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span>
</span><span id="ITensorLike-24"><a href="#ITensorLike-24"><span class="linenos">24</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ITensorLike-25"><a href="#ITensorLike-25"><span class="linenos">25</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch_dtype</span><span class="p">:</span>
</span><span id="ITensorLike-26"><a href="#ITensorLike-26"><span class="linenos">26</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;PyTorch data type&quot;&quot;&quot;</span>
</span><span id="ITensorLike-27"><a href="#ITensorLike-27"><span class="linenos">27</span></a>
</span><span id="ITensorLike-28"><a href="#ITensorLike-28"><span class="linenos">28</span></a>    <span class="nd">@property</span>
</span><span id="ITensorLike-29"><a href="#ITensorLike-29"><span class="linenos">29</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ITensorLike-30"><a href="#ITensorLike-30"><span class="linenos">30</span></a>    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span>
</span><span id="ITensorLike-31"><a href="#ITensorLike-31"><span class="linenos">31</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ITensorLike-32"><a href="#ITensorLike-32"><span class="linenos">32</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch_device</span><span class="p">:</span>
</span><span id="ITensorLike-33"><a href="#ITensorLike-33"><span class="linenos">33</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;PyTorch device&quot;&quot;&quot;</span>
</span><span id="ITensorLike-34"><a href="#ITensorLike-34"><span class="linenos">34</span></a>
</span><span id="ITensorLike-35"><a href="#ITensorLike-35"><span class="linenos">35</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ITensorLike-36"><a href="#ITensorLike-36"><span class="linenos">36</span></a>    <span class="k">def</span> <span class="nf">cast</span><span class="p">(</span>
</span><span id="ITensorLike-37"><a href="#ITensorLike-37"><span class="linenos">37</span></a>        <span class="bp">self</span><span class="p">:</span> <span class="n">ITensorLikeT</span><span class="p">,</span>
</span><span id="ITensorLike-38"><a href="#ITensorLike-38"><span class="linenos">38</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ITensorLike-39"><a href="#ITensorLike-39"><span class="linenos">39</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ITensorLike-40"><a href="#ITensorLike-40"><span class="linenos">40</span></a>        <span class="n">non_blocking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="ITensorLike-41"><a href="#ITensorLike-41"><span class="linenos">41</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ITensorLikeT</span><span class="p">:</span>
</span><span id="ITensorLike-42"><a href="#ITensorLike-42"><span class="linenos">42</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Cast to given data type and device</span>
</span><span id="ITensorLike-43"><a href="#ITensorLike-43"><span class="linenos">43</span></a>
</span><span id="ITensorLike-44"><a href="#ITensorLike-44"><span class="linenos">44</span></a><span class="sd">        We will not use method name &quot;to&quot; as it would create conflict with</span>
</span><span id="ITensorLike-45"><a href="#ITensorLike-45"><span class="linenos">45</span></a><span class="sd">        torch.nn.Module.to method which does casting in-place.</span>
</span><span id="ITensorLike-46"><a href="#ITensorLike-46"><span class="linenos">46</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ITensorLike-47"><a href="#ITensorLike-47"><span class="linenos">47</span></a>
</span><span id="ITensorLike-48"><a href="#ITensorLike-48"><span class="linenos">48</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ITensorLike-49"><a href="#ITensorLike-49"><span class="linenos">49</span></a>    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">ITensorLikeT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ITensorLikeT</span><span class="p">:</span>
</span><span id="ITensorLike-50"><a href="#ITensorLike-50"><span class="linenos">50</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Detach the wrapped tensors from computational graph&quot;&quot;&quot;</span>
</span><span id="ITensorLike-51"><a href="#ITensorLike-51"><span class="linenos">51</span></a>
</span><span id="ITensorLike-52"><a href="#ITensorLike-52"><span class="linenos">52</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ITensorLike-53"><a href="#ITensorLike-53"><span class="linenos">53</span></a>    <span class="k">def</span> <span class="nf">pin_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">ITensorLikeT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ITensorLikeT</span><span class="p">:</span>
</span><span id="ITensorLike-54"><a href="#ITensorLike-54"><span class="linenos">54</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Move the wrapped tensors to page-locked memory&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Interface for classes having tensor like properties</p>

<p>Usually contains wrapped tensors with device, dtype, and detachment
related functionalities corresponding directly to the wrapped tensors.</p>
</div>


                            <div id="ITensorLike.dtype" class="classattr">
                                        <input id="ITensorLike.dtype-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">dtype</span><span class="annotation">: torch.dtype</span>

                <label class="view-source-button" for="ITensorLike.dtype-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ITensorLike.dtype"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ITensorLike.dtype-21"><a href="#ITensorLike.dtype-21"><span class="linenos">21</span></a>    <span class="nd">@property</span>
</span><span id="ITensorLike.dtype-22"><a href="#ITensorLike.dtype-22"><span class="linenos">22</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ITensorLike.dtype-23"><a href="#ITensorLike.dtype-23"><span class="linenos">23</span></a>    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span>
</span><span id="ITensorLike.dtype-24"><a href="#ITensorLike.dtype-24"><span class="linenos">24</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ITensorLike.dtype-25"><a href="#ITensorLike.dtype-25"><span class="linenos">25</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch_dtype</span><span class="p">:</span>
</span><span id="ITensorLike.dtype-26"><a href="#ITensorLike.dtype-26"><span class="linenos">26</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;PyTorch data type&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>PyTorch data type</p>
</div>


                            </div>
                            <div id="ITensorLike.device" class="classattr">
                                        <input id="ITensorLike.device-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">device</span><span class="annotation">: torch.device</span>

                <label class="view-source-button" for="ITensorLike.device-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ITensorLike.device"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ITensorLike.device-28"><a href="#ITensorLike.device-28"><span class="linenos">28</span></a>    <span class="nd">@property</span>
</span><span id="ITensorLike.device-29"><a href="#ITensorLike.device-29"><span class="linenos">29</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ITensorLike.device-30"><a href="#ITensorLike.device-30"><span class="linenos">30</span></a>    <span class="k">def</span> <span class="nf">device</span><span class="p">(</span>
</span><span id="ITensorLike.device-31"><a href="#ITensorLike.device-31"><span class="linenos">31</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ITensorLike.device-32"><a href="#ITensorLike.device-32"><span class="linenos">32</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch_device</span><span class="p">:</span>
</span><span id="ITensorLike.device-33"><a href="#ITensorLike.device-33"><span class="linenos">33</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;PyTorch device&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>PyTorch device</p>
</div>


                            </div>
                            <div id="ITensorLike.cast" class="classattr">
                                        <input id="ITensorLike.cast-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">cast</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span><span class="p">:</span> <span class="o">~</span><span class="n">ITensorLikeT</span>,</span><span class="param">	<span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">non_blocking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="o">~</span><span class="n">ITensorLikeT</span>:</span></span>

                <label class="view-source-button" for="ITensorLike.cast-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ITensorLike.cast"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ITensorLike.cast-35"><a href="#ITensorLike.cast-35"><span class="linenos">35</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ITensorLike.cast-36"><a href="#ITensorLike.cast-36"><span class="linenos">36</span></a>    <span class="k">def</span> <span class="nf">cast</span><span class="p">(</span>
</span><span id="ITensorLike.cast-37"><a href="#ITensorLike.cast-37"><span class="linenos">37</span></a>        <span class="bp">self</span><span class="p">:</span> <span class="n">ITensorLikeT</span><span class="p">,</span>
</span><span id="ITensorLike.cast-38"><a href="#ITensorLike.cast-38"><span class="linenos">38</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ITensorLike.cast-39"><a href="#ITensorLike.cast-39"><span class="linenos">39</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ITensorLike.cast-40"><a href="#ITensorLike.cast-40"><span class="linenos">40</span></a>        <span class="n">non_blocking</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="ITensorLike.cast-41"><a href="#ITensorLike.cast-41"><span class="linenos">41</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ITensorLikeT</span><span class="p">:</span>
</span><span id="ITensorLike.cast-42"><a href="#ITensorLike.cast-42"><span class="linenos">42</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Cast to given data type and device</span>
</span><span id="ITensorLike.cast-43"><a href="#ITensorLike.cast-43"><span class="linenos">43</span></a>
</span><span id="ITensorLike.cast-44"><a href="#ITensorLike.cast-44"><span class="linenos">44</span></a><span class="sd">        We will not use method name &quot;to&quot; as it would create conflict with</span>
</span><span id="ITensorLike.cast-45"><a href="#ITensorLike.cast-45"><span class="linenos">45</span></a><span class="sd">        torch.nn.Module.to method which does casting in-place.</span>
</span><span id="ITensorLike.cast-46"><a href="#ITensorLike.cast-46"><span class="linenos">46</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Cast to given data type and device</p>

<p>We will not use method name "to" as it would create conflict with
torch.nn.Module.to method which does casting in-place.</p>
</div>


                            </div>
                            <div id="ITensorLike.detach" class="classattr">
                                        <input id="ITensorLike.detach-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">detach</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span><span class="p">:</span> <span class="o">~</span><span class="n">ITensorLikeT</span></span><span class="return-annotation">) -> <span class="o">~</span><span class="n">ITensorLikeT</span>:</span></span>

                <label class="view-source-button" for="ITensorLike.detach-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ITensorLike.detach"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ITensorLike.detach-48"><a href="#ITensorLike.detach-48"><span class="linenos">48</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ITensorLike.detach-49"><a href="#ITensorLike.detach-49"><span class="linenos">49</span></a>    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">ITensorLikeT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ITensorLikeT</span><span class="p">:</span>
</span><span id="ITensorLike.detach-50"><a href="#ITensorLike.detach-50"><span class="linenos">50</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Detach the wrapped tensors from computational graph&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Detach the wrapped tensors from computational graph</p>
</div>


                            </div>
                            <div id="ITensorLike.pin_memory" class="classattr">
                                        <input id="ITensorLike.pin_memory-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">pin_memory</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span><span class="p">:</span> <span class="o">~</span><span class="n">ITensorLikeT</span></span><span class="return-annotation">) -> <span class="o">~</span><span class="n">ITensorLikeT</span>:</span></span>

                <label class="view-source-button" for="ITensorLike.pin_memory-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ITensorLike.pin_memory"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ITensorLike.pin_memory-52"><a href="#ITensorLike.pin_memory-52"><span class="linenos">52</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ITensorLike.pin_memory-53"><a href="#ITensorLike.pin_memory-53"><span class="linenos">53</span></a>    <span class="k">def</span> <span class="nf">pin_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">ITensorLikeT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ITensorLikeT</span><span class="p">:</span>
</span><span id="ITensorLike.pin_memory-54"><a href="#ITensorLike.pin_memory-54"><span class="linenos">54</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Move the wrapped tensors to page-locked memory&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Move the wrapped tensors to page-locked memory</p>
</div>


                            </div>
                </section>
                <section id="LimitDirection">
                            <input id="LimitDirection-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LimitDirection</span>:

                <label class="view-source-button" for="LimitDirection-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LimitDirection"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LimitDirection-15"><a href="#LimitDirection-15"><span class="linenos">15</span></a><span class="k">class</span> <span class="nc">LimitDirection</span><span class="p">:</span>
</span><span id="LimitDirection-16"><a href="#LimitDirection-16"><span class="linenos">16</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Direction of a limit.</span>
</span><span id="LimitDirection-17"><a href="#LimitDirection-17"><span class="linenos">17</span></a>
</span><span id="LimitDirection-18"><a href="#LimitDirection-18"><span class="linenos">18</span></a><span class="sd">    Arguments:</span>
</span><span id="LimitDirection-19"><a href="#LimitDirection-19"><span class="linenos">19</span></a><span class="sd">        direction: Direction of the limit. Can be one of &quot;left&quot;, &quot;right&quot;, or</span>
</span><span id="LimitDirection-20"><a href="#LimitDirection-20"><span class="linenos">20</span></a><span class="sd">            &quot;average&quot;.</span>
</span><span id="LimitDirection-21"><a href="#LimitDirection-21"><span class="linenos">21</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="LimitDirection-22"><a href="#LimitDirection-22"><span class="linenos">22</span></a>
</span><span id="LimitDirection-23"><a href="#LimitDirection-23"><span class="linenos">23</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LimitDirection-24"><a href="#LimitDirection-24"><span class="linenos">24</span></a>        <span class="k">if</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;average&quot;</span><span class="p">]:</span>
</span><span id="LimitDirection-25"><a href="#LimitDirection-25"><span class="linenos">25</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid direction&quot;</span><span class="p">)</span>
</span><span id="LimitDirection-26"><a href="#LimitDirection-26"><span class="linenos">26</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span>
</span><span id="LimitDirection-27"><a href="#LimitDirection-27"><span class="linenos">27</span></a>
</span><span id="LimitDirection-28"><a href="#LimitDirection-28"><span class="linenos">28</span></a>    <span class="nd">@classmethod</span>
</span><span id="LimitDirection-29"><a href="#LimitDirection-29"><span class="linenos">29</span></a>    <span class="k">def</span> <span class="nf">left</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LimitDirection&quot;</span><span class="p">:</span>
</span><span id="LimitDirection-30"><a href="#LimitDirection-30"><span class="linenos">30</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Left limit direction.&quot;&quot;&quot;</span>
</span><span id="LimitDirection-31"><a href="#LimitDirection-31"><span class="linenos">31</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</span><span id="LimitDirection-32"><a href="#LimitDirection-32"><span class="linenos">32</span></a>
</span><span id="LimitDirection-33"><a href="#LimitDirection-33"><span class="linenos">33</span></a>    <span class="nd">@classmethod</span>
</span><span id="LimitDirection-34"><a href="#LimitDirection-34"><span class="linenos">34</span></a>    <span class="k">def</span> <span class="nf">right</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LimitDirection&quot;</span><span class="p">:</span>
</span><span id="LimitDirection-35"><a href="#LimitDirection-35"><span class="linenos">35</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Right limit direction.&quot;&quot;&quot;</span>
</span><span id="LimitDirection-36"><a href="#LimitDirection-36"><span class="linenos">36</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
</span><span id="LimitDirection-37"><a href="#LimitDirection-37"><span class="linenos">37</span></a>
</span><span id="LimitDirection-38"><a href="#LimitDirection-38"><span class="linenos">38</span></a>    <span class="nd">@classmethod</span>
</span><span id="LimitDirection-39"><a href="#LimitDirection-39"><span class="linenos">39</span></a>    <span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LimitDirection&quot;</span><span class="p">:</span>
</span><span id="LimitDirection-40"><a href="#LimitDirection-40"><span class="linenos">40</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Average of left and right limit directions.&quot;&quot;&quot;</span>
</span><span id="LimitDirection-41"><a href="#LimitDirection-41"><span class="linenos">41</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="s2">&quot;average&quot;</span><span class="p">)</span>
</span><span id="LimitDirection-42"><a href="#LimitDirection-42"><span class="linenos">42</span></a>
</span><span id="LimitDirection-43"><a href="#LimitDirection-43"><span class="linenos">43</span></a>    <span class="k">def</span> <span class="nf">as_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="s2">&quot;LimitDirection&quot;</span><span class="p">]:</span>
</span><span id="LimitDirection-44"><a href="#LimitDirection-44"><span class="linenos">44</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Limit direction as callable.</span>
</span><span id="LimitDirection-45"><a href="#LimitDirection-45"><span class="linenos">45</span></a>
</span><span id="LimitDirection-46"><a href="#LimitDirection-46"><span class="linenos">46</span></a><span class="sd">        Useful for creating a callable that returns the same limit direction</span>
</span><span id="LimitDirection-47"><a href="#LimitDirection-47"><span class="linenos">47</span></a><span class="sd">        for all dimensions.</span>
</span><span id="LimitDirection-48"><a href="#LimitDirection-48"><span class="linenos">48</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LimitDirection-49"><a href="#LimitDirection-49"><span class="linenos">49</span></a>        <span class="k">return</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span>
</span><span id="LimitDirection-50"><a href="#LimitDirection-50"><span class="linenos">50</span></a>
</span><span id="LimitDirection-51"><a href="#LimitDirection-51"><span class="linenos">51</span></a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="LimitDirection-52"><a href="#LimitDirection-52"><span class="linenos">52</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">LimitDirection</span><span class="p">):</span>
</span><span id="LimitDirection-53"><a href="#LimitDirection-53"><span class="linenos">53</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="LimitDirection-54"><a href="#LimitDirection-54"><span class="linenos">54</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">value</span><span class="o">.</span><span class="n">direction</span>
</span></pre></div>


            <div class="docstring"><p>Direction of a limit.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>direction:</strong>  Direction of the limit. Can be one of "left", "right", or
"average".</li>
</ul>
</div>


                            <div id="LimitDirection.__init__" class="classattr">
                                        <input id="LimitDirection.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">LimitDirection</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">direction</span><span class="p">:</span> <span class="nb">str</span></span>)</span>

                <label class="view-source-button" for="LimitDirection.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LimitDirection.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LimitDirection.__init__-23"><a href="#LimitDirection.__init__-23"><span class="linenos">23</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LimitDirection.__init__-24"><a href="#LimitDirection.__init__-24"><span class="linenos">24</span></a>        <span class="k">if</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;average&quot;</span><span class="p">]:</span>
</span><span id="LimitDirection.__init__-25"><a href="#LimitDirection.__init__-25"><span class="linenos">25</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid direction&quot;</span><span class="p">)</span>
</span><span id="LimitDirection.__init__-26"><a href="#LimitDirection.__init__-26"><span class="linenos">26</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span>
</span></pre></div>


    

                            </div>
                            <div id="LimitDirection.direction" class="classattr">
                                <div class="attr variable">
            <span class="name">direction</span>

        
    </div>
    <a class="headerlink" href="#LimitDirection.direction"></a>
    
    

                            </div>
                            <div id="LimitDirection.left" class="classattr">
                                        <input id="LimitDirection.left-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">left</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span></span><span class="return-annotation">) -> <span class="n"><a href="#LimitDirection">LimitDirection</a></span>:</span></span>

                <label class="view-source-button" for="LimitDirection.left-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LimitDirection.left"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LimitDirection.left-28"><a href="#LimitDirection.left-28"><span class="linenos">28</span></a>    <span class="nd">@classmethod</span>
</span><span id="LimitDirection.left-29"><a href="#LimitDirection.left-29"><span class="linenos">29</span></a>    <span class="k">def</span> <span class="nf">left</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LimitDirection&quot;</span><span class="p">:</span>
</span><span id="LimitDirection.left-30"><a href="#LimitDirection.left-30"><span class="linenos">30</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Left limit direction.&quot;&quot;&quot;</span>
</span><span id="LimitDirection.left-31"><a href="#LimitDirection.left-31"><span class="linenos">31</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Left limit direction.</p>
</div>


                            </div>
                            <div id="LimitDirection.right" class="classattr">
                                        <input id="LimitDirection.right-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">right</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span></span><span class="return-annotation">) -> <span class="n"><a href="#LimitDirection">LimitDirection</a></span>:</span></span>

                <label class="view-source-button" for="LimitDirection.right-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LimitDirection.right"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LimitDirection.right-33"><a href="#LimitDirection.right-33"><span class="linenos">33</span></a>    <span class="nd">@classmethod</span>
</span><span id="LimitDirection.right-34"><a href="#LimitDirection.right-34"><span class="linenos">34</span></a>    <span class="k">def</span> <span class="nf">right</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LimitDirection&quot;</span><span class="p">:</span>
</span><span id="LimitDirection.right-35"><a href="#LimitDirection.right-35"><span class="linenos">35</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Right limit direction.&quot;&quot;&quot;</span>
</span><span id="LimitDirection.right-36"><a href="#LimitDirection.right-36"><span class="linenos">36</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Right limit direction.</p>
</div>


                            </div>
                            <div id="LimitDirection.average" class="classattr">
                                        <input id="LimitDirection.average-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">average</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span></span><span class="return-annotation">) -> <span class="n"><a href="#LimitDirection">LimitDirection</a></span>:</span></span>

                <label class="view-source-button" for="LimitDirection.average-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LimitDirection.average"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LimitDirection.average-38"><a href="#LimitDirection.average-38"><span class="linenos">38</span></a>    <span class="nd">@classmethod</span>
</span><span id="LimitDirection.average-39"><a href="#LimitDirection.average-39"><span class="linenos">39</span></a>    <span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;LimitDirection&quot;</span><span class="p">:</span>
</span><span id="LimitDirection.average-40"><a href="#LimitDirection.average-40"><span class="linenos">40</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Average of left and right limit directions.&quot;&quot;&quot;</span>
</span><span id="LimitDirection.average-41"><a href="#LimitDirection.average-41"><span class="linenos">41</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="s2">&quot;average&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Average of left and right limit directions.</p>
</div>


                            </div>
                            <div id="LimitDirection.as_callable" class="classattr">
                                        <input id="LimitDirection.as_callable-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">as_callable</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Callable</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n"><a href="#LimitDirection">LimitDirection</a></span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="LimitDirection.as_callable-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LimitDirection.as_callable"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LimitDirection.as_callable-43"><a href="#LimitDirection.as_callable-43"><span class="linenos">43</span></a>    <span class="k">def</span> <span class="nf">as_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="s2">&quot;LimitDirection&quot;</span><span class="p">]:</span>
</span><span id="LimitDirection.as_callable-44"><a href="#LimitDirection.as_callable-44"><span class="linenos">44</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Limit direction as callable.</span>
</span><span id="LimitDirection.as_callable-45"><a href="#LimitDirection.as_callable-45"><span class="linenos">45</span></a>
</span><span id="LimitDirection.as_callable-46"><a href="#LimitDirection.as_callable-46"><span class="linenos">46</span></a><span class="sd">        Useful for creating a callable that returns the same limit direction</span>
</span><span id="LimitDirection.as_callable-47"><a href="#LimitDirection.as_callable-47"><span class="linenos">47</span></a><span class="sd">        for all dimensions.</span>
</span><span id="LimitDirection.as_callable-48"><a href="#LimitDirection.as_callable-48"><span class="linenos">48</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LimitDirection.as_callable-49"><a href="#LimitDirection.as_callable-49"><span class="linenos">49</span></a>        <span class="k">return</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Limit direction as callable.</p>

<p>Useful for creating a callable that returns the same limit direction
for all dimensions.</p>
</div>


                            </div>
                </section>
                <section id="LinearInterpolator">
                            <input id="LinearInterpolator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LinearInterpolator</span><wbr>(<span class="base"><a href="#BaseSeparableSampler">composable_mapping.BaseSeparableSampler</a></span>):

                <label class="view-source-button" for="LinearInterpolator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LinearInterpolator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LinearInterpolator-23"><a href="#LinearInterpolator-23"><span class="linenos">23</span></a><span class="k">class</span> <span class="nc">LinearInterpolator</span><span class="p">(</span><span class="n">BaseSeparableSampler</span><span class="p">):</span>
</span><span id="LinearInterpolator-24"><a href="#LinearInterpolator-24"><span class="linenos">24</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Linear interpolation in voxel coordinates</span>
</span><span id="LinearInterpolator-25"><a href="#LinearInterpolator-25"><span class="linenos">25</span></a>
</span><span id="LinearInterpolator-26"><a href="#LinearInterpolator-26"><span class="linenos">26</span></a><span class="sd">    Arguments:</span>
</span><span id="LinearInterpolator-27"><a href="#LinearInterpolator-27"><span class="linenos">27</span></a><span class="sd">        extrapolation_mode: Extrapolation mode for out-of-bound coordinates.</span>
</span><span id="LinearInterpolator-28"><a href="#LinearInterpolator-28"><span class="linenos">28</span></a><span class="sd">        mask_extrapolated_regions_for_empty_volume_mask: Whether to mask</span>
</span><span id="LinearInterpolator-29"><a href="#LinearInterpolator-29"><span class="linenos">29</span></a><span class="sd">            extrapolated regions when input volume mask is empty.</span>
</span><span id="LinearInterpolator-30"><a href="#LinearInterpolator-30"><span class="linenos">30</span></a><span class="sd">        convolution_threshold: Maximum allowed difference in coordinates</span>
</span><span id="LinearInterpolator-31"><a href="#LinearInterpolator-31"><span class="linenos">31</span></a><span class="sd">            for using convolution-based sampling (the difference might be upper</span>
</span><span id="LinearInterpolator-32"><a href="#LinearInterpolator-32"><span class="linenos">32</span></a><span class="sd">            bounded when doing the decision).</span>
</span><span id="LinearInterpolator-33"><a href="#LinearInterpolator-33"><span class="linenos">33</span></a><span class="sd">        mask_threshold: Maximum allowed weight for masked regions in a</span>
</span><span id="LinearInterpolator-34"><a href="#LinearInterpolator-34"><span class="linenos">34</span></a><span class="sd">            sampled location to still consider it valid (non-masked).</span>
</span><span id="LinearInterpolator-35"><a href="#LinearInterpolator-35"><span class="linenos">35</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="LinearInterpolator-36"><a href="#LinearInterpolator-36"><span class="linenos">36</span></a>
</span><span id="LinearInterpolator-37"><a href="#LinearInterpolator-37"><span class="linenos">37</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="LinearInterpolator-38"><a href="#LinearInterpolator-38"><span class="linenos">38</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LinearInterpolator-39"><a href="#LinearInterpolator-39"><span class="linenos">39</span></a>        <span class="n">extrapolation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;border&quot;</span><span class="p">,</span>
</span><span id="LinearInterpolator-40"><a href="#LinearInterpolator-40"><span class="linenos">40</span></a>        <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LinearInterpolator-41"><a href="#LinearInterpolator-41"><span class="linenos">41</span></a>        <span class="n">convolution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
</span><span id="LinearInterpolator-42"><a href="#LinearInterpolator-42"><span class="linenos">42</span></a>        <span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span>
</span><span id="LinearInterpolator-43"><a href="#LinearInterpolator-43"><span class="linenos">43</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LinearInterpolator-44"><a href="#LinearInterpolator-44"><span class="linenos">44</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="LinearInterpolator-45"><a href="#LinearInterpolator-45"><span class="linenos">45</span></a>            <span class="n">extrapolation_mode</span><span class="o">=</span><span class="n">extrapolation_mode</span><span class="p">,</span>
</span><span id="LinearInterpolator-46"><a href="#LinearInterpolator-46"><span class="linenos">46</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="o">=</span><span class="p">(</span>
</span><span id="LinearInterpolator-47"><a href="#LinearInterpolator-47"><span class="linenos">47</span></a>                <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="LinearInterpolator-48"><a href="#LinearInterpolator-48"><span class="linenos">48</span></a>            <span class="p">),</span>
</span><span id="LinearInterpolator-49"><a href="#LinearInterpolator-49"><span class="linenos">49</span></a>            <span class="n">convolution_threshold</span><span class="o">=</span><span class="n">convolution_threshold</span><span class="p">,</span>
</span><span id="LinearInterpolator-50"><a href="#LinearInterpolator-50"><span class="linenos">50</span></a>            <span class="n">mask_threshold</span><span class="o">=</span><span class="n">mask_threshold</span><span class="p">,</span>
</span><span id="LinearInterpolator-51"><a href="#LinearInterpolator-51"><span class="linenos">51</span></a>            <span class="n">limit_direction</span><span class="o">=</span><span class="n">LimitDirection</span><span class="o">.</span><span class="n">right</span><span class="p">(),</span>
</span><span id="LinearInterpolator-52"><a href="#LinearInterpolator-52"><span class="linenos">52</span></a>        <span class="p">)</span>
</span><span id="LinearInterpolator-53"><a href="#LinearInterpolator-53"><span class="linenos">53</span></a>
</span><span id="LinearInterpolator-54"><a href="#LinearInterpolator-54"><span class="linenos">54</span></a>    <span class="k">def</span> <span class="nf">_kernel_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ISeparableKernelSupport</span><span class="p">:</span>
</span><span id="LinearInterpolator-55"><a href="#LinearInterpolator-55"><span class="linenos">55</span></a>        <span class="k">return</span> <span class="n">SymmetricPolynomialKernelSupport</span><span class="p">(</span><span class="n">kernel_width</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">polynomial_degree</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LinearInterpolator-56"><a href="#LinearInterpolator-56"><span class="linenos">56</span></a>
</span><span id="LinearInterpolator-57"><a href="#LinearInterpolator-57"><span class="linenos">57</span></a>    <span class="k">def</span> <span class="nf">_is_interpolating_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="LinearInterpolator-58"><a href="#LinearInterpolator-58"><span class="linenos">58</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="LinearInterpolator-59"><a href="#LinearInterpolator-59"><span class="linenos">59</span></a>
</span><span id="LinearInterpolator-60"><a href="#LinearInterpolator-60"><span class="linenos">60</span></a>    <span class="k">def</span> <span class="nf">_left_limit_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="LinearInterpolator-61"><a href="#LinearInterpolator-61"><span class="linenos">61</span></a>        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">coordinates</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">coordinates</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
</span><span id="LinearInterpolator-62"><a href="#LinearInterpolator-62"><span class="linenos">62</span></a>            <span class="p">(</span><span class="n">coordinates</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="LinearInterpolator-63"><a href="#LinearInterpolator-63"><span class="linenos">63</span></a>        <span class="p">)</span>
</span><span id="LinearInterpolator-64"><a href="#LinearInterpolator-64"><span class="linenos">64</span></a>
</span><span id="LinearInterpolator-65"><a href="#LinearInterpolator-65"><span class="linenos">65</span></a>    <span class="k">def</span> <span class="nf">_right_limit_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="LinearInterpolator-66"><a href="#LinearInterpolator-66"><span class="linenos">66</span></a>        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">coordinates</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">coordinates</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
</span><span id="LinearInterpolator-67"><a href="#LinearInterpolator-67"><span class="linenos">67</span></a>            <span class="p">(</span><span class="n">coordinates</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="LinearInterpolator-68"><a href="#LinearInterpolator-68"><span class="linenos">68</span></a>        <span class="p">)</span>
</span><span id="LinearInterpolator-69"><a href="#LinearInterpolator-69"><span class="linenos">69</span></a>
</span><span id="LinearInterpolator-70"><a href="#LinearInterpolator-70"><span class="linenos">70</span></a>    <span class="k">def</span> <span class="nf">sample_values</span><span class="p">(</span>
</span><span id="LinearInterpolator-71"><a href="#LinearInterpolator-71"><span class="linenos">71</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LinearInterpolator-72"><a href="#LinearInterpolator-72"><span class="linenos">72</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="LinearInterpolator-73"><a href="#LinearInterpolator-73"><span class="linenos">73</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="LinearInterpolator-74"><a href="#LinearInterpolator-74"><span class="linenos">74</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="LinearInterpolator-75"><a href="#LinearInterpolator-75"><span class="linenos">75</span></a>        <span class="k">return</span> <span class="n">interpolate</span><span class="p">(</span>
</span><span id="LinearInterpolator-76"><a href="#LinearInterpolator-76"><span class="linenos">76</span></a>            <span class="n">volume</span><span class="p">,</span>
</span><span id="LinearInterpolator-77"><a href="#LinearInterpolator-77"><span class="linenos">77</span></a>            <span class="n">coordinates</span><span class="p">,</span>
</span><span id="LinearInterpolator-78"><a href="#LinearInterpolator-78"><span class="linenos">78</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
</span><span id="LinearInterpolator-79"><a href="#LinearInterpolator-79"><span class="linenos">79</span></a>            <span class="n">padding_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extrapolation_mode</span><span class="p">,</span>
</span><span id="LinearInterpolator-80"><a href="#LinearInterpolator-80"><span class="linenos">80</span></a>        <span class="p">)</span>
</span><span id="LinearInterpolator-81"><a href="#LinearInterpolator-81"><span class="linenos">81</span></a>
</span><span id="LinearInterpolator-82"><a href="#LinearInterpolator-82"><span class="linenos">82</span></a>    <span class="k">def</span> <span class="nf">sample_mask</span><span class="p">(</span>
</span><span id="LinearInterpolator-83"><a href="#LinearInterpolator-83"><span class="linenos">83</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LinearInterpolator-84"><a href="#LinearInterpolator-84"><span class="linenos">84</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="LinearInterpolator-85"><a href="#LinearInterpolator-85"><span class="linenos">85</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="LinearInterpolator-86"><a href="#LinearInterpolator-86"><span class="linenos">86</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="LinearInterpolator-87"><a href="#LinearInterpolator-87"><span class="linenos">87</span></a>        <span class="n">interpolated_mask</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span>
</span><span id="LinearInterpolator-88"><a href="#LinearInterpolator-88"><span class="linenos">88</span></a>            <span class="n">volume</span><span class="o">=</span><span class="n">mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="LinearInterpolator-89"><a href="#LinearInterpolator-89"><span class="linenos">89</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
</span><span id="LinearInterpolator-90"><a href="#LinearInterpolator-90"><span class="linenos">90</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
</span><span id="LinearInterpolator-91"><a href="#LinearInterpolator-91"><span class="linenos">91</span></a>            <span class="n">padding_mode</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span>
</span><span id="LinearInterpolator-92"><a href="#LinearInterpolator-92"><span class="linenos">92</span></a>        <span class="p">)</span>
</span><span id="LinearInterpolator-93"><a href="#LinearInterpolator-93"><span class="linenos">93</span></a>        <span class="k">return</span> <span class="n">interpolated_mask</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span>
</span></pre></div>


            <div class="docstring"><p>Linear interpolation in voxel coordinates</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>extrapolation_mode:</strong>  Extrapolation mode for out-of-bound coordinates.</li>
<li><strong>mask_extrapolated_regions_for_empty_volume_mask:</strong>  Whether to mask
extrapolated regions when input volume mask is empty.</li>
<li><strong>convolution_threshold:</strong>  Maximum allowed difference in coordinates
for using convolution-based sampling (the difference might be upper
bounded when doing the decision).</li>
<li><strong>mask_threshold:</strong>  Maximum allowed weight for masked regions in a
sampled location to still consider it valid (non-masked).</li>
</ul>
</div>


                            <div id="LinearInterpolator.__init__" class="classattr">
                                        <input id="LinearInterpolator.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">LinearInterpolator</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">extrapolation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;border&#39;</span>,</span><span class="param">	<span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">convolution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0001</span>,</span><span class="param">	<span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-05</span></span>)</span>

                <label class="view-source-button" for="LinearInterpolator.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LinearInterpolator.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LinearInterpolator.__init__-37"><a href="#LinearInterpolator.__init__-37"><span class="linenos">37</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="LinearInterpolator.__init__-38"><a href="#LinearInterpolator.__init__-38"><span class="linenos">38</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LinearInterpolator.__init__-39"><a href="#LinearInterpolator.__init__-39"><span class="linenos">39</span></a>        <span class="n">extrapolation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;border&quot;</span><span class="p">,</span>
</span><span id="LinearInterpolator.__init__-40"><a href="#LinearInterpolator.__init__-40"><span class="linenos">40</span></a>        <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LinearInterpolator.__init__-41"><a href="#LinearInterpolator.__init__-41"><span class="linenos">41</span></a>        <span class="n">convolution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
</span><span id="LinearInterpolator.__init__-42"><a href="#LinearInterpolator.__init__-42"><span class="linenos">42</span></a>        <span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span>
</span><span id="LinearInterpolator.__init__-43"><a href="#LinearInterpolator.__init__-43"><span class="linenos">43</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LinearInterpolator.__init__-44"><a href="#LinearInterpolator.__init__-44"><span class="linenos">44</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="LinearInterpolator.__init__-45"><a href="#LinearInterpolator.__init__-45"><span class="linenos">45</span></a>            <span class="n">extrapolation_mode</span><span class="o">=</span><span class="n">extrapolation_mode</span><span class="p">,</span>
</span><span id="LinearInterpolator.__init__-46"><a href="#LinearInterpolator.__init__-46"><span class="linenos">46</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="o">=</span><span class="p">(</span>
</span><span id="LinearInterpolator.__init__-47"><a href="#LinearInterpolator.__init__-47"><span class="linenos">47</span></a>                <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="LinearInterpolator.__init__-48"><a href="#LinearInterpolator.__init__-48"><span class="linenos">48</span></a>            <span class="p">),</span>
</span><span id="LinearInterpolator.__init__-49"><a href="#LinearInterpolator.__init__-49"><span class="linenos">49</span></a>            <span class="n">convolution_threshold</span><span class="o">=</span><span class="n">convolution_threshold</span><span class="p">,</span>
</span><span id="LinearInterpolator.__init__-50"><a href="#LinearInterpolator.__init__-50"><span class="linenos">50</span></a>            <span class="n">mask_threshold</span><span class="o">=</span><span class="n">mask_threshold</span><span class="p">,</span>
</span><span id="LinearInterpolator.__init__-51"><a href="#LinearInterpolator.__init__-51"><span class="linenos">51</span></a>            <span class="n">limit_direction</span><span class="o">=</span><span class="n">LimitDirection</span><span class="o">.</span><span class="n">right</span><span class="p">(),</span>
</span><span id="LinearInterpolator.__init__-52"><a href="#LinearInterpolator.__init__-52"><span class="linenos">52</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="LinearInterpolator.sample_values" class="classattr">
                                        <input id="LinearInterpolator.sample_values-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_values</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">volume</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>, </span><span class="param"><span class="n">coordinates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="LinearInterpolator.sample_values-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LinearInterpolator.sample_values"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LinearInterpolator.sample_values-70"><a href="#LinearInterpolator.sample_values-70"><span class="linenos">70</span></a>    <span class="k">def</span> <span class="nf">sample_values</span><span class="p">(</span>
</span><span id="LinearInterpolator.sample_values-71"><a href="#LinearInterpolator.sample_values-71"><span class="linenos">71</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LinearInterpolator.sample_values-72"><a href="#LinearInterpolator.sample_values-72"><span class="linenos">72</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="LinearInterpolator.sample_values-73"><a href="#LinearInterpolator.sample_values-73"><span class="linenos">73</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="LinearInterpolator.sample_values-74"><a href="#LinearInterpolator.sample_values-74"><span class="linenos">74</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="LinearInterpolator.sample_values-75"><a href="#LinearInterpolator.sample_values-75"><span class="linenos">75</span></a>        <span class="k">return</span> <span class="n">interpolate</span><span class="p">(</span>
</span><span id="LinearInterpolator.sample_values-76"><a href="#LinearInterpolator.sample_values-76"><span class="linenos">76</span></a>            <span class="n">volume</span><span class="p">,</span>
</span><span id="LinearInterpolator.sample_values-77"><a href="#LinearInterpolator.sample_values-77"><span class="linenos">77</span></a>            <span class="n">coordinates</span><span class="p">,</span>
</span><span id="LinearInterpolator.sample_values-78"><a href="#LinearInterpolator.sample_values-78"><span class="linenos">78</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
</span><span id="LinearInterpolator.sample_values-79"><a href="#LinearInterpolator.sample_values-79"><span class="linenos">79</span></a>            <span class="n">padding_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extrapolation_mode</span><span class="p">,</span>
</span><span id="LinearInterpolator.sample_values-80"><a href="#LinearInterpolator.sample_values-80"><span class="linenos">80</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sample values at spatial locations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>volume:</strong>  Volume to sample over spatial dimensions
with shape (*batch_shape, *channels_shape, *spatial_shape)</li>
<li><strong>coordinates:</strong>  Coordinates in voxel coordinates with shape
(*batch_shape, n_spatial_dims, *target_shape).</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Sampled values with shape (*batch_shape, *channels_shape, *target_shape).</p>
</blockquote>
</div>


                            </div>
                            <div id="LinearInterpolator.sample_mask" class="classattr">
                                        <input id="LinearInterpolator.sample_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_mask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>, </span><span class="param"><span class="n">coordinates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="LinearInterpolator.sample_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LinearInterpolator.sample_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LinearInterpolator.sample_mask-82"><a href="#LinearInterpolator.sample_mask-82"><span class="linenos">82</span></a>    <span class="k">def</span> <span class="nf">sample_mask</span><span class="p">(</span>
</span><span id="LinearInterpolator.sample_mask-83"><a href="#LinearInterpolator.sample_mask-83"><span class="linenos">83</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LinearInterpolator.sample_mask-84"><a href="#LinearInterpolator.sample_mask-84"><span class="linenos">84</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="LinearInterpolator.sample_mask-85"><a href="#LinearInterpolator.sample_mask-85"><span class="linenos">85</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="LinearInterpolator.sample_mask-86"><a href="#LinearInterpolator.sample_mask-86"><span class="linenos">86</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="LinearInterpolator.sample_mask-87"><a href="#LinearInterpolator.sample_mask-87"><span class="linenos">87</span></a>        <span class="n">interpolated_mask</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span>
</span><span id="LinearInterpolator.sample_mask-88"><a href="#LinearInterpolator.sample_mask-88"><span class="linenos">88</span></a>            <span class="n">volume</span><span class="o">=</span><span class="n">mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="LinearInterpolator.sample_mask-89"><a href="#LinearInterpolator.sample_mask-89"><span class="linenos">89</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
</span><span id="LinearInterpolator.sample_mask-90"><a href="#LinearInterpolator.sample_mask-90"><span class="linenos">90</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
</span><span id="LinearInterpolator.sample_mask-91"><a href="#LinearInterpolator.sample_mask-91"><span class="linenos">91</span></a>            <span class="n">padding_mode</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span>
</span><span id="LinearInterpolator.sample_mask-92"><a href="#LinearInterpolator.sample_mask-92"><span class="linenos">92</span></a>        <span class="p">)</span>
</span><span id="LinearInterpolator.sample_mask-93"><a href="#LinearInterpolator.sample_mask-93"><span class="linenos">93</span></a>        <span class="k">return</span> <span class="n">interpolated_mask</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask_threshold</span>
</span></pre></div>


            <div class="docstring"><p>Sample mask at spatial locations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mask:</strong>  Mask to sample over spatial dimensions
with shape (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</li>
<li><strong>coordinates:</strong>  Coordinates in voxel coordinates with shape
(*batch_shape, n_spatial_dims, *target_shape).</li>
</ul>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#BaseSeparableSampler">BaseSeparableSampler</a></dt>
                                <dd id="LinearInterpolator.derivative" class="function"><a href="#BaseSeparableSampler.derivative">derivative</a></dd>
                <dd id="LinearInterpolator.inverse" class="function"><a href="#BaseSeparableSampler.inverse">inverse</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="MappableTensor">
                            <input id="MappableTensor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MappableTensor</span><wbr>(<span class="base">composable_mapping.tensor_like.BaseTensorLikeWrapper</span>):

                <label class="view-source-button" for="MappableTensor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor-47"><a href="#MappableTensor-47"><span class="linenos"> 47</span></a><span class="k">class</span> <span class="nc">MappableTensor</span><span class="p">(</span><span class="n">BaseTensorLikeWrapper</span><span class="p">):</span>
</span><span id="MappableTensor-48"><a href="#MappableTensor-48"><span class="linenos"> 48</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A tensor wrapper used as inputs for composable mappings</span>
</span><span id="MappableTensor-49"><a href="#MappableTensor-49"><span class="linenos"> 49</span></a>
</span><span id="MappableTensor-50"><a href="#MappableTensor-50"><span class="linenos"> 50</span></a><span class="sd">    It is not recommended to create instances of this class directly, but to</span>
</span><span id="MappableTensor-51"><a href="#MappableTensor-51"><span class="linenos"> 51</span></a><span class="sd">    use instead the constructors provided in the module, or as class methods</span>
</span><span id="MappableTensor-52"><a href="#MappableTensor-52"><span class="linenos"> 52</span></a><span class="sd">    of this class: `mappable`, `voxel_grid`, `MappableTensor.from_tensor`,</span>
</span><span id="MappableTensor-53"><a href="#MappableTensor-53"><span class="linenos"> 53</span></a><span class="sd">    `MappableTensor.voxel_grid`.</span>
</span><span id="MappableTensor-54"><a href="#MappableTensor-54"><span class="linenos"> 54</span></a>
</span><span id="MappableTensor-55"><a href="#MappableTensor-55"><span class="linenos"> 55</span></a><span class="sd">    The core idea of the mappable tensor is that affine transformations applied</span>
</span><span id="MappableTensor-56"><a href="#MappableTensor-56"><span class="linenos"> 56</span></a><span class="sd">    to the tensor are not applied right away, but only when the values are</span>
</span><span id="MappableTensor-57"><a href="#MappableTensor-57"><span class="linenos"> 57</span></a><span class="sd">    generated. This allows for more efficient computation. Additionally,</span>
</span><span id="MappableTensor-58"><a href="#MappableTensor-58"><span class="linenos"> 58</span></a><span class="sd">    representing voxel coordinate grids and their transformations without</span>
</span><span id="MappableTensor-59"><a href="#MappableTensor-59"><span class="linenos"> 59</span></a><span class="sd">    generating the grid is possible. Such grids can be also combined with</span>
</span><span id="MappableTensor-60"><a href="#MappableTensor-60"><span class="linenos"> 60</span></a><span class="sd">    displacement vectors, still without generating the grid.</span>
</span><span id="MappableTensor-61"><a href="#MappableTensor-61"><span class="linenos"> 61</span></a>
</span><span id="MappableTensor-62"><a href="#MappableTensor-62"><span class="linenos"> 62</span></a><span class="sd">    Masks can also be used to define valid regions of the tensor.</span>
</span><span id="MappableTensor-63"><a href="#MappableTensor-63"><span class="linenos"> 63</span></a>
</span><span id="MappableTensor-64"><a href="#MappableTensor-64"><span class="linenos"> 64</span></a><span class="sd">    Arguments:</span>
</span><span id="MappableTensor-65"><a href="#MappableTensor-65"><span class="linenos"> 65</span></a><span class="sd">        displacements: Displacement vectors, tensor with shape</span>
</span><span id="MappableTensor-66"><a href="#MappableTensor-66"><span class="linenos"> 66</span></a><span class="sd">            (*batch_shape, *channels_shape, *spatial_shape).</span>
</span><span id="MappableTensor-67"><a href="#MappableTensor-67"><span class="linenos"> 67</span></a><span class="sd">        mask: Mask of the tensor with shape (*batch_shape, *(1,) *</span>
</span><span id="MappableTensor-68"><a href="#MappableTensor-68"><span class="linenos"> 68</span></a><span class="sd">            n_channel_dims, *spatial_shape).</span>
</span><span id="MappableTensor-69"><a href="#MappableTensor-69"><span class="linenos"> 69</span></a><span class="sd">        n_channel_dims: Number of channel dimensions.</span>
</span><span id="MappableTensor-70"><a href="#MappableTensor-70"><span class="linenos"> 70</span></a><span class="sd">        affine_transformation: Affine transformation acting on the displacements.</span>
</span><span id="MappableTensor-71"><a href="#MappableTensor-71"><span class="linenos"> 71</span></a><span class="sd">        grid: Definition of a grid added to the displacements.</span>
</span><span id="MappableTensor-72"><a href="#MappableTensor-72"><span class="linenos"> 72</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MappableTensor-73"><a href="#MappableTensor-73"><span class="linenos"> 73</span></a>
</span><span id="MappableTensor-74"><a href="#MappableTensor-74"><span class="linenos"> 74</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="MappableTensor-75"><a href="#MappableTensor-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-76"><a href="#MappableTensor-76"><span class="linenos"> 76</span></a>        <span class="n">displacements</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-77"><a href="#MappableTensor-77"><span class="linenos"> 77</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-78"><a href="#MappableTensor-78"><span class="linenos"> 78</span></a>        <span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="MappableTensor-79"><a href="#MappableTensor-79"><span class="linenos"> 79</span></a>        <span class="n">affine_transformation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IAffineTransformation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-80"><a href="#MappableTensor-80"><span class="linenos"> 80</span></a>        <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridDefinition</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-81"><a href="#MappableTensor-81"><span class="linenos"> 81</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-82"><a href="#MappableTensor-82"><span class="linenos"> 82</span></a>        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-83"><a href="#MappableTensor-83"><span class="linenos"> 83</span></a>            <span class="n">mask_channels_shape</span> <span class="o">=</span> <span class="n">get_channels_shape</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-84"><a href="#MappableTensor-84"><span class="linenos"> 84</span></a>            <span class="k">if</span> <span class="n">mask_channels_shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="n">n_channel_dims</span><span class="p">:</span>
</span><span id="MappableTensor-85"><a href="#MappableTensor-85"><span class="linenos"> 85</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mask must dimension with size 1 in all channel dimensions&quot;</span><span class="p">)</span>
</span><span id="MappableTensor-86"><a href="#MappableTensor-86"><span class="linenos"> 86</span></a>        <span class="k">if</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_channel_dims</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MappableTensor-87"><a href="#MappableTensor-87"><span class="linenos"> 87</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;When no displacements is set, n_channel_dims must be 1&quot;</span><span class="p">)</span>
</span><span id="MappableTensor-88"><a href="#MappableTensor-88"><span class="linenos"> 88</span></a>        <span class="k">if</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-89"><a href="#MappableTensor-89"><span class="linenos"> 89</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either displacements, or grid must be set.&quot;</span><span class="p">)</span>
</span><span id="MappableTensor-90"><a href="#MappableTensor-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span> <span class="o">=</span> <span class="n">displacements</span>
</span><span id="MappableTensor-91"><a href="#MappableTensor-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">=</span> <span class="n">mask</span>
</span><span id="MappableTensor-92"><a href="#MappableTensor-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span> <span class="o">=</span> <span class="n">n_channel_dims</span>
</span><span id="MappableTensor-93"><a href="#MappableTensor-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MappableTensor-94"><a href="#MappableTensor-94"><span class="linenos"> 94</span></a>            <span class="n">IdentityAffineTransformation</span><span class="p">(</span>
</span><span id="MappableTensor-95"><a href="#MappableTensor-95"><span class="linenos"> 95</span></a>                <span class="n">get_channels_shape</span><span class="p">(</span><span class="n">displacements</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="MappableTensor-96"><a href="#MappableTensor-96"><span class="linenos"> 96</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="n">displacements</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="MappableTensor-97"><a href="#MappableTensor-97"><span class="linenos"> 97</span></a>                <span class="n">device</span><span class="o">=</span><span class="n">displacements</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="MappableTensor-98"><a href="#MappableTensor-98"><span class="linenos"> 98</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-99"><a href="#MappableTensor-99"><span class="linenos"> 99</span></a>            <span class="k">if</span> <span class="n">affine_transformation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="MappableTensor-100"><a href="#MappableTensor-100"><span class="linenos">100</span></a>            <span class="k">else</span> <span class="n">affine_transformation</span>
</span><span id="MappableTensor-101"><a href="#MappableTensor-101"><span class="linenos">101</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-102"><a href="#MappableTensor-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="o">=</span> <span class="n">grid</span>
</span><span id="MappableTensor-103"><a href="#MappableTensor-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_shape</span><span class="p">()</span>
</span><span id="MappableTensor-104"><a href="#MappableTensor-104"><span class="linenos">104</span></a>
</span><span id="MappableTensor-105"><a href="#MappableTensor-105"><span class="linenos">105</span></a>    <span class="nd">@classmethod</span>
</span><span id="MappableTensor-106"><a href="#MappableTensor-106"><span class="linenos">106</span></a>    <span class="k">def</span> <span class="nf">from_tensor</span><span class="p">(</span>
</span><span id="MappableTensor-107"><a href="#MappableTensor-107"><span class="linenos">107</span></a>        <span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MappableTensor-108"><a href="#MappableTensor-108"><span class="linenos">108</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-109"><a href="#MappableTensor-109"><span class="linenos">109</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a mappable tensor from values and mask</span>
</span><span id="MappableTensor-110"><a href="#MappableTensor-110"><span class="linenos">110</span></a>
</span><span id="MappableTensor-111"><a href="#MappableTensor-111"><span class="linenos">111</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor-112"><a href="#MappableTensor-112"><span class="linenos">112</span></a><span class="sd">            values: Values of the generated mappable tensor, tensor with shape</span>
</span><span id="MappableTensor-113"><a href="#MappableTensor-113"><span class="linenos">113</span></a><span class="sd">                (*batch_shape, *channels_shape, *spatial_shape).</span>
</span><span id="MappableTensor-114"><a href="#MappableTensor-114"><span class="linenos">114</span></a><span class="sd">            mask: Mask of the generated mapable tensor with shape</span>
</span><span id="MappableTensor-115"><a href="#MappableTensor-115"><span class="linenos">115</span></a><span class="sd">                (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</span>
</span><span id="MappableTensor-116"><a href="#MappableTensor-116"><span class="linenos">116</span></a><span class="sd">            n_channel_dims: Number of channel dimensions.</span>
</span><span id="MappableTensor-117"><a href="#MappableTensor-117"><span class="linenos">117</span></a>
</span><span id="MappableTensor-118"><a href="#MappableTensor-118"><span class="linenos">118</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor-119"><a href="#MappableTensor-119"><span class="linenos">119</span></a><span class="sd">            Mappable tensor.</span>
</span><span id="MappableTensor-120"><a href="#MappableTensor-120"><span class="linenos">120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-121"><a href="#MappableTensor-121"><span class="linenos">121</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span><span class="n">displacements</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-122"><a href="#MappableTensor-122"><span class="linenos">122</span></a>
</span><span id="MappableTensor-123"><a href="#MappableTensor-123"><span class="linenos">123</span></a>    <span class="nd">@classmethod</span>
</span><span id="MappableTensor-124"><a href="#MappableTensor-124"><span class="linenos">124</span></a>    <span class="k">def</span> <span class="nf">voxel_grid</span><span class="p">(</span>
</span><span id="MappableTensor-125"><a href="#MappableTensor-125"><span class="linenos">125</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="MappableTensor-126"><a href="#MappableTensor-126"><span class="linenos">126</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="MappableTensor-127"><a href="#MappableTensor-127"><span class="linenos">127</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-128"><a href="#MappableTensor-128"><span class="linenos">128</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-129"><a href="#MappableTensor-129"><span class="linenos">129</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-130"><a href="#MappableTensor-130"><span class="linenos">130</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-131"><a href="#MappableTensor-131"><span class="linenos">131</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a voxel grid with optional mask.</span>
</span><span id="MappableTensor-132"><a href="#MappableTensor-132"><span class="linenos">132</span></a>
</span><span id="MappableTensor-133"><a href="#MappableTensor-133"><span class="linenos">133</span></a><span class="sd">        The voxel grid is not generated explicitly right away, but only when the</span>
</span><span id="MappableTensor-134"><a href="#MappableTensor-134"><span class="linenos">134</span></a><span class="sd">        values are generated.</span>
</span><span id="MappableTensor-135"><a href="#MappableTensor-135"><span class="linenos">135</span></a>
</span><span id="MappableTensor-136"><a href="#MappableTensor-136"><span class="linenos">136</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor-137"><a href="#MappableTensor-137"><span class="linenos">137</span></a><span class="sd">            spatial_shape: Spatial shape of the created grid.</span>
</span><span id="MappableTensor-138"><a href="#MappableTensor-138"><span class="linenos">138</span></a><span class="sd">            mask: Mask of the grid with shape</span>
</span><span id="MappableTensor-139"><a href="#MappableTensor-139"><span class="linenos">139</span></a><span class="sd">                (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</span>
</span><span id="MappableTensor-140"><a href="#MappableTensor-140"><span class="linenos">140</span></a><span class="sd">            dtype: Data type of the grid.</span>
</span><span id="MappableTensor-141"><a href="#MappableTensor-141"><span class="linenos">141</span></a><span class="sd">            device: Device of the grid.</span>
</span><span id="MappableTensor-142"><a href="#MappableTensor-142"><span class="linenos">142</span></a>
</span><span id="MappableTensor-143"><a href="#MappableTensor-143"><span class="linenos">143</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor-144"><a href="#MappableTensor-144"><span class="linenos">144</span></a><span class="sd">            Mappable tensor representing the voxel grid.</span>
</span><span id="MappableTensor-145"><a href="#MappableTensor-145"><span class="linenos">145</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-146"><a href="#MappableTensor-146"><span class="linenos">146</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor-147"><a href="#MappableTensor-147"><span class="linenos">147</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor-148"><a href="#MappableTensor-148"><span class="linenos">148</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="MappableTensor-149"><a href="#MappableTensor-149"><span class="linenos">149</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">GridDefinition</span><span class="p">(</span>
</span><span id="MappableTensor-150"><a href="#MappableTensor-150"><span class="linenos">150</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor-151"><a href="#MappableTensor-151"><span class="linenos">151</span></a>                <span class="n">affine_transformation</span><span class="o">=</span><span class="n">IdentityAffineTransformation</span><span class="p">(</span>
</span><span id="MappableTensor-152"><a href="#MappableTensor-152"><span class="linenos">152</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
</span><span id="MappableTensor-153"><a href="#MappableTensor-153"><span class="linenos">153</span></a>                <span class="p">),</span>
</span><span id="MappableTensor-154"><a href="#MappableTensor-154"><span class="linenos">154</span></a>            <span class="p">),</span>
</span><span id="MappableTensor-155"><a href="#MappableTensor-155"><span class="linenos">155</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-156"><a href="#MappableTensor-156"><span class="linenos">156</span></a>
</span><span id="MappableTensor-157"><a href="#MappableTensor-157"><span class="linenos">157</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-158"><a href="#MappableTensor-158"><span class="linenos">158</span></a>    <span class="k">def</span> <span class="nf">_transformed_displacements_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
</span><span id="MappableTensor-159"><a href="#MappableTensor-159"><span class="linenos">159</span></a>        <span class="n">displacements_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MappableTensor-160"><a href="#MappableTensor-160"><span class="linenos">160</span></a>            <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="o">.</span><span class="n">shape</span>
</span><span id="MappableTensor-161"><a href="#MappableTensor-161"><span class="linenos">161</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-162"><a href="#MappableTensor-162"><span class="linenos">162</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-163"><a href="#MappableTensor-163"><span class="linenos">163</span></a>            <span class="k">if</span> <span class="n">displacements_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-164"><a href="#MappableTensor-164"><span class="linenos">164</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Affine transformation may be set only if displacements is set&quot;</span><span class="p">)</span>
</span><span id="MappableTensor-165"><a href="#MappableTensor-165"><span class="linenos">165</span></a>            <span class="n">displacements_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span><span class="o">.</span><span class="n">get_output_shape</span><span class="p">(</span>
</span><span id="MappableTensor-166"><a href="#MappableTensor-166"><span class="linenos">166</span></a>                <span class="n">displacements_shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span><span id="MappableTensor-167"><a href="#MappableTensor-167"><span class="linenos">167</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-168"><a href="#MappableTensor-168"><span class="linenos">168</span></a>        <span class="k">return</span> <span class="n">displacements_shape</span>
</span><span id="MappableTensor-169"><a href="#MappableTensor-169"><span class="linenos">169</span></a>
</span><span id="MappableTensor-170"><a href="#MappableTensor-170"><span class="linenos">170</span></a>    <span class="k">def</span> <span class="nf">_infer_shape</span><span class="p">(</span>
</span><span id="MappableTensor-171"><a href="#MappableTensor-171"><span class="linenos">171</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-172"><a href="#MappableTensor-172"><span class="linenos">172</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor-173"><a href="#MappableTensor-173"><span class="linenos">173</span></a>        <span class="n">displacements_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transformed_displacements_shape</span>
</span><span id="MappableTensor-174"><a href="#MappableTensor-174"><span class="linenos">174</span></a>        <span class="k">return</span> <span class="n">broadcast_optional_shapes_in_parts_to_single_shape</span><span class="p">(</span>
</span><span id="MappableTensor-175"><a href="#MappableTensor-175"><span class="linenos">175</span></a>            <span class="n">displacements_shape</span><span class="p">,</span>
</span><span id="MappableTensor-176"><a href="#MappableTensor-176"><span class="linenos">176</span></a>            <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="MappableTensor-177"><a href="#MappableTensor-177"><span class="linenos">177</span></a>            <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="MappableTensor-178"><a href="#MappableTensor-178"><span class="linenos">178</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-179"><a href="#MappableTensor-179"><span class="linenos">179</span></a>
</span><span id="MappableTensor-180"><a href="#MappableTensor-180"><span class="linenos">180</span></a>    <span class="k">def</span> <span class="nf">_get_tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="MappableTensor-181"><a href="#MappableTensor-181"><span class="linenos">181</span></a>        <span class="n">tensors</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MappableTensor-182"><a href="#MappableTensor-182"><span class="linenos">182</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-183"><a href="#MappableTensor-183"><span class="linenos">183</span></a>            <span class="n">tensors</span><span class="p">[</span><span class="s2">&quot;displacements&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span>
</span><span id="MappableTensor-184"><a href="#MappableTensor-184"><span class="linenos">184</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-185"><a href="#MappableTensor-185"><span class="linenos">185</span></a>            <span class="n">tensors</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span>
</span><span id="MappableTensor-186"><a href="#MappableTensor-186"><span class="linenos">186</span></a>        <span class="k">return</span> <span class="n">tensors</span>
</span><span id="MappableTensor-187"><a href="#MappableTensor-187"><span class="linenos">187</span></a>
</span><span id="MappableTensor-188"><a href="#MappableTensor-188"><span class="linenos">188</span></a>    <span class="k">def</span> <span class="nf">_get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]:</span>
</span><span id="MappableTensor-189"><a href="#MappableTensor-189"><span class="linenos">189</span></a>        <span class="n">children</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MappableTensor-190"><a href="#MappableTensor-190"><span class="linenos">190</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-191"><a href="#MappableTensor-191"><span class="linenos">191</span></a>            <span class="n">children</span><span class="p">[</span><span class="s2">&quot;affine_transformation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span>
</span><span id="MappableTensor-192"><a href="#MappableTensor-192"><span class="linenos">192</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-193"><a href="#MappableTensor-193"><span class="linenos">193</span></a>            <span class="n">children</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span>
</span><span id="MappableTensor-194"><a href="#MappableTensor-194"><span class="linenos">194</span></a>        <span class="k">return</span> <span class="n">children</span>
</span><span id="MappableTensor-195"><a href="#MappableTensor-195"><span class="linenos">195</span></a>
</span><span id="MappableTensor-196"><a href="#MappableTensor-196"><span class="linenos">196</span></a>    <span class="k">def</span> <span class="nf">_modified_copy</span><span class="p">(</span>
</span><span id="MappableTensor-197"><a href="#MappableTensor-197"><span class="linenos">197</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">tensors</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">children</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]</span>
</span><span id="MappableTensor-198"><a href="#MappableTensor-198"><span class="linenos">198</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-199"><a href="#MappableTensor-199"><span class="linenos">199</span></a>        <span class="n">affine_transformation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IAffineTransformation</span><span class="p">]</span>
</span><span id="MappableTensor-200"><a href="#MappableTensor-200"><span class="linenos">200</span></a>        <span class="k">if</span> <span class="s2">&quot;affine_transformation&quot;</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
</span><span id="MappableTensor-201"><a href="#MappableTensor-201"><span class="linenos">201</span></a>            <span class="n">affine_transformation</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">IAffineTransformation</span><span class="p">,</span> <span class="n">children</span><span class="p">[</span><span class="s2">&quot;affine_transformation&quot;</span><span class="p">])</span>
</span><span id="MappableTensor-202"><a href="#MappableTensor-202"><span class="linenos">202</span></a>
</span><span id="MappableTensor-203"><a href="#MappableTensor-203"><span class="linenos">203</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor-204"><a href="#MappableTensor-204"><span class="linenos">204</span></a>            <span class="n">affine_transformation</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor-205"><a href="#MappableTensor-205"><span class="linenos">205</span></a>        <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridDefinition</span><span class="p">]</span>
</span><span id="MappableTensor-206"><a href="#MappableTensor-206"><span class="linenos">206</span></a>        <span class="k">if</span> <span class="s2">&quot;grid&quot;</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
</span><span id="MappableTensor-207"><a href="#MappableTensor-207"><span class="linenos">207</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">GridDefinition</span><span class="p">,</span> <span class="n">children</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">])</span>
</span><span id="MappableTensor-208"><a href="#MappableTensor-208"><span class="linenos">208</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor-209"><a href="#MappableTensor-209"><span class="linenos">209</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor-210"><a href="#MappableTensor-210"><span class="linenos">210</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor-211"><a href="#MappableTensor-211"><span class="linenos">211</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="n">tensors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;displacements&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="p">),</span>
</span><span id="MappableTensor-212"><a href="#MappableTensor-212"><span class="linenos">212</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">tensors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">),</span>
</span><span id="MappableTensor-213"><a href="#MappableTensor-213"><span class="linenos">213</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-214"><a href="#MappableTensor-214"><span class="linenos">214</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="n">affine_transformation</span><span class="p">,</span>
</span><span id="MappableTensor-215"><a href="#MappableTensor-215"><span class="linenos">215</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
</span><span id="MappableTensor-216"><a href="#MappableTensor-216"><span class="linenos">216</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-217"><a href="#MappableTensor-217"><span class="linenos">217</span></a>
</span><span id="MappableTensor-218"><a href="#MappableTensor-218"><span class="linenos">218</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-219"><a href="#MappableTensor-219"><span class="linenos">219</span></a>    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor-220"><a href="#MappableTensor-220"><span class="linenos">220</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Shape of the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor-221"><a href="#MappableTensor-221"><span class="linenos">221</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>
</span><span id="MappableTensor-222"><a href="#MappableTensor-222"><span class="linenos">222</span></a>
</span><span id="MappableTensor-223"><a href="#MappableTensor-223"><span class="linenos">223</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-224"><a href="#MappableTensor-224"><span class="linenos">224</span></a>    <span class="k">def</span> <span class="nf">spatial_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor-225"><a href="#MappableTensor-225"><span class="linenos">225</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Spatial shape of the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor-226"><a href="#MappableTensor-226"><span class="linenos">226</span></a>        <span class="k">return</span> <span class="n">get_spatial_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-227"><a href="#MappableTensor-227"><span class="linenos">227</span></a>
</span><span id="MappableTensor-228"><a href="#MappableTensor-228"><span class="linenos">228</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-229"><a href="#MappableTensor-229"><span class="linenos">229</span></a>    <span class="k">def</span> <span class="nf">channels_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor-230"><a href="#MappableTensor-230"><span class="linenos">230</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Channel shape of the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor-231"><a href="#MappableTensor-231"><span class="linenos">231</span></a>        <span class="k">return</span> <span class="n">get_channels_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-232"><a href="#MappableTensor-232"><span class="linenos">232</span></a>
</span><span id="MappableTensor-233"><a href="#MappableTensor-233"><span class="linenos">233</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-234"><a href="#MappableTensor-234"><span class="linenos">234</span></a>    <span class="k">def</span> <span class="nf">batch_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor-235"><a href="#MappableTensor-235"><span class="linenos">235</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Batch shape of the mappable tensor.&quot;&quot;&quot;</span>
</span><span id="MappableTensor-236"><a href="#MappableTensor-236"><span class="linenos">236</span></a>        <span class="k">return</span> <span class="n">get_batch_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-237"><a href="#MappableTensor-237"><span class="linenos">237</span></a>
</span><span id="MappableTensor-238"><a href="#MappableTensor-238"><span class="linenos">238</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-239"><a href="#MappableTensor-239"><span class="linenos">239</span></a>    <span class="k">def</span> <span class="nf">mask_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor-240"><a href="#MappableTensor-240"><span class="linenos">240</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Shape of the generated mask of the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor-241"><a href="#MappableTensor-241"><span class="linenos">241</span></a>        <span class="k">return</span> <span class="n">reduce_channels_shape_to_ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-242"><a href="#MappableTensor-242"><span class="linenos">242</span></a>
</span><span id="MappableTensor-243"><a href="#MappableTensor-243"><span class="linenos">243</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-244"><a href="#MappableTensor-244"><span class="linenos">244</span></a>    <span class="k">def</span> <span class="nf">n_channel_dims</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="MappableTensor-245"><a href="#MappableTensor-245"><span class="linenos">245</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of channel dimensions&quot;&quot;&quot;</span>
</span><span id="MappableTensor-246"><a href="#MappableTensor-246"><span class="linenos">246</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span><span id="MappableTensor-247"><a href="#MappableTensor-247"><span class="linenos">247</span></a>
</span><span id="MappableTensor-248"><a href="#MappableTensor-248"><span class="linenos">248</span></a>    <span class="nd">@overload</span>
</span><span id="MappableTensor-249"><a href="#MappableTensor-249"><span class="linenos">249</span></a>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span>
</span><span id="MappableTensor-250"><a href="#MappableTensor-250"><span class="linenos">250</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-251"><a href="#MappableTensor-251"><span class="linenos">251</span></a>        <span class="n">generate_missing_mask</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="MappableTensor-252"><a href="#MappableTensor-252"><span class="linenos">252</span></a>        <span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="MappableTensor-253"><a href="#MappableTensor-253"><span class="linenos">253</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span> <span class="o">...</span>
</span><span id="MappableTensor-254"><a href="#MappableTensor-254"><span class="linenos">254</span></a>
</span><span id="MappableTensor-255"><a href="#MappableTensor-255"><span class="linenos">255</span></a>    <span class="nd">@overload</span>
</span><span id="MappableTensor-256"><a href="#MappableTensor-256"><span class="linenos">256</span></a>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span>  <span class="c1"># https://github.com/pylint-dev/pylint/issues/5264 - pylint: disable=signature-differs</span>
</span><span id="MappableTensor-257"><a href="#MappableTensor-257"><span class="linenos">257</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-258"><a href="#MappableTensor-258"><span class="linenos">258</span></a>        <span class="n">generate_missing_mask</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="MappableTensor-259"><a href="#MappableTensor-259"><span class="linenos">259</span></a>        <span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="MappableTensor-260"><a href="#MappableTensor-260"><span class="linenos">260</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]]:</span> <span class="o">...</span>
</span><span id="MappableTensor-261"><a href="#MappableTensor-261"><span class="linenos">261</span></a>
</span><span id="MappableTensor-262"><a href="#MappableTensor-262"><span class="linenos">262</span></a>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span>
</span><span id="MappableTensor-263"><a href="#MappableTensor-263"><span class="linenos">263</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-264"><a href="#MappableTensor-264"><span class="linenos">264</span></a>        <span class="n">generate_missing_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="MappableTensor-265"><a href="#MappableTensor-265"><span class="linenos">265</span></a>        <span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="MappableTensor-266"><a href="#MappableTensor-266"><span class="linenos">266</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]]:</span>
</span><span id="MappableTensor-267"><a href="#MappableTensor-267"><span class="linenos">267</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate values and mask contained by the mappable tensor.</span>
</span><span id="MappableTensor-268"><a href="#MappableTensor-268"><span class="linenos">268</span></a>
</span><span id="MappableTensor-269"><a href="#MappableTensor-269"><span class="linenos">269</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor-270"><a href="#MappableTensor-270"><span class="linenos">270</span></a><span class="sd">            generate_mask: Generate mask of ones if the tensor does not contain an explicit mask.</span>
</span><span id="MappableTensor-271"><a href="#MappableTensor-271"><span class="linenos">271</span></a><span class="sd">            cast_mask: Mask is stored as a boolean tensor, cast it to dtype of values if True.</span>
</span><span id="MappableTensor-272"><a href="#MappableTensor-272"><span class="linenos">272</span></a>
</span><span id="MappableTensor-273"><a href="#MappableTensor-273"><span class="linenos">273</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor-274"><a href="#MappableTensor-274"><span class="linenos">274</span></a><span class="sd">            Tuple of values and mask.</span>
</span><span id="MappableTensor-275"><a href="#MappableTensor-275"><span class="linenos">275</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-276"><a href="#MappableTensor-276"><span class="linenos">276</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_mask</span><span class="p">(</span>
</span><span id="MappableTensor-277"><a href="#MappableTensor-277"><span class="linenos">277</span></a>            <span class="n">generate_missing_mask</span><span class="o">=</span><span class="n">generate_missing_mask</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="n">cast_mask</span>
</span><span id="MappableTensor-278"><a href="#MappableTensor-278"><span class="linenos">278</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-279"><a href="#MappableTensor-279"><span class="linenos">279</span></a>
</span><span id="MappableTensor-280"><a href="#MappableTensor-280"><span class="linenos">280</span></a>    <span class="k">def</span> <span class="nf">generate_values</span><span class="p">(</span>
</span><span id="MappableTensor-281"><a href="#MappableTensor-281"><span class="linenos">281</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-282"><a href="#MappableTensor-282"><span class="linenos">282</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="MappableTensor-283"><a href="#MappableTensor-283"><span class="linenos">283</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate values contained by the mappable tensor.&quot;&quot;&quot;</span>
</span><span id="MappableTensor-284"><a href="#MappableTensor-284"><span class="linenos">284</span></a>        <span class="n">batch_shape</span><span class="p">,</span> <span class="n">channels_shape</span><span class="p">,</span> <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">split_shape</span><span class="p">(</span>
</span><span id="MappableTensor-285"><a href="#MappableTensor-285"><span class="linenos">285</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span><span id="MappableTensor-286"><a href="#MappableTensor-286"><span class="linenos">286</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-287"><a href="#MappableTensor-287"><span class="linenos">287</span></a>        <span class="n">displacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span>
</span><span id="MappableTensor-288"><a href="#MappableTensor-288"><span class="linenos">288</span></a>        <span class="k">if</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-289"><a href="#MappableTensor-289"><span class="linenos">289</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-290"><a href="#MappableTensor-290"><span class="linenos">290</span></a>                <span class="n">displacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span><span class="p">(</span>
</span><span id="MappableTensor-291"><a href="#MappableTensor-291"><span class="linenos">291</span></a>                    <span class="n">displacements</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span><span id="MappableTensor-292"><a href="#MappableTensor-292"><span class="linenos">292</span></a>                <span class="p">)</span>
</span><span id="MappableTensor-293"><a href="#MappableTensor-293"><span class="linenos">293</span></a>            <span class="n">displacements</span> <span class="o">=</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-294"><a href="#MappableTensor-294"><span class="linenos">294</span></a>                <span class="n">displacements</span><span class="p">,</span>
</span><span id="MappableTensor-295"><a href="#MappableTensor-295"><span class="linenos">295</span></a>                <span class="n">batch_shape</span><span class="o">=</span><span class="n">batch_shape</span><span class="p">,</span>
</span><span id="MappableTensor-296"><a href="#MappableTensor-296"><span class="linenos">296</span></a>                <span class="n">channels_shape</span><span class="o">=</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="MappableTensor-297"><a href="#MappableTensor-297"><span class="linenos">297</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor-298"><a href="#MappableTensor-298"><span class="linenos">298</span></a>                <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-299"><a href="#MappableTensor-299"><span class="linenos">299</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-300"><a href="#MappableTensor-300"><span class="linenos">300</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">is_zero</span><span class="p">():</span>
</span><span id="MappableTensor-301"><a href="#MappableTensor-301"><span class="linenos">301</span></a>            <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor-302"><a href="#MappableTensor-302"><span class="linenos">302</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor-303"><a href="#MappableTensor-303"><span class="linenos">303</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-304"><a href="#MappableTensor-304"><span class="linenos">304</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">generate</span><span class="p">(),</span>
</span><span id="MappableTensor-305"><a href="#MappableTensor-305"><span class="linenos">305</span></a>                <span class="n">batch_shape</span><span class="o">=</span><span class="n">batch_shape</span><span class="p">,</span>
</span><span id="MappableTensor-306"><a href="#MappableTensor-306"><span class="linenos">306</span></a>                <span class="n">channels_shape</span><span class="o">=</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="MappableTensor-307"><a href="#MappableTensor-307"><span class="linenos">307</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor-308"><a href="#MappableTensor-308"><span class="linenos">308</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-309"><a href="#MappableTensor-309"><span class="linenos">309</span></a>        <span class="k">if</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-310"><a href="#MappableTensor-310"><span class="linenos">310</span></a>            <span class="n">values</span> <span class="o">=</span> <span class="n">grid</span>
</span><span id="MappableTensor-311"><a href="#MappableTensor-311"><span class="linenos">311</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor-312"><a href="#MappableTensor-312"><span class="linenos">312</span></a>            <span class="n">values</span> <span class="o">=</span> <span class="n">displacements</span>
</span><span id="MappableTensor-313"><a href="#MappableTensor-313"><span class="linenos">313</span></a>        <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-314"><a href="#MappableTensor-314"><span class="linenos">314</span></a>            <span class="k">return</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="MappableTensor-315"><a href="#MappableTensor-315"><span class="linenos">315</span></a>        <span class="k">return</span> <span class="n">values</span>
</span><span id="MappableTensor-316"><a href="#MappableTensor-316"><span class="linenos">316</span></a>
</span><span id="MappableTensor-317"><a href="#MappableTensor-317"><span class="linenos">317</span></a>    <span class="nd">@overload</span>
</span><span id="MappableTensor-318"><a href="#MappableTensor-318"><span class="linenos">318</span></a>    <span class="k">def</span> <span class="nf">generate_mask</span><span class="p">(</span>
</span><span id="MappableTensor-319"><a href="#MappableTensor-319"><span class="linenos">319</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-320"><a href="#MappableTensor-320"><span class="linenos">320</span></a>        <span class="n">generate_missing_mask</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="MappableTensor-321"><a href="#MappableTensor-321"><span class="linenos">321</span></a>        <span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="MappableTensor-322"><a href="#MappableTensor-322"><span class="linenos">322</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span> <span class="o">...</span>
</span><span id="MappableTensor-323"><a href="#MappableTensor-323"><span class="linenos">323</span></a>
</span><span id="MappableTensor-324"><a href="#MappableTensor-324"><span class="linenos">324</span></a>    <span class="nd">@overload</span>
</span><span id="MappableTensor-325"><a href="#MappableTensor-325"><span class="linenos">325</span></a>    <span class="k">def</span> <span class="nf">generate_mask</span><span class="p">(</span>  <span class="c1"># https://github.com/pylint-dev/pylint/issues/5264 - pylint: disable=signature-differs</span>
</span><span id="MappableTensor-326"><a href="#MappableTensor-326"><span class="linenos">326</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-327"><a href="#MappableTensor-327"><span class="linenos">327</span></a>        <span class="n">generate_missing_mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]],</span>
</span><span id="MappableTensor-328"><a href="#MappableTensor-328"><span class="linenos">328</span></a>        <span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="MappableTensor-329"><a href="#MappableTensor-329"><span class="linenos">329</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span> <span class="o">...</span>
</span><span id="MappableTensor-330"><a href="#MappableTensor-330"><span class="linenos">330</span></a>
</span><span id="MappableTensor-331"><a href="#MappableTensor-331"><span class="linenos">331</span></a>    <span class="k">def</span> <span class="nf">generate_mask</span><span class="p">(</span>
</span><span id="MappableTensor-332"><a href="#MappableTensor-332"><span class="linenos">332</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-333"><a href="#MappableTensor-333"><span class="linenos">333</span></a>        <span class="n">generate_missing_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="MappableTensor-334"><a href="#MappableTensor-334"><span class="linenos">334</span></a>        <span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="MappableTensor-335"><a href="#MappableTensor-335"><span class="linenos">335</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
</span><span id="MappableTensor-336"><a href="#MappableTensor-336"><span class="linenos">336</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate mask contained by the mappable tensor.</span>
</span><span id="MappableTensor-337"><a href="#MappableTensor-337"><span class="linenos">337</span></a>
</span><span id="MappableTensor-338"><a href="#MappableTensor-338"><span class="linenos">338</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor-339"><a href="#MappableTensor-339"><span class="linenos">339</span></a><span class="sd">            generate_mask: Generate mask of ones if the tensor does not contain an explicit mask.</span>
</span><span id="MappableTensor-340"><a href="#MappableTensor-340"><span class="linenos">340</span></a><span class="sd">            cast_mask: Mask is stored as a boolean tensor, cast it to dtype of values if True.</span>
</span><span id="MappableTensor-341"><a href="#MappableTensor-341"><span class="linenos">341</span></a>
</span><span id="MappableTensor-342"><a href="#MappableTensor-342"><span class="linenos">342</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor-343"><a href="#MappableTensor-343"><span class="linenos">343</span></a><span class="sd">            Mask of the mappable tensor.</span>
</span><span id="MappableTensor-344"><a href="#MappableTensor-344"><span class="linenos">344</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-345"><a href="#MappableTensor-345"><span class="linenos">345</span></a>        <span class="n">target_dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="k">if</span> <span class="n">cast_mask</span> <span class="k">else</span> <span class="n">torch_bool</span>
</span><span id="MappableTensor-346"><a href="#MappableTensor-346"><span class="linenos">346</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-347"><a href="#MappableTensor-347"><span class="linenos">347</span></a>            <span class="n">batch_shape</span><span class="p">,</span> <span class="n">channels_shape</span><span class="p">,</span> <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">split_shape</span><span class="p">(</span>
</span><span id="MappableTensor-348"><a href="#MappableTensor-348"><span class="linenos">348</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mask_shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span><span id="MappableTensor-349"><a href="#MappableTensor-349"><span class="linenos">349</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-350"><a href="#MappableTensor-350"><span class="linenos">350</span></a>            <span class="k">return</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-351"><a href="#MappableTensor-351"><span class="linenos">351</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">),</span>
</span><span id="MappableTensor-352"><a href="#MappableTensor-352"><span class="linenos">352</span></a>                <span class="n">batch_shape</span><span class="o">=</span><span class="n">batch_shape</span><span class="p">,</span>
</span><span id="MappableTensor-353"><a href="#MappableTensor-353"><span class="linenos">353</span></a>                <span class="n">channels_shape</span><span class="o">=</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="MappableTensor-354"><a href="#MappableTensor-354"><span class="linenos">354</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor-355"><a href="#MappableTensor-355"><span class="linenos">355</span></a>                <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-356"><a href="#MappableTensor-356"><span class="linenos">356</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-357"><a href="#MappableTensor-357"><span class="linenos">357</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="MappableTensor-358"><a href="#MappableTensor-358"><span class="linenos">358</span></a>            <span class="n">ones</span><span class="p">(</span>
</span><span id="MappableTensor-359"><a href="#MappableTensor-359"><span class="linenos">359</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mask_shape</span><span class="p">,</span>
</span><span id="MappableTensor-360"><a href="#MappableTensor-360"><span class="linenos">360</span></a>                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="MappableTensor-361"><a href="#MappableTensor-361"><span class="linenos">361</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="n">target_dtype</span><span class="p">,</span>
</span><span id="MappableTensor-362"><a href="#MappableTensor-362"><span class="linenos">362</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-363"><a href="#MappableTensor-363"><span class="linenos">363</span></a>            <span class="k">if</span> <span class="n">generate_missing_mask</span>
</span><span id="MappableTensor-364"><a href="#MappableTensor-364"><span class="linenos">364</span></a>            <span class="k">else</span> <span class="kc">None</span>
</span><span id="MappableTensor-365"><a href="#MappableTensor-365"><span class="linenos">365</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-366"><a href="#MappableTensor-366"><span class="linenos">366</span></a>
</span><span id="MappableTensor-367"><a href="#MappableTensor-367"><span class="linenos">367</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-368"><a href="#MappableTensor-368"><span class="linenos">368</span></a>    <span class="k">def</span> <span class="nf">displacements</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
</span><span id="MappableTensor-369"><a href="#MappableTensor-369"><span class="linenos">369</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Displacements contained by the mappable tensor</span>
</span><span id="MappableTensor-370"><a href="#MappableTensor-370"><span class="linenos">370</span></a>
</span><span id="MappableTensor-371"><a href="#MappableTensor-371"><span class="linenos">371</span></a><span class="sd">        The displacements vector might not have the same shape as the mappable</span>
</span><span id="MappableTensor-372"><a href="#MappableTensor-372"><span class="linenos">372</span></a><span class="sd">        tensor, but is brodcastable to it. This is a relatively low level</span>
</span><span id="MappableTensor-373"><a href="#MappableTensor-373"><span class="linenos">373</span></a><span class="sd">        property and the recommended way to access the values is through the</span>
</span><span id="MappableTensor-374"><a href="#MappableTensor-374"><span class="linenos">374</span></a><span class="sd">        `generate_values` method.</span>
</span><span id="MappableTensor-375"><a href="#MappableTensor-375"><span class="linenos">375</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-376"><a href="#MappableTensor-376"><span class="linenos">376</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span>
</span><span id="MappableTensor-377"><a href="#MappableTensor-377"><span class="linenos">377</span></a>
</span><span id="MappableTensor-378"><a href="#MappableTensor-378"><span class="linenos">378</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-379"><a href="#MappableTensor-379"><span class="linenos">379</span></a>    <span class="k">def</span> <span class="nf">affine_transformation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IAffineTransformation</span><span class="p">]:</span>
</span><span id="MappableTensor-380"><a href="#MappableTensor-380"><span class="linenos">380</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Affine transformation on displacements, if available</span>
</span><span id="MappableTensor-381"><a href="#MappableTensor-381"><span class="linenos">381</span></a>
</span><span id="MappableTensor-382"><a href="#MappableTensor-382"><span class="linenos">382</span></a><span class="sd">        This is relatively low level property, and should be used with caution.</span>
</span><span id="MappableTensor-383"><a href="#MappableTensor-383"><span class="linenos">383</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-384"><a href="#MappableTensor-384"><span class="linenos">384</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span>
</span><span id="MappableTensor-385"><a href="#MappableTensor-385"><span class="linenos">385</span></a>
</span><span id="MappableTensor-386"><a href="#MappableTensor-386"><span class="linenos">386</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-387"><a href="#MappableTensor-387"><span class="linenos">387</span></a>    <span class="k">def</span> <span class="nf">grid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridDefinition</span><span class="p">]:</span>
</span><span id="MappableTensor-388"><a href="#MappableTensor-388"><span class="linenos">388</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Definition of the grid contained by the tensor, if available</span>
</span><span id="MappableTensor-389"><a href="#MappableTensor-389"><span class="linenos">389</span></a>
</span><span id="MappableTensor-390"><a href="#MappableTensor-390"><span class="linenos">390</span></a><span class="sd">        The grid might not have the same shape as the mappable tensor, but is</span>
</span><span id="MappableTensor-391"><a href="#MappableTensor-391"><span class="linenos">391</span></a><span class="sd">        brodcastable to it. This is relatively low level method, and should be</span>
</span><span id="MappableTensor-392"><a href="#MappableTensor-392"><span class="linenos">392</span></a><span class="sd">        used with caution.</span>
</span><span id="MappableTensor-393"><a href="#MappableTensor-393"><span class="linenos">393</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-394"><a href="#MappableTensor-394"><span class="linenos">394</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span>
</span><span id="MappableTensor-395"><a href="#MappableTensor-395"><span class="linenos">395</span></a>
</span><span id="MappableTensor-396"><a href="#MappableTensor-396"><span class="linenos">396</span></a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">affine_transformation</span><span class="p">:</span> <span class="n">IAffineTransformation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-397"><a href="#MappableTensor-397"><span class="linenos">397</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply an affine transformation to the last channel dimension of the</span>
</span><span id="MappableTensor-398"><a href="#MappableTensor-398"><span class="linenos">398</span></a><span class="sd">        mappable tensor.</span>
</span><span id="MappableTensor-399"><a href="#MappableTensor-399"><span class="linenos">399</span></a>
</span><span id="MappableTensor-400"><a href="#MappableTensor-400"><span class="linenos">400</span></a><span class="sd">        The affine transformation is not applied right a way, only the</span>
</span><span id="MappableTensor-401"><a href="#MappableTensor-401"><span class="linenos">401</span></a><span class="sd">        composition with the existing affine transformation is stored. The</span>
</span><span id="MappableTensor-402"><a href="#MappableTensor-402"><span class="linenos">402</span></a><span class="sd">        transformation is applied when the values are generated.</span>
</span><span id="MappableTensor-403"><a href="#MappableTensor-403"><span class="linenos">403</span></a>
</span><span id="MappableTensor-404"><a href="#MappableTensor-404"><span class="linenos">404</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor-405"><a href="#MappableTensor-405"><span class="linenos">405</span></a><span class="sd">            affine_transformation: Affine transformation to apply.</span>
</span><span id="MappableTensor-406"><a href="#MappableTensor-406"><span class="linenos">406</span></a>
</span><span id="MappableTensor-407"><a href="#MappableTensor-407"><span class="linenos">407</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor-408"><a href="#MappableTensor-408"><span class="linenos">408</span></a><span class="sd">            Transformed mappable tensor.</span>
</span><span id="MappableTensor-409"><a href="#MappableTensor-409"><span class="linenos">409</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-410"><a href="#MappableTensor-410"><span class="linenos">410</span></a>        <span class="n">n_affine_transformation_input_channels</span> <span class="o">=</span> <span class="n">affine_transformation</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="MappableTensor-411"><a href="#MappableTensor-411"><span class="linenos">411</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">n_affine_transformation_input_channels</span><span class="p">:</span>
</span><span id="MappableTensor-412"><a href="#MappableTensor-412"><span class="linenos">412</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Affine transformation must have matching input channels&quot;</span><span class="p">)</span>
</span><span id="MappableTensor-413"><a href="#MappableTensor-413"><span class="linenos">413</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-414"><a href="#MappableTensor-414"><span class="linenos">414</span></a>            <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridDefinition</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor-415"><a href="#MappableTensor-415"><span class="linenos">415</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor-416"><a href="#MappableTensor-416"><span class="linenos">416</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">is_transformable</span><span class="p">(</span><span class="n">affine_transformation</span><span class="p">):</span>
</span><span id="MappableTensor-417"><a href="#MappableTensor-417"><span class="linenos">417</span></a>                <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor-418"><a href="#MappableTensor-418"><span class="linenos">418</span></a>                    <span class="n">displacements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">(),</span>
</span><span id="MappableTensor-419"><a href="#MappableTensor-419"><span class="linenos">419</span></a>                    <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor-420"><a href="#MappableTensor-420"><span class="linenos">420</span></a>                    <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-421"><a href="#MappableTensor-421"><span class="linenos">421</span></a>                    <span class="n">affine_transformation</span><span class="o">=</span><span class="n">affine_transformation</span><span class="p">,</span>
</span><span id="MappableTensor-422"><a href="#MappableTensor-422"><span class="linenos">422</span></a>                    <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-423"><a href="#MappableTensor-423"><span class="linenos">423</span></a>                <span class="p">)</span>
</span><span id="MappableTensor-424"><a href="#MappableTensor-424"><span class="linenos">424</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">broadcast_to_n_channels</span><span class="p">(</span>
</span><span id="MappableTensor-425"><a href="#MappableTensor-425"><span class="linenos">425</span></a>                <span class="n">n_affine_transformation_input_channels</span>
</span><span id="MappableTensor-426"><a href="#MappableTensor-426"><span class="linenos">426</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">affine_transformation</span><span class="p">)</span>
</span><span id="MappableTensor-427"><a href="#MappableTensor-427"><span class="linenos">427</span></a>            <span class="n">affine_transformation</span> <span class="o">=</span> <span class="n">affine_transformation</span><span class="o">.</span><span class="n">clear_translation</span><span class="p">()</span>
</span><span id="MappableTensor-428"><a href="#MappableTensor-428"><span class="linenos">428</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-429"><a href="#MappableTensor-429"><span class="linenos">429</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="MappableTensor-430"><a href="#MappableTensor-430"><span class="linenos">430</span></a>            <span class="n">affine_transformation_on_displacements</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IAffineTransformation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor-431"><a href="#MappableTensor-431"><span class="linenos">431</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor-432"><a href="#MappableTensor-432"><span class="linenos">432</span></a>            <span class="n">affine_transformation_on_displacements</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MappableTensor-433"><a href="#MappableTensor-433"><span class="linenos">433</span></a>                <span class="n">affine_transformation</span>
</span><span id="MappableTensor-434"><a href="#MappableTensor-434"><span class="linenos">434</span></a>                <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span><span class="o">.</span><span class="n">broadcast_to_n_output_channels</span><span class="p">(</span>
</span><span id="MappableTensor-435"><a href="#MappableTensor-435"><span class="linenos">435</span></a>                    <span class="n">n_affine_transformation_input_channels</span><span class="p">,</span>
</span><span id="MappableTensor-436"><a href="#MappableTensor-436"><span class="linenos">436</span></a>                <span class="p">)</span>
</span><span id="MappableTensor-437"><a href="#MappableTensor-437"><span class="linenos">437</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-438"><a href="#MappableTensor-438"><span class="linenos">438</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor-439"><a href="#MappableTensor-439"><span class="linenos">439</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="p">,</span>
</span><span id="MappableTensor-440"><a href="#MappableTensor-440"><span class="linenos">440</span></a>            <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor-441"><a href="#MappableTensor-441"><span class="linenos">441</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-442"><a href="#MappableTensor-442"><span class="linenos">442</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="n">affine_transformation_on_displacements</span><span class="p">,</span>
</span><span id="MappableTensor-443"><a href="#MappableTensor-443"><span class="linenos">443</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
</span><span id="MappableTensor-444"><a href="#MappableTensor-444"><span class="linenos">444</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-445"><a href="#MappableTensor-445"><span class="linenos">445</span></a>
</span><span id="MappableTensor-446"><a href="#MappableTensor-446"><span class="linenos">446</span></a>    <span class="k">def</span> <span class="fm">__rpow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;MappableTensor&quot;</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-447"><a href="#MappableTensor-447"><span class="linenos">447</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MappableTensor</span><span class="p">):</span>
</span><span id="MappableTensor-448"><a href="#MappableTensor-448"><span class="linenos">448</span></a>            <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="fm">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="MappableTensor-449"><a href="#MappableTensor-449"><span class="linenos">449</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
</span><span id="MappableTensor-450"><a href="#MappableTensor-450"><span class="linenos">450</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpow_scalar</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-451"><a href="#MappableTensor-451"><span class="linenos">451</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="MappableTensor-452"><a href="#MappableTensor-452"><span class="linenos">452</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpow_tensor</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-453"><a href="#MappableTensor-453"><span class="linenos">453</span></a>        <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span id="MappableTensor-454"><a href="#MappableTensor-454"><span class="linenos">454</span></a>
</span><span id="MappableTensor-455"><a href="#MappableTensor-455"><span class="linenos">455</span></a>    <span class="k">def</span> <span class="nf">_rpow_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-456"><a href="#MappableTensor-456"><span class="linenos">456</span></a>        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MappableTensor-457"><a href="#MappableTensor-457"><span class="linenos">457</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="MappableTensor-458"><a href="#MappableTensor-458"><span class="linenos">458</span></a>                <span class="s2">&quot;Power is ambigous since n_channel_dims is not specified. &quot;</span>
</span><span id="MappableTensor-459"><a href="#MappableTensor-459"><span class="linenos">459</span></a>                <span class="s2">&quot;Consider exponentiating with a MappableTensor instead.&quot;</span>
</span><span id="MappableTensor-460"><a href="#MappableTensor-460"><span class="linenos">460</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-461"><a href="#MappableTensor-461"><span class="linenos">461</span></a>        <span class="n">other</span> <span class="o">=</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-462"><a href="#MappableTensor-462"><span class="linenos">462</span></a>            <span class="n">other</span><span class="p">,</span>
</span><span id="MappableTensor-463"><a href="#MappableTensor-463"><span class="linenos">463</span></a>            <span class="n">batch_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_shape</span><span class="p">,</span>
</span><span id="MappableTensor-464"><a href="#MappableTensor-464"><span class="linenos">464</span></a>            <span class="n">channels_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="MappableTensor-465"><a href="#MappableTensor-465"><span class="linenos">465</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor-466"><a href="#MappableTensor-466"><span class="linenos">466</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="MappableTensor-467"><a href="#MappableTensor-467"><span class="linenos">467</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-468"><a href="#MappableTensor-468"><span class="linenos">468</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-469"><a href="#MappableTensor-469"><span class="linenos">469</span></a>            <span class="n">values</span><span class="o">=</span><span class="n">other</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">(),</span>
</span><span id="MappableTensor-470"><a href="#MappableTensor-470"><span class="linenos">470</span></a>            <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor-471"><a href="#MappableTensor-471"><span class="linenos">471</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-472"><a href="#MappableTensor-472"><span class="linenos">472</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-473"><a href="#MappableTensor-473"><span class="linenos">473</span></a>
</span><span id="MappableTensor-474"><a href="#MappableTensor-474"><span class="linenos">474</span></a>    <span class="k">def</span> <span class="nf">_rpow_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-475"><a href="#MappableTensor-475"><span class="linenos">475</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-476"><a href="#MappableTensor-476"><span class="linenos">476</span></a>            <span class="n">values</span><span class="o">=</span><span class="n">other</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">(),</span>
</span><span id="MappableTensor-477"><a href="#MappableTensor-477"><span class="linenos">477</span></a>            <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor-478"><a href="#MappableTensor-478"><span class="linenos">478</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-479"><a href="#MappableTensor-479"><span class="linenos">479</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-480"><a href="#MappableTensor-480"><span class="linenos">480</span></a>
</span><span id="MappableTensor-481"><a href="#MappableTensor-481"><span class="linenos">481</span></a>    <span class="k">def</span> <span class="fm">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;MappableTensor&quot;</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-482"><a href="#MappableTensor-482"><span class="linenos">482</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MappableTensor</span><span class="p">):</span>
</span><span id="MappableTensor-483"><a href="#MappableTensor-483"><span class="linenos">483</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pow_mappable_tensor</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-484"><a href="#MappableTensor-484"><span class="linenos">484</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
</span><span id="MappableTensor-485"><a href="#MappableTensor-485"><span class="linenos">485</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pow_scalar</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-486"><a href="#MappableTensor-486"><span class="linenos">486</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="MappableTensor-487"><a href="#MappableTensor-487"><span class="linenos">487</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pow_tensor</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-488"><a href="#MappableTensor-488"><span class="linenos">488</span></a>        <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span id="MappableTensor-489"><a href="#MappableTensor-489"><span class="linenos">489</span></a>
</span><span id="MappableTensor-490"><a href="#MappableTensor-490"><span class="linenos">490</span></a>    <span class="k">def</span> <span class="nf">_pow_mappable_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-491"><a href="#MappableTensor-491"><span class="linenos">491</span></a>        <span class="n">self_values</span><span class="p">,</span> <span class="n">self_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MappableTensor-492"><a href="#MappableTensor-492"><span class="linenos">492</span></a>        <span class="n">other_values</span><span class="p">,</span> <span class="n">other_mask</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MappableTensor-493"><a href="#MappableTensor-493"><span class="linenos">493</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">combine_optional_masks</span><span class="p">(</span>
</span><span id="MappableTensor-494"><a href="#MappableTensor-494"><span class="linenos">494</span></a>            <span class="n">self_mask</span><span class="p">,</span>
</span><span id="MappableTensor-495"><a href="#MappableTensor-495"><span class="linenos">495</span></a>            <span class="n">other_mask</span><span class="p">,</span>
</span><span id="MappableTensor-496"><a href="#MappableTensor-496"><span class="linenos">496</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">),</span>
</span><span id="MappableTensor-497"><a href="#MappableTensor-497"><span class="linenos">497</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-498"><a href="#MappableTensor-498"><span class="linenos">498</span></a>        <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-499"><a href="#MappableTensor-499"><span class="linenos">499</span></a>        <span class="n">self_values</span><span class="p">,</span> <span class="n">other_values</span> <span class="o">=</span> <span class="n">broadcast_tensors_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-500"><a href="#MappableTensor-500"><span class="linenos">500</span></a>            <span class="n">self_values</span><span class="p">,</span> <span class="n">other_values</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-501"><a href="#MappableTensor-501"><span class="linenos">501</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-502"><a href="#MappableTensor-502"><span class="linenos">502</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-503"><a href="#MappableTensor-503"><span class="linenos">503</span></a>            <span class="n">values</span><span class="o">=</span><span class="n">self_values</span><span class="o">**</span><span class="n">other_values</span><span class="p">,</span>
</span><span id="MappableTensor-504"><a href="#MappableTensor-504"><span class="linenos">504</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor-505"><a href="#MappableTensor-505"><span class="linenos">505</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-506"><a href="#MappableTensor-506"><span class="linenos">506</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-507"><a href="#MappableTensor-507"><span class="linenos">507</span></a>
</span><span id="MappableTensor-508"><a href="#MappableTensor-508"><span class="linenos">508</span></a>    <span class="k">def</span> <span class="nf">_pow_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-509"><a href="#MappableTensor-509"><span class="linenos">509</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-510"><a href="#MappableTensor-510"><span class="linenos">510</span></a>            <span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">()</span> <span class="o">**</span> <span class="n">other</span><span class="p">,</span>
</span><span id="MappableTensor-511"><a href="#MappableTensor-511"><span class="linenos">511</span></a>            <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor-512"><a href="#MappableTensor-512"><span class="linenos">512</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-513"><a href="#MappableTensor-513"><span class="linenos">513</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-514"><a href="#MappableTensor-514"><span class="linenos">514</span></a>
</span><span id="MappableTensor-515"><a href="#MappableTensor-515"><span class="linenos">515</span></a>    <span class="k">def</span> <span class="nf">_pow_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-516"><a href="#MappableTensor-516"><span class="linenos">516</span></a>        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MappableTensor-517"><a href="#MappableTensor-517"><span class="linenos">517</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="MappableTensor-518"><a href="#MappableTensor-518"><span class="linenos">518</span></a>                <span class="s2">&quot;Power is ambigous since n_channel_dims is not specified. &quot;</span>
</span><span id="MappableTensor-519"><a href="#MappableTensor-519"><span class="linenos">519</span></a>                <span class="s2">&quot;Consider exponentiating with a MappableTensor instead.&quot;</span>
</span><span id="MappableTensor-520"><a href="#MappableTensor-520"><span class="linenos">520</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-521"><a href="#MappableTensor-521"><span class="linenos">521</span></a>        <span class="n">other</span> <span class="o">=</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-522"><a href="#MappableTensor-522"><span class="linenos">522</span></a>            <span class="n">other</span><span class="p">,</span>
</span><span id="MappableTensor-523"><a href="#MappableTensor-523"><span class="linenos">523</span></a>            <span class="n">batch_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_shape</span><span class="p">,</span>
</span><span id="MappableTensor-524"><a href="#MappableTensor-524"><span class="linenos">524</span></a>            <span class="n">channels_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="MappableTensor-525"><a href="#MappableTensor-525"><span class="linenos">525</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor-526"><a href="#MappableTensor-526"><span class="linenos">526</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="MappableTensor-527"><a href="#MappableTensor-527"><span class="linenos">527</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-528"><a href="#MappableTensor-528"><span class="linenos">528</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-529"><a href="#MappableTensor-529"><span class="linenos">529</span></a>            <span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">()</span> <span class="o">**</span> <span class="n">other</span><span class="p">,</span>
</span><span id="MappableTensor-530"><a href="#MappableTensor-530"><span class="linenos">530</span></a>            <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor-531"><a href="#MappableTensor-531"><span class="linenos">531</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-532"><a href="#MappableTensor-532"><span class="linenos">532</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-533"><a href="#MappableTensor-533"><span class="linenos">533</span></a>
</span><span id="MappableTensor-534"><a href="#MappableTensor-534"><span class="linenos">534</span></a>    <span class="k">def</span> <span class="fm">__rtruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;MappableTensor&quot;</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-535"><a href="#MappableTensor-535"><span class="linenos">535</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">MappableTensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
</span><span id="MappableTensor-536"><a href="#MappableTensor-536"><span class="linenos">536</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reciprocal</span><span class="p">()</span><span class="o">.</span><span class="fm">__mul__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-537"><a href="#MappableTensor-537"><span class="linenos">537</span></a>        <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span id="MappableTensor-538"><a href="#MappableTensor-538"><span class="linenos">538</span></a>
</span><span id="MappableTensor-539"><a href="#MappableTensor-539"><span class="linenos">539</span></a>    <span class="k">def</span> <span class="nf">_reciprocal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-540"><a href="#MappableTensor-540"><span class="linenos">540</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-541"><a href="#MappableTensor-541"><span class="linenos">541</span></a>            <span class="n">values</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">(),</span>
</span><span id="MappableTensor-542"><a href="#MappableTensor-542"><span class="linenos">542</span></a>            <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor-543"><a href="#MappableTensor-543"><span class="linenos">543</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-544"><a href="#MappableTensor-544"><span class="linenos">544</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-545"><a href="#MappableTensor-545"><span class="linenos">545</span></a>
</span><span id="MappableTensor-546"><a href="#MappableTensor-546"><span class="linenos">546</span></a>    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;MappableTensor&quot;</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-547"><a href="#MappableTensor-547"><span class="linenos">547</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MappableTensor</span><span class="p">):</span>
</span><span id="MappableTensor-548"><a href="#MappableTensor-548"><span class="linenos">548</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truediv_mappable_tensor</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-549"><a href="#MappableTensor-549"><span class="linenos">549</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
</span><span id="MappableTensor-550"><a href="#MappableTensor-550"><span class="linenos">550</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__mul__</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-551"><a href="#MappableTensor-551"><span class="linenos">551</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="MappableTensor-552"><a href="#MappableTensor-552"><span class="linenos">552</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__mul__</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-553"><a href="#MappableTensor-553"><span class="linenos">553</span></a>        <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span id="MappableTensor-554"><a href="#MappableTensor-554"><span class="linenos">554</span></a>
</span><span id="MappableTensor-555"><a href="#MappableTensor-555"><span class="linenos">555</span></a>    <span class="k">def</span> <span class="nf">_truediv_mappable_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-556"><a href="#MappableTensor-556"><span class="linenos">556</span></a>        <span class="n">self_values</span><span class="p">,</span> <span class="n">self_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MappableTensor-557"><a href="#MappableTensor-557"><span class="linenos">557</span></a>        <span class="n">other_values</span><span class="p">,</span> <span class="n">other_mask</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MappableTensor-558"><a href="#MappableTensor-558"><span class="linenos">558</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">combine_optional_masks</span><span class="p">(</span>
</span><span id="MappableTensor-559"><a href="#MappableTensor-559"><span class="linenos">559</span></a>            <span class="n">self_mask</span><span class="p">,</span>
</span><span id="MappableTensor-560"><a href="#MappableTensor-560"><span class="linenos">560</span></a>            <span class="n">other_mask</span><span class="p">,</span>
</span><span id="MappableTensor-561"><a href="#MappableTensor-561"><span class="linenos">561</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">),</span>
</span><span id="MappableTensor-562"><a href="#MappableTensor-562"><span class="linenos">562</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-563"><a href="#MappableTensor-563"><span class="linenos">563</span></a>        <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-564"><a href="#MappableTensor-564"><span class="linenos">564</span></a>        <span class="n">self_values</span><span class="p">,</span> <span class="n">other_values</span> <span class="o">=</span> <span class="n">broadcast_tensors_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-565"><a href="#MappableTensor-565"><span class="linenos">565</span></a>            <span class="n">self_values</span><span class="p">,</span> <span class="n">other_values</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-566"><a href="#MappableTensor-566"><span class="linenos">566</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-567"><a href="#MappableTensor-567"><span class="linenos">567</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-568"><a href="#MappableTensor-568"><span class="linenos">568</span></a>            <span class="n">values</span><span class="o">=</span><span class="n">self_values</span> <span class="o">/</span> <span class="n">other_values</span><span class="p">,</span>
</span><span id="MappableTensor-569"><a href="#MappableTensor-569"><span class="linenos">569</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor-570"><a href="#MappableTensor-570"><span class="linenos">570</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-571"><a href="#MappableTensor-571"><span class="linenos">571</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-572"><a href="#MappableTensor-572"><span class="linenos">572</span></a>
</span><span id="MappableTensor-573"><a href="#MappableTensor-573"><span class="linenos">573</span></a>    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;MappableTensor&quot;</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-574"><a href="#MappableTensor-574"><span class="linenos">574</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MappableTensor</span><span class="p">):</span>
</span><span id="MappableTensor-575"><a href="#MappableTensor-575"><span class="linenos">575</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mul_mappable_tensor</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-576"><a href="#MappableTensor-576"><span class="linenos">576</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
</span><span id="MappableTensor-577"><a href="#MappableTensor-577"><span class="linenos">577</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mul_scalar</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-578"><a href="#MappableTensor-578"><span class="linenos">578</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="MappableTensor-579"><a href="#MappableTensor-579"><span class="linenos">579</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mul_tensor</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-580"><a href="#MappableTensor-580"><span class="linenos">580</span></a>        <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span id="MappableTensor-581"><a href="#MappableTensor-581"><span class="linenos">581</span></a>
</span><span id="MappableTensor-582"><a href="#MappableTensor-582"><span class="linenos">582</span></a>    <span class="k">def</span> <span class="nf">_mul_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-583"><a href="#MappableTensor-583"><span class="linenos">583</span></a>        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MappableTensor-584"><a href="#MappableTensor-584"><span class="linenos">584</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="MappableTensor-585"><a href="#MappableTensor-585"><span class="linenos">585</span></a>                <span class="s2">&quot;Multiplication is ambigous since n_channel_dims is not specified. &quot;</span>
</span><span id="MappableTensor-586"><a href="#MappableTensor-586"><span class="linenos">586</span></a>                <span class="s2">&quot;Multiply a MappableTensor instead or apply an affine transformation.&quot;</span>
</span><span id="MappableTensor-587"><a href="#MappableTensor-587"><span class="linenos">587</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-588"><a href="#MappableTensor-588"><span class="linenos">588</span></a>        <span class="n">n_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MappableTensor-589"><a href="#MappableTensor-589"><span class="linenos">589</span></a>        <span class="n">affine</span> <span class="o">=</span> <span class="n">DiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="MappableTensor-590"><a href="#MappableTensor-590"><span class="linenos">590</span></a>            <span class="n">diagonal</span><span class="o">=</span><span class="n">other</span><span class="p">,</span>
</span><span id="MappableTensor-591"><a href="#MappableTensor-591"><span class="linenos">591</span></a>            <span class="n">matrix_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="MappableTensor-592"><a href="#MappableTensor-592"><span class="linenos">592</span></a>            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="MappableTensor-593"><a href="#MappableTensor-593"><span class="linenos">593</span></a>            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="MappableTensor-594"><a href="#MappableTensor-594"><span class="linenos">594</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-595"><a href="#MappableTensor-595"><span class="linenos">595</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>
</span><span id="MappableTensor-596"><a href="#MappableTensor-596"><span class="linenos">596</span></a>
</span><span id="MappableTensor-597"><a href="#MappableTensor-597"><span class="linenos">597</span></a>    <span class="k">def</span> <span class="nf">_mul_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-598"><a href="#MappableTensor-598"><span class="linenos">598</span></a>        <span class="n">n_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MappableTensor-599"><a href="#MappableTensor-599"><span class="linenos">599</span></a>        <span class="n">affine</span> <span class="o">=</span> <span class="n">HostDiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="MappableTensor-600"><a href="#MappableTensor-600"><span class="linenos">600</span></a>            <span class="n">diagonal</span><span class="o">=</span><span class="n">other</span><span class="p">,</span>
</span><span id="MappableTensor-601"><a href="#MappableTensor-601"><span class="linenos">601</span></a>            <span class="n">matrix_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="MappableTensor-602"><a href="#MappableTensor-602"><span class="linenos">602</span></a>            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="MappableTensor-603"><a href="#MappableTensor-603"><span class="linenos">603</span></a>            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="MappableTensor-604"><a href="#MappableTensor-604"><span class="linenos">604</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-605"><a href="#MappableTensor-605"><span class="linenos">605</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>
</span><span id="MappableTensor-606"><a href="#MappableTensor-606"><span class="linenos">606</span></a>
</span><span id="MappableTensor-607"><a href="#MappableTensor-607"><span class="linenos">607</span></a>    <span class="k">def</span> <span class="nf">_mul_mappable_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-608"><a href="#MappableTensor-608"><span class="linenos">608</span></a>        <span class="n">self_values</span><span class="p">,</span> <span class="n">self_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MappableTensor-609"><a href="#MappableTensor-609"><span class="linenos">609</span></a>        <span class="n">other_values</span><span class="p">,</span> <span class="n">other_mask</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MappableTensor-610"><a href="#MappableTensor-610"><span class="linenos">610</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">combine_optional_masks</span><span class="p">(</span>
</span><span id="MappableTensor-611"><a href="#MappableTensor-611"><span class="linenos">611</span></a>            <span class="n">self_mask</span><span class="p">,</span>
</span><span id="MappableTensor-612"><a href="#MappableTensor-612"><span class="linenos">612</span></a>            <span class="n">other_mask</span><span class="p">,</span>
</span><span id="MappableTensor-613"><a href="#MappableTensor-613"><span class="linenos">613</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">),</span>
</span><span id="MappableTensor-614"><a href="#MappableTensor-614"><span class="linenos">614</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-615"><a href="#MappableTensor-615"><span class="linenos">615</span></a>        <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-616"><a href="#MappableTensor-616"><span class="linenos">616</span></a>        <span class="n">self_values</span><span class="p">,</span> <span class="n">other_values</span> <span class="o">=</span> <span class="n">broadcast_tensors_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-617"><a href="#MappableTensor-617"><span class="linenos">617</span></a>            <span class="n">self_values</span><span class="p">,</span> <span class="n">other_values</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-618"><a href="#MappableTensor-618"><span class="linenos">618</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-619"><a href="#MappableTensor-619"><span class="linenos">619</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-620"><a href="#MappableTensor-620"><span class="linenos">620</span></a>            <span class="n">values</span><span class="o">=</span><span class="n">self_values</span> <span class="o">*</span> <span class="n">other_values</span><span class="p">,</span>
</span><span id="MappableTensor-621"><a href="#MappableTensor-621"><span class="linenos">621</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor-622"><a href="#MappableTensor-622"><span class="linenos">622</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-623"><a href="#MappableTensor-623"><span class="linenos">623</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-624"><a href="#MappableTensor-624"><span class="linenos">624</span></a>
</span><span id="MappableTensor-625"><a href="#MappableTensor-625"><span class="linenos">625</span></a>    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;MappableTensor&quot;</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-626"><a href="#MappableTensor-626"><span class="linenos">626</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MappableTensor</span><span class="p">):</span>
</span><span id="MappableTensor-627"><a href="#MappableTensor-627"><span class="linenos">627</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_mappable_tensor</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-628"><a href="#MappableTensor-628"><span class="linenos">628</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
</span><span id="MappableTensor-629"><a href="#MappableTensor-629"><span class="linenos">629</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_scalar</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-630"><a href="#MappableTensor-630"><span class="linenos">630</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="MappableTensor-631"><a href="#MappableTensor-631"><span class="linenos">631</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_tensor</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-632"><a href="#MappableTensor-632"><span class="linenos">632</span></a>        <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span id="MappableTensor-633"><a href="#MappableTensor-633"><span class="linenos">633</span></a>
</span><span id="MappableTensor-634"><a href="#MappableTensor-634"><span class="linenos">634</span></a>    <span class="k">def</span> <span class="nf">_add_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-635"><a href="#MappableTensor-635"><span class="linenos">635</span></a>        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MappableTensor-636"><a href="#MappableTensor-636"><span class="linenos">636</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="MappableTensor-637"><a href="#MappableTensor-637"><span class="linenos">637</span></a>                <span class="s2">&quot;Addition is ambigous since n_channel_dims is not specified. &quot;</span>
</span><span id="MappableTensor-638"><a href="#MappableTensor-638"><span class="linenos">638</span></a>                <span class="s2">&quot;Add a MappableTensor instead or apply an affine transformation.&quot;</span>
</span><span id="MappableTensor-639"><a href="#MappableTensor-639"><span class="linenos">639</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-640"><a href="#MappableTensor-640"><span class="linenos">640</span></a>        <span class="n">n_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MappableTensor-641"><a href="#MappableTensor-641"><span class="linenos">641</span></a>        <span class="n">affine</span> <span class="o">=</span> <span class="n">DiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="MappableTensor-642"><a href="#MappableTensor-642"><span class="linenos">642</span></a>            <span class="n">translation</span><span class="o">=</span><span class="n">other</span><span class="p">,</span>
</span><span id="MappableTensor-643"><a href="#MappableTensor-643"><span class="linenos">643</span></a>            <span class="n">matrix_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="MappableTensor-644"><a href="#MappableTensor-644"><span class="linenos">644</span></a>            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="MappableTensor-645"><a href="#MappableTensor-645"><span class="linenos">645</span></a>            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="MappableTensor-646"><a href="#MappableTensor-646"><span class="linenos">646</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-647"><a href="#MappableTensor-647"><span class="linenos">647</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>
</span><span id="MappableTensor-648"><a href="#MappableTensor-648"><span class="linenos">648</span></a>
</span><span id="MappableTensor-649"><a href="#MappableTensor-649"><span class="linenos">649</span></a>    <span class="k">def</span> <span class="nf">_add_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-650"><a href="#MappableTensor-650"><span class="linenos">650</span></a>        <span class="n">n_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MappableTensor-651"><a href="#MappableTensor-651"><span class="linenos">651</span></a>        <span class="n">affine</span> <span class="o">=</span> <span class="n">HostDiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="MappableTensor-652"><a href="#MappableTensor-652"><span class="linenos">652</span></a>            <span class="n">translation</span><span class="o">=</span><span class="n">other</span><span class="p">,</span>
</span><span id="MappableTensor-653"><a href="#MappableTensor-653"><span class="linenos">653</span></a>            <span class="n">matrix_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="MappableTensor-654"><a href="#MappableTensor-654"><span class="linenos">654</span></a>            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="MappableTensor-655"><a href="#MappableTensor-655"><span class="linenos">655</span></a>            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="MappableTensor-656"><a href="#MappableTensor-656"><span class="linenos">656</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-657"><a href="#MappableTensor-657"><span class="linenos">657</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>
</span><span id="MappableTensor-658"><a href="#MappableTensor-658"><span class="linenos">658</span></a>
</span><span id="MappableTensor-659"><a href="#MappableTensor-659"><span class="linenos">659</span></a>    <span class="k">def</span> <span class="nf">_add_mappable_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-660"><a href="#MappableTensor-660"><span class="linenos">660</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">combine_optional_masks</span><span class="p">(</span>
</span><span id="MappableTensor-661"><a href="#MappableTensor-661"><span class="linenos">661</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">generate_mask</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="MappableTensor-662"><a href="#MappableTensor-662"><span class="linenos">662</span></a>            <span class="n">other</span><span class="o">.</span><span class="n">generate_mask</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="MappableTensor-663"><a href="#MappableTensor-663"><span class="linenos">663</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">),</span>
</span><span id="MappableTensor-664"><a href="#MappableTensor-664"><span class="linenos">664</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-665"><a href="#MappableTensor-665"><span class="linenos">665</span></a>        <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-666"><a href="#MappableTensor-666"><span class="linenos">666</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-667"><a href="#MappableTensor-667"><span class="linenos">667</span></a>            <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridDefinition</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">grid</span>
</span><span id="MappableTensor-668"><a href="#MappableTensor-668"><span class="linenos">668</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-669"><a href="#MappableTensor-669"><span class="linenos">669</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span>
</span><span id="MappableTensor-670"><a href="#MappableTensor-670"><span class="linenos">670</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor-671"><a href="#MappableTensor-671"><span class="linenos">671</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">grid</span>
</span><span id="MappableTensor-672"><a href="#MappableTensor-672"><span class="linenos">672</span></a>
</span><span id="MappableTensor-673"><a href="#MappableTensor-673"><span class="linenos">673</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacements</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-674"><a href="#MappableTensor-674"><span class="linenos">674</span></a>            <span class="n">displacements</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">displacements</span>
</span><span id="MappableTensor-675"><a href="#MappableTensor-675"><span class="linenos">675</span></a>            <span class="n">affine_transformation</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">affine_transformation</span>
</span><span id="MappableTensor-676"><a href="#MappableTensor-676"><span class="linenos">676</span></a>        <span class="k">elif</span> <span class="n">other</span><span class="o">.</span><span class="n">displacements</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-677"><a href="#MappableTensor-677"><span class="linenos">677</span></a>            <span class="n">displacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacements</span>
</span><span id="MappableTensor-678"><a href="#MappableTensor-678"><span class="linenos">678</span></a>            <span class="n">affine_transformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine_transformation</span>
</span><span id="MappableTensor-679"><a href="#MappableTensor-679"><span class="linenos">679</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor-680"><a href="#MappableTensor-680"><span class="linenos">680</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="MappableTensor-681"><a href="#MappableTensor-681"><span class="linenos">681</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">affine_transformation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">affine_transformation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="MappableTensor-682"><a href="#MappableTensor-682"><span class="linenos">682</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-683"><a href="#MappableTensor-683"><span class="linenos">683</span></a>            <span class="n">self_displacements</span><span class="p">,</span> <span class="n">other_displacements</span> <span class="o">=</span> <span class="n">broadcast_tensors_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-684"><a href="#MappableTensor-684"><span class="linenos">684</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">affine_transformation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displacements</span><span class="p">),</span>
</span><span id="MappableTensor-685"><a href="#MappableTensor-685"><span class="linenos">685</span></a>                <span class="n">other</span><span class="o">.</span><span class="n">affine_transformation</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">displacements</span><span class="p">),</span>
</span><span id="MappableTensor-686"><a href="#MappableTensor-686"><span class="linenos">686</span></a>                <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">),</span>
</span><span id="MappableTensor-687"><a href="#MappableTensor-687"><span class="linenos">687</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-688"><a href="#MappableTensor-688"><span class="linenos">688</span></a>            <span class="n">displacements</span> <span class="o">=</span> <span class="n">self_displacements</span> <span class="o">+</span> <span class="n">other_displacements</span>
</span><span id="MappableTensor-689"><a href="#MappableTensor-689"><span class="linenos">689</span></a>            <span class="n">affine_transformation</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor-690"><a href="#MappableTensor-690"><span class="linenos">690</span></a>
</span><span id="MappableTensor-691"><a href="#MappableTensor-691"><span class="linenos">691</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor-692"><a href="#MappableTensor-692"><span class="linenos">692</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="n">displacements</span><span class="p">,</span>
</span><span id="MappableTensor-693"><a href="#MappableTensor-693"><span class="linenos">693</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor-694"><a href="#MappableTensor-694"><span class="linenos">694</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-695"><a href="#MappableTensor-695"><span class="linenos">695</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="n">affine_transformation</span><span class="p">,</span>
</span><span id="MappableTensor-696"><a href="#MappableTensor-696"><span class="linenos">696</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
</span><span id="MappableTensor-697"><a href="#MappableTensor-697"><span class="linenos">697</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-698"><a href="#MappableTensor-698"><span class="linenos">698</span></a>
</span><span id="MappableTensor-699"><a href="#MappableTensor-699"><span class="linenos">699</span></a>    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;MappableTensor&quot;</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-700"><a href="#MappableTensor-700"><span class="linenos">700</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="o">-</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-701"><a href="#MappableTensor-701"><span class="linenos">701</span></a>
</span><span id="MappableTensor-702"><a href="#MappableTensor-702"><span class="linenos">702</span></a>    <span class="k">def</span> <span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-703"><a href="#MappableTensor-703"><span class="linenos">703</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor-704"><a href="#MappableTensor-704"><span class="linenos">704</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="p">,</span>
</span><span id="MappableTensor-705"><a href="#MappableTensor-705"><span class="linenos">705</span></a>            <span class="n">mask</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor-706"><a href="#MappableTensor-706"><span class="linenos">706</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-707"><a href="#MappableTensor-707"><span class="linenos">707</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="p">(</span>
</span><span id="MappableTensor-708"><a href="#MappableTensor-708"><span class="linenos">708</span></a>                <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span>
</span><span id="MappableTensor-709"><a href="#MappableTensor-709"><span class="linenos">709</span></a>            <span class="p">),</span>
</span><span id="MappableTensor-710"><a href="#MappableTensor-710"><span class="linenos">710</span></a>            <span class="n">grid</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="p">),</span>
</span><span id="MappableTensor-711"><a href="#MappableTensor-711"><span class="linenos">711</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-712"><a href="#MappableTensor-712"><span class="linenos">712</span></a>
</span><span id="MappableTensor-713"><a href="#MappableTensor-713"><span class="linenos">713</span></a>    <span class="k">def</span> <span class="nf">has_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="MappableTensor-714"><a href="#MappableTensor-714"><span class="linenos">714</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Has the mappable tensor an explicit mask&quot;&quot;&quot;</span>
</span><span id="MappableTensor-715"><a href="#MappableTensor-715"><span class="linenos">715</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="MappableTensor-716"><a href="#MappableTensor-716"><span class="linenos">716</span></a>
</span><span id="MappableTensor-717"><a href="#MappableTensor-717"><span class="linenos">717</span></a>    <span class="k">def</span> <span class="nf">clear_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-718"><a href="#MappableTensor-718"><span class="linenos">718</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear mask from the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor-719"><a href="#MappableTensor-719"><span class="linenos">719</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_mask</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MappableTensor-720"><a href="#MappableTensor-720"><span class="linenos">720</span></a>
</span><span id="MappableTensor-721"><a href="#MappableTensor-721"><span class="linenos">721</span></a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-722"><a href="#MappableTensor-722"><span class="linenos">722</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reduce the masked tensor to a mappable tensor with values and mask</span>
</span><span id="MappableTensor-723"><a href="#MappableTensor-723"><span class="linenos">723</span></a><span class="sd">        stored explicitly.&quot;&quot;&quot;</span>
</span><span id="MappableTensor-724"><a href="#MappableTensor-724"><span class="linenos">724</span></a>        <span class="n">values</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MappableTensor-725"><a href="#MappableTensor-725"><span class="linenos">725</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-726"><a href="#MappableTensor-726"><span class="linenos">726</span></a>            <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
</span><span id="MappableTensor-727"><a href="#MappableTensor-727"><span class="linenos">727</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor-728"><a href="#MappableTensor-728"><span class="linenos">728</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-729"><a href="#MappableTensor-729"><span class="linenos">729</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-730"><a href="#MappableTensor-730"><span class="linenos">730</span></a>
</span><span id="MappableTensor-731"><a href="#MappableTensor-731"><span class="linenos">731</span></a>    <span class="k">def</span> <span class="nf">modify_values</span><span class="p">(</span>
</span><span id="MappableTensor-732"><a href="#MappableTensor-732"><span class="linenos">732</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor-733"><a href="#MappableTensor-733"><span class="linenos">733</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-734"><a href="#MappableTensor-734"><span class="linenos">734</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify values of the mappable tensor.</span>
</span><span id="MappableTensor-735"><a href="#MappableTensor-735"><span class="linenos">735</span></a>
</span><span id="MappableTensor-736"><a href="#MappableTensor-736"><span class="linenos">736</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor-737"><a href="#MappableTensor-737"><span class="linenos">737</span></a><span class="sd">            values: New values of the mappable tensor. Tensor with shape</span>
</span><span id="MappableTensor-738"><a href="#MappableTensor-738"><span class="linenos">738</span></a><span class="sd">                (*batch_shape, *channels_shape, *spatial_shape).</span>
</span><span id="MappableTensor-739"><a href="#MappableTensor-739"><span class="linenos">739</span></a><span class="sd">            n_channel_dims: Number of channel dimensions of the new values.</span>
</span><span id="MappableTensor-740"><a href="#MappableTensor-740"><span class="linenos">740</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-741"><a href="#MappableTensor-741"><span class="linenos">741</span></a>        <span class="k">if</span> <span class="n">n_channel_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-742"><a href="#MappableTensor-742"><span class="linenos">742</span></a>            <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span>
</span><span id="MappableTensor-743"><a href="#MappableTensor-743"><span class="linenos">743</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span>
</span><span id="MappableTensor-744"><a href="#MappableTensor-744"><span class="linenos">744</span></a>        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-745"><a href="#MappableTensor-745"><span class="linenos">745</span></a>            <span class="n">batch_shape</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">split_shape</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="MappableTensor-746"><a href="#MappableTensor-746"><span class="linenos">746</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="n">n_channel_dims</span> <span class="o">+</span> <span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="MappableTensor-747"><a href="#MappableTensor-747"><span class="linenos">747</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor-748"><a href="#MappableTensor-748"><span class="linenos">748</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
</span><span id="MappableTensor-749"><a href="#MappableTensor-749"><span class="linenos">749</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor-750"><a href="#MappableTensor-750"><span class="linenos">750</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-751"><a href="#MappableTensor-751"><span class="linenos">751</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-752"><a href="#MappableTensor-752"><span class="linenos">752</span></a>            <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-753"><a href="#MappableTensor-753"><span class="linenos">753</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-754"><a href="#MappableTensor-754"><span class="linenos">754</span></a>
</span><span id="MappableTensor-755"><a href="#MappableTensor-755"><span class="linenos">755</span></a>    <span class="k">def</span> <span class="nf">mask_and</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-756"><a href="#MappableTensor-756"><span class="linenos">756</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine mask with logical and.</span>
</span><span id="MappableTensor-757"><a href="#MappableTensor-757"><span class="linenos">757</span></a>
</span><span id="MappableTensor-758"><a href="#MappableTensor-758"><span class="linenos">758</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor-759"><a href="#MappableTensor-759"><span class="linenos">759</span></a><span class="sd">            mask: Mask to combine with the mappable tensor.</span>
</span><span id="MappableTensor-760"><a href="#MappableTensor-760"><span class="linenos">760</span></a>
</span><span id="MappableTensor-761"><a href="#MappableTensor-761"><span class="linenos">761</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor-762"><a href="#MappableTensor-762"><span class="linenos">762</span></a><span class="sd">            Mappable tensor with the combined mask.</span>
</span><span id="MappableTensor-763"><a href="#MappableTensor-763"><span class="linenos">763</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-764"><a href="#MappableTensor-764"><span class="linenos">764</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_mask</span><span class="p">(</span>
</span><span id="MappableTensor-765"><a href="#MappableTensor-765"><span class="linenos">765</span></a>            <span class="n">combine_optional_masks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-766"><a href="#MappableTensor-766"><span class="linenos">766</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-767"><a href="#MappableTensor-767"><span class="linenos">767</span></a>
</span><span id="MappableTensor-768"><a href="#MappableTensor-768"><span class="linenos">768</span></a>    <span class="k">def</span> <span class="nf">modify_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-769"><a href="#MappableTensor-769"><span class="linenos">769</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify mask of the mappable tensor.</span>
</span><span id="MappableTensor-770"><a href="#MappableTensor-770"><span class="linenos">770</span></a>
</span><span id="MappableTensor-771"><a href="#MappableTensor-771"><span class="linenos">771</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor-772"><a href="#MappableTensor-772"><span class="linenos">772</span></a><span class="sd">            mask: New mask of the mappable tensor.</span>
</span><span id="MappableTensor-773"><a href="#MappableTensor-773"><span class="linenos">773</span></a>
</span><span id="MappableTensor-774"><a href="#MappableTensor-774"><span class="linenos">774</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor-775"><a href="#MappableTensor-775"><span class="linenos">775</span></a><span class="sd">            Mappable tensor with the new mask.</span>
</span><span id="MappableTensor-776"><a href="#MappableTensor-776"><span class="linenos">776</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-777"><a href="#MappableTensor-777"><span class="linenos">777</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor-778"><a href="#MappableTensor-778"><span class="linenos">778</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="p">,</span>
</span><span id="MappableTensor-779"><a href="#MappableTensor-779"><span class="linenos">779</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor-780"><a href="#MappableTensor-780"><span class="linenos">780</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-781"><a href="#MappableTensor-781"><span class="linenos">781</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span><span class="p">,</span>
</span><span id="MappableTensor-782"><a href="#MappableTensor-782"><span class="linenos">782</span></a>            <span class="n">grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="p">,</span>
</span><span id="MappableTensor-783"><a href="#MappableTensor-783"><span class="linenos">783</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-784"><a href="#MappableTensor-784"><span class="linenos">784</span></a>
</span><span id="MappableTensor-785"><a href="#MappableTensor-785"><span class="linenos">785</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="MappableTensor-786"><a href="#MappableTensor-786"><span class="linenos">786</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="MappableTensor-787"><a href="#MappableTensor-787"><span class="linenos">787</span></a>            <span class="sa">f</span><span class="s2">&quot;MappableTensor(&quot;</span>
</span><span id="MappableTensor-788"><a href="#MappableTensor-788"><span class="linenos">788</span></a>            <span class="sa">f</span><span class="s2">&quot;displacements=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="MappableTensor-789"><a href="#MappableTensor-789"><span class="linenos">789</span></a>            <span class="sa">f</span><span class="s2">&quot;mask=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="MappableTensor-790"><a href="#MappableTensor-790"><span class="linenos">790</span></a>            <span class="sa">f</span><span class="s2">&quot;n_channel_dims=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="MappableTensor-791"><a href="#MappableTensor-791"><span class="linenos">791</span></a>            <span class="sa">f</span><span class="s2">&quot;affine_transformation=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="MappableTensor-792"><a href="#MappableTensor-792"><span class="linenos">792</span></a>            <span class="sa">f</span><span class="s2">&quot;grid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="MappableTensor-793"><a href="#MappableTensor-793"><span class="linenos">793</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A tensor wrapper used as inputs for composable mappings</p>

<p>It is not recommended to create instances of this class directly, but to
use instead the constructors provided in the module, or as class methods
of this class: <code><a href="#mappable">mappable</a></code>, <code><a href="#MappableTensor.voxel_grid">voxel_grid</a></code>, <code><a href="#MappableTensor.from_tensor">MappableTensor.from_tensor</a></code>,
<code><a href="#MappableTensor.voxel_grid">MappableTensor.voxel_grid</a></code>.</p>

<p>The core idea of the mappable tensor is that affine transformations applied
to the tensor are not applied right away, but only when the values are
generated. This allows for more efficient computation. Additionally,
representing voxel coordinate grids and their transformations without
generating the grid is possible. Such grids can be also combined with
displacement vectors, still without generating the grid.</p>

<p>Masks can also be used to define valid regions of the tensor.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>displacements:</strong>  Displacement vectors, tensor with shape
(*batch_shape, *channels_shape, *spatial_shape).</li>
<li><strong>mask:</strong>  Mask of the tensor with shape (*batch_shape, *(1,) *
n_channel_dims, *spatial_shape).</li>
<li><strong>n_channel_dims:</strong>  Number of channel dimensions.</li>
<li><strong>affine_transformation:</strong>  Affine transformation acting on the displacements.</li>
<li><strong>grid:</strong>  Definition of a grid added to the displacements.</li>
</ul>
</div>


                            <div id="MappableTensor.__init__" class="classattr">
                                        <input id="MappableTensor.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">MappableTensor</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">displacements</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">affine_transformation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="composable_mapping/affine_transformation.html#IAffineTransformation">composable_mapping.affine_transformation.IAffineTransformation</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">grid</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">composable_mapping</span><span class="o">.</span><span class="n">mappable_tensor</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">GridDefinition</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="MappableTensor.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.__init__-74"><a href="#MappableTensor.__init__-74"><span class="linenos"> 74</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="MappableTensor.__init__-75"><a href="#MappableTensor.__init__-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor.__init__-76"><a href="#MappableTensor.__init__-76"><span class="linenos"> 76</span></a>        <span class="n">displacements</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.__init__-77"><a href="#MappableTensor.__init__-77"><span class="linenos"> 77</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.__init__-78"><a href="#MappableTensor.__init__-78"><span class="linenos"> 78</span></a>        <span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="MappableTensor.__init__-79"><a href="#MappableTensor.__init__-79"><span class="linenos"> 79</span></a>        <span class="n">affine_transformation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IAffineTransformation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.__init__-80"><a href="#MappableTensor.__init__-80"><span class="linenos"> 80</span></a>        <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridDefinition</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.__init__-81"><a href="#MappableTensor.__init__-81"><span class="linenos"> 81</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.__init__-82"><a href="#MappableTensor.__init__-82"><span class="linenos"> 82</span></a>        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.__init__-83"><a href="#MappableTensor.__init__-83"><span class="linenos"> 83</span></a>            <span class="n">mask_channels_shape</span> <span class="o">=</span> <span class="n">get_channels_shape</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor.__init__-84"><a href="#MappableTensor.__init__-84"><span class="linenos"> 84</span></a>            <span class="k">if</span> <span class="n">mask_channels_shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="n">n_channel_dims</span><span class="p">:</span>
</span><span id="MappableTensor.__init__-85"><a href="#MappableTensor.__init__-85"><span class="linenos"> 85</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mask must dimension with size 1 in all channel dimensions&quot;</span><span class="p">)</span>
</span><span id="MappableTensor.__init__-86"><a href="#MappableTensor.__init__-86"><span class="linenos"> 86</span></a>        <span class="k">if</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_channel_dims</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MappableTensor.__init__-87"><a href="#MappableTensor.__init__-87"><span class="linenos"> 87</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;When no displacements is set, n_channel_dims must be 1&quot;</span><span class="p">)</span>
</span><span id="MappableTensor.__init__-88"><a href="#MappableTensor.__init__-88"><span class="linenos"> 88</span></a>        <span class="k">if</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.__init__-89"><a href="#MappableTensor.__init__-89"><span class="linenos"> 89</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either displacements, or grid must be set.&quot;</span><span class="p">)</span>
</span><span id="MappableTensor.__init__-90"><a href="#MappableTensor.__init__-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span> <span class="o">=</span> <span class="n">displacements</span>
</span><span id="MappableTensor.__init__-91"><a href="#MappableTensor.__init__-91"><span class="linenos"> 91</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">=</span> <span class="n">mask</span>
</span><span id="MappableTensor.__init__-92"><a href="#MappableTensor.__init__-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span> <span class="o">=</span> <span class="n">n_channel_dims</span>
</span><span id="MappableTensor.__init__-93"><a href="#MappableTensor.__init__-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MappableTensor.__init__-94"><a href="#MappableTensor.__init__-94"><span class="linenos"> 94</span></a>            <span class="n">IdentityAffineTransformation</span><span class="p">(</span>
</span><span id="MappableTensor.__init__-95"><a href="#MappableTensor.__init__-95"><span class="linenos"> 95</span></a>                <span class="n">get_channels_shape</span><span class="p">(</span><span class="n">displacements</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="MappableTensor.__init__-96"><a href="#MappableTensor.__init__-96"><span class="linenos"> 96</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="n">displacements</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="MappableTensor.__init__-97"><a href="#MappableTensor.__init__-97"><span class="linenos"> 97</span></a>                <span class="n">device</span><span class="o">=</span><span class="n">displacements</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="MappableTensor.__init__-98"><a href="#MappableTensor.__init__-98"><span class="linenos"> 98</span></a>            <span class="p">)</span>
</span><span id="MappableTensor.__init__-99"><a href="#MappableTensor.__init__-99"><span class="linenos"> 99</span></a>            <span class="k">if</span> <span class="n">affine_transformation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="MappableTensor.__init__-100"><a href="#MappableTensor.__init__-100"><span class="linenos">100</span></a>            <span class="k">else</span> <span class="n">affine_transformation</span>
</span><span id="MappableTensor.__init__-101"><a href="#MappableTensor.__init__-101"><span class="linenos">101</span></a>        <span class="p">)</span>
</span><span id="MappableTensor.__init__-102"><a href="#MappableTensor.__init__-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="o">=</span> <span class="n">grid</span>
</span><span id="MappableTensor.__init__-103"><a href="#MappableTensor.__init__-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_shape</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="MappableTensor.from_tensor" class="classattr">
                                        <input id="MappableTensor.from_tensor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_tensor</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">values</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="MappableTensor.from_tensor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.from_tensor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.from_tensor-105"><a href="#MappableTensor.from_tensor-105"><span class="linenos">105</span></a>    <span class="nd">@classmethod</span>
</span><span id="MappableTensor.from_tensor-106"><a href="#MappableTensor.from_tensor-106"><span class="linenos">106</span></a>    <span class="k">def</span> <span class="nf">from_tensor</span><span class="p">(</span>
</span><span id="MappableTensor.from_tensor-107"><a href="#MappableTensor.from_tensor-107"><span class="linenos">107</span></a>        <span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MappableTensor.from_tensor-108"><a href="#MappableTensor.from_tensor-108"><span class="linenos">108</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor.from_tensor-109"><a href="#MappableTensor.from_tensor-109"><span class="linenos">109</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a mappable tensor from values and mask</span>
</span><span id="MappableTensor.from_tensor-110"><a href="#MappableTensor.from_tensor-110"><span class="linenos">110</span></a>
</span><span id="MappableTensor.from_tensor-111"><a href="#MappableTensor.from_tensor-111"><span class="linenos">111</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor.from_tensor-112"><a href="#MappableTensor.from_tensor-112"><span class="linenos">112</span></a><span class="sd">            values: Values of the generated mappable tensor, tensor with shape</span>
</span><span id="MappableTensor.from_tensor-113"><a href="#MappableTensor.from_tensor-113"><span class="linenos">113</span></a><span class="sd">                (*batch_shape, *channels_shape, *spatial_shape).</span>
</span><span id="MappableTensor.from_tensor-114"><a href="#MappableTensor.from_tensor-114"><span class="linenos">114</span></a><span class="sd">            mask: Mask of the generated mapable tensor with shape</span>
</span><span id="MappableTensor.from_tensor-115"><a href="#MappableTensor.from_tensor-115"><span class="linenos">115</span></a><span class="sd">                (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</span>
</span><span id="MappableTensor.from_tensor-116"><a href="#MappableTensor.from_tensor-116"><span class="linenos">116</span></a><span class="sd">            n_channel_dims: Number of channel dimensions.</span>
</span><span id="MappableTensor.from_tensor-117"><a href="#MappableTensor.from_tensor-117"><span class="linenos">117</span></a>
</span><span id="MappableTensor.from_tensor-118"><a href="#MappableTensor.from_tensor-118"><span class="linenos">118</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor.from_tensor-119"><a href="#MappableTensor.from_tensor-119"><span class="linenos">119</span></a><span class="sd">            Mappable tensor.</span>
</span><span id="MappableTensor.from_tensor-120"><a href="#MappableTensor.from_tensor-120"><span class="linenos">120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.from_tensor-121"><a href="#MappableTensor.from_tensor-121"><span class="linenos">121</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span><span class="n">displacements</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a mappable tensor from values and mask</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>values:</strong>  Values of the generated mappable tensor, tensor with shape
(*batch_shape, *channels_shape, *spatial_shape).</li>
<li><strong>mask:</strong>  Mask of the generated mapable tensor with shape
(*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</li>
<li><strong>n_channel_dims:</strong>  Number of channel dimensions.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Mappable tensor.</p>
</blockquote>
</div>


                            </div>
                            <div id="MappableTensor.voxel_grid" class="classattr">
                                        <input id="MappableTensor.voxel_grid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">voxel_grid</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="MappableTensor.voxel_grid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.voxel_grid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.voxel_grid-123"><a href="#MappableTensor.voxel_grid-123"><span class="linenos">123</span></a>    <span class="nd">@classmethod</span>
</span><span id="MappableTensor.voxel_grid-124"><a href="#MappableTensor.voxel_grid-124"><span class="linenos">124</span></a>    <span class="k">def</span> <span class="nf">voxel_grid</span><span class="p">(</span>
</span><span id="MappableTensor.voxel_grid-125"><a href="#MappableTensor.voxel_grid-125"><span class="linenos">125</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="MappableTensor.voxel_grid-126"><a href="#MappableTensor.voxel_grid-126"><span class="linenos">126</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="MappableTensor.voxel_grid-127"><a href="#MappableTensor.voxel_grid-127"><span class="linenos">127</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.voxel_grid-128"><a href="#MappableTensor.voxel_grid-128"><span class="linenos">128</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.voxel_grid-129"><a href="#MappableTensor.voxel_grid-129"><span class="linenos">129</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.voxel_grid-130"><a href="#MappableTensor.voxel_grid-130"><span class="linenos">130</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor.voxel_grid-131"><a href="#MappableTensor.voxel_grid-131"><span class="linenos">131</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a voxel grid with optional mask.</span>
</span><span id="MappableTensor.voxel_grid-132"><a href="#MappableTensor.voxel_grid-132"><span class="linenos">132</span></a>
</span><span id="MappableTensor.voxel_grid-133"><a href="#MappableTensor.voxel_grid-133"><span class="linenos">133</span></a><span class="sd">        The voxel grid is not generated explicitly right away, but only when the</span>
</span><span id="MappableTensor.voxel_grid-134"><a href="#MappableTensor.voxel_grid-134"><span class="linenos">134</span></a><span class="sd">        values are generated.</span>
</span><span id="MappableTensor.voxel_grid-135"><a href="#MappableTensor.voxel_grid-135"><span class="linenos">135</span></a>
</span><span id="MappableTensor.voxel_grid-136"><a href="#MappableTensor.voxel_grid-136"><span class="linenos">136</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor.voxel_grid-137"><a href="#MappableTensor.voxel_grid-137"><span class="linenos">137</span></a><span class="sd">            spatial_shape: Spatial shape of the created grid.</span>
</span><span id="MappableTensor.voxel_grid-138"><a href="#MappableTensor.voxel_grid-138"><span class="linenos">138</span></a><span class="sd">            mask: Mask of the grid with shape</span>
</span><span id="MappableTensor.voxel_grid-139"><a href="#MappableTensor.voxel_grid-139"><span class="linenos">139</span></a><span class="sd">                (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</span>
</span><span id="MappableTensor.voxel_grid-140"><a href="#MappableTensor.voxel_grid-140"><span class="linenos">140</span></a><span class="sd">            dtype: Data type of the grid.</span>
</span><span id="MappableTensor.voxel_grid-141"><a href="#MappableTensor.voxel_grid-141"><span class="linenos">141</span></a><span class="sd">            device: Device of the grid.</span>
</span><span id="MappableTensor.voxel_grid-142"><a href="#MappableTensor.voxel_grid-142"><span class="linenos">142</span></a>
</span><span id="MappableTensor.voxel_grid-143"><a href="#MappableTensor.voxel_grid-143"><span class="linenos">143</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor.voxel_grid-144"><a href="#MappableTensor.voxel_grid-144"><span class="linenos">144</span></a><span class="sd">            Mappable tensor representing the voxel grid.</span>
</span><span id="MappableTensor.voxel_grid-145"><a href="#MappableTensor.voxel_grid-145"><span class="linenos">145</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.voxel_grid-146"><a href="#MappableTensor.voxel_grid-146"><span class="linenos">146</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor.voxel_grid-147"><a href="#MappableTensor.voxel_grid-147"><span class="linenos">147</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor.voxel_grid-148"><a href="#MappableTensor.voxel_grid-148"><span class="linenos">148</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="MappableTensor.voxel_grid-149"><a href="#MappableTensor.voxel_grid-149"><span class="linenos">149</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">GridDefinition</span><span class="p">(</span>
</span><span id="MappableTensor.voxel_grid-150"><a href="#MappableTensor.voxel_grid-150"><span class="linenos">150</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor.voxel_grid-151"><a href="#MappableTensor.voxel_grid-151"><span class="linenos">151</span></a>                <span class="n">affine_transformation</span><span class="o">=</span><span class="n">IdentityAffineTransformation</span><span class="p">(</span>
</span><span id="MappableTensor.voxel_grid-152"><a href="#MappableTensor.voxel_grid-152"><span class="linenos">152</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
</span><span id="MappableTensor.voxel_grid-153"><a href="#MappableTensor.voxel_grid-153"><span class="linenos">153</span></a>                <span class="p">),</span>
</span><span id="MappableTensor.voxel_grid-154"><a href="#MappableTensor.voxel_grid-154"><span class="linenos">154</span></a>            <span class="p">),</span>
</span><span id="MappableTensor.voxel_grid-155"><a href="#MappableTensor.voxel_grid-155"><span class="linenos">155</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a voxel grid with optional mask.</p>

<p>The voxel grid is not generated explicitly right away, but only when the
values are generated.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>spatial_shape:</strong>  Spatial shape of the created grid.</li>
<li><strong>mask:</strong>  Mask of the grid with shape
(*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</li>
<li><strong>dtype:</strong>  Data type of the grid.</li>
<li><strong>device:</strong>  Device of the grid.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Mappable tensor representing the voxel grid.</p>
</blockquote>
</div>


                            </div>
                            <div id="MappableTensor.shape" class="classattr">
                                        <input id="MappableTensor.shape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">shape</span><span class="annotation">: Tuple[int, ...]</span>

                <label class="view-source-button" for="MappableTensor.shape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.shape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.shape-218"><a href="#MappableTensor.shape-218"><span class="linenos">218</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.shape-219"><a href="#MappableTensor.shape-219"><span class="linenos">219</span></a>    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor.shape-220"><a href="#MappableTensor.shape-220"><span class="linenos">220</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Shape of the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor.shape-221"><a href="#MappableTensor.shape-221"><span class="linenos">221</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>
</span></pre></div>


            <div class="docstring"><p>Shape of the mappable tensor</p>
</div>


                            </div>
                            <div id="MappableTensor.spatial_shape" class="classattr">
                                        <input id="MappableTensor.spatial_shape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">spatial_shape</span><span class="annotation">: Tuple[int, ...]</span>

                <label class="view-source-button" for="MappableTensor.spatial_shape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.spatial_shape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.spatial_shape-223"><a href="#MappableTensor.spatial_shape-223"><span class="linenos">223</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.spatial_shape-224"><a href="#MappableTensor.spatial_shape-224"><span class="linenos">224</span></a>    <span class="k">def</span> <span class="nf">spatial_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor.spatial_shape-225"><a href="#MappableTensor.spatial_shape-225"><span class="linenos">225</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Spatial shape of the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor.spatial_shape-226"><a href="#MappableTensor.spatial_shape-226"><span class="linenos">226</span></a>        <span class="k">return</span> <span class="n">get_spatial_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Spatial shape of the mappable tensor</p>
</div>


                            </div>
                            <div id="MappableTensor.channels_shape" class="classattr">
                                        <input id="MappableTensor.channels_shape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">channels_shape</span><span class="annotation">: Tuple[int, ...]</span>

                <label class="view-source-button" for="MappableTensor.channels_shape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.channels_shape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.channels_shape-228"><a href="#MappableTensor.channels_shape-228"><span class="linenos">228</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.channels_shape-229"><a href="#MappableTensor.channels_shape-229"><span class="linenos">229</span></a>    <span class="k">def</span> <span class="nf">channels_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor.channels_shape-230"><a href="#MappableTensor.channels_shape-230"><span class="linenos">230</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Channel shape of the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor.channels_shape-231"><a href="#MappableTensor.channels_shape-231"><span class="linenos">231</span></a>        <span class="k">return</span> <span class="n">get_channels_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Channel shape of the mappable tensor</p>
</div>


                            </div>
                            <div id="MappableTensor.batch_shape" class="classattr">
                                        <input id="MappableTensor.batch_shape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">batch_shape</span><span class="annotation">: Tuple[int, ...]</span>

                <label class="view-source-button" for="MappableTensor.batch_shape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.batch_shape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.batch_shape-233"><a href="#MappableTensor.batch_shape-233"><span class="linenos">233</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.batch_shape-234"><a href="#MappableTensor.batch_shape-234"><span class="linenos">234</span></a>    <span class="k">def</span> <span class="nf">batch_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor.batch_shape-235"><a href="#MappableTensor.batch_shape-235"><span class="linenos">235</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Batch shape of the mappable tensor.&quot;&quot;&quot;</span>
</span><span id="MappableTensor.batch_shape-236"><a href="#MappableTensor.batch_shape-236"><span class="linenos">236</span></a>        <span class="k">return</span> <span class="n">get_batch_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Batch shape of the mappable tensor.</p>
</div>


                            </div>
                            <div id="MappableTensor.mask_shape" class="classattr">
                                        <input id="MappableTensor.mask_shape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">mask_shape</span><span class="annotation">: Tuple[int, ...]</span>

                <label class="view-source-button" for="MappableTensor.mask_shape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.mask_shape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.mask_shape-238"><a href="#MappableTensor.mask_shape-238"><span class="linenos">238</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.mask_shape-239"><a href="#MappableTensor.mask_shape-239"><span class="linenos">239</span></a>    <span class="k">def</span> <span class="nf">mask_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor.mask_shape-240"><a href="#MappableTensor.mask_shape-240"><span class="linenos">240</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Shape of the generated mask of the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor.mask_shape-241"><a href="#MappableTensor.mask_shape-241"><span class="linenos">241</span></a>        <span class="k">return</span> <span class="n">reduce_channels_shape_to_ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Shape of the generated mask of the mappable tensor</p>
</div>


                            </div>
                            <div id="MappableTensor.n_channel_dims" class="classattr">
                                        <input id="MappableTensor.n_channel_dims-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">n_channel_dims</span><span class="annotation">: int</span>

                <label class="view-source-button" for="MappableTensor.n_channel_dims-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.n_channel_dims"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.n_channel_dims-243"><a href="#MappableTensor.n_channel_dims-243"><span class="linenos">243</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.n_channel_dims-244"><a href="#MappableTensor.n_channel_dims-244"><span class="linenos">244</span></a>    <span class="k">def</span> <span class="nf">n_channel_dims</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="MappableTensor.n_channel_dims-245"><a href="#MappableTensor.n_channel_dims-245"><span class="linenos">245</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of channel dimensions&quot;&quot;&quot;</span>
</span><span id="MappableTensor.n_channel_dims-246"><a href="#MappableTensor.n_channel_dims-246"><span class="linenos">246</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span></pre></div>


            <div class="docstring"><p>Number of channel dimensions</p>
</div>


                            </div>
                            <div id="MappableTensor.generate" class="classattr">
                                        <input id="MappableTensor.generate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">generate_missing_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="MappableTensor.generate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.generate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.generate-262"><a href="#MappableTensor.generate-262"><span class="linenos">262</span></a>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span>
</span><span id="MappableTensor.generate-263"><a href="#MappableTensor.generate-263"><span class="linenos">263</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor.generate-264"><a href="#MappableTensor.generate-264"><span class="linenos">264</span></a>        <span class="n">generate_missing_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="MappableTensor.generate-265"><a href="#MappableTensor.generate-265"><span class="linenos">265</span></a>        <span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="MappableTensor.generate-266"><a href="#MappableTensor.generate-266"><span class="linenos">266</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]]:</span>
</span><span id="MappableTensor.generate-267"><a href="#MappableTensor.generate-267"><span class="linenos">267</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate values and mask contained by the mappable tensor.</span>
</span><span id="MappableTensor.generate-268"><a href="#MappableTensor.generate-268"><span class="linenos">268</span></a>
</span><span id="MappableTensor.generate-269"><a href="#MappableTensor.generate-269"><span class="linenos">269</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor.generate-270"><a href="#MappableTensor.generate-270"><span class="linenos">270</span></a><span class="sd">            generate_mask: Generate mask of ones if the tensor does not contain an explicit mask.</span>
</span><span id="MappableTensor.generate-271"><a href="#MappableTensor.generate-271"><span class="linenos">271</span></a><span class="sd">            cast_mask: Mask is stored as a boolean tensor, cast it to dtype of values if True.</span>
</span><span id="MappableTensor.generate-272"><a href="#MappableTensor.generate-272"><span class="linenos">272</span></a>
</span><span id="MappableTensor.generate-273"><a href="#MappableTensor.generate-273"><span class="linenos">273</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor.generate-274"><a href="#MappableTensor.generate-274"><span class="linenos">274</span></a><span class="sd">            Tuple of values and mask.</span>
</span><span id="MappableTensor.generate-275"><a href="#MappableTensor.generate-275"><span class="linenos">275</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.generate-276"><a href="#MappableTensor.generate-276"><span class="linenos">276</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_mask</span><span class="p">(</span>
</span><span id="MappableTensor.generate-277"><a href="#MappableTensor.generate-277"><span class="linenos">277</span></a>            <span class="n">generate_missing_mask</span><span class="o">=</span><span class="n">generate_missing_mask</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="n">cast_mask</span>
</span><span id="MappableTensor.generate-278"><a href="#MappableTensor.generate-278"><span class="linenos">278</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Generate values and mask contained by the mappable tensor.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>generate_mask:</strong>  Generate mask of ones if the tensor does not contain an explicit mask.</li>
<li><strong>cast_mask:</strong>  Mask is stored as a boolean tensor, cast it to dtype of values if True.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Tuple of values and mask.</p>
</blockquote>
</div>


                            </div>
                            <div id="MappableTensor.generate_values" class="classattr">
                                        <input id="MappableTensor.generate_values-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_values</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="MappableTensor.generate_values-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.generate_values"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.generate_values-280"><a href="#MappableTensor.generate_values-280"><span class="linenos">280</span></a>    <span class="k">def</span> <span class="nf">generate_values</span><span class="p">(</span>
</span><span id="MappableTensor.generate_values-281"><a href="#MappableTensor.generate_values-281"><span class="linenos">281</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-282"><a href="#MappableTensor.generate_values-282"><span class="linenos">282</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="MappableTensor.generate_values-283"><a href="#MappableTensor.generate_values-283"><span class="linenos">283</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate values contained by the mappable tensor.&quot;&quot;&quot;</span>
</span><span id="MappableTensor.generate_values-284"><a href="#MappableTensor.generate_values-284"><span class="linenos">284</span></a>        <span class="n">batch_shape</span><span class="p">,</span> <span class="n">channels_shape</span><span class="p">,</span> <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">split_shape</span><span class="p">(</span>
</span><span id="MappableTensor.generate_values-285"><a href="#MappableTensor.generate_values-285"><span class="linenos">285</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span><span id="MappableTensor.generate_values-286"><a href="#MappableTensor.generate_values-286"><span class="linenos">286</span></a>        <span class="p">)</span>
</span><span id="MappableTensor.generate_values-287"><a href="#MappableTensor.generate_values-287"><span class="linenos">287</span></a>        <span class="n">displacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span>
</span><span id="MappableTensor.generate_values-288"><a href="#MappableTensor.generate_values-288"><span class="linenos">288</span></a>        <span class="k">if</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.generate_values-289"><a href="#MappableTensor.generate_values-289"><span class="linenos">289</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.generate_values-290"><a href="#MappableTensor.generate_values-290"><span class="linenos">290</span></a>                <span class="n">displacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span><span class="p">(</span>
</span><span id="MappableTensor.generate_values-291"><a href="#MappableTensor.generate_values-291"><span class="linenos">291</span></a>                    <span class="n">displacements</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span><span id="MappableTensor.generate_values-292"><a href="#MappableTensor.generate_values-292"><span class="linenos">292</span></a>                <span class="p">)</span>
</span><span id="MappableTensor.generate_values-293"><a href="#MappableTensor.generate_values-293"><span class="linenos">293</span></a>            <span class="n">displacements</span> <span class="o">=</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor.generate_values-294"><a href="#MappableTensor.generate_values-294"><span class="linenos">294</span></a>                <span class="n">displacements</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-295"><a href="#MappableTensor.generate_values-295"><span class="linenos">295</span></a>                <span class="n">batch_shape</span><span class="o">=</span><span class="n">batch_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-296"><a href="#MappableTensor.generate_values-296"><span class="linenos">296</span></a>                <span class="n">channels_shape</span><span class="o">=</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-297"><a href="#MappableTensor.generate_values-297"><span class="linenos">297</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-298"><a href="#MappableTensor.generate_values-298"><span class="linenos">298</span></a>                <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-299"><a href="#MappableTensor.generate_values-299"><span class="linenos">299</span></a>            <span class="p">)</span>
</span><span id="MappableTensor.generate_values-300"><a href="#MappableTensor.generate_values-300"><span class="linenos">300</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">is_zero</span><span class="p">():</span>
</span><span id="MappableTensor.generate_values-301"><a href="#MappableTensor.generate_values-301"><span class="linenos">301</span></a>            <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor.generate_values-302"><a href="#MappableTensor.generate_values-302"><span class="linenos">302</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor.generate_values-303"><a href="#MappableTensor.generate_values-303"><span class="linenos">303</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor.generate_values-304"><a href="#MappableTensor.generate_values-304"><span class="linenos">304</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">generate</span><span class="p">(),</span>
</span><span id="MappableTensor.generate_values-305"><a href="#MappableTensor.generate_values-305"><span class="linenos">305</span></a>                <span class="n">batch_shape</span><span class="o">=</span><span class="n">batch_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-306"><a href="#MappableTensor.generate_values-306"><span class="linenos">306</span></a>                <span class="n">channels_shape</span><span class="o">=</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-307"><a href="#MappableTensor.generate_values-307"><span class="linenos">307</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-308"><a href="#MappableTensor.generate_values-308"><span class="linenos">308</span></a>            <span class="p">)</span>
</span><span id="MappableTensor.generate_values-309"><a href="#MappableTensor.generate_values-309"><span class="linenos">309</span></a>        <span class="k">if</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.generate_values-310"><a href="#MappableTensor.generate_values-310"><span class="linenos">310</span></a>            <span class="n">values</span> <span class="o">=</span> <span class="n">grid</span>
</span><span id="MappableTensor.generate_values-311"><a href="#MappableTensor.generate_values-311"><span class="linenos">311</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor.generate_values-312"><a href="#MappableTensor.generate_values-312"><span class="linenos">312</span></a>            <span class="n">values</span> <span class="o">=</span> <span class="n">displacements</span>
</span><span id="MappableTensor.generate_values-313"><a href="#MappableTensor.generate_values-313"><span class="linenos">313</span></a>        <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.generate_values-314"><a href="#MappableTensor.generate_values-314"><span class="linenos">314</span></a>            <span class="k">return</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="MappableTensor.generate_values-315"><a href="#MappableTensor.generate_values-315"><span class="linenos">315</span></a>        <span class="k">return</span> <span class="n">values</span>
</span></pre></div>


            <div class="docstring"><p>Generate values contained by the mappable tensor.</p>
</div>


                            </div>
                            <div id="MappableTensor.generate_mask" class="classattr">
                                        <input id="MappableTensor.generate_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_mask</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">generate_missing_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="MappableTensor.generate_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.generate_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.generate_mask-331"><a href="#MappableTensor.generate_mask-331"><span class="linenos">331</span></a>    <span class="k">def</span> <span class="nf">generate_mask</span><span class="p">(</span>
</span><span id="MappableTensor.generate_mask-332"><a href="#MappableTensor.generate_mask-332"><span class="linenos">332</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-333"><a href="#MappableTensor.generate_mask-333"><span class="linenos">333</span></a>        <span class="n">generate_missing_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-334"><a href="#MappableTensor.generate_mask-334"><span class="linenos">334</span></a>        <span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-335"><a href="#MappableTensor.generate_mask-335"><span class="linenos">335</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
</span><span id="MappableTensor.generate_mask-336"><a href="#MappableTensor.generate_mask-336"><span class="linenos">336</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate mask contained by the mappable tensor.</span>
</span><span id="MappableTensor.generate_mask-337"><a href="#MappableTensor.generate_mask-337"><span class="linenos">337</span></a>
</span><span id="MappableTensor.generate_mask-338"><a href="#MappableTensor.generate_mask-338"><span class="linenos">338</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor.generate_mask-339"><a href="#MappableTensor.generate_mask-339"><span class="linenos">339</span></a><span class="sd">            generate_mask: Generate mask of ones if the tensor does not contain an explicit mask.</span>
</span><span id="MappableTensor.generate_mask-340"><a href="#MappableTensor.generate_mask-340"><span class="linenos">340</span></a><span class="sd">            cast_mask: Mask is stored as a boolean tensor, cast it to dtype of values if True.</span>
</span><span id="MappableTensor.generate_mask-341"><a href="#MappableTensor.generate_mask-341"><span class="linenos">341</span></a>
</span><span id="MappableTensor.generate_mask-342"><a href="#MappableTensor.generate_mask-342"><span class="linenos">342</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor.generate_mask-343"><a href="#MappableTensor.generate_mask-343"><span class="linenos">343</span></a><span class="sd">            Mask of the mappable tensor.</span>
</span><span id="MappableTensor.generate_mask-344"><a href="#MappableTensor.generate_mask-344"><span class="linenos">344</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.generate_mask-345"><a href="#MappableTensor.generate_mask-345"><span class="linenos">345</span></a>        <span class="n">target_dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="k">if</span> <span class="n">cast_mask</span> <span class="k">else</span> <span class="n">torch_bool</span>
</span><span id="MappableTensor.generate_mask-346"><a href="#MappableTensor.generate_mask-346"><span class="linenos">346</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.generate_mask-347"><a href="#MappableTensor.generate_mask-347"><span class="linenos">347</span></a>            <span class="n">batch_shape</span><span class="p">,</span> <span class="n">channels_shape</span><span class="p">,</span> <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">split_shape</span><span class="p">(</span>
</span><span id="MappableTensor.generate_mask-348"><a href="#MappableTensor.generate_mask-348"><span class="linenos">348</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mask_shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span><span id="MappableTensor.generate_mask-349"><a href="#MappableTensor.generate_mask-349"><span class="linenos">349</span></a>            <span class="p">)</span>
</span><span id="MappableTensor.generate_mask-350"><a href="#MappableTensor.generate_mask-350"><span class="linenos">350</span></a>            <span class="k">return</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor.generate_mask-351"><a href="#MappableTensor.generate_mask-351"><span class="linenos">351</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">),</span>
</span><span id="MappableTensor.generate_mask-352"><a href="#MappableTensor.generate_mask-352"><span class="linenos">352</span></a>                <span class="n">batch_shape</span><span class="o">=</span><span class="n">batch_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-353"><a href="#MappableTensor.generate_mask-353"><span class="linenos">353</span></a>                <span class="n">channels_shape</span><span class="o">=</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-354"><a href="#MappableTensor.generate_mask-354"><span class="linenos">354</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-355"><a href="#MappableTensor.generate_mask-355"><span class="linenos">355</span></a>                <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-356"><a href="#MappableTensor.generate_mask-356"><span class="linenos">356</span></a>            <span class="p">)</span>
</span><span id="MappableTensor.generate_mask-357"><a href="#MappableTensor.generate_mask-357"><span class="linenos">357</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="MappableTensor.generate_mask-358"><a href="#MappableTensor.generate_mask-358"><span class="linenos">358</span></a>            <span class="n">ones</span><span class="p">(</span>
</span><span id="MappableTensor.generate_mask-359"><a href="#MappableTensor.generate_mask-359"><span class="linenos">359</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mask_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-360"><a href="#MappableTensor.generate_mask-360"><span class="linenos">360</span></a>                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-361"><a href="#MappableTensor.generate_mask-361"><span class="linenos">361</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="n">target_dtype</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-362"><a href="#MappableTensor.generate_mask-362"><span class="linenos">362</span></a>            <span class="p">)</span>
</span><span id="MappableTensor.generate_mask-363"><a href="#MappableTensor.generate_mask-363"><span class="linenos">363</span></a>            <span class="k">if</span> <span class="n">generate_missing_mask</span>
</span><span id="MappableTensor.generate_mask-364"><a href="#MappableTensor.generate_mask-364"><span class="linenos">364</span></a>            <span class="k">else</span> <span class="kc">None</span>
</span><span id="MappableTensor.generate_mask-365"><a href="#MappableTensor.generate_mask-365"><span class="linenos">365</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Generate mask contained by the mappable tensor.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>generate_mask:</strong>  Generate mask of ones if the tensor does not contain an explicit mask.</li>
<li><strong>cast_mask:</strong>  Mask is stored as a boolean tensor, cast it to dtype of values if True.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Mask of the mappable tensor.</p>
</blockquote>
</div>


                            </div>
                            <div id="MappableTensor.displacements" class="classattr">
                                        <input id="MappableTensor.displacements-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">displacements</span><span class="annotation">: Union[torch.Tensor, NoneType]</span>

                <label class="view-source-button" for="MappableTensor.displacements-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.displacements"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.displacements-367"><a href="#MappableTensor.displacements-367"><span class="linenos">367</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.displacements-368"><a href="#MappableTensor.displacements-368"><span class="linenos">368</span></a>    <span class="k">def</span> <span class="nf">displacements</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
</span><span id="MappableTensor.displacements-369"><a href="#MappableTensor.displacements-369"><span class="linenos">369</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Displacements contained by the mappable tensor</span>
</span><span id="MappableTensor.displacements-370"><a href="#MappableTensor.displacements-370"><span class="linenos">370</span></a>
</span><span id="MappableTensor.displacements-371"><a href="#MappableTensor.displacements-371"><span class="linenos">371</span></a><span class="sd">        The displacements vector might not have the same shape as the mappable</span>
</span><span id="MappableTensor.displacements-372"><a href="#MappableTensor.displacements-372"><span class="linenos">372</span></a><span class="sd">        tensor, but is brodcastable to it. This is a relatively low level</span>
</span><span id="MappableTensor.displacements-373"><a href="#MappableTensor.displacements-373"><span class="linenos">373</span></a><span class="sd">        property and the recommended way to access the values is through the</span>
</span><span id="MappableTensor.displacements-374"><a href="#MappableTensor.displacements-374"><span class="linenos">374</span></a><span class="sd">        `generate_values` method.</span>
</span><span id="MappableTensor.displacements-375"><a href="#MappableTensor.displacements-375"><span class="linenos">375</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.displacements-376"><a href="#MappableTensor.displacements-376"><span class="linenos">376</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span>
</span></pre></div>


            <div class="docstring"><p>Displacements contained by the mappable tensor</p>

<p>The displacements vector might not have the same shape as the mappable
tensor, but is brodcastable to it. This is a relatively low level
property and the recommended way to access the values is through the
<code><a href="#MappableTensor.generate_values">generate_values</a></code> method.</p>
</div>


                            </div>
                            <div id="MappableTensor.affine_transformation" class="classattr">
                                        <input id="MappableTensor.affine_transformation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">affine_transformation</span><span class="annotation">: Union[<a href="composable_mapping/affine_transformation.html#IAffineTransformation">composable_mapping.affine_transformation.IAffineTransformation</a>, NoneType]</span>

                <label class="view-source-button" for="MappableTensor.affine_transformation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.affine_transformation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.affine_transformation-378"><a href="#MappableTensor.affine_transformation-378"><span class="linenos">378</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.affine_transformation-379"><a href="#MappableTensor.affine_transformation-379"><span class="linenos">379</span></a>    <span class="k">def</span> <span class="nf">affine_transformation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IAffineTransformation</span><span class="p">]:</span>
</span><span id="MappableTensor.affine_transformation-380"><a href="#MappableTensor.affine_transformation-380"><span class="linenos">380</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Affine transformation on displacements, if available</span>
</span><span id="MappableTensor.affine_transformation-381"><a href="#MappableTensor.affine_transformation-381"><span class="linenos">381</span></a>
</span><span id="MappableTensor.affine_transformation-382"><a href="#MappableTensor.affine_transformation-382"><span class="linenos">382</span></a><span class="sd">        This is relatively low level property, and should be used with caution.</span>
</span><span id="MappableTensor.affine_transformation-383"><a href="#MappableTensor.affine_transformation-383"><span class="linenos">383</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.affine_transformation-384"><a href="#MappableTensor.affine_transformation-384"><span class="linenos">384</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span>
</span></pre></div>


            <div class="docstring"><p>Affine transformation on displacements, if available</p>

<p>This is relatively low level property, and should be used with caution.</p>
</div>


                            </div>
                            <div id="MappableTensor.grid" class="classattr">
                                        <input id="MappableTensor.grid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">grid</span><span class="annotation">: Union[composable_mapping.mappable_tensor.grid.GridDefinition, NoneType]</span>

                <label class="view-source-button" for="MappableTensor.grid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.grid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.grid-386"><a href="#MappableTensor.grid-386"><span class="linenos">386</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.grid-387"><a href="#MappableTensor.grid-387"><span class="linenos">387</span></a>    <span class="k">def</span> <span class="nf">grid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridDefinition</span><span class="p">]:</span>
</span><span id="MappableTensor.grid-388"><a href="#MappableTensor.grid-388"><span class="linenos">388</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Definition of the grid contained by the tensor, if available</span>
</span><span id="MappableTensor.grid-389"><a href="#MappableTensor.grid-389"><span class="linenos">389</span></a>
</span><span id="MappableTensor.grid-390"><a href="#MappableTensor.grid-390"><span class="linenos">390</span></a><span class="sd">        The grid might not have the same shape as the mappable tensor, but is</span>
</span><span id="MappableTensor.grid-391"><a href="#MappableTensor.grid-391"><span class="linenos">391</span></a><span class="sd">        brodcastable to it. This is relatively low level method, and should be</span>
</span><span id="MappableTensor.grid-392"><a href="#MappableTensor.grid-392"><span class="linenos">392</span></a><span class="sd">        used with caution.</span>
</span><span id="MappableTensor.grid-393"><a href="#MappableTensor.grid-393"><span class="linenos">393</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.grid-394"><a href="#MappableTensor.grid-394"><span class="linenos">394</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span>
</span></pre></div>


            <div class="docstring"><p>Definition of the grid contained by the tensor, if available</p>

<p>The grid might not have the same shape as the mappable tensor, but is
brodcastable to it. This is relatively low level method, and should be
used with caution.</p>
</div>


                            </div>
                            <div id="MappableTensor.transform" class="classattr">
                                        <input id="MappableTensor.transform-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">transform</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">affine_transformation</span><span class="p">:</span> <span class="n"><a href="composable_mapping/affine_transformation.html#IAffineTransformation">composable_mapping.affine_transformation.IAffineTransformation</a></span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="MappableTensor.transform-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.transform"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.transform-396"><a href="#MappableTensor.transform-396"><span class="linenos">396</span></a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">affine_transformation</span><span class="p">:</span> <span class="n">IAffineTransformation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor.transform-397"><a href="#MappableTensor.transform-397"><span class="linenos">397</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply an affine transformation to the last channel dimension of the</span>
</span><span id="MappableTensor.transform-398"><a href="#MappableTensor.transform-398"><span class="linenos">398</span></a><span class="sd">        mappable tensor.</span>
</span><span id="MappableTensor.transform-399"><a href="#MappableTensor.transform-399"><span class="linenos">399</span></a>
</span><span id="MappableTensor.transform-400"><a href="#MappableTensor.transform-400"><span class="linenos">400</span></a><span class="sd">        The affine transformation is not applied right a way, only the</span>
</span><span id="MappableTensor.transform-401"><a href="#MappableTensor.transform-401"><span class="linenos">401</span></a><span class="sd">        composition with the existing affine transformation is stored. The</span>
</span><span id="MappableTensor.transform-402"><a href="#MappableTensor.transform-402"><span class="linenos">402</span></a><span class="sd">        transformation is applied when the values are generated.</span>
</span><span id="MappableTensor.transform-403"><a href="#MappableTensor.transform-403"><span class="linenos">403</span></a>
</span><span id="MappableTensor.transform-404"><a href="#MappableTensor.transform-404"><span class="linenos">404</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor.transform-405"><a href="#MappableTensor.transform-405"><span class="linenos">405</span></a><span class="sd">            affine_transformation: Affine transformation to apply.</span>
</span><span id="MappableTensor.transform-406"><a href="#MappableTensor.transform-406"><span class="linenos">406</span></a>
</span><span id="MappableTensor.transform-407"><a href="#MappableTensor.transform-407"><span class="linenos">407</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor.transform-408"><a href="#MappableTensor.transform-408"><span class="linenos">408</span></a><span class="sd">            Transformed mappable tensor.</span>
</span><span id="MappableTensor.transform-409"><a href="#MappableTensor.transform-409"><span class="linenos">409</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.transform-410"><a href="#MappableTensor.transform-410"><span class="linenos">410</span></a>        <span class="n">n_affine_transformation_input_channels</span> <span class="o">=</span> <span class="n">affine_transformation</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="MappableTensor.transform-411"><a href="#MappableTensor.transform-411"><span class="linenos">411</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">n_affine_transformation_input_channels</span><span class="p">:</span>
</span><span id="MappableTensor.transform-412"><a href="#MappableTensor.transform-412"><span class="linenos">412</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Affine transformation must have matching input channels&quot;</span><span class="p">)</span>
</span><span id="MappableTensor.transform-413"><a href="#MappableTensor.transform-413"><span class="linenos">413</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.transform-414"><a href="#MappableTensor.transform-414"><span class="linenos">414</span></a>            <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridDefinition</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor.transform-415"><a href="#MappableTensor.transform-415"><span class="linenos">415</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor.transform-416"><a href="#MappableTensor.transform-416"><span class="linenos">416</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">is_transformable</span><span class="p">(</span><span class="n">affine_transformation</span><span class="p">):</span>
</span><span id="MappableTensor.transform-417"><a href="#MappableTensor.transform-417"><span class="linenos">417</span></a>                <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor.transform-418"><a href="#MappableTensor.transform-418"><span class="linenos">418</span></a>                    <span class="n">displacements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">(),</span>
</span><span id="MappableTensor.transform-419"><a href="#MappableTensor.transform-419"><span class="linenos">419</span></a>                    <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor.transform-420"><a href="#MappableTensor.transform-420"><span class="linenos">420</span></a>                    <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor.transform-421"><a href="#MappableTensor.transform-421"><span class="linenos">421</span></a>                    <span class="n">affine_transformation</span><span class="o">=</span><span class="n">affine_transformation</span><span class="p">,</span>
</span><span id="MappableTensor.transform-422"><a href="#MappableTensor.transform-422"><span class="linenos">422</span></a>                    <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.transform-423"><a href="#MappableTensor.transform-423"><span class="linenos">423</span></a>                <span class="p">)</span>
</span><span id="MappableTensor.transform-424"><a href="#MappableTensor.transform-424"><span class="linenos">424</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">broadcast_to_n_channels</span><span class="p">(</span>
</span><span id="MappableTensor.transform-425"><a href="#MappableTensor.transform-425"><span class="linenos">425</span></a>                <span class="n">n_affine_transformation_input_channels</span>
</span><span id="MappableTensor.transform-426"><a href="#MappableTensor.transform-426"><span class="linenos">426</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">affine_transformation</span><span class="p">)</span>
</span><span id="MappableTensor.transform-427"><a href="#MappableTensor.transform-427"><span class="linenos">427</span></a>            <span class="n">affine_transformation</span> <span class="o">=</span> <span class="n">affine_transformation</span><span class="o">.</span><span class="n">clear_translation</span><span class="p">()</span>
</span><span id="MappableTensor.transform-428"><a href="#MappableTensor.transform-428"><span class="linenos">428</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.transform-429"><a href="#MappableTensor.transform-429"><span class="linenos">429</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="MappableTensor.transform-430"><a href="#MappableTensor.transform-430"><span class="linenos">430</span></a>            <span class="n">affine_transformation_on_displacements</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IAffineTransformation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor.transform-431"><a href="#MappableTensor.transform-431"><span class="linenos">431</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor.transform-432"><a href="#MappableTensor.transform-432"><span class="linenos">432</span></a>            <span class="n">affine_transformation_on_displacements</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MappableTensor.transform-433"><a href="#MappableTensor.transform-433"><span class="linenos">433</span></a>                <span class="n">affine_transformation</span>
</span><span id="MappableTensor.transform-434"><a href="#MappableTensor.transform-434"><span class="linenos">434</span></a>                <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span><span class="o">.</span><span class="n">broadcast_to_n_output_channels</span><span class="p">(</span>
</span><span id="MappableTensor.transform-435"><a href="#MappableTensor.transform-435"><span class="linenos">435</span></a>                    <span class="n">n_affine_transformation_input_channels</span><span class="p">,</span>
</span><span id="MappableTensor.transform-436"><a href="#MappableTensor.transform-436"><span class="linenos">436</span></a>                <span class="p">)</span>
</span><span id="MappableTensor.transform-437"><a href="#MappableTensor.transform-437"><span class="linenos">437</span></a>            <span class="p">)</span>
</span><span id="MappableTensor.transform-438"><a href="#MappableTensor.transform-438"><span class="linenos">438</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor.transform-439"><a href="#MappableTensor.transform-439"><span class="linenos">439</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="p">,</span>
</span><span id="MappableTensor.transform-440"><a href="#MappableTensor.transform-440"><span class="linenos">440</span></a>            <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor.transform-441"><a href="#MappableTensor.transform-441"><span class="linenos">441</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor.transform-442"><a href="#MappableTensor.transform-442"><span class="linenos">442</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="n">affine_transformation_on_displacements</span><span class="p">,</span>
</span><span id="MappableTensor.transform-443"><a href="#MappableTensor.transform-443"><span class="linenos">443</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
</span><span id="MappableTensor.transform-444"><a href="#MappableTensor.transform-444"><span class="linenos">444</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Apply an affine transformation to the last channel dimension of the
mappable tensor.</p>

<p>The affine transformation is not applied right a way, only the
composition with the existing affine transformation is stored. The
transformation is applied when the values are generated.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>affine_transformation:</strong>  Affine transformation to apply.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Transformed mappable tensor.</p>
</blockquote>
</div>


                            </div>
                            <div id="MappableTensor.has_mask" class="classattr">
                                        <input id="MappableTensor.has_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">has_mask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="MappableTensor.has_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.has_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.has_mask-713"><a href="#MappableTensor.has_mask-713"><span class="linenos">713</span></a>    <span class="k">def</span> <span class="nf">has_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="MappableTensor.has_mask-714"><a href="#MappableTensor.has_mask-714"><span class="linenos">714</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Has the mappable tensor an explicit mask&quot;&quot;&quot;</span>
</span><span id="MappableTensor.has_mask-715"><a href="#MappableTensor.has_mask-715"><span class="linenos">715</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Has the mappable tensor an explicit mask</p>
</div>


                            </div>
                            <div id="MappableTensor.clear_mask" class="classattr">
                                        <input id="MappableTensor.clear_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clear_mask</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="MappableTensor.clear_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.clear_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.clear_mask-717"><a href="#MappableTensor.clear_mask-717"><span class="linenos">717</span></a>    <span class="k">def</span> <span class="nf">clear_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor.clear_mask-718"><a href="#MappableTensor.clear_mask-718"><span class="linenos">718</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear mask from the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor.clear_mask-719"><a href="#MappableTensor.clear_mask-719"><span class="linenos">719</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_mask</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Clear mask from the mappable tensor</p>
</div>


                            </div>
                            <div id="MappableTensor.reduce" class="classattr">
                                        <input id="MappableTensor.reduce-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reduce</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="MappableTensor.reduce-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.reduce"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.reduce-721"><a href="#MappableTensor.reduce-721"><span class="linenos">721</span></a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor.reduce-722"><a href="#MappableTensor.reduce-722"><span class="linenos">722</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reduce the masked tensor to a mappable tensor with values and mask</span>
</span><span id="MappableTensor.reduce-723"><a href="#MappableTensor.reduce-723"><span class="linenos">723</span></a><span class="sd">        stored explicitly.&quot;&quot;&quot;</span>
</span><span id="MappableTensor.reduce-724"><a href="#MappableTensor.reduce-724"><span class="linenos">724</span></a>        <span class="n">values</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MappableTensor.reduce-725"><a href="#MappableTensor.reduce-725"><span class="linenos">725</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor.reduce-726"><a href="#MappableTensor.reduce-726"><span class="linenos">726</span></a>            <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
</span><span id="MappableTensor.reduce-727"><a href="#MappableTensor.reduce-727"><span class="linenos">727</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor.reduce-728"><a href="#MappableTensor.reduce-728"><span class="linenos">728</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor.reduce-729"><a href="#MappableTensor.reduce-729"><span class="linenos">729</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Reduce the masked tensor to a mappable tensor with values and mask
stored explicitly.</p>
</div>


                            </div>
                            <div id="MappableTensor.modify_values" class="classattr">
                                        <input id="MappableTensor.modify_values-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">modify_values</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">values</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>,</span><span class="param">	<span class="n">n_channel_dims</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="MappableTensor.modify_values-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.modify_values"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.modify_values-731"><a href="#MappableTensor.modify_values-731"><span class="linenos">731</span></a>    <span class="k">def</span> <span class="nf">modify_values</span><span class="p">(</span>
</span><span id="MappableTensor.modify_values-732"><a href="#MappableTensor.modify_values-732"><span class="linenos">732</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor.modify_values-733"><a href="#MappableTensor.modify_values-733"><span class="linenos">733</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor.modify_values-734"><a href="#MappableTensor.modify_values-734"><span class="linenos">734</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify values of the mappable tensor.</span>
</span><span id="MappableTensor.modify_values-735"><a href="#MappableTensor.modify_values-735"><span class="linenos">735</span></a>
</span><span id="MappableTensor.modify_values-736"><a href="#MappableTensor.modify_values-736"><span class="linenos">736</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor.modify_values-737"><a href="#MappableTensor.modify_values-737"><span class="linenos">737</span></a><span class="sd">            values: New values of the mappable tensor. Tensor with shape</span>
</span><span id="MappableTensor.modify_values-738"><a href="#MappableTensor.modify_values-738"><span class="linenos">738</span></a><span class="sd">                (*batch_shape, *channels_shape, *spatial_shape).</span>
</span><span id="MappableTensor.modify_values-739"><a href="#MappableTensor.modify_values-739"><span class="linenos">739</span></a><span class="sd">            n_channel_dims: Number of channel dimensions of the new values.</span>
</span><span id="MappableTensor.modify_values-740"><a href="#MappableTensor.modify_values-740"><span class="linenos">740</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.modify_values-741"><a href="#MappableTensor.modify_values-741"><span class="linenos">741</span></a>        <span class="k">if</span> <span class="n">n_channel_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.modify_values-742"><a href="#MappableTensor.modify_values-742"><span class="linenos">742</span></a>            <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span>
</span><span id="MappableTensor.modify_values-743"><a href="#MappableTensor.modify_values-743"><span class="linenos">743</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span>
</span><span id="MappableTensor.modify_values-744"><a href="#MappableTensor.modify_values-744"><span class="linenos">744</span></a>        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.modify_values-745"><a href="#MappableTensor.modify_values-745"><span class="linenos">745</span></a>            <span class="n">batch_shape</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">split_shape</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="MappableTensor.modify_values-746"><a href="#MappableTensor.modify_values-746"><span class="linenos">746</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="n">n_channel_dims</span> <span class="o">+</span> <span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="MappableTensor.modify_values-747"><a href="#MappableTensor.modify_values-747"><span class="linenos">747</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor.modify_values-748"><a href="#MappableTensor.modify_values-748"><span class="linenos">748</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
</span><span id="MappableTensor.modify_values-749"><a href="#MappableTensor.modify_values-749"><span class="linenos">749</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor.modify_values-750"><a href="#MappableTensor.modify_values-750"><span class="linenos">750</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor.modify_values-751"><a href="#MappableTensor.modify_values-751"><span class="linenos">751</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.modify_values-752"><a href="#MappableTensor.modify_values-752"><span class="linenos">752</span></a>            <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.modify_values-753"><a href="#MappableTensor.modify_values-753"><span class="linenos">753</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Modify values of the mappable tensor.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>values:</strong>  New values of the mappable tensor. Tensor with shape
(*batch_shape, *channels_shape, *spatial_shape).</li>
<li><strong>n_channel_dims:</strong>  Number of channel dimensions of the new values.</li>
</ul>
</div>


                            </div>
                            <div id="MappableTensor.mask_and" class="classattr">
                                        <input id="MappableTensor.mask_and-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">mask_and</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="MappableTensor.mask_and-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.mask_and"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.mask_and-755"><a href="#MappableTensor.mask_and-755"><span class="linenos">755</span></a>    <span class="k">def</span> <span class="nf">mask_and</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor.mask_and-756"><a href="#MappableTensor.mask_and-756"><span class="linenos">756</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine mask with logical and.</span>
</span><span id="MappableTensor.mask_and-757"><a href="#MappableTensor.mask_and-757"><span class="linenos">757</span></a>
</span><span id="MappableTensor.mask_and-758"><a href="#MappableTensor.mask_and-758"><span class="linenos">758</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor.mask_and-759"><a href="#MappableTensor.mask_and-759"><span class="linenos">759</span></a><span class="sd">            mask: Mask to combine with the mappable tensor.</span>
</span><span id="MappableTensor.mask_and-760"><a href="#MappableTensor.mask_and-760"><span class="linenos">760</span></a>
</span><span id="MappableTensor.mask_and-761"><a href="#MappableTensor.mask_and-761"><span class="linenos">761</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor.mask_and-762"><a href="#MappableTensor.mask_and-762"><span class="linenos">762</span></a><span class="sd">            Mappable tensor with the combined mask.</span>
</span><span id="MappableTensor.mask_and-763"><a href="#MappableTensor.mask_and-763"><span class="linenos">763</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.mask_and-764"><a href="#MappableTensor.mask_and-764"><span class="linenos">764</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_mask</span><span class="p">(</span>
</span><span id="MappableTensor.mask_and-765"><a href="#MappableTensor.mask_and-765"><span class="linenos">765</span></a>            <span class="n">combine_optional_masks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor.mask_and-766"><a href="#MappableTensor.mask_and-766"><span class="linenos">766</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Combine mask with logical and.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mask:</strong>  Mask to combine with the mappable tensor.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Mappable tensor with the combined mask.</p>
</blockquote>
</div>


                            </div>
                            <div id="MappableTensor.modify_mask" class="classattr">
                                        <input id="MappableTensor.modify_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">modify_mask</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="MappableTensor.modify_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.modify_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.modify_mask-768"><a href="#MappableTensor.modify_mask-768"><span class="linenos">768</span></a>    <span class="k">def</span> <span class="nf">modify_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor.modify_mask-769"><a href="#MappableTensor.modify_mask-769"><span class="linenos">769</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify mask of the mappable tensor.</span>
</span><span id="MappableTensor.modify_mask-770"><a href="#MappableTensor.modify_mask-770"><span class="linenos">770</span></a>
</span><span id="MappableTensor.modify_mask-771"><a href="#MappableTensor.modify_mask-771"><span class="linenos">771</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor.modify_mask-772"><a href="#MappableTensor.modify_mask-772"><span class="linenos">772</span></a><span class="sd">            mask: New mask of the mappable tensor.</span>
</span><span id="MappableTensor.modify_mask-773"><a href="#MappableTensor.modify_mask-773"><span class="linenos">773</span></a>
</span><span id="MappableTensor.modify_mask-774"><a href="#MappableTensor.modify_mask-774"><span class="linenos">774</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor.modify_mask-775"><a href="#MappableTensor.modify_mask-775"><span class="linenos">775</span></a><span class="sd">            Mappable tensor with the new mask.</span>
</span><span id="MappableTensor.modify_mask-776"><a href="#MappableTensor.modify_mask-776"><span class="linenos">776</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.modify_mask-777"><a href="#MappableTensor.modify_mask-777"><span class="linenos">777</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor.modify_mask-778"><a href="#MappableTensor.modify_mask-778"><span class="linenos">778</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="p">,</span>
</span><span id="MappableTensor.modify_mask-779"><a href="#MappableTensor.modify_mask-779"><span class="linenos">779</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor.modify_mask-780"><a href="#MappableTensor.modify_mask-780"><span class="linenos">780</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor.modify_mask-781"><a href="#MappableTensor.modify_mask-781"><span class="linenos">781</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span><span class="p">,</span>
</span><span id="MappableTensor.modify_mask-782"><a href="#MappableTensor.modify_mask-782"><span class="linenos">782</span></a>            <span class="n">grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="p">,</span>
</span><span id="MappableTensor.modify_mask-783"><a href="#MappableTensor.modify_mask-783"><span class="linenos">783</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Modify mask of the mappable tensor.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mask:</strong>  New mask of the mappable tensor.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Mappable tensor with the new mask.</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>composable_mapping.tensor_like.BaseTensorLikeWrapper</dt>
                                <dd id="MappableTensor.dtype" class="variable">dtype</dd>
                <dd id="MappableTensor.device" class="variable">device</dd>
                <dd id="MappableTensor.cast" class="function">cast</dd>
                <dd id="MappableTensor.pin_memory" class="function">pin_memory</dd>
                <dd id="MappableTensor.detach" class="function">detach</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="NearestInterpolator">
                            <input id="NearestInterpolator-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">NearestInterpolator</span><wbr>(<span class="base"><a href="#BaseSeparableSampler">composable_mapping.BaseSeparableSampler</a></span>):

                <label class="view-source-button" for="NearestInterpolator-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NearestInterpolator"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NearestInterpolator-96"><a href="#NearestInterpolator-96"><span class="linenos"> 96</span></a><span class="k">class</span> <span class="nc">NearestInterpolator</span><span class="p">(</span><span class="n">BaseSeparableSampler</span><span class="p">):</span>
</span><span id="NearestInterpolator-97"><a href="#NearestInterpolator-97"><span class="linenos"> 97</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Nearest neighbour interpolation in voxel coordinates.</span>
</span><span id="NearestInterpolator-98"><a href="#NearestInterpolator-98"><span class="linenos"> 98</span></a>
</span><span id="NearestInterpolator-99"><a href="#NearestInterpolator-99"><span class="linenos"> 99</span></a><span class="sd">    Arguments:</span>
</span><span id="NearestInterpolator-100"><a href="#NearestInterpolator-100"><span class="linenos">100</span></a><span class="sd">        extrapolation_mode: Extrapolation mode for out-of-bound coordinates.</span>
</span><span id="NearestInterpolator-101"><a href="#NearestInterpolator-101"><span class="linenos">101</span></a><span class="sd">        mask_extrapolated_regions_for_empty_volume_mask: Whether to mask</span>
</span><span id="NearestInterpolator-102"><a href="#NearestInterpolator-102"><span class="linenos">102</span></a><span class="sd">            extrapolated regions when input volume mask is empty.</span>
</span><span id="NearestInterpolator-103"><a href="#NearestInterpolator-103"><span class="linenos">103</span></a><span class="sd">        convolution_threshold: Maximum allowed difference in coordinates</span>
</span><span id="NearestInterpolator-104"><a href="#NearestInterpolator-104"><span class="linenos">104</span></a><span class="sd">            for using convolution-based sampling (the difference might be upper</span>
</span><span id="NearestInterpolator-105"><a href="#NearestInterpolator-105"><span class="linenos">105</span></a><span class="sd">            bounded when doing the decision).</span>
</span><span id="NearestInterpolator-106"><a href="#NearestInterpolator-106"><span class="linenos">106</span></a><span class="sd">        mask_threshold: Maximum allowed weight for masked regions in a</span>
</span><span id="NearestInterpolator-107"><a href="#NearestInterpolator-107"><span class="linenos">107</span></a><span class="sd">            sampled location to still consider it valid (non-masked).</span>
</span><span id="NearestInterpolator-108"><a href="#NearestInterpolator-108"><span class="linenos">108</span></a><span class="sd">        limit_direction: How to handle points at equal distances. This</span>
</span><span id="NearestInterpolator-109"><a href="#NearestInterpolator-109"><span class="linenos">109</span></a><span class="sd">            option currently applies only to convolution based sampling.</span>
</span><span id="NearestInterpolator-110"><a href="#NearestInterpolator-110"><span class="linenos">110</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="NearestInterpolator-111"><a href="#NearestInterpolator-111"><span class="linenos">111</span></a>
</span><span id="NearestInterpolator-112"><a href="#NearestInterpolator-112"><span class="linenos">112</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="NearestInterpolator-113"><a href="#NearestInterpolator-113"><span class="linenos">113</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="NearestInterpolator-114"><a href="#NearestInterpolator-114"><span class="linenos">114</span></a>        <span class="n">extrapolation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;border&quot;</span><span class="p">,</span>
</span><span id="NearestInterpolator-115"><a href="#NearestInterpolator-115"><span class="linenos">115</span></a>        <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="NearestInterpolator-116"><a href="#NearestInterpolator-116"><span class="linenos">116</span></a>        <span class="n">convolution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
</span><span id="NearestInterpolator-117"><a href="#NearestInterpolator-117"><span class="linenos">117</span></a>        <span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span>
</span><span id="NearestInterpolator-118"><a href="#NearestInterpolator-118"><span class="linenos">118</span></a>        <span class="n">limit_direction</span><span class="p">:</span> <span class="n">LimitDirection</span> <span class="o">=</span> <span class="n">LimitDirection</span><span class="o">.</span><span class="n">right</span><span class="p">(),</span>
</span><span id="NearestInterpolator-119"><a href="#NearestInterpolator-119"><span class="linenos">119</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NearestInterpolator-120"><a href="#NearestInterpolator-120"><span class="linenos">120</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="NearestInterpolator-121"><a href="#NearestInterpolator-121"><span class="linenos">121</span></a>            <span class="n">extrapolation_mode</span><span class="o">=</span><span class="n">extrapolation_mode</span><span class="p">,</span>
</span><span id="NearestInterpolator-122"><a href="#NearestInterpolator-122"><span class="linenos">122</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="o">=</span><span class="p">(</span>
</span><span id="NearestInterpolator-123"><a href="#NearestInterpolator-123"><span class="linenos">123</span></a>                <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="NearestInterpolator-124"><a href="#NearestInterpolator-124"><span class="linenos">124</span></a>            <span class="p">),</span>
</span><span id="NearestInterpolator-125"><a href="#NearestInterpolator-125"><span class="linenos">125</span></a>            <span class="n">convolution_threshold</span><span class="o">=</span><span class="n">convolution_threshold</span><span class="p">,</span>
</span><span id="NearestInterpolator-126"><a href="#NearestInterpolator-126"><span class="linenos">126</span></a>            <span class="n">mask_threshold</span><span class="o">=</span><span class="n">mask_threshold</span><span class="p">,</span>
</span><span id="NearestInterpolator-127"><a href="#NearestInterpolator-127"><span class="linenos">127</span></a>            <span class="n">limit_direction</span><span class="o">=</span><span class="n">limit_direction</span><span class="p">,</span>
</span><span id="NearestInterpolator-128"><a href="#NearestInterpolator-128"><span class="linenos">128</span></a>        <span class="p">)</span>
</span><span id="NearestInterpolator-129"><a href="#NearestInterpolator-129"><span class="linenos">129</span></a>
</span><span id="NearestInterpolator-130"><a href="#NearestInterpolator-130"><span class="linenos">130</span></a>    <span class="k">def</span> <span class="nf">_kernel_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ISeparableKernelSupport</span><span class="p">:</span>
</span><span id="NearestInterpolator-131"><a href="#NearestInterpolator-131"><span class="linenos">131</span></a>        <span class="k">return</span> <span class="n">SymmetricPolynomialKernelSupport</span><span class="p">(</span><span class="n">kernel_width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">polynomial_degree</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="NearestInterpolator-132"><a href="#NearestInterpolator-132"><span class="linenos">132</span></a>
</span><span id="NearestInterpolator-133"><a href="#NearestInterpolator-133"><span class="linenos">133</span></a>    <span class="k">def</span> <span class="nf">_is_interpolating_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="NearestInterpolator-134"><a href="#NearestInterpolator-134"><span class="linenos">134</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="NearestInterpolator-135"><a href="#NearestInterpolator-135"><span class="linenos">135</span></a>
</span><span id="NearestInterpolator-136"><a href="#NearestInterpolator-136"><span class="linenos">136</span></a>    <span class="k">def</span> <span class="nf">_left_limit_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="NearestInterpolator-137"><a href="#NearestInterpolator-137"><span class="linenos">137</span></a>        <span class="k">return</span> <span class="n">ones_like</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;=</span> <span class="mf">0.5</span><span class="p">))</span>
</span><span id="NearestInterpolator-138"><a href="#NearestInterpolator-138"><span class="linenos">138</span></a>
</span><span id="NearestInterpolator-139"><a href="#NearestInterpolator-139"><span class="linenos">139</span></a>    <span class="k">def</span> <span class="nf">_right_limit_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="NearestInterpolator-140"><a href="#NearestInterpolator-140"><span class="linenos">140</span></a>        <span class="k">return</span> <span class="n">ones_like</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">coordinates</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">))</span>
</span><span id="NearestInterpolator-141"><a href="#NearestInterpolator-141"><span class="linenos">141</span></a>
</span><span id="NearestInterpolator-142"><a href="#NearestInterpolator-142"><span class="linenos">142</span></a>    <span class="k">def</span> <span class="nf">sample_values</span><span class="p">(</span>
</span><span id="NearestInterpolator-143"><a href="#NearestInterpolator-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="NearestInterpolator-144"><a href="#NearestInterpolator-144"><span class="linenos">144</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="NearestInterpolator-145"><a href="#NearestInterpolator-145"><span class="linenos">145</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="NearestInterpolator-146"><a href="#NearestInterpolator-146"><span class="linenos">146</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="NearestInterpolator-147"><a href="#NearestInterpolator-147"><span class="linenos">147</span></a>        <span class="k">return</span> <span class="n">interpolate</span><span class="p">(</span>
</span><span id="NearestInterpolator-148"><a href="#NearestInterpolator-148"><span class="linenos">148</span></a>            <span class="n">volume</span><span class="p">,</span>
</span><span id="NearestInterpolator-149"><a href="#NearestInterpolator-149"><span class="linenos">149</span></a>            <span class="n">coordinates</span><span class="p">,</span>
</span><span id="NearestInterpolator-150"><a href="#NearestInterpolator-150"><span class="linenos">150</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
</span><span id="NearestInterpolator-151"><a href="#NearestInterpolator-151"><span class="linenos">151</span></a>            <span class="n">padding_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extrapolation_mode</span><span class="p">,</span>
</span><span id="NearestInterpolator-152"><a href="#NearestInterpolator-152"><span class="linenos">152</span></a>        <span class="p">)</span>
</span><span id="NearestInterpolator-153"><a href="#NearestInterpolator-153"><span class="linenos">153</span></a>
</span><span id="NearestInterpolator-154"><a href="#NearestInterpolator-154"><span class="linenos">154</span></a>    <span class="k">def</span> <span class="nf">sample_mask</span><span class="p">(</span>
</span><span id="NearestInterpolator-155"><a href="#NearestInterpolator-155"><span class="linenos">155</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="NearestInterpolator-156"><a href="#NearestInterpolator-156"><span class="linenos">156</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="NearestInterpolator-157"><a href="#NearestInterpolator-157"><span class="linenos">157</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="NearestInterpolator-158"><a href="#NearestInterpolator-158"><span class="linenos">158</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="NearestInterpolator-159"><a href="#NearestInterpolator-159"><span class="linenos">159</span></a>        <span class="k">return</span> <span class="n">interpolate</span><span class="p">(</span>
</span><span id="NearestInterpolator-160"><a href="#NearestInterpolator-160"><span class="linenos">160</span></a>            <span class="n">volume</span><span class="o">=</span><span class="n">mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="NearestInterpolator-161"><a href="#NearestInterpolator-161"><span class="linenos">161</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
</span><span id="NearestInterpolator-162"><a href="#NearestInterpolator-162"><span class="linenos">162</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
</span><span id="NearestInterpolator-163"><a href="#NearestInterpolator-163"><span class="linenos">163</span></a>            <span class="n">padding_mode</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span>
</span><span id="NearestInterpolator-164"><a href="#NearestInterpolator-164"><span class="linenos">164</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Nearest neighbour interpolation in voxel coordinates.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>extrapolation_mode:</strong>  Extrapolation mode for out-of-bound coordinates.</li>
<li><strong>mask_extrapolated_regions_for_empty_volume_mask:</strong>  Whether to mask
extrapolated regions when input volume mask is empty.</li>
<li><strong>convolution_threshold:</strong>  Maximum allowed difference in coordinates
for using convolution-based sampling (the difference might be upper
bounded when doing the decision).</li>
<li><strong>mask_threshold:</strong>  Maximum allowed weight for masked regions in a
sampled location to still consider it valid (non-masked).</li>
<li><strong>limit_direction:</strong>  How to handle points at equal distances. This
option currently applies only to convolution based sampling.</li>
</ul>
</div>


                            <div id="NearestInterpolator.__init__" class="classattr">
                                        <input id="NearestInterpolator.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">NearestInterpolator</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">extrapolation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;border&#39;</span>,</span><span class="param">	<span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">convolution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0001</span>,</span><span class="param">	<span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-05</span>,</span><span class="param">	<span class="n">limit_direction</span><span class="p">:</span> <span class="n"><a href="#LimitDirection">LimitDirection</a></span> <span class="o">=</span> <span class="o">&lt;</span><span class="n"><a href="#LimitDirection">LimitDirection</a></span> <span class="nb">object</span><span class="o">&gt;</span></span>)</span>

                <label class="view-source-button" for="NearestInterpolator.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NearestInterpolator.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NearestInterpolator.__init__-112"><a href="#NearestInterpolator.__init__-112"><span class="linenos">112</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="NearestInterpolator.__init__-113"><a href="#NearestInterpolator.__init__-113"><span class="linenos">113</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="NearestInterpolator.__init__-114"><a href="#NearestInterpolator.__init__-114"><span class="linenos">114</span></a>        <span class="n">extrapolation_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;border&quot;</span><span class="p">,</span>
</span><span id="NearestInterpolator.__init__-115"><a href="#NearestInterpolator.__init__-115"><span class="linenos">115</span></a>        <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="NearestInterpolator.__init__-116"><a href="#NearestInterpolator.__init__-116"><span class="linenos">116</span></a>        <span class="n">convolution_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span>
</span><span id="NearestInterpolator.__init__-117"><a href="#NearestInterpolator.__init__-117"><span class="linenos">117</span></a>        <span class="n">mask_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span>
</span><span id="NearestInterpolator.__init__-118"><a href="#NearestInterpolator.__init__-118"><span class="linenos">118</span></a>        <span class="n">limit_direction</span><span class="p">:</span> <span class="n">LimitDirection</span> <span class="o">=</span> <span class="n">LimitDirection</span><span class="o">.</span><span class="n">right</span><span class="p">(),</span>
</span><span id="NearestInterpolator.__init__-119"><a href="#NearestInterpolator.__init__-119"><span class="linenos">119</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="NearestInterpolator.__init__-120"><a href="#NearestInterpolator.__init__-120"><span class="linenos">120</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="NearestInterpolator.__init__-121"><a href="#NearestInterpolator.__init__-121"><span class="linenos">121</span></a>            <span class="n">extrapolation_mode</span><span class="o">=</span><span class="n">extrapolation_mode</span><span class="p">,</span>
</span><span id="NearestInterpolator.__init__-122"><a href="#NearestInterpolator.__init__-122"><span class="linenos">122</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="o">=</span><span class="p">(</span>
</span><span id="NearestInterpolator.__init__-123"><a href="#NearestInterpolator.__init__-123"><span class="linenos">123</span></a>                <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="NearestInterpolator.__init__-124"><a href="#NearestInterpolator.__init__-124"><span class="linenos">124</span></a>            <span class="p">),</span>
</span><span id="NearestInterpolator.__init__-125"><a href="#NearestInterpolator.__init__-125"><span class="linenos">125</span></a>            <span class="n">convolution_threshold</span><span class="o">=</span><span class="n">convolution_threshold</span><span class="p">,</span>
</span><span id="NearestInterpolator.__init__-126"><a href="#NearestInterpolator.__init__-126"><span class="linenos">126</span></a>            <span class="n">mask_threshold</span><span class="o">=</span><span class="n">mask_threshold</span><span class="p">,</span>
</span><span id="NearestInterpolator.__init__-127"><a href="#NearestInterpolator.__init__-127"><span class="linenos">127</span></a>            <span class="n">limit_direction</span><span class="o">=</span><span class="n">limit_direction</span><span class="p">,</span>
</span><span id="NearestInterpolator.__init__-128"><a href="#NearestInterpolator.__init__-128"><span class="linenos">128</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="NearestInterpolator.sample_values" class="classattr">
                                        <input id="NearestInterpolator.sample_values-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_values</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">volume</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>, </span><span class="param"><span class="n">coordinates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="NearestInterpolator.sample_values-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NearestInterpolator.sample_values"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NearestInterpolator.sample_values-142"><a href="#NearestInterpolator.sample_values-142"><span class="linenos">142</span></a>    <span class="k">def</span> <span class="nf">sample_values</span><span class="p">(</span>
</span><span id="NearestInterpolator.sample_values-143"><a href="#NearestInterpolator.sample_values-143"><span class="linenos">143</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="NearestInterpolator.sample_values-144"><a href="#NearestInterpolator.sample_values-144"><span class="linenos">144</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="NearestInterpolator.sample_values-145"><a href="#NearestInterpolator.sample_values-145"><span class="linenos">145</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="NearestInterpolator.sample_values-146"><a href="#NearestInterpolator.sample_values-146"><span class="linenos">146</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="NearestInterpolator.sample_values-147"><a href="#NearestInterpolator.sample_values-147"><span class="linenos">147</span></a>        <span class="k">return</span> <span class="n">interpolate</span><span class="p">(</span>
</span><span id="NearestInterpolator.sample_values-148"><a href="#NearestInterpolator.sample_values-148"><span class="linenos">148</span></a>            <span class="n">volume</span><span class="p">,</span>
</span><span id="NearestInterpolator.sample_values-149"><a href="#NearestInterpolator.sample_values-149"><span class="linenos">149</span></a>            <span class="n">coordinates</span><span class="p">,</span>
</span><span id="NearestInterpolator.sample_values-150"><a href="#NearestInterpolator.sample_values-150"><span class="linenos">150</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
</span><span id="NearestInterpolator.sample_values-151"><a href="#NearestInterpolator.sample_values-151"><span class="linenos">151</span></a>            <span class="n">padding_mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_extrapolation_mode</span><span class="p">,</span>
</span><span id="NearestInterpolator.sample_values-152"><a href="#NearestInterpolator.sample_values-152"><span class="linenos">152</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sample values at spatial locations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>volume:</strong>  Volume to sample over spatial dimensions
with shape (*batch_shape, *channels_shape, *spatial_shape)</li>
<li><strong>coordinates:</strong>  Coordinates in voxel coordinates with shape
(*batch_shape, n_spatial_dims, *target_shape).</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Sampled values with shape (*batch_shape, *channels_shape, *target_shape).</p>
</blockquote>
</div>


                            </div>
                            <div id="NearestInterpolator.sample_mask" class="classattr">
                                        <input id="NearestInterpolator.sample_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_mask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>, </span><span class="param"><span class="n">coordinates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="NearestInterpolator.sample_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#NearestInterpolator.sample_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="NearestInterpolator.sample_mask-154"><a href="#NearestInterpolator.sample_mask-154"><span class="linenos">154</span></a>    <span class="k">def</span> <span class="nf">sample_mask</span><span class="p">(</span>
</span><span id="NearestInterpolator.sample_mask-155"><a href="#NearestInterpolator.sample_mask-155"><span class="linenos">155</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="NearestInterpolator.sample_mask-156"><a href="#NearestInterpolator.sample_mask-156"><span class="linenos">156</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="NearestInterpolator.sample_mask-157"><a href="#NearestInterpolator.sample_mask-157"><span class="linenos">157</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="NearestInterpolator.sample_mask-158"><a href="#NearestInterpolator.sample_mask-158"><span class="linenos">158</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="NearestInterpolator.sample_mask-159"><a href="#NearestInterpolator.sample_mask-159"><span class="linenos">159</span></a>        <span class="k">return</span> <span class="n">interpolate</span><span class="p">(</span>
</span><span id="NearestInterpolator.sample_mask-160"><a href="#NearestInterpolator.sample_mask-160"><span class="linenos">160</span></a>            <span class="n">volume</span><span class="o">=</span><span class="n">mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
</span><span id="NearestInterpolator.sample_mask-161"><a href="#NearestInterpolator.sample_mask-161"><span class="linenos">161</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
</span><span id="NearestInterpolator.sample_mask-162"><a href="#NearestInterpolator.sample_mask-162"><span class="linenos">162</span></a>            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
</span><span id="NearestInterpolator.sample_mask-163"><a href="#NearestInterpolator.sample_mask-163"><span class="linenos">163</span></a>            <span class="n">padding_mode</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">,</span>
</span><span id="NearestInterpolator.sample_mask-164"><a href="#NearestInterpolator.sample_mask-164"><span class="linenos">164</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sample mask at spatial locations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mask:</strong>  Mask to sample over spatial dimensions
with shape (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</li>
<li><strong>coordinates:</strong>  Coordinates in voxel coordinates with shape
(*batch_shape, n_spatial_dims, *target_shape).</li>
</ul>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#BaseSeparableSampler">BaseSeparableSampler</a></dt>
                                <dd id="NearestInterpolator.derivative" class="function"><a href="#BaseSeparableSampler.derivative">derivative</a></dd>
                <dd id="NearestInterpolator.inverse" class="function"><a href="#BaseSeparableSampler.inverse">inverse</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Number">
                    <div class="attr variable">
            <span class="name">Number</span>        =
<span class="default_value">typing.Union[int, float]</span>

        
    </div>
    <a class="headerlink" href="#Number"></a>
    
    

                </section>
                <section id="OriginalFOV">
                            <input id="OriginalFOV-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">OriginalFOV</span><wbr>(<span class="base"><a href="#ReformattingSpatialShape">composable_mapping.ReformattingSpatialShape</a></span>):

                <label class="view-source-button" for="OriginalFOV-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OriginalFOV"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="OriginalFOV-132"><a href="#OriginalFOV-132"><span class="linenos">132</span></a><span class="k">class</span> <span class="nc">OriginalFOV</span><span class="p">(</span><span class="n">ReformattingSpatialShape</span><span class="p">):</span>
</span><span id="OriginalFOV-133"><a href="#OriginalFOV-133"><span class="linenos">133</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Spatial shape such that the size of the field of view is the same as with</span>
</span><span id="OriginalFOV-134"><a href="#OriginalFOV-134"><span class="linenos">134</span></a><span class="sd">    the original grid.</span>
</span><span id="OriginalFOV-135"><a href="#OriginalFOV-135"><span class="linenos">135</span></a>
</span><span id="OriginalFOV-136"><a href="#OriginalFOV-136"><span class="linenos">136</span></a><span class="sd">    E.g. if the original grid has a size of 10 and the downsampling factor is 2,</span>
</span><span id="OriginalFOV-137"><a href="#OriginalFOV-137"><span class="linenos">137</span></a><span class="sd">    the target size will be 5 (with fov_convention == &quot;full_voxels&quot;).</span>
</span><span id="OriginalFOV-138"><a href="#OriginalFOV-138"><span class="linenos">138</span></a>
</span><span id="OriginalFOV-139"><a href="#OriginalFOV-139"><span class="linenos">139</span></a><span class="sd">    Arguments:</span>
</span><span id="OriginalFOV-140"><a href="#OriginalFOV-140"><span class="linenos">140</span></a><span class="sd">        fitting_method: Method for fitting the field of view size, either &quot;round&quot;,</span>
</span><span id="OriginalFOV-141"><a href="#OriginalFOV-141"><span class="linenos">141</span></a><span class="sd">            &quot;floor&quot;, or &quot;ceil&quot;.</span>
</span><span id="OriginalFOV-142"><a href="#OriginalFOV-142"><span class="linenos">142</span></a><span class="sd">        fov_convention: Convention for defining the field of view, either &quot;full_voxels&quot;</span>
</span><span id="OriginalFOV-143"><a href="#OriginalFOV-143"><span class="linenos">143</span></a><span class="sd">            or &quot;voxel_centers&quot;. If voxels are seens as cubes with the value at the</span>
</span><span id="OriginalFOV-144"><a href="#OriginalFOV-144"><span class="linenos">144</span></a><span class="sd">            center, the convention &quot;full voxels&quot; includes the full cubes in the field</span>
</span><span id="OriginalFOV-145"><a href="#OriginalFOV-145"><span class="linenos">145</span></a><span class="sd">            of view, while the convention &quot;voxel_centers&quot; includes only the centers.</span>
</span><span id="OriginalFOV-146"><a href="#OriginalFOV-146"><span class="linenos">146</span></a><span class="sd">            The latter results in a field of view that is one voxel smaller in each</span>
</span><span id="OriginalFOV-147"><a href="#OriginalFOV-147"><span class="linenos">147</span></a><span class="sd">            dimension. Similar to the align_corners option in</span>
</span><span id="OriginalFOV-148"><a href="#OriginalFOV-148"><span class="linenos">148</span></a><span class="sd">            torch.nn.functional.grid_sample</span>
</span><span id="OriginalFOV-149"><a href="#OriginalFOV-149"><span class="linenos">149</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="OriginalFOV-150"><a href="#OriginalFOV-150"><span class="linenos">150</span></a>
</span><span id="OriginalFOV-151"><a href="#OriginalFOV-151"><span class="linenos">151</span></a>    <span class="n">DIVISION_FUNCTIONS</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="OriginalFOV-152"><a href="#OriginalFOV-152"><span class="linenos">152</span></a>        <span class="s2">&quot;round&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="p">)),</span>
</span><span id="OriginalFOV-153"><a href="#OriginalFOV-153"><span class="linenos">153</span></a>        <span class="s2">&quot;floor&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">//</span> <span class="n">y</span><span class="p">),</span>
</span><span id="OriginalFOV-154"><a href="#OriginalFOV-154"><span class="linenos">154</span></a>        <span class="s2">&quot;ceil&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">_ceildiv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)),</span>
</span><span id="OriginalFOV-155"><a href="#OriginalFOV-155"><span class="linenos">155</span></a>    <span class="p">}</span>
</span><span id="OriginalFOV-156"><a href="#OriginalFOV-156"><span class="linenos">156</span></a>
</span><span id="OriginalFOV-157"><a href="#OriginalFOV-157"><span class="linenos">157</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitting_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">fov_convention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="OriginalFOV-158"><a href="#OriginalFOV-158"><span class="linenos">158</span></a>        <span class="k">if</span> <span class="n">fitting_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="s2">&quot;floor&quot;</span><span class="p">,</span> <span class="s2">&quot;ceil&quot;</span><span class="p">):</span>
</span><span id="OriginalFOV-159"><a href="#OriginalFOV-159"><span class="linenos">159</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown fitting method (</span><span class="si">{</span><span class="n">fitting_method</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="OriginalFOV-160"><a href="#OriginalFOV-160"><span class="linenos">160</span></a>        <span class="k">if</span> <span class="n">fov_convention</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;full_voxels&quot;</span><span class="p">,</span> <span class="s2">&quot;voxel_centers&quot;</span><span class="p">):</span>
</span><span id="OriginalFOV-161"><a href="#OriginalFOV-161"><span class="linenos">161</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown fov convention (</span><span class="si">{</span><span class="n">fov_convention</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
</span><span id="OriginalFOV-162"><a href="#OriginalFOV-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_division_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIVISION_FUNCTIONS</span><span class="p">[</span><span class="n">fitting_method</span><span class="p">]</span>
</span><span id="OriginalFOV-163"><a href="#OriginalFOV-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">=</span> <span class="n">fov_convention</span>
</span><span id="OriginalFOV-164"><a href="#OriginalFOV-164"><span class="linenos">164</span></a>
</span><span id="OriginalFOV-165"><a href="#OriginalFOV-165"><span class="linenos">165</span></a>    <span class="k">def</span> <span class="nf">target_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">downsampling_factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="OriginalFOV-166"><a href="#OriginalFOV-166"><span class="linenos">166</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">==</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">:</span>
</span><span id="OriginalFOV-167"><a href="#OriginalFOV-167"><span class="linenos">167</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_division_function</span><span class="p">(</span><span class="n">original_size</span><span class="p">,</span> <span class="n">downsampling_factor</span><span class="p">)</span>
</span><span id="OriginalFOV-168"><a href="#OriginalFOV-168"><span class="linenos">168</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">==</span> <span class="s2">&quot;voxel_centers&quot;</span><span class="p">:</span>
</span><span id="OriginalFOV-169"><a href="#OriginalFOV-169"><span class="linenos">169</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_division_function</span><span class="p">(</span><span class="n">original_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">downsampling_factor</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="OriginalFOV-170"><a href="#OriginalFOV-170"><span class="linenos">170</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown fov convention (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Spatial shape such that the size of the field of view is the same as with
the original grid.</p>

<p>E.g. if the original grid has a size of 10 and the downsampling factor is 2,
the target size will be 5 (with fov_convention == "full_voxels").</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>fitting_method:</strong>  Method for fitting the field of view size, either "round",
"floor", or "ceil".</li>
<li><strong>fov_convention:</strong>  Convention for defining the field of view, either "full_voxels"
or "voxel_centers". If voxels are seens as cubes with the value at the
center, the convention "full voxels" includes the full cubes in the field
of view, while the convention "voxel_centers" includes only the centers.
The latter results in a field of view that is one voxel smaller in each
dimension. Similar to the align_corners option in
torch.nn.functional.grid_sample</li>
</ul>
</div>


                            <div id="OriginalFOV.__init__" class="classattr">
                                        <input id="OriginalFOV.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">OriginalFOV</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">fitting_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;round&#39;</span>, </span><span class="param"><span class="n">fov_convention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;full_voxels&#39;</span></span>)</span>

                <label class="view-source-button" for="OriginalFOV.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OriginalFOV.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="OriginalFOV.__init__-157"><a href="#OriginalFOV.__init__-157"><span class="linenos">157</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fitting_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">fov_convention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="OriginalFOV.__init__-158"><a href="#OriginalFOV.__init__-158"><span class="linenos">158</span></a>        <span class="k">if</span> <span class="n">fitting_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="s2">&quot;floor&quot;</span><span class="p">,</span> <span class="s2">&quot;ceil&quot;</span><span class="p">):</span>
</span><span id="OriginalFOV.__init__-159"><a href="#OriginalFOV.__init__-159"><span class="linenos">159</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown fitting method (</span><span class="si">{</span><span class="n">fitting_method</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="OriginalFOV.__init__-160"><a href="#OriginalFOV.__init__-160"><span class="linenos">160</span></a>        <span class="k">if</span> <span class="n">fov_convention</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;full_voxels&quot;</span><span class="p">,</span> <span class="s2">&quot;voxel_centers&quot;</span><span class="p">):</span>
</span><span id="OriginalFOV.__init__-161"><a href="#OriginalFOV.__init__-161"><span class="linenos">161</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown fov convention (</span><span class="si">{</span><span class="n">fov_convention</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
</span><span id="OriginalFOV.__init__-162"><a href="#OriginalFOV.__init__-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_division_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DIVISION_FUNCTIONS</span><span class="p">[</span><span class="n">fitting_method</span><span class="p">]</span>
</span><span id="OriginalFOV.__init__-163"><a href="#OriginalFOV.__init__-163"><span class="linenos">163</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">=</span> <span class="n">fov_convention</span>
</span></pre></div>


    

                            </div>
                            <div id="OriginalFOV.DIVISION_FUNCTIONS" class="classattr">
                                <div class="attr variable">
            <span class="name">DIVISION_FUNCTIONS</span>        =
<input id="OriginalFOV.DIVISION_FUNCTIONS-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="OriginalFOV.DIVISION_FUNCTIONS-view-value"></label><span class="default_value">{&#39;round&#39;: &lt;function OriginalFOV.&lt;lambda&gt;&gt;, &#39;floor&#39;: &lt;function OriginalFOV.&lt;lambda&gt;&gt;, &#39;ceil&#39;: &lt;function OriginalFOV.&lt;lambda&gt;&gt;}</span>

        
    </div>
    <a class="headerlink" href="#OriginalFOV.DIVISION_FUNCTIONS"></a>
    
    

                            </div>
                            <div id="OriginalFOV.target_size" class="classattr">
                                        <input id="OriginalFOV.target_size-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">target_size</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">original_size</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="n">downsampling_factor</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="OriginalFOV.target_size-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OriginalFOV.target_size"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="OriginalFOV.target_size-165"><a href="#OriginalFOV.target_size-165"><span class="linenos">165</span></a>    <span class="k">def</span> <span class="nf">target_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">downsampling_factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="OriginalFOV.target_size-166"><a href="#OriginalFOV.target_size-166"><span class="linenos">166</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">==</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">:</span>
</span><span id="OriginalFOV.target_size-167"><a href="#OriginalFOV.target_size-167"><span class="linenos">167</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_division_function</span><span class="p">(</span><span class="n">original_size</span><span class="p">,</span> <span class="n">downsampling_factor</span><span class="p">)</span>
</span><span id="OriginalFOV.target_size-168"><a href="#OriginalFOV.target_size-168"><span class="linenos">168</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">==</span> <span class="s2">&quot;voxel_centers&quot;</span><span class="p">:</span>
</span><span id="OriginalFOV.target_size-169"><a href="#OriginalFOV.target_size-169"><span class="linenos">169</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_division_function</span><span class="p">(</span><span class="n">original_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">downsampling_factor</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="OriginalFOV.target_size-170"><a href="#OriginalFOV.target_size-170"><span class="linenos">170</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown fov convention (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Return a target size given an original size and a downsampling factor.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>original_size:</strong>  Original size of the dimension.</li>
<li><strong>downsampling_factor:</strong>  Downsampling factor of the dimension during reformatting.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Target size of the dimension.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="OriginalShape">
                            <input id="OriginalShape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">OriginalShape</span><wbr>(<span class="base"><a href="#ReformattingSpatialShape">composable_mapping.ReformattingSpatialShape</a></span>):

                <label class="view-source-button" for="OriginalShape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OriginalShape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="OriginalShape-121"><a href="#OriginalShape-121"><span class="linenos">121</span></a><span class="k">class</span> <span class="nc">OriginalShape</span><span class="p">(</span><span class="n">ReformattingSpatialShape</span><span class="p">):</span>
</span><span id="OriginalShape-122"><a href="#OriginalShape-122"><span class="linenos">122</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Spatial shape of the original grid.&quot;&quot;&quot;</span>
</span><span id="OriginalShape-123"><a href="#OriginalShape-123"><span class="linenos">123</span></a>
</span><span id="OriginalShape-124"><a href="#OriginalShape-124"><span class="linenos">124</span></a>    <span class="k">def</span> <span class="nf">target_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">downsampling_factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="OriginalShape-125"><a href="#OriginalShape-125"><span class="linenos">125</span></a>        <span class="k">return</span> <span class="n">original_size</span>
</span></pre></div>


            <div class="docstring"><p>Spatial shape of the original grid.</p>
</div>


                            <div id="OriginalShape.target_size" class="classattr">
                                        <input id="OriginalShape.target_size-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">target_size</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">original_size</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="n">downsampling_factor</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="OriginalShape.target_size-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OriginalShape.target_size"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="OriginalShape.target_size-124"><a href="#OriginalShape.target_size-124"><span class="linenos">124</span></a>    <span class="k">def</span> <span class="nf">target_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">downsampling_factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="OriginalShape.target_size-125"><a href="#OriginalShape.target_size-125"><span class="linenos">125</span></a>        <span class="k">return</span> <span class="n">original_size</span>
</span></pre></div>


            <div class="docstring"><p>Return a target size given an original size and a downsampling factor.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>original_size:</strong>  Original size of the dimension.</li>
<li><strong>downsampling_factor:</strong>  Downsampling factor of the dimension during reformatting.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Target size of the dimension.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="ReformattingReference">
                            <input id="ReformattingReference-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ReformattingReference</span><wbr>(<span class="base">abc.ABC</span>):

                <label class="view-source-button" for="ReformattingReference-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReformattingReference"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReformattingReference-52"><a href="#ReformattingReference-52"><span class="linenos">52</span></a><span class="k">class</span> <span class="nc">ReformattingReference</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="ReformattingReference-53"><a href="#ReformattingReference-53"><span class="linenos">53</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Reference point which will be aligned between the</span>
</span><span id="ReformattingReference-54"><a href="#ReformattingReference-54"><span class="linenos">54</span></a><span class="sd">    original and the reformatted coordinates.</span>
</span><span id="ReformattingReference-55"><a href="#ReformattingReference-55"><span class="linenos">55</span></a>
</span><span id="ReformattingReference-56"><a href="#ReformattingReference-56"><span class="linenos">56</span></a><span class="sd">    Allows to define the reference point for reformatting based on the</span>
</span><span id="ReformattingReference-57"><a href="#ReformattingReference-57"><span class="linenos">57</span></a><span class="sd">    spatial size of the grid.</span>
</span><span id="ReformattingReference-58"><a href="#ReformattingReference-58"><span class="linenos">58</span></a>
</span><span id="ReformattingReference-59"><a href="#ReformattingReference-59"><span class="linenos">59</span></a><span class="sd">    For ease of use, the class implements the basic arithmetic operators</span>
</span><span id="ReformattingReference-60"><a href="#ReformattingReference-60"><span class="linenos">60</span></a><span class="sd">    to allow for easy manipulation of the reference point.</span>
</span><span id="ReformattingReference-61"><a href="#ReformattingReference-61"><span class="linenos">61</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ReformattingReference-62"><a href="#ReformattingReference-62"><span class="linenos">62</span></a>
</span><span id="ReformattingReference-63"><a href="#ReformattingReference-63"><span class="linenos">63</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ReformattingReference-64"><a href="#ReformattingReference-64"><span class="linenos">64</span></a>    <span class="k">def</span> <span class="nf">get_voxel_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Number</span><span class="p">:</span>
</span><span id="ReformattingReference-65"><a href="#ReformattingReference-65"><span class="linenos">65</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a voxel coordinate corresponding to the reference position with</span>
</span><span id="ReformattingReference-66"><a href="#ReformattingReference-66"><span class="linenos">66</span></a><span class="sd">        a given dimension size.</span>
</span><span id="ReformattingReference-67"><a href="#ReformattingReference-67"><span class="linenos">67</span></a>
</span><span id="ReformattingReference-68"><a href="#ReformattingReference-68"><span class="linenos">68</span></a><span class="sd">        Args:</span>
</span><span id="ReformattingReference-69"><a href="#ReformattingReference-69"><span class="linenos">69</span></a><span class="sd">            size: Size of the dimension</span>
</span><span id="ReformattingReference-70"><a href="#ReformattingReference-70"><span class="linenos">70</span></a>
</span><span id="ReformattingReference-71"><a href="#ReformattingReference-71"><span class="linenos">71</span></a><span class="sd">        Returns:</span>
</span><span id="ReformattingReference-72"><a href="#ReformattingReference-72"><span class="linenos">72</span></a><span class="sd">            Voxel coordinate corresponding to the reference position along the dimension.</span>
</span><span id="ReformattingReference-73"><a href="#ReformattingReference-73"><span class="linenos">73</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReformattingReference-74"><a href="#ReformattingReference-74"><span class="linenos">74</span></a>
</span><span id="ReformattingReference-75"><a href="#ReformattingReference-75"><span class="linenos">75</span></a>    <span class="fm">__add__</span><span class="p">,</span> <span class="fm">__radd__</span> <span class="o">=</span> <span class="n">_define_bivariate_reference_operator</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
</span><span id="ReformattingReference-76"><a href="#ReformattingReference-76"><span class="linenos">76</span></a>    <span class="fm">__sub__</span><span class="p">,</span> <span class="fm">__rsub__</span> <span class="o">=</span> <span class="n">_define_bivariate_reference_operator</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
</span><span id="ReformattingReference-77"><a href="#ReformattingReference-77"><span class="linenos">77</span></a>    <span class="fm">__mul__</span><span class="p">,</span> <span class="fm">__rmul__</span> <span class="o">=</span> <span class="n">_define_bivariate_reference_operator</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>
</span><span id="ReformattingReference-78"><a href="#ReformattingReference-78"><span class="linenos">78</span></a>    <span class="fm">__floordiv__</span><span class="p">,</span> <span class="fm">__rfloordiv__</span> <span class="o">=</span> <span class="n">_define_bivariate_reference_operator</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">//</span> <span class="n">y</span><span class="p">)</span>
</span><span id="ReformattingReference-79"><a href="#ReformattingReference-79"><span class="linenos">79</span></a>    <span class="fm">__truediv__</span><span class="p">,</span> <span class="fm">__rtruediv__</span> <span class="o">=</span> <span class="n">_define_bivariate_reference_operator</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="p">)</span>
</span><span id="ReformattingReference-80"><a href="#ReformattingReference-80"><span class="linenos">80</span></a>    <span class="fm">__pow__</span><span class="p">,</span> <span class="fm">__rpow__</span> <span class="o">=</span> <span class="n">_define_bivariate_reference_operator</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">**</span><span class="n">y</span><span class="p">)</span>
</span><span id="ReformattingReference-81"><a href="#ReformattingReference-81"><span class="linenos">81</span></a>    <span class="fm">__abs__</span> <span class="o">=</span> <span class="n">_define_univariate_reference_operator</span><span class="p">(</span><span class="nb">abs</span><span class="p">)</span>
</span><span id="ReformattingReference-82"><a href="#ReformattingReference-82"><span class="linenos">82</span></a>    <span class="fm">__neg__</span> <span class="o">=</span> <span class="n">_define_univariate_reference_operator</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Reference point which will be aligned between the
original and the reformatted coordinates.</p>

<p>Allows to define the reference point for reformatting based on the
spatial size of the grid.</p>

<p>For ease of use, the class implements the basic arithmetic operators
to allow for easy manipulation of the reference point.</p>
</div>


                            <div id="ReformattingReference.get_voxel_coordinate" class="classattr">
                                        <input id="ReformattingReference.get_voxel_coordinate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">get_voxel_coordinate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">size</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="ReformattingReference.get_voxel_coordinate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReformattingReference.get_voxel_coordinate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReformattingReference.get_voxel_coordinate-63"><a href="#ReformattingReference.get_voxel_coordinate-63"><span class="linenos">63</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ReformattingReference.get_voxel_coordinate-64"><a href="#ReformattingReference.get_voxel_coordinate-64"><span class="linenos">64</span></a>    <span class="k">def</span> <span class="nf">get_voxel_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Number</span><span class="p">:</span>
</span><span id="ReformattingReference.get_voxel_coordinate-65"><a href="#ReformattingReference.get_voxel_coordinate-65"><span class="linenos">65</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a voxel coordinate corresponding to the reference position with</span>
</span><span id="ReformattingReference.get_voxel_coordinate-66"><a href="#ReformattingReference.get_voxel_coordinate-66"><span class="linenos">66</span></a><span class="sd">        a given dimension size.</span>
</span><span id="ReformattingReference.get_voxel_coordinate-67"><a href="#ReformattingReference.get_voxel_coordinate-67"><span class="linenos">67</span></a>
</span><span id="ReformattingReference.get_voxel_coordinate-68"><a href="#ReformattingReference.get_voxel_coordinate-68"><span class="linenos">68</span></a><span class="sd">        Args:</span>
</span><span id="ReformattingReference.get_voxel_coordinate-69"><a href="#ReformattingReference.get_voxel_coordinate-69"><span class="linenos">69</span></a><span class="sd">            size: Size of the dimension</span>
</span><span id="ReformattingReference.get_voxel_coordinate-70"><a href="#ReformattingReference.get_voxel_coordinate-70"><span class="linenos">70</span></a>
</span><span id="ReformattingReference.get_voxel_coordinate-71"><a href="#ReformattingReference.get_voxel_coordinate-71"><span class="linenos">71</span></a><span class="sd">        Returns:</span>
</span><span id="ReformattingReference.get_voxel_coordinate-72"><a href="#ReformattingReference.get_voxel_coordinate-72"><span class="linenos">72</span></a><span class="sd">            Voxel coordinate corresponding to the reference position along the dimension.</span>
</span><span id="ReformattingReference.get_voxel_coordinate-73"><a href="#ReformattingReference.get_voxel_coordinate-73"><span class="linenos">73</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Get a voxel coordinate corresponding to the reference position with
a given dimension size.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>size:</strong>  Size of the dimension</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Voxel coordinate corresponding to the reference position along the dimension.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="ReformattingSpatialShape">
                            <input id="ReformattingSpatialShape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ReformattingSpatialShape</span><wbr>(<span class="base">abc.ABC</span>):

                <label class="view-source-button" for="ReformattingSpatialShape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReformattingSpatialShape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReformattingSpatialShape-50"><a href="#ReformattingSpatialShape-50"><span class="linenos">50</span></a><span class="k">class</span> <span class="nc">ReformattingSpatialShape</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="ReformattingSpatialShape-51"><a href="#ReformattingSpatialShape-51"><span class="linenos">51</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Instances of this class can be used as target spatial shapes for reformatting</span>
</span><span id="ReformattingSpatialShape-52"><a href="#ReformattingSpatialShape-52"><span class="linenos">52</span></a><span class="sd">    coordinate systems.</span>
</span><span id="ReformattingSpatialShape-53"><a href="#ReformattingSpatialShape-53"><span class="linenos">53</span></a>
</span><span id="ReformattingSpatialShape-54"><a href="#ReformattingSpatialShape-54"><span class="linenos">54</span></a><span class="sd">    Allows to define how the spatial shape of the grid should be reformatted based on</span>
</span><span id="ReformattingSpatialShape-55"><a href="#ReformattingSpatialShape-55"><span class="linenos">55</span></a><span class="sd">    the original spatial shape and the downsampling factor.</span>
</span><span id="ReformattingSpatialShape-56"><a href="#ReformattingSpatialShape-56"><span class="linenos">56</span></a>
</span><span id="ReformattingSpatialShape-57"><a href="#ReformattingSpatialShape-57"><span class="linenos">57</span></a><span class="sd">    For ease of use, the class implements the basic arithmetic operators to allow for</span>
</span><span id="ReformattingSpatialShape-58"><a href="#ReformattingSpatialShape-58"><span class="linenos">58</span></a><span class="sd">    easy manipulation of the spatial shape.</span>
</span><span id="ReformattingSpatialShape-59"><a href="#ReformattingSpatialShape-59"><span class="linenos">59</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ReformattingSpatialShape-60"><a href="#ReformattingSpatialShape-60"><span class="linenos">60</span></a>
</span><span id="ReformattingSpatialShape-61"><a href="#ReformattingSpatialShape-61"><span class="linenos">61</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ReformattingSpatialShape-62"><a href="#ReformattingSpatialShape-62"><span class="linenos">62</span></a>    <span class="k">def</span> <span class="nf">target_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">downsampling_factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="ReformattingSpatialShape-63"><a href="#ReformattingSpatialShape-63"><span class="linenos">63</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a target size given an original size and a downsampling factor.</span>
</span><span id="ReformattingSpatialShape-64"><a href="#ReformattingSpatialShape-64"><span class="linenos">64</span></a>
</span><span id="ReformattingSpatialShape-65"><a href="#ReformattingSpatialShape-65"><span class="linenos">65</span></a><span class="sd">        Args:</span>
</span><span id="ReformattingSpatialShape-66"><a href="#ReformattingSpatialShape-66"><span class="linenos">66</span></a><span class="sd">            original_size: Original size of the dimension.</span>
</span><span id="ReformattingSpatialShape-67"><a href="#ReformattingSpatialShape-67"><span class="linenos">67</span></a><span class="sd">            downsampling_factor: Downsampling factor of the dimension during reformatting.</span>
</span><span id="ReformattingSpatialShape-68"><a href="#ReformattingSpatialShape-68"><span class="linenos">68</span></a>
</span><span id="ReformattingSpatialShape-69"><a href="#ReformattingSpatialShape-69"><span class="linenos">69</span></a><span class="sd">        Returns:</span>
</span><span id="ReformattingSpatialShape-70"><a href="#ReformattingSpatialShape-70"><span class="linenos">70</span></a><span class="sd">            Target size of the dimension.</span>
</span><span id="ReformattingSpatialShape-71"><a href="#ReformattingSpatialShape-71"><span class="linenos">71</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ReformattingSpatialShape-72"><a href="#ReformattingSpatialShape-72"><span class="linenos">72</span></a>
</span><span id="ReformattingSpatialShape-73"><a href="#ReformattingSpatialShape-73"><span class="linenos">73</span></a>    <span class="fm">__add__</span><span class="p">,</span> <span class="fm">__radd__</span> <span class="o">=</span> <span class="n">_define_bivariate_shape_operator</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
</span><span id="ReformattingSpatialShape-74"><a href="#ReformattingSpatialShape-74"><span class="linenos">74</span></a>    <span class="fm">__sub__</span><span class="p">,</span> <span class="fm">__rsub__</span> <span class="o">=</span> <span class="n">_define_bivariate_shape_operator</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
</span><span id="ReformattingSpatialShape-75"><a href="#ReformattingSpatialShape-75"><span class="linenos">75</span></a>    <span class="fm">__mul__</span><span class="p">,</span> <span class="fm">__rmul__</span> <span class="o">=</span> <span class="n">_define_bivariate_shape_operator</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>
</span><span id="ReformattingSpatialShape-76"><a href="#ReformattingSpatialShape-76"><span class="linenos">76</span></a>    <span class="fm">__floordiv__</span><span class="p">,</span> <span class="fm">__rfloordiv__</span> <span class="o">=</span> <span class="n">_define_bivariate_shape_operator</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">//</span> <span class="n">y</span><span class="p">)</span>
</span><span id="ReformattingSpatialShape-77"><a href="#ReformattingSpatialShape-77"><span class="linenos">77</span></a>    <span class="fm">__pow__</span><span class="p">,</span> <span class="fm">__rpow__</span> <span class="o">=</span> <span class="n">_define_bivariate_shape_operator</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">**</span><span class="n">y</span><span class="p">)</span>
</span><span id="ReformattingSpatialShape-78"><a href="#ReformattingSpatialShape-78"><span class="linenos">78</span></a>    <span class="fm">__abs__</span> <span class="o">=</span> <span class="n">_define_univariate_shape_operator</span><span class="p">(</span><span class="nb">abs</span><span class="p">)</span>
</span><span id="ReformattingSpatialShape-79"><a href="#ReformattingSpatialShape-79"><span class="linenos">79</span></a>    <span class="fm">__neg__</span> <span class="o">=</span> <span class="n">_define_univariate_shape_operator</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Instances of this class can be used as target spatial shapes for reformatting
coordinate systems.</p>

<p>Allows to define how the spatial shape of the grid should be reformatted based on
the original spatial shape and the downsampling factor.</p>

<p>For ease of use, the class implements the basic arithmetic operators to allow for
easy manipulation of the spatial shape.</p>
</div>


                            <div id="ReformattingSpatialShape.target_size" class="classattr">
                                        <input id="ReformattingSpatialShape.target_size-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">target_size</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">original_size</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="n">downsampling_factor</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="ReformattingSpatialShape.target_size-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReformattingSpatialShape.target_size"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReformattingSpatialShape.target_size-61"><a href="#ReformattingSpatialShape.target_size-61"><span class="linenos">61</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="ReformattingSpatialShape.target_size-62"><a href="#ReformattingSpatialShape.target_size-62"><span class="linenos">62</span></a>    <span class="k">def</span> <span class="nf">target_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">downsampling_factor</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="ReformattingSpatialShape.target_size-63"><a href="#ReformattingSpatialShape.target_size-63"><span class="linenos">63</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a target size given an original size and a downsampling factor.</span>
</span><span id="ReformattingSpatialShape.target_size-64"><a href="#ReformattingSpatialShape.target_size-64"><span class="linenos">64</span></a>
</span><span id="ReformattingSpatialShape.target_size-65"><a href="#ReformattingSpatialShape.target_size-65"><span class="linenos">65</span></a><span class="sd">        Args:</span>
</span><span id="ReformattingSpatialShape.target_size-66"><a href="#ReformattingSpatialShape.target_size-66"><span class="linenos">66</span></a><span class="sd">            original_size: Original size of the dimension.</span>
</span><span id="ReformattingSpatialShape.target_size-67"><a href="#ReformattingSpatialShape.target_size-67"><span class="linenos">67</span></a><span class="sd">            downsampling_factor: Downsampling factor of the dimension during reformatting.</span>
</span><span id="ReformattingSpatialShape.target_size-68"><a href="#ReformattingSpatialShape.target_size-68"><span class="linenos">68</span></a>
</span><span id="ReformattingSpatialShape.target_size-69"><a href="#ReformattingSpatialShape.target_size-69"><span class="linenos">69</span></a><span class="sd">        Returns:</span>
</span><span id="ReformattingSpatialShape.target_size-70"><a href="#ReformattingSpatialShape.target_size-70"><span class="linenos">70</span></a><span class="sd">            Target size of the dimension.</span>
</span><span id="ReformattingSpatialShape.target_size-71"><a href="#ReformattingSpatialShape.target_size-71"><span class="linenos">71</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Return a target size given an original size and a downsampling factor.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>original_size:</strong>  Original size of the dimension.</li>
<li><strong>downsampling_factor:</strong>  Downsampling factor of the dimension during reformatting.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Target size of the dimension.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="RectangleMask">
                            <input id="RectangleMask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">RectangleMask</span><wbr>(<span class="base">composable_mapping.tensor_like.BaseTensorLikeWrapper</span>, <span class="base"><a href="#ComposableMapping">composable_mapping.ComposableMapping</a></span>):

                <label class="view-source-button" for="RectangleMask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RectangleMask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RectangleMask-17"><a href="#RectangleMask-17"><span class="linenos">17</span></a><span class="k">class</span> <span class="nc">RectangleMask</span><span class="p">(</span><span class="n">BaseTensorLikeWrapper</span><span class="p">,</span> <span class="n">ComposableMapping</span><span class="p">):</span>
</span><span id="RectangleMask-18"><a href="#RectangleMask-18"><span class="linenos">18</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Modify mask of the input based on bounds</span>
</span><span id="RectangleMask-19"><a href="#RectangleMask-19"><span class="linenos">19</span></a>
</span><span id="RectangleMask-20"><a href="#RectangleMask-20"><span class="linenos">20</span></a><span class="sd">    Arguments.</span>
</span><span id="RectangleMask-21"><a href="#RectangleMask-21"><span class="linenos">21</span></a><span class="sd">        min_values: Minimum values for the mask over each dimension.</span>
</span><span id="RectangleMask-22"><a href="#RectangleMask-22"><span class="linenos">22</span></a><span class="sd">        max_values: Maximum values for the mask over each dimension.</span>
</span><span id="RectangleMask-23"><a href="#RectangleMask-23"><span class="linenos">23</span></a><span class="sd">        inclusive_min: Whether the minimum values are inclusive.</span>
</span><span id="RectangleMask-24"><a href="#RectangleMask-24"><span class="linenos">24</span></a><span class="sd">        inclusive_max: Whether the maximum values are inclusive</span>
</span><span id="RectangleMask-25"><a href="#RectangleMask-25"><span class="linenos">25</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="RectangleMask-26"><a href="#RectangleMask-26"><span class="linenos">26</span></a>
</span><span id="RectangleMask-27"><a href="#RectangleMask-27"><span class="linenos">27</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="RectangleMask-28"><a href="#RectangleMask-28"><span class="linenos">28</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="RectangleMask-29"><a href="#RectangleMask-29"><span class="linenos">29</span></a>        <span class="n">min_values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
</span><span id="RectangleMask-30"><a href="#RectangleMask-30"><span class="linenos">30</span></a>        <span class="n">max_values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
</span><span id="RectangleMask-31"><a href="#RectangleMask-31"><span class="linenos">31</span></a>        <span class="n">inclusive_min</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="RectangleMask-32"><a href="#RectangleMask-32"><span class="linenos">32</span></a>        <span class="n">inclusive_max</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="RectangleMask-33"><a href="#RectangleMask-33"><span class="linenos">33</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RectangleMask-34"><a href="#RectangleMask-34"><span class="linenos">34</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_min_values</span> <span class="o">=</span> <span class="n">min_values</span>
</span><span id="RectangleMask-35"><a href="#RectangleMask-35"><span class="linenos">35</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_max_values</span> <span class="o">=</span> <span class="n">max_values</span>
</span><span id="RectangleMask-36"><a href="#RectangleMask-36"><span class="linenos">36</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_inclusive_min</span> <span class="o">=</span> <span class="n">inclusive_min</span>
</span><span id="RectangleMask-37"><a href="#RectangleMask-37"><span class="linenos">37</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_inclusive_max</span> <span class="o">=</span> <span class="n">inclusive_max</span>
</span><span id="RectangleMask-38"><a href="#RectangleMask-38"><span class="linenos">38</span></a>
</span><span id="RectangleMask-39"><a href="#RectangleMask-39"><span class="linenos">39</span></a>    <span class="k">def</span> <span class="nf">_get_tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="RectangleMask-40"><a href="#RectangleMask-40"><span class="linenos">40</span></a>        <span class="k">return</span> <span class="p">{}</span>
</span><span id="RectangleMask-41"><a href="#RectangleMask-41"><span class="linenos">41</span></a>
</span><span id="RectangleMask-42"><a href="#RectangleMask-42"><span class="linenos">42</span></a>    <span class="k">def</span> <span class="nf">_get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]:</span>
</span><span id="RectangleMask-43"><a href="#RectangleMask-43"><span class="linenos">43</span></a>        <span class="k">return</span> <span class="p">{}</span>
</span><span id="RectangleMask-44"><a href="#RectangleMask-44"><span class="linenos">44</span></a>
</span><span id="RectangleMask-45"><a href="#RectangleMask-45"><span class="linenos">45</span></a>    <span class="k">def</span> <span class="nf">_modified_copy</span><span class="p">(</span>
</span><span id="RectangleMask-46"><a href="#RectangleMask-46"><span class="linenos">46</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">tensors</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">children</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]</span>
</span><span id="RectangleMask-47"><a href="#RectangleMask-47"><span class="linenos">47</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RectangleMask&quot;</span><span class="p">:</span>
</span><span id="RectangleMask-48"><a href="#RectangleMask-48"><span class="linenos">48</span></a>        <span class="k">return</span> <span class="n">RectangleMask</span><span class="p">(</span><span class="n">min_values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_values</span><span class="p">,</span> <span class="n">max_values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_values</span><span class="p">)</span>
</span><span id="RectangleMask-49"><a href="#RectangleMask-49"><span class="linenos">49</span></a>
</span><span id="RectangleMask-50"><a href="#RectangleMask-50"><span class="linenos">50</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="RectangleMask-51"><a href="#RectangleMask-51"><span class="linenos">51</span></a>        <span class="n">values</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">generate_values</span><span class="p">()</span>
</span><span id="RectangleMask-52"><a href="#RectangleMask-52"><span class="linenos">52</span></a>        <span class="n">update_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_mask_based_on_bounds</span><span class="p">(</span>
</span><span id="RectangleMask-53"><a href="#RectangleMask-53"><span class="linenos">53</span></a>            <span class="n">coordinates</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
</span><span id="RectangleMask-54"><a href="#RectangleMask-54"><span class="linenos">54</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">coordinates</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="RectangleMask-55"><a href="#RectangleMask-55"><span class="linenos">55</span></a>            <span class="n">min_values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_values</span><span class="p">,</span>
</span><span id="RectangleMask-56"><a href="#RectangleMask-56"><span class="linenos">56</span></a>            <span class="n">max_values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_values</span><span class="p">,</span>
</span><span id="RectangleMask-57"><a href="#RectangleMask-57"><span class="linenos">57</span></a>            <span class="n">inclusive_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inclusive_min</span><span class="p">,</span>
</span><span id="RectangleMask-58"><a href="#RectangleMask-58"><span class="linenos">58</span></a>            <span class="n">inclusive_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_inclusive_max</span><span class="p">,</span>
</span><span id="RectangleMask-59"><a href="#RectangleMask-59"><span class="linenos">59</span></a>        <span class="p">)</span>
</span><span id="RectangleMask-60"><a href="#RectangleMask-60"><span class="linenos">60</span></a>        <span class="k">return</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">mask_and</span><span class="p">(</span><span class="n">update_mask</span><span class="p">)</span>
</span><span id="RectangleMask-61"><a href="#RectangleMask-61"><span class="linenos">61</span></a>
</span><span id="RectangleMask-62"><a href="#RectangleMask-62"><span class="linenos">62</span></a>    <span class="nd">@staticmethod</span>
</span><span id="RectangleMask-63"><a href="#RectangleMask-63"><span class="linenos">63</span></a>    <span class="k">def</span> <span class="nf">_generate_mask_based_on_bounds</span><span class="p">(</span>
</span><span id="RectangleMask-64"><a href="#RectangleMask-64"><span class="linenos">64</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="RectangleMask-65"><a href="#RectangleMask-65"><span class="linenos">65</span></a>        <span class="n">min_values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
</span><span id="RectangleMask-66"><a href="#RectangleMask-66"><span class="linenos">66</span></a>        <span class="n">max_values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
</span><span id="RectangleMask-67"><a href="#RectangleMask-67"><span class="linenos">67</span></a>        <span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="RectangleMask-68"><a href="#RectangleMask-68"><span class="linenos">68</span></a>        <span class="n">inclusive_min</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="RectangleMask-69"><a href="#RectangleMask-69"><span class="linenos">69</span></a>        <span class="n">inclusive_max</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="RectangleMask-70"><a href="#RectangleMask-70"><span class="linenos">70</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="RectangleMask-71"><a href="#RectangleMask-71"><span class="linenos">71</span></a>        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">move_channels_last</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="RectangleMask-72"><a href="#RectangleMask-72"><span class="linenos">72</span></a>        <span class="n">non_blocking</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;cpu&quot;</span>
</span><span id="RectangleMask-73"><a href="#RectangleMask-73"><span class="linenos">73</span></a>        <span class="n">min_values_tensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">min_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">coordinates</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
</span><span id="RectangleMask-74"><a href="#RectangleMask-74"><span class="linenos">74</span></a>            <span class="n">device</span><span class="o">=</span><span class="n">coordinates</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="n">non_blocking</span>
</span><span id="RectangleMask-75"><a href="#RectangleMask-75"><span class="linenos">75</span></a>        <span class="p">)</span>
</span><span id="RectangleMask-76"><a href="#RectangleMask-76"><span class="linenos">76</span></a>        <span class="n">max_values_tensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">max_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">coordinates</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
</span><span id="RectangleMask-77"><a href="#RectangleMask-77"><span class="linenos">77</span></a>            <span class="n">device</span><span class="o">=</span><span class="n">coordinates</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">non_blocking</span><span class="o">=</span><span class="n">non_blocking</span>
</span><span id="RectangleMask-78"><a href="#RectangleMask-78"><span class="linenos">78</span></a>        <span class="p">)</span>
</span><span id="RectangleMask-79"><a href="#RectangleMask-79"><span class="linenos">79</span></a>        <span class="n">normalized_coordinates</span> <span class="o">=</span> <span class="p">(</span><span class="n">coordinates</span> <span class="o">-</span> <span class="n">min_values_tensor</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="RectangleMask-80"><a href="#RectangleMask-80"><span class="linenos">80</span></a>            <span class="n">max_values_tensor</span> <span class="o">-</span> <span class="n">min_values_tensor</span>
</span><span id="RectangleMask-81"><a href="#RectangleMask-81"><span class="linenos">81</span></a>        <span class="p">)</span>
</span><span id="RectangleMask-82"><a href="#RectangleMask-82"><span class="linenos">82</span></a>        <span class="n">min_operator</span> <span class="o">=</span> <span class="n">ge</span> <span class="k">if</span> <span class="n">inclusive_min</span> <span class="k">else</span> <span class="n">gt</span>
</span><span id="RectangleMask-83"><a href="#RectangleMask-83"><span class="linenos">83</span></a>        <span class="n">max_operator</span> <span class="o">=</span> <span class="n">le</span> <span class="k">if</span> <span class="n">inclusive_max</span> <span class="k">else</span> <span class="n">lt</span>
</span><span id="RectangleMask-84"><a href="#RectangleMask-84"><span class="linenos">84</span></a>        <span class="n">fov_mask</span> <span class="o">=</span> <span class="n">min_operator</span><span class="p">(</span><span class="n">normalized_coordinates</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">max_operator</span><span class="p">(</span><span class="n">normalized_coordinates</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="RectangleMask-85"><a href="#RectangleMask-85"><span class="linenos">85</span></a>        <span class="n">fov_mask</span> <span class="o">=</span> <span class="n">move_channels_first</span><span class="p">(</span>
</span><span id="RectangleMask-86"><a href="#RectangleMask-86"><span class="linenos">86</span></a>            <span class="n">torch_all</span><span class="p">(</span><span class="n">fov_mask</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span>
</span><span id="RectangleMask-87"><a href="#RectangleMask-87"><span class="linenos">87</span></a>        <span class="p">)</span>
</span><span id="RectangleMask-88"><a href="#RectangleMask-88"><span class="linenos">88</span></a>        <span class="k">return</span> <span class="n">fov_mask</span>
</span><span id="RectangleMask-89"><a href="#RectangleMask-89"><span class="linenos">89</span></a>
</span><span id="RectangleMask-90"><a href="#RectangleMask-90"><span class="linenos">90</span></a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">):</span>
</span><span id="RectangleMask-91"><a href="#RectangleMask-91"><span class="linenos">91</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Rectangle mask is not invertible&quot;</span><span class="p">)</span>
</span><span id="RectangleMask-92"><a href="#RectangleMask-92"><span class="linenos">92</span></a>
</span><span id="RectangleMask-93"><a href="#RectangleMask-93"><span class="linenos">93</span></a>    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RectangleMask&quot;</span><span class="p">:</span>
</span><span id="RectangleMask-94"><a href="#RectangleMask-94"><span class="linenos">94</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="RectangleMask-95"><a href="#RectangleMask-95"><span class="linenos">95</span></a>
</span><span id="RectangleMask-96"><a href="#RectangleMask-96"><span class="linenos">96</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="RectangleMask-97"><a href="#RectangleMask-97"><span class="linenos">97</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;RectangleMask(min_values=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_min_values</span><span class="si">}</span><span class="s2">, max_values=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_values</span><span class="si">}</span><span class="s2">)&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Modify mask of the input based on bounds</p>

<p>Arguments.
    min_values: Minimum values for the mask over each dimension.
    max_values: Maximum values for the mask over each dimension.
    inclusive_min: Whether the minimum values are inclusive.
    inclusive_max: Whether the maximum values are inclusive</p>
</div>


                            <div id="RectangleMask.__init__" class="classattr">
                                        <input id="RectangleMask.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">RectangleMask</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">min_values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">max_values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>,</span><span class="param">	<span class="n">inclusive_min</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">inclusive_max</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span>)</span>

                <label class="view-source-button" for="RectangleMask.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RectangleMask.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RectangleMask.__init__-27"><a href="#RectangleMask.__init__-27"><span class="linenos">27</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="RectangleMask.__init__-28"><a href="#RectangleMask.__init__-28"><span class="linenos">28</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="RectangleMask.__init__-29"><a href="#RectangleMask.__init__-29"><span class="linenos">29</span></a>        <span class="n">min_values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
</span><span id="RectangleMask.__init__-30"><a href="#RectangleMask.__init__-30"><span class="linenos">30</span></a>        <span class="n">max_values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
</span><span id="RectangleMask.__init__-31"><a href="#RectangleMask.__init__-31"><span class="linenos">31</span></a>        <span class="n">inclusive_min</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="RectangleMask.__init__-32"><a href="#RectangleMask.__init__-32"><span class="linenos">32</span></a>        <span class="n">inclusive_max</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="RectangleMask.__init__-33"><a href="#RectangleMask.__init__-33"><span class="linenos">33</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="RectangleMask.__init__-34"><a href="#RectangleMask.__init__-34"><span class="linenos">34</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_min_values</span> <span class="o">=</span> <span class="n">min_values</span>
</span><span id="RectangleMask.__init__-35"><a href="#RectangleMask.__init__-35"><span class="linenos">35</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_max_values</span> <span class="o">=</span> <span class="n">max_values</span>
</span><span id="RectangleMask.__init__-36"><a href="#RectangleMask.__init__-36"><span class="linenos">36</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_inclusive_min</span> <span class="o">=</span> <span class="n">inclusive_min</span>
</span><span id="RectangleMask.__init__-37"><a href="#RectangleMask.__init__-37"><span class="linenos">37</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_inclusive_max</span> <span class="o">=</span> <span class="n">inclusive_max</span>
</span></pre></div>


    

                            </div>
                            <div id="RectangleMask.invert" class="classattr">
                                        <input id="RectangleMask.invert-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">invert</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">**</span><span class="n">arguments</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="RectangleMask.invert-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RectangleMask.invert"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RectangleMask.invert-90"><a href="#RectangleMask.invert-90"><span class="linenos">90</span></a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">):</span>
</span><span id="RectangleMask.invert-91"><a href="#RectangleMask.invert-91"><span class="linenos">91</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Rectangle mask is not invertible&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Invert the mapping.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>arguments:</strong>  Arguments for the inversion.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>The inverted mapping.</p>
</blockquote>
</div>


                            </div>
                            <div id="RectangleMask.detach" class="classattr">
                                        <input id="RectangleMask.detach-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">detach</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n"><a href="#RectangleMask">RectangleMask</a></span>:</span></span>

                <label class="view-source-button" for="RectangleMask.detach-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RectangleMask.detach"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RectangleMask.detach-93"><a href="#RectangleMask.detach-93"><span class="linenos">93</span></a>    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;RectangleMask&quot;</span><span class="p">:</span>
</span><span id="RectangleMask.detach-94"><a href="#RectangleMask.detach-94"><span class="linenos">94</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Detach the wrapped tensors from computational graph</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>composable_mapping.tensor_like.BaseTensorLikeWrapper</dt>
                                <dd id="RectangleMask.dtype" class="variable">dtype</dd>
                <dd id="RectangleMask.device" class="variable">device</dd>
                <dd id="RectangleMask.cast" class="function">cast</dd>
                <dd id="RectangleMask.pin_memory" class="function">pin_memory</dd>

            </div>
            <div><dt><a href="#ComposableMapping">ComposableMapping</a></dt>
                                <dd id="RectangleMask.sample_to" class="function"><a href="#ComposableMapping.sample_to">sample_to</a></dd>
                <dd id="RectangleMask.resample_to" class="function"><a href="#ComposableMapping.resample_to">resample_to</a></dd>
                <dd id="RectangleMask.assign_coordinates" class="function"><a href="#ComposableMapping.assign_coordinates">assign_coordinates</a></dd>
                <dd id="RectangleMask.as_affine_transformation" class="function"><a href="#ComposableMapping.as_affine_transformation">as_affine_transformation</a></dd>
                <dd id="RectangleMask.as_affine_matrix" class="function"><a href="#ComposableMapping.as_affine_matrix">as_affine_matrix</a></dd>
                <dd id="RectangleMask.default_sampling_data_format" class="variable"><a href="#ComposableMapping.default_sampling_data_format">default_sampling_data_format</a></dd>
                <dd id="RectangleMask.set_default_sampling_data_format" class="function"><a href="#ComposableMapping.set_default_sampling_data_format">set_default_sampling_data_format</a></dd>
                <dd id="RectangleMask.__matmul__" class="function"><a href="#ComposableMapping.__matmul__">__matmul__</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="SamplableVolume">
                            <input id="SamplableVolume-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SamplableVolume</span><wbr>(<span class="base">composable_mapping.tensor_like.BaseTensorLikeWrapper</span>, <span class="base"><a href="#GridComposableMapping">composable_mapping.GridComposableMapping</a></span>):

                <label class="view-source-button" for="SamplableVolume-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SamplableVolume"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SamplableVolume-710"><a href="#SamplableVolume-710"><span class="linenos">710</span></a><span class="k">class</span> <span class="nc">SamplableVolume</span><span class="p">(</span><span class="n">BaseTensorLikeWrapper</span><span class="p">,</span> <span class="n">GridComposableMapping</span><span class="p">):</span>
</span><span id="SamplableVolume-711"><a href="#SamplableVolume-711"><span class="linenos">711</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mapping defined based on a regular grid of values and a sampler turning the</span>
</span><span id="SamplableVolume-712"><a href="#SamplableVolume-712"><span class="linenos">712</span></a><span class="sd">    grid values into a continuously defined mapping.</span>
</span><span id="SamplableVolume-713"><a href="#SamplableVolume-713"><span class="linenos">713</span></a>
</span><span id="SamplableVolume-714"><a href="#SamplableVolume-714"><span class="linenos">714</span></a><span class="sd">    The easiest way to create a samplable volume is to use the factory</span>
</span><span id="SamplableVolume-715"><a href="#SamplableVolume-715"><span class="linenos">715</span></a><span class="sd">    function provided in this module or the class method of this class:</span>
</span><span id="SamplableVolume-716"><a href="#SamplableVolume-716"><span class="linenos">716</span></a><span class="sd">    `samplable_volume`, `SamplableVolume.from_tensor`.</span>
</span><span id="SamplableVolume-717"><a href="#SamplableVolume-717"><span class="linenos">717</span></a>
</span><span id="SamplableVolume-718"><a href="#SamplableVolume-718"><span class="linenos">718</span></a><span class="sd">    Arguments:</span>
</span><span id="SamplableVolume-719"><a href="#SamplableVolume-719"><span class="linenos">719</span></a><span class="sd">        data: Regular grid of values, with shape</span>
</span><span id="SamplableVolume-720"><a href="#SamplableVolume-720"><span class="linenos">720</span></a><span class="sd">            (*batch_shape, *channels_shape, *spatial_shape).</span>
</span><span id="SamplableVolume-721"><a href="#SamplableVolume-721"><span class="linenos">721</span></a><span class="sd">        coordinate_system: Coordinate system describing transformation from the</span>
</span><span id="SamplableVolume-722"><a href="#SamplableVolume-722"><span class="linenos">722</span></a><span class="sd">            voxel coordinates on the data grid to the world coordinates.</span>
</span><span id="SamplableVolume-723"><a href="#SamplableVolume-723"><span class="linenos">723</span></a><span class="sd">        data_format: Data format of the grid values.</span>
</span><span id="SamplableVolume-724"><a href="#SamplableVolume-724"><span class="linenos">724</span></a><span class="sd">        sampler: Sampler turning the grid values into a continuously defined mapping</span>
</span><span id="SamplableVolume-725"><a href="#SamplableVolume-725"><span class="linenos">725</span></a><span class="sd">            over spatial coordinates.</span>
</span><span id="SamplableVolume-726"><a href="#SamplableVolume-726"><span class="linenos">726</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SamplableVolume-727"><a href="#SamplableVolume-727"><span class="linenos">727</span></a>
</span><span id="SamplableVolume-728"><a href="#SamplableVolume-728"><span class="linenos">728</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="SamplableVolume-729"><a href="#SamplableVolume-729"><span class="linenos">729</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SamplableVolume-730"><a href="#SamplableVolume-730"><span class="linenos">730</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span>
</span><span id="SamplableVolume-731"><a href="#SamplableVolume-731"><span class="linenos">731</span></a>        <span class="n">coordinate_system</span><span class="p">:</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">,</span>
</span><span id="SamplableVolume-732"><a href="#SamplableVolume-732"><span class="linenos">732</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">DataFormat</span> <span class="o">=</span> <span class="n">DataFormat</span><span class="o">.</span><span class="n">world_coordinates</span><span class="p">(),</span>
</span><span id="SamplableVolume-733"><a href="#SamplableVolume-733"><span class="linenos">733</span></a>        <span class="n">sampler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ISampler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SamplableVolume-734"><a href="#SamplableVolume-734"><span class="linenos">734</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SamplableVolume-735"><a href="#SamplableVolume-735"><span class="linenos">735</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="SamplableVolume-736"><a href="#SamplableVolume-736"><span class="linenos">736</span></a>        <span class="k">if</span> <span class="n">coordinate_system</span><span class="o">.</span><span class="n">spatial_shape</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">:</span>
</span><span id="SamplableVolume-737"><a href="#SamplableVolume-737"><span class="linenos">737</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="SamplableVolume-738"><a href="#SamplableVolume-738"><span class="linenos">738</span></a>                <span class="s2">&quot;Coordinate system spatial shape must match the data spatial shape. &quot;</span>
</span><span id="SamplableVolume-739"><a href="#SamplableVolume-739"><span class="linenos">739</span></a>                <span class="sa">f</span><span class="s2">&quot;Coordinate system spatial shape: </span><span class="si">{</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">spatial_shape</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="SamplableVolume-740"><a href="#SamplableVolume-740"><span class="linenos">740</span></a>                <span class="sa">f</span><span class="s2">&quot;data spatial shape: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">spatial_shape</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="SamplableVolume-741"><a href="#SamplableVolume-741"><span class="linenos">741</span></a>            <span class="p">)</span>
</span><span id="SamplableVolume-742"><a href="#SamplableVolume-742"><span class="linenos">742</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="SamplableVolume-743"><a href="#SamplableVolume-743"><span class="linenos">743</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_system</span> <span class="o">=</span> <span class="n">coordinate_system</span>
</span><span id="SamplableVolume-744"><a href="#SamplableVolume-744"><span class="linenos">744</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_data_format</span> <span class="o">=</span> <span class="n">data_format</span>
</span><span id="SamplableVolume-745"><a href="#SamplableVolume-745"><span class="linenos">745</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span> <span class="o">=</span> <span class="n">get_sampler</span><span class="p">(</span><span class="n">sampler</span><span class="p">)</span>
</span><span id="SamplableVolume-746"><a href="#SamplableVolume-746"><span class="linenos">746</span></a>
</span><span id="SamplableVolume-747"><a href="#SamplableVolume-747"><span class="linenos">747</span></a>    <span class="k">def</span> <span class="nf">from_tensor</span><span class="p">(</span>
</span><span id="SamplableVolume-748"><a href="#SamplableVolume-748"><span class="linenos">748</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SamplableVolume-749"><a href="#SamplableVolume-749"><span class="linenos">749</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="SamplableVolume-750"><a href="#SamplableVolume-750"><span class="linenos">750</span></a>        <span class="n">coordinate_system</span><span class="p">:</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">,</span>
</span><span id="SamplableVolume-751"><a href="#SamplableVolume-751"><span class="linenos">751</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SamplableVolume-752"><a href="#SamplableVolume-752"><span class="linenos">752</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">DataFormat</span> <span class="o">=</span> <span class="n">DataFormat</span><span class="o">.</span><span class="n">world_coordinates</span><span class="p">(),</span>
</span><span id="SamplableVolume-753"><a href="#SamplableVolume-753"><span class="linenos">753</span></a>        <span class="n">sampler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ISampler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SamplableVolume-754"><a href="#SamplableVolume-754"><span class="linenos">754</span></a>    <span class="p">):</span>
</span><span id="SamplableVolume-755"><a href="#SamplableVolume-755"><span class="linenos">755</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a samplable volume from a tensor.</span>
</span><span id="SamplableVolume-756"><a href="#SamplableVolume-756"><span class="linenos">756</span></a>
</span><span id="SamplableVolume-757"><a href="#SamplableVolume-757"><span class="linenos">757</span></a><span class="sd">        Args:</span>
</span><span id="SamplableVolume-758"><a href="#SamplableVolume-758"><span class="linenos">758</span></a><span class="sd">            data: Regular grid of values, with shape</span>
</span><span id="SamplableVolume-759"><a href="#SamplableVolume-759"><span class="linenos">759</span></a><span class="sd">                (*batch_shape, *channels_shape, *spatial_shape).</span>
</span><span id="SamplableVolume-760"><a href="#SamplableVolume-760"><span class="linenos">760</span></a><span class="sd">            coordinate_system: Coordinate system describing transformation from the</span>
</span><span id="SamplableVolume-761"><a href="#SamplableVolume-761"><span class="linenos">761</span></a><span class="sd">                voxel coordinates on the data grid to the world coordinates.</span>
</span><span id="SamplableVolume-762"><a href="#SamplableVolume-762"><span class="linenos">762</span></a><span class="sd">            mask: Mask for the data,</span>
</span><span id="SamplableVolume-763"><a href="#SamplableVolume-763"><span class="linenos">763</span></a><span class="sd">                with shape (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</span>
</span><span id="SamplableVolume-764"><a href="#SamplableVolume-764"><span class="linenos">764</span></a><span class="sd">            data_format: Data format of the grid values.</span>
</span><span id="SamplableVolume-765"><a href="#SamplableVolume-765"><span class="linenos">765</span></a><span class="sd">            sampler: Sampler turning the grid values into a continuously defined mapping</span>
</span><span id="SamplableVolume-766"><a href="#SamplableVolume-766"><span class="linenos">766</span></a><span class="sd">                over spatial coordinates.</span>
</span><span id="SamplableVolume-767"><a href="#SamplableVolume-767"><span class="linenos">767</span></a>
</span><span id="SamplableVolume-768"><a href="#SamplableVolume-768"><span class="linenos">768</span></a><span class="sd">        Returns:</span>
</span><span id="SamplableVolume-769"><a href="#SamplableVolume-769"><span class="linenos">769</span></a><span class="sd">            Samplable volume.</span>
</span><span id="SamplableVolume-770"><a href="#SamplableVolume-770"><span class="linenos">770</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SamplableVolume-771"><a href="#SamplableVolume-771"><span class="linenos">771</span></a>        <span class="k">return</span> <span class="n">SamplableVolume</span><span class="p">(</span>
</span><span id="SamplableVolume-772"><a href="#SamplableVolume-772"><span class="linenos">772</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">mappable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="p">),</span>
</span><span id="SamplableVolume-773"><a href="#SamplableVolume-773"><span class="linenos">773</span></a>            <span class="n">coordinate_system</span><span class="o">=</span><span class="n">coordinate_system</span><span class="p">,</span>
</span><span id="SamplableVolume-774"><a href="#SamplableVolume-774"><span class="linenos">774</span></a>            <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">,</span>
</span><span id="SamplableVolume-775"><a href="#SamplableVolume-775"><span class="linenos">775</span></a>            <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span>
</span><span id="SamplableVolume-776"><a href="#SamplableVolume-776"><span class="linenos">776</span></a>        <span class="p">)</span>
</span><span id="SamplableVolume-777"><a href="#SamplableVolume-777"><span class="linenos">777</span></a>
</span><span id="SamplableVolume-778"><a href="#SamplableVolume-778"><span class="linenos">778</span></a>    <span class="k">def</span> <span class="nf">modify_sampler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sampler</span><span class="p">:</span> <span class="n">ISampler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SamplableVolume&quot;</span><span class="p">:</span>
</span><span id="SamplableVolume-779"><a href="#SamplableVolume-779"><span class="linenos">779</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify the sampler of the volume.</span>
</span><span id="SamplableVolume-780"><a href="#SamplableVolume-780"><span class="linenos">780</span></a>
</span><span id="SamplableVolume-781"><a href="#SamplableVolume-781"><span class="linenos">781</span></a><span class="sd">        Args:</span>
</span><span id="SamplableVolume-782"><a href="#SamplableVolume-782"><span class="linenos">782</span></a><span class="sd">            sampler: New sampler.</span>
</span><span id="SamplableVolume-783"><a href="#SamplableVolume-783"><span class="linenos">783</span></a>
</span><span id="SamplableVolume-784"><a href="#SamplableVolume-784"><span class="linenos">784</span></a><span class="sd">        Returns:</span>
</span><span id="SamplableVolume-785"><a href="#SamplableVolume-785"><span class="linenos">785</span></a><span class="sd">            Samplable volume with the new sampler.</span>
</span><span id="SamplableVolume-786"><a href="#SamplableVolume-786"><span class="linenos">786</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SamplableVolume-787"><a href="#SamplableVolume-787"><span class="linenos">787</span></a>        <span class="k">return</span> <span class="n">SamplableVolume</span><span class="p">(</span>
</span><span id="SamplableVolume-788"><a href="#SamplableVolume-788"><span class="linenos">788</span></a>            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
</span><span id="SamplableVolume-789"><a href="#SamplableVolume-789"><span class="linenos">789</span></a>            <span class="n">coordinate_system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_system</span><span class="p">,</span>
</span><span id="SamplableVolume-790"><a href="#SamplableVolume-790"><span class="linenos">790</span></a>            <span class="n">data_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_format</span><span class="p">,</span>
</span><span id="SamplableVolume-791"><a href="#SamplableVolume-791"><span class="linenos">791</span></a>            <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span>
</span><span id="SamplableVolume-792"><a href="#SamplableVolume-792"><span class="linenos">792</span></a>        <span class="p">)</span>
</span><span id="SamplableVolume-793"><a href="#SamplableVolume-793"><span class="linenos">793</span></a>
</span><span id="SamplableVolume-794"><a href="#SamplableVolume-794"><span class="linenos">794</span></a>    <span class="nd">@property</span>
</span><span id="SamplableVolume-795"><a href="#SamplableVolume-795"><span class="linenos">795</span></a>    <span class="k">def</span> <span class="nf">coordinate_system</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="SamplableVolume-796"><a href="#SamplableVolume-796"><span class="linenos">796</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_system</span>
</span><span id="SamplableVolume-797"><a href="#SamplableVolume-797"><span class="linenos">797</span></a>
</span><span id="SamplableVolume-798"><a href="#SamplableVolume-798"><span class="linenos">798</span></a>    <span class="nd">@property</span>
</span><span id="SamplableVolume-799"><a href="#SamplableVolume-799"><span class="linenos">799</span></a>    <span class="k">def</span> <span class="nf">default_sampling_data_format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFormat</span><span class="p">:</span>
</span><span id="SamplableVolume-800"><a href="#SamplableVolume-800"><span class="linenos">800</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_format</span>
</span><span id="SamplableVolume-801"><a href="#SamplableVolume-801"><span class="linenos">801</span></a>
</span><span id="SamplableVolume-802"><a href="#SamplableVolume-802"><span class="linenos">802</span></a>    <span class="k">def</span> <span class="nf">_get_tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="SamplableVolume-803"><a href="#SamplableVolume-803"><span class="linenos">803</span></a>        <span class="k">return</span> <span class="p">{}</span>
</span><span id="SamplableVolume-804"><a href="#SamplableVolume-804"><span class="linenos">804</span></a>
</span><span id="SamplableVolume-805"><a href="#SamplableVolume-805"><span class="linenos">805</span></a>    <span class="k">def</span> <span class="nf">_get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]:</span>
</span><span id="SamplableVolume-806"><a href="#SamplableVolume-806"><span class="linenos">806</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="SamplableVolume-807"><a href="#SamplableVolume-807"><span class="linenos">807</span></a>            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
</span><span id="SamplableVolume-808"><a href="#SamplableVolume-808"><span class="linenos">808</span></a>            <span class="s2">&quot;coordinate_system&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_system</span><span class="p">,</span>
</span><span id="SamplableVolume-809"><a href="#SamplableVolume-809"><span class="linenos">809</span></a>        <span class="p">}</span>
</span><span id="SamplableVolume-810"><a href="#SamplableVolume-810"><span class="linenos">810</span></a>
</span><span id="SamplableVolume-811"><a href="#SamplableVolume-811"><span class="linenos">811</span></a>    <span class="k">def</span> <span class="nf">_modified_copy</span><span class="p">(</span>
</span><span id="SamplableVolume-812"><a href="#SamplableVolume-812"><span class="linenos">812</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">tensors</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">children</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]</span>
</span><span id="SamplableVolume-813"><a href="#SamplableVolume-813"><span class="linenos">813</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SamplableVolume&quot;</span><span class="p">:</span>
</span><span id="SamplableVolume-814"><a href="#SamplableVolume-814"><span class="linenos">814</span></a>        <span class="k">return</span> <span class="n">SamplableVolume</span><span class="p">(</span>
</span><span id="SamplableVolume-815"><a href="#SamplableVolume-815"><span class="linenos">815</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="n">MappableTensor</span><span class="p">,</span> <span class="n">children</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]),</span>
</span><span id="SamplableVolume-816"><a href="#SamplableVolume-816"><span class="linenos">816</span></a>            <span class="n">coordinate_system</span><span class="o">=</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">,</span> <span class="n">children</span><span class="p">[</span><span class="s2">&quot;coordinate_system&quot;</span><span class="p">]),</span>
</span><span id="SamplableVolume-817"><a href="#SamplableVolume-817"><span class="linenos">817</span></a>            <span class="n">data_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_format</span><span class="p">,</span>
</span><span id="SamplableVolume-818"><a href="#SamplableVolume-818"><span class="linenos">818</span></a>            <span class="n">sampler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="p">,</span>
</span><span id="SamplableVolume-819"><a href="#SamplableVolume-819"><span class="linenos">819</span></a>        <span class="p">)</span>
</span><span id="SamplableVolume-820"><a href="#SamplableVolume-820"><span class="linenos">820</span></a>
</span><span id="SamplableVolume-821"><a href="#SamplableVolume-821"><span class="linenos">821</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="SamplableVolume-822"><a href="#SamplableVolume-822"><span class="linenos">822</span></a>        <span class="n">voxel_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_system</span><span class="o">.</span><span class="n">to_voxel_coordinates</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
</span><span id="SamplableVolume-823"><a href="#SamplableVolume-823"><span class="linenos">823</span></a>        <span class="n">sampled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">voxel_coordinates</span><span class="p">)</span>
</span><span id="SamplableVolume-824"><a href="#SamplableVolume-824"><span class="linenos">824</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_format</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;displacements&quot;</span><span class="p">:</span>
</span><span id="SamplableVolume-825"><a href="#SamplableVolume-825"><span class="linenos">825</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_format</span><span class="o">.</span><span class="n">coordinate_type</span> <span class="o">==</span> <span class="s2">&quot;voxel&quot;</span><span class="p">:</span>
</span><span id="SamplableVolume-826"><a href="#SamplableVolume-826"><span class="linenos">826</span></a>                <span class="n">sampled</span> <span class="o">=</span> <span class="n">voxel_coordinates</span> <span class="o">+</span> <span class="n">sampled</span>
</span><span id="SamplableVolume-827"><a href="#SamplableVolume-827"><span class="linenos">827</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_format</span><span class="o">.</span><span class="n">coordinate_type</span> <span class="o">==</span> <span class="s2">&quot;world&quot;</span><span class="p">:</span>
</span><span id="SamplableVolume-828"><a href="#SamplableVolume-828"><span class="linenos">828</span></a>                <span class="n">sampled</span> <span class="o">=</span> <span class="n">coordinates</span> <span class="o">+</span> <span class="n">sampled</span>
</span><span id="SamplableVolume-829"><a href="#SamplableVolume-829"><span class="linenos">829</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_format</span><span class="o">.</span><span class="n">coordinate_type</span> <span class="o">==</span> <span class="s2">&quot;voxel&quot;</span><span class="p">:</span>
</span><span id="SamplableVolume-830"><a href="#SamplableVolume-830"><span class="linenos">830</span></a>            <span class="n">sampled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_system</span><span class="o">.</span><span class="n">from_voxel_coordinates</span><span class="p">(</span><span class="n">sampled</span><span class="p">)</span>
</span><span id="SamplableVolume-831"><a href="#SamplableVolume-831"><span class="linenos">831</span></a>        <span class="k">return</span> <span class="n">sampled</span>
</span><span id="SamplableVolume-832"><a href="#SamplableVolume-832"><span class="linenos">832</span></a>
</span><span id="SamplableVolume-833"><a href="#SamplableVolume-833"><span class="linenos">833</span></a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SamplableVolume&quot;</span><span class="p">:</span>
</span><span id="SamplableVolume-834"><a href="#SamplableVolume-834"><span class="linenos">834</span></a>        <span class="k">return</span> <span class="n">SamplableVolume</span><span class="p">(</span>
</span><span id="SamplableVolume-835"><a href="#SamplableVolume-835"><span class="linenos">835</span></a>            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
</span><span id="SamplableVolume-836"><a href="#SamplableVolume-836"><span class="linenos">836</span></a>            <span class="n">coordinate_system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_system</span><span class="p">,</span>
</span><span id="SamplableVolume-837"><a href="#SamplableVolume-837"><span class="linenos">837</span></a>            <span class="n">data_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_format</span><span class="p">,</span>
</span><span id="SamplableVolume-838"><a href="#SamplableVolume-838"><span class="linenos">838</span></a>            <span class="n">sampler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_format</span><span class="p">,</span> <span class="n">arguments</span><span class="p">),</span>
</span><span id="SamplableVolume-839"><a href="#SamplableVolume-839"><span class="linenos">839</span></a>        <span class="p">)</span>
</span><span id="SamplableVolume-840"><a href="#SamplableVolume-840"><span class="linenos">840</span></a>
</span><span id="SamplableVolume-841"><a href="#SamplableVolume-841"><span class="linenos">841</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="SamplableVolume-842"><a href="#SamplableVolume-842"><span class="linenos">842</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="SamplableVolume-843"><a href="#SamplableVolume-843"><span class="linenos">843</span></a>            <span class="sa">f</span><span class="s2">&quot;SamplableVolume(data=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="SamplableVolume-844"><a href="#SamplableVolume-844"><span class="linenos">844</span></a>            <span class="sa">f</span><span class="s2">&quot;coordinate_system=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_system</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="SamplableVolume-845"><a href="#SamplableVolume-845"><span class="linenos">845</span></a>            <span class="sa">f</span><span class="s2">&quot;data_format=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_format</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="SamplableVolume-846"><a href="#SamplableVolume-846"><span class="linenos">846</span></a>            <span class="sa">f</span><span class="s2">&quot;sampler=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="SamplableVolume-847"><a href="#SamplableVolume-847"><span class="linenos">847</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Mapping defined based on a regular grid of values and a sampler turning the
grid values into a continuously defined mapping.</p>

<p>The easiest way to create a samplable volume is to use the factory
function provided in this module or the class method of this class:
<code><a href="#samplable_volume">samplable_volume</a></code>, <code><a href="#SamplableVolume.from_tensor">SamplableVolume.from_tensor</a></code>.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>data:</strong>  Regular grid of values, with shape
(*batch_shape, *channels_shape, *spatial_shape).</li>
<li><strong>coordinate_system:</strong>  Coordinate system describing transformation from the
voxel coordinates on the data grid to the world coordinates.</li>
<li><strong>data_format:</strong>  Data format of the grid values.</li>
<li><strong>sampler:</strong>  Sampler turning the grid values into a continuously defined mapping
over spatial coordinates.</li>
</ul>
</div>


                            <div id="SamplableVolume.__init__" class="classattr">
                                        <input id="SamplableVolume.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SamplableVolume</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>,</span><span class="param">	<span class="n">coordinate_system</span><span class="p">:</span> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>,</span><span class="param">	<span class="n">data_format</span><span class="p">:</span> <span class="n"><a href="#DataFormat">DataFormat</a></span> <span class="o">=</span> <span class="n">DataFormat</span><span class="p">(</span><span class="n">representation</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">coordinate_type</span><span class="o">=</span><span class="n">world</span><span class="p">)</span>,</span><span class="param">	<span class="n">sampler</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#ISampler">ISampler</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="SamplableVolume.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SamplableVolume.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SamplableVolume.__init__-728"><a href="#SamplableVolume.__init__-728"><span class="linenos">728</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="SamplableVolume.__init__-729"><a href="#SamplableVolume.__init__-729"><span class="linenos">729</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SamplableVolume.__init__-730"><a href="#SamplableVolume.__init__-730"><span class="linenos">730</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span>
</span><span id="SamplableVolume.__init__-731"><a href="#SamplableVolume.__init__-731"><span class="linenos">731</span></a>        <span class="n">coordinate_system</span><span class="p">:</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">,</span>
</span><span id="SamplableVolume.__init__-732"><a href="#SamplableVolume.__init__-732"><span class="linenos">732</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">DataFormat</span> <span class="o">=</span> <span class="n">DataFormat</span><span class="o">.</span><span class="n">world_coordinates</span><span class="p">(),</span>
</span><span id="SamplableVolume.__init__-733"><a href="#SamplableVolume.__init__-733"><span class="linenos">733</span></a>        <span class="n">sampler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ISampler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SamplableVolume.__init__-734"><a href="#SamplableVolume.__init__-734"><span class="linenos">734</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SamplableVolume.__init__-735"><a href="#SamplableVolume.__init__-735"><span class="linenos">735</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="SamplableVolume.__init__-736"><a href="#SamplableVolume.__init__-736"><span class="linenos">736</span></a>        <span class="k">if</span> <span class="n">coordinate_system</span><span class="o">.</span><span class="n">spatial_shape</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">:</span>
</span><span id="SamplableVolume.__init__-737"><a href="#SamplableVolume.__init__-737"><span class="linenos">737</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="SamplableVolume.__init__-738"><a href="#SamplableVolume.__init__-738"><span class="linenos">738</span></a>                <span class="s2">&quot;Coordinate system spatial shape must match the data spatial shape. &quot;</span>
</span><span id="SamplableVolume.__init__-739"><a href="#SamplableVolume.__init__-739"><span class="linenos">739</span></a>                <span class="sa">f</span><span class="s2">&quot;Coordinate system spatial shape: </span><span class="si">{</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">spatial_shape</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="SamplableVolume.__init__-740"><a href="#SamplableVolume.__init__-740"><span class="linenos">740</span></a>                <span class="sa">f</span><span class="s2">&quot;data spatial shape: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">spatial_shape</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="SamplableVolume.__init__-741"><a href="#SamplableVolume.__init__-741"><span class="linenos">741</span></a>            <span class="p">)</span>
</span><span id="SamplableVolume.__init__-742"><a href="#SamplableVolume.__init__-742"><span class="linenos">742</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="SamplableVolume.__init__-743"><a href="#SamplableVolume.__init__-743"><span class="linenos">743</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_system</span> <span class="o">=</span> <span class="n">coordinate_system</span>
</span><span id="SamplableVolume.__init__-744"><a href="#SamplableVolume.__init__-744"><span class="linenos">744</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_data_format</span> <span class="o">=</span> <span class="n">data_format</span>
</span><span id="SamplableVolume.__init__-745"><a href="#SamplableVolume.__init__-745"><span class="linenos">745</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span> <span class="o">=</span> <span class="n">get_sampler</span><span class="p">(</span><span class="n">sampler</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="SamplableVolume.from_tensor" class="classattr">
                                        <input id="SamplableVolume.from_tensor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">from_tensor</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>,</span><span class="param">	<span class="n">coordinate_system</span><span class="p">:</span> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">data_format</span><span class="p">:</span> <span class="n"><a href="#DataFormat">DataFormat</a></span> <span class="o">=</span> <span class="n">DataFormat</span><span class="p">(</span><span class="n">representation</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">coordinate_type</span><span class="o">=</span><span class="n">world</span><span class="p">)</span>,</span><span class="param">	<span class="n">sampler</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#ISampler">ISampler</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SamplableVolume.from_tensor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SamplableVolume.from_tensor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SamplableVolume.from_tensor-747"><a href="#SamplableVolume.from_tensor-747"><span class="linenos">747</span></a>    <span class="k">def</span> <span class="nf">from_tensor</span><span class="p">(</span>
</span><span id="SamplableVolume.from_tensor-748"><a href="#SamplableVolume.from_tensor-748"><span class="linenos">748</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SamplableVolume.from_tensor-749"><a href="#SamplableVolume.from_tensor-749"><span class="linenos">749</span></a>        <span class="n">data</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="SamplableVolume.from_tensor-750"><a href="#SamplableVolume.from_tensor-750"><span class="linenos">750</span></a>        <span class="n">coordinate_system</span><span class="p">:</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">,</span>
</span><span id="SamplableVolume.from_tensor-751"><a href="#SamplableVolume.from_tensor-751"><span class="linenos">751</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SamplableVolume.from_tensor-752"><a href="#SamplableVolume.from_tensor-752"><span class="linenos">752</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">DataFormat</span> <span class="o">=</span> <span class="n">DataFormat</span><span class="o">.</span><span class="n">world_coordinates</span><span class="p">(),</span>
</span><span id="SamplableVolume.from_tensor-753"><a href="#SamplableVolume.from_tensor-753"><span class="linenos">753</span></a>        <span class="n">sampler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ISampler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="SamplableVolume.from_tensor-754"><a href="#SamplableVolume.from_tensor-754"><span class="linenos">754</span></a>    <span class="p">):</span>
</span><span id="SamplableVolume.from_tensor-755"><a href="#SamplableVolume.from_tensor-755"><span class="linenos">755</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a samplable volume from a tensor.</span>
</span><span id="SamplableVolume.from_tensor-756"><a href="#SamplableVolume.from_tensor-756"><span class="linenos">756</span></a>
</span><span id="SamplableVolume.from_tensor-757"><a href="#SamplableVolume.from_tensor-757"><span class="linenos">757</span></a><span class="sd">        Args:</span>
</span><span id="SamplableVolume.from_tensor-758"><a href="#SamplableVolume.from_tensor-758"><span class="linenos">758</span></a><span class="sd">            data: Regular grid of values, with shape</span>
</span><span id="SamplableVolume.from_tensor-759"><a href="#SamplableVolume.from_tensor-759"><span class="linenos">759</span></a><span class="sd">                (*batch_shape, *channels_shape, *spatial_shape).</span>
</span><span id="SamplableVolume.from_tensor-760"><a href="#SamplableVolume.from_tensor-760"><span class="linenos">760</span></a><span class="sd">            coordinate_system: Coordinate system describing transformation from the</span>
</span><span id="SamplableVolume.from_tensor-761"><a href="#SamplableVolume.from_tensor-761"><span class="linenos">761</span></a><span class="sd">                voxel coordinates on the data grid to the world coordinates.</span>
</span><span id="SamplableVolume.from_tensor-762"><a href="#SamplableVolume.from_tensor-762"><span class="linenos">762</span></a><span class="sd">            mask: Mask for the data,</span>
</span><span id="SamplableVolume.from_tensor-763"><a href="#SamplableVolume.from_tensor-763"><span class="linenos">763</span></a><span class="sd">                with shape (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</span>
</span><span id="SamplableVolume.from_tensor-764"><a href="#SamplableVolume.from_tensor-764"><span class="linenos">764</span></a><span class="sd">            data_format: Data format of the grid values.</span>
</span><span id="SamplableVolume.from_tensor-765"><a href="#SamplableVolume.from_tensor-765"><span class="linenos">765</span></a><span class="sd">            sampler: Sampler turning the grid values into a continuously defined mapping</span>
</span><span id="SamplableVolume.from_tensor-766"><a href="#SamplableVolume.from_tensor-766"><span class="linenos">766</span></a><span class="sd">                over spatial coordinates.</span>
</span><span id="SamplableVolume.from_tensor-767"><a href="#SamplableVolume.from_tensor-767"><span class="linenos">767</span></a>
</span><span id="SamplableVolume.from_tensor-768"><a href="#SamplableVolume.from_tensor-768"><span class="linenos">768</span></a><span class="sd">        Returns:</span>
</span><span id="SamplableVolume.from_tensor-769"><a href="#SamplableVolume.from_tensor-769"><span class="linenos">769</span></a><span class="sd">            Samplable volume.</span>
</span><span id="SamplableVolume.from_tensor-770"><a href="#SamplableVolume.from_tensor-770"><span class="linenos">770</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SamplableVolume.from_tensor-771"><a href="#SamplableVolume.from_tensor-771"><span class="linenos">771</span></a>        <span class="k">return</span> <span class="n">SamplableVolume</span><span class="p">(</span>
</span><span id="SamplableVolume.from_tensor-772"><a href="#SamplableVolume.from_tensor-772"><span class="linenos">772</span></a>            <span class="n">data</span><span class="o">=</span><span class="n">mappable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="p">),</span>
</span><span id="SamplableVolume.from_tensor-773"><a href="#SamplableVolume.from_tensor-773"><span class="linenos">773</span></a>            <span class="n">coordinate_system</span><span class="o">=</span><span class="n">coordinate_system</span><span class="p">,</span>
</span><span id="SamplableVolume.from_tensor-774"><a href="#SamplableVolume.from_tensor-774"><span class="linenos">774</span></a>            <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">,</span>
</span><span id="SamplableVolume.from_tensor-775"><a href="#SamplableVolume.from_tensor-775"><span class="linenos">775</span></a>            <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span>
</span><span id="SamplableVolume.from_tensor-776"><a href="#SamplableVolume.from_tensor-776"><span class="linenos">776</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a samplable volume from a tensor.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>data:</strong>  Regular grid of values, with shape
(*batch_shape, *channels_shape, *spatial_shape).</li>
<li><strong>coordinate_system:</strong>  Coordinate system describing transformation from the
voxel coordinates on the data grid to the world coordinates.</li>
<li><strong>mask:</strong>  Mask for the data,
with shape (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</li>
<li><strong>data_format:</strong>  Data format of the grid values.</li>
<li><strong>sampler:</strong>  Sampler turning the grid values into a continuously defined mapping
over spatial coordinates.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Samplable volume.</p>
</blockquote>
</div>


                            </div>
                            <div id="SamplableVolume.modify_sampler" class="classattr">
                                        <input id="SamplableVolume.modify_sampler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">modify_sampler</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">sampler</span><span class="p">:</span> <span class="n"><a href="#ISampler">ISampler</a></span></span><span class="return-annotation">) -> <span class="n"><a href="#SamplableVolume">SamplableVolume</a></span>:</span></span>

                <label class="view-source-button" for="SamplableVolume.modify_sampler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SamplableVolume.modify_sampler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SamplableVolume.modify_sampler-778"><a href="#SamplableVolume.modify_sampler-778"><span class="linenos">778</span></a>    <span class="k">def</span> <span class="nf">modify_sampler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sampler</span><span class="p">:</span> <span class="n">ISampler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SamplableVolume&quot;</span><span class="p">:</span>
</span><span id="SamplableVolume.modify_sampler-779"><a href="#SamplableVolume.modify_sampler-779"><span class="linenos">779</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify the sampler of the volume.</span>
</span><span id="SamplableVolume.modify_sampler-780"><a href="#SamplableVolume.modify_sampler-780"><span class="linenos">780</span></a>
</span><span id="SamplableVolume.modify_sampler-781"><a href="#SamplableVolume.modify_sampler-781"><span class="linenos">781</span></a><span class="sd">        Args:</span>
</span><span id="SamplableVolume.modify_sampler-782"><a href="#SamplableVolume.modify_sampler-782"><span class="linenos">782</span></a><span class="sd">            sampler: New sampler.</span>
</span><span id="SamplableVolume.modify_sampler-783"><a href="#SamplableVolume.modify_sampler-783"><span class="linenos">783</span></a>
</span><span id="SamplableVolume.modify_sampler-784"><a href="#SamplableVolume.modify_sampler-784"><span class="linenos">784</span></a><span class="sd">        Returns:</span>
</span><span id="SamplableVolume.modify_sampler-785"><a href="#SamplableVolume.modify_sampler-785"><span class="linenos">785</span></a><span class="sd">            Samplable volume with the new sampler.</span>
</span><span id="SamplableVolume.modify_sampler-786"><a href="#SamplableVolume.modify_sampler-786"><span class="linenos">786</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SamplableVolume.modify_sampler-787"><a href="#SamplableVolume.modify_sampler-787"><span class="linenos">787</span></a>        <span class="k">return</span> <span class="n">SamplableVolume</span><span class="p">(</span>
</span><span id="SamplableVolume.modify_sampler-788"><a href="#SamplableVolume.modify_sampler-788"><span class="linenos">788</span></a>            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
</span><span id="SamplableVolume.modify_sampler-789"><a href="#SamplableVolume.modify_sampler-789"><span class="linenos">789</span></a>            <span class="n">coordinate_system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_system</span><span class="p">,</span>
</span><span id="SamplableVolume.modify_sampler-790"><a href="#SamplableVolume.modify_sampler-790"><span class="linenos">790</span></a>            <span class="n">data_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_format</span><span class="p">,</span>
</span><span id="SamplableVolume.modify_sampler-791"><a href="#SamplableVolume.modify_sampler-791"><span class="linenos">791</span></a>            <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span>
</span><span id="SamplableVolume.modify_sampler-792"><a href="#SamplableVolume.modify_sampler-792"><span class="linenos">792</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Modify the sampler of the volume.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>sampler:</strong>  New sampler.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Samplable volume with the new sampler.</p>
</blockquote>
</div>


                            </div>
                            <div id="SamplableVolume.coordinate_system" class="classattr">
                                        <input id="SamplableVolume.coordinate_system-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">coordinate_system</span><span class="annotation">: <a href="#CoordinateSystem">CoordinateSystem</a></span>

                <label class="view-source-button" for="SamplableVolume.coordinate_system-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SamplableVolume.coordinate_system"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SamplableVolume.coordinate_system-794"><a href="#SamplableVolume.coordinate_system-794"><span class="linenos">794</span></a>    <span class="nd">@property</span>
</span><span id="SamplableVolume.coordinate_system-795"><a href="#SamplableVolume.coordinate_system-795"><span class="linenos">795</span></a>    <span class="k">def</span> <span class="nf">coordinate_system</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">:</span>
</span><span id="SamplableVolume.coordinate_system-796"><a href="#SamplableVolume.coordinate_system-796"><span class="linenos">796</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_system</span>
</span></pre></div>


            <div class="docstring"><p>Coordinate system of the container.</p>
</div>


                            </div>
                            <div id="SamplableVolume.default_sampling_data_format" class="classattr">
                                        <input id="SamplableVolume.default_sampling_data_format-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">default_sampling_data_format</span><span class="annotation">: <a href="#DataFormat">DataFormat</a></span>

                <label class="view-source-button" for="SamplableVolume.default_sampling_data_format-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SamplableVolume.default_sampling_data_format"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SamplableVolume.default_sampling_data_format-798"><a href="#SamplableVolume.default_sampling_data_format-798"><span class="linenos">798</span></a>    <span class="nd">@property</span>
</span><span id="SamplableVolume.default_sampling_data_format-799"><a href="#SamplableVolume.default_sampling_data_format-799"><span class="linenos">799</span></a>    <span class="k">def</span> <span class="nf">default_sampling_data_format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFormat</span><span class="p">:</span>
</span><span id="SamplableVolume.default_sampling_data_format-800"><a href="#SamplableVolume.default_sampling_data_format-800"><span class="linenos">800</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_format</span>
</span></pre></div>


            <div class="docstring"><p>Default data format to use in sampling and resampling operations for
the mapping.</p>

<p>If None, <a href="#DataFormat.world_coordinates">DataFormat.world_coordinates()</a> will be used but the behaviour
in operations with other mappings is different as the default data format
of the other mapping will be used.</p>
</div>


                            </div>
                            <div id="SamplableVolume.invert" class="classattr">
                                        <input id="SamplableVolume.invert-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">invert</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="o">**</span><span class="n">arguments</span></span><span class="return-annotation">) -> <span class="n"><a href="#SamplableVolume">SamplableVolume</a></span>:</span></span>

                <label class="view-source-button" for="SamplableVolume.invert-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SamplableVolume.invert"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SamplableVolume.invert-833"><a href="#SamplableVolume.invert-833"><span class="linenos">833</span></a>    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SamplableVolume&quot;</span><span class="p">:</span>
</span><span id="SamplableVolume.invert-834"><a href="#SamplableVolume.invert-834"><span class="linenos">834</span></a>        <span class="k">return</span> <span class="n">SamplableVolume</span><span class="p">(</span>
</span><span id="SamplableVolume.invert-835"><a href="#SamplableVolume.invert-835"><span class="linenos">835</span></a>            <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
</span><span id="SamplableVolume.invert-836"><a href="#SamplableVolume.invert-836"><span class="linenos">836</span></a>            <span class="n">coordinate_system</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_system</span><span class="p">,</span>
</span><span id="SamplableVolume.invert-837"><a href="#SamplableVolume.invert-837"><span class="linenos">837</span></a>            <span class="n">data_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_format</span><span class="p">,</span>
</span><span id="SamplableVolume.invert-838"><a href="#SamplableVolume.invert-838"><span class="linenos">838</span></a>            <span class="n">sampler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="o">.</span><span class="n">inverse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coordinate_system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_format</span><span class="p">,</span> <span class="n">arguments</span><span class="p">),</span>
</span><span id="SamplableVolume.invert-839"><a href="#SamplableVolume.invert-839"><span class="linenos">839</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Invert the mapping.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>arguments:</strong>  Arguments for the inversion.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>The inverted mapping.</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>composable_mapping.tensor_like.BaseTensorLikeWrapper</dt>
                                <dd id="SamplableVolume.dtype" class="variable">dtype</dd>
                <dd id="SamplableVolume.device" class="variable">device</dd>
                <dd id="SamplableVolume.cast" class="function">cast</dd>
                <dd id="SamplableVolume.pin_memory" class="function">pin_memory</dd>
                <dd id="SamplableVolume.detach" class="function">detach</dd>

            </div>
            <div><dt><a href="#GridComposableMapping">GridComposableMapping</a></dt>
                                <dd id="SamplableVolume.sample" class="function"><a href="#GridComposableMapping.sample">sample</a></dd>
                <dd id="SamplableVolume.resample" class="function"><a href="#GridComposableMapping.resample">resample</a></dd>

            </div>
            <div><dt><a href="#ComposableMapping">ComposableMapping</a></dt>
                                <dd id="SamplableVolume.sample_to" class="function"><a href="#ComposableMapping.sample_to">sample_to</a></dd>
                <dd id="SamplableVolume.resample_to" class="function"><a href="#ComposableMapping.resample_to">resample_to</a></dd>
                <dd id="SamplableVolume.assign_coordinates" class="function"><a href="#ComposableMapping.assign_coordinates">assign_coordinates</a></dd>
                <dd id="SamplableVolume.as_affine_transformation" class="function"><a href="#ComposableMapping.as_affine_transformation">as_affine_transformation</a></dd>
                <dd id="SamplableVolume.as_affine_matrix" class="function"><a href="#ComposableMapping.as_affine_matrix">as_affine_matrix</a></dd>
                <dd id="SamplableVolume.set_default_sampling_data_format" class="function"><a href="#ComposableMapping.set_default_sampling_data_format">set_default_sampling_data_format</a></dd>
                <dd id="SamplableVolume.__matmul__" class="function"><a href="#ComposableMapping.__matmul__">__matmul__</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ScalingAndSquaring">
                            <input id="ScalingAndSquaring-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ScalingAndSquaring</span><wbr>(<span class="base"><a href="#ISampler">composable_mapping.ISampler</a></span>):

                <label class="view-source-button" for="ScalingAndSquaring-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ScalingAndSquaring"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ScalingAndSquaring-18"><a href="#ScalingAndSquaring-18"><span class="linenos"> 18</span></a><span class="k">class</span> <span class="nc">ScalingAndSquaring</span><span class="p">(</span><span class="n">ISampler</span><span class="p">):</span>
</span><span id="ScalingAndSquaring-19"><a href="#ScalingAndSquaring-19"><span class="linenos"> 19</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Scaling and squaring sampler.</span>
</span><span id="ScalingAndSquaring-20"><a href="#ScalingAndSquaring-20"><span class="linenos"> 20</span></a>
</span><span id="ScalingAndSquaring-21"><a href="#ScalingAndSquaring-21"><span class="linenos"> 21</span></a><span class="sd">    Applies scaling and squaring to integrate stationary velocity field (SVF) before</span>
</span><span id="ScalingAndSquaring-22"><a href="#ScalingAndSquaring-22"><span class="linenos"> 22</span></a><span class="sd">    sampling the volume.</span>
</span><span id="ScalingAndSquaring-23"><a href="#ScalingAndSquaring-23"><span class="linenos"> 23</span></a>
</span><span id="ScalingAndSquaring-24"><a href="#ScalingAndSquaring-24"><span class="linenos"> 24</span></a><span class="sd">    Arguments:</span>
</span><span id="ScalingAndSquaring-25"><a href="#ScalingAndSquaring-25"><span class="linenos"> 25</span></a><span class="sd">        sampler: Sampler used in integration of the SVF and sampling the volume.</span>
</span><span id="ScalingAndSquaring-26"><a href="#ScalingAndSquaring-26"><span class="linenos"> 26</span></a><span class="sd">        steps: Number of scaling and squaring steps.</span>
</span><span id="ScalingAndSquaring-27"><a href="#ScalingAndSquaring-27"><span class="linenos"> 27</span></a><span class="sd">        inverse: Whether to integrate in the inverse direction.</span>
</span><span id="ScalingAndSquaring-28"><a href="#ScalingAndSquaring-28"><span class="linenos"> 28</span></a><span class="sd">        mask_extrapolated_regions_for_empty_volume_mask: Whether to mask</span>
</span><span id="ScalingAndSquaring-29"><a href="#ScalingAndSquaring-29"><span class="linenos"> 29</span></a><span class="sd">            extrapolated regions when input volume mask is empty.</span>
</span><span id="ScalingAndSquaring-30"><a href="#ScalingAndSquaring-30"><span class="linenos"> 30</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ScalingAndSquaring-31"><a href="#ScalingAndSquaring-31"><span class="linenos"> 31</span></a>
</span><span id="ScalingAndSquaring-32"><a href="#ScalingAndSquaring-32"><span class="linenos"> 32</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="ScalingAndSquaring-33"><a href="#ScalingAndSquaring-33"><span class="linenos"> 33</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-34"><a href="#ScalingAndSquaring-34"><span class="linenos"> 34</span></a>        <span class="n">steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-35"><a href="#ScalingAndSquaring-35"><span class="linenos"> 35</span></a>        <span class="n">sampler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ISampler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-36"><a href="#ScalingAndSquaring-36"><span class="linenos"> 36</span></a>        <span class="n">inverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-37"><a href="#ScalingAndSquaring-37"><span class="linenos"> 37</span></a>        <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-38"><a href="#ScalingAndSquaring-38"><span class="linenos"> 38</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ScalingAndSquaring-39"><a href="#ScalingAndSquaring-39"><span class="linenos"> 39</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span> <span class="o">=</span> <span class="n">get_sampler</span><span class="p">(</span><span class="n">sampler</span><span class="p">)</span>
</span><span id="ScalingAndSquaring-40"><a href="#ScalingAndSquaring-40"><span class="linenos"> 40</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_steps</span> <span class="o">=</span> <span class="n">steps</span>
</span><span id="ScalingAndSquaring-41"><a href="#ScalingAndSquaring-41"><span class="linenos"> 41</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_inverse</span> <span class="o">=</span> <span class="n">inverse</span>
</span><span id="ScalingAndSquaring-42"><a href="#ScalingAndSquaring-42"><span class="linenos"> 42</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_extrapolated_regions_for_empty_volume_mask</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ScalingAndSquaring-43"><a href="#ScalingAndSquaring-43"><span class="linenos"> 43</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="ScalingAndSquaring-44"><a href="#ScalingAndSquaring-44"><span class="linenos"> 44</span></a>        <span class="p">)</span>
</span><span id="ScalingAndSquaring-45"><a href="#ScalingAndSquaring-45"><span class="linenos"> 45</span></a>
</span><span id="ScalingAndSquaring-46"><a href="#ScalingAndSquaring-46"><span class="linenos"> 46</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="ScalingAndSquaring-47"><a href="#ScalingAndSquaring-47"><span class="linenos"> 47</span></a>        <span class="k">if</span> <span class="n">volume</span><span class="o">.</span><span class="n">n_channel_dims</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">volume</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">):</span>
</span><span id="ScalingAndSquaring-48"><a href="#ScalingAndSquaring-48"><span class="linenos"> 48</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ScalingAndSquaring-49"><a href="#ScalingAndSquaring-49"><span class="linenos"> 49</span></a>                <span class="s2">&quot;Scaling and squaring sampler assumes single channel displacements &quot;</span>
</span><span id="ScalingAndSquaring-50"><a href="#ScalingAndSquaring-50"><span class="linenos"> 50</span></a>                <span class="s2">&quot;with same number of channels as spatial dims.&quot;</span>
</span><span id="ScalingAndSquaring-51"><a href="#ScalingAndSquaring-51"><span class="linenos"> 51</span></a>            <span class="p">)</span>
</span><span id="ScalingAndSquaring-52"><a href="#ScalingAndSquaring-52"><span class="linenos"> 52</span></a>        <span class="n">ddf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrate_svf</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">generate_values</span><span class="p">())</span>
</span><span id="ScalingAndSquaring-53"><a href="#ScalingAndSquaring-53"><span class="linenos"> 53</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">modify_values</span><span class="p">(</span><span class="n">ddf</span><span class="p">),</span> <span class="n">coordinates</span><span class="p">)</span>
</span><span id="ScalingAndSquaring-54"><a href="#ScalingAndSquaring-54"><span class="linenos"> 54</span></a>
</span><span id="ScalingAndSquaring-55"><a href="#ScalingAndSquaring-55"><span class="linenos"> 55</span></a>    <span class="k">def</span> <span class="nf">derivative</span><span class="p">(</span>
</span><span id="ScalingAndSquaring-56"><a href="#ScalingAndSquaring-56"><span class="linenos"> 56</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-57"><a href="#ScalingAndSquaring-57"><span class="linenos"> 57</span></a>        <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-58"><a href="#ScalingAndSquaring-58"><span class="linenos"> 58</span></a>        <span class="n">limit_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="ScalingAndSquaring-59"><a href="#ScalingAndSquaring-59"><span class="linenos"> 59</span></a>            <span class="n">LimitDirection</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">LimitDirection</span><span class="p">]</span>
</span><span id="ScalingAndSquaring-60"><a href="#ScalingAndSquaring-60"><span class="linenos"> 60</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">LimitDirection</span><span class="o">.</span><span class="n">average</span><span class="p">(),</span>
</span><span id="ScalingAndSquaring-61"><a href="#ScalingAndSquaring-61"><span class="linenos"> 61</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ISampler&quot;</span><span class="p">:</span>
</span><span id="ScalingAndSquaring-62"><a href="#ScalingAndSquaring-62"><span class="linenos"> 62</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Derivative sampling is not implemented for scaling and squaring&quot;</span><span class="p">)</span>
</span><span id="ScalingAndSquaring-63"><a href="#ScalingAndSquaring-63"><span class="linenos"> 63</span></a>
</span><span id="ScalingAndSquaring-64"><a href="#ScalingAndSquaring-64"><span class="linenos"> 64</span></a>    <span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span>
</span><span id="ScalingAndSquaring-65"><a href="#ScalingAndSquaring-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-66"><a href="#ScalingAndSquaring-66"><span class="linenos"> 66</span></a>        <span class="n">coordinate_system</span><span class="p">:</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-67"><a href="#ScalingAndSquaring-67"><span class="linenos"> 67</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">DataFormat</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-68"><a href="#ScalingAndSquaring-68"><span class="linenos"> 68</span></a>        <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-69"><a href="#ScalingAndSquaring-69"><span class="linenos"> 69</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ISampler</span><span class="p">:</span>
</span><span id="ScalingAndSquaring-70"><a href="#ScalingAndSquaring-70"><span class="linenos"> 70</span></a>        <span class="k">if</span> <span class="n">data_format</span><span class="o">.</span><span class="n">coordinate_type</span> <span class="o">==</span> <span class="s2">&quot;voxel&quot;</span> <span class="ow">and</span> <span class="n">data_format</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;displacements&quot;</span><span class="p">:</span>
</span><span id="ScalingAndSquaring-71"><a href="#ScalingAndSquaring-71"><span class="linenos"> 71</span></a>            <span class="k">return</span> <span class="n">ScalingAndSquaring</span><span class="p">(</span>
</span><span id="ScalingAndSquaring-72"><a href="#ScalingAndSquaring-72"><span class="linenos"> 72</span></a>                <span class="n">steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverse</span>
</span><span id="ScalingAndSquaring-73"><a href="#ScalingAndSquaring-73"><span class="linenos"> 73</span></a>            <span class="p">)</span>
</span><span id="ScalingAndSquaring-74"><a href="#ScalingAndSquaring-74"><span class="linenos"> 74</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ScalingAndSquaring-75"><a href="#ScalingAndSquaring-75"><span class="linenos"> 75</span></a>            <span class="s2">&quot;The sampler has been currently implemented only for voxel displacements data format.&quot;</span>
</span><span id="ScalingAndSquaring-76"><a href="#ScalingAndSquaring-76"><span class="linenos"> 76</span></a>        <span class="p">)</span>
</span><span id="ScalingAndSquaring-77"><a href="#ScalingAndSquaring-77"><span class="linenos"> 77</span></a>
</span><span id="ScalingAndSquaring-78"><a href="#ScalingAndSquaring-78"><span class="linenos"> 78</span></a>    <span class="k">def</span> <span class="nf">_integrate_svf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">svf</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="ScalingAndSquaring-79"><a href="#ScalingAndSquaring-79"><span class="linenos"> 79</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverse</span><span class="p">:</span>
</span><span id="ScalingAndSquaring-80"><a href="#ScalingAndSquaring-80"><span class="linenos"> 80</span></a>            <span class="n">svf</span> <span class="o">=</span> <span class="o">-</span><span class="n">svf</span>
</span><span id="ScalingAndSquaring-81"><a href="#ScalingAndSquaring-81"><span class="linenos"> 81</span></a>        <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">get_spatial_shape</span><span class="p">(</span><span class="n">svf</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ScalingAndSquaring-82"><a href="#ScalingAndSquaring-82"><span class="linenos"> 82</span></a>        <span class="n">grid</span> <span class="o">=</span> <span class="n">voxel_grid</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">svf</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">svf</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">generate_values</span><span class="p">()</span>
</span><span id="ScalingAndSquaring-83"><a href="#ScalingAndSquaring-83"><span class="linenos"> 83</span></a>        <span class="n">integrated</span> <span class="o">=</span> <span class="n">svf</span> <span class="o">/</span> <span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_steps</span>
</span><span id="ScalingAndSquaring-84"><a href="#ScalingAndSquaring-84"><span class="linenos"> 84</span></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">):</span>
</span><span id="ScalingAndSquaring-85"><a href="#ScalingAndSquaring-85"><span class="linenos"> 85</span></a>            <span class="n">integrated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="o">.</span><span class="n">sample_values</span><span class="p">(</span><span class="n">integrated</span><span class="p">,</span> <span class="n">integrated</span> <span class="o">+</span> <span class="n">grid</span><span class="p">)</span> <span class="o">+</span> <span class="n">integrated</span>
</span><span id="ScalingAndSquaring-86"><a href="#ScalingAndSquaring-86"><span class="linenos"> 86</span></a>        <span class="k">return</span> <span class="n">integrated</span>
</span><span id="ScalingAndSquaring-87"><a href="#ScalingAndSquaring-87"><span class="linenos"> 87</span></a>
</span><span id="ScalingAndSquaring-88"><a href="#ScalingAndSquaring-88"><span class="linenos"> 88</span></a>    <span class="k">def</span> <span class="nf">sample_values</span><span class="p">(</span>
</span><span id="ScalingAndSquaring-89"><a href="#ScalingAndSquaring-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-90"><a href="#ScalingAndSquaring-90"><span class="linenos"> 90</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-91"><a href="#ScalingAndSquaring-91"><span class="linenos"> 91</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-92"><a href="#ScalingAndSquaring-92"><span class="linenos"> 92</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="ScalingAndSquaring-93"><a href="#ScalingAndSquaring-93"><span class="linenos"> 93</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="o">.</span><span class="n">sample_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_integrate_svf</span><span class="p">(</span><span class="n">volume</span><span class="p">),</span> <span class="n">coordinates</span><span class="p">)</span>
</span><span id="ScalingAndSquaring-94"><a href="#ScalingAndSquaring-94"><span class="linenos"> 94</span></a>
</span><span id="ScalingAndSquaring-95"><a href="#ScalingAndSquaring-95"><span class="linenos"> 95</span></a>    <span class="k">def</span> <span class="nf">sample_mask</span><span class="p">(</span>
</span><span id="ScalingAndSquaring-96"><a href="#ScalingAndSquaring-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-97"><a href="#ScalingAndSquaring-97"><span class="linenos"> 97</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-98"><a href="#ScalingAndSquaring-98"><span class="linenos"> 98</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="ScalingAndSquaring-99"><a href="#ScalingAndSquaring-99"><span class="linenos"> 99</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="ScalingAndSquaring-100"><a href="#ScalingAndSquaring-100"><span class="linenos">100</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="o">.</span><span class="n">sample_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Scaling and squaring sampler.</p>

<p>Applies scaling and squaring to integrate stationary velocity field (SVF) before
sampling the volume.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>sampler:</strong>  Sampler used in integration of the SVF and sampling the volume.</li>
<li><strong>steps:</strong>  Number of scaling and squaring steps.</li>
<li><strong>inverse:</strong>  Whether to integrate in the inverse direction.</li>
<li><strong>mask_extrapolated_regions_for_empty_volume_mask:</strong>  Whether to mask
extrapolated regions when input volume mask is empty.</li>
</ul>
</div>


                            <div id="ScalingAndSquaring.__init__" class="classattr">
                                        <input id="ScalingAndSquaring.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ScalingAndSquaring</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span>,</span><span class="param">	<span class="n">sampler</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#ISampler">ISampler</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">inverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span>)</span>

                <label class="view-source-button" for="ScalingAndSquaring.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ScalingAndSquaring.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ScalingAndSquaring.__init__-32"><a href="#ScalingAndSquaring.__init__-32"><span class="linenos">32</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="ScalingAndSquaring.__init__-33"><a href="#ScalingAndSquaring.__init__-33"><span class="linenos">33</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.__init__-34"><a href="#ScalingAndSquaring.__init__-34"><span class="linenos">34</span></a>        <span class="n">steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.__init__-35"><a href="#ScalingAndSquaring.__init__-35"><span class="linenos">35</span></a>        <span class="n">sampler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ISampler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.__init__-36"><a href="#ScalingAndSquaring.__init__-36"><span class="linenos">36</span></a>        <span class="n">inverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.__init__-37"><a href="#ScalingAndSquaring.__init__-37"><span class="linenos">37</span></a>        <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.__init__-38"><a href="#ScalingAndSquaring.__init__-38"><span class="linenos">38</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ScalingAndSquaring.__init__-39"><a href="#ScalingAndSquaring.__init__-39"><span class="linenos">39</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span> <span class="o">=</span> <span class="n">get_sampler</span><span class="p">(</span><span class="n">sampler</span><span class="p">)</span>
</span><span id="ScalingAndSquaring.__init__-40"><a href="#ScalingAndSquaring.__init__-40"><span class="linenos">40</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_steps</span> <span class="o">=</span> <span class="n">steps</span>
</span><span id="ScalingAndSquaring.__init__-41"><a href="#ScalingAndSquaring.__init__-41"><span class="linenos">41</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_inverse</span> <span class="o">=</span> <span class="n">inverse</span>
</span><span id="ScalingAndSquaring.__init__-42"><a href="#ScalingAndSquaring.__init__-42"><span class="linenos">42</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mask_extrapolated_regions_for_empty_volume_mask</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="ScalingAndSquaring.__init__-43"><a href="#ScalingAndSquaring.__init__-43"><span class="linenos">43</span></a>            <span class="n">mask_extrapolated_regions_for_empty_volume_mask</span>
</span><span id="ScalingAndSquaring.__init__-44"><a href="#ScalingAndSquaring.__init__-44"><span class="linenos">44</span></a>        <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ScalingAndSquaring.derivative" class="classattr">
                                        <input id="ScalingAndSquaring.derivative-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">derivative</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">limit_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#LimitDirection">LimitDirection</a></span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n"><a href="#LimitDirection">LimitDirection</a></span><span class="p">]]</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n"><a href="#LimitDirection">LimitDirection</a></span> <span class="nb">object</span><span class="o">&gt;</span></span><span class="return-annotation">) -> <span class="n"><a href="#ISampler">ISampler</a></span>:</span></span>

                <label class="view-source-button" for="ScalingAndSquaring.derivative-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ScalingAndSquaring.derivative"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ScalingAndSquaring.derivative-55"><a href="#ScalingAndSquaring.derivative-55"><span class="linenos">55</span></a>    <span class="k">def</span> <span class="nf">derivative</span><span class="p">(</span>
</span><span id="ScalingAndSquaring.derivative-56"><a href="#ScalingAndSquaring.derivative-56"><span class="linenos">56</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.derivative-57"><a href="#ScalingAndSquaring.derivative-57"><span class="linenos">57</span></a>        <span class="n">spatial_dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.derivative-58"><a href="#ScalingAndSquaring.derivative-58"><span class="linenos">58</span></a>        <span class="n">limit_direction</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="ScalingAndSquaring.derivative-59"><a href="#ScalingAndSquaring.derivative-59"><span class="linenos">59</span></a>            <span class="n">LimitDirection</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">LimitDirection</span><span class="p">]</span>
</span><span id="ScalingAndSquaring.derivative-60"><a href="#ScalingAndSquaring.derivative-60"><span class="linenos">60</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">LimitDirection</span><span class="o">.</span><span class="n">average</span><span class="p">(),</span>
</span><span id="ScalingAndSquaring.derivative-61"><a href="#ScalingAndSquaring.derivative-61"><span class="linenos">61</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ISampler&quot;</span><span class="p">:</span>
</span><span id="ScalingAndSquaring.derivative-62"><a href="#ScalingAndSquaring.derivative-62"><span class="linenos">62</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Derivative sampling is not implemented for scaling and squaring&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Obtain sampler for sampling derivatives corresponding to the current sampler.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>spatial_dim:</strong>  Spatial dimension along which to compute the derivative.</li>
<li><strong>limit_direction:</strong>  Direction in which to compute the derivative.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Sampler for sampling derivatives.</p>
</blockquote>
</div>


                            </div>
                            <div id="ScalingAndSquaring.inverse" class="classattr">
                                        <input id="ScalingAndSquaring.inverse-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">inverse</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">coordinate_system</span><span class="p">:</span> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>,</span><span class="param">	<span class="n">data_format</span><span class="p">:</span> <span class="n"><a href="#DataFormat">DataFormat</a></span>,</span><span class="param">	<span class="n">arguments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#ISampler">ISampler</a></span>:</span></span>

                <label class="view-source-button" for="ScalingAndSquaring.inverse-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ScalingAndSquaring.inverse"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ScalingAndSquaring.inverse-64"><a href="#ScalingAndSquaring.inverse-64"><span class="linenos">64</span></a>    <span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span>
</span><span id="ScalingAndSquaring.inverse-65"><a href="#ScalingAndSquaring.inverse-65"><span class="linenos">65</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.inverse-66"><a href="#ScalingAndSquaring.inverse-66"><span class="linenos">66</span></a>        <span class="n">coordinate_system</span><span class="p">:</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.inverse-67"><a href="#ScalingAndSquaring.inverse-67"><span class="linenos">67</span></a>        <span class="n">data_format</span><span class="p">:</span> <span class="n">DataFormat</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.inverse-68"><a href="#ScalingAndSquaring.inverse-68"><span class="linenos">68</span></a>        <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.inverse-69"><a href="#ScalingAndSquaring.inverse-69"><span class="linenos">69</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ISampler</span><span class="p">:</span>
</span><span id="ScalingAndSquaring.inverse-70"><a href="#ScalingAndSquaring.inverse-70"><span class="linenos">70</span></a>        <span class="k">if</span> <span class="n">data_format</span><span class="o">.</span><span class="n">coordinate_type</span> <span class="o">==</span> <span class="s2">&quot;voxel&quot;</span> <span class="ow">and</span> <span class="n">data_format</span><span class="o">.</span><span class="n">representation</span> <span class="o">==</span> <span class="s2">&quot;displacements&quot;</span><span class="p">:</span>
</span><span id="ScalingAndSquaring.inverse-71"><a href="#ScalingAndSquaring.inverse-71"><span class="linenos">71</span></a>            <span class="k">return</span> <span class="n">ScalingAndSquaring</span><span class="p">(</span>
</span><span id="ScalingAndSquaring.inverse-72"><a href="#ScalingAndSquaring.inverse-72"><span class="linenos">72</span></a>                <span class="n">steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverse</span>
</span><span id="ScalingAndSquaring.inverse-73"><a href="#ScalingAndSquaring.inverse-73"><span class="linenos">73</span></a>            <span class="p">)</span>
</span><span id="ScalingAndSquaring.inverse-74"><a href="#ScalingAndSquaring.inverse-74"><span class="linenos">74</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ScalingAndSquaring.inverse-75"><a href="#ScalingAndSquaring.inverse-75"><span class="linenos">75</span></a>            <span class="s2">&quot;The sampler has been currently implemented only for voxel displacements data format.&quot;</span>
</span><span id="ScalingAndSquaring.inverse-76"><a href="#ScalingAndSquaring.inverse-76"><span class="linenos">76</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Obtain sampler for sampling inverse values corresponding to the
current sampler, if available.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>coordinate_system:</strong>  Coordinate system of the mapping.</li>
<li><strong>data_format:</strong>  Data format of the sampled volume.</li>
<li><strong>arguments:</strong>  Additional arguments for the inverse.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Sampler for sampling inverse values.</p>
</blockquote>
</div>


                            </div>
                            <div id="ScalingAndSquaring.sample_values" class="classattr">
                                        <input id="ScalingAndSquaring.sample_values-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_values</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">volume</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>, </span><span class="param"><span class="n">coordinates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="ScalingAndSquaring.sample_values-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ScalingAndSquaring.sample_values"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ScalingAndSquaring.sample_values-88"><a href="#ScalingAndSquaring.sample_values-88"><span class="linenos">88</span></a>    <span class="k">def</span> <span class="nf">sample_values</span><span class="p">(</span>
</span><span id="ScalingAndSquaring.sample_values-89"><a href="#ScalingAndSquaring.sample_values-89"><span class="linenos">89</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.sample_values-90"><a href="#ScalingAndSquaring.sample_values-90"><span class="linenos">90</span></a>        <span class="n">volume</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.sample_values-91"><a href="#ScalingAndSquaring.sample_values-91"><span class="linenos">91</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.sample_values-92"><a href="#ScalingAndSquaring.sample_values-92"><span class="linenos">92</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="ScalingAndSquaring.sample_values-93"><a href="#ScalingAndSquaring.sample_values-93"><span class="linenos">93</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="o">.</span><span class="n">sample_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_integrate_svf</span><span class="p">(</span><span class="n">volume</span><span class="p">),</span> <span class="n">coordinates</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sample values at spatial locations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>volume:</strong>  Volume to sample over spatial dimensions
with shape (*batch_shape, *channels_shape, *spatial_shape)</li>
<li><strong>coordinates:</strong>  Coordinates in voxel coordinates with shape
(*batch_shape, n_spatial_dims, *target_shape).</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Sampled values with shape (*batch_shape, *channels_shape, *target_shape).</p>
</blockquote>
</div>


                            </div>
                            <div id="ScalingAndSquaring.sample_mask" class="classattr">
                                        <input id="ScalingAndSquaring.sample_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sample_mask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mask</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>, </span><span class="param"><span class="n">coordinates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="ScalingAndSquaring.sample_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ScalingAndSquaring.sample_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ScalingAndSquaring.sample_mask-95"><a href="#ScalingAndSquaring.sample_mask-95"><span class="linenos"> 95</span></a>    <span class="k">def</span> <span class="nf">sample_mask</span><span class="p">(</span>
</span><span id="ScalingAndSquaring.sample_mask-96"><a href="#ScalingAndSquaring.sample_mask-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.sample_mask-97"><a href="#ScalingAndSquaring.sample_mask-97"><span class="linenos"> 97</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.sample_mask-98"><a href="#ScalingAndSquaring.sample_mask-98"><span class="linenos"> 98</span></a>        <span class="n">coordinates</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="ScalingAndSquaring.sample_mask-99"><a href="#ScalingAndSquaring.sample_mask-99"><span class="linenos"> 99</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="ScalingAndSquaring.sample_mask-100"><a href="#ScalingAndSquaring.sample_mask-100"><span class="linenos">100</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampler</span><span class="o">.</span><span class="n">sample_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sample mask at spatial locations.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mask:</strong>  Mask to sample over spatial dimensions
with shape (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</li>
<li><strong>coordinates:</strong>  Coordinates in voxel coordinates with shape
(*batch_shape, n_spatial_dims, *target_shape).</li>
</ul>
</div>


                            </div>
                </section>
                <section id="Start">
                            <input id="Start-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Start</span><wbr>(<span class="base"><a href="#ReformattingReference">composable_mapping.ReformattingReference</a></span>):

                <label class="view-source-button" for="Start-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Start"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Start-124"><a href="#Start-124"><span class="linenos">124</span></a><span class="k">class</span> <span class="nc">Start</span><span class="p">(</span><span class="n">ReformattingReference</span><span class="p">):</span>
</span><span id="Start-125"><a href="#Start-125"><span class="linenos">125</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Reference point at the start of the dimension.</span>
</span><span id="Start-126"><a href="#Start-126"><span class="linenos">126</span></a>
</span><span id="Start-127"><a href="#Start-127"><span class="linenos">127</span></a><span class="sd">    Arguments:</span>
</span><span id="Start-128"><a href="#Start-128"><span class="linenos">128</span></a><span class="sd">        fov_convention: Convention for defining the field of view, either &quot;full_voxels&quot;</span>
</span><span id="Start-129"><a href="#Start-129"><span class="linenos">129</span></a><span class="sd">            or &quot;voxel_centers&quot;. If voxels are seens as cubes with the value at the</span>
</span><span id="Start-130"><a href="#Start-130"><span class="linenos">130</span></a><span class="sd">            center, the convention &quot;full voxels&quot; includes the full cubes in the field</span>
</span><span id="Start-131"><a href="#Start-131"><span class="linenos">131</span></a><span class="sd">            of view, while the convention &quot;voxel_centers&quot; includes only the centers.</span>
</span><span id="Start-132"><a href="#Start-132"><span class="linenos">132</span></a><span class="sd">            The latter results in a field of view that is one voxel smaller in each</span>
</span><span id="Start-133"><a href="#Start-133"><span class="linenos">133</span></a><span class="sd">            dimension. Similar to the align_corners option in</span>
</span><span id="Start-134"><a href="#Start-134"><span class="linenos">134</span></a><span class="sd">            torch.nn.functional.grid_sample</span>
</span><span id="Start-135"><a href="#Start-135"><span class="linenos">135</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Start-136"><a href="#Start-136"><span class="linenos">136</span></a>
</span><span id="Start-137"><a href="#Start-137"><span class="linenos">137</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Start-138"><a href="#Start-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Start-139"><a href="#Start-139"><span class="linenos">139</span></a>        <span class="n">fov_convention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">,</span>
</span><span id="Start-140"><a href="#Start-140"><span class="linenos">140</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Start-141"><a href="#Start-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">=</span> <span class="n">fov_convention</span>
</span><span id="Start-142"><a href="#Start-142"><span class="linenos">142</span></a>
</span><span id="Start-143"><a href="#Start-143"><span class="linenos">143</span></a>    <span class="k">def</span> <span class="nf">get_voxel_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Start-144"><a href="#Start-144"><span class="linenos">144</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">==</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">:</span>
</span><span id="Start-145"><a href="#Start-145"><span class="linenos">145</span></a>            <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span>
</span><span id="Start-146"><a href="#Start-146"><span class="linenos">146</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">==</span> <span class="s2">&quot;voxel_centers&quot;</span><span class="p">:</span>
</span><span id="Start-147"><a href="#Start-147"><span class="linenos">147</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span><span id="Start-148"><a href="#Start-148"><span class="linenos">148</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown fov convention: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Reference point at the start of the dimension.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>fov_convention:</strong>  Convention for defining the field of view, either "full_voxels"
or "voxel_centers". If voxels are seens as cubes with the value at the
center, the convention "full voxels" includes the full cubes in the field
of view, while the convention "voxel_centers" includes only the centers.
The latter results in a field of view that is one voxel smaller in each
dimension. Similar to the align_corners option in
torch.nn.functional.grid_sample</li>
</ul>
</div>


                            <div id="Start.__init__" class="classattr">
                                        <input id="Start.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Start</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">fov_convention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;full_voxels&#39;</span></span>)</span>

                <label class="view-source-button" for="Start.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Start.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Start.__init__-137"><a href="#Start.__init__-137"><span class="linenos">137</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="Start.__init__-138"><a href="#Start.__init__-138"><span class="linenos">138</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Start.__init__-139"><a href="#Start.__init__-139"><span class="linenos">139</span></a>        <span class="n">fov_convention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">,</span>
</span><span id="Start.__init__-140"><a href="#Start.__init__-140"><span class="linenos">140</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Start.__init__-141"><a href="#Start.__init__-141"><span class="linenos">141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">=</span> <span class="n">fov_convention</span>
</span></pre></div>


    

                            </div>
                            <div id="Start.get_voxel_coordinate" class="classattr">
                                        <input id="Start.get_voxel_coordinate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_voxel_coordinate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">size</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Start.get_voxel_coordinate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Start.get_voxel_coordinate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Start.get_voxel_coordinate-143"><a href="#Start.get_voxel_coordinate-143"><span class="linenos">143</span></a>    <span class="k">def</span> <span class="nf">get_voxel_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Start.get_voxel_coordinate-144"><a href="#Start.get_voxel_coordinate-144"><span class="linenos">144</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">==</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">:</span>
</span><span id="Start.get_voxel_coordinate-145"><a href="#Start.get_voxel_coordinate-145"><span class="linenos">145</span></a>            <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span>
</span><span id="Start.get_voxel_coordinate-146"><a href="#Start.get_voxel_coordinate-146"><span class="linenos">146</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">==</span> <span class="s2">&quot;voxel_centers&quot;</span><span class="p">:</span>
</span><span id="Start.get_voxel_coordinate-147"><a href="#Start.get_voxel_coordinate-147"><span class="linenos">147</span></a>            <span class="k">return</span> <span class="mi">0</span>
</span><span id="Start.get_voxel_coordinate-148"><a href="#Start.get_voxel_coordinate-148"><span class="linenos">148</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown fov convention: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get a voxel coordinate corresponding to the reference position with
a given dimension size.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>size:</strong>  Size of the dimension</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Voxel coordinate corresponding to the reference position along the dimension.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="Center">
                            <input id="Center-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Center</span><wbr>(<span class="base"><a href="#ReformattingReference">composable_mapping.ReformattingReference</a></span>):

                <label class="view-source-button" for="Center-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Center"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Center-178"><a href="#Center-178"><span class="linenos">178</span></a><span class="k">class</span> <span class="nc">Center</span><span class="p">(</span><span class="n">ReformattingReference</span><span class="p">):</span>
</span><span id="Center-179"><a href="#Center-179"><span class="linenos">179</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Reference point at the center of the dimension.&quot;&quot;&quot;</span>
</span><span id="Center-180"><a href="#Center-180"><span class="linenos">180</span></a>
</span><span id="Center-181"><a href="#Center-181"><span class="linenos">181</span></a>    <span class="k">def</span> <span class="nf">get_voxel_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Center-182"><a href="#Center-182"><span class="linenos">182</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span></pre></div>


            <div class="docstring"><p>Reference point at the center of the dimension.</p>
</div>


                            <div id="Center.get_voxel_coordinate" class="classattr">
                                        <input id="Center.get_voxel_coordinate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_voxel_coordinate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">size</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="Center.get_voxel_coordinate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Center.get_voxel_coordinate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Center.get_voxel_coordinate-181"><a href="#Center.get_voxel_coordinate-181"><span class="linenos">181</span></a>    <span class="k">def</span> <span class="nf">get_voxel_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="Center.get_voxel_coordinate-182"><a href="#Center.get_voxel_coordinate-182"><span class="linenos">182</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span></pre></div>


            <div class="docstring"><p>Get a voxel coordinate corresponding to the reference position with
a given dimension size.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>size:</strong>  Size of the dimension</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Voxel coordinate corresponding to the reference position along the dimension.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="End">
                            <input id="End-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">End</span><wbr>(<span class="base"><a href="#ReformattingReference">composable_mapping.ReformattingReference</a></span>):

                <label class="view-source-button" for="End-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#End"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="End-151"><a href="#End-151"><span class="linenos">151</span></a><span class="k">class</span> <span class="nc">End</span><span class="p">(</span><span class="n">ReformattingReference</span><span class="p">):</span>
</span><span id="End-152"><a href="#End-152"><span class="linenos">152</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Reference point at the end of the dimension.</span>
</span><span id="End-153"><a href="#End-153"><span class="linenos">153</span></a>
</span><span id="End-154"><a href="#End-154"><span class="linenos">154</span></a><span class="sd">    Arguments:</span>
</span><span id="End-155"><a href="#End-155"><span class="linenos">155</span></a><span class="sd">        fov_convention: Convention for defining the field of view, either &quot;full_voxels&quot;</span>
</span><span id="End-156"><a href="#End-156"><span class="linenos">156</span></a><span class="sd">            or &quot;voxel_centers&quot;. If voxels are seens as cubes with the value at the</span>
</span><span id="End-157"><a href="#End-157"><span class="linenos">157</span></a><span class="sd">            center, the convention &quot;full voxels&quot; includes the full cubes in the field</span>
</span><span id="End-158"><a href="#End-158"><span class="linenos">158</span></a><span class="sd">            of view, while the convention &quot;voxel_centers&quot; includes only the centers.</span>
</span><span id="End-159"><a href="#End-159"><span class="linenos">159</span></a><span class="sd">            The latter results in a field of view that is one voxel smaller in each</span>
</span><span id="End-160"><a href="#End-160"><span class="linenos">160</span></a><span class="sd">            dimension. Similar to the align_corners option in</span>
</span><span id="End-161"><a href="#End-161"><span class="linenos">161</span></a><span class="sd">            torch.nn.functional.grid_sample</span>
</span><span id="End-162"><a href="#End-162"><span class="linenos">162</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="End-163"><a href="#End-163"><span class="linenos">163</span></a>
</span><span id="End-164"><a href="#End-164"><span class="linenos">164</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="End-165"><a href="#End-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="End-166"><a href="#End-166"><span class="linenos">166</span></a>        <span class="n">fov_convention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">,</span>
</span><span id="End-167"><a href="#End-167"><span class="linenos">167</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="End-168"><a href="#End-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">=</span> <span class="n">fov_convention</span>
</span><span id="End-169"><a href="#End-169"><span class="linenos">169</span></a>
</span><span id="End-170"><a href="#End-170"><span class="linenos">170</span></a>    <span class="k">def</span> <span class="nf">get_voxel_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="End-171"><a href="#End-171"><span class="linenos">171</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">==</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">:</span>
</span><span id="End-172"><a href="#End-172"><span class="linenos">172</span></a>            <span class="k">return</span> <span class="n">size</span> <span class="o">-</span> <span class="mf">0.5</span>
</span><span id="End-173"><a href="#End-173"><span class="linenos">173</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">==</span> <span class="s2">&quot;voxel_centers&quot;</span><span class="p">:</span>
</span><span id="End-174"><a href="#End-174"><span class="linenos">174</span></a>            <span class="k">return</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="End-175"><a href="#End-175"><span class="linenos">175</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown fov convention: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Reference point at the end of the dimension.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>fov_convention:</strong>  Convention for defining the field of view, either "full_voxels"
or "voxel_centers". If voxels are seens as cubes with the value at the
center, the convention "full voxels" includes the full cubes in the field
of view, while the convention "voxel_centers" includes only the centers.
The latter results in a field of view that is one voxel smaller in each
dimension. Similar to the align_corners option in
torch.nn.functional.grid_sample</li>
</ul>
</div>


                            <div id="End.__init__" class="classattr">
                                        <input id="End.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">End</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">fov_convention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;full_voxels&#39;</span></span>)</span>

                <label class="view-source-button" for="End.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#End.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="End.__init__-164"><a href="#End.__init__-164"><span class="linenos">164</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="End.__init__-165"><a href="#End.__init__-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="End.__init__-166"><a href="#End.__init__-166"><span class="linenos">166</span></a>        <span class="n">fov_convention</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">,</span>
</span><span id="End.__init__-167"><a href="#End.__init__-167"><span class="linenos">167</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="End.__init__-168"><a href="#End.__init__-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">=</span> <span class="n">fov_convention</span>
</span></pre></div>


    

                            </div>
                            <div id="End.get_voxel_coordinate" class="classattr">
                                        <input id="End.get_voxel_coordinate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_voxel_coordinate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">size</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="End.get_voxel_coordinate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#End.get_voxel_coordinate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="End.get_voxel_coordinate-170"><a href="#End.get_voxel_coordinate-170"><span class="linenos">170</span></a>    <span class="k">def</span> <span class="nf">get_voxel_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="End.get_voxel_coordinate-171"><a href="#End.get_voxel_coordinate-171"><span class="linenos">171</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">==</span> <span class="s2">&quot;full_voxels&quot;</span><span class="p">:</span>
</span><span id="End.get_voxel_coordinate-172"><a href="#End.get_voxel_coordinate-172"><span class="linenos">172</span></a>            <span class="k">return</span> <span class="n">size</span> <span class="o">-</span> <span class="mf">0.5</span>
</span><span id="End.get_voxel_coordinate-173"><a href="#End.get_voxel_coordinate-173"><span class="linenos">173</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span> <span class="o">==</span> <span class="s2">&quot;voxel_centers&quot;</span><span class="p">:</span>
</span><span id="End.get_voxel_coordinate-174"><a href="#End.get_voxel_coordinate-174"><span class="linenos">174</span></a>            <span class="k">return</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="End.get_voxel_coordinate-175"><a href="#End.get_voxel_coordinate-175"><span class="linenos">175</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown fov convention: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_fov_convention</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get a voxel coordinate corresponding to the reference position with
a given dimension size.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>size:</strong>  Size of the dimension</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Voxel coordinate corresponding to the reference position along the dimension.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="affine">
                            <input id="affine-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">affine</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">matrix</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span></span><span class="return-annotation">) -> <span class="n"><a href="#Affine">Affine</a></span>:</span></span>

                <label class="view-source-button" for="affine-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#affine"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="affine-134"><a href="#affine-134"><span class="linenos">134</span></a><span class="k">def</span> <span class="nf">affine</span><span class="p">(</span><span class="n">matrix</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Affine</span><span class="p">:</span>
</span><span id="affine-135"><a href="#affine-135"><span class="linenos">135</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create affine mapping from an affine transformation matrix.</span>
</span><span id="affine-136"><a href="#affine-136"><span class="linenos">136</span></a>
</span><span id="affine-137"><a href="#affine-137"><span class="linenos">137</span></a><span class="sd">    See: `Affine.from_matrix.`</span>
</span><span id="affine-138"><a href="#affine-138"><span class="linenos">138</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="affine-139"><a href="#affine-139"><span class="linenos">139</span></a>    <span class="k">return</span> <span class="n">Affine</span><span class="o">.</span><span class="n">from_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create affine mapping from an affine transformation matrix.</p>

<p>See: <code><a href="#Affine.from_matrix">Affine.from_matrix</a>.</code></p>
</div>


                </section>
                <section id="clear_default_sampler">
                            <input id="clear_default_sampler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clear_default_sampler</span><span class="signature pdoc-code condensed">(<span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="clear_default_sampler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#clear_default_sampler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="clear_default_sampler-35"><a href="#clear_default_sampler-35"><span class="linenos">35</span></a><span class="k">def</span> <span class="nf">clear_default_sampler</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="clear_default_sampler-36"><a href="#clear_default_sampler-36"><span class="linenos">36</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear default sampler&quot;&quot;&quot;</span>
</span><span id="clear_default_sampler-37"><a href="#clear_default_sampler-37"><span class="linenos">37</span></a>    <span class="k">global</span> <span class="n">_DEFAULT_SAMPLER</span>  <span class="c1"># pylint: disable=global-statement</span>
</span><span id="clear_default_sampler-38"><a href="#clear_default_sampler-38"><span class="linenos">38</span></a>    <span class="n">_DEFAULT_SAMPLER</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Clear default sampler</p>
</div>


                </section>
                <section id="concatenate_mappings">
                            <input id="concatenate_mappings-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">concatenate_mappings</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="o">*</span><span class="n">mappings</span><span class="p">:</span> <span class="o">~</span><span class="n">ComposableMappingT</span>,</span><span class="param">	<span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span><span class="return-annotation">) -> <span class="o">~</span><span class="n">ComposableMappingT</span>:</span></span>

                <label class="view-source-button" for="concatenate_mappings-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#concatenate_mappings"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="concatenate_mappings-40"><a href="#concatenate_mappings-40"><span class="linenos">40</span></a><span class="k">def</span> <span class="nf">concatenate_mappings</span><span class="p">(</span>
</span><span id="concatenate_mappings-41"><a href="#concatenate_mappings-41"><span class="linenos">41</span></a>    <span class="o">*</span><span class="n">mappings</span><span class="p">:</span> <span class="n">ComposableMappingT</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="concatenate_mappings-42"><a href="#concatenate_mappings-42"><span class="linenos">42</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ComposableMappingT</span><span class="p">:</span>
</span><span id="concatenate_mappings-43"><a href="#concatenate_mappings-43"><span class="linenos">43</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Concatenate mappings along a channel dimension.</span>
</span><span id="concatenate_mappings-44"><a href="#concatenate_mappings-44"><span class="linenos">44</span></a>
</span><span id="concatenate_mappings-45"><a href="#concatenate_mappings-45"><span class="linenos">45</span></a><span class="sd">    Args:</span>
</span><span id="concatenate_mappings-46"><a href="#concatenate_mappings-46"><span class="linenos">46</span></a><span class="sd">        mappings: Mappings to concatenate.</span>
</span><span id="concatenate_mappings-47"><a href="#concatenate_mappings-47"><span class="linenos">47</span></a><span class="sd">        channel_index: Channel index along which to concatenate.</span>
</span><span id="concatenate_mappings-48"><a href="#concatenate_mappings-48"><span class="linenos">48</span></a>
</span><span id="concatenate_mappings-49"><a href="#concatenate_mappings-49"><span class="linenos">49</span></a><span class="sd">    Returns:</span>
</span><span id="concatenate_mappings-50"><a href="#concatenate_mappings-50"><span class="linenos">50</span></a><span class="sd">        A mapping with the output being the outputs of the input mappings</span>
</span><span id="concatenate_mappings-51"><a href="#concatenate_mappings-51"><span class="linenos">51</span></a><span class="sd">        concatenated along the channel dimension.</span>
</span><span id="concatenate_mappings-52"><a href="#concatenate_mappings-52"><span class="linenos">52</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="concatenate_mappings-53"><a href="#concatenate_mappings-53"><span class="linenos">53</span></a>    <span class="n">concatenated</span><span class="p">:</span> <span class="n">ComposableMapping</span> <span class="o">=</span> <span class="n">_Concatenate</span><span class="p">(</span><span class="o">*</span><span class="n">mappings</span><span class="p">,</span> <span class="n">channel_index</span><span class="o">=</span><span class="n">channel_index</span><span class="p">)</span>
</span><span id="concatenate_mappings-54"><a href="#concatenate_mappings-54"><span class="linenos">54</span></a>    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">:</span>
</span><span id="concatenate_mappings-55"><a href="#concatenate_mappings-55"><span class="linenos">55</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">GridComposableMapping</span><span class="p">):</span>
</span><span id="concatenate_mappings-56"><a href="#concatenate_mappings-56"><span class="linenos">56</span></a>            <span class="n">concatenated</span> <span class="o">=</span> <span class="n">concatenated</span><span class="o">.</span><span class="n">assign_coordinates</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span>
</span><span id="concatenate_mappings-57"><a href="#concatenate_mappings-57"><span class="linenos">57</span></a>            <span class="k">break</span>
</span><span id="concatenate_mappings-58"><a href="#concatenate_mappings-58"><span class="linenos">58</span></a>    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">ComposableMappingT</span><span class="p">,</span> <span class="n">concatenated</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Concatenate mappings along a channel dimension.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mappings:</strong>  Mappings to concatenate.</li>
<li><strong>channel_index:</strong>  Channel index along which to concatenate.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>A mapping with the output being the outputs of the input mappings
  concatenated along the channel dimension.</p>
</blockquote>
</div>


                </section>
                <section id="concatenate_mappable_tensors">
                            <input id="concatenate_mappable_tensors-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">concatenate_mappable_tensors</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="o">*</span><span class="n">mappable_tensors</span><span class="p">:</span> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>,</span><span class="param">	<span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="concatenate_mappable_tensors-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#concatenate_mappable_tensors"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="concatenate_mappable_tensors-13"><a href="#concatenate_mappable_tensors-13"><span class="linenos">13</span></a><span class="k">def</span> <span class="nf">concatenate_mappable_tensors</span><span class="p">(</span>
</span><span id="concatenate_mappable_tensors-14"><a href="#concatenate_mappable_tensors-14"><span class="linenos">14</span></a>    <span class="o">*</span><span class="n">mappable_tensors</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="concatenate_mappable_tensors-15"><a href="#concatenate_mappable_tensors-15"><span class="linenos">15</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="concatenate_mappable_tensors-16"><a href="#concatenate_mappable_tensors-16"><span class="linenos">16</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Concatenate mappable tensors along the channel dimension</span>
</span><span id="concatenate_mappable_tensors-17"><a href="#concatenate_mappable_tensors-17"><span class="linenos">17</span></a>
</span><span id="concatenate_mappable_tensors-18"><a href="#concatenate_mappable_tensors-18"><span class="linenos">18</span></a><span class="sd">    Args:</span>
</span><span id="concatenate_mappable_tensors-19"><a href="#concatenate_mappable_tensors-19"><span class="linenos">19</span></a><span class="sd">        mappable_tensors: Masked tensors to concatenate</span>
</span><span id="concatenate_mappable_tensors-20"><a href="#concatenate_mappable_tensors-20"><span class="linenos">20</span></a><span class="sd">        channel_index: Index of the channel dimension starting from the first</span>
</span><span id="concatenate_mappable_tensors-21"><a href="#concatenate_mappable_tensors-21"><span class="linenos">21</span></a><span class="sd">            channel dimension over which to concatenate.</span>
</span><span id="concatenate_mappable_tensors-22"><a href="#concatenate_mappable_tensors-22"><span class="linenos">22</span></a>
</span><span id="concatenate_mappable_tensors-23"><a href="#concatenate_mappable_tensors-23"><span class="linenos">23</span></a><span class="sd">    Returns:</span>
</span><span id="concatenate_mappable_tensors-24"><a href="#concatenate_mappable_tensors-24"><span class="linenos">24</span></a><span class="sd">        Concatenated masked tensor.</span>
</span><span id="concatenate_mappable_tensors-25"><a href="#concatenate_mappable_tensors-25"><span class="linenos">25</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="concatenate_mappable_tensors-26"><a href="#concatenate_mappable_tensors-26"><span class="linenos">26</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
</span><span id="concatenate_mappable_tensors-27"><a href="#concatenate_mappable_tensors-27"><span class="linenos">27</span></a>        <span class="n">mappable_tensor</span><span class="o">.</span><span class="n">n_channel_dims</span> <span class="o">==</span> <span class="n">mappable_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n_channel_dims</span>
</span><span id="concatenate_mappable_tensors-28"><a href="#concatenate_mappable_tensors-28"><span class="linenos">28</span></a>        <span class="k">for</span> <span class="n">mappable_tensor</span> <span class="ow">in</span> <span class="n">mappable_tensors</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="concatenate_mappable_tensors-29"><a href="#concatenate_mappable_tensors-29"><span class="linenos">29</span></a>    <span class="p">):</span>
</span><span id="concatenate_mappable_tensors-30"><a href="#concatenate_mappable_tensors-30"><span class="linenos">30</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lengths of channel shapes of masked tensors must be the same&quot;</span><span class="p">)</span>
</span><span id="concatenate_mappable_tensors-31"><a href="#concatenate_mappable_tensors-31"><span class="linenos">31</span></a>    <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mappable_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">)</span>
</span><span id="concatenate_mappable_tensors-32"><a href="#concatenate_mappable_tensors-32"><span class="linenos">32</span></a>    <span class="n">concatenation_dim</span> <span class="o">=</span> <span class="n">get_channel_dims</span><span class="p">(</span>
</span><span id="concatenate_mappable_tensors-33"><a href="#concatenate_mappable_tensors-33"><span class="linenos">33</span></a>        <span class="n">n_total_dims</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">mappable_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
</span><span id="concatenate_mappable_tensors-34"><a href="#concatenate_mappable_tensors-34"><span class="linenos">34</span></a>        <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="concatenate_mappable_tensors-35"><a href="#concatenate_mappable_tensors-35"><span class="linenos">35</span></a>    <span class="p">)[</span><span class="n">channel_index</span><span class="p">]</span>
</span><span id="concatenate_mappable_tensors-36"><a href="#concatenate_mappable_tensors-36"><span class="linenos">36</span></a>    <span class="n">values</span> <span class="o">=</span> <span class="n">cat</span><span class="p">(</span>
</span><span id="concatenate_mappable_tensors-37"><a href="#concatenate_mappable_tensors-37"><span class="linenos">37</span></a>        <span class="p">[</span><span class="n">mappable_tensor</span><span class="o">.</span><span class="n">generate_values</span><span class="p">()</span> <span class="k">for</span> <span class="n">mappable_tensor</span> <span class="ow">in</span> <span class="n">mappable_tensors</span><span class="p">],</span>
</span><span id="concatenate_mappable_tensors-38"><a href="#concatenate_mappable_tensors-38"><span class="linenos">38</span></a>        <span class="n">dim</span><span class="o">=</span><span class="n">concatenation_dim</span><span class="p">,</span>
</span><span id="concatenate_mappable_tensors-39"><a href="#concatenate_mappable_tensors-39"><span class="linenos">39</span></a>    <span class="p">)</span>
</span><span id="concatenate_mappable_tensors-40"><a href="#concatenate_mappable_tensors-40"><span class="linenos">40</span></a>    <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="concatenate_mappable_tensors-41"><a href="#concatenate_mappable_tensors-41"><span class="linenos">41</span></a>    <span class="k">for</span> <span class="n">mappable_tensor</span> <span class="ow">in</span> <span class="n">mappable_tensors</span><span class="p">:</span>
</span><span id="concatenate_mappable_tensors-42"><a href="#concatenate_mappable_tensors-42"><span class="linenos">42</span></a>        <span class="n">update_mask</span> <span class="o">=</span> <span class="n">mappable_tensor</span><span class="o">.</span><span class="n">generate_mask</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="concatenate_mappable_tensors-43"><a href="#concatenate_mappable_tensors-43"><span class="linenos">43</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">combine_optional_masks</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">update_mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="concatenate_mappable_tensors-44"><a href="#concatenate_mappable_tensors-44"><span class="linenos">44</span></a>    <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="concatenate_mappable_tensors-45"><a href="#concatenate_mappable_tensors-45"><span class="linenos">45</span></a>        <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
</span><span id="concatenate_mappable_tensors-46"><a href="#concatenate_mappable_tensors-46"><span class="linenos">46</span></a>        <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="concatenate_mappable_tensors-47"><a href="#concatenate_mappable_tensors-47"><span class="linenos">47</span></a>        <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="concatenate_mappable_tensors-48"><a href="#concatenate_mappable_tensors-48"><span class="linenos">48</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Concatenate mappable tensors along the channel dimension</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mappable_tensors:</strong>  Masked tensors to concatenate</li>
<li><strong>channel_index:</strong>  Index of the channel dimension starting from the first
channel dimension over which to concatenate.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Concatenated masked tensor.</p>
</blockquote>
</div>


                </section>
                <section id="default_sampler">
                            <input id="default_sampler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">default_sampler</span><wbr>(<span class="base">contextlib.ContextDecorator</span>):

                <label class="view-source-button" for="default_sampler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#default_sampler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="default_sampler-46"><a href="#default_sampler-46"><span class="linenos">46</span></a><span class="k">class</span> <span class="nc">default_sampler</span><span class="p">(</span>  <span class="c1"># this is supposed to appear as function - pylint: disable=invalid-name</span>
</span><span id="default_sampler-47"><a href="#default_sampler-47"><span class="linenos">47</span></a>    <span class="n">ContextDecorator</span>
</span><span id="default_sampler-48"><a href="#default_sampler-48"><span class="linenos">48</span></a><span class="p">):</span>
</span><span id="default_sampler-49"><a href="#default_sampler-49"><span class="linenos">49</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager for setting default sampler</span>
</span><span id="default_sampler-50"><a href="#default_sampler-50"><span class="linenos">50</span></a>
</span><span id="default_sampler-51"><a href="#default_sampler-51"><span class="linenos">51</span></a><span class="sd">    Arguments:</span>
</span><span id="default_sampler-52"><a href="#default_sampler-52"><span class="linenos">52</span></a><span class="sd">        sampler: Sampler to set as default.</span>
</span><span id="default_sampler-53"><a href="#default_sampler-53"><span class="linenos">53</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="default_sampler-54"><a href="#default_sampler-54"><span class="linenos">54</span></a>
</span><span id="default_sampler-55"><a href="#default_sampler-55"><span class="linenos">55</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sampler</span><span class="p">:</span> <span class="n">ISampler</span><span class="p">):</span>
</span><span id="default_sampler-56"><a href="#default_sampler-56"><span class="linenos">56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span> <span class="o">=</span> <span class="n">sampler</span>
</span><span id="default_sampler-57"><a href="#default_sampler-57"><span class="linenos">57</span></a>
</span><span id="default_sampler-58"><a href="#default_sampler-58"><span class="linenos">58</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="default_sampler-59"><a href="#default_sampler-59"><span class="linenos">59</span></a>        <span class="n">_DEFAULT_SAMPLER_CONTEXT_STACK</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="p">)</span>
</span><span id="default_sampler-60"><a href="#default_sampler-60"><span class="linenos">60</span></a>
</span><span id="default_sampler-61"><a href="#default_sampler-61"><span class="linenos">61</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="default_sampler-62"><a href="#default_sampler-62"><span class="linenos">62</span></a>        <span class="n">_DEFAULT_SAMPLER_CONTEXT_STACK</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Context manager for setting default sampler</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>sampler:</strong>  Sampler to set as default.</li>
</ul>
</div>


                            <div id="default_sampler.__init__" class="classattr">
                                        <input id="default_sampler.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">default_sampler</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">sampler</span><span class="p">:</span> <span class="n"><a href="#ISampler">ISampler</a></span></span>)</span>

                <label class="view-source-button" for="default_sampler.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#default_sampler.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="default_sampler.__init__-55"><a href="#default_sampler.__init__-55"><span class="linenos">55</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sampler</span><span class="p">:</span> <span class="n">ISampler</span><span class="p">):</span>
</span><span id="default_sampler.__init__-56"><a href="#default_sampler.__init__-56"><span class="linenos">56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span> <span class="o">=</span> <span class="n">sampler</span>
</span></pre></div>


    

                            </div>
                            <div id="default_sampler.sampler" class="classattr">
                                <div class="attr variable">
            <span class="name">sampler</span>

        
    </div>
    <a class="headerlink" href="#default_sampler.sampler"></a>
    
    

                            </div>
                </section>
                <section id="diagonal_affine">
                            <input id="diagonal_affine-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">diagonal_affine</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">diagonal</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">translation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">matrix_shape</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#Affine">Affine</a></span>:</span></span>

                <label class="view-source-button" for="diagonal_affine-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#diagonal_affine"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="diagonal_affine-142"><a href="#diagonal_affine-142"><span class="linenos">142</span></a><span class="k">def</span> <span class="nf">diagonal_affine</span><span class="p">(</span>
</span><span id="diagonal_affine-143"><a href="#diagonal_affine-143"><span class="linenos">143</span></a>    <span class="n">diagonal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="diagonal_affine-144"><a href="#diagonal_affine-144"><span class="linenos">144</span></a>    <span class="n">translation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="diagonal_affine-145"><a href="#diagonal_affine-145"><span class="linenos">145</span></a>    <span class="n">matrix_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="diagonal_affine-146"><a href="#diagonal_affine-146"><span class="linenos">146</span></a>    <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="diagonal_affine-147"><a href="#diagonal_affine-147"><span class="linenos">147</span></a>    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="diagonal_affine-148"><a href="#diagonal_affine-148"><span class="linenos">148</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Affine</span><span class="p">:</span>
</span><span id="diagonal_affine-149"><a href="#diagonal_affine-149"><span class="linenos">149</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create affine mapping from diagonal and translation.</span>
</span><span id="diagonal_affine-150"><a href="#diagonal_affine-150"><span class="linenos">150</span></a>
</span><span id="diagonal_affine-151"><a href="#diagonal_affine-151"><span class="linenos">151</span></a><span class="sd">    See: `Affine.from_diagonal_and_translation`.</span>
</span><span id="diagonal_affine-152"><a href="#diagonal_affine-152"><span class="linenos">152</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="diagonal_affine-153"><a href="#diagonal_affine-153"><span class="linenos">153</span></a>    <span class="k">return</span> <span class="n">Affine</span><span class="o">.</span><span class="n">from_diagonal_and_translation</span><span class="p">(</span>
</span><span id="diagonal_affine-154"><a href="#diagonal_affine-154"><span class="linenos">154</span></a>        <span class="n">diagonal</span><span class="o">=</span><span class="n">diagonal</span><span class="p">,</span>
</span><span id="diagonal_affine-155"><a href="#diagonal_affine-155"><span class="linenos">155</span></a>        <span class="n">translation</span><span class="o">=</span><span class="n">translation</span><span class="p">,</span>
</span><span id="diagonal_affine-156"><a href="#diagonal_affine-156"><span class="linenos">156</span></a>        <span class="n">matrix_shape</span><span class="o">=</span><span class="n">matrix_shape</span><span class="p">,</span>
</span><span id="diagonal_affine-157"><a href="#diagonal_affine-157"><span class="linenos">157</span></a>        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="diagonal_affine-158"><a href="#diagonal_affine-158"><span class="linenos">158</span></a>        <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
</span><span id="diagonal_affine-159"><a href="#diagonal_affine-159"><span class="linenos">159</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create affine mapping from diagonal and translation.</p>

<p>See: <code><a href="#Affine.from_diagonal_and_translation">Affine.from_diagonal_and_translation</a></code>.</p>
</div>


                </section>
                <section id="estimate_spatial_jacobian_matrices">
                            <input id="estimate_spatial_jacobian_matrices-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">estimate_spatial_jacobian_matrices</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">mapping</span><span class="p">:</span> <span class="n"><a href="#GridComposableMapping">GridComposableMapping</a></span>,</span><span class="param">	<span class="n">target</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">composable_mapping</span><span class="o">.</span><span class="n">composable_mapping</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">ICoordinateSystemContainer</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">limit_direction</span><span class="p">:</span> <span class="n"><a href="#LimitDirection">LimitDirection</a></span> <span class="o">=</span> <span class="o">&lt;</span><span class="n"><a href="#LimitDirection">LimitDirection</a></span> <span class="nb">object</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">sampler</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#ISampler">ISampler</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="estimate_spatial_jacobian_matrices-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#estimate_spatial_jacobian_matrices"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="estimate_spatial_jacobian_matrices-20"><a href="#estimate_spatial_jacobian_matrices-20"><span class="linenos"> 20</span></a><span class="k">def</span> <span class="nf">estimate_spatial_jacobian_matrices</span><span class="p">(</span>
</span><span id="estimate_spatial_jacobian_matrices-21"><a href="#estimate_spatial_jacobian_matrices-21"><span class="linenos"> 21</span></a>    <span class="n">mapping</span><span class="p">:</span> <span class="n">GridComposableMapping</span><span class="p">,</span>
</span><span id="estimate_spatial_jacobian_matrices-22"><a href="#estimate_spatial_jacobian_matrices-22"><span class="linenos"> 22</span></a>    <span class="n">target</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ICoordinateSystemContainer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="estimate_spatial_jacobian_matrices-23"><a href="#estimate_spatial_jacobian_matrices-23"><span class="linenos"> 23</span></a>    <span class="n">limit_direction</span><span class="p">:</span> <span class="n">LimitDirection</span> <span class="o">=</span> <span class="n">LimitDirection</span><span class="o">.</span><span class="n">average</span><span class="p">(),</span>
</span><span id="estimate_spatial_jacobian_matrices-24"><a href="#estimate_spatial_jacobian_matrices-24"><span class="linenos"> 24</span></a>    <span class="n">sampler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ISampler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="estimate_spatial_jacobian_matrices-25"><a href="#estimate_spatial_jacobian_matrices-25"><span class="linenos"> 25</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="estimate_spatial_jacobian_matrices-26"><a href="#estimate_spatial_jacobian_matrices-26"><span class="linenos"> 26</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimate spatial Jacobian matrices of a grid composable mapping.</span>
</span><span id="estimate_spatial_jacobian_matrices-27"><a href="#estimate_spatial_jacobian_matrices-27"><span class="linenos"> 27</span></a>
</span><span id="estimate_spatial_jacobian_matrices-28"><a href="#estimate_spatial_jacobian_matrices-28"><span class="linenos"> 28</span></a><span class="sd">    Estimation is done based on samples of the mapping at the grid defined by</span>
</span><span id="estimate_spatial_jacobian_matrices-29"><a href="#estimate_spatial_jacobian_matrices-29"><span class="linenos"> 29</span></a><span class="sd">    the coordinate system of the mapping.</span>
</span><span id="estimate_spatial_jacobian_matrices-30"><a href="#estimate_spatial_jacobian_matrices-30"><span class="linenos"> 30</span></a>
</span><span id="estimate_spatial_jacobian_matrices-31"><a href="#estimate_spatial_jacobian_matrices-31"><span class="linenos"> 31</span></a><span class="sd">    Args:</span>
</span><span id="estimate_spatial_jacobian_matrices-32"><a href="#estimate_spatial_jacobian_matrices-32"><span class="linenos"> 32</span></a><span class="sd">        mapping: Grid composable mapping to estimate the Jacobian matrices for.</span>
</span><span id="estimate_spatial_jacobian_matrices-33"><a href="#estimate_spatial_jacobian_matrices-33"><span class="linenos"> 33</span></a><span class="sd">        target: Target locations at which to estimate the Jacobian matrices.</span>
</span><span id="estimate_spatial_jacobian_matrices-34"><a href="#estimate_spatial_jacobian_matrices-34"><span class="linenos"> 34</span></a><span class="sd">        limit_direction: Direction in which to compute the derivatives, e.g. average</span>
</span><span id="estimate_spatial_jacobian_matrices-35"><a href="#estimate_spatial_jacobian_matrices-35"><span class="linenos"> 35</span></a><span class="sd">            and LinearInterpolator corresponds to central finite differences when</span>
</span><span id="estimate_spatial_jacobian_matrices-36"><a href="#estimate_spatial_jacobian_matrices-36"><span class="linenos"> 36</span></a><span class="sd">            estimated at the grid points.</span>
</span><span id="estimate_spatial_jacobian_matrices-37"><a href="#estimate_spatial_jacobian_matrices-37"><span class="linenos"> 37</span></a><span class="sd">        sampler: Sampler to use for the derivative estimation, e.g. LinearInterpolator</span>
</span><span id="estimate_spatial_jacobian_matrices-38"><a href="#estimate_spatial_jacobian_matrices-38"><span class="linenos"> 38</span></a><span class="sd">            corresponds to finite differences.</span>
</span><span id="estimate_spatial_jacobian_matrices-39"><a href="#estimate_spatial_jacobian_matrices-39"><span class="linenos"> 39</span></a>
</span><span id="estimate_spatial_jacobian_matrices-40"><a href="#estimate_spatial_jacobian_matrices-40"><span class="linenos"> 40</span></a><span class="sd">    Returns:</span>
</span><span id="estimate_spatial_jacobian_matrices-41"><a href="#estimate_spatial_jacobian_matrices-41"><span class="linenos"> 41</span></a><span class="sd">        MappableTensor with the estimated Jacobian matrices over spatial locations.</span>
</span><span id="estimate_spatial_jacobian_matrices-42"><a href="#estimate_spatial_jacobian_matrices-42"><span class="linenos"> 42</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="estimate_spatial_jacobian_matrices-43"><a href="#estimate_spatial_jacobian_matrices-43"><span class="linenos"> 43</span></a>    <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="estimate_spatial_jacobian_matrices-44"><a href="#estimate_spatial_jacobian_matrices-44"><span class="linenos"> 44</span></a>        <span class="n">target</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">coordinate_system</span>
</span><span id="estimate_spatial_jacobian_matrices-45"><a href="#estimate_spatial_jacobian_matrices-45"><span class="linenos"> 45</span></a>    <span class="k">if</span> <span class="n">sampler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="estimate_spatial_jacobian_matrices-46"><a href="#estimate_spatial_jacobian_matrices-46"><span class="linenos"> 46</span></a>        <span class="n">sampler</span> <span class="o">=</span> <span class="n">get_sampler</span><span class="p">(</span><span class="n">sampler</span><span class="p">)</span>
</span><span id="estimate_spatial_jacobian_matrices-47"><a href="#estimate_spatial_jacobian_matrices-47"><span class="linenos"> 47</span></a>    <span class="n">resampled_mapping</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">resample_to</span><span class="p">(</span>
</span><span id="estimate_spatial_jacobian_matrices-48"><a href="#estimate_spatial_jacobian_matrices-48"><span class="linenos"> 48</span></a>        <span class="n">mapping</span><span class="p">,</span>
</span><span id="estimate_spatial_jacobian_matrices-49"><a href="#estimate_spatial_jacobian_matrices-49"><span class="linenos"> 49</span></a>        <span class="n">data_format</span><span class="o">=</span><span class="n">DataFormat</span><span class="o">.</span><span class="n">world_coordinates</span><span class="p">(),</span>
</span><span id="estimate_spatial_jacobian_matrices-50"><a href="#estimate_spatial_jacobian_matrices-50"><span class="linenos"> 50</span></a>    <span class="p">)</span>
</span><span id="estimate_spatial_jacobian_matrices-51"><a href="#estimate_spatial_jacobian_matrices-51"><span class="linenos"> 51</span></a>    <span class="n">n_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="estimate_spatial_jacobian_matrices-52"><a href="#estimate_spatial_jacobian_matrices-52"><span class="linenos"> 52</span></a>    <span class="n">sampled_jacobians</span> <span class="o">=</span> <span class="n">stack_mappable_tensors</span><span class="p">(</span>
</span><span id="estimate_spatial_jacobian_matrices-53"><a href="#estimate_spatial_jacobian_matrices-53"><span class="linenos"> 53</span></a>        <span class="o">*</span><span class="p">(</span>
</span><span id="estimate_spatial_jacobian_matrices-54"><a href="#estimate_spatial_jacobian_matrices-54"><span class="linenos"> 54</span></a>            <span class="n">resampled_mapping</span><span class="o">.</span><span class="n">modify_sampler</span><span class="p">(</span>
</span><span id="estimate_spatial_jacobian_matrices-55"><a href="#estimate_spatial_jacobian_matrices-55"><span class="linenos"> 55</span></a>                <span class="n">sampler</span><span class="o">.</span><span class="n">derivative</span><span class="p">(</span><span class="n">spatial_dim</span><span class="o">=</span><span class="n">spatial_dim</span><span class="p">,</span> <span class="n">limit_direction</span><span class="o">=</span><span class="n">limit_direction</span><span class="p">),</span>
</span><span id="estimate_spatial_jacobian_matrices-56"><a href="#estimate_spatial_jacobian_matrices-56"><span class="linenos"> 56</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">sample_to</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span><span id="estimate_spatial_jacobian_matrices-57"><a href="#estimate_spatial_jacobian_matrices-57"><span class="linenos"> 57</span></a>            <span class="k">for</span> <span class="n">spatial_dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_dims</span><span class="p">)</span>
</span><span id="estimate_spatial_jacobian_matrices-58"><a href="#estimate_spatial_jacobian_matrices-58"><span class="linenos"> 58</span></a>        <span class="p">),</span>
</span><span id="estimate_spatial_jacobian_matrices-59"><a href="#estimate_spatial_jacobian_matrices-59"><span class="linenos"> 59</span></a>        <span class="n">channel_index</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
</span><span id="estimate_spatial_jacobian_matrices-60"><a href="#estimate_spatial_jacobian_matrices-60"><span class="linenos"> 60</span></a>    <span class="p">)</span>
</span><span id="estimate_spatial_jacobian_matrices-61"><a href="#estimate_spatial_jacobian_matrices-61"><span class="linenos"> 61</span></a>    <span class="n">jacobian_matrices</span><span class="p">,</span> <span class="n">jacobians_mask</span> <span class="o">=</span> <span class="n">sampled_jacobians</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
</span><span id="estimate_spatial_jacobian_matrices-62"><a href="#estimate_spatial_jacobian_matrices-62"><span class="linenos"> 62</span></a>    <span class="n">target_jacobian_matrix_shape</span> <span class="o">=</span> <span class="n">sampled_jacobians</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
</span><span id="estimate_spatial_jacobian_matrices-63"><a href="#estimate_spatial_jacobian_matrices-63"><span class="linenos"> 63</span></a>        <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">),</span>
</span><span id="estimate_spatial_jacobian_matrices-64"><a href="#estimate_spatial_jacobian_matrices-64"><span class="linenos"> 64</span></a>    <span class="p">)</span>
</span><span id="estimate_spatial_jacobian_matrices-65"><a href="#estimate_spatial_jacobian_matrices-65"><span class="linenos"> 65</span></a>    <span class="n">jacobian_matrices</span> <span class="o">=</span> <span class="n">jacobian_matrices</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
</span><span id="estimate_spatial_jacobian_matrices-66"><a href="#estimate_spatial_jacobian_matrices-66"><span class="linenos"> 66</span></a>        <span class="n">sampled_jacobians</span><span class="o">.</span><span class="n">batch_shape</span>
</span><span id="estimate_spatial_jacobian_matrices-67"><a href="#estimate_spatial_jacobian_matrices-67"><span class="linenos"> 67</span></a>        <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sampled_jacobians</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="estimate_spatial_jacobian_matrices-68"><a href="#estimate_spatial_jacobian_matrices-68"><span class="linenos"> 68</span></a>        <span class="o">+</span> <span class="n">sampled_jacobians</span><span class="o">.</span><span class="n">spatial_shape</span>
</span><span id="estimate_spatial_jacobian_matrices-69"><a href="#estimate_spatial_jacobian_matrices-69"><span class="linenos"> 69</span></a>    <span class="p">)</span>
</span><span id="estimate_spatial_jacobian_matrices-70"><a href="#estimate_spatial_jacobian_matrices-70"><span class="linenos"> 70</span></a>    <span class="n">coordinate_system_affine_transformation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="estimate_spatial_jacobian_matrices-71"><a href="#estimate_spatial_jacobian_matrices-71"><span class="linenos"> 71</span></a>        <span class="n">target</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">to_voxel_coordinates</span><span class="o">.</span><span class="n">transformation</span>
</span><span id="estimate_spatial_jacobian_matrices-72"><a href="#estimate_spatial_jacobian_matrices-72"><span class="linenos"> 72</span></a>    <span class="p">)</span>
</span><span id="estimate_spatial_jacobian_matrices-73"><a href="#estimate_spatial_jacobian_matrices-73"><span class="linenos"> 73</span></a>    <span class="n">coordinate_system_diagonal_affine_matrix</span> <span class="o">=</span> <span class="n">coordinate_system_affine_transformation</span><span class="o">.</span><span class="n">as_diagonal</span><span class="p">()</span>
</span><span id="estimate_spatial_jacobian_matrices-74"><a href="#estimate_spatial_jacobian_matrices-74"><span class="linenos"> 74</span></a>    <span class="k">if</span> <span class="n">coordinate_system_diagonal_affine_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="estimate_spatial_jacobian_matrices-75"><a href="#estimate_spatial_jacobian_matrices-75"><span class="linenos"> 75</span></a>        <span class="n">coordinate_system_affine_matrix</span> <span class="o">=</span> <span class="n">coordinate_system_affine_transformation</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
</span><span id="estimate_spatial_jacobian_matrices-76"><a href="#estimate_spatial_jacobian_matrices-76"><span class="linenos"> 76</span></a>        <span class="n">jacobian_matrices</span><span class="p">,</span> <span class="n">coordinate_system_affine_matrix</span> <span class="o">=</span> <span class="n">broadcast_tensors_in_parts</span><span class="p">(</span>
</span><span id="estimate_spatial_jacobian_matrices-77"><a href="#estimate_spatial_jacobian_matrices-77"><span class="linenos"> 77</span></a>            <span class="n">jacobian_matrices</span><span class="p">,</span>
</span><span id="estimate_spatial_jacobian_matrices-78"><a href="#estimate_spatial_jacobian_matrices-78"><span class="linenos"> 78</span></a>            <span class="n">coordinate_system_affine_matrix</span><span class="p">,</span>
</span><span id="estimate_spatial_jacobian_matrices-79"><a href="#estimate_spatial_jacobian_matrices-79"><span class="linenos"> 79</span></a>            <span class="n">broadcast_channels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="estimate_spatial_jacobian_matrices-80"><a href="#estimate_spatial_jacobian_matrices-80"><span class="linenos"> 80</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
</span><span id="estimate_spatial_jacobian_matrices-81"><a href="#estimate_spatial_jacobian_matrices-81"><span class="linenos"> 81</span></a>        <span class="p">)</span>
</span><span id="estimate_spatial_jacobian_matrices-82"><a href="#estimate_spatial_jacobian_matrices-82"><span class="linenos"> 82</span></a>        <span class="n">composed_jacobian_matrices</span> <span class="o">=</span> <span class="n">move_channels_first</span><span class="p">(</span>
</span><span id="estimate_spatial_jacobian_matrices-83"><a href="#estimate_spatial_jacobian_matrices-83"><span class="linenos"> 83</span></a>            <span class="n">matmul</span><span class="p">(</span>
</span><span id="estimate_spatial_jacobian_matrices-84"><a href="#estimate_spatial_jacobian_matrices-84"><span class="linenos"> 84</span></a>                <span class="n">move_channels_last</span><span class="p">(</span><span class="n">jacobian_matrices</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
</span><span id="estimate_spatial_jacobian_matrices-85"><a href="#estimate_spatial_jacobian_matrices-85"><span class="linenos"> 85</span></a>                <span class="n">move_channels_last</span><span class="p">(</span><span class="n">coordinate_system_affine_matrix</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span>
</span><span id="estimate_spatial_jacobian_matrices-86"><a href="#estimate_spatial_jacobian_matrices-86"><span class="linenos"> 86</span></a>                    <span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span>
</span><span id="estimate_spatial_jacobian_matrices-87"><a href="#estimate_spatial_jacobian_matrices-87"><span class="linenos"> 87</span></a>                <span class="p">],</span>
</span><span id="estimate_spatial_jacobian_matrices-88"><a href="#estimate_spatial_jacobian_matrices-88"><span class="linenos"> 88</span></a>            <span class="p">),</span>
</span><span id="estimate_spatial_jacobian_matrices-89"><a href="#estimate_spatial_jacobian_matrices-89"><span class="linenos"> 89</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="estimate_spatial_jacobian_matrices-90"><a href="#estimate_spatial_jacobian_matrices-90"><span class="linenos"> 90</span></a>        <span class="p">)</span>
</span><span id="estimate_spatial_jacobian_matrices-91"><a href="#estimate_spatial_jacobian_matrices-91"><span class="linenos"> 91</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="estimate_spatial_jacobian_matrices-92"><a href="#estimate_spatial_jacobian_matrices-92"><span class="linenos"> 92</span></a>        <span class="n">jacobian_matrices</span><span class="p">,</span> <span class="n">coordinate_system_diagonal</span> <span class="o">=</span> <span class="n">broadcast_tensors_in_parts</span><span class="p">(</span>
</span><span id="estimate_spatial_jacobian_matrices-93"><a href="#estimate_spatial_jacobian_matrices-93"><span class="linenos"> 93</span></a>            <span class="n">jacobian_matrices</span><span class="p">,</span>
</span><span id="estimate_spatial_jacobian_matrices-94"><a href="#estimate_spatial_jacobian_matrices-94"><span class="linenos"> 94</span></a>            <span class="n">coordinate_system_diagonal_affine_matrix</span><span class="o">.</span><span class="n">generate_diagonal</span><span class="p">(),</span>
</span><span id="estimate_spatial_jacobian_matrices-95"><a href="#estimate_spatial_jacobian_matrices-95"><span class="linenos"> 95</span></a>            <span class="n">broadcast_channels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="estimate_spatial_jacobian_matrices-96"><a href="#estimate_spatial_jacobian_matrices-96"><span class="linenos"> 96</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="estimate_spatial_jacobian_matrices-97"><a href="#estimate_spatial_jacobian_matrices-97"><span class="linenos"> 97</span></a>        <span class="p">)</span>
</span><span id="estimate_spatial_jacobian_matrices-98"><a href="#estimate_spatial_jacobian_matrices-98"><span class="linenos"> 98</span></a>        <span class="n">n_batch_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">get_batch_shape</span><span class="p">(</span><span class="n">coordinate_system_diagonal</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="estimate_spatial_jacobian_matrices-99"><a href="#estimate_spatial_jacobian_matrices-99"><span class="linenos"> 99</span></a>        <span class="n">composed_jacobian_matrices</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="estimate_spatial_jacobian_matrices-100"><a href="#estimate_spatial_jacobian_matrices-100"><span class="linenos">100</span></a>            <span class="n">jacobian_matrices</span> <span class="o">*</span> <span class="n">coordinate_system_diagonal</span><span class="p">[</span><span class="n">n_batch_dims</span> <span class="o">*</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">+</span> <span class="p">(</span><span class="kc">None</span><span class="p">,)]</span>
</span><span id="estimate_spatial_jacobian_matrices-101"><a href="#estimate_spatial_jacobian_matrices-101"><span class="linenos">101</span></a>        <span class="p">)</span>
</span><span id="estimate_spatial_jacobian_matrices-102"><a href="#estimate_spatial_jacobian_matrices-102"><span class="linenos">102</span></a>    <span class="n">batch_shape</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">split_shape</span><span class="p">(</span><span class="n">jacobian_matrices</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="estimate_spatial_jacobian_matrices-103"><a href="#estimate_spatial_jacobian_matrices-103"><span class="linenos">103</span></a>    <span class="n">composed_jacobian_matrices</span> <span class="o">=</span> <span class="n">composed_jacobian_matrices</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
</span><span id="estimate_spatial_jacobian_matrices-104"><a href="#estimate_spatial_jacobian_matrices-104"><span class="linenos">104</span></a>        <span class="n">batch_shape</span> <span class="o">+</span> <span class="n">target_jacobian_matrix_shape</span> <span class="o">+</span> <span class="n">spatial_shape</span>
</span><span id="estimate_spatial_jacobian_matrices-105"><a href="#estimate_spatial_jacobian_matrices-105"><span class="linenos">105</span></a>    <span class="p">)</span>
</span><span id="estimate_spatial_jacobian_matrices-106"><a href="#estimate_spatial_jacobian_matrices-106"><span class="linenos">106</span></a>    <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="estimate_spatial_jacobian_matrices-107"><a href="#estimate_spatial_jacobian_matrices-107"><span class="linenos">107</span></a>        <span class="n">composed_jacobian_matrices</span><span class="p">,</span>
</span><span id="estimate_spatial_jacobian_matrices-108"><a href="#estimate_spatial_jacobian_matrices-108"><span class="linenos">108</span></a>        <span class="n">mask</span><span class="o">=</span><span class="n">jacobians_mask</span><span class="p">,</span>
</span><span id="estimate_spatial_jacobian_matrices-109"><a href="#estimate_spatial_jacobian_matrices-109"><span class="linenos">109</span></a>        <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">sampled_jacobians</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="estimate_spatial_jacobian_matrices-110"><a href="#estimate_spatial_jacobian_matrices-110"><span class="linenos">110</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Estimate spatial Jacobian matrices of a grid composable mapping.</p>

<p>Estimation is done based on samples of the mapping at the grid defined by
the coordinate system of the mapping.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mapping:</strong>  Grid composable mapping to estimate the Jacobian matrices for.</li>
<li><strong>target:</strong>  Target locations at which to estimate the Jacobian matrices.</li>
<li><strong>limit_direction:</strong>  Direction in which to compute the derivatives, e.g. average
and LinearInterpolator corresponds to central finite differences when
estimated at the grid points.</li>
<li><strong>sampler:</strong>  Sampler to use for the derivative estimation, e.g. LinearInterpolator
corresponds to finite differences.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>MappableTensor with the estimated Jacobian matrices over spatial locations.</p>
</blockquote>
</div>


                </section>
                <section id="get_default_sampler">
                            <input id="get_default_sampler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_default_sampler</span><span class="signature pdoc-code condensed">(<span class="return-annotation">) -> <span class="n"><a href="#ISampler">ISampler</a></span>:</span></span>

                <label class="view-source-button" for="get_default_sampler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_default_sampler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_default_sampler-16"><a href="#get_default_sampler-16"><span class="linenos">16</span></a><span class="k">def</span> <span class="nf">get_default_sampler</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ISampler</span><span class="p">:</span>
</span><span id="get_default_sampler-17"><a href="#get_default_sampler-17"><span class="linenos">17</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get current default sampler&quot;&quot;&quot;</span>
</span><span id="get_default_sampler-18"><a href="#get_default_sampler-18"><span class="linenos">18</span></a>    <span class="k">if</span> <span class="n">_DEFAULT_SAMPLER_CONTEXT_STACK</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
</span><span id="get_default_sampler-19"><a href="#get_default_sampler-19"><span class="linenos">19</span></a>        <span class="k">return</span> <span class="n">_DEFAULT_SAMPLER_CONTEXT_STACK</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="get_default_sampler-20"><a href="#get_default_sampler-20"><span class="linenos">20</span></a>    <span class="k">if</span> <span class="n">_DEFAULT_SAMPLER</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="get_default_sampler-21"><a href="#get_default_sampler-21"><span class="linenos">21</span></a>        <span class="k">return</span> <span class="n">LinearInterpolator</span><span class="p">()</span>
</span><span id="get_default_sampler-22"><a href="#get_default_sampler-22"><span class="linenos">22</span></a>    <span class="k">return</span> <span class="n">_DEFAULT_SAMPLER</span>
</span></pre></div>


            <div class="docstring"><p>Get current default sampler</p>
</div>


                </section>
                <section id="get_sampler">
                            <input id="get_sampler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_sampler</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">sampler</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#ISampler">ISampler</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="#ISampler">ISampler</a></span>:</span></span>

                <label class="view-source-button" for="get_sampler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_sampler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_sampler-41"><a href="#get_sampler-41"><span class="linenos">41</span></a><span class="k">def</span> <span class="nf">get_sampler</span><span class="p">(</span><span class="n">sampler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ISampler</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ISampler</span><span class="p">:</span>
</span><span id="get_sampler-42"><a href="#get_sampler-42"><span class="linenos">42</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get sampler, either from argument or default&quot;&quot;&quot;</span>
</span><span id="get_sampler-43"><a href="#get_sampler-43"><span class="linenos">43</span></a>    <span class="k">return</span> <span class="n">sampler</span> <span class="k">if</span> <span class="n">sampler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">get_default_sampler</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Get sampler, either from argument or default</p>
</div>


                </section>
                <section id="mappable">
                            <input id="mappable-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">mappable</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">values</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="mappable-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#mappable"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="mappable-796"><a href="#mappable-796"><span class="linenos">796</span></a><span class="k">def</span> <span class="nf">mappable</span><span class="p">(</span>
</span><span id="mappable-797"><a href="#mappable-797"><span class="linenos">797</span></a>    <span class="n">values</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="mappable-798"><a href="#mappable-798"><span class="linenos">798</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="mappable-799"><a href="#mappable-799"><span class="linenos">799</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a mappable tensor from values and mask</span>
</span><span id="mappable-800"><a href="#mappable-800"><span class="linenos">800</span></a>
</span><span id="mappable-801"><a href="#mappable-801"><span class="linenos">801</span></a><span class="sd">    See: `MappableTensor.from_tensor`.</span>
</span><span id="mappable-802"><a href="#mappable-802"><span class="linenos">802</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="mappable-803"><a href="#mappable-803"><span class="linenos">803</span></a>    <span class="k">return</span> <span class="n">MappableTensor</span><span class="o">.</span><span class="n">from_tensor</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a mappable tensor from values and mask</p>

<p>See: <code><a href="#MappableTensor.from_tensor">MappableTensor.from_tensor</a></code>.</p>
</div>


                </section>
                <section id="samplable_volume">
                            <input id="samplable_volume-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">samplable_volume</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">data</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>,</span><span class="param">	<span class="n">coordinate_system</span><span class="p">:</span> <span class="n"><a href="#CoordinateSystem">CoordinateSystem</a></span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">data_format</span><span class="p">:</span> <span class="n"><a href="#DataFormat">DataFormat</a></span> <span class="o">=</span> <span class="n">DataFormat</span><span class="p">(</span><span class="n">representation</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span> <span class="n">coordinate_type</span><span class="o">=</span><span class="n">world</span><span class="p">)</span>,</span><span class="param">	<span class="n">sampler</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#ISampler">ISampler</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#GridComposableMapping">GridComposableMapping</a></span>:</span></span>

                <label class="view-source-button" for="samplable_volume-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#samplable_volume"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="samplable_volume-850"><a href="#samplable_volume-850"><span class="linenos">850</span></a><span class="k">def</span> <span class="nf">samplable_volume</span><span class="p">(</span>
</span><span id="samplable_volume-851"><a href="#samplable_volume-851"><span class="linenos">851</span></a>    <span class="n">data</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
</span><span id="samplable_volume-852"><a href="#samplable_volume-852"><span class="linenos">852</span></a>    <span class="n">coordinate_system</span><span class="p">:</span> <span class="s2">&quot;CoordinateSystem&quot;</span><span class="p">,</span>
</span><span id="samplable_volume-853"><a href="#samplable_volume-853"><span class="linenos">853</span></a>    <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="samplable_volume-854"><a href="#samplable_volume-854"><span class="linenos">854</span></a>    <span class="n">data_format</span><span class="p">:</span> <span class="n">DataFormat</span> <span class="o">=</span> <span class="n">DataFormat</span><span class="o">.</span><span class="n">world_coordinates</span><span class="p">(),</span>
</span><span id="samplable_volume-855"><a href="#samplable_volume-855"><span class="linenos">855</span></a>    <span class="n">sampler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ISampler</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="samplable_volume-856"><a href="#samplable_volume-856"><span class="linenos">856</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GridComposableMapping</span><span class="p">:</span>
</span><span id="samplable_volume-857"><a href="#samplable_volume-857"><span class="linenos">857</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a samplable volume from a tensor.</span>
</span><span id="samplable_volume-858"><a href="#samplable_volume-858"><span class="linenos">858</span></a>
</span><span id="samplable_volume-859"><a href="#samplable_volume-859"><span class="linenos">859</span></a><span class="sd">    See: `SamplableVolume.from_tensor`.</span>
</span><span id="samplable_volume-860"><a href="#samplable_volume-860"><span class="linenos">860</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="samplable_volume-861"><a href="#samplable_volume-861"><span class="linenos">861</span></a>    <span class="k">return</span> <span class="n">SamplableVolume</span><span class="p">(</span>
</span><span id="samplable_volume-862"><a href="#samplable_volume-862"><span class="linenos">862</span></a>        <span class="n">data</span><span class="o">=</span><span class="n">mappable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="p">),</span>
</span><span id="samplable_volume-863"><a href="#samplable_volume-863"><span class="linenos">863</span></a>        <span class="n">coordinate_system</span><span class="o">=</span><span class="n">coordinate_system</span><span class="p">,</span>
</span><span id="samplable_volume-864"><a href="#samplable_volume-864"><span class="linenos">864</span></a>        <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">,</span>
</span><span id="samplable_volume-865"><a href="#samplable_volume-865"><span class="linenos">865</span></a>        <span class="n">sampler</span><span class="o">=</span><span class="n">sampler</span><span class="p">,</span>
</span><span id="samplable_volume-866"><a href="#samplable_volume-866"><span class="linenos">866</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a samplable volume from a tensor.</p>

<p>See: <code><a href="#SamplableVolume.from_tensor">SamplableVolume.from_tensor</a></code>.</p>
</div>


                </section>
                <section id="set_default_sampler">
                            <input id="set_default_sampler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_default_sampler</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">sampler</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#ISampler">ISampler</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="kc">None</span>:</span></span>

                <label class="view-source-button" for="set_default_sampler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#set_default_sampler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="set_default_sampler-25"><a href="#set_default_sampler-25"><span class="linenos">25</span></a><span class="k">def</span> <span class="nf">set_default_sampler</span><span class="p">(</span><span class="n">sampler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ISampler</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="set_default_sampler-26"><a href="#set_default_sampler-26"><span class="linenos">26</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Set default sampler</span>
</span><span id="set_default_sampler-27"><a href="#set_default_sampler-27"><span class="linenos">27</span></a>
</span><span id="set_default_sampler-28"><a href="#set_default_sampler-28"><span class="linenos">28</span></a><span class="sd">    Args:</span>
</span><span id="set_default_sampler-29"><a href="#set_default_sampler-29"><span class="linenos">29</span></a><span class="sd">        sampler: Sampler to set as default.</span>
</span><span id="set_default_sampler-30"><a href="#set_default_sampler-30"><span class="linenos">30</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="set_default_sampler-31"><a href="#set_default_sampler-31"><span class="linenos">31</span></a>    <span class="k">global</span> <span class="n">_DEFAULT_SAMPLER</span>  <span class="c1"># pylint: disable=global-statement</span>
</span><span id="set_default_sampler-32"><a href="#set_default_sampler-32"><span class="linenos">32</span></a>    <span class="n">_DEFAULT_SAMPLER</span> <span class="o">=</span> <span class="n">sampler</span>
</span></pre></div>


            <div class="docstring"><p>Set default sampler</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>sampler:</strong>  Sampler to set as default.</li>
</ul>
</div>


                </section>
                <section id="stack_mappings">
                            <input id="stack_mappings-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">stack_mappings</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="o">*</span><span class="n">mappings</span><span class="p">:</span> <span class="o">~</span><span class="n">ComposableMappingT</span>,</span><span class="param">	<span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span><span class="return-annotation">) -> <span class="o">~</span><span class="n">ComposableMappingT</span>:</span></span>

                <label class="view-source-button" for="stack_mappings-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#stack_mappings"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="stack_mappings-21"><a href="#stack_mappings-21"><span class="linenos">21</span></a><span class="k">def</span> <span class="nf">stack_mappings</span><span class="p">(</span><span class="o">*</span><span class="n">mappings</span><span class="p">:</span> <span class="n">ComposableMappingT</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ComposableMappingT</span><span class="p">:</span>
</span><span id="stack_mappings-22"><a href="#stack_mappings-22"><span class="linenos">22</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Stack mappings along a channel dimension.</span>
</span><span id="stack_mappings-23"><a href="#stack_mappings-23"><span class="linenos">23</span></a>
</span><span id="stack_mappings-24"><a href="#stack_mappings-24"><span class="linenos">24</span></a><span class="sd">    Args:</span>
</span><span id="stack_mappings-25"><a href="#stack_mappings-25"><span class="linenos">25</span></a><span class="sd">        mappings: Mappings to stack.</span>
</span><span id="stack_mappings-26"><a href="#stack_mappings-26"><span class="linenos">26</span></a><span class="sd">        channel_index: Channel index along which to stack.</span>
</span><span id="stack_mappings-27"><a href="#stack_mappings-27"><span class="linenos">27</span></a>
</span><span id="stack_mappings-28"><a href="#stack_mappings-28"><span class="linenos">28</span></a><span class="sd">    Returns:</span>
</span><span id="stack_mappings-29"><a href="#stack_mappings-29"><span class="linenos">29</span></a><span class="sd">        A mapping with the output being the outputs of the input mappings</span>
</span><span id="stack_mappings-30"><a href="#stack_mappings-30"><span class="linenos">30</span></a><span class="sd">        stacked along the channel dimension.</span>
</span><span id="stack_mappings-31"><a href="#stack_mappings-31"><span class="linenos">31</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="stack_mappings-32"><a href="#stack_mappings-32"><span class="linenos">32</span></a>    <span class="n">stacked</span><span class="p">:</span> <span class="n">ComposableMapping</span> <span class="o">=</span> <span class="n">_Stack</span><span class="p">(</span><span class="o">*</span><span class="n">mappings</span><span class="p">,</span> <span class="n">channel_index</span><span class="o">=</span><span class="n">channel_index</span><span class="p">)</span>
</span><span id="stack_mappings-33"><a href="#stack_mappings-33"><span class="linenos">33</span></a>    <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">:</span>
</span><span id="stack_mappings-34"><a href="#stack_mappings-34"><span class="linenos">34</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">GridComposableMapping</span><span class="p">):</span>
</span><span id="stack_mappings-35"><a href="#stack_mappings-35"><span class="linenos">35</span></a>            <span class="n">stacked</span> <span class="o">=</span> <span class="n">stacked</span><span class="o">.</span><span class="n">assign_coordinates</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span>
</span><span id="stack_mappings-36"><a href="#stack_mappings-36"><span class="linenos">36</span></a>            <span class="k">break</span>
</span><span id="stack_mappings-37"><a href="#stack_mappings-37"><span class="linenos">37</span></a>    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">ComposableMappingT</span><span class="p">,</span> <span class="n">stacked</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Stack mappings along a channel dimension.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mappings:</strong>  Mappings to stack.</li>
<li><strong>channel_index:</strong>  Channel index along which to stack.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>A mapping with the output being the outputs of the input mappings
  stacked along the channel dimension.</p>
</blockquote>
</div>


                </section>
                <section id="stack_mappable_tensors">
                            <input id="stack_mappable_tensors-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">stack_mappable_tensors</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="o">*</span><span class="n">mappable_tensors</span><span class="p">:</span> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>,</span><span class="param">	<span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="stack_mappable_tensors-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#stack_mappable_tensors"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="stack_mappable_tensors-51"><a href="#stack_mappable_tensors-51"><span class="linenos">51</span></a><span class="k">def</span> <span class="nf">stack_mappable_tensors</span><span class="p">(</span>
</span><span id="stack_mappable_tensors-52"><a href="#stack_mappable_tensors-52"><span class="linenos">52</span></a>    <span class="o">*</span><span class="n">mappable_tensors</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="stack_mappable_tensors-53"><a href="#stack_mappable_tensors-53"><span class="linenos">53</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="stack_mappable_tensors-54"><a href="#stack_mappable_tensors-54"><span class="linenos">54</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Stack mappable tensors along the channel dimension.</span>
</span><span id="stack_mappable_tensors-55"><a href="#stack_mappable_tensors-55"><span class="linenos">55</span></a>
</span><span id="stack_mappable_tensors-56"><a href="#stack_mappable_tensors-56"><span class="linenos">56</span></a><span class="sd">    Args:</span>
</span><span id="stack_mappable_tensors-57"><a href="#stack_mappable_tensors-57"><span class="linenos">57</span></a><span class="sd">        mappable_tensors: Mappable tensors to concatenate</span>
</span><span id="stack_mappable_tensors-58"><a href="#stack_mappable_tensors-58"><span class="linenos">58</span></a><span class="sd">        channel_index: Index of the channel dimension over which to stack</span>
</span><span id="stack_mappable_tensors-59"><a href="#stack_mappable_tensors-59"><span class="linenos">59</span></a><span class="sd">            starting from the first channel dimension over which to stack.</span>
</span><span id="stack_mappable_tensors-60"><a href="#stack_mappable_tensors-60"><span class="linenos">60</span></a>
</span><span id="stack_mappable_tensors-61"><a href="#stack_mappable_tensors-61"><span class="linenos">61</span></a><span class="sd">    Returns:</span>
</span><span id="stack_mappable_tensors-62"><a href="#stack_mappable_tensors-62"><span class="linenos">62</span></a><span class="sd">        Stacked masked tensor.</span>
</span><span id="stack_mappable_tensors-63"><a href="#stack_mappable_tensors-63"><span class="linenos">63</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="stack_mappable_tensors-64"><a href="#stack_mappable_tensors-64"><span class="linenos">64</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
</span><span id="stack_mappable_tensors-65"><a href="#stack_mappable_tensors-65"><span class="linenos">65</span></a>        <span class="n">mappable_tensor</span><span class="o">.</span><span class="n">n_channel_dims</span> <span class="o">==</span> <span class="n">mappable_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n_channel_dims</span>
</span><span id="stack_mappable_tensors-66"><a href="#stack_mappable_tensors-66"><span class="linenos">66</span></a>        <span class="k">for</span> <span class="n">mappable_tensor</span> <span class="ow">in</span> <span class="n">mappable_tensors</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="stack_mappable_tensors-67"><a href="#stack_mappable_tensors-67"><span class="linenos">67</span></a>    <span class="p">):</span>
</span><span id="stack_mappable_tensors-68"><a href="#stack_mappable_tensors-68"><span class="linenos">68</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lengths of channel shapes of masked tensors must be the same&quot;</span><span class="p">)</span>
</span><span id="stack_mappable_tensors-69"><a href="#stack_mappable_tensors-69"><span class="linenos">69</span></a>    <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mappable_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">)</span>
</span><span id="stack_mappable_tensors-70"><a href="#stack_mappable_tensors-70"><span class="linenos">70</span></a>    <span class="n">channel_dims</span> <span class="o">=</span> <span class="n">get_channel_dims</span><span class="p">(</span>
</span><span id="stack_mappable_tensors-71"><a href="#stack_mappable_tensors-71"><span class="linenos">71</span></a>        <span class="n">n_total_dims</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">mappable_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
</span><span id="stack_mappable_tensors-72"><a href="#stack_mappable_tensors-72"><span class="linenos">72</span></a>        <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="stack_mappable_tensors-73"><a href="#stack_mappable_tensors-73"><span class="linenos">73</span></a>    <span class="p">)</span>
</span><span id="stack_mappable_tensors-74"><a href="#stack_mappable_tensors-74"><span class="linenos">74</span></a>    <span class="n">stacking_dim</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel_dims</span> <span class="o">+</span> <span class="p">(</span><span class="n">channel_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,))[</span><span class="n">channel_index</span><span class="p">]</span>
</span><span id="stack_mappable_tensors-75"><a href="#stack_mappable_tensors-75"><span class="linenos">75</span></a>    <span class="n">values</span> <span class="o">=</span> <span class="n">stack</span><span class="p">(</span>
</span><span id="stack_mappable_tensors-76"><a href="#stack_mappable_tensors-76"><span class="linenos">76</span></a>        <span class="p">[</span><span class="n">mappable_tensor</span><span class="o">.</span><span class="n">generate_values</span><span class="p">()</span> <span class="k">for</span> <span class="n">mappable_tensor</span> <span class="ow">in</span> <span class="n">mappable_tensors</span><span class="p">],</span>
</span><span id="stack_mappable_tensors-77"><a href="#stack_mappable_tensors-77"><span class="linenos">77</span></a>        <span class="n">dim</span><span class="o">=</span><span class="n">stacking_dim</span><span class="p">,</span>
</span><span id="stack_mappable_tensors-78"><a href="#stack_mappable_tensors-78"><span class="linenos">78</span></a>    <span class="p">)</span>
</span><span id="stack_mappable_tensors-79"><a href="#stack_mappable_tensors-79"><span class="linenos">79</span></a>    <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="stack_mappable_tensors-80"><a href="#stack_mappable_tensors-80"><span class="linenos">80</span></a>    <span class="k">for</span> <span class="n">mappable_tensor</span> <span class="ow">in</span> <span class="n">mappable_tensors</span><span class="p">:</span>
</span><span id="stack_mappable_tensors-81"><a href="#stack_mappable_tensors-81"><span class="linenos">81</span></a>        <span class="n">update_mask</span> <span class="o">=</span> <span class="n">mappable_tensor</span><span class="o">.</span><span class="n">generate_mask</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="stack_mappable_tensors-82"><a href="#stack_mappable_tensors-82"><span class="linenos">82</span></a>        <span class="k">if</span> <span class="n">update_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="stack_mappable_tensors-83"><a href="#stack_mappable_tensors-83"><span class="linenos">83</span></a>            <span class="n">update_mask</span> <span class="o">=</span> <span class="n">update_mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">stacking_dim</span><span class="p">)</span>
</span><span id="stack_mappable_tensors-84"><a href="#stack_mappable_tensors-84"><span class="linenos">84</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">combine_optional_masks</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">update_mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="stack_mappable_tensors-85"><a href="#stack_mappable_tensors-85"><span class="linenos">85</span></a>    <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="stack_mappable_tensors-86"><a href="#stack_mappable_tensors-86"><span class="linenos">86</span></a>        <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
</span><span id="stack_mappable_tensors-87"><a href="#stack_mappable_tensors-87"><span class="linenos">87</span></a>        <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="stack_mappable_tensors-88"><a href="#stack_mappable_tensors-88"><span class="linenos">88</span></a>        <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="stack_mappable_tensors-89"><a href="#stack_mappable_tensors-89"><span class="linenos">89</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Stack mappable tensors along the channel dimension.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mappable_tensors:</strong>  Mappable tensors to concatenate</li>
<li><strong>channel_index:</strong>  Index of the channel dimension over which to stack
starting from the first channel dimension over which to stack.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Stacked masked tensor.</p>
</blockquote>
</div>


                </section>
                <section id="voxel_grid">
                            <input id="voxel_grid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">voxel_grid</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="voxel_grid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#voxel_grid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="voxel_grid-806"><a href="#voxel_grid-806"><span class="linenos">806</span></a><span class="k">def</span> <span class="nf">voxel_grid</span><span class="p">(</span>
</span><span id="voxel_grid-807"><a href="#voxel_grid-807"><span class="linenos">807</span></a>    <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="voxel_grid-808"><a href="#voxel_grid-808"><span class="linenos">808</span></a>    <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="voxel_grid-809"><a href="#voxel_grid-809"><span class="linenos">809</span></a>    <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="voxel_grid-810"><a href="#voxel_grid-810"><span class="linenos">810</span></a>    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="voxel_grid-811"><a href="#voxel_grid-811"><span class="linenos">811</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="voxel_grid-812"><a href="#voxel_grid-812"><span class="linenos">812</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a voxel grid with optional mask.</span>
</span><span id="voxel_grid-813"><a href="#voxel_grid-813"><span class="linenos">813</span></a>
</span><span id="voxel_grid-814"><a href="#voxel_grid-814"><span class="linenos">814</span></a><span class="sd">    The voxel grid is not generated explicitly right away, but only when the</span>
</span><span id="voxel_grid-815"><a href="#voxel_grid-815"><span class="linenos">815</span></a><span class="sd">    values are generated.</span>
</span><span id="voxel_grid-816"><a href="#voxel_grid-816"><span class="linenos">816</span></a>
</span><span id="voxel_grid-817"><a href="#voxel_grid-817"><span class="linenos">817</span></a><span class="sd">    See: `MappableTensor.voxel_grid`.</span>
</span><span id="voxel_grid-818"><a href="#voxel_grid-818"><span class="linenos">818</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="voxel_grid-819"><a href="#voxel_grid-819"><span class="linenos">819</span></a>    <span class="k">return</span> <span class="n">MappableTensor</span><span class="o">.</span><span class="n">voxel_grid</span><span class="p">(</span>
</span><span id="voxel_grid-820"><a href="#voxel_grid-820"><span class="linenos">820</span></a>        <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
</span><span id="voxel_grid-821"><a href="#voxel_grid-821"><span class="linenos">821</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a voxel grid with optional mask.</p>

<p>The voxel grid is not generated explicitly right away, but only when the
values are generated.</p>

<p>See: <code><a href="#MappableTensor.voxel_grid">MappableTensor.voxel_grid</a></code>.</p>
</div>


                </section>
                <section id="visualize_as_deformed_grid">
                            <input id="visualize_as_deformed_grid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_as_deformed_grid</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">mapping</span><span class="p">:</span> <span class="n"><a href="#GridComposableMapping">GridComposableMapping</a></span>,</span><span class="param">	<span class="n">arguments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#GridVisualizationArguments">GridVisualizationArguments</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="visualize_as_deformed_grid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#visualize_as_deformed_grid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="visualize_as_deformed_grid-279"><a href="#visualize_as_deformed_grid-279"><span class="linenos">279</span></a><span class="k">def</span> <span class="nf">visualize_as_deformed_grid</span><span class="p">(</span>
</span><span id="visualize_as_deformed_grid-280"><a href="#visualize_as_deformed_grid-280"><span class="linenos">280</span></a>    <span class="n">mapping</span><span class="p">:</span> <span class="n">GridComposableMapping</span><span class="p">,</span>
</span><span id="visualize_as_deformed_grid-281"><a href="#visualize_as_deformed_grid-281"><span class="linenos">281</span></a>    <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridVisualizationArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="visualize_as_deformed_grid-282"><a href="#visualize_as_deformed_grid-282"><span class="linenos">282</span></a><span class="p">):</span>
</span><span id="visualize_as_deformed_grid-283"><a href="#visualize_as_deformed_grid-283"><span class="linenos">283</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize a grid mapping as a grid&quot;&quot;&quot;</span>
</span><span id="visualize_as_deformed_grid-284"><a href="#visualize_as_deformed_grid-284"><span class="linenos">284</span></a>    <span class="k">return</span> <span class="n">visualize_to_as_deformed_grid</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">mapping</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="n">arguments</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Visualize a grid mapping as a grid</p>
</div>


                </section>
                <section id="visualize_as_image">
                            <input id="visualize_as_image-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_as_image</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">mapping</span><span class="p">:</span> <span class="n"><a href="#GridComposableMapping">GridComposableMapping</a></span>,</span><span class="param">	<span class="n">arguments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#ImageVisualizationArguments">ImageVisualizationArguments</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="visualize_as_image-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#visualize_as_image"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="visualize_as_image-254"><a href="#visualize_as_image-254"><span class="linenos">254</span></a><span class="k">def</span> <span class="nf">visualize_as_image</span><span class="p">(</span>
</span><span id="visualize_as_image-255"><a href="#visualize_as_image-255"><span class="linenos">255</span></a>    <span class="n">mapping</span><span class="p">:</span> <span class="n">GridComposableMapping</span><span class="p">,</span>
</span><span id="visualize_as_image-256"><a href="#visualize_as_image-256"><span class="linenos">256</span></a>    <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ImageVisualizationArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="visualize_as_image-257"><a href="#visualize_as_image-257"><span class="linenos">257</span></a><span class="p">):</span>
</span><span id="visualize_as_image-258"><a href="#visualize_as_image-258"><span class="linenos">258</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize a grid mapping as an image&quot;&quot;&quot;</span>
</span><span id="visualize_as_image-259"><a href="#visualize_as_image-259"><span class="linenos">259</span></a>    <span class="k">return</span> <span class="n">visualize_image</span><span class="p">(</span>
</span><span id="visualize_as_image-260"><a href="#visualize_as_image-260"><span class="linenos">260</span></a>        <span class="n">mapping</span><span class="o">.</span><span class="n">sample</span><span class="p">(),</span>
</span><span id="visualize_as_image-261"><a href="#visualize_as_image-261"><span class="linenos">261</span></a>        <span class="n">voxel_size</span><span class="o">=</span><span class="n">mapping</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">grid_spacing_cpu</span><span class="p">(),</span>
</span><span id="visualize_as_image-262"><a href="#visualize_as_image-262"><span class="linenos">262</span></a>        <span class="n">arguments</span><span class="o">=</span><span class="n">arguments</span><span class="p">,</span>
</span><span id="visualize_as_image-263"><a href="#visualize_as_image-263"><span class="linenos">263</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Visualize a grid mapping as an image</p>
</div>


                </section>
                <section id="visualize_grid">
                            <input id="visualize_grid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_grid</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">coordinates</span><span class="p">:</span> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>,</span><span class="param">	<span class="n">arguments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#GridVisualizationArguments">GridVisualizationArguments</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span>:</span></span>

                <label class="view-source-button" for="visualize_grid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#visualize_grid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="visualize_grid-101"><a href="#visualize_grid-101"><span class="linenos">101</span></a><span class="k">def</span> <span class="nf">visualize_grid</span><span class="p">(</span>
</span><span id="visualize_grid-102"><a href="#visualize_grid-102"><span class="linenos">102</span></a>    <span class="n">coordinates</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span>
</span><span id="visualize_grid-103"><a href="#visualize_grid-103"><span class="linenos">103</span></a>    <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridVisualizationArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="visualize_grid-104"><a href="#visualize_grid-104"><span class="linenos">104</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Figure</span><span class="p">:</span>
</span><span id="visualize_grid-105"><a href="#visualize_grid-105"><span class="linenos">105</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize coordinates as a grid&quot;&quot;&quot;</span>
</span><span id="visualize_grid-106"><a href="#visualize_grid-106"><span class="linenos">106</span></a>    <span class="k">if</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">n_channel_dims</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="visualize_grid-107"><a href="#visualize_grid-107"><span class="linenos">107</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only single-channel coordinates are supported&quot;</span><span class="p">)</span>
</span><span id="visualize_grid-108"><a href="#visualize_grid-108"><span class="linenos">108</span></a>    <span class="k">if</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">):</span>
</span><span id="visualize_grid-109"><a href="#visualize_grid-109"><span class="linenos">109</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of channels must match number of spatial dimensions&quot;</span><span class="p">)</span>
</span><span id="visualize_grid-110"><a href="#visualize_grid-110"><span class="linenos">110</span></a>    <span class="k">if</span> <span class="n">arguments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="visualize_grid-111"><a href="#visualize_grid-111"><span class="linenos">111</span></a>        <span class="n">arguments</span> <span class="o">=</span> <span class="n">GridVisualizationArguments</span><span class="p">()</span>
</span><span id="visualize_grid-112"><a href="#visualize_grid-112"><span class="linenos">112</span></a>    <span class="n">n_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="visualize_grid-113"><a href="#visualize_grid-113"><span class="linenos">113</span></a>    <span class="n">planes</span><span class="p">,</span> <span class="n">_mask_planes</span><span class="p">,</span> <span class="n">dimension_pairs</span> <span class="o">=</span> <span class="n">obtain_central_planes</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
</span><span id="visualize_grid-114"><a href="#visualize_grid-114"><span class="linenos">114</span></a>    <span class="k">if</span> <span class="n">arguments</span><span class="o">.</span><span class="n">plot_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="visualize_grid-115"><a href="#visualize_grid-115"><span class="linenos">115</span></a>        <span class="n">arguments</span><span class="o">.</span><span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="visualize_grid-116"><a href="#visualize_grid-116"><span class="linenos">116</span></a>
</span><span id="visualize_grid-117"><a href="#visualize_grid-117"><span class="linenos">117</span></a>    <span class="k">def</span> <span class="nf">get_kwargs</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="visualize_grid-118"><a href="#visualize_grid-118"><span class="linenos">118</span></a>        <span class="k">if</span> <span class="n">arguments</span><span class="o">.</span><span class="n">emphasize_every_nth_line</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="visualize_grid-119"><a href="#visualize_grid-119"><span class="linenos">119</span></a>            <span class="k">return</span> <span class="n">arguments</span><span class="o">.</span><span class="n">plot_kwargs</span>
</span><span id="visualize_grid-120"><a href="#visualize_grid-120"><span class="linenos">120</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="n">arguments</span><span class="o">.</span><span class="n">emphasize_every_nth_line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">%</span> <span class="n">arguments</span><span class="o">.</span><span class="n">emphasize_every_nth_line</span><span class="p">[</span>
</span><span id="visualize_grid-121"><a href="#visualize_grid-121"><span class="linenos">121</span></a>            <span class="mi">0</span>
</span><span id="visualize_grid-122"><a href="#visualize_grid-122"><span class="linenos">122</span></a>        <span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="visualize_grid-123"><a href="#visualize_grid-123"><span class="linenos">123</span></a>            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">}</span>
</span><span id="visualize_grid-124"><a href="#visualize_grid-124"><span class="linenos">124</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="visualize_grid-125"><a href="#visualize_grid-125"><span class="linenos">125</span></a>            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>
</span><span id="visualize_grid-126"><a href="#visualize_grid-126"><span class="linenos">126</span></a>        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">arguments</span><span class="o">.</span><span class="n">plot_kwargs</span><span class="p">)</span>
</span><span id="visualize_grid-127"><a href="#visualize_grid-127"><span class="linenos">127</span></a>        <span class="k">return</span> <span class="n">kwargs</span>
</span><span id="visualize_grid-128"><a href="#visualize_grid-128"><span class="linenos">128</span></a>
</span><span id="visualize_grid-129"><a href="#visualize_grid-129"><span class="linenos">129</span></a>    <span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span>
</span><span id="visualize_grid-130"><a href="#visualize_grid-130"><span class="linenos">130</span></a>        <span class="mi">1</span><span class="p">,</span>
</span><span id="visualize_grid-131"><a href="#visualize_grid-131"><span class="linenos">131</span></a>        <span class="nb">len</span><span class="p">(</span><span class="n">planes</span><span class="p">),</span>
</span><span id="visualize_grid-132"><a href="#visualize_grid-132"><span class="linenos">132</span></a>        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">arguments</span><span class="o">.</span><span class="n">figure_height</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">planes</span><span class="p">),</span> <span class="n">arguments</span><span class="o">.</span><span class="n">figure_height</span><span class="p">),</span>
</span><span id="visualize_grid-133"><a href="#visualize_grid-133"><span class="linenos">133</span></a>        <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="visualize_grid-134"><a href="#visualize_grid-134"><span class="linenos">134</span></a>    <span class="p">)</span>
</span><span id="visualize_grid-135"><a href="#visualize_grid-135"><span class="linenos">135</span></a>
</span><span id="visualize_grid-136"><a href="#visualize_grid-136"><span class="linenos">136</span></a>    <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="p">(</span><span class="n">dim_1</span><span class="p">,</span> <span class="n">dim_2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">planes</span><span class="p">,</span> <span class="n">dimension_pairs</span><span class="p">):</span>
</span><span id="visualize_grid-137"><a href="#visualize_grid-137"><span class="linenos">137</span></a>        <span class="n">plane</span> <span class="o">=</span> <span class="n">plane</span><span class="p">[</span><span class="n">arguments</span><span class="o">.</span><span class="n">batch_index</span><span class="p">,</span> <span class="p">[</span><span class="n">dim_1</span><span class="p">,</span> <span class="n">dim_2</span><span class="p">]]</span>
</span><span id="visualize_grid-138"><a href="#visualize_grid-138"><span class="linenos">138</span></a>        <span class="n">axis</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
</span><span id="visualize_grid-139"><a href="#visualize_grid-139"><span class="linenos">139</span></a>        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">dimension_to_letter</span><span class="p">(</span><span class="n">dim_1</span><span class="p">,</span> <span class="n">n_dims</span><span class="p">))</span>
</span><span id="visualize_grid-140"><a href="#visualize_grid-140"><span class="linenos">140</span></a>        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">dimension_to_letter</span><span class="p">(</span><span class="n">dim_2</span><span class="p">,</span> <span class="n">n_dims</span><span class="p">))</span>
</span><span id="visualize_grid-141"><a href="#visualize_grid-141"><span class="linenos">141</span></a>        <span class="k">for</span> <span class="n">row_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">plane</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="visualize_grid-142"><a href="#visualize_grid-142"><span class="linenos">142</span></a>            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="visualize_grid-143"><a href="#visualize_grid-143"><span class="linenos">143</span></a>                <span class="n">plane</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">row_index</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="visualize_grid-144"><a href="#visualize_grid-144"><span class="linenos">144</span></a>                <span class="n">plane</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">row_index</span><span class="p">,</span> <span class="p">:],</span>
</span><span id="visualize_grid-145"><a href="#visualize_grid-145"><span class="linenos">145</span></a>                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
</span><span id="visualize_grid-146"><a href="#visualize_grid-146"><span class="linenos">146</span></a>                <span class="o">**</span><span class="n">get_kwargs</span><span class="p">(</span><span class="n">row_index</span><span class="p">),</span>
</span><span id="visualize_grid-147"><a href="#visualize_grid-147"><span class="linenos">147</span></a>            <span class="p">)</span>
</span><span id="visualize_grid-148"><a href="#visualize_grid-148"><span class="linenos">148</span></a>        <span class="k">for</span> <span class="n">col_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">plane</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
</span><span id="visualize_grid-149"><a href="#visualize_grid-149"><span class="linenos">149</span></a>            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
</span><span id="visualize_grid-150"><a href="#visualize_grid-150"><span class="linenos">150</span></a>                <span class="n">plane</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="n">col_index</span><span class="p">],</span>
</span><span id="visualize_grid-151"><a href="#visualize_grid-151"><span class="linenos">151</span></a>                <span class="n">plane</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="n">col_index</span><span class="p">],</span>
</span><span id="visualize_grid-152"><a href="#visualize_grid-152"><span class="linenos">152</span></a>                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
</span><span id="visualize_grid-153"><a href="#visualize_grid-153"><span class="linenos">153</span></a>                <span class="o">**</span><span class="n">get_kwargs</span><span class="p">(</span><span class="n">col_index</span><span class="p">),</span>
</span><span id="visualize_grid-154"><a href="#visualize_grid-154"><span class="linenos">154</span></a>            <span class="p">)</span>
</span><span id="visualize_grid-155"><a href="#visualize_grid-155"><span class="linenos">155</span></a>
</span><span id="visualize_grid-156"><a href="#visualize_grid-156"><span class="linenos">156</span></a>    <span class="k">return</span> <span class="n">figure</span>
</span></pre></div>


            <div class="docstring"><p>Visualize coordinates as a grid</p>
</div>


                </section>
                <section id="visualize_image">
                            <input id="visualize_image-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_image</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">volume</span><span class="p">:</span> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>,</span><span class="param">	<span class="n">voxel_size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">arguments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#ImageVisualizationArguments">ImageVisualizationArguments</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span>:</span></span>

                <label class="view-source-button" for="visualize_image-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#visualize_image"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="visualize_image-179"><a href="#visualize_image-179"><span class="linenos">179</span></a><span class="k">def</span> <span class="nf">visualize_image</span><span class="p">(</span>
</span><span id="visualize_image-180"><a href="#visualize_image-180"><span class="linenos">180</span></a>    <span class="n">volume</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span>
</span><span id="visualize_image-181"><a href="#visualize_image-181"><span class="linenos">181</span></a>    <span class="n">voxel_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Number</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="visualize_image-182"><a href="#visualize_image-182"><span class="linenos">182</span></a>    <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ImageVisualizationArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="visualize_image-183"><a href="#visualize_image-183"><span class="linenos">183</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Figure</span><span class="p">:</span>
</span><span id="visualize_image-184"><a href="#visualize_image-184"><span class="linenos">184</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize coordinates as an image&quot;&quot;&quot;</span>
</span><span id="visualize_image-185"><a href="#visualize_image-185"><span class="linenos">185</span></a>    <span class="k">if</span> <span class="n">volume</span><span class="o">.</span><span class="n">n_channel_dims</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="visualize_image-186"><a href="#visualize_image-186"><span class="linenos">186</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only single-channel volumes are supported&quot;</span><span class="p">)</span>
</span><span id="visualize_image-187"><a href="#visualize_image-187"><span class="linenos">187</span></a>    <span class="k">if</span> <span class="n">arguments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="visualize_image-188"><a href="#visualize_image-188"><span class="linenos">188</span></a>        <span class="n">arguments</span> <span class="o">=</span> <span class="n">ImageVisualizationArguments</span><span class="p">()</span>
</span><span id="visualize_image-189"><a href="#visualize_image-189"><span class="linenos">189</span></a>    <span class="k">if</span> <span class="n">voxel_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="visualize_image-190"><a href="#visualize_image-190"><span class="linenos">190</span></a>        <span class="n">voxel_size</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">torch_device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">))</span>
</span><span id="visualize_image-191"><a href="#visualize_image-191"><span class="linenos">191</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">voxel_size</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="visualize_image-192"><a href="#visualize_image-192"><span class="linenos">192</span></a>        <span class="n">voxel_size</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="n">voxel_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch_device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">))</span>
</span><span id="visualize_image-193"><a href="#visualize_image-193"><span class="linenos">193</span></a>    <span class="n">voxel_size</span> <span class="o">=</span> <span class="n">voxel_size</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">batch_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">))</span>
</span><span id="visualize_image-194"><a href="#visualize_image-194"><span class="linenos">194</span></a>    <span class="k">if</span> <span class="n">volume</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="visualize_image-195"><a href="#visualize_image-195"><span class="linenos">195</span></a>        <span class="n">cmap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span>
</span><span id="visualize_image-196"><a href="#visualize_image-196"><span class="linenos">196</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="visualize_image-197"><a href="#visualize_image-197"><span class="linenos">197</span></a>        <span class="n">cmap</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="visualize_image-198"><a href="#visualize_image-198"><span class="linenos">198</span></a>    <span class="n">n_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="visualize_image-199"><a href="#visualize_image-199"><span class="linenos">199</span></a>    <span class="n">planes</span><span class="p">,</span> <span class="n">mask_planes</span><span class="p">,</span> <span class="n">dimension_pairs</span> <span class="o">=</span> <span class="n">obtain_central_planes</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
</span><span id="visualize_image-200"><a href="#visualize_image-200"><span class="linenos">200</span></a>    <span class="n">vmin</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="visualize_image-201"><a href="#visualize_image-201"><span class="linenos">201</span></a>        <span class="nb">min</span><span class="p">(</span><span class="n">amin</span><span class="p">(</span><span class="n">plane</span><span class="p">[</span><span class="n">arguments</span><span class="o">.</span><span class="n">batch_index</span><span class="p">])</span> <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">planes</span><span class="p">)</span>
</span><span id="visualize_image-202"><a href="#visualize_image-202"><span class="linenos">202</span></a>        <span class="k">if</span> <span class="n">arguments</span><span class="o">.</span><span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="visualize_image-203"><a href="#visualize_image-203"><span class="linenos">203</span></a>        <span class="k">else</span> <span class="n">arguments</span><span class="o">.</span><span class="n">vmin</span>
</span><span id="visualize_image-204"><a href="#visualize_image-204"><span class="linenos">204</span></a>    <span class="p">)</span>
</span><span id="visualize_image-205"><a href="#visualize_image-205"><span class="linenos">205</span></a>    <span class="n">vmax</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="visualize_image-206"><a href="#visualize_image-206"><span class="linenos">206</span></a>        <span class="nb">max</span><span class="p">(</span><span class="n">amax</span><span class="p">(</span><span class="n">plane</span><span class="p">[</span><span class="n">arguments</span><span class="o">.</span><span class="n">batch_index</span><span class="p">])</span> <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="n">planes</span><span class="p">)</span>
</span><span id="visualize_image-207"><a href="#visualize_image-207"><span class="linenos">207</span></a>        <span class="k">if</span> <span class="n">arguments</span><span class="o">.</span><span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="visualize_image-208"><a href="#visualize_image-208"><span class="linenos">208</span></a>        <span class="k">else</span> <span class="n">arguments</span><span class="o">.</span><span class="n">vmax</span>
</span><span id="visualize_image-209"><a href="#visualize_image-209"><span class="linenos">209</span></a>    <span class="p">)</span>
</span><span id="visualize_image-210"><a href="#visualize_image-210"><span class="linenos">210</span></a>    <span class="n">normalizer</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
</span><span id="visualize_image-211"><a href="#visualize_image-211"><span class="linenos">211</span></a>    <span class="n">figure</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">subplots</span><span class="p">(</span>
</span><span id="visualize_image-212"><a href="#visualize_image-212"><span class="linenos">212</span></a>        <span class="mi">1</span><span class="p">,</span>
</span><span id="visualize_image-213"><a href="#visualize_image-213"><span class="linenos">213</span></a>        <span class="nb">len</span><span class="p">(</span><span class="n">planes</span><span class="p">),</span>
</span><span id="visualize_image-214"><a href="#visualize_image-214"><span class="linenos">214</span></a>        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">arguments</span><span class="o">.</span><span class="n">figure_height</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">planes</span><span class="p">),</span> <span class="n">arguments</span><span class="o">.</span><span class="n">figure_height</span><span class="p">),</span>
</span><span id="visualize_image-215"><a href="#visualize_image-215"><span class="linenos">215</span></a>        <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="visualize_image-216"><a href="#visualize_image-216"><span class="linenos">216</span></a>    <span class="p">)</span>
</span><span id="visualize_image-217"><a href="#visualize_image-217"><span class="linenos">217</span></a>    <span class="k">if</span> <span class="n">arguments</span><span class="o">.</span><span class="n">mask_color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="visualize_image-218"><a href="#visualize_image-218"><span class="linenos">218</span></a>        <span class="n">mask_color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="visualize_image-219"><a href="#visualize_image-219"><span class="linenos">219</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="visualize_image-220"><a href="#visualize_image-220"><span class="linenos">220</span></a>        <span class="n">mask_color</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">arguments</span><span class="o">.</span><span class="n">mask_color</span><span class="p">))</span>
</span><span id="visualize_image-221"><a href="#visualize_image-221"><span class="linenos">221</span></a>    <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">mask_plane</span><span class="p">,</span> <span class="p">(</span><span class="n">dim_1</span><span class="p">,</span> <span class="n">dim_2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
</span><span id="visualize_image-222"><a href="#visualize_image-222"><span class="linenos">222</span></a>        <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">planes</span><span class="p">,</span> <span class="n">mask_planes</span><span class="p">,</span> <span class="n">dimension_pairs</span>
</span><span id="visualize_image-223"><a href="#visualize_image-223"><span class="linenos">223</span></a>    <span class="p">):</span>
</span><span id="visualize_image-224"><a href="#visualize_image-224"><span class="linenos">224</span></a>        <span class="n">plane</span> <span class="o">=</span> <span class="n">normalizer</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
</span><span id="visualize_image-225"><a href="#visualize_image-225"><span class="linenos">225</span></a>        <span class="n">aspect</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="visualize_image-226"><a href="#visualize_image-226"><span class="linenos">226</span></a>            <span class="n">voxel_size</span><span class="p">[</span><span class="n">arguments</span><span class="o">.</span><span class="n">batch_index</span><span class="p">,</span> <span class="n">dim_1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="visualize_image-227"><a href="#visualize_image-227"><span class="linenos">227</span></a>            <span class="o">/</span> <span class="n">voxel_size</span><span class="p">[</span><span class="n">arguments</span><span class="o">.</span><span class="n">batch_index</span><span class="p">,</span> <span class="n">dim_2</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</span><span id="visualize_image-228"><a href="#visualize_image-228"><span class="linenos">228</span></a>        <span class="p">)</span>
</span><span id="visualize_image-229"><a href="#visualize_image-229"><span class="linenos">229</span></a>        <span class="n">plane</span> <span class="o">=</span> <span class="n">moveaxis</span><span class="p">(</span><span class="n">plane</span><span class="p">[</span><span class="n">arguments</span><span class="o">.</span><span class="n">batch_index</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="visualize_image-230"><a href="#visualize_image-230"><span class="linenos">230</span></a>        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">dimension_to_letter</span><span class="p">(</span><span class="n">dim_1</span><span class="p">,</span> <span class="n">n_dims</span><span class="p">))</span>
</span><span id="visualize_image-231"><a href="#visualize_image-231"><span class="linenos">231</span></a>        <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">dimension_to_letter</span><span class="p">(</span><span class="n">dim_2</span><span class="p">,</span> <span class="n">n_dims</span><span class="p">))</span>
</span><span id="visualize_image-232"><a href="#visualize_image-232"><span class="linenos">232</span></a>
</span><span id="visualize_image-233"><a href="#visualize_image-233"><span class="linenos">233</span></a>        <span class="n">axis</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="visualize_image-234"><a href="#visualize_image-234"><span class="linenos">234</span></a>            <span class="n">plane</span><span class="p">,</span>
</span><span id="visualize_image-235"><a href="#visualize_image-235"><span class="linenos">235</span></a>            <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
</span><span id="visualize_image-236"><a href="#visualize_image-236"><span class="linenos">236</span></a>            <span class="n">aspect</span><span class="o">=</span><span class="n">aspect</span><span class="p">,</span>
</span><span id="visualize_image-237"><a href="#visualize_image-237"><span class="linenos">237</span></a>            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
</span><span id="visualize_image-238"><a href="#visualize_image-238"><span class="linenos">238</span></a>            <span class="o">**</span><span class="n">arguments</span><span class="o">.</span><span class="n">imshow_kwargs</span><span class="p">,</span>
</span><span id="visualize_image-239"><a href="#visualize_image-239"><span class="linenos">239</span></a>        <span class="p">)</span>
</span><span id="visualize_image-240"><a href="#visualize_image-240"><span class="linenos">240</span></a>        <span class="k">if</span> <span class="n">mask_color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="visualize_image-241"><a href="#visualize_image-241"><span class="linenos">241</span></a>            <span class="n">mask_plane</span> <span class="o">=</span> <span class="n">moveaxis</span><span class="p">(</span><span class="n">mask_plane</span><span class="p">[</span><span class="n">arguments</span><span class="o">.</span><span class="n">batch_index</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="visualize_image-242"><a href="#visualize_image-242"><span class="linenos">242</span></a>            <span class="n">mask_color</span> <span class="o">=</span> <span class="n">mask_color</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="visualize_image-243"><a href="#visualize_image-243"><span class="linenos">243</span></a>            <span class="n">coloured_mask_plane</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mask_plane</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask_color</span>
</span><span id="visualize_image-244"><a href="#visualize_image-244"><span class="linenos">244</span></a>            <span class="n">axis</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
</span><span id="visualize_image-245"><a href="#visualize_image-245"><span class="linenos">245</span></a>                <span class="n">coloured_mask_plane</span><span class="p">,</span>
</span><span id="visualize_image-246"><a href="#visualize_image-246"><span class="linenos">246</span></a>                <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
</span><span id="visualize_image-247"><a href="#visualize_image-247"><span class="linenos">247</span></a>                <span class="n">aspect</span><span class="o">=</span><span class="n">aspect</span><span class="p">,</span>
</span><span id="visualize_image-248"><a href="#visualize_image-248"><span class="linenos">248</span></a>                <span class="o">**</span><span class="n">arguments</span><span class="o">.</span><span class="n">imshow_kwargs</span><span class="p">,</span>
</span><span id="visualize_image-249"><a href="#visualize_image-249"><span class="linenos">249</span></a>            <span class="p">)</span>
</span><span id="visualize_image-250"><a href="#visualize_image-250"><span class="linenos">250</span></a>
</span><span id="visualize_image-251"><a href="#visualize_image-251"><span class="linenos">251</span></a>    <span class="k">return</span> <span class="n">figure</span>
</span></pre></div>


            <div class="docstring"><p>Visualize coordinates as an image</p>
</div>


                </section>
                <section id="visualize_to_as_deformed_grid">
                            <input id="visualize_to_as_deformed_grid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_to_as_deformed_grid</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">mapping</span><span class="p">:</span> <span class="n"><a href="#ComposableMapping">ComposableMapping</a></span>,</span><span class="param">	<span class="n">target</span><span class="p">:</span> <span class="n">composable_mapping</span><span class="o">.</span><span class="n">composable_mapping</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">ICoordinateSystemContainer</span>,</span><span class="param">	<span class="n">arguments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#GridVisualizationArguments">GridVisualizationArguments</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="visualize_to_as_deformed_grid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#visualize_to_as_deformed_grid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="visualize_to_as_deformed_grid-287"><a href="#visualize_to_as_deformed_grid-287"><span class="linenos">287</span></a><span class="k">def</span> <span class="nf">visualize_to_as_deformed_grid</span><span class="p">(</span>
</span><span id="visualize_to_as_deformed_grid-288"><a href="#visualize_to_as_deformed_grid-288"><span class="linenos">288</span></a>    <span class="n">mapping</span><span class="p">:</span> <span class="n">ComposableMapping</span><span class="p">,</span>
</span><span id="visualize_to_as_deformed_grid-289"><a href="#visualize_to_as_deformed_grid-289"><span class="linenos">289</span></a>    <span class="n">target</span><span class="p">:</span> <span class="n">ICoordinateSystemContainer</span><span class="p">,</span>
</span><span id="visualize_to_as_deformed_grid-290"><a href="#visualize_to_as_deformed_grid-290"><span class="linenos">290</span></a>    <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridVisualizationArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="visualize_to_as_deformed_grid-291"><a href="#visualize_to_as_deformed_grid-291"><span class="linenos">291</span></a><span class="p">):</span>
</span><span id="visualize_to_as_deformed_grid-292"><a href="#visualize_to_as_deformed_grid-292"><span class="linenos">292</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize a mapping to a target coordinate system as a grid&quot;&quot;&quot;</span>
</span><span id="visualize_to_as_deformed_grid-293"><a href="#visualize_to_as_deformed_grid-293"><span class="linenos">293</span></a>    <span class="k">return</span> <span class="n">visualize_grid</span><span class="p">(</span>
</span><span id="visualize_to_as_deformed_grid-294"><a href="#visualize_to_as_deformed_grid-294"><span class="linenos">294</span></a>        <span class="n">mapping</span><span class="o">.</span><span class="n">sample_to</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="n">DataFormat</span><span class="o">.</span><span class="n">world_coordinates</span><span class="p">()),</span> <span class="n">arguments</span><span class="o">=</span><span class="n">arguments</span>
</span><span id="visualize_to_as_deformed_grid-295"><a href="#visualize_to_as_deformed_grid-295"><span class="linenos">295</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Visualize a mapping to a target coordinate system as a grid</p>
</div>


                </section>
                <section id="visualize_to_as_image">
                            <input id="visualize_to_as_image-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">visualize_to_as_image</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">mapping</span><span class="p">:</span> <span class="n"><a href="#ComposableMapping">ComposableMapping</a></span>,</span><span class="param">	<span class="n">target</span><span class="p">:</span> <span class="n">composable_mapping</span><span class="o">.</span><span class="n">composable_mapping</span><span class="o">.</span><span class="n">interface</span><span class="o">.</span><span class="n">ICoordinateSystemContainer</span>,</span><span class="param">	<span class="n">arguments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="#ImageVisualizationArguments">ImageVisualizationArguments</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="visualize_to_as_image-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#visualize_to_as_image"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="visualize_to_as_image-266"><a href="#visualize_to_as_image-266"><span class="linenos">266</span></a><span class="k">def</span> <span class="nf">visualize_to_as_image</span><span class="p">(</span>
</span><span id="visualize_to_as_image-267"><a href="#visualize_to_as_image-267"><span class="linenos">267</span></a>    <span class="n">mapping</span><span class="p">:</span> <span class="n">ComposableMapping</span><span class="p">,</span>
</span><span id="visualize_to_as_image-268"><a href="#visualize_to_as_image-268"><span class="linenos">268</span></a>    <span class="n">target</span><span class="p">:</span> <span class="n">ICoordinateSystemContainer</span><span class="p">,</span>
</span><span id="visualize_to_as_image-269"><a href="#visualize_to_as_image-269"><span class="linenos">269</span></a>    <span class="n">arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ImageVisualizationArguments</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="visualize_to_as_image-270"><a href="#visualize_to_as_image-270"><span class="linenos">270</span></a><span class="p">):</span>
</span><span id="visualize_to_as_image-271"><a href="#visualize_to_as_image-271"><span class="linenos">271</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Visualize a mapping to a target coordinate system as an image&quot;&quot;&quot;</span>
</span><span id="visualize_to_as_image-272"><a href="#visualize_to_as_image-272"><span class="linenos">272</span></a>    <span class="k">return</span> <span class="n">visualize_image</span><span class="p">(</span>
</span><span id="visualize_to_as_image-273"><a href="#visualize_to_as_image-273"><span class="linenos">273</span></a>        <span class="n">mapping</span><span class="o">.</span><span class="n">sample_to</span><span class="p">(</span><span class="n">target</span><span class="p">),</span>
</span><span id="visualize_to_as_image-274"><a href="#visualize_to_as_image-274"><span class="linenos">274</span></a>        <span class="n">voxel_size</span><span class="o">=</span><span class="n">target</span><span class="o">.</span><span class="n">coordinate_system</span><span class="o">.</span><span class="n">grid_spacing_cpu</span><span class="p">(),</span>
</span><span id="visualize_to_as_image-275"><a href="#visualize_to_as_image-275"><span class="linenos">275</span></a>        <span class="n">arguments</span><span class="o">=</span><span class="n">arguments</span><span class="p">,</span>
</span><span id="visualize_to_as_image-276"><a href="#visualize_to_as_image-276"><span class="linenos">276</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Visualize a mapping to a target coordinate system as an image</p>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>