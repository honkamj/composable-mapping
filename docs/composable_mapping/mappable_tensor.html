<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.7.0"/>
    <title>composable_mapping.mappable_tensor API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../composable_mapping.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;composable_mapping</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#MappableTensor">MappableTensor</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MappableTensor.__init__">MappableTensor</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.from_tensor">from_tensor</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.voxel_grid">voxel_grid</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.shape">shape</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.spatial_shape">spatial_shape</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.channels_shape">channels_shape</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.batch_shape">batch_shape</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.mask_shape">mask_shape</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.n_channel_dims">n_channel_dims</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.generate">generate</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.generate_values">generate_values</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.generate_mask">generate_mask</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.displacements">displacements</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.affine_transformation">affine_transformation</a>
                        </li>
                        <li>
                                <a class="variable" href="#MappableTensor.grid">grid</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.transform">transform</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.has_mask">has_mask</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.clear_mask">clear_mask</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.reduce">reduce</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.modify_values">modify_values</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.mask_and">mask_and</a>
                        </li>
                        <li>
                                <a class="function" href="#MappableTensor.modify_mask">modify_mask</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#concatenate_mappable_tensors">concatenate_mappable_tensors</a>
            </li>
            <li>
                    <a class="function" href="#mappable">mappable</a>
            </li>
            <li>
                    <a class="function" href="#stack_mappable_tensors">stack_mappable_tensors</a>
            </li>
            <li>
                    <a class="function" href="#voxel_grid">voxel_grid</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../composable_mapping.html">composable_mapping</a><wbr>.mappable_tensor    </h1>

                        <div class="docstring"><p>Tensor wrapper on which composable mappings can be applied.</p>
</div>

                        <input id="mod-mappable_tensor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-mappable_tensor-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos"> 1</span></a><span class="sd">&quot;&quot;&quot;Tensor wrapper on which composable mappings can be applied.&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos"> 2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos"> 3</span></a><span class="kn">from</span> <span class="nn">.mappable_tensor</span> <span class="kn">import</span> <span class="n">MappableTensor</span><span class="p">,</span> <span class="n">mappable</span><span class="p">,</span> <span class="n">voxel_grid</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos"> 4</span></a><span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">concatenate_mappable_tensors</span><span class="p">,</span> <span class="n">stack_mappable_tensors</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos"> 5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos"> 6</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos"> 7</span></a>    <span class="s2">&quot;MappableTensor&quot;</span><span class="p">,</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos"> 8</span></a>    <span class="s2">&quot;concatenate_mappable_tensors&quot;</span><span class="p">,</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos"> 9</span></a>    <span class="s2">&quot;mappable&quot;</span><span class="p">,</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">10</span></a>    <span class="s2">&quot;stack_mappable_tensors&quot;</span><span class="p">,</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">11</span></a>    <span class="s2">&quot;voxel_grid&quot;</span><span class="p">,</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">12</span></a><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="MappableTensor">
                            <input id="MappableTensor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MappableTensor</span><wbr>(<span class="base">composable_mapping.tensor_like.BaseTensorLikeWrapper</span>):

                <label class="view-source-button" for="MappableTensor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor-38"><a href="#MappableTensor-38"><span class="linenos"> 38</span></a><span class="k">class</span> <span class="nc">MappableTensor</span><span class="p">(</span><span class="n">BaseTensorLikeWrapper</span><span class="p">):</span>
</span><span id="MappableTensor-39"><a href="#MappableTensor-39"><span class="linenos"> 39</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A tensor wrapper used as inputs for composable mappings</span>
</span><span id="MappableTensor-40"><a href="#MappableTensor-40"><span class="linenos"> 40</span></a>
</span><span id="MappableTensor-41"><a href="#MappableTensor-41"><span class="linenos"> 41</span></a><span class="sd">    It is not recommended to create instances of this class directly, but to</span>
</span><span id="MappableTensor-42"><a href="#MappableTensor-42"><span class="linenos"> 42</span></a><span class="sd">    use instead the constructors provided in the module, or as class methods</span>
</span><span id="MappableTensor-43"><a href="#MappableTensor-43"><span class="linenos"> 43</span></a><span class="sd">    of this class: `mappable`, `voxel_grid`, `MappableTensor.from_tensor`,</span>
</span><span id="MappableTensor-44"><a href="#MappableTensor-44"><span class="linenos"> 44</span></a><span class="sd">    `MappableTensor.voxel_grid`.</span>
</span><span id="MappableTensor-45"><a href="#MappableTensor-45"><span class="linenos"> 45</span></a>
</span><span id="MappableTensor-46"><a href="#MappableTensor-46"><span class="linenos"> 46</span></a><span class="sd">    The core idea of the mappable tensor is that affine transformations applied</span>
</span><span id="MappableTensor-47"><a href="#MappableTensor-47"><span class="linenos"> 47</span></a><span class="sd">    to the tensor are not applied right away, but only when the values are</span>
</span><span id="MappableTensor-48"><a href="#MappableTensor-48"><span class="linenos"> 48</span></a><span class="sd">    generated. This allows for more efficient computation. Additionally,</span>
</span><span id="MappableTensor-49"><a href="#MappableTensor-49"><span class="linenos"> 49</span></a><span class="sd">    representing voxel coordinate grids and their transformations without</span>
</span><span id="MappableTensor-50"><a href="#MappableTensor-50"><span class="linenos"> 50</span></a><span class="sd">    generating the grid is possible. Such grids can be also combined with</span>
</span><span id="MappableTensor-51"><a href="#MappableTensor-51"><span class="linenos"> 51</span></a><span class="sd">    displacement vectors, still without generating the grid.</span>
</span><span id="MappableTensor-52"><a href="#MappableTensor-52"><span class="linenos"> 52</span></a>
</span><span id="MappableTensor-53"><a href="#MappableTensor-53"><span class="linenos"> 53</span></a><span class="sd">    Masks can also be used to define valid regions of the tensor.</span>
</span><span id="MappableTensor-54"><a href="#MappableTensor-54"><span class="linenos"> 54</span></a>
</span><span id="MappableTensor-55"><a href="#MappableTensor-55"><span class="linenos"> 55</span></a><span class="sd">    Arguments:</span>
</span><span id="MappableTensor-56"><a href="#MappableTensor-56"><span class="linenos"> 56</span></a><span class="sd">        displacements: Displacement vectors, tensor with shape</span>
</span><span id="MappableTensor-57"><a href="#MappableTensor-57"><span class="linenos"> 57</span></a><span class="sd">            (*batch_shape, *channels_shape, *spatial_shape).</span>
</span><span id="MappableTensor-58"><a href="#MappableTensor-58"><span class="linenos"> 58</span></a><span class="sd">        mask: Mask of the tensor with shape (*batch_shape, *(1,) *</span>
</span><span id="MappableTensor-59"><a href="#MappableTensor-59"><span class="linenos"> 59</span></a><span class="sd">            n_channel_dims, *spatial_shape).</span>
</span><span id="MappableTensor-60"><a href="#MappableTensor-60"><span class="linenos"> 60</span></a><span class="sd">        n_channel_dims: Number of channel dimensions.</span>
</span><span id="MappableTensor-61"><a href="#MappableTensor-61"><span class="linenos"> 61</span></a><span class="sd">        affine_transformation: Affine transformation acting on the displacements.</span>
</span><span id="MappableTensor-62"><a href="#MappableTensor-62"><span class="linenos"> 62</span></a><span class="sd">        grid: Definition of a grid added to the displacements.</span>
</span><span id="MappableTensor-63"><a href="#MappableTensor-63"><span class="linenos"> 63</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MappableTensor-64"><a href="#MappableTensor-64"><span class="linenos"> 64</span></a>
</span><span id="MappableTensor-65"><a href="#MappableTensor-65"><span class="linenos"> 65</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="MappableTensor-66"><a href="#MappableTensor-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-67"><a href="#MappableTensor-67"><span class="linenos"> 67</span></a>        <span class="n">displacements</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-68"><a href="#MappableTensor-68"><span class="linenos"> 68</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-69"><a href="#MappableTensor-69"><span class="linenos"> 69</span></a>        <span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="MappableTensor-70"><a href="#MappableTensor-70"><span class="linenos"> 70</span></a>        <span class="n">affine_transformation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IAffineTransformation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-71"><a href="#MappableTensor-71"><span class="linenos"> 71</span></a>        <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridDefinition</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-72"><a href="#MappableTensor-72"><span class="linenos"> 72</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-73"><a href="#MappableTensor-73"><span class="linenos"> 73</span></a>        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-74"><a href="#MappableTensor-74"><span class="linenos"> 74</span></a>            <span class="n">mask_channels_shape</span> <span class="o">=</span> <span class="n">get_channels_shape</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-75"><a href="#MappableTensor-75"><span class="linenos"> 75</span></a>            <span class="k">if</span> <span class="n">mask_channels_shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="n">n_channel_dims</span><span class="p">:</span>
</span><span id="MappableTensor-76"><a href="#MappableTensor-76"><span class="linenos"> 76</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mask must dimension with size 1 in all channel dimensions&quot;</span><span class="p">)</span>
</span><span id="MappableTensor-77"><a href="#MappableTensor-77"><span class="linenos"> 77</span></a>        <span class="k">if</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_channel_dims</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MappableTensor-78"><a href="#MappableTensor-78"><span class="linenos"> 78</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;When no displacements is set, n_channel_dims must be 1&quot;</span><span class="p">)</span>
</span><span id="MappableTensor-79"><a href="#MappableTensor-79"><span class="linenos"> 79</span></a>        <span class="k">if</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-80"><a href="#MappableTensor-80"><span class="linenos"> 80</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either displacements, or grid must be set.&quot;</span><span class="p">)</span>
</span><span id="MappableTensor-81"><a href="#MappableTensor-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span> <span class="o">=</span> <span class="n">displacements</span>
</span><span id="MappableTensor-82"><a href="#MappableTensor-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">=</span> <span class="n">mask</span>
</span><span id="MappableTensor-83"><a href="#MappableTensor-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span> <span class="o">=</span> <span class="n">n_channel_dims</span>
</span><span id="MappableTensor-84"><a href="#MappableTensor-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MappableTensor-85"><a href="#MappableTensor-85"><span class="linenos"> 85</span></a>            <span class="n">IdentityAffineTransformation</span><span class="p">(</span>
</span><span id="MappableTensor-86"><a href="#MappableTensor-86"><span class="linenos"> 86</span></a>                <span class="n">get_channels_shape</span><span class="p">(</span><span class="n">displacements</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="MappableTensor-87"><a href="#MappableTensor-87"><span class="linenos"> 87</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="n">displacements</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="MappableTensor-88"><a href="#MappableTensor-88"><span class="linenos"> 88</span></a>                <span class="n">device</span><span class="o">=</span><span class="n">displacements</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="MappableTensor-89"><a href="#MappableTensor-89"><span class="linenos"> 89</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-90"><a href="#MappableTensor-90"><span class="linenos"> 90</span></a>            <span class="k">if</span> <span class="n">affine_transformation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="MappableTensor-91"><a href="#MappableTensor-91"><span class="linenos"> 91</span></a>            <span class="k">else</span> <span class="n">affine_transformation</span>
</span><span id="MappableTensor-92"><a href="#MappableTensor-92"><span class="linenos"> 92</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-93"><a href="#MappableTensor-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="o">=</span> <span class="n">grid</span>
</span><span id="MappableTensor-94"><a href="#MappableTensor-94"><span class="linenos"> 94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_shape</span><span class="p">()</span>
</span><span id="MappableTensor-95"><a href="#MappableTensor-95"><span class="linenos"> 95</span></a>
</span><span id="MappableTensor-96"><a href="#MappableTensor-96"><span class="linenos"> 96</span></a>    <span class="nd">@classmethod</span>
</span><span id="MappableTensor-97"><a href="#MappableTensor-97"><span class="linenos"> 97</span></a>    <span class="k">def</span> <span class="nf">from_tensor</span><span class="p">(</span>
</span><span id="MappableTensor-98"><a href="#MappableTensor-98"><span class="linenos"> 98</span></a>        <span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MappableTensor-99"><a href="#MappableTensor-99"><span class="linenos"> 99</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-100"><a href="#MappableTensor-100"><span class="linenos">100</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a mappable tensor from values and mask</span>
</span><span id="MappableTensor-101"><a href="#MappableTensor-101"><span class="linenos">101</span></a>
</span><span id="MappableTensor-102"><a href="#MappableTensor-102"><span class="linenos">102</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor-103"><a href="#MappableTensor-103"><span class="linenos">103</span></a><span class="sd">            values: Values of the generated mappable tensor, tensor with shape</span>
</span><span id="MappableTensor-104"><a href="#MappableTensor-104"><span class="linenos">104</span></a><span class="sd">                (*batch_shape, *channels_shape, *spatial_shape).</span>
</span><span id="MappableTensor-105"><a href="#MappableTensor-105"><span class="linenos">105</span></a><span class="sd">            mask: Mask of the generated mapable tensor with shape</span>
</span><span id="MappableTensor-106"><a href="#MappableTensor-106"><span class="linenos">106</span></a><span class="sd">                (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</span>
</span><span id="MappableTensor-107"><a href="#MappableTensor-107"><span class="linenos">107</span></a><span class="sd">            n_channel_dims: Number of channel dimensions.</span>
</span><span id="MappableTensor-108"><a href="#MappableTensor-108"><span class="linenos">108</span></a>
</span><span id="MappableTensor-109"><a href="#MappableTensor-109"><span class="linenos">109</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor-110"><a href="#MappableTensor-110"><span class="linenos">110</span></a><span class="sd">            Mappable tensor.</span>
</span><span id="MappableTensor-111"><a href="#MappableTensor-111"><span class="linenos">111</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-112"><a href="#MappableTensor-112"><span class="linenos">112</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span><span class="n">displacements</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-113"><a href="#MappableTensor-113"><span class="linenos">113</span></a>
</span><span id="MappableTensor-114"><a href="#MappableTensor-114"><span class="linenos">114</span></a>    <span class="nd">@classmethod</span>
</span><span id="MappableTensor-115"><a href="#MappableTensor-115"><span class="linenos">115</span></a>    <span class="k">def</span> <span class="nf">voxel_grid</span><span class="p">(</span>
</span><span id="MappableTensor-116"><a href="#MappableTensor-116"><span class="linenos">116</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="MappableTensor-117"><a href="#MappableTensor-117"><span class="linenos">117</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="MappableTensor-118"><a href="#MappableTensor-118"><span class="linenos">118</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-119"><a href="#MappableTensor-119"><span class="linenos">119</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-120"><a href="#MappableTensor-120"><span class="linenos">120</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-121"><a href="#MappableTensor-121"><span class="linenos">121</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-122"><a href="#MappableTensor-122"><span class="linenos">122</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a voxel grid with optional mask.</span>
</span><span id="MappableTensor-123"><a href="#MappableTensor-123"><span class="linenos">123</span></a>
</span><span id="MappableTensor-124"><a href="#MappableTensor-124"><span class="linenos">124</span></a><span class="sd">        The voxel grid is not generated explicitly right away, but only when the</span>
</span><span id="MappableTensor-125"><a href="#MappableTensor-125"><span class="linenos">125</span></a><span class="sd">        values are generated.</span>
</span><span id="MappableTensor-126"><a href="#MappableTensor-126"><span class="linenos">126</span></a>
</span><span id="MappableTensor-127"><a href="#MappableTensor-127"><span class="linenos">127</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor-128"><a href="#MappableTensor-128"><span class="linenos">128</span></a><span class="sd">            spatial_shape: Spatial shape of the created grid.</span>
</span><span id="MappableTensor-129"><a href="#MappableTensor-129"><span class="linenos">129</span></a><span class="sd">            mask: Mask of the grid with shape</span>
</span><span id="MappableTensor-130"><a href="#MappableTensor-130"><span class="linenos">130</span></a><span class="sd">                (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</span>
</span><span id="MappableTensor-131"><a href="#MappableTensor-131"><span class="linenos">131</span></a><span class="sd">            dtype: Data type of the grid.</span>
</span><span id="MappableTensor-132"><a href="#MappableTensor-132"><span class="linenos">132</span></a><span class="sd">            device: Device of the grid.</span>
</span><span id="MappableTensor-133"><a href="#MappableTensor-133"><span class="linenos">133</span></a>
</span><span id="MappableTensor-134"><a href="#MappableTensor-134"><span class="linenos">134</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor-135"><a href="#MappableTensor-135"><span class="linenos">135</span></a><span class="sd">            Mappable tensor representing the voxel grid.</span>
</span><span id="MappableTensor-136"><a href="#MappableTensor-136"><span class="linenos">136</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-137"><a href="#MappableTensor-137"><span class="linenos">137</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor-138"><a href="#MappableTensor-138"><span class="linenos">138</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor-139"><a href="#MappableTensor-139"><span class="linenos">139</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="MappableTensor-140"><a href="#MappableTensor-140"><span class="linenos">140</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">GridDefinition</span><span class="p">(</span>
</span><span id="MappableTensor-141"><a href="#MappableTensor-141"><span class="linenos">141</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor-142"><a href="#MappableTensor-142"><span class="linenos">142</span></a>                <span class="n">affine_transformation</span><span class="o">=</span><span class="n">IdentityAffineTransformation</span><span class="p">(</span>
</span><span id="MappableTensor-143"><a href="#MappableTensor-143"><span class="linenos">143</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
</span><span id="MappableTensor-144"><a href="#MappableTensor-144"><span class="linenos">144</span></a>                <span class="p">),</span>
</span><span id="MappableTensor-145"><a href="#MappableTensor-145"><span class="linenos">145</span></a>            <span class="p">),</span>
</span><span id="MappableTensor-146"><a href="#MappableTensor-146"><span class="linenos">146</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-147"><a href="#MappableTensor-147"><span class="linenos">147</span></a>
</span><span id="MappableTensor-148"><a href="#MappableTensor-148"><span class="linenos">148</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-149"><a href="#MappableTensor-149"><span class="linenos">149</span></a>    <span class="k">def</span> <span class="nf">_transformed_displacements_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
</span><span id="MappableTensor-150"><a href="#MappableTensor-150"><span class="linenos">150</span></a>        <span class="n">displacements_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MappableTensor-151"><a href="#MappableTensor-151"><span class="linenos">151</span></a>            <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="o">.</span><span class="n">shape</span>
</span><span id="MappableTensor-152"><a href="#MappableTensor-152"><span class="linenos">152</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-153"><a href="#MappableTensor-153"><span class="linenos">153</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-154"><a href="#MappableTensor-154"><span class="linenos">154</span></a>            <span class="k">if</span> <span class="n">displacements_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-155"><a href="#MappableTensor-155"><span class="linenos">155</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Affine transformation may be set only if displacements is set&quot;</span><span class="p">)</span>
</span><span id="MappableTensor-156"><a href="#MappableTensor-156"><span class="linenos">156</span></a>            <span class="n">displacements_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span><span class="o">.</span><span class="n">get_output_shape</span><span class="p">(</span>
</span><span id="MappableTensor-157"><a href="#MappableTensor-157"><span class="linenos">157</span></a>                <span class="n">displacements_shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span><span id="MappableTensor-158"><a href="#MappableTensor-158"><span class="linenos">158</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-159"><a href="#MappableTensor-159"><span class="linenos">159</span></a>        <span class="k">return</span> <span class="n">displacements_shape</span>
</span><span id="MappableTensor-160"><a href="#MappableTensor-160"><span class="linenos">160</span></a>
</span><span id="MappableTensor-161"><a href="#MappableTensor-161"><span class="linenos">161</span></a>    <span class="k">def</span> <span class="nf">_infer_shape</span><span class="p">(</span>
</span><span id="MappableTensor-162"><a href="#MappableTensor-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-163"><a href="#MappableTensor-163"><span class="linenos">163</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor-164"><a href="#MappableTensor-164"><span class="linenos">164</span></a>        <span class="n">displacements_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transformed_displacements_shape</span>
</span><span id="MappableTensor-165"><a href="#MappableTensor-165"><span class="linenos">165</span></a>        <span class="k">return</span> <span class="n">broadcast_optional_shapes_in_parts_to_single_shape</span><span class="p">(</span>
</span><span id="MappableTensor-166"><a href="#MappableTensor-166"><span class="linenos">166</span></a>            <span class="n">displacements_shape</span><span class="p">,</span>
</span><span id="MappableTensor-167"><a href="#MappableTensor-167"><span class="linenos">167</span></a>            <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="MappableTensor-168"><a href="#MappableTensor-168"><span class="linenos">168</span></a>            <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
</span><span id="MappableTensor-169"><a href="#MappableTensor-169"><span class="linenos">169</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-170"><a href="#MappableTensor-170"><span class="linenos">170</span></a>
</span><span id="MappableTensor-171"><a href="#MappableTensor-171"><span class="linenos">171</span></a>    <span class="k">def</span> <span class="nf">_get_tensors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="MappableTensor-172"><a href="#MappableTensor-172"><span class="linenos">172</span></a>        <span class="n">tensors</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MappableTensor-173"><a href="#MappableTensor-173"><span class="linenos">173</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-174"><a href="#MappableTensor-174"><span class="linenos">174</span></a>            <span class="n">tensors</span><span class="p">[</span><span class="s2">&quot;displacements&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span>
</span><span id="MappableTensor-175"><a href="#MappableTensor-175"><span class="linenos">175</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-176"><a href="#MappableTensor-176"><span class="linenos">176</span></a>            <span class="n">tensors</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span>
</span><span id="MappableTensor-177"><a href="#MappableTensor-177"><span class="linenos">177</span></a>        <span class="k">return</span> <span class="n">tensors</span>
</span><span id="MappableTensor-178"><a href="#MappableTensor-178"><span class="linenos">178</span></a>
</span><span id="MappableTensor-179"><a href="#MappableTensor-179"><span class="linenos">179</span></a>    <span class="k">def</span> <span class="nf">_get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]:</span>
</span><span id="MappableTensor-180"><a href="#MappableTensor-180"><span class="linenos">180</span></a>        <span class="n">children</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MappableTensor-181"><a href="#MappableTensor-181"><span class="linenos">181</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-182"><a href="#MappableTensor-182"><span class="linenos">182</span></a>            <span class="n">children</span><span class="p">[</span><span class="s2">&quot;affine_transformation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span>
</span><span id="MappableTensor-183"><a href="#MappableTensor-183"><span class="linenos">183</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-184"><a href="#MappableTensor-184"><span class="linenos">184</span></a>            <span class="n">children</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span>
</span><span id="MappableTensor-185"><a href="#MappableTensor-185"><span class="linenos">185</span></a>        <span class="k">return</span> <span class="n">children</span>
</span><span id="MappableTensor-186"><a href="#MappableTensor-186"><span class="linenos">186</span></a>
</span><span id="MappableTensor-187"><a href="#MappableTensor-187"><span class="linenos">187</span></a>    <span class="k">def</span> <span class="nf">_modified_copy</span><span class="p">(</span>
</span><span id="MappableTensor-188"><a href="#MappableTensor-188"><span class="linenos">188</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">tensors</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span> <span class="n">children</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ITensorLike</span><span class="p">]</span>
</span><span id="MappableTensor-189"><a href="#MappableTensor-189"><span class="linenos">189</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-190"><a href="#MappableTensor-190"><span class="linenos">190</span></a>        <span class="k">if</span> <span class="s2">&quot;affine_transformation&quot;</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
</span><span id="MappableTensor-191"><a href="#MappableTensor-191"><span class="linenos">191</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;affine_transformation&quot;</span><span class="p">],</span> <span class="n">IAffineTransformation</span><span class="p">):</span>
</span><span id="MappableTensor-192"><a href="#MappableTensor-192"><span class="linenos">192</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid children for mappable tensor&quot;</span><span class="p">)</span>
</span><span id="MappableTensor-193"><a href="#MappableTensor-193"><span class="linenos">193</span></a>            <span class="n">affine_transformation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IAffineTransformation</span><span class="p">]</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span>
</span><span id="MappableTensor-194"><a href="#MappableTensor-194"><span class="linenos">194</span></a>                <span class="s2">&quot;affine_transformation&quot;</span>
</span><span id="MappableTensor-195"><a href="#MappableTensor-195"><span class="linenos">195</span></a>            <span class="p">]</span>
</span><span id="MappableTensor-196"><a href="#MappableTensor-196"><span class="linenos">196</span></a>
</span><span id="MappableTensor-197"><a href="#MappableTensor-197"><span class="linenos">197</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor-198"><a href="#MappableTensor-198"><span class="linenos">198</span></a>            <span class="n">affine_transformation</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor-199"><a href="#MappableTensor-199"><span class="linenos">199</span></a>        <span class="k">if</span> <span class="s2">&quot;grid&quot;</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
</span><span id="MappableTensor-200"><a href="#MappableTensor-200"><span class="linenos">200</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">children</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">],</span> <span class="n">GridDefinition</span><span class="p">):</span>
</span><span id="MappableTensor-201"><a href="#MappableTensor-201"><span class="linenos">201</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid children for mappable tensor&quot;</span><span class="p">)</span>
</span><span id="MappableTensor-202"><a href="#MappableTensor-202"><span class="linenos">202</span></a>            <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridDefinition</span><span class="p">]</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span>
</span><span id="MappableTensor-203"><a href="#MappableTensor-203"><span class="linenos">203</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor-204"><a href="#MappableTensor-204"><span class="linenos">204</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor-205"><a href="#MappableTensor-205"><span class="linenos">205</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor-206"><a href="#MappableTensor-206"><span class="linenos">206</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="n">tensors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;displacements&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="p">),</span>
</span><span id="MappableTensor-207"><a href="#MappableTensor-207"><span class="linenos">207</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">tensors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">),</span>
</span><span id="MappableTensor-208"><a href="#MappableTensor-208"><span class="linenos">208</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-209"><a href="#MappableTensor-209"><span class="linenos">209</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="n">affine_transformation</span><span class="p">,</span>
</span><span id="MappableTensor-210"><a href="#MappableTensor-210"><span class="linenos">210</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
</span><span id="MappableTensor-211"><a href="#MappableTensor-211"><span class="linenos">211</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-212"><a href="#MappableTensor-212"><span class="linenos">212</span></a>
</span><span id="MappableTensor-213"><a href="#MappableTensor-213"><span class="linenos">213</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-214"><a href="#MappableTensor-214"><span class="linenos">214</span></a>    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor-215"><a href="#MappableTensor-215"><span class="linenos">215</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Shape of the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor-216"><a href="#MappableTensor-216"><span class="linenos">216</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>
</span><span id="MappableTensor-217"><a href="#MappableTensor-217"><span class="linenos">217</span></a>
</span><span id="MappableTensor-218"><a href="#MappableTensor-218"><span class="linenos">218</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-219"><a href="#MappableTensor-219"><span class="linenos">219</span></a>    <span class="k">def</span> <span class="nf">spatial_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor-220"><a href="#MappableTensor-220"><span class="linenos">220</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Spatial shape of the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor-221"><a href="#MappableTensor-221"><span class="linenos">221</span></a>        <span class="k">return</span> <span class="n">get_spatial_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-222"><a href="#MappableTensor-222"><span class="linenos">222</span></a>
</span><span id="MappableTensor-223"><a href="#MappableTensor-223"><span class="linenos">223</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-224"><a href="#MappableTensor-224"><span class="linenos">224</span></a>    <span class="k">def</span> <span class="nf">channels_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor-225"><a href="#MappableTensor-225"><span class="linenos">225</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Channel shape of the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor-226"><a href="#MappableTensor-226"><span class="linenos">226</span></a>        <span class="k">return</span> <span class="n">get_channels_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-227"><a href="#MappableTensor-227"><span class="linenos">227</span></a>
</span><span id="MappableTensor-228"><a href="#MappableTensor-228"><span class="linenos">228</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-229"><a href="#MappableTensor-229"><span class="linenos">229</span></a>    <span class="k">def</span> <span class="nf">batch_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor-230"><a href="#MappableTensor-230"><span class="linenos">230</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Batch shape of the mappable tensor.&quot;&quot;&quot;</span>
</span><span id="MappableTensor-231"><a href="#MappableTensor-231"><span class="linenos">231</span></a>        <span class="k">return</span> <span class="n">get_batch_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-232"><a href="#MappableTensor-232"><span class="linenos">232</span></a>
</span><span id="MappableTensor-233"><a href="#MappableTensor-233"><span class="linenos">233</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-234"><a href="#MappableTensor-234"><span class="linenos">234</span></a>    <span class="k">def</span> <span class="nf">mask_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor-235"><a href="#MappableTensor-235"><span class="linenos">235</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Shape of the generated mask of the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor-236"><a href="#MappableTensor-236"><span class="linenos">236</span></a>        <span class="k">return</span> <span class="n">reduce_channels_shape_to_ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-237"><a href="#MappableTensor-237"><span class="linenos">237</span></a>
</span><span id="MappableTensor-238"><a href="#MappableTensor-238"><span class="linenos">238</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-239"><a href="#MappableTensor-239"><span class="linenos">239</span></a>    <span class="k">def</span> <span class="nf">n_channel_dims</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="MappableTensor-240"><a href="#MappableTensor-240"><span class="linenos">240</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of channel dimensions&quot;&quot;&quot;</span>
</span><span id="MappableTensor-241"><a href="#MappableTensor-241"><span class="linenos">241</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span><span id="MappableTensor-242"><a href="#MappableTensor-242"><span class="linenos">242</span></a>
</span><span id="MappableTensor-243"><a href="#MappableTensor-243"><span class="linenos">243</span></a>    <span class="nd">@overload</span>
</span><span id="MappableTensor-244"><a href="#MappableTensor-244"><span class="linenos">244</span></a>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span>
</span><span id="MappableTensor-245"><a href="#MappableTensor-245"><span class="linenos">245</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-246"><a href="#MappableTensor-246"><span class="linenos">246</span></a>        <span class="n">generate_missing_mask</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="MappableTensor-247"><a href="#MappableTensor-247"><span class="linenos">247</span></a>        <span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="MappableTensor-248"><a href="#MappableTensor-248"><span class="linenos">248</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span> <span class="o">...</span>
</span><span id="MappableTensor-249"><a href="#MappableTensor-249"><span class="linenos">249</span></a>
</span><span id="MappableTensor-250"><a href="#MappableTensor-250"><span class="linenos">250</span></a>    <span class="nd">@overload</span>
</span><span id="MappableTensor-251"><a href="#MappableTensor-251"><span class="linenos">251</span></a>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span>  <span class="c1"># https://github.com/pylint-dev/pylint/issues/5264 - pylint: disable=signature-differs</span>
</span><span id="MappableTensor-252"><a href="#MappableTensor-252"><span class="linenos">252</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-253"><a href="#MappableTensor-253"><span class="linenos">253</span></a>        <span class="n">generate_missing_mask</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="MappableTensor-254"><a href="#MappableTensor-254"><span class="linenos">254</span></a>        <span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="MappableTensor-255"><a href="#MappableTensor-255"><span class="linenos">255</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]]:</span> <span class="o">...</span>
</span><span id="MappableTensor-256"><a href="#MappableTensor-256"><span class="linenos">256</span></a>
</span><span id="MappableTensor-257"><a href="#MappableTensor-257"><span class="linenos">257</span></a>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span>
</span><span id="MappableTensor-258"><a href="#MappableTensor-258"><span class="linenos">258</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-259"><a href="#MappableTensor-259"><span class="linenos">259</span></a>        <span class="n">generate_missing_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="MappableTensor-260"><a href="#MappableTensor-260"><span class="linenos">260</span></a>        <span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="MappableTensor-261"><a href="#MappableTensor-261"><span class="linenos">261</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]]:</span>
</span><span id="MappableTensor-262"><a href="#MappableTensor-262"><span class="linenos">262</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate values and mask contained by the mappable tensor.</span>
</span><span id="MappableTensor-263"><a href="#MappableTensor-263"><span class="linenos">263</span></a>
</span><span id="MappableTensor-264"><a href="#MappableTensor-264"><span class="linenos">264</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor-265"><a href="#MappableTensor-265"><span class="linenos">265</span></a><span class="sd">            generate_mask: Generate mask of ones if the tensor does not contain an explicit mask.</span>
</span><span id="MappableTensor-266"><a href="#MappableTensor-266"><span class="linenos">266</span></a><span class="sd">            cast_mask: Mask is stored as a boolean tensor, cast it to dtype of values if True.</span>
</span><span id="MappableTensor-267"><a href="#MappableTensor-267"><span class="linenos">267</span></a>
</span><span id="MappableTensor-268"><a href="#MappableTensor-268"><span class="linenos">268</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor-269"><a href="#MappableTensor-269"><span class="linenos">269</span></a><span class="sd">            Tuple of values and mask.</span>
</span><span id="MappableTensor-270"><a href="#MappableTensor-270"><span class="linenos">270</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-271"><a href="#MappableTensor-271"><span class="linenos">271</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_mask</span><span class="p">(</span>
</span><span id="MappableTensor-272"><a href="#MappableTensor-272"><span class="linenos">272</span></a>            <span class="n">generate_missing_mask</span><span class="o">=</span><span class="n">generate_missing_mask</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="n">cast_mask</span>
</span><span id="MappableTensor-273"><a href="#MappableTensor-273"><span class="linenos">273</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-274"><a href="#MappableTensor-274"><span class="linenos">274</span></a>
</span><span id="MappableTensor-275"><a href="#MappableTensor-275"><span class="linenos">275</span></a>    <span class="k">def</span> <span class="nf">generate_values</span><span class="p">(</span>
</span><span id="MappableTensor-276"><a href="#MappableTensor-276"><span class="linenos">276</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-277"><a href="#MappableTensor-277"><span class="linenos">277</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="MappableTensor-278"><a href="#MappableTensor-278"><span class="linenos">278</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate values contained by the mappable tensor.&quot;&quot;&quot;</span>
</span><span id="MappableTensor-279"><a href="#MappableTensor-279"><span class="linenos">279</span></a>        <span class="n">batch_shape</span><span class="p">,</span> <span class="n">channels_shape</span><span class="p">,</span> <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">split_shape</span><span class="p">(</span>
</span><span id="MappableTensor-280"><a href="#MappableTensor-280"><span class="linenos">280</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span><span id="MappableTensor-281"><a href="#MappableTensor-281"><span class="linenos">281</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-282"><a href="#MappableTensor-282"><span class="linenos">282</span></a>        <span class="n">displacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span>
</span><span id="MappableTensor-283"><a href="#MappableTensor-283"><span class="linenos">283</span></a>        <span class="k">if</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-284"><a href="#MappableTensor-284"><span class="linenos">284</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-285"><a href="#MappableTensor-285"><span class="linenos">285</span></a>                <span class="n">displacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span><span class="p">(</span>
</span><span id="MappableTensor-286"><a href="#MappableTensor-286"><span class="linenos">286</span></a>                    <span class="n">displacements</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span><span id="MappableTensor-287"><a href="#MappableTensor-287"><span class="linenos">287</span></a>                <span class="p">)</span>
</span><span id="MappableTensor-288"><a href="#MappableTensor-288"><span class="linenos">288</span></a>            <span class="n">displacements</span> <span class="o">=</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-289"><a href="#MappableTensor-289"><span class="linenos">289</span></a>                <span class="n">displacements</span><span class="p">,</span>
</span><span id="MappableTensor-290"><a href="#MappableTensor-290"><span class="linenos">290</span></a>                <span class="n">batch_shape</span><span class="o">=</span><span class="n">batch_shape</span><span class="p">,</span>
</span><span id="MappableTensor-291"><a href="#MappableTensor-291"><span class="linenos">291</span></a>                <span class="n">channels_shape</span><span class="o">=</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="MappableTensor-292"><a href="#MappableTensor-292"><span class="linenos">292</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor-293"><a href="#MappableTensor-293"><span class="linenos">293</span></a>                <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-294"><a href="#MappableTensor-294"><span class="linenos">294</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-295"><a href="#MappableTensor-295"><span class="linenos">295</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">is_zero</span><span class="p">():</span>
</span><span id="MappableTensor-296"><a href="#MappableTensor-296"><span class="linenos">296</span></a>            <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor-297"><a href="#MappableTensor-297"><span class="linenos">297</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor-298"><a href="#MappableTensor-298"><span class="linenos">298</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-299"><a href="#MappableTensor-299"><span class="linenos">299</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">generate</span><span class="p">(),</span>
</span><span id="MappableTensor-300"><a href="#MappableTensor-300"><span class="linenos">300</span></a>                <span class="n">batch_shape</span><span class="o">=</span><span class="n">batch_shape</span><span class="p">,</span>
</span><span id="MappableTensor-301"><a href="#MappableTensor-301"><span class="linenos">301</span></a>                <span class="n">channels_shape</span><span class="o">=</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="MappableTensor-302"><a href="#MappableTensor-302"><span class="linenos">302</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor-303"><a href="#MappableTensor-303"><span class="linenos">303</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-304"><a href="#MappableTensor-304"><span class="linenos">304</span></a>        <span class="n">values</span> <span class="o">=</span> <span class="n">optional_add</span><span class="p">(</span><span class="n">displacements</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>
</span><span id="MappableTensor-305"><a href="#MappableTensor-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-306"><a href="#MappableTensor-306"><span class="linenos">306</span></a>            <span class="k">return</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="MappableTensor-307"><a href="#MappableTensor-307"><span class="linenos">307</span></a>        <span class="k">return</span> <span class="n">values</span>
</span><span id="MappableTensor-308"><a href="#MappableTensor-308"><span class="linenos">308</span></a>
</span><span id="MappableTensor-309"><a href="#MappableTensor-309"><span class="linenos">309</span></a>    <span class="nd">@overload</span>
</span><span id="MappableTensor-310"><a href="#MappableTensor-310"><span class="linenos">310</span></a>    <span class="k">def</span> <span class="nf">generate_mask</span><span class="p">(</span>
</span><span id="MappableTensor-311"><a href="#MappableTensor-311"><span class="linenos">311</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-312"><a href="#MappableTensor-312"><span class="linenos">312</span></a>        <span class="n">generate_missing_mask</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="MappableTensor-313"><a href="#MappableTensor-313"><span class="linenos">313</span></a>        <span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="MappableTensor-314"><a href="#MappableTensor-314"><span class="linenos">314</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span> <span class="o">...</span>
</span><span id="MappableTensor-315"><a href="#MappableTensor-315"><span class="linenos">315</span></a>
</span><span id="MappableTensor-316"><a href="#MappableTensor-316"><span class="linenos">316</span></a>    <span class="nd">@overload</span>
</span><span id="MappableTensor-317"><a href="#MappableTensor-317"><span class="linenos">317</span></a>    <span class="k">def</span> <span class="nf">generate_mask</span><span class="p">(</span>  <span class="c1"># https://github.com/pylint-dev/pylint/issues/5264 - pylint: disable=signature-differs</span>
</span><span id="MappableTensor-318"><a href="#MappableTensor-318"><span class="linenos">318</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-319"><a href="#MappableTensor-319"><span class="linenos">319</span></a>        <span class="n">generate_missing_mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]],</span>
</span><span id="MappableTensor-320"><a href="#MappableTensor-320"><span class="linenos">320</span></a>        <span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="MappableTensor-321"><a href="#MappableTensor-321"><span class="linenos">321</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span> <span class="o">...</span>
</span><span id="MappableTensor-322"><a href="#MappableTensor-322"><span class="linenos">322</span></a>
</span><span id="MappableTensor-323"><a href="#MappableTensor-323"><span class="linenos">323</span></a>    <span class="k">def</span> <span class="nf">generate_mask</span><span class="p">(</span>
</span><span id="MappableTensor-324"><a href="#MappableTensor-324"><span class="linenos">324</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor-325"><a href="#MappableTensor-325"><span class="linenos">325</span></a>        <span class="n">generate_missing_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="MappableTensor-326"><a href="#MappableTensor-326"><span class="linenos">326</span></a>        <span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="MappableTensor-327"><a href="#MappableTensor-327"><span class="linenos">327</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
</span><span id="MappableTensor-328"><a href="#MappableTensor-328"><span class="linenos">328</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate mask contained by the mappable tensor.</span>
</span><span id="MappableTensor-329"><a href="#MappableTensor-329"><span class="linenos">329</span></a>
</span><span id="MappableTensor-330"><a href="#MappableTensor-330"><span class="linenos">330</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor-331"><a href="#MappableTensor-331"><span class="linenos">331</span></a><span class="sd">            generate_mask: Generate mask of ones if the tensor does not contain an explicit mask.</span>
</span><span id="MappableTensor-332"><a href="#MappableTensor-332"><span class="linenos">332</span></a><span class="sd">            cast_mask: Mask is stored as a boolean tensor, cast it to dtype of values if True.</span>
</span><span id="MappableTensor-333"><a href="#MappableTensor-333"><span class="linenos">333</span></a>
</span><span id="MappableTensor-334"><a href="#MappableTensor-334"><span class="linenos">334</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor-335"><a href="#MappableTensor-335"><span class="linenos">335</span></a><span class="sd">            Mask of the mappable tensor.</span>
</span><span id="MappableTensor-336"><a href="#MappableTensor-336"><span class="linenos">336</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-337"><a href="#MappableTensor-337"><span class="linenos">337</span></a>        <span class="n">target_dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="k">if</span> <span class="n">cast_mask</span> <span class="k">else</span> <span class="n">torch_bool</span>
</span><span id="MappableTensor-338"><a href="#MappableTensor-338"><span class="linenos">338</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-339"><a href="#MappableTensor-339"><span class="linenos">339</span></a>            <span class="n">batch_shape</span><span class="p">,</span> <span class="n">channels_shape</span><span class="p">,</span> <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">split_shape</span><span class="p">(</span>
</span><span id="MappableTensor-340"><a href="#MappableTensor-340"><span class="linenos">340</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mask_shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span><span id="MappableTensor-341"><a href="#MappableTensor-341"><span class="linenos">341</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-342"><a href="#MappableTensor-342"><span class="linenos">342</span></a>            <span class="k">return</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-343"><a href="#MappableTensor-343"><span class="linenos">343</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">),</span>
</span><span id="MappableTensor-344"><a href="#MappableTensor-344"><span class="linenos">344</span></a>                <span class="n">batch_shape</span><span class="o">=</span><span class="n">batch_shape</span><span class="p">,</span>
</span><span id="MappableTensor-345"><a href="#MappableTensor-345"><span class="linenos">345</span></a>                <span class="n">channels_shape</span><span class="o">=</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="MappableTensor-346"><a href="#MappableTensor-346"><span class="linenos">346</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor-347"><a href="#MappableTensor-347"><span class="linenos">347</span></a>                <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-348"><a href="#MappableTensor-348"><span class="linenos">348</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-349"><a href="#MappableTensor-349"><span class="linenos">349</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="MappableTensor-350"><a href="#MappableTensor-350"><span class="linenos">350</span></a>            <span class="n">ones</span><span class="p">(</span>
</span><span id="MappableTensor-351"><a href="#MappableTensor-351"><span class="linenos">351</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mask_shape</span><span class="p">,</span>
</span><span id="MappableTensor-352"><a href="#MappableTensor-352"><span class="linenos">352</span></a>                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="MappableTensor-353"><a href="#MappableTensor-353"><span class="linenos">353</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="n">target_dtype</span><span class="p">,</span>
</span><span id="MappableTensor-354"><a href="#MappableTensor-354"><span class="linenos">354</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-355"><a href="#MappableTensor-355"><span class="linenos">355</span></a>            <span class="k">if</span> <span class="n">generate_missing_mask</span>
</span><span id="MappableTensor-356"><a href="#MappableTensor-356"><span class="linenos">356</span></a>            <span class="k">else</span> <span class="kc">None</span>
</span><span id="MappableTensor-357"><a href="#MappableTensor-357"><span class="linenos">357</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-358"><a href="#MappableTensor-358"><span class="linenos">358</span></a>
</span><span id="MappableTensor-359"><a href="#MappableTensor-359"><span class="linenos">359</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-360"><a href="#MappableTensor-360"><span class="linenos">360</span></a>    <span class="k">def</span> <span class="nf">displacements</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
</span><span id="MappableTensor-361"><a href="#MappableTensor-361"><span class="linenos">361</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Displacements contained by the mappable tensor</span>
</span><span id="MappableTensor-362"><a href="#MappableTensor-362"><span class="linenos">362</span></a>
</span><span id="MappableTensor-363"><a href="#MappableTensor-363"><span class="linenos">363</span></a><span class="sd">        The displacements vector might not have the same shape as the mappable</span>
</span><span id="MappableTensor-364"><a href="#MappableTensor-364"><span class="linenos">364</span></a><span class="sd">        tensor, but is brodcastable to it. This is a relatively low level</span>
</span><span id="MappableTensor-365"><a href="#MappableTensor-365"><span class="linenos">365</span></a><span class="sd">        property and the recommended way to access the values is through the</span>
</span><span id="MappableTensor-366"><a href="#MappableTensor-366"><span class="linenos">366</span></a><span class="sd">        `generate_values` method.</span>
</span><span id="MappableTensor-367"><a href="#MappableTensor-367"><span class="linenos">367</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-368"><a href="#MappableTensor-368"><span class="linenos">368</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span>
</span><span id="MappableTensor-369"><a href="#MappableTensor-369"><span class="linenos">369</span></a>
</span><span id="MappableTensor-370"><a href="#MappableTensor-370"><span class="linenos">370</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-371"><a href="#MappableTensor-371"><span class="linenos">371</span></a>    <span class="k">def</span> <span class="nf">affine_transformation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IAffineTransformation</span><span class="p">]:</span>
</span><span id="MappableTensor-372"><a href="#MappableTensor-372"><span class="linenos">372</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Affine transformation on displacements, if available</span>
</span><span id="MappableTensor-373"><a href="#MappableTensor-373"><span class="linenos">373</span></a>
</span><span id="MappableTensor-374"><a href="#MappableTensor-374"><span class="linenos">374</span></a><span class="sd">        This is relatively low level property, and should be used with caution.</span>
</span><span id="MappableTensor-375"><a href="#MappableTensor-375"><span class="linenos">375</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-376"><a href="#MappableTensor-376"><span class="linenos">376</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span>
</span><span id="MappableTensor-377"><a href="#MappableTensor-377"><span class="linenos">377</span></a>
</span><span id="MappableTensor-378"><a href="#MappableTensor-378"><span class="linenos">378</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor-379"><a href="#MappableTensor-379"><span class="linenos">379</span></a>    <span class="k">def</span> <span class="nf">grid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridDefinition</span><span class="p">]:</span>
</span><span id="MappableTensor-380"><a href="#MappableTensor-380"><span class="linenos">380</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Definition of the grid contained by the tensor, if available</span>
</span><span id="MappableTensor-381"><a href="#MappableTensor-381"><span class="linenos">381</span></a>
</span><span id="MappableTensor-382"><a href="#MappableTensor-382"><span class="linenos">382</span></a><span class="sd">        The grid might not have the same shape as the mappable tensor, but is</span>
</span><span id="MappableTensor-383"><a href="#MappableTensor-383"><span class="linenos">383</span></a><span class="sd">        brodcastable to it. This is relatively low level method, and should be</span>
</span><span id="MappableTensor-384"><a href="#MappableTensor-384"><span class="linenos">384</span></a><span class="sd">        used with caution.</span>
</span><span id="MappableTensor-385"><a href="#MappableTensor-385"><span class="linenos">385</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-386"><a href="#MappableTensor-386"><span class="linenos">386</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span>
</span><span id="MappableTensor-387"><a href="#MappableTensor-387"><span class="linenos">387</span></a>
</span><span id="MappableTensor-388"><a href="#MappableTensor-388"><span class="linenos">388</span></a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">affine_transformation</span><span class="p">:</span> <span class="n">IAffineTransformation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-389"><a href="#MappableTensor-389"><span class="linenos">389</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply an affine transformation to the last channel dimension of the</span>
</span><span id="MappableTensor-390"><a href="#MappableTensor-390"><span class="linenos">390</span></a><span class="sd">        mappable tensor.</span>
</span><span id="MappableTensor-391"><a href="#MappableTensor-391"><span class="linenos">391</span></a>
</span><span id="MappableTensor-392"><a href="#MappableTensor-392"><span class="linenos">392</span></a><span class="sd">        The affine transformation is not applied right a way, only the</span>
</span><span id="MappableTensor-393"><a href="#MappableTensor-393"><span class="linenos">393</span></a><span class="sd">        composition with the existing affine transformation is stored. The</span>
</span><span id="MappableTensor-394"><a href="#MappableTensor-394"><span class="linenos">394</span></a><span class="sd">        transformation is applied when the values are generated.</span>
</span><span id="MappableTensor-395"><a href="#MappableTensor-395"><span class="linenos">395</span></a>
</span><span id="MappableTensor-396"><a href="#MappableTensor-396"><span class="linenos">396</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor-397"><a href="#MappableTensor-397"><span class="linenos">397</span></a><span class="sd">            affine_transformation: Affine transformation to apply.</span>
</span><span id="MappableTensor-398"><a href="#MappableTensor-398"><span class="linenos">398</span></a>
</span><span id="MappableTensor-399"><a href="#MappableTensor-399"><span class="linenos">399</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor-400"><a href="#MappableTensor-400"><span class="linenos">400</span></a><span class="sd">            Transformed mappable tensor.</span>
</span><span id="MappableTensor-401"><a href="#MappableTensor-401"><span class="linenos">401</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-402"><a href="#MappableTensor-402"><span class="linenos">402</span></a>        <span class="n">n_affine_transformation_input_channels</span> <span class="o">=</span> <span class="n">affine_transformation</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="MappableTensor-403"><a href="#MappableTensor-403"><span class="linenos">403</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">n_affine_transformation_input_channels</span><span class="p">:</span>
</span><span id="MappableTensor-404"><a href="#MappableTensor-404"><span class="linenos">404</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Affine transformation must have matching input channels&quot;</span><span class="p">)</span>
</span><span id="MappableTensor-405"><a href="#MappableTensor-405"><span class="linenos">405</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-406"><a href="#MappableTensor-406"><span class="linenos">406</span></a>            <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridDefinition</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor-407"><a href="#MappableTensor-407"><span class="linenos">407</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor-408"><a href="#MappableTensor-408"><span class="linenos">408</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">is_transformable</span><span class="p">(</span><span class="n">affine_transformation</span><span class="p">):</span>
</span><span id="MappableTensor-409"><a href="#MappableTensor-409"><span class="linenos">409</span></a>                <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor-410"><a href="#MappableTensor-410"><span class="linenos">410</span></a>                    <span class="n">displacements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">(),</span>
</span><span id="MappableTensor-411"><a href="#MappableTensor-411"><span class="linenos">411</span></a>                    <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor-412"><a href="#MappableTensor-412"><span class="linenos">412</span></a>                    <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-413"><a href="#MappableTensor-413"><span class="linenos">413</span></a>                    <span class="n">affine_transformation</span><span class="o">=</span><span class="n">affine_transformation</span><span class="p">,</span>
</span><span id="MappableTensor-414"><a href="#MappableTensor-414"><span class="linenos">414</span></a>                    <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-415"><a href="#MappableTensor-415"><span class="linenos">415</span></a>                <span class="p">)</span>
</span><span id="MappableTensor-416"><a href="#MappableTensor-416"><span class="linenos">416</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">broadcast_to_n_channels</span><span class="p">(</span>
</span><span id="MappableTensor-417"><a href="#MappableTensor-417"><span class="linenos">417</span></a>                <span class="n">n_affine_transformation_input_channels</span>
</span><span id="MappableTensor-418"><a href="#MappableTensor-418"><span class="linenos">418</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">affine_transformation</span><span class="p">)</span>
</span><span id="MappableTensor-419"><a href="#MappableTensor-419"><span class="linenos">419</span></a>            <span class="n">affine_transformation</span> <span class="o">=</span> <span class="n">affine_transformation</span><span class="o">.</span><span class="n">clear_translation</span><span class="p">()</span>
</span><span id="MappableTensor-420"><a href="#MappableTensor-420"><span class="linenos">420</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-421"><a href="#MappableTensor-421"><span class="linenos">421</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="MappableTensor-422"><a href="#MappableTensor-422"><span class="linenos">422</span></a>            <span class="n">affine_transformation_on_displacements</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IAffineTransformation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor-423"><a href="#MappableTensor-423"><span class="linenos">423</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor-424"><a href="#MappableTensor-424"><span class="linenos">424</span></a>            <span class="n">affine_transformation_on_displacements</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MappableTensor-425"><a href="#MappableTensor-425"><span class="linenos">425</span></a>                <span class="n">affine_transformation</span>
</span><span id="MappableTensor-426"><a href="#MappableTensor-426"><span class="linenos">426</span></a>                <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span><span class="o">.</span><span class="n">broadcast_to_n_output_channels</span><span class="p">(</span>
</span><span id="MappableTensor-427"><a href="#MappableTensor-427"><span class="linenos">427</span></a>                    <span class="n">n_affine_transformation_input_channels</span><span class="p">,</span>
</span><span id="MappableTensor-428"><a href="#MappableTensor-428"><span class="linenos">428</span></a>                <span class="p">)</span>
</span><span id="MappableTensor-429"><a href="#MappableTensor-429"><span class="linenos">429</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-430"><a href="#MappableTensor-430"><span class="linenos">430</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor-431"><a href="#MappableTensor-431"><span class="linenos">431</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="p">,</span>
</span><span id="MappableTensor-432"><a href="#MappableTensor-432"><span class="linenos">432</span></a>            <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor-433"><a href="#MappableTensor-433"><span class="linenos">433</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-434"><a href="#MappableTensor-434"><span class="linenos">434</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="n">affine_transformation_on_displacements</span><span class="p">,</span>
</span><span id="MappableTensor-435"><a href="#MappableTensor-435"><span class="linenos">435</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
</span><span id="MappableTensor-436"><a href="#MappableTensor-436"><span class="linenos">436</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-437"><a href="#MappableTensor-437"><span class="linenos">437</span></a>
</span><span id="MappableTensor-438"><a href="#MappableTensor-438"><span class="linenos">438</span></a>    <span class="k">def</span> <span class="fm">__rpow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;MappableTensor&quot;</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-439"><a href="#MappableTensor-439"><span class="linenos">439</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MappableTensor</span><span class="p">):</span>
</span><span id="MappableTensor-440"><a href="#MappableTensor-440"><span class="linenos">440</span></a>            <span class="k">return</span> <span class="n">other</span><span class="o">.</span><span class="fm">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="MappableTensor-441"><a href="#MappableTensor-441"><span class="linenos">441</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
</span><span id="MappableTensor-442"><a href="#MappableTensor-442"><span class="linenos">442</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpow_scalar</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-443"><a href="#MappableTensor-443"><span class="linenos">443</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="MappableTensor-444"><a href="#MappableTensor-444"><span class="linenos">444</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpow_tensor</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-445"><a href="#MappableTensor-445"><span class="linenos">445</span></a>        <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span id="MappableTensor-446"><a href="#MappableTensor-446"><span class="linenos">446</span></a>
</span><span id="MappableTensor-447"><a href="#MappableTensor-447"><span class="linenos">447</span></a>    <span class="k">def</span> <span class="nf">_rpow_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-448"><a href="#MappableTensor-448"><span class="linenos">448</span></a>        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MappableTensor-449"><a href="#MappableTensor-449"><span class="linenos">449</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="MappableTensor-450"><a href="#MappableTensor-450"><span class="linenos">450</span></a>                <span class="s2">&quot;Power is ambigous since n_channel_dims is not specified. &quot;</span>
</span><span id="MappableTensor-451"><a href="#MappableTensor-451"><span class="linenos">451</span></a>                <span class="s2">&quot;Consider exponentiating with a MappableTensor instead.&quot;</span>
</span><span id="MappableTensor-452"><a href="#MappableTensor-452"><span class="linenos">452</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-453"><a href="#MappableTensor-453"><span class="linenos">453</span></a>        <span class="n">other</span> <span class="o">=</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-454"><a href="#MappableTensor-454"><span class="linenos">454</span></a>            <span class="n">other</span><span class="p">,</span>
</span><span id="MappableTensor-455"><a href="#MappableTensor-455"><span class="linenos">455</span></a>            <span class="n">batch_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_shape</span><span class="p">,</span>
</span><span id="MappableTensor-456"><a href="#MappableTensor-456"><span class="linenos">456</span></a>            <span class="n">channels_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="MappableTensor-457"><a href="#MappableTensor-457"><span class="linenos">457</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor-458"><a href="#MappableTensor-458"><span class="linenos">458</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="MappableTensor-459"><a href="#MappableTensor-459"><span class="linenos">459</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-460"><a href="#MappableTensor-460"><span class="linenos">460</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-461"><a href="#MappableTensor-461"><span class="linenos">461</span></a>            <span class="n">values</span><span class="o">=</span><span class="n">other</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">(),</span>
</span><span id="MappableTensor-462"><a href="#MappableTensor-462"><span class="linenos">462</span></a>            <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor-463"><a href="#MappableTensor-463"><span class="linenos">463</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-464"><a href="#MappableTensor-464"><span class="linenos">464</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-465"><a href="#MappableTensor-465"><span class="linenos">465</span></a>
</span><span id="MappableTensor-466"><a href="#MappableTensor-466"><span class="linenos">466</span></a>    <span class="k">def</span> <span class="nf">_rpow_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-467"><a href="#MappableTensor-467"><span class="linenos">467</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-468"><a href="#MappableTensor-468"><span class="linenos">468</span></a>            <span class="n">values</span><span class="o">=</span><span class="n">other</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">(),</span>
</span><span id="MappableTensor-469"><a href="#MappableTensor-469"><span class="linenos">469</span></a>            <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor-470"><a href="#MappableTensor-470"><span class="linenos">470</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-471"><a href="#MappableTensor-471"><span class="linenos">471</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-472"><a href="#MappableTensor-472"><span class="linenos">472</span></a>
</span><span id="MappableTensor-473"><a href="#MappableTensor-473"><span class="linenos">473</span></a>    <span class="k">def</span> <span class="fm">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;MappableTensor&quot;</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-474"><a href="#MappableTensor-474"><span class="linenos">474</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MappableTensor</span><span class="p">):</span>
</span><span id="MappableTensor-475"><a href="#MappableTensor-475"><span class="linenos">475</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pow_mappable_tensor</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-476"><a href="#MappableTensor-476"><span class="linenos">476</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
</span><span id="MappableTensor-477"><a href="#MappableTensor-477"><span class="linenos">477</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pow_scalar</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-478"><a href="#MappableTensor-478"><span class="linenos">478</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="MappableTensor-479"><a href="#MappableTensor-479"><span class="linenos">479</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pow_tensor</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-480"><a href="#MappableTensor-480"><span class="linenos">480</span></a>        <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span id="MappableTensor-481"><a href="#MappableTensor-481"><span class="linenos">481</span></a>
</span><span id="MappableTensor-482"><a href="#MappableTensor-482"><span class="linenos">482</span></a>    <span class="k">def</span> <span class="nf">_pow_mappable_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-483"><a href="#MappableTensor-483"><span class="linenos">483</span></a>        <span class="n">self_values</span><span class="p">,</span> <span class="n">self_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MappableTensor-484"><a href="#MappableTensor-484"><span class="linenos">484</span></a>        <span class="n">other_values</span><span class="p">,</span> <span class="n">other_mask</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MappableTensor-485"><a href="#MappableTensor-485"><span class="linenos">485</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">combine_optional_masks</span><span class="p">(</span>
</span><span id="MappableTensor-486"><a href="#MappableTensor-486"><span class="linenos">486</span></a>            <span class="n">self_mask</span><span class="p">,</span>
</span><span id="MappableTensor-487"><a href="#MappableTensor-487"><span class="linenos">487</span></a>            <span class="n">other_mask</span><span class="p">,</span>
</span><span id="MappableTensor-488"><a href="#MappableTensor-488"><span class="linenos">488</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">),</span>
</span><span id="MappableTensor-489"><a href="#MappableTensor-489"><span class="linenos">489</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-490"><a href="#MappableTensor-490"><span class="linenos">490</span></a>        <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-491"><a href="#MappableTensor-491"><span class="linenos">491</span></a>        <span class="n">self_values</span><span class="p">,</span> <span class="n">other_values</span> <span class="o">=</span> <span class="n">broadcast_tensors_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-492"><a href="#MappableTensor-492"><span class="linenos">492</span></a>            <span class="n">self_values</span><span class="p">,</span> <span class="n">other_values</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-493"><a href="#MappableTensor-493"><span class="linenos">493</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-494"><a href="#MappableTensor-494"><span class="linenos">494</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-495"><a href="#MappableTensor-495"><span class="linenos">495</span></a>            <span class="n">values</span><span class="o">=</span><span class="n">self_values</span><span class="o">**</span><span class="n">other_values</span><span class="p">,</span>
</span><span id="MappableTensor-496"><a href="#MappableTensor-496"><span class="linenos">496</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor-497"><a href="#MappableTensor-497"><span class="linenos">497</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-498"><a href="#MappableTensor-498"><span class="linenos">498</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-499"><a href="#MappableTensor-499"><span class="linenos">499</span></a>
</span><span id="MappableTensor-500"><a href="#MappableTensor-500"><span class="linenos">500</span></a>    <span class="k">def</span> <span class="nf">_pow_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-501"><a href="#MappableTensor-501"><span class="linenos">501</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-502"><a href="#MappableTensor-502"><span class="linenos">502</span></a>            <span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">()</span> <span class="o">**</span> <span class="n">other</span><span class="p">,</span>
</span><span id="MappableTensor-503"><a href="#MappableTensor-503"><span class="linenos">503</span></a>            <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor-504"><a href="#MappableTensor-504"><span class="linenos">504</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-505"><a href="#MappableTensor-505"><span class="linenos">505</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-506"><a href="#MappableTensor-506"><span class="linenos">506</span></a>
</span><span id="MappableTensor-507"><a href="#MappableTensor-507"><span class="linenos">507</span></a>    <span class="k">def</span> <span class="nf">_pow_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-508"><a href="#MappableTensor-508"><span class="linenos">508</span></a>        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MappableTensor-509"><a href="#MappableTensor-509"><span class="linenos">509</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="MappableTensor-510"><a href="#MappableTensor-510"><span class="linenos">510</span></a>                <span class="s2">&quot;Power is ambigous since n_channel_dims is not specified. &quot;</span>
</span><span id="MappableTensor-511"><a href="#MappableTensor-511"><span class="linenos">511</span></a>                <span class="s2">&quot;Consider exponentiating with a MappableTensor instead.&quot;</span>
</span><span id="MappableTensor-512"><a href="#MappableTensor-512"><span class="linenos">512</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-513"><a href="#MappableTensor-513"><span class="linenos">513</span></a>        <span class="n">other</span> <span class="o">=</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-514"><a href="#MappableTensor-514"><span class="linenos">514</span></a>            <span class="n">other</span><span class="p">,</span>
</span><span id="MappableTensor-515"><a href="#MappableTensor-515"><span class="linenos">515</span></a>            <span class="n">batch_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_shape</span><span class="p">,</span>
</span><span id="MappableTensor-516"><a href="#MappableTensor-516"><span class="linenos">516</span></a>            <span class="n">channels_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="MappableTensor-517"><a href="#MappableTensor-517"><span class="linenos">517</span></a>            <span class="n">spatial_shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor-518"><a href="#MappableTensor-518"><span class="linenos">518</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="MappableTensor-519"><a href="#MappableTensor-519"><span class="linenos">519</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-520"><a href="#MappableTensor-520"><span class="linenos">520</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-521"><a href="#MappableTensor-521"><span class="linenos">521</span></a>            <span class="n">values</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">()</span> <span class="o">**</span> <span class="n">other</span><span class="p">,</span>
</span><span id="MappableTensor-522"><a href="#MappableTensor-522"><span class="linenos">522</span></a>            <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor-523"><a href="#MappableTensor-523"><span class="linenos">523</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-524"><a href="#MappableTensor-524"><span class="linenos">524</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-525"><a href="#MappableTensor-525"><span class="linenos">525</span></a>
</span><span id="MappableTensor-526"><a href="#MappableTensor-526"><span class="linenos">526</span></a>    <span class="k">def</span> <span class="fm">__rtruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;MappableTensor&quot;</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-527"><a href="#MappableTensor-527"><span class="linenos">527</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">MappableTensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
</span><span id="MappableTensor-528"><a href="#MappableTensor-528"><span class="linenos">528</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reciprocal</span><span class="p">()</span><span class="o">.</span><span class="fm">__mul__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-529"><a href="#MappableTensor-529"><span class="linenos">529</span></a>        <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span id="MappableTensor-530"><a href="#MappableTensor-530"><span class="linenos">530</span></a>
</span><span id="MappableTensor-531"><a href="#MappableTensor-531"><span class="linenos">531</span></a>    <span class="k">def</span> <span class="nf">_reciprocal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-532"><a href="#MappableTensor-532"><span class="linenos">532</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-533"><a href="#MappableTensor-533"><span class="linenos">533</span></a>            <span class="n">values</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">(),</span>
</span><span id="MappableTensor-534"><a href="#MappableTensor-534"><span class="linenos">534</span></a>            <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor-535"><a href="#MappableTensor-535"><span class="linenos">535</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-536"><a href="#MappableTensor-536"><span class="linenos">536</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-537"><a href="#MappableTensor-537"><span class="linenos">537</span></a>
</span><span id="MappableTensor-538"><a href="#MappableTensor-538"><span class="linenos">538</span></a>    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;MappableTensor&quot;</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-539"><a href="#MappableTensor-539"><span class="linenos">539</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MappableTensor</span><span class="p">):</span>
</span><span id="MappableTensor-540"><a href="#MappableTensor-540"><span class="linenos">540</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truediv_mappable_tensor</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-541"><a href="#MappableTensor-541"><span class="linenos">541</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
</span><span id="MappableTensor-542"><a href="#MappableTensor-542"><span class="linenos">542</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__mul__</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-543"><a href="#MappableTensor-543"><span class="linenos">543</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="MappableTensor-544"><a href="#MappableTensor-544"><span class="linenos">544</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__mul__</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-545"><a href="#MappableTensor-545"><span class="linenos">545</span></a>        <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span id="MappableTensor-546"><a href="#MappableTensor-546"><span class="linenos">546</span></a>
</span><span id="MappableTensor-547"><a href="#MappableTensor-547"><span class="linenos">547</span></a>    <span class="k">def</span> <span class="nf">_truediv_mappable_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-548"><a href="#MappableTensor-548"><span class="linenos">548</span></a>        <span class="n">self_values</span><span class="p">,</span> <span class="n">self_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MappableTensor-549"><a href="#MappableTensor-549"><span class="linenos">549</span></a>        <span class="n">other_values</span><span class="p">,</span> <span class="n">other_mask</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MappableTensor-550"><a href="#MappableTensor-550"><span class="linenos">550</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">combine_optional_masks</span><span class="p">(</span>
</span><span id="MappableTensor-551"><a href="#MappableTensor-551"><span class="linenos">551</span></a>            <span class="n">self_mask</span><span class="p">,</span>
</span><span id="MappableTensor-552"><a href="#MappableTensor-552"><span class="linenos">552</span></a>            <span class="n">other_mask</span><span class="p">,</span>
</span><span id="MappableTensor-553"><a href="#MappableTensor-553"><span class="linenos">553</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">),</span>
</span><span id="MappableTensor-554"><a href="#MappableTensor-554"><span class="linenos">554</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-555"><a href="#MappableTensor-555"><span class="linenos">555</span></a>        <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-556"><a href="#MappableTensor-556"><span class="linenos">556</span></a>        <span class="n">self_values</span><span class="p">,</span> <span class="n">other_values</span> <span class="o">=</span> <span class="n">broadcast_tensors_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-557"><a href="#MappableTensor-557"><span class="linenos">557</span></a>            <span class="n">self_values</span><span class="p">,</span> <span class="n">other_values</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-558"><a href="#MappableTensor-558"><span class="linenos">558</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-559"><a href="#MappableTensor-559"><span class="linenos">559</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-560"><a href="#MappableTensor-560"><span class="linenos">560</span></a>            <span class="n">values</span><span class="o">=</span><span class="n">self_values</span> <span class="o">/</span> <span class="n">other_values</span><span class="p">,</span>
</span><span id="MappableTensor-561"><a href="#MappableTensor-561"><span class="linenos">561</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor-562"><a href="#MappableTensor-562"><span class="linenos">562</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-563"><a href="#MappableTensor-563"><span class="linenos">563</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-564"><a href="#MappableTensor-564"><span class="linenos">564</span></a>
</span><span id="MappableTensor-565"><a href="#MappableTensor-565"><span class="linenos">565</span></a>    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;MappableTensor&quot;</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-566"><a href="#MappableTensor-566"><span class="linenos">566</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MappableTensor</span><span class="p">):</span>
</span><span id="MappableTensor-567"><a href="#MappableTensor-567"><span class="linenos">567</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mul_mappable_tensor</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-568"><a href="#MappableTensor-568"><span class="linenos">568</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
</span><span id="MappableTensor-569"><a href="#MappableTensor-569"><span class="linenos">569</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mul_scalar</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-570"><a href="#MappableTensor-570"><span class="linenos">570</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="MappableTensor-571"><a href="#MappableTensor-571"><span class="linenos">571</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mul_tensor</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-572"><a href="#MappableTensor-572"><span class="linenos">572</span></a>        <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span id="MappableTensor-573"><a href="#MappableTensor-573"><span class="linenos">573</span></a>
</span><span id="MappableTensor-574"><a href="#MappableTensor-574"><span class="linenos">574</span></a>    <span class="k">def</span> <span class="nf">_mul_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-575"><a href="#MappableTensor-575"><span class="linenos">575</span></a>        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MappableTensor-576"><a href="#MappableTensor-576"><span class="linenos">576</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="MappableTensor-577"><a href="#MappableTensor-577"><span class="linenos">577</span></a>                <span class="s2">&quot;Multiplication is ambigous since n_channel_dims is not specified. &quot;</span>
</span><span id="MappableTensor-578"><a href="#MappableTensor-578"><span class="linenos">578</span></a>                <span class="s2">&quot;Multiply a MappableTensor instead or apply an affine transformation.&quot;</span>
</span><span id="MappableTensor-579"><a href="#MappableTensor-579"><span class="linenos">579</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-580"><a href="#MappableTensor-580"><span class="linenos">580</span></a>        <span class="n">n_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MappableTensor-581"><a href="#MappableTensor-581"><span class="linenos">581</span></a>        <span class="n">affine</span> <span class="o">=</span> <span class="n">DiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="MappableTensor-582"><a href="#MappableTensor-582"><span class="linenos">582</span></a>            <span class="n">diagonal</span><span class="o">=</span><span class="n">other</span><span class="p">,</span>
</span><span id="MappableTensor-583"><a href="#MappableTensor-583"><span class="linenos">583</span></a>            <span class="n">matrix_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="MappableTensor-584"><a href="#MappableTensor-584"><span class="linenos">584</span></a>            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="MappableTensor-585"><a href="#MappableTensor-585"><span class="linenos">585</span></a>            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="MappableTensor-586"><a href="#MappableTensor-586"><span class="linenos">586</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-587"><a href="#MappableTensor-587"><span class="linenos">587</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>
</span><span id="MappableTensor-588"><a href="#MappableTensor-588"><span class="linenos">588</span></a>
</span><span id="MappableTensor-589"><a href="#MappableTensor-589"><span class="linenos">589</span></a>    <span class="k">def</span> <span class="nf">_mul_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-590"><a href="#MappableTensor-590"><span class="linenos">590</span></a>        <span class="n">n_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MappableTensor-591"><a href="#MappableTensor-591"><span class="linenos">591</span></a>        <span class="n">affine</span> <span class="o">=</span> <span class="n">HostDiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="MappableTensor-592"><a href="#MappableTensor-592"><span class="linenos">592</span></a>            <span class="n">diagonal</span><span class="o">=</span><span class="n">other</span><span class="p">,</span>
</span><span id="MappableTensor-593"><a href="#MappableTensor-593"><span class="linenos">593</span></a>            <span class="n">matrix_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="MappableTensor-594"><a href="#MappableTensor-594"><span class="linenos">594</span></a>            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="MappableTensor-595"><a href="#MappableTensor-595"><span class="linenos">595</span></a>            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="MappableTensor-596"><a href="#MappableTensor-596"><span class="linenos">596</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-597"><a href="#MappableTensor-597"><span class="linenos">597</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>
</span><span id="MappableTensor-598"><a href="#MappableTensor-598"><span class="linenos">598</span></a>
</span><span id="MappableTensor-599"><a href="#MappableTensor-599"><span class="linenos">599</span></a>    <span class="k">def</span> <span class="nf">_mul_mappable_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-600"><a href="#MappableTensor-600"><span class="linenos">600</span></a>        <span class="n">self_values</span><span class="p">,</span> <span class="n">self_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MappableTensor-601"><a href="#MappableTensor-601"><span class="linenos">601</span></a>        <span class="n">other_values</span><span class="p">,</span> <span class="n">other_mask</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MappableTensor-602"><a href="#MappableTensor-602"><span class="linenos">602</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">combine_optional_masks</span><span class="p">(</span>
</span><span id="MappableTensor-603"><a href="#MappableTensor-603"><span class="linenos">603</span></a>            <span class="n">self_mask</span><span class="p">,</span>
</span><span id="MappableTensor-604"><a href="#MappableTensor-604"><span class="linenos">604</span></a>            <span class="n">other_mask</span><span class="p">,</span>
</span><span id="MappableTensor-605"><a href="#MappableTensor-605"><span class="linenos">605</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">),</span>
</span><span id="MappableTensor-606"><a href="#MappableTensor-606"><span class="linenos">606</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-607"><a href="#MappableTensor-607"><span class="linenos">607</span></a>        <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-608"><a href="#MappableTensor-608"><span class="linenos">608</span></a>        <span class="n">self_values</span><span class="p">,</span> <span class="n">other_values</span> <span class="o">=</span> <span class="n">broadcast_tensors_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-609"><a href="#MappableTensor-609"><span class="linenos">609</span></a>            <span class="n">self_values</span><span class="p">,</span> <span class="n">other_values</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-610"><a href="#MappableTensor-610"><span class="linenos">610</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-611"><a href="#MappableTensor-611"><span class="linenos">611</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-612"><a href="#MappableTensor-612"><span class="linenos">612</span></a>            <span class="n">values</span><span class="o">=</span><span class="n">self_values</span> <span class="o">*</span> <span class="n">other_values</span><span class="p">,</span>
</span><span id="MappableTensor-613"><a href="#MappableTensor-613"><span class="linenos">613</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor-614"><a href="#MappableTensor-614"><span class="linenos">614</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-615"><a href="#MappableTensor-615"><span class="linenos">615</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-616"><a href="#MappableTensor-616"><span class="linenos">616</span></a>
</span><span id="MappableTensor-617"><a href="#MappableTensor-617"><span class="linenos">617</span></a>    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;MappableTensor&quot;</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-618"><a href="#MappableTensor-618"><span class="linenos">618</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MappableTensor</span><span class="p">):</span>
</span><span id="MappableTensor-619"><a href="#MappableTensor-619"><span class="linenos">619</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_mappable_tensor</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-620"><a href="#MappableTensor-620"><span class="linenos">620</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
</span><span id="MappableTensor-621"><a href="#MappableTensor-621"><span class="linenos">621</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_scalar</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-622"><a href="#MappableTensor-622"><span class="linenos">622</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">):</span>
</span><span id="MappableTensor-623"><a href="#MappableTensor-623"><span class="linenos">623</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_tensor</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-624"><a href="#MappableTensor-624"><span class="linenos">624</span></a>        <span class="k">return</span> <span class="bp">NotImplemented</span>
</span><span id="MappableTensor-625"><a href="#MappableTensor-625"><span class="linenos">625</span></a>
</span><span id="MappableTensor-626"><a href="#MappableTensor-626"><span class="linenos">626</span></a>    <span class="k">def</span> <span class="nf">_add_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-627"><a href="#MappableTensor-627"><span class="linenos">627</span></a>        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MappableTensor-628"><a href="#MappableTensor-628"><span class="linenos">628</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="MappableTensor-629"><a href="#MappableTensor-629"><span class="linenos">629</span></a>                <span class="s2">&quot;Addition is ambigous since n_channel_dims is not specified. &quot;</span>
</span><span id="MappableTensor-630"><a href="#MappableTensor-630"><span class="linenos">630</span></a>                <span class="s2">&quot;Add a MappableTensor instead or apply an affine transformation.&quot;</span>
</span><span id="MappableTensor-631"><a href="#MappableTensor-631"><span class="linenos">631</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-632"><a href="#MappableTensor-632"><span class="linenos">632</span></a>        <span class="n">n_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MappableTensor-633"><a href="#MappableTensor-633"><span class="linenos">633</span></a>        <span class="n">affine</span> <span class="o">=</span> <span class="n">DiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="MappableTensor-634"><a href="#MappableTensor-634"><span class="linenos">634</span></a>            <span class="n">translation</span><span class="o">=</span><span class="n">other</span><span class="p">,</span>
</span><span id="MappableTensor-635"><a href="#MappableTensor-635"><span class="linenos">635</span></a>            <span class="n">matrix_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="MappableTensor-636"><a href="#MappableTensor-636"><span class="linenos">636</span></a>            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="MappableTensor-637"><a href="#MappableTensor-637"><span class="linenos">637</span></a>            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="MappableTensor-638"><a href="#MappableTensor-638"><span class="linenos">638</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-639"><a href="#MappableTensor-639"><span class="linenos">639</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>
</span><span id="MappableTensor-640"><a href="#MappableTensor-640"><span class="linenos">640</span></a>
</span><span id="MappableTensor-641"><a href="#MappableTensor-641"><span class="linenos">641</span></a>    <span class="k">def</span> <span class="nf">_add_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-642"><a href="#MappableTensor-642"><span class="linenos">642</span></a>        <span class="n">n_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MappableTensor-643"><a href="#MappableTensor-643"><span class="linenos">643</span></a>        <span class="n">affine</span> <span class="o">=</span> <span class="n">HostDiagonalAffineTransformation</span><span class="p">(</span>
</span><span id="MappableTensor-644"><a href="#MappableTensor-644"><span class="linenos">644</span></a>            <span class="n">translation</span><span class="o">=</span><span class="n">other</span><span class="p">,</span>
</span><span id="MappableTensor-645"><a href="#MappableTensor-645"><span class="linenos">645</span></a>            <span class="n">matrix_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="MappableTensor-646"><a href="#MappableTensor-646"><span class="linenos">646</span></a>            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="MappableTensor-647"><a href="#MappableTensor-647"><span class="linenos">647</span></a>            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="MappableTensor-648"><a href="#MappableTensor-648"><span class="linenos">648</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-649"><a href="#MappableTensor-649"><span class="linenos">649</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">affine</span><span class="p">)</span>
</span><span id="MappableTensor-650"><a href="#MappableTensor-650"><span class="linenos">650</span></a>
</span><span id="MappableTensor-651"><a href="#MappableTensor-651"><span class="linenos">651</span></a>    <span class="k">def</span> <span class="nf">_add_mappable_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-652"><a href="#MappableTensor-652"><span class="linenos">652</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">combine_optional_masks</span><span class="p">(</span>
</span><span id="MappableTensor-653"><a href="#MappableTensor-653"><span class="linenos">653</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">generate_mask</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="MappableTensor-654"><a href="#MappableTensor-654"><span class="linenos">654</span></a>            <span class="n">other</span><span class="o">.</span><span class="n">generate_mask</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span><span id="MappableTensor-655"><a href="#MappableTensor-655"><span class="linenos">655</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">),</span>
</span><span id="MappableTensor-656"><a href="#MappableTensor-656"><span class="linenos">656</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-657"><a href="#MappableTensor-657"><span class="linenos">657</span></a>        <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-658"><a href="#MappableTensor-658"><span class="linenos">658</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-659"><a href="#MappableTensor-659"><span class="linenos">659</span></a>            <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridDefinition</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">grid</span>
</span><span id="MappableTensor-660"><a href="#MappableTensor-660"><span class="linenos">660</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-661"><a href="#MappableTensor-661"><span class="linenos">661</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span>
</span><span id="MappableTensor-662"><a href="#MappableTensor-662"><span class="linenos">662</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor-663"><a href="#MappableTensor-663"><span class="linenos">663</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">grid</span>
</span><span id="MappableTensor-664"><a href="#MappableTensor-664"><span class="linenos">664</span></a>
</span><span id="MappableTensor-665"><a href="#MappableTensor-665"><span class="linenos">665</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacements</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-666"><a href="#MappableTensor-666"><span class="linenos">666</span></a>            <span class="n">displacements</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">displacements</span>
</span><span id="MappableTensor-667"><a href="#MappableTensor-667"><span class="linenos">667</span></a>            <span class="n">affine_transformation</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">affine_transformation</span>
</span><span id="MappableTensor-668"><a href="#MappableTensor-668"><span class="linenos">668</span></a>        <span class="k">elif</span> <span class="n">other</span><span class="o">.</span><span class="n">displacements</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-669"><a href="#MappableTensor-669"><span class="linenos">669</span></a>            <span class="n">displacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacements</span>
</span><span id="MappableTensor-670"><a href="#MappableTensor-670"><span class="linenos">670</span></a>            <span class="n">affine_transformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine_transformation</span>
</span><span id="MappableTensor-671"><a href="#MappableTensor-671"><span class="linenos">671</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor-672"><a href="#MappableTensor-672"><span class="linenos">672</span></a>            <span class="k">assert</span> <span class="p">(</span>
</span><span id="MappableTensor-673"><a href="#MappableTensor-673"><span class="linenos">673</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">affine_transformation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">affine_transformation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="MappableTensor-674"><a href="#MappableTensor-674"><span class="linenos">674</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-675"><a href="#MappableTensor-675"><span class="linenos">675</span></a>            <span class="n">self_displacements</span><span class="p">,</span> <span class="n">other_displacements</span> <span class="o">=</span> <span class="n">broadcast_tensors_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor-676"><a href="#MappableTensor-676"><span class="linenos">676</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">affine_transformation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displacements</span><span class="p">),</span>
</span><span id="MappableTensor-677"><a href="#MappableTensor-677"><span class="linenos">677</span></a>                <span class="n">other</span><span class="o">.</span><span class="n">affine_transformation</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">displacements</span><span class="p">),</span>
</span><span id="MappableTensor-678"><a href="#MappableTensor-678"><span class="linenos">678</span></a>                <span class="n">n_channel_dims</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">n_channel_dims</span><span class="p">),</span>
</span><span id="MappableTensor-679"><a href="#MappableTensor-679"><span class="linenos">679</span></a>            <span class="p">)</span>
</span><span id="MappableTensor-680"><a href="#MappableTensor-680"><span class="linenos">680</span></a>            <span class="n">displacements</span> <span class="o">=</span> <span class="n">self_displacements</span> <span class="o">+</span> <span class="n">other_displacements</span>
</span><span id="MappableTensor-681"><a href="#MappableTensor-681"><span class="linenos">681</span></a>            <span class="n">affine_transformation</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor-682"><a href="#MappableTensor-682"><span class="linenos">682</span></a>
</span><span id="MappableTensor-683"><a href="#MappableTensor-683"><span class="linenos">683</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor-684"><a href="#MappableTensor-684"><span class="linenos">684</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="n">displacements</span><span class="p">,</span>
</span><span id="MappableTensor-685"><a href="#MappableTensor-685"><span class="linenos">685</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor-686"><a href="#MappableTensor-686"><span class="linenos">686</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-687"><a href="#MappableTensor-687"><span class="linenos">687</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="n">affine_transformation</span><span class="p">,</span>
</span><span id="MappableTensor-688"><a href="#MappableTensor-688"><span class="linenos">688</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
</span><span id="MappableTensor-689"><a href="#MappableTensor-689"><span class="linenos">689</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-690"><a href="#MappableTensor-690"><span class="linenos">690</span></a>
</span><span id="MappableTensor-691"><a href="#MappableTensor-691"><span class="linenos">691</span></a>    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;MappableTensor&quot;</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-692"><a href="#MappableTensor-692"><span class="linenos">692</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="o">-</span><span class="n">other</span><span class="p">)</span>
</span><span id="MappableTensor-693"><a href="#MappableTensor-693"><span class="linenos">693</span></a>
</span><span id="MappableTensor-694"><a href="#MappableTensor-694"><span class="linenos">694</span></a>    <span class="k">def</span> <span class="fm">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-695"><a href="#MappableTensor-695"><span class="linenos">695</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor-696"><a href="#MappableTensor-696"><span class="linenos">696</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="p">,</span>
</span><span id="MappableTensor-697"><a href="#MappableTensor-697"><span class="linenos">697</span></a>            <span class="n">mask</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor-698"><a href="#MappableTensor-698"><span class="linenos">698</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-699"><a href="#MappableTensor-699"><span class="linenos">699</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="p">(</span>
</span><span id="MappableTensor-700"><a href="#MappableTensor-700"><span class="linenos">700</span></a>                <span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span>
</span><span id="MappableTensor-701"><a href="#MappableTensor-701"><span class="linenos">701</span></a>            <span class="p">),</span>
</span><span id="MappableTensor-702"><a href="#MappableTensor-702"><span class="linenos">702</span></a>            <span class="n">grid</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="p">),</span>
</span><span id="MappableTensor-703"><a href="#MappableTensor-703"><span class="linenos">703</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-704"><a href="#MappableTensor-704"><span class="linenos">704</span></a>
</span><span id="MappableTensor-705"><a href="#MappableTensor-705"><span class="linenos">705</span></a>    <span class="k">def</span> <span class="nf">has_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="MappableTensor-706"><a href="#MappableTensor-706"><span class="linenos">706</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Has the mappable tensor an explicit mask&quot;&quot;&quot;</span>
</span><span id="MappableTensor-707"><a href="#MappableTensor-707"><span class="linenos">707</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="MappableTensor-708"><a href="#MappableTensor-708"><span class="linenos">708</span></a>
</span><span id="MappableTensor-709"><a href="#MappableTensor-709"><span class="linenos">709</span></a>    <span class="k">def</span> <span class="nf">clear_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-710"><a href="#MappableTensor-710"><span class="linenos">710</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear mask from the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor-711"><a href="#MappableTensor-711"><span class="linenos">711</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_mask</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="MappableTensor-712"><a href="#MappableTensor-712"><span class="linenos">712</span></a>
</span><span id="MappableTensor-713"><a href="#MappableTensor-713"><span class="linenos">713</span></a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-714"><a href="#MappableTensor-714"><span class="linenos">714</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reduce the masked tensor to a mappable tensor with values and mask</span>
</span><span id="MappableTensor-715"><a href="#MappableTensor-715"><span class="linenos">715</span></a><span class="sd">        stored explicitly.&quot;&quot;&quot;</span>
</span><span id="MappableTensor-716"><a href="#MappableTensor-716"><span class="linenos">716</span></a>        <span class="n">values</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MappableTensor-717"><a href="#MappableTensor-717"><span class="linenos">717</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor-718"><a href="#MappableTensor-718"><span class="linenos">718</span></a>            <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
</span><span id="MappableTensor-719"><a href="#MappableTensor-719"><span class="linenos">719</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor-720"><a href="#MappableTensor-720"><span class="linenos">720</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-721"><a href="#MappableTensor-721"><span class="linenos">721</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-722"><a href="#MappableTensor-722"><span class="linenos">722</span></a>
</span><span id="MappableTensor-723"><a href="#MappableTensor-723"><span class="linenos">723</span></a>    <span class="k">def</span> <span class="nf">modify_values</span><span class="p">(</span>
</span><span id="MappableTensor-724"><a href="#MappableTensor-724"><span class="linenos">724</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor-725"><a href="#MappableTensor-725"><span class="linenos">725</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-726"><a href="#MappableTensor-726"><span class="linenos">726</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify values of the mappable tensor.</span>
</span><span id="MappableTensor-727"><a href="#MappableTensor-727"><span class="linenos">727</span></a>
</span><span id="MappableTensor-728"><a href="#MappableTensor-728"><span class="linenos">728</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor-729"><a href="#MappableTensor-729"><span class="linenos">729</span></a><span class="sd">            values: New values of the mappable tensor. Tensor with shape</span>
</span><span id="MappableTensor-730"><a href="#MappableTensor-730"><span class="linenos">730</span></a><span class="sd">                (*batch_shape, *channels_shape, *spatial_shape).</span>
</span><span id="MappableTensor-731"><a href="#MappableTensor-731"><span class="linenos">731</span></a><span class="sd">            n_channel_dims: Number of channel dimensions of the new values.</span>
</span><span id="MappableTensor-732"><a href="#MappableTensor-732"><span class="linenos">732</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-733"><a href="#MappableTensor-733"><span class="linenos">733</span></a>        <span class="k">if</span> <span class="n">n_channel_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-734"><a href="#MappableTensor-734"><span class="linenos">734</span></a>            <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span>
</span><span id="MappableTensor-735"><a href="#MappableTensor-735"><span class="linenos">735</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span>
</span><span id="MappableTensor-736"><a href="#MappableTensor-736"><span class="linenos">736</span></a>        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor-737"><a href="#MappableTensor-737"><span class="linenos">737</span></a>            <span class="n">batch_shape</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">split_shape</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="MappableTensor-738"><a href="#MappableTensor-738"><span class="linenos">738</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="n">n_channel_dims</span> <span class="o">+</span> <span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="MappableTensor-739"><a href="#MappableTensor-739"><span class="linenos">739</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor-740"><a href="#MappableTensor-740"><span class="linenos">740</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
</span><span id="MappableTensor-741"><a href="#MappableTensor-741"><span class="linenos">741</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor-742"><a href="#MappableTensor-742"><span class="linenos">742</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-743"><a href="#MappableTensor-743"><span class="linenos">743</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-744"><a href="#MappableTensor-744"><span class="linenos">744</span></a>            <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor-745"><a href="#MappableTensor-745"><span class="linenos">745</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-746"><a href="#MappableTensor-746"><span class="linenos">746</span></a>
</span><span id="MappableTensor-747"><a href="#MappableTensor-747"><span class="linenos">747</span></a>    <span class="k">def</span> <span class="nf">mask_and</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-748"><a href="#MappableTensor-748"><span class="linenos">748</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine mask with logical and.</span>
</span><span id="MappableTensor-749"><a href="#MappableTensor-749"><span class="linenos">749</span></a>
</span><span id="MappableTensor-750"><a href="#MappableTensor-750"><span class="linenos">750</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor-751"><a href="#MappableTensor-751"><span class="linenos">751</span></a><span class="sd">            mask: Mask to combine with the mappable tensor.</span>
</span><span id="MappableTensor-752"><a href="#MappableTensor-752"><span class="linenos">752</span></a>
</span><span id="MappableTensor-753"><a href="#MappableTensor-753"><span class="linenos">753</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor-754"><a href="#MappableTensor-754"><span class="linenos">754</span></a><span class="sd">            Mappable tensor with the combined mask.</span>
</span><span id="MappableTensor-755"><a href="#MappableTensor-755"><span class="linenos">755</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-756"><a href="#MappableTensor-756"><span class="linenos">756</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_mask</span><span class="p">(</span>
</span><span id="MappableTensor-757"><a href="#MappableTensor-757"><span class="linenos">757</span></a>            <span class="n">combine_optional_masks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor-758"><a href="#MappableTensor-758"><span class="linenos">758</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-759"><a href="#MappableTensor-759"><span class="linenos">759</span></a>
</span><span id="MappableTensor-760"><a href="#MappableTensor-760"><span class="linenos">760</span></a>    <span class="k">def</span> <span class="nf">modify_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor-761"><a href="#MappableTensor-761"><span class="linenos">761</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify mask of the mappable tensor.</span>
</span><span id="MappableTensor-762"><a href="#MappableTensor-762"><span class="linenos">762</span></a>
</span><span id="MappableTensor-763"><a href="#MappableTensor-763"><span class="linenos">763</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor-764"><a href="#MappableTensor-764"><span class="linenos">764</span></a><span class="sd">            mask: New mask of the mappable tensor.</span>
</span><span id="MappableTensor-765"><a href="#MappableTensor-765"><span class="linenos">765</span></a>
</span><span id="MappableTensor-766"><a href="#MappableTensor-766"><span class="linenos">766</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor-767"><a href="#MappableTensor-767"><span class="linenos">767</span></a><span class="sd">            Mappable tensor with the new mask.</span>
</span><span id="MappableTensor-768"><a href="#MappableTensor-768"><span class="linenos">768</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor-769"><a href="#MappableTensor-769"><span class="linenos">769</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor-770"><a href="#MappableTensor-770"><span class="linenos">770</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="p">,</span>
</span><span id="MappableTensor-771"><a href="#MappableTensor-771"><span class="linenos">771</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor-772"><a href="#MappableTensor-772"><span class="linenos">772</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor-773"><a href="#MappableTensor-773"><span class="linenos">773</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span><span class="p">,</span>
</span><span id="MappableTensor-774"><a href="#MappableTensor-774"><span class="linenos">774</span></a>            <span class="n">grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="p">,</span>
</span><span id="MappableTensor-775"><a href="#MappableTensor-775"><span class="linenos">775</span></a>        <span class="p">)</span>
</span><span id="MappableTensor-776"><a href="#MappableTensor-776"><span class="linenos">776</span></a>
</span><span id="MappableTensor-777"><a href="#MappableTensor-777"><span class="linenos">777</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="MappableTensor-778"><a href="#MappableTensor-778"><span class="linenos">778</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="MappableTensor-779"><a href="#MappableTensor-779"><span class="linenos">779</span></a>            <span class="sa">f</span><span class="s2">&quot;MappableTensor(&quot;</span>
</span><span id="MappableTensor-780"><a href="#MappableTensor-780"><span class="linenos">780</span></a>            <span class="sa">f</span><span class="s2">&quot;displacements=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="MappableTensor-781"><a href="#MappableTensor-781"><span class="linenos">781</span></a>            <span class="sa">f</span><span class="s2">&quot;mask=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="MappableTensor-782"><a href="#MappableTensor-782"><span class="linenos">782</span></a>            <span class="sa">f</span><span class="s2">&quot;n_channel_dims=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="MappableTensor-783"><a href="#MappableTensor-783"><span class="linenos">783</span></a>            <span class="sa">f</span><span class="s2">&quot;affine_transformation=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="MappableTensor-784"><a href="#MappableTensor-784"><span class="linenos">784</span></a>            <span class="sa">f</span><span class="s2">&quot;grid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="MappableTensor-785"><a href="#MappableTensor-785"><span class="linenos">785</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A tensor wrapper used as inputs for composable mappings</p>

<p>It is not recommended to create instances of this class directly, but to
use instead the constructors provided in the module, or as class methods
of this class: <code><a href="#mappable">mappable</a></code>, <code><a href="#MappableTensor.voxel_grid">voxel_grid</a></code>, <code><a href="#MappableTensor.from_tensor">MappableTensor.from_tensor</a></code>,
<code><a href="#MappableTensor.voxel_grid">MappableTensor.voxel_grid</a></code>.</p>

<p>The core idea of the mappable tensor is that affine transformations applied
to the tensor are not applied right away, but only when the values are
generated. This allows for more efficient computation. Additionally,
representing voxel coordinate grids and their transformations without
generating the grid is possible. Such grids can be also combined with
displacement vectors, still without generating the grid.</p>

<p>Masks can also be used to define valid regions of the tensor.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>displacements:</strong>  Displacement vectors, tensor with shape
(*batch_shape, *channels_shape, *spatial_shape).</li>
<li><strong>mask:</strong>  Mask of the tensor with shape (*batch_shape, *(1,) *
n_channel_dims, *spatial_shape).</li>
<li><strong>n_channel_dims:</strong>  Number of channel dimensions.</li>
<li><strong>affine_transformation:</strong>  Affine transformation acting on the displacements.</li>
<li><strong>grid:</strong>  Definition of a grid added to the displacements.</li>
</ul>
</div>


                            <div id="MappableTensor.__init__" class="classattr">
                                        <input id="MappableTensor.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">MappableTensor</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">displacements</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">affine_transformation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n"><a href="affine_transformation.html#IAffineTransformation">composable_mapping.affine_transformation.IAffineTransformation</a></span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">grid</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">composable_mapping</span><span class="o">.</span><span class="n">mappable_tensor</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">GridDefinition</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="MappableTensor.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.__init__-65"><a href="#MappableTensor.__init__-65"><span class="linenos">65</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="MappableTensor.__init__-66"><a href="#MappableTensor.__init__-66"><span class="linenos">66</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor.__init__-67"><a href="#MappableTensor.__init__-67"><span class="linenos">67</span></a>        <span class="n">displacements</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.__init__-68"><a href="#MappableTensor.__init__-68"><span class="linenos">68</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.__init__-69"><a href="#MappableTensor.__init__-69"><span class="linenos">69</span></a>        <span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="MappableTensor.__init__-70"><a href="#MappableTensor.__init__-70"><span class="linenos">70</span></a>        <span class="n">affine_transformation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IAffineTransformation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.__init__-71"><a href="#MappableTensor.__init__-71"><span class="linenos">71</span></a>        <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridDefinition</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.__init__-72"><a href="#MappableTensor.__init__-72"><span class="linenos">72</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.__init__-73"><a href="#MappableTensor.__init__-73"><span class="linenos">73</span></a>        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.__init__-74"><a href="#MappableTensor.__init__-74"><span class="linenos">74</span></a>            <span class="n">mask_channels_shape</span> <span class="o">=</span> <span class="n">get_channels_shape</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor.__init__-75"><a href="#MappableTensor.__init__-75"><span class="linenos">75</span></a>            <span class="k">if</span> <span class="n">mask_channels_shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="n">n_channel_dims</span><span class="p">:</span>
</span><span id="MappableTensor.__init__-76"><a href="#MappableTensor.__init__-76"><span class="linenos">76</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mask must dimension with size 1 in all channel dimensions&quot;</span><span class="p">)</span>
</span><span id="MappableTensor.__init__-77"><a href="#MappableTensor.__init__-77"><span class="linenos">77</span></a>        <span class="k">if</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_channel_dims</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MappableTensor.__init__-78"><a href="#MappableTensor.__init__-78"><span class="linenos">78</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;When no displacements is set, n_channel_dims must be 1&quot;</span><span class="p">)</span>
</span><span id="MappableTensor.__init__-79"><a href="#MappableTensor.__init__-79"><span class="linenos">79</span></a>        <span class="k">if</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.__init__-80"><a href="#MappableTensor.__init__-80"><span class="linenos">80</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either displacements, or grid must be set.&quot;</span><span class="p">)</span>
</span><span id="MappableTensor.__init__-81"><a href="#MappableTensor.__init__-81"><span class="linenos">81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span> <span class="o">=</span> <span class="n">displacements</span>
</span><span id="MappableTensor.__init__-82"><a href="#MappableTensor.__init__-82"><span class="linenos">82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="o">=</span> <span class="n">mask</span>
</span><span id="MappableTensor.__init__-83"><a href="#MappableTensor.__init__-83"><span class="linenos">83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span> <span class="o">=</span> <span class="n">n_channel_dims</span>
</span><span id="MappableTensor.__init__-84"><a href="#MappableTensor.__init__-84"><span class="linenos">84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MappableTensor.__init__-85"><a href="#MappableTensor.__init__-85"><span class="linenos">85</span></a>            <span class="n">IdentityAffineTransformation</span><span class="p">(</span>
</span><span id="MappableTensor.__init__-86"><a href="#MappableTensor.__init__-86"><span class="linenos">86</span></a>                <span class="n">get_channels_shape</span><span class="p">(</span><span class="n">displacements</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="MappableTensor.__init__-87"><a href="#MappableTensor.__init__-87"><span class="linenos">87</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="n">displacements</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
</span><span id="MappableTensor.__init__-88"><a href="#MappableTensor.__init__-88"><span class="linenos">88</span></a>                <span class="n">device</span><span class="o">=</span><span class="n">displacements</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="MappableTensor.__init__-89"><a href="#MappableTensor.__init__-89"><span class="linenos">89</span></a>            <span class="p">)</span>
</span><span id="MappableTensor.__init__-90"><a href="#MappableTensor.__init__-90"><span class="linenos">90</span></a>            <span class="k">if</span> <span class="n">affine_transformation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="MappableTensor.__init__-91"><a href="#MappableTensor.__init__-91"><span class="linenos">91</span></a>            <span class="k">else</span> <span class="n">affine_transformation</span>
</span><span id="MappableTensor.__init__-92"><a href="#MappableTensor.__init__-92"><span class="linenos">92</span></a>        <span class="p">)</span>
</span><span id="MappableTensor.__init__-93"><a href="#MappableTensor.__init__-93"><span class="linenos">93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="o">=</span> <span class="n">grid</span>
</span><span id="MappableTensor.__init__-94"><a href="#MappableTensor.__init__-94"><span class="linenos">94</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_shape</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="MappableTensor.from_tensor" class="classattr">
                                        <input id="MappableTensor.from_tensor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_tensor</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">values</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="MappableTensor.from_tensor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.from_tensor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.from_tensor-96"><a href="#MappableTensor.from_tensor-96"><span class="linenos"> 96</span></a>    <span class="nd">@classmethod</span>
</span><span id="MappableTensor.from_tensor-97"><a href="#MappableTensor.from_tensor-97"><span class="linenos"> 97</span></a>    <span class="k">def</span> <span class="nf">from_tensor</span><span class="p">(</span>
</span><span id="MappableTensor.from_tensor-98"><a href="#MappableTensor.from_tensor-98"><span class="linenos"> 98</span></a>        <span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MappableTensor.from_tensor-99"><a href="#MappableTensor.from_tensor-99"><span class="linenos"> 99</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor.from_tensor-100"><a href="#MappableTensor.from_tensor-100"><span class="linenos">100</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a mappable tensor from values and mask</span>
</span><span id="MappableTensor.from_tensor-101"><a href="#MappableTensor.from_tensor-101"><span class="linenos">101</span></a>
</span><span id="MappableTensor.from_tensor-102"><a href="#MappableTensor.from_tensor-102"><span class="linenos">102</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor.from_tensor-103"><a href="#MappableTensor.from_tensor-103"><span class="linenos">103</span></a><span class="sd">            values: Values of the generated mappable tensor, tensor with shape</span>
</span><span id="MappableTensor.from_tensor-104"><a href="#MappableTensor.from_tensor-104"><span class="linenos">104</span></a><span class="sd">                (*batch_shape, *channels_shape, *spatial_shape).</span>
</span><span id="MappableTensor.from_tensor-105"><a href="#MappableTensor.from_tensor-105"><span class="linenos">105</span></a><span class="sd">            mask: Mask of the generated mapable tensor with shape</span>
</span><span id="MappableTensor.from_tensor-106"><a href="#MappableTensor.from_tensor-106"><span class="linenos">106</span></a><span class="sd">                (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</span>
</span><span id="MappableTensor.from_tensor-107"><a href="#MappableTensor.from_tensor-107"><span class="linenos">107</span></a><span class="sd">            n_channel_dims: Number of channel dimensions.</span>
</span><span id="MappableTensor.from_tensor-108"><a href="#MappableTensor.from_tensor-108"><span class="linenos">108</span></a>
</span><span id="MappableTensor.from_tensor-109"><a href="#MappableTensor.from_tensor-109"><span class="linenos">109</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor.from_tensor-110"><a href="#MappableTensor.from_tensor-110"><span class="linenos">110</span></a><span class="sd">            Mappable tensor.</span>
</span><span id="MappableTensor.from_tensor-111"><a href="#MappableTensor.from_tensor-111"><span class="linenos">111</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.from_tensor-112"><a href="#MappableTensor.from_tensor-112"><span class="linenos">112</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span><span class="n">displacements</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a mappable tensor from values and mask</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>values:</strong>  Values of the generated mappable tensor, tensor with shape
(*batch_shape, *channels_shape, *spatial_shape).</li>
<li><strong>mask:</strong>  Mask of the generated mapable tensor with shape
(*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</li>
<li><strong>n_channel_dims:</strong>  Number of channel dimensions.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Mappable tensor.</p>
</blockquote>
</div>


                            </div>
                            <div id="MappableTensor.voxel_grid" class="classattr">
                                        <input id="MappableTensor.voxel_grid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">voxel_grid</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">cls</span>,</span><span class="param">	<span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="MappableTensor.voxel_grid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.voxel_grid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.voxel_grid-114"><a href="#MappableTensor.voxel_grid-114"><span class="linenos">114</span></a>    <span class="nd">@classmethod</span>
</span><span id="MappableTensor.voxel_grid-115"><a href="#MappableTensor.voxel_grid-115"><span class="linenos">115</span></a>    <span class="k">def</span> <span class="nf">voxel_grid</span><span class="p">(</span>
</span><span id="MappableTensor.voxel_grid-116"><a href="#MappableTensor.voxel_grid-116"><span class="linenos">116</span></a>        <span class="bp">cls</span><span class="p">,</span>
</span><span id="MappableTensor.voxel_grid-117"><a href="#MappableTensor.voxel_grid-117"><span class="linenos">117</span></a>        <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="MappableTensor.voxel_grid-118"><a href="#MappableTensor.voxel_grid-118"><span class="linenos">118</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.voxel_grid-119"><a href="#MappableTensor.voxel_grid-119"><span class="linenos">119</span></a>        <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.voxel_grid-120"><a href="#MappableTensor.voxel_grid-120"><span class="linenos">120</span></a>        <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.voxel_grid-121"><a href="#MappableTensor.voxel_grid-121"><span class="linenos">121</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor.voxel_grid-122"><a href="#MappableTensor.voxel_grid-122"><span class="linenos">122</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a voxel grid with optional mask.</span>
</span><span id="MappableTensor.voxel_grid-123"><a href="#MappableTensor.voxel_grid-123"><span class="linenos">123</span></a>
</span><span id="MappableTensor.voxel_grid-124"><a href="#MappableTensor.voxel_grid-124"><span class="linenos">124</span></a><span class="sd">        The voxel grid is not generated explicitly right away, but only when the</span>
</span><span id="MappableTensor.voxel_grid-125"><a href="#MappableTensor.voxel_grid-125"><span class="linenos">125</span></a><span class="sd">        values are generated.</span>
</span><span id="MappableTensor.voxel_grid-126"><a href="#MappableTensor.voxel_grid-126"><span class="linenos">126</span></a>
</span><span id="MappableTensor.voxel_grid-127"><a href="#MappableTensor.voxel_grid-127"><span class="linenos">127</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor.voxel_grid-128"><a href="#MappableTensor.voxel_grid-128"><span class="linenos">128</span></a><span class="sd">            spatial_shape: Spatial shape of the created grid.</span>
</span><span id="MappableTensor.voxel_grid-129"><a href="#MappableTensor.voxel_grid-129"><span class="linenos">129</span></a><span class="sd">            mask: Mask of the grid with shape</span>
</span><span id="MappableTensor.voxel_grid-130"><a href="#MappableTensor.voxel_grid-130"><span class="linenos">130</span></a><span class="sd">                (*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</span>
</span><span id="MappableTensor.voxel_grid-131"><a href="#MappableTensor.voxel_grid-131"><span class="linenos">131</span></a><span class="sd">            dtype: Data type of the grid.</span>
</span><span id="MappableTensor.voxel_grid-132"><a href="#MappableTensor.voxel_grid-132"><span class="linenos">132</span></a><span class="sd">            device: Device of the grid.</span>
</span><span id="MappableTensor.voxel_grid-133"><a href="#MappableTensor.voxel_grid-133"><span class="linenos">133</span></a>
</span><span id="MappableTensor.voxel_grid-134"><a href="#MappableTensor.voxel_grid-134"><span class="linenos">134</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor.voxel_grid-135"><a href="#MappableTensor.voxel_grid-135"><span class="linenos">135</span></a><span class="sd">            Mappable tensor representing the voxel grid.</span>
</span><span id="MappableTensor.voxel_grid-136"><a href="#MappableTensor.voxel_grid-136"><span class="linenos">136</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.voxel_grid-137"><a href="#MappableTensor.voxel_grid-137"><span class="linenos">137</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor.voxel_grid-138"><a href="#MappableTensor.voxel_grid-138"><span class="linenos">138</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor.voxel_grid-139"><a href="#MappableTensor.voxel_grid-139"><span class="linenos">139</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="MappableTensor.voxel_grid-140"><a href="#MappableTensor.voxel_grid-140"><span class="linenos">140</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">GridDefinition</span><span class="p">(</span>
</span><span id="MappableTensor.voxel_grid-141"><a href="#MappableTensor.voxel_grid-141"><span class="linenos">141</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor.voxel_grid-142"><a href="#MappableTensor.voxel_grid-142"><span class="linenos">142</span></a>                <span class="n">affine_transformation</span><span class="o">=</span><span class="n">IdentityAffineTransformation</span><span class="p">(</span>
</span><span id="MappableTensor.voxel_grid-143"><a href="#MappableTensor.voxel_grid-143"><span class="linenos">143</span></a>                    <span class="nb">len</span><span class="p">(</span><span class="n">spatial_shape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
</span><span id="MappableTensor.voxel_grid-144"><a href="#MappableTensor.voxel_grid-144"><span class="linenos">144</span></a>                <span class="p">),</span>
</span><span id="MappableTensor.voxel_grid-145"><a href="#MappableTensor.voxel_grid-145"><span class="linenos">145</span></a>            <span class="p">),</span>
</span><span id="MappableTensor.voxel_grid-146"><a href="#MappableTensor.voxel_grid-146"><span class="linenos">146</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a voxel grid with optional mask.</p>

<p>The voxel grid is not generated explicitly right away, but only when the
values are generated.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>spatial_shape:</strong>  Spatial shape of the created grid.</li>
<li><strong>mask:</strong>  Mask of the grid with shape
(*batch_shape, *(1,) * n_channel_dims, *spatial_shape).</li>
<li><strong>dtype:</strong>  Data type of the grid.</li>
<li><strong>device:</strong>  Device of the grid.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Mappable tensor representing the voxel grid.</p>
</blockquote>
</div>


                            </div>
                            <div id="MappableTensor.shape" class="classattr">
                                        <input id="MappableTensor.shape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">shape</span><span class="annotation">: Tuple[int, ...]</span>

                <label class="view-source-button" for="MappableTensor.shape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.shape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.shape-213"><a href="#MappableTensor.shape-213"><span class="linenos">213</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.shape-214"><a href="#MappableTensor.shape-214"><span class="linenos">214</span></a>    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor.shape-215"><a href="#MappableTensor.shape-215"><span class="linenos">215</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Shape of the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor.shape-216"><a href="#MappableTensor.shape-216"><span class="linenos">216</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>
</span></pre></div>


            <div class="docstring"><p>Shape of the mappable tensor</p>
</div>


                            </div>
                            <div id="MappableTensor.spatial_shape" class="classattr">
                                        <input id="MappableTensor.spatial_shape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">spatial_shape</span><span class="annotation">: Tuple[int, ...]</span>

                <label class="view-source-button" for="MappableTensor.spatial_shape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.spatial_shape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.spatial_shape-218"><a href="#MappableTensor.spatial_shape-218"><span class="linenos">218</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.spatial_shape-219"><a href="#MappableTensor.spatial_shape-219"><span class="linenos">219</span></a>    <span class="k">def</span> <span class="nf">spatial_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor.spatial_shape-220"><a href="#MappableTensor.spatial_shape-220"><span class="linenos">220</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Spatial shape of the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor.spatial_shape-221"><a href="#MappableTensor.spatial_shape-221"><span class="linenos">221</span></a>        <span class="k">return</span> <span class="n">get_spatial_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Spatial shape of the mappable tensor</p>
</div>


                            </div>
                            <div id="MappableTensor.channels_shape" class="classattr">
                                        <input id="MappableTensor.channels_shape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">channels_shape</span><span class="annotation">: Tuple[int, ...]</span>

                <label class="view-source-button" for="MappableTensor.channels_shape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.channels_shape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.channels_shape-223"><a href="#MappableTensor.channels_shape-223"><span class="linenos">223</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.channels_shape-224"><a href="#MappableTensor.channels_shape-224"><span class="linenos">224</span></a>    <span class="k">def</span> <span class="nf">channels_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor.channels_shape-225"><a href="#MappableTensor.channels_shape-225"><span class="linenos">225</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Channel shape of the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor.channels_shape-226"><a href="#MappableTensor.channels_shape-226"><span class="linenos">226</span></a>        <span class="k">return</span> <span class="n">get_channels_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Channel shape of the mappable tensor</p>
</div>


                            </div>
                            <div id="MappableTensor.batch_shape" class="classattr">
                                        <input id="MappableTensor.batch_shape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">batch_shape</span><span class="annotation">: Tuple[int, ...]</span>

                <label class="view-source-button" for="MappableTensor.batch_shape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.batch_shape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.batch_shape-228"><a href="#MappableTensor.batch_shape-228"><span class="linenos">228</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.batch_shape-229"><a href="#MappableTensor.batch_shape-229"><span class="linenos">229</span></a>    <span class="k">def</span> <span class="nf">batch_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor.batch_shape-230"><a href="#MappableTensor.batch_shape-230"><span class="linenos">230</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Batch shape of the mappable tensor.&quot;&quot;&quot;</span>
</span><span id="MappableTensor.batch_shape-231"><a href="#MappableTensor.batch_shape-231"><span class="linenos">231</span></a>        <span class="k">return</span> <span class="n">get_batch_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Batch shape of the mappable tensor.</p>
</div>


                            </div>
                            <div id="MappableTensor.mask_shape" class="classattr">
                                        <input id="MappableTensor.mask_shape-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">mask_shape</span><span class="annotation">: Tuple[int, ...]</span>

                <label class="view-source-button" for="MappableTensor.mask_shape-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.mask_shape"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.mask_shape-233"><a href="#MappableTensor.mask_shape-233"><span class="linenos">233</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.mask_shape-234"><a href="#MappableTensor.mask_shape-234"><span class="linenos">234</span></a>    <span class="k">def</span> <span class="nf">mask_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
</span><span id="MappableTensor.mask_shape-235"><a href="#MappableTensor.mask_shape-235"><span class="linenos">235</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Shape of the generated mask of the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor.mask_shape-236"><a href="#MappableTensor.mask_shape-236"><span class="linenos">236</span></a>        <span class="k">return</span> <span class="n">reduce_channels_shape_to_ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Shape of the generated mask of the mappable tensor</p>
</div>


                            </div>
                            <div id="MappableTensor.n_channel_dims" class="classattr">
                                        <input id="MappableTensor.n_channel_dims-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">n_channel_dims</span><span class="annotation">: int</span>

                <label class="view-source-button" for="MappableTensor.n_channel_dims-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.n_channel_dims"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.n_channel_dims-238"><a href="#MappableTensor.n_channel_dims-238"><span class="linenos">238</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.n_channel_dims-239"><a href="#MappableTensor.n_channel_dims-239"><span class="linenos">239</span></a>    <span class="k">def</span> <span class="nf">n_channel_dims</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="MappableTensor.n_channel_dims-240"><a href="#MappableTensor.n_channel_dims-240"><span class="linenos">240</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of channel dimensions&quot;&quot;&quot;</span>
</span><span id="MappableTensor.n_channel_dims-241"><a href="#MappableTensor.n_channel_dims-241"><span class="linenos">241</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span></pre></div>


            <div class="docstring"><p>Number of channel dimensions</p>
</div>


                            </div>
                            <div id="MappableTensor.generate" class="classattr">
                                        <input id="MappableTensor.generate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">generate_missing_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="MappableTensor.generate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.generate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.generate-257"><a href="#MappableTensor.generate-257"><span class="linenos">257</span></a>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span>
</span><span id="MappableTensor.generate-258"><a href="#MappableTensor.generate-258"><span class="linenos">258</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor.generate-259"><a href="#MappableTensor.generate-259"><span class="linenos">259</span></a>        <span class="n">generate_missing_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="MappableTensor.generate-260"><a href="#MappableTensor.generate-260"><span class="linenos">260</span></a>        <span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="MappableTensor.generate-261"><a href="#MappableTensor.generate-261"><span class="linenos">261</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]]:</span>
</span><span id="MappableTensor.generate-262"><a href="#MappableTensor.generate-262"><span class="linenos">262</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate values and mask contained by the mappable tensor.</span>
</span><span id="MappableTensor.generate-263"><a href="#MappableTensor.generate-263"><span class="linenos">263</span></a>
</span><span id="MappableTensor.generate-264"><a href="#MappableTensor.generate-264"><span class="linenos">264</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor.generate-265"><a href="#MappableTensor.generate-265"><span class="linenos">265</span></a><span class="sd">            generate_mask: Generate mask of ones if the tensor does not contain an explicit mask.</span>
</span><span id="MappableTensor.generate-266"><a href="#MappableTensor.generate-266"><span class="linenos">266</span></a><span class="sd">            cast_mask: Mask is stored as a boolean tensor, cast it to dtype of values if True.</span>
</span><span id="MappableTensor.generate-267"><a href="#MappableTensor.generate-267"><span class="linenos">267</span></a>
</span><span id="MappableTensor.generate-268"><a href="#MappableTensor.generate-268"><span class="linenos">268</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor.generate-269"><a href="#MappableTensor.generate-269"><span class="linenos">269</span></a><span class="sd">            Tuple of values and mask.</span>
</span><span id="MappableTensor.generate-270"><a href="#MappableTensor.generate-270"><span class="linenos">270</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.generate-271"><a href="#MappableTensor.generate-271"><span class="linenos">271</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_mask</span><span class="p">(</span>
</span><span id="MappableTensor.generate-272"><a href="#MappableTensor.generate-272"><span class="linenos">272</span></a>            <span class="n">generate_missing_mask</span><span class="o">=</span><span class="n">generate_missing_mask</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="n">cast_mask</span>
</span><span id="MappableTensor.generate-273"><a href="#MappableTensor.generate-273"><span class="linenos">273</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Generate values and mask contained by the mappable tensor.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>generate_mask:</strong>  Generate mask of ones if the tensor does not contain an explicit mask.</li>
<li><strong>cast_mask:</strong>  Mask is stored as a boolean tensor, cast it to dtype of values if True.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Tuple of values and mask.</p>
</blockquote>
</div>


                            </div>
                            <div id="MappableTensor.generate_values" class="classattr">
                                        <input id="MappableTensor.generate_values-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_values</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="MappableTensor.generate_values-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.generate_values"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.generate_values-275"><a href="#MappableTensor.generate_values-275"><span class="linenos">275</span></a>    <span class="k">def</span> <span class="nf">generate_values</span><span class="p">(</span>
</span><span id="MappableTensor.generate_values-276"><a href="#MappableTensor.generate_values-276"><span class="linenos">276</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-277"><a href="#MappableTensor.generate_values-277"><span class="linenos">277</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="MappableTensor.generate_values-278"><a href="#MappableTensor.generate_values-278"><span class="linenos">278</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate values contained by the mappable tensor.&quot;&quot;&quot;</span>
</span><span id="MappableTensor.generate_values-279"><a href="#MappableTensor.generate_values-279"><span class="linenos">279</span></a>        <span class="n">batch_shape</span><span class="p">,</span> <span class="n">channels_shape</span><span class="p">,</span> <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">split_shape</span><span class="p">(</span>
</span><span id="MappableTensor.generate_values-280"><a href="#MappableTensor.generate_values-280"><span class="linenos">280</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span><span id="MappableTensor.generate_values-281"><a href="#MappableTensor.generate_values-281"><span class="linenos">281</span></a>        <span class="p">)</span>
</span><span id="MappableTensor.generate_values-282"><a href="#MappableTensor.generate_values-282"><span class="linenos">282</span></a>        <span class="n">displacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span>
</span><span id="MappableTensor.generate_values-283"><a href="#MappableTensor.generate_values-283"><span class="linenos">283</span></a>        <span class="k">if</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.generate_values-284"><a href="#MappableTensor.generate_values-284"><span class="linenos">284</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.generate_values-285"><a href="#MappableTensor.generate_values-285"><span class="linenos">285</span></a>                <span class="n">displacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span><span class="p">(</span>
</span><span id="MappableTensor.generate_values-286"><a href="#MappableTensor.generate_values-286"><span class="linenos">286</span></a>                    <span class="n">displacements</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span><span id="MappableTensor.generate_values-287"><a href="#MappableTensor.generate_values-287"><span class="linenos">287</span></a>                <span class="p">)</span>
</span><span id="MappableTensor.generate_values-288"><a href="#MappableTensor.generate_values-288"><span class="linenos">288</span></a>            <span class="n">displacements</span> <span class="o">=</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor.generate_values-289"><a href="#MappableTensor.generate_values-289"><span class="linenos">289</span></a>                <span class="n">displacements</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-290"><a href="#MappableTensor.generate_values-290"><span class="linenos">290</span></a>                <span class="n">batch_shape</span><span class="o">=</span><span class="n">batch_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-291"><a href="#MappableTensor.generate_values-291"><span class="linenos">291</span></a>                <span class="n">channels_shape</span><span class="o">=</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-292"><a href="#MappableTensor.generate_values-292"><span class="linenos">292</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-293"><a href="#MappableTensor.generate_values-293"><span class="linenos">293</span></a>                <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-294"><a href="#MappableTensor.generate_values-294"><span class="linenos">294</span></a>            <span class="p">)</span>
</span><span id="MappableTensor.generate_values-295"><a href="#MappableTensor.generate_values-295"><span class="linenos">295</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">is_zero</span><span class="p">():</span>
</span><span id="MappableTensor.generate_values-296"><a href="#MappableTensor.generate_values-296"><span class="linenos">296</span></a>            <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor.generate_values-297"><a href="#MappableTensor.generate_values-297"><span class="linenos">297</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor.generate_values-298"><a href="#MappableTensor.generate_values-298"><span class="linenos">298</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor.generate_values-299"><a href="#MappableTensor.generate_values-299"><span class="linenos">299</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">generate</span><span class="p">(),</span>
</span><span id="MappableTensor.generate_values-300"><a href="#MappableTensor.generate_values-300"><span class="linenos">300</span></a>                <span class="n">batch_shape</span><span class="o">=</span><span class="n">batch_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-301"><a href="#MappableTensor.generate_values-301"><span class="linenos">301</span></a>                <span class="n">channels_shape</span><span class="o">=</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-302"><a href="#MappableTensor.generate_values-302"><span class="linenos">302</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_values-303"><a href="#MappableTensor.generate_values-303"><span class="linenos">303</span></a>            <span class="p">)</span>
</span><span id="MappableTensor.generate_values-304"><a href="#MappableTensor.generate_values-304"><span class="linenos">304</span></a>        <span class="n">values</span> <span class="o">=</span> <span class="n">optional_add</span><span class="p">(</span><span class="n">displacements</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>
</span><span id="MappableTensor.generate_values-305"><a href="#MappableTensor.generate_values-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.generate_values-306"><a href="#MappableTensor.generate_values-306"><span class="linenos">306</span></a>            <span class="k">return</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="MappableTensor.generate_values-307"><a href="#MappableTensor.generate_values-307"><span class="linenos">307</span></a>        <span class="k">return</span> <span class="n">values</span>
</span></pre></div>


            <div class="docstring"><p>Generate values contained by the mappable tensor.</p>
</div>


                            </div>
                            <div id="MappableTensor.generate_mask" class="classattr">
                                        <input id="MappableTensor.generate_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_mask</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">generate_missing_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="MappableTensor.generate_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.generate_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.generate_mask-323"><a href="#MappableTensor.generate_mask-323"><span class="linenos">323</span></a>    <span class="k">def</span> <span class="nf">generate_mask</span><span class="p">(</span>
</span><span id="MappableTensor.generate_mask-324"><a href="#MappableTensor.generate_mask-324"><span class="linenos">324</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-325"><a href="#MappableTensor.generate_mask-325"><span class="linenos">325</span></a>        <span class="n">generate_missing_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-326"><a href="#MappableTensor.generate_mask-326"><span class="linenos">326</span></a>        <span class="n">cast_mask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-327"><a href="#MappableTensor.generate_mask-327"><span class="linenos">327</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
</span><span id="MappableTensor.generate_mask-328"><a href="#MappableTensor.generate_mask-328"><span class="linenos">328</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate mask contained by the mappable tensor.</span>
</span><span id="MappableTensor.generate_mask-329"><a href="#MappableTensor.generate_mask-329"><span class="linenos">329</span></a>
</span><span id="MappableTensor.generate_mask-330"><a href="#MappableTensor.generate_mask-330"><span class="linenos">330</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor.generate_mask-331"><a href="#MappableTensor.generate_mask-331"><span class="linenos">331</span></a><span class="sd">            generate_mask: Generate mask of ones if the tensor does not contain an explicit mask.</span>
</span><span id="MappableTensor.generate_mask-332"><a href="#MappableTensor.generate_mask-332"><span class="linenos">332</span></a><span class="sd">            cast_mask: Mask is stored as a boolean tensor, cast it to dtype of values if True.</span>
</span><span id="MappableTensor.generate_mask-333"><a href="#MappableTensor.generate_mask-333"><span class="linenos">333</span></a>
</span><span id="MappableTensor.generate_mask-334"><a href="#MappableTensor.generate_mask-334"><span class="linenos">334</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor.generate_mask-335"><a href="#MappableTensor.generate_mask-335"><span class="linenos">335</span></a><span class="sd">            Mask of the mappable tensor.</span>
</span><span id="MappableTensor.generate_mask-336"><a href="#MappableTensor.generate_mask-336"><span class="linenos">336</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.generate_mask-337"><a href="#MappableTensor.generate_mask-337"><span class="linenos">337</span></a>        <span class="n">target_dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="k">if</span> <span class="n">cast_mask</span> <span class="k">else</span> <span class="n">torch_bool</span>
</span><span id="MappableTensor.generate_mask-338"><a href="#MappableTensor.generate_mask-338"><span class="linenos">338</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.generate_mask-339"><a href="#MappableTensor.generate_mask-339"><span class="linenos">339</span></a>            <span class="n">batch_shape</span><span class="p">,</span> <span class="n">channels_shape</span><span class="p">,</span> <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">split_shape</span><span class="p">(</span>
</span><span id="MappableTensor.generate_mask-340"><a href="#MappableTensor.generate_mask-340"><span class="linenos">340</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mask_shape</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span>
</span><span id="MappableTensor.generate_mask-341"><a href="#MappableTensor.generate_mask-341"><span class="linenos">341</span></a>            <span class="p">)</span>
</span><span id="MappableTensor.generate_mask-342"><a href="#MappableTensor.generate_mask-342"><span class="linenos">342</span></a>            <span class="k">return</span> <span class="n">broadcast_to_in_parts</span><span class="p">(</span>
</span><span id="MappableTensor.generate_mask-343"><a href="#MappableTensor.generate_mask-343"><span class="linenos">343</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">target_dtype</span><span class="p">),</span>
</span><span id="MappableTensor.generate_mask-344"><a href="#MappableTensor.generate_mask-344"><span class="linenos">344</span></a>                <span class="n">batch_shape</span><span class="o">=</span><span class="n">batch_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-345"><a href="#MappableTensor.generate_mask-345"><span class="linenos">345</span></a>                <span class="n">channels_shape</span><span class="o">=</span><span class="n">channels_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-346"><a href="#MappableTensor.generate_mask-346"><span class="linenos">346</span></a>                <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-347"><a href="#MappableTensor.generate_mask-347"><span class="linenos">347</span></a>                <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-348"><a href="#MappableTensor.generate_mask-348"><span class="linenos">348</span></a>            <span class="p">)</span>
</span><span id="MappableTensor.generate_mask-349"><a href="#MappableTensor.generate_mask-349"><span class="linenos">349</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="MappableTensor.generate_mask-350"><a href="#MappableTensor.generate_mask-350"><span class="linenos">350</span></a>            <span class="n">ones</span><span class="p">(</span>
</span><span id="MappableTensor.generate_mask-351"><a href="#MappableTensor.generate_mask-351"><span class="linenos">351</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mask_shape</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-352"><a href="#MappableTensor.generate_mask-352"><span class="linenos">352</span></a>                <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-353"><a href="#MappableTensor.generate_mask-353"><span class="linenos">353</span></a>                <span class="n">dtype</span><span class="o">=</span><span class="n">target_dtype</span><span class="p">,</span>
</span><span id="MappableTensor.generate_mask-354"><a href="#MappableTensor.generate_mask-354"><span class="linenos">354</span></a>            <span class="p">)</span>
</span><span id="MappableTensor.generate_mask-355"><a href="#MappableTensor.generate_mask-355"><span class="linenos">355</span></a>            <span class="k">if</span> <span class="n">generate_missing_mask</span>
</span><span id="MappableTensor.generate_mask-356"><a href="#MappableTensor.generate_mask-356"><span class="linenos">356</span></a>            <span class="k">else</span> <span class="kc">None</span>
</span><span id="MappableTensor.generate_mask-357"><a href="#MappableTensor.generate_mask-357"><span class="linenos">357</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Generate mask contained by the mappable tensor.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>generate_mask:</strong>  Generate mask of ones if the tensor does not contain an explicit mask.</li>
<li><strong>cast_mask:</strong>  Mask is stored as a boolean tensor, cast it to dtype of values if True.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Mask of the mappable tensor.</p>
</blockquote>
</div>


                            </div>
                            <div id="MappableTensor.displacements" class="classattr">
                                        <input id="MappableTensor.displacements-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">displacements</span><span class="annotation">: Union[torch.Tensor, NoneType]</span>

                <label class="view-source-button" for="MappableTensor.displacements-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.displacements"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.displacements-359"><a href="#MappableTensor.displacements-359"><span class="linenos">359</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.displacements-360"><a href="#MappableTensor.displacements-360"><span class="linenos">360</span></a>    <span class="k">def</span> <span class="nf">displacements</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]:</span>
</span><span id="MappableTensor.displacements-361"><a href="#MappableTensor.displacements-361"><span class="linenos">361</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Displacements contained by the mappable tensor</span>
</span><span id="MappableTensor.displacements-362"><a href="#MappableTensor.displacements-362"><span class="linenos">362</span></a>
</span><span id="MappableTensor.displacements-363"><a href="#MappableTensor.displacements-363"><span class="linenos">363</span></a><span class="sd">        The displacements vector might not have the same shape as the mappable</span>
</span><span id="MappableTensor.displacements-364"><a href="#MappableTensor.displacements-364"><span class="linenos">364</span></a><span class="sd">        tensor, but is brodcastable to it. This is a relatively low level</span>
</span><span id="MappableTensor.displacements-365"><a href="#MappableTensor.displacements-365"><span class="linenos">365</span></a><span class="sd">        property and the recommended way to access the values is through the</span>
</span><span id="MappableTensor.displacements-366"><a href="#MappableTensor.displacements-366"><span class="linenos">366</span></a><span class="sd">        `generate_values` method.</span>
</span><span id="MappableTensor.displacements-367"><a href="#MappableTensor.displacements-367"><span class="linenos">367</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.displacements-368"><a href="#MappableTensor.displacements-368"><span class="linenos">368</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span>
</span></pre></div>


            <div class="docstring"><p>Displacements contained by the mappable tensor</p>

<p>The displacements vector might not have the same shape as the mappable
tensor, but is brodcastable to it. This is a relatively low level
property and the recommended way to access the values is through the
<code><a href="#MappableTensor.generate_values">generate_values</a></code> method.</p>
</div>


                            </div>
                            <div id="MappableTensor.affine_transformation" class="classattr">
                                        <input id="MappableTensor.affine_transformation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">affine_transformation</span><span class="annotation">: Union[<a href="affine_transformation.html#IAffineTransformation">composable_mapping.affine_transformation.IAffineTransformation</a>, NoneType]</span>

                <label class="view-source-button" for="MappableTensor.affine_transformation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.affine_transformation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.affine_transformation-370"><a href="#MappableTensor.affine_transformation-370"><span class="linenos">370</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.affine_transformation-371"><a href="#MappableTensor.affine_transformation-371"><span class="linenos">371</span></a>    <span class="k">def</span> <span class="nf">affine_transformation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IAffineTransformation</span><span class="p">]:</span>
</span><span id="MappableTensor.affine_transformation-372"><a href="#MappableTensor.affine_transformation-372"><span class="linenos">372</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Affine transformation on displacements, if available</span>
</span><span id="MappableTensor.affine_transformation-373"><a href="#MappableTensor.affine_transformation-373"><span class="linenos">373</span></a>
</span><span id="MappableTensor.affine_transformation-374"><a href="#MappableTensor.affine_transformation-374"><span class="linenos">374</span></a><span class="sd">        This is relatively low level property, and should be used with caution.</span>
</span><span id="MappableTensor.affine_transformation-375"><a href="#MappableTensor.affine_transformation-375"><span class="linenos">375</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.affine_transformation-376"><a href="#MappableTensor.affine_transformation-376"><span class="linenos">376</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span>
</span></pre></div>


            <div class="docstring"><p>Affine transformation on displacements, if available</p>

<p>This is relatively low level property, and should be used with caution.</p>
</div>


                            </div>
                            <div id="MappableTensor.grid" class="classattr">
                                        <input id="MappableTensor.grid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">grid</span><span class="annotation">: Union[composable_mapping.mappable_tensor.grid.GridDefinition, NoneType]</span>

                <label class="view-source-button" for="MappableTensor.grid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.grid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.grid-378"><a href="#MappableTensor.grid-378"><span class="linenos">378</span></a>    <span class="nd">@property</span>
</span><span id="MappableTensor.grid-379"><a href="#MappableTensor.grid-379"><span class="linenos">379</span></a>    <span class="k">def</span> <span class="nf">grid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridDefinition</span><span class="p">]:</span>
</span><span id="MappableTensor.grid-380"><a href="#MappableTensor.grid-380"><span class="linenos">380</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Definition of the grid contained by the tensor, if available</span>
</span><span id="MappableTensor.grid-381"><a href="#MappableTensor.grid-381"><span class="linenos">381</span></a>
</span><span id="MappableTensor.grid-382"><a href="#MappableTensor.grid-382"><span class="linenos">382</span></a><span class="sd">        The grid might not have the same shape as the mappable tensor, but is</span>
</span><span id="MappableTensor.grid-383"><a href="#MappableTensor.grid-383"><span class="linenos">383</span></a><span class="sd">        brodcastable to it. This is relatively low level method, and should be</span>
</span><span id="MappableTensor.grid-384"><a href="#MappableTensor.grid-384"><span class="linenos">384</span></a><span class="sd">        used with caution.</span>
</span><span id="MappableTensor.grid-385"><a href="#MappableTensor.grid-385"><span class="linenos">385</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.grid-386"><a href="#MappableTensor.grid-386"><span class="linenos">386</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span>
</span></pre></div>


            <div class="docstring"><p>Definition of the grid contained by the tensor, if available</p>

<p>The grid might not have the same shape as the mappable tensor, but is
brodcastable to it. This is relatively low level method, and should be
used with caution.</p>
</div>


                            </div>
                            <div id="MappableTensor.transform" class="classattr">
                                        <input id="MappableTensor.transform-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">transform</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">affine_transformation</span><span class="p">:</span> <span class="n"><a href="affine_transformation.html#IAffineTransformation">composable_mapping.affine_transformation.IAffineTransformation</a></span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="MappableTensor.transform-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.transform"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.transform-388"><a href="#MappableTensor.transform-388"><span class="linenos">388</span></a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">affine_transformation</span><span class="p">:</span> <span class="n">IAffineTransformation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor.transform-389"><a href="#MappableTensor.transform-389"><span class="linenos">389</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply an affine transformation to the last channel dimension of the</span>
</span><span id="MappableTensor.transform-390"><a href="#MappableTensor.transform-390"><span class="linenos">390</span></a><span class="sd">        mappable tensor.</span>
</span><span id="MappableTensor.transform-391"><a href="#MappableTensor.transform-391"><span class="linenos">391</span></a>
</span><span id="MappableTensor.transform-392"><a href="#MappableTensor.transform-392"><span class="linenos">392</span></a><span class="sd">        The affine transformation is not applied right a way, only the</span>
</span><span id="MappableTensor.transform-393"><a href="#MappableTensor.transform-393"><span class="linenos">393</span></a><span class="sd">        composition with the existing affine transformation is stored. The</span>
</span><span id="MappableTensor.transform-394"><a href="#MappableTensor.transform-394"><span class="linenos">394</span></a><span class="sd">        transformation is applied when the values are generated.</span>
</span><span id="MappableTensor.transform-395"><a href="#MappableTensor.transform-395"><span class="linenos">395</span></a>
</span><span id="MappableTensor.transform-396"><a href="#MappableTensor.transform-396"><span class="linenos">396</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor.transform-397"><a href="#MappableTensor.transform-397"><span class="linenos">397</span></a><span class="sd">            affine_transformation: Affine transformation to apply.</span>
</span><span id="MappableTensor.transform-398"><a href="#MappableTensor.transform-398"><span class="linenos">398</span></a>
</span><span id="MappableTensor.transform-399"><a href="#MappableTensor.transform-399"><span class="linenos">399</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor.transform-400"><a href="#MappableTensor.transform-400"><span class="linenos">400</span></a><span class="sd">            Transformed mappable tensor.</span>
</span><span id="MappableTensor.transform-401"><a href="#MappableTensor.transform-401"><span class="linenos">401</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.transform-402"><a href="#MappableTensor.transform-402"><span class="linenos">402</span></a>        <span class="n">n_affine_transformation_input_channels</span> <span class="o">=</span> <span class="n">affine_transformation</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="MappableTensor.transform-403"><a href="#MappableTensor.transform-403"><span class="linenos">403</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">n_affine_transformation_input_channels</span><span class="p">:</span>
</span><span id="MappableTensor.transform-404"><a href="#MappableTensor.transform-404"><span class="linenos">404</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Affine transformation must have matching input channels&quot;</span><span class="p">)</span>
</span><span id="MappableTensor.transform-405"><a href="#MappableTensor.transform-405"><span class="linenos">405</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.transform-406"><a href="#MappableTensor.transform-406"><span class="linenos">406</span></a>            <span class="n">grid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">GridDefinition</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor.transform-407"><a href="#MappableTensor.transform-407"><span class="linenos">407</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor.transform-408"><a href="#MappableTensor.transform-408"><span class="linenos">408</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">is_transformable</span><span class="p">(</span><span class="n">affine_transformation</span><span class="p">):</span>
</span><span id="MappableTensor.transform-409"><a href="#MappableTensor.transform-409"><span class="linenos">409</span></a>                <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor.transform-410"><a href="#MappableTensor.transform-410"><span class="linenos">410</span></a>                    <span class="n">displacements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_values</span><span class="p">(),</span>
</span><span id="MappableTensor.transform-411"><a href="#MappableTensor.transform-411"><span class="linenos">411</span></a>                    <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor.transform-412"><a href="#MappableTensor.transform-412"><span class="linenos">412</span></a>                    <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor.transform-413"><a href="#MappableTensor.transform-413"><span class="linenos">413</span></a>                    <span class="n">affine_transformation</span><span class="o">=</span><span class="n">affine_transformation</span><span class="p">,</span>
</span><span id="MappableTensor.transform-414"><a href="#MappableTensor.transform-414"><span class="linenos">414</span></a>                    <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.transform-415"><a href="#MappableTensor.transform-415"><span class="linenos">415</span></a>                <span class="p">)</span>
</span><span id="MappableTensor.transform-416"><a href="#MappableTensor.transform-416"><span class="linenos">416</span></a>            <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="o">.</span><span class="n">broadcast_to_n_channels</span><span class="p">(</span>
</span><span id="MappableTensor.transform-417"><a href="#MappableTensor.transform-417"><span class="linenos">417</span></a>                <span class="n">n_affine_transformation_input_channels</span>
</span><span id="MappableTensor.transform-418"><a href="#MappableTensor.transform-418"><span class="linenos">418</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">affine_transformation</span><span class="p">)</span>
</span><span id="MappableTensor.transform-419"><a href="#MappableTensor.transform-419"><span class="linenos">419</span></a>            <span class="n">affine_transformation</span> <span class="o">=</span> <span class="n">affine_transformation</span><span class="o">.</span><span class="n">clear_translation</span><span class="p">()</span>
</span><span id="MappableTensor.transform-420"><a href="#MappableTensor.transform-420"><span class="linenos">420</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.transform-421"><a href="#MappableTensor.transform-421"><span class="linenos">421</span></a>            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="MappableTensor.transform-422"><a href="#MappableTensor.transform-422"><span class="linenos">422</span></a>            <span class="n">affine_transformation_on_displacements</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IAffineTransformation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor.transform-423"><a href="#MappableTensor.transform-423"><span class="linenos">423</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MappableTensor.transform-424"><a href="#MappableTensor.transform-424"><span class="linenos">424</span></a>            <span class="n">affine_transformation_on_displacements</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MappableTensor.transform-425"><a href="#MappableTensor.transform-425"><span class="linenos">425</span></a>                <span class="n">affine_transformation</span>
</span><span id="MappableTensor.transform-426"><a href="#MappableTensor.transform-426"><span class="linenos">426</span></a>                <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span><span class="o">.</span><span class="n">broadcast_to_n_output_channels</span><span class="p">(</span>
</span><span id="MappableTensor.transform-427"><a href="#MappableTensor.transform-427"><span class="linenos">427</span></a>                    <span class="n">n_affine_transformation_input_channels</span><span class="p">,</span>
</span><span id="MappableTensor.transform-428"><a href="#MappableTensor.transform-428"><span class="linenos">428</span></a>                <span class="p">)</span>
</span><span id="MappableTensor.transform-429"><a href="#MappableTensor.transform-429"><span class="linenos">429</span></a>            <span class="p">)</span>
</span><span id="MappableTensor.transform-430"><a href="#MappableTensor.transform-430"><span class="linenos">430</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor.transform-431"><a href="#MappableTensor.transform-431"><span class="linenos">431</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="p">,</span>
</span><span id="MappableTensor.transform-432"><a href="#MappableTensor.transform-432"><span class="linenos">432</span></a>            <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span>
</span><span id="MappableTensor.transform-433"><a href="#MappableTensor.transform-433"><span class="linenos">433</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor.transform-434"><a href="#MappableTensor.transform-434"><span class="linenos">434</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="n">affine_transformation_on_displacements</span><span class="p">,</span>
</span><span id="MappableTensor.transform-435"><a href="#MappableTensor.transform-435"><span class="linenos">435</span></a>            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
</span><span id="MappableTensor.transform-436"><a href="#MappableTensor.transform-436"><span class="linenos">436</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Apply an affine transformation to the last channel dimension of the
mappable tensor.</p>

<p>The affine transformation is not applied right a way, only the
composition with the existing affine transformation is stored. The
transformation is applied when the values are generated.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>affine_transformation:</strong>  Affine transformation to apply.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Transformed mappable tensor.</p>
</blockquote>
</div>


                            </div>
                            <div id="MappableTensor.has_mask" class="classattr">
                                        <input id="MappableTensor.has_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">has_mask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">bool</span>:</span></span>

                <label class="view-source-button" for="MappableTensor.has_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.has_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.has_mask-705"><a href="#MappableTensor.has_mask-705"><span class="linenos">705</span></a>    <span class="k">def</span> <span class="nf">has_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="MappableTensor.has_mask-706"><a href="#MappableTensor.has_mask-706"><span class="linenos">706</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Has the mappable tensor an explicit mask&quot;&quot;&quot;</span>
</span><span id="MappableTensor.has_mask-707"><a href="#MappableTensor.has_mask-707"><span class="linenos">707</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Has the mappable tensor an explicit mask</p>
</div>


                            </div>
                            <div id="MappableTensor.clear_mask" class="classattr">
                                        <input id="MappableTensor.clear_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clear_mask</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="MappableTensor.clear_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.clear_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.clear_mask-709"><a href="#MappableTensor.clear_mask-709"><span class="linenos">709</span></a>    <span class="k">def</span> <span class="nf">clear_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor.clear_mask-710"><a href="#MappableTensor.clear_mask-710"><span class="linenos">710</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear mask from the mappable tensor&quot;&quot;&quot;</span>
</span><span id="MappableTensor.clear_mask-711"><a href="#MappableTensor.clear_mask-711"><span class="linenos">711</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_mask</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Clear mask from the mappable tensor</p>
</div>


                            </div>
                            <div id="MappableTensor.reduce" class="classattr">
                                        <input id="MappableTensor.reduce-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reduce</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="MappableTensor.reduce-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.reduce"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.reduce-713"><a href="#MappableTensor.reduce-713"><span class="linenos">713</span></a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor.reduce-714"><a href="#MappableTensor.reduce-714"><span class="linenos">714</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reduce the masked tensor to a mappable tensor with values and mask</span>
</span><span id="MappableTensor.reduce-715"><a href="#MappableTensor.reduce-715"><span class="linenos">715</span></a><span class="sd">        stored explicitly.&quot;&quot;&quot;</span>
</span><span id="MappableTensor.reduce-716"><a href="#MappableTensor.reduce-716"><span class="linenos">716</span></a>        <span class="n">values</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="MappableTensor.reduce-717"><a href="#MappableTensor.reduce-717"><span class="linenos">717</span></a>        <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="MappableTensor.reduce-718"><a href="#MappableTensor.reduce-718"><span class="linenos">718</span></a>            <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
</span><span id="MappableTensor.reduce-719"><a href="#MappableTensor.reduce-719"><span class="linenos">719</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor.reduce-720"><a href="#MappableTensor.reduce-720"><span class="linenos">720</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor.reduce-721"><a href="#MappableTensor.reduce-721"><span class="linenos">721</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Reduce the masked tensor to a mappable tensor with values and mask
stored explicitly.</p>
</div>


                            </div>
                            <div id="MappableTensor.modify_values" class="classattr">
                                        <input id="MappableTensor.modify_values-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">modify_values</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">values</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>,</span><span class="param">	<span class="n">n_channel_dims</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="MappableTensor.modify_values-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.modify_values"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.modify_values-723"><a href="#MappableTensor.modify_values-723"><span class="linenos">723</span></a>    <span class="k">def</span> <span class="nf">modify_values</span><span class="p">(</span>
</span><span id="MappableTensor.modify_values-724"><a href="#MappableTensor.modify_values-724"><span class="linenos">724</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MappableTensor.modify_values-725"><a href="#MappableTensor.modify_values-725"><span class="linenos">725</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor.modify_values-726"><a href="#MappableTensor.modify_values-726"><span class="linenos">726</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify values of the mappable tensor.</span>
</span><span id="MappableTensor.modify_values-727"><a href="#MappableTensor.modify_values-727"><span class="linenos">727</span></a>
</span><span id="MappableTensor.modify_values-728"><a href="#MappableTensor.modify_values-728"><span class="linenos">728</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor.modify_values-729"><a href="#MappableTensor.modify_values-729"><span class="linenos">729</span></a><span class="sd">            values: New values of the mappable tensor. Tensor with shape</span>
</span><span id="MappableTensor.modify_values-730"><a href="#MappableTensor.modify_values-730"><span class="linenos">730</span></a><span class="sd">                (*batch_shape, *channels_shape, *spatial_shape).</span>
</span><span id="MappableTensor.modify_values-731"><a href="#MappableTensor.modify_values-731"><span class="linenos">731</span></a><span class="sd">            n_channel_dims: Number of channel dimensions of the new values.</span>
</span><span id="MappableTensor.modify_values-732"><a href="#MappableTensor.modify_values-732"><span class="linenos">732</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.modify_values-733"><a href="#MappableTensor.modify_values-733"><span class="linenos">733</span></a>        <span class="k">if</span> <span class="n">n_channel_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.modify_values-734"><a href="#MappableTensor.modify_values-734"><span class="linenos">734</span></a>            <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_channel_dims</span>
</span><span id="MappableTensor.modify_values-735"><a href="#MappableTensor.modify_values-735"><span class="linenos">735</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span>
</span><span id="MappableTensor.modify_values-736"><a href="#MappableTensor.modify_values-736"><span class="linenos">736</span></a>        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MappableTensor.modify_values-737"><a href="#MappableTensor.modify_values-737"><span class="linenos">737</span></a>            <span class="n">batch_shape</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">spatial_shape</span> <span class="o">=</span> <span class="n">split_shape</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="MappableTensor.modify_values-738"><a href="#MappableTensor.modify_values-738"><span class="linenos">738</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="n">n_channel_dims</span> <span class="o">+</span> <span class="n">spatial_shape</span><span class="p">)</span>
</span><span id="MappableTensor.modify_values-739"><a href="#MappableTensor.modify_values-739"><span class="linenos">739</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor.modify_values-740"><a href="#MappableTensor.modify_values-740"><span class="linenos">740</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
</span><span id="MappableTensor.modify_values-741"><a href="#MappableTensor.modify_values-741"><span class="linenos">741</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor.modify_values-742"><a href="#MappableTensor.modify_values-742"><span class="linenos">742</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor.modify_values-743"><a href="#MappableTensor.modify_values-743"><span class="linenos">743</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.modify_values-744"><a href="#MappableTensor.modify_values-744"><span class="linenos">744</span></a>            <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="MappableTensor.modify_values-745"><a href="#MappableTensor.modify_values-745"><span class="linenos">745</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Modify values of the mappable tensor.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>values:</strong>  New values of the mappable tensor. Tensor with shape
(*batch_shape, *channels_shape, *spatial_shape).</li>
<li><strong>n_channel_dims:</strong>  Number of channel dimensions of the new values.</li>
</ul>
</div>


                            </div>
                            <div id="MappableTensor.mask_and" class="classattr">
                                        <input id="MappableTensor.mask_and-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">mask_and</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="MappableTensor.mask_and-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.mask_and"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.mask_and-747"><a href="#MappableTensor.mask_and-747"><span class="linenos">747</span></a>    <span class="k">def</span> <span class="nf">mask_and</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor.mask_and-748"><a href="#MappableTensor.mask_and-748"><span class="linenos">748</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine mask with logical and.</span>
</span><span id="MappableTensor.mask_and-749"><a href="#MappableTensor.mask_and-749"><span class="linenos">749</span></a>
</span><span id="MappableTensor.mask_and-750"><a href="#MappableTensor.mask_and-750"><span class="linenos">750</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor.mask_and-751"><a href="#MappableTensor.mask_and-751"><span class="linenos">751</span></a><span class="sd">            mask: Mask to combine with the mappable tensor.</span>
</span><span id="MappableTensor.mask_and-752"><a href="#MappableTensor.mask_and-752"><span class="linenos">752</span></a>
</span><span id="MappableTensor.mask_and-753"><a href="#MappableTensor.mask_and-753"><span class="linenos">753</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor.mask_and-754"><a href="#MappableTensor.mask_and-754"><span class="linenos">754</span></a><span class="sd">            Mappable tensor with the combined mask.</span>
</span><span id="MappableTensor.mask_and-755"><a href="#MappableTensor.mask_and-755"><span class="linenos">755</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.mask_and-756"><a href="#MappableTensor.mask_and-756"><span class="linenos">756</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modify_mask</span><span class="p">(</span>
</span><span id="MappableTensor.mask_and-757"><a href="#MappableTensor.mask_and-757"><span class="linenos">757</span></a>            <span class="n">combine_optional_masks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">)</span>
</span><span id="MappableTensor.mask_and-758"><a href="#MappableTensor.mask_and-758"><span class="linenos">758</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Combine mask with logical and.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mask:</strong>  Mask to combine with the mappable tensor.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Mappable tensor with the combined mask.</p>
</blockquote>
</div>


                            </div>
                            <div id="MappableTensor.modify_mask" class="classattr">
                                        <input id="MappableTensor.modify_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">modify_mask</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="MappableTensor.modify_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MappableTensor.modify_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MappableTensor.modify_mask-760"><a href="#MappableTensor.modify_mask-760"><span class="linenos">760</span></a>    <span class="k">def</span> <span class="nf">modify_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="MappableTensor.modify_mask-761"><a href="#MappableTensor.modify_mask-761"><span class="linenos">761</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Modify mask of the mappable tensor.</span>
</span><span id="MappableTensor.modify_mask-762"><a href="#MappableTensor.modify_mask-762"><span class="linenos">762</span></a>
</span><span id="MappableTensor.modify_mask-763"><a href="#MappableTensor.modify_mask-763"><span class="linenos">763</span></a><span class="sd">        Args:</span>
</span><span id="MappableTensor.modify_mask-764"><a href="#MappableTensor.modify_mask-764"><span class="linenos">764</span></a><span class="sd">            mask: New mask of the mappable tensor.</span>
</span><span id="MappableTensor.modify_mask-765"><a href="#MappableTensor.modify_mask-765"><span class="linenos">765</span></a>
</span><span id="MappableTensor.modify_mask-766"><a href="#MappableTensor.modify_mask-766"><span class="linenos">766</span></a><span class="sd">        Returns:</span>
</span><span id="MappableTensor.modify_mask-767"><a href="#MappableTensor.modify_mask-767"><span class="linenos">767</span></a><span class="sd">            Mappable tensor with the new mask.</span>
</span><span id="MappableTensor.modify_mask-768"><a href="#MappableTensor.modify_mask-768"><span class="linenos">768</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MappableTensor.modify_mask-769"><a href="#MappableTensor.modify_mask-769"><span class="linenos">769</span></a>        <span class="k">return</span> <span class="n">MappableTensor</span><span class="p">(</span>
</span><span id="MappableTensor.modify_mask-770"><a href="#MappableTensor.modify_mask-770"><span class="linenos">770</span></a>            <span class="n">displacements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="p">,</span>
</span><span id="MappableTensor.modify_mask-771"><a href="#MappableTensor.modify_mask-771"><span class="linenos">771</span></a>            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="MappableTensor.modify_mask-772"><a href="#MappableTensor.modify_mask-772"><span class="linenos">772</span></a>            <span class="n">n_channel_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_channel_dims</span><span class="p">,</span>
</span><span id="MappableTensor.modify_mask-773"><a href="#MappableTensor.modify_mask-773"><span class="linenos">773</span></a>            <span class="n">affine_transformation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_affine_transformation</span><span class="p">,</span>
</span><span id="MappableTensor.modify_mask-774"><a href="#MappableTensor.modify_mask-774"><span class="linenos">774</span></a>            <span class="n">grid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grid</span><span class="p">,</span>
</span><span id="MappableTensor.modify_mask-775"><a href="#MappableTensor.modify_mask-775"><span class="linenos">775</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Modify mask of the mappable tensor.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mask:</strong>  New mask of the mappable tensor.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Mappable tensor with the new mask.</p>
</blockquote>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>composable_mapping.tensor_like.BaseTensorLikeWrapper</dt>
                                <dd id="MappableTensor.dtype" class="variable">dtype</dd>
                <dd id="MappableTensor.device" class="variable">device</dd>
                <dd id="MappableTensor.cast" class="function">cast</dd>
                <dd id="MappableTensor.pin_memory" class="function">pin_memory</dd>
                <dd id="MappableTensor.detach" class="function">detach</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="concatenate_mappable_tensors">
                            <input id="concatenate_mappable_tensors-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">concatenate_mappable_tensors</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="o">*</span><span class="n">mappable_tensors</span><span class="p">:</span> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>,</span><span class="param">	<span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="concatenate_mappable_tensors-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#concatenate_mappable_tensors"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="concatenate_mappable_tensors-13"><a href="#concatenate_mappable_tensors-13"><span class="linenos">13</span></a><span class="k">def</span> <span class="nf">concatenate_mappable_tensors</span><span class="p">(</span>
</span><span id="concatenate_mappable_tensors-14"><a href="#concatenate_mappable_tensors-14"><span class="linenos">14</span></a>    <span class="o">*</span><span class="n">mappable_tensors</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="concatenate_mappable_tensors-15"><a href="#concatenate_mappable_tensors-15"><span class="linenos">15</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="concatenate_mappable_tensors-16"><a href="#concatenate_mappable_tensors-16"><span class="linenos">16</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Concatenate mappable tensors along the channel dimension</span>
</span><span id="concatenate_mappable_tensors-17"><a href="#concatenate_mappable_tensors-17"><span class="linenos">17</span></a>
</span><span id="concatenate_mappable_tensors-18"><a href="#concatenate_mappable_tensors-18"><span class="linenos">18</span></a><span class="sd">    Args:</span>
</span><span id="concatenate_mappable_tensors-19"><a href="#concatenate_mappable_tensors-19"><span class="linenos">19</span></a><span class="sd">        mappable_tensors: Masked tensors to concatenate</span>
</span><span id="concatenate_mappable_tensors-20"><a href="#concatenate_mappable_tensors-20"><span class="linenos">20</span></a><span class="sd">        channel_index: Index of the channel dimension starting from the first</span>
</span><span id="concatenate_mappable_tensors-21"><a href="#concatenate_mappable_tensors-21"><span class="linenos">21</span></a><span class="sd">            channel dimension over which to concatenate.</span>
</span><span id="concatenate_mappable_tensors-22"><a href="#concatenate_mappable_tensors-22"><span class="linenos">22</span></a>
</span><span id="concatenate_mappable_tensors-23"><a href="#concatenate_mappable_tensors-23"><span class="linenos">23</span></a><span class="sd">    Returns:</span>
</span><span id="concatenate_mappable_tensors-24"><a href="#concatenate_mappable_tensors-24"><span class="linenos">24</span></a><span class="sd">        Concatenated masked tensor.</span>
</span><span id="concatenate_mappable_tensors-25"><a href="#concatenate_mappable_tensors-25"><span class="linenos">25</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="concatenate_mappable_tensors-26"><a href="#concatenate_mappable_tensors-26"><span class="linenos">26</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
</span><span id="concatenate_mappable_tensors-27"><a href="#concatenate_mappable_tensors-27"><span class="linenos">27</span></a>        <span class="n">mappable_tensor</span><span class="o">.</span><span class="n">n_channel_dims</span> <span class="o">==</span> <span class="n">mappable_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n_channel_dims</span>
</span><span id="concatenate_mappable_tensors-28"><a href="#concatenate_mappable_tensors-28"><span class="linenos">28</span></a>        <span class="k">for</span> <span class="n">mappable_tensor</span> <span class="ow">in</span> <span class="n">mappable_tensors</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="concatenate_mappable_tensors-29"><a href="#concatenate_mappable_tensors-29"><span class="linenos">29</span></a>    <span class="p">):</span>
</span><span id="concatenate_mappable_tensors-30"><a href="#concatenate_mappable_tensors-30"><span class="linenos">30</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lengths of channel shapes of masked tensors must be the same&quot;</span><span class="p">)</span>
</span><span id="concatenate_mappable_tensors-31"><a href="#concatenate_mappable_tensors-31"><span class="linenos">31</span></a>    <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mappable_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">)</span>
</span><span id="concatenate_mappable_tensors-32"><a href="#concatenate_mappable_tensors-32"><span class="linenos">32</span></a>    <span class="n">concatenation_dim</span> <span class="o">=</span> <span class="n">get_channel_dims</span><span class="p">(</span>
</span><span id="concatenate_mappable_tensors-33"><a href="#concatenate_mappable_tensors-33"><span class="linenos">33</span></a>        <span class="n">n_total_dims</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">mappable_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
</span><span id="concatenate_mappable_tensors-34"><a href="#concatenate_mappable_tensors-34"><span class="linenos">34</span></a>        <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="concatenate_mappable_tensors-35"><a href="#concatenate_mappable_tensors-35"><span class="linenos">35</span></a>    <span class="p">)[</span><span class="n">channel_index</span><span class="p">]</span>
</span><span id="concatenate_mappable_tensors-36"><a href="#concatenate_mappable_tensors-36"><span class="linenos">36</span></a>    <span class="n">values</span> <span class="o">=</span> <span class="n">cat</span><span class="p">(</span>
</span><span id="concatenate_mappable_tensors-37"><a href="#concatenate_mappable_tensors-37"><span class="linenos">37</span></a>        <span class="p">[</span><span class="n">mappable_tensor</span><span class="o">.</span><span class="n">generate_values</span><span class="p">()</span> <span class="k">for</span> <span class="n">mappable_tensor</span> <span class="ow">in</span> <span class="n">mappable_tensors</span><span class="p">],</span>
</span><span id="concatenate_mappable_tensors-38"><a href="#concatenate_mappable_tensors-38"><span class="linenos">38</span></a>        <span class="n">dim</span><span class="o">=</span><span class="n">concatenation_dim</span><span class="p">,</span>
</span><span id="concatenate_mappable_tensors-39"><a href="#concatenate_mappable_tensors-39"><span class="linenos">39</span></a>    <span class="p">)</span>
</span><span id="concatenate_mappable_tensors-40"><a href="#concatenate_mappable_tensors-40"><span class="linenos">40</span></a>    <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="concatenate_mappable_tensors-41"><a href="#concatenate_mappable_tensors-41"><span class="linenos">41</span></a>    <span class="k">for</span> <span class="n">mappable_tensor</span> <span class="ow">in</span> <span class="n">mappable_tensors</span><span class="p">:</span>
</span><span id="concatenate_mappable_tensors-42"><a href="#concatenate_mappable_tensors-42"><span class="linenos">42</span></a>        <span class="n">update_mask</span> <span class="o">=</span> <span class="n">mappable_tensor</span><span class="o">.</span><span class="n">generate_mask</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="concatenate_mappable_tensors-43"><a href="#concatenate_mappable_tensors-43"><span class="linenos">43</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">combine_optional_masks</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">update_mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span><span id="concatenate_mappable_tensors-44"><a href="#concatenate_mappable_tensors-44"><span class="linenos">44</span></a>    <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="concatenate_mappable_tensors-45"><a href="#concatenate_mappable_tensors-45"><span class="linenos">45</span></a>        <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
</span><span id="concatenate_mappable_tensors-46"><a href="#concatenate_mappable_tensors-46"><span class="linenos">46</span></a>        <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="concatenate_mappable_tensors-47"><a href="#concatenate_mappable_tensors-47"><span class="linenos">47</span></a>        <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="concatenate_mappable_tensors-48"><a href="#concatenate_mappable_tensors-48"><span class="linenos">48</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Concatenate mappable tensors along the channel dimension</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mappable_tensors:</strong>  Masked tensors to concatenate</li>
<li><strong>channel_index:</strong>  Index of the channel dimension starting from the first
channel dimension over which to concatenate.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Concatenated masked tensor.</p>
</blockquote>
</div>


                </section>
                <section id="mappable">
                            <input id="mappable-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">mappable</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">values</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="mappable-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#mappable"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="mappable-788"><a href="#mappable-788"><span class="linenos">788</span></a><span class="k">def</span> <span class="nf">mappable</span><span class="p">(</span>
</span><span id="mappable-789"><a href="#mappable-789"><span class="linenos">789</span></a>    <span class="n">values</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="mappable-790"><a href="#mappable-790"><span class="linenos">790</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="mappable-791"><a href="#mappable-791"><span class="linenos">791</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a mappable tensor from values and mask</span>
</span><span id="mappable-792"><a href="#mappable-792"><span class="linenos">792</span></a>
</span><span id="mappable-793"><a href="#mappable-793"><span class="linenos">793</span></a><span class="sd">    See: `MappableTensor.from_tensor`.</span>
</span><span id="mappable-794"><a href="#mappable-794"><span class="linenos">794</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="mappable-795"><a href="#mappable-795"><span class="linenos">795</span></a>    <span class="k">return</span> <span class="n">MappableTensor</span><span class="o">.</span><span class="n">from_tensor</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a mappable tensor from values and mask</p>

<p>See: <code><a href="#MappableTensor.from_tensor">MappableTensor.from_tensor</a></code>.</p>
</div>


                </section>
                <section id="stack_mappable_tensors">
                            <input id="stack_mappable_tensors-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">stack_mappable_tensors</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="o">*</span><span class="n">mappable_tensors</span><span class="p">:</span> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>,</span><span class="param">	<span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="stack_mappable_tensors-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#stack_mappable_tensors"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="stack_mappable_tensors-51"><a href="#stack_mappable_tensors-51"><span class="linenos">51</span></a><span class="k">def</span> <span class="nf">stack_mappable_tensors</span><span class="p">(</span>
</span><span id="stack_mappable_tensors-52"><a href="#stack_mappable_tensors-52"><span class="linenos">52</span></a>    <span class="o">*</span><span class="n">mappable_tensors</span><span class="p">:</span> <span class="n">MappableTensor</span><span class="p">,</span> <span class="n">channel_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="stack_mappable_tensors-53"><a href="#stack_mappable_tensors-53"><span class="linenos">53</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;MappableTensor&quot;</span><span class="p">:</span>
</span><span id="stack_mappable_tensors-54"><a href="#stack_mappable_tensors-54"><span class="linenos">54</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Stack mappable tensors along the channel dimension.</span>
</span><span id="stack_mappable_tensors-55"><a href="#stack_mappable_tensors-55"><span class="linenos">55</span></a>
</span><span id="stack_mappable_tensors-56"><a href="#stack_mappable_tensors-56"><span class="linenos">56</span></a><span class="sd">    Args:</span>
</span><span id="stack_mappable_tensors-57"><a href="#stack_mappable_tensors-57"><span class="linenos">57</span></a><span class="sd">        mappable_tensors: Mappable tensors to concatenate</span>
</span><span id="stack_mappable_tensors-58"><a href="#stack_mappable_tensors-58"><span class="linenos">58</span></a><span class="sd">        channel_index: Index of the channel dimension over which to stack</span>
</span><span id="stack_mappable_tensors-59"><a href="#stack_mappable_tensors-59"><span class="linenos">59</span></a><span class="sd">            starting from the first channel dimension over which to stack.</span>
</span><span id="stack_mappable_tensors-60"><a href="#stack_mappable_tensors-60"><span class="linenos">60</span></a>
</span><span id="stack_mappable_tensors-61"><a href="#stack_mappable_tensors-61"><span class="linenos">61</span></a><span class="sd">    Returns:</span>
</span><span id="stack_mappable_tensors-62"><a href="#stack_mappable_tensors-62"><span class="linenos">62</span></a><span class="sd">        Stacked masked tensor.</span>
</span><span id="stack_mappable_tensors-63"><a href="#stack_mappable_tensors-63"><span class="linenos">63</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="stack_mappable_tensors-64"><a href="#stack_mappable_tensors-64"><span class="linenos">64</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
</span><span id="stack_mappable_tensors-65"><a href="#stack_mappable_tensors-65"><span class="linenos">65</span></a>        <span class="n">mappable_tensor</span><span class="o">.</span><span class="n">n_channel_dims</span> <span class="o">==</span> <span class="n">mappable_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n_channel_dims</span>
</span><span id="stack_mappable_tensors-66"><a href="#stack_mappable_tensors-66"><span class="linenos">66</span></a>        <span class="k">for</span> <span class="n">mappable_tensor</span> <span class="ow">in</span> <span class="n">mappable_tensors</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="stack_mappable_tensors-67"><a href="#stack_mappable_tensors-67"><span class="linenos">67</span></a>    <span class="p">):</span>
</span><span id="stack_mappable_tensors-68"><a href="#stack_mappable_tensors-68"><span class="linenos">68</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lengths of channel shapes of masked tensors must be the same&quot;</span><span class="p">)</span>
</span><span id="stack_mappable_tensors-69"><a href="#stack_mappable_tensors-69"><span class="linenos">69</span></a>    <span class="n">n_channel_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mappable_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">channels_shape</span><span class="p">)</span>
</span><span id="stack_mappable_tensors-70"><a href="#stack_mappable_tensors-70"><span class="linenos">70</span></a>    <span class="n">channel_dims</span> <span class="o">=</span> <span class="n">get_channel_dims</span><span class="p">(</span>
</span><span id="stack_mappable_tensors-71"><a href="#stack_mappable_tensors-71"><span class="linenos">71</span></a>        <span class="n">n_total_dims</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">mappable_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
</span><span id="stack_mappable_tensors-72"><a href="#stack_mappable_tensors-72"><span class="linenos">72</span></a>        <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span><span class="p">,</span>
</span><span id="stack_mappable_tensors-73"><a href="#stack_mappable_tensors-73"><span class="linenos">73</span></a>    <span class="p">)</span>
</span><span id="stack_mappable_tensors-74"><a href="#stack_mappable_tensors-74"><span class="linenos">74</span></a>    <span class="n">stacking_dim</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel_dims</span> <span class="o">+</span> <span class="p">(</span><span class="n">channel_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,))[</span><span class="n">channel_index</span><span class="p">]</span>
</span><span id="stack_mappable_tensors-75"><a href="#stack_mappable_tensors-75"><span class="linenos">75</span></a>    <span class="n">values</span> <span class="o">=</span> <span class="n">stack</span><span class="p">(</span>
</span><span id="stack_mappable_tensors-76"><a href="#stack_mappable_tensors-76"><span class="linenos">76</span></a>        <span class="p">[</span><span class="n">mappable_tensor</span><span class="o">.</span><span class="n">generate_values</span><span class="p">()</span> <span class="k">for</span> <span class="n">mappable_tensor</span> <span class="ow">in</span> <span class="n">mappable_tensors</span><span class="p">],</span>
</span><span id="stack_mappable_tensors-77"><a href="#stack_mappable_tensors-77"><span class="linenos">77</span></a>        <span class="n">dim</span><span class="o">=</span><span class="n">stacking_dim</span><span class="p">,</span>
</span><span id="stack_mappable_tensors-78"><a href="#stack_mappable_tensors-78"><span class="linenos">78</span></a>    <span class="p">)</span>
</span><span id="stack_mappable_tensors-79"><a href="#stack_mappable_tensors-79"><span class="linenos">79</span></a>    <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="stack_mappable_tensors-80"><a href="#stack_mappable_tensors-80"><span class="linenos">80</span></a>    <span class="k">for</span> <span class="n">mappable_tensor</span> <span class="ow">in</span> <span class="n">mappable_tensors</span><span class="p">:</span>
</span><span id="stack_mappable_tensors-81"><a href="#stack_mappable_tensors-81"><span class="linenos">81</span></a>        <span class="n">update_mask</span> <span class="o">=</span> <span class="n">mappable_tensor</span><span class="o">.</span><span class="n">generate_mask</span><span class="p">(</span><span class="n">generate_missing_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cast_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="stack_mappable_tensors-82"><a href="#stack_mappable_tensors-82"><span class="linenos">82</span></a>        <span class="k">if</span> <span class="n">update_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="stack_mappable_tensors-83"><a href="#stack_mappable_tensors-83"><span class="linenos">83</span></a>            <span class="n">update_mask</span> <span class="o">=</span> <span class="n">update_mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">stacking_dim</span><span class="p">)</span>
</span><span id="stack_mappable_tensors-84"><a href="#stack_mappable_tensors-84"><span class="linenos">84</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">combine_optional_masks</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">update_mask</span><span class="p">,</span> <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="stack_mappable_tensors-85"><a href="#stack_mappable_tensors-85"><span class="linenos">85</span></a>    <span class="k">return</span> <span class="n">mappable</span><span class="p">(</span>
</span><span id="stack_mappable_tensors-86"><a href="#stack_mappable_tensors-86"><span class="linenos">86</span></a>        <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
</span><span id="stack_mappable_tensors-87"><a href="#stack_mappable_tensors-87"><span class="linenos">87</span></a>        <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
</span><span id="stack_mappable_tensors-88"><a href="#stack_mappable_tensors-88"><span class="linenos">88</span></a>        <span class="n">n_channel_dims</span><span class="o">=</span><span class="n">n_channel_dims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="stack_mappable_tensors-89"><a href="#stack_mappable_tensors-89"><span class="linenos">89</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Stack mappable tensors along the channel dimension.</p>

<h6 id="arguments">Arguments:</h6>

<ul>
<li><strong>mappable_tensors:</strong>  Mappable tensors to concatenate</li>
<li><strong>channel_index:</strong>  Index of the channel dimension over which to stack
starting from the first channel dimension over which to stack.</li>
</ul>

<h6 id="returns">Returns:</h6>

<blockquote>
  <p>Stacked masked tensor.</p>
</blockquote>
</div>


                </section>
                <section id="voxel_grid">
                            <input id="voxel_grid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">voxel_grid</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">dtype</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">device</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#MappableTensor">MappableTensor</a></span>:</span></span>

                <label class="view-source-button" for="voxel_grid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#voxel_grid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="voxel_grid-798"><a href="#voxel_grid-798"><span class="linenos">798</span></a><span class="k">def</span> <span class="nf">voxel_grid</span><span class="p">(</span>
</span><span id="voxel_grid-799"><a href="#voxel_grid-799"><span class="linenos">799</span></a>    <span class="n">spatial_shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
</span><span id="voxel_grid-800"><a href="#voxel_grid-800"><span class="linenos">800</span></a>    <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="voxel_grid-801"><a href="#voxel_grid-801"><span class="linenos">801</span></a>    <span class="n">dtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_dtype</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="voxel_grid-802"><a href="#voxel_grid-802"><span class="linenos">802</span></a>    <span class="n">device</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch_device</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="voxel_grid-803"><a href="#voxel_grid-803"><span class="linenos">803</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MappableTensor</span><span class="p">:</span>
</span><span id="voxel_grid-804"><a href="#voxel_grid-804"><span class="linenos">804</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a voxel grid with optional mask.</span>
</span><span id="voxel_grid-805"><a href="#voxel_grid-805"><span class="linenos">805</span></a>
</span><span id="voxel_grid-806"><a href="#voxel_grid-806"><span class="linenos">806</span></a><span class="sd">    The voxel grid is not generated explicitly right away, but only when the</span>
</span><span id="voxel_grid-807"><a href="#voxel_grid-807"><span class="linenos">807</span></a><span class="sd">    values are generated.</span>
</span><span id="voxel_grid-808"><a href="#voxel_grid-808"><span class="linenos">808</span></a>
</span><span id="voxel_grid-809"><a href="#voxel_grid-809"><span class="linenos">809</span></a><span class="sd">    See: `MappableTensor.voxel_grid`.</span>
</span><span id="voxel_grid-810"><a href="#voxel_grid-810"><span class="linenos">810</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="voxel_grid-811"><a href="#voxel_grid-811"><span class="linenos">811</span></a>    <span class="k">return</span> <span class="n">MappableTensor</span><span class="o">.</span><span class="n">voxel_grid</span><span class="p">(</span>
</span><span id="voxel_grid-812"><a href="#voxel_grid-812"><span class="linenos">812</span></a>        <span class="n">spatial_shape</span><span class="o">=</span><span class="n">spatial_shape</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span>
</span><span id="voxel_grid-813"><a href="#voxel_grid-813"><span class="linenos">813</span></a>    <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create a voxel grid with optional mask.</p>

<p>The voxel grid is not generated explicitly right away, but only when the
values are generated.</p>

<p>See: <code><a href="#MappableTensor.voxel_grid">MappableTensor.voxel_grid</a></code>.</p>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>